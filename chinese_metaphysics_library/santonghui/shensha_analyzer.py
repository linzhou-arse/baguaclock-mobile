#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç¥ç…åˆ†æå™¨ - Shensha Analyzer
============================

åŸºäºã€Šä¸‰å‘½é€šä¼šÂ·ç¥ç…ç¯‡ã€‹çš„ç¥ç…åˆ†æ
å®ç°å¤©å¾·è´µäººã€æœˆå¾·è´µäººã€å¤©ä¹™è´µäººç­‰ç¥ç…çš„å‡†ç¡®è¯†åˆ«
"""

from __future__ import annotations
from typing import Dict, List, Any, Tuple
import time

from ..core.base_analyzer import BaseAnalyzer
from ..core.data_structures import BaziData, AnalysisResult, AnalysisConfig
from ..core.utils import get_ten_god, get_season_by_month_branch, create_analysis_result
from ..core.constants import TIANGAN_WUXING, DIZHI_WUXING, DIZHI_CANGGAN, TIANGAN_LIST, DIZHI_LIST


class ShenshaAnalyzer(BaseAnalyzer):
    """ç¥ç…åˆ†æå™¨ - åŸºäºã€Šä¸‰å‘½é€šä¼šÂ·ç¥ç…ç¯‡ã€‹"""
    
    def __init__(self, config: AnalysisConfig = None):
        super().__init__("ç¥ç…åˆ†æå™¨", "ä¸‰å‘½é€šä¼š", config)
        
        # ç¥ç…æŸ¥è¡¨ - åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç†è®º
        self.shensha_tables = self._init_shensha_tables()
    
    def analyze(self, bazi_data: BaziData) -> AnalysisResult:
        """
        æ‰§è¡Œç¥ç…åˆ†æ - åŸºäºã€Šä¸‰å‘½é€šä¼šÂ·ç¥ç…ç¯‡ã€‹
        âœ… ä¿®å¤ï¼šç§»é™¤æ‰“åˆ†ç³»ç»Ÿï¼Œåªæ˜¾ç¤ºç¥ç…è¯¦æƒ…
        """
        start_time = time.time()

        try:
            # åˆ†æå‰ç¥
            ji_shen = self._analyze_ji_shen(bazi_data)

            # åˆ†æå‡¶ç¥
            xiong_shen = self._analyze_xiong_shen(bazi_data)

            # âœ… åˆ¤æ–­å‰å‡¶ï¼ˆä¸æ‰“åˆ†ï¼‰
            ji_count = len(ji_shen)
            xiong_count = len(xiong_shen)

            if ji_count > xiong_count * 2:
                level = 'å¤§å‰'
            elif ji_count > xiong_count:
                level = 'å°å‰'
            elif ji_count == xiong_count:
                level = 'ä¸­å¹³'
            elif xiong_count > ji_count * 2:
                level = 'å¤§å‡¶'
            else:
                level = 'å°å‡¶'

            # ç”Ÿæˆæè¿°å’Œå»ºè®®
            description = self._generate_description(ji_shen, xiong_shen)
            advice = self._generate_advice(ji_shen, xiong_shen)

            analysis_time = (time.time() - start_time) * 1000

            # âœ… æ–°å¢ï¼šè·å–åˆ¤æ–­ä¾æ®ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ç»å…¸ç†è®ºï¼‰
            ji_names = {shen.get('name', '') for shen in ji_shen}
            xiong_names = {shen.get('name', '') for shen in xiong_shen}
            level_reason = self._judge_shensha_level_classical(ji_shen, xiong_shen, ji_names, xiong_names, bazi_data)
            
            return create_analysis_result(
                analyzer_name=self.name,
                book_name=self.book_name,
                analysis_type="ç¥ç…åˆ†æ",
                level=level,
                score=0,  # ä¸æ‰“åˆ†
                description=description,
                details={
                    'ji_shen': ji_shen,
                    'xiong_shen': xiong_shen,
                    'total_ji': ji_count,
                    'total_xiong': xiong_count,
                    'level_reason': level_reason  # âœ… æ–°å¢ï¼šåˆ¤æ–­ä¾æ®
                },
                advice=advice,
                explanation=f"åŸºäºã€Šä¸‰å‘½é€šä¼šÂ·ç¥ç…ç¯‡ã€‹ç†è®ºåˆ†æï¼Œè¯†åˆ«å‡º{ji_count}ä¸ªå‰ç¥ï¼Œ{xiong_count}ä¸ªå‡¶ç¥ã€‚ç¥ç…å‰å‡¶éœ€ç»“åˆå‘½å±€æ•´ä½“åˆ¤æ–­ã€‚",
                analysis_time=analysis_time
            )

        except Exception as e:
            raise Exception(f"ç¥ç…åˆ†æå¤±è´¥: {e}")
    
    def _init_shensha_tables(self) -> Dict[str, Dict]:
        """åˆå§‹åŒ–ç¥ç…æŸ¥è¡¨"""
        return {
            # å¤©å¾·è´µäººè¡¨ - æŒ‰ã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ç†è®º
            # ã€Šä¸‰å‘½é€šä¼šã€‹åŸæ–‡ï¼š"å¤©å¾·è€…ï¼Œæ¯æœˆä¹‹å¾·ç¥ä¹Ÿã€‚"
            # æŸ¥æ³•ï¼šæ­£æœˆä¸ï¼ŒäºŒæœˆç”³ï¼Œä¸‰æœˆå£¬ï¼Œå››æœˆè¾›ï¼Œäº”æœˆäº¥ï¼Œå…­æœˆç”²ï¼Œ
            #      ä¸ƒæœˆç™¸ï¼Œå…«æœˆå¯…ï¼Œä¹æœˆä¸™ï¼Œåæœˆä¹™ï¼Œåä¸€æœˆå·³ï¼ŒåäºŒæœˆåºš
            'tiande': {
                'å¯…': 'ä¸',  # æ­£æœˆï¼ˆå¯…æœˆï¼‰- ä¸ âœ…
                'å¯': 'ç”³',  # äºŒæœˆï¼ˆå¯æœˆï¼‰- ç”³ï¼ˆå¤ä½ï¼‰âœ…
                'è¾°': 'å£¬',  # ä¸‰æœˆï¼ˆè¾°æœˆï¼‰- å£¬ âœ…
                'å·³': 'è¾›',  # å››æœˆï¼ˆå·³æœˆï¼‰- è¾› âœ…
                'åˆ': 'äº¥',  # äº”æœˆï¼ˆåˆæœˆï¼‰- äº¥ âœ…
                'æœª': 'ç”²',  # å…­æœˆï¼ˆæœªæœˆï¼‰- ç”² âœ…
                'ç”³': 'ç™¸',  # ä¸ƒæœˆï¼ˆç”³æœˆï¼‰- ç™¸ âœ…
                'é…‰': 'å¯…',  # å…«æœˆï¼ˆé…‰æœˆï¼‰- å¯… âœ…
                'æˆŒ': 'ä¸™',  # ä¹æœˆï¼ˆæˆŒæœˆï¼‰- ä¸™ âœ…
                'äº¥': 'ä¹™',  # åæœˆï¼ˆäº¥æœˆï¼‰- ä¹™ âœ…
                'å­': 'å·³',  # åä¸€æœˆï¼ˆå­æœˆï¼‰- å·³ï¼ˆå·½ä½ï¼‰âœ…
                'ä¸‘': 'åºš',  # åäºŒæœˆï¼ˆä¸‘æœˆï¼‰- åºš âœ…
            },
            
            # ğŸ”¥ ä¿®å¤ï¼šæœˆå¾·è´µäººè¡¨ï¼ˆæŒ‰ä¸‰åˆå±€è®¡ç®—ï¼‰
            # å¯…åˆæˆŒæœˆè§ä¸™ï¼ˆä¸‰åˆç«å±€ï¼‰
            # ç”³å­è¾°æœˆè§å£¬ï¼ˆä¸‰åˆæ°´å±€ï¼‰
            # äº¥å¯æœªæœˆè§ç”²ï¼ˆä¸‰åˆæœ¨å±€ï¼‰
            # å·³é…‰ä¸‘æœˆè§åºšï¼ˆä¸‰åˆé‡‘å±€ï¼‰
            'yuede': {
                'å¯…': 'ä¸™',  # å¯…åˆæˆŒè§ä¸™ âœ…
                'å¯': 'ç”²',  # äº¥å¯æœªè§ç”² âœ…
                'è¾°': 'å£¬',  # ç”³å­è¾°è§å£¬ âœ…
                'å·³': 'åºš',  # å·³é…‰ä¸‘è§åºš âœ…
                'åˆ': 'ä¸™',  # å¯…åˆæˆŒè§ä¸™ âœ…
                'æœª': 'ç”²',  # äº¥å¯æœªè§ç”² âœ…
                'ç”³': 'å£¬',  # ç”³å­è¾°è§å£¬ âœ…
                'é…‰': 'åºš',  # å·³é…‰ä¸‘è§åºš âœ…
                'æˆŒ': 'ä¸™',  # å¯…åˆæˆŒè§ä¸™ âœ…
                'äº¥': 'ç”²',  # äº¥å¯æœªè§ç”² âœ…
                'å­': 'å£¬',  # ç”³å­è¾°è§å£¬ âœ…
                'ä¸‘': 'åºš',  # å·³é…‰ä¸‘è§åºš âœ…
            },
            
            # å¤©ä¹™è´µäººè¡¨ - æŒ‰ã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©ä¹™è´µäººã€‹ç†è®º
            # ã€Šä¸‰å‘½é€šä¼šã€‹å£è¯€ï¼š"ç”²æˆŠè§ç‰›ç¾Šï¼Œä¹™å·±é¼ çŒ´ä¹¡ï¼Œä¸™ä¸çŒªé¸¡ä½ï¼Œå£¬ç™¸å…”è›‡è—ï¼Œå…­è¾›é€¢è™é©¬"
            # æ³¨é‡Šï¼šç‰›=ä¸‘ï¼Œç¾Š=æœªï¼Œé¼ =å­ï¼ŒçŒ´=ç”³ï¼ŒçŒª=äº¥ï¼Œé¸¡=é…‰ï¼Œå…”=å¯ï¼Œè›‡=å·³ï¼Œè™=å¯…ï¼Œé©¬=åˆ
            'tianyi': {
                'ç”²': 'ä¸‘æœª',  # ç”²æˆŠè§ç‰›ç¾Š âœ…
                'ä¹™': 'å­ç”³',  # ä¹™å·±é¼ çŒ´ä¹¡ âœ…
                'ä¸™': 'äº¥é…‰',  # ä¸™ä¸çŒªé¸¡ä½ âœ…
                'ä¸': 'äº¥é…‰',  # ä¸™ä¸çŒªé¸¡ä½ âœ…
                'æˆŠ': 'ä¸‘æœª',  # ç”²æˆŠè§ç‰›ç¾Š âœ…
                'å·±': 'å­ç”³',  # ä¹™å·±é¼ çŒ´ä¹¡ âœ…
                'åºš': 'åˆå¯…',  # å…­è¾›é€¢è™é©¬ï¼ˆåºšåŒè¾›ï¼‰âœ…
                'è¾›': 'åˆå¯…',  # å…­è¾›é€¢è™é©¬ âœ…
                'å£¬': 'å¯å·³',  # å£¬ç™¸å…”è›‡è— âœ…
                'ç™¸': 'å¯å·³',  # å£¬ç™¸å…”è›‡è— âœ…
            },
            
            # æ–‡æ˜Œè´µäººè¡¨ - æŒ‰ã€Šä¸‰å‘½é€šä¼šÂ·è®ºæ–‡æ˜Œè´µäººã€‹ç†è®º
            # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"æ–‡æ˜Œè€…ï¼Œä¸»èªæ˜æ™ºæ…§ï¼Œå­¦ä¸šæœ‰æˆ"
            # æŸ¥æ³•ï¼šç”²å·³ä¹™åˆä¸™æˆŠç”³ï¼Œä¸å·±é…‰ä½åºšäº¥å¯»ï¼Œè¾›å­å£¬å¯…ç™¸å¯çœŸ
            'wenchang': {
                'ç”²': 'å·³',  # ç”²æ—¥ - å·³ âœ…
                'ä¹™': 'åˆ',  # ä¹™æ—¥ - åˆ âœ…
                'ä¸™': 'ç”³',  # ä¸™æ—¥ - ç”³ âœ…
                'ä¸': 'é…‰',  # ä¸æ—¥ - é…‰ âœ…
                'æˆŠ': 'ç”³',  # æˆŠæ—¥ - ç”³ âœ…
                'å·±': 'é…‰',  # å·±æ—¥ - é…‰ âœ…
                'åºš': 'äº¥',  # åºšæ—¥ - äº¥ âœ…
                'è¾›': 'å­',  # è¾›æ—¥ - å­ âœ…
                'å£¬': 'å¯…',  # å£¬æ—¥ - å¯… âœ…
                'ç™¸': 'å¯',  # ç™¸æ—¥ - å¯ âœ…
            },
            
            # ç¾Šåˆƒè¡¨ - æŒ‰ã€Šä¸‰å‘½é€šä¼šÂ·è®ºç¾Šåˆƒã€‹ç†è®º
            # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"ç¾Šåˆƒè€…ï¼Œç¦„å‰ä¸€ä½ä¹Ÿ"
            # æŸ¥æ³•ï¼šç”²åˆƒåœ¨å¯ï¼Œä¹™åˆƒåœ¨å¯…ï¼Œä¸™æˆŠåˆƒåœ¨åˆï¼Œä¸å·±åˆƒåœ¨å·³ï¼Œ
            #      åºšåˆƒåœ¨é…‰ï¼Œè¾›åˆƒåœ¨ç”³ï¼Œå£¬åˆƒåœ¨å­ï¼Œç™¸åˆƒåœ¨äº¥
            'yangren': {
                'ç”²': 'å¯',  # ç”²æ—¥ - å¯ï¼ˆç”²ç¦„åœ¨å¯…ï¼Œåˆƒåœ¨å¯ï¼‰âœ…
                'ä¹™': 'å¯…',  # ä¹™æ—¥ - å¯…ï¼ˆä¹™ç¦„åœ¨å¯ï¼Œåˆƒåœ¨å¯…ï¼‰âœ…
                'ä¸™': 'åˆ',  # ä¸™æ—¥ - åˆï¼ˆä¸™æˆŠç¦„åœ¨å·³ï¼Œåˆƒåœ¨åˆï¼‰âœ…
                'ä¸': 'å·³',  # ä¸æ—¥ - å·³ï¼ˆä¸å·±ç¦„åœ¨åˆï¼Œåˆƒåœ¨å·³ï¼‰âœ…
                'æˆŠ': 'åˆ',  # æˆŠæ—¥ - åˆï¼ˆä¸™æˆŠç¦„åœ¨å·³ï¼Œåˆƒåœ¨åˆï¼‰âœ…
                'å·±': 'å·³',  # å·±æ—¥ - å·³ï¼ˆä¸å·±ç¦„åœ¨åˆï¼Œåˆƒåœ¨å·³ï¼‰âœ…
                'åºš': 'é…‰',  # åºšæ—¥ - é…‰ï¼ˆåºšç¦„åœ¨ç”³ï¼Œåˆƒåœ¨é…‰ï¼‰âœ…
                'è¾›': 'ç”³',  # è¾›æ—¥ - ç”³ï¼ˆè¾›ç¦„åœ¨é…‰ï¼Œåˆƒåœ¨ç”³ï¼‰âœ…
                'å£¬': 'å­',  # å£¬æ—¥ - å­ï¼ˆå£¬ç¦„åœ¨äº¥ï¼Œåˆƒåœ¨å­ï¼‰âœ…
                'ç™¸': 'äº¥',  # ç™¸æ—¥ - äº¥ï¼ˆç™¸ç¦„åœ¨å­ï¼Œåˆƒåœ¨äº¥ï¼‰âœ…
            }
        }
    
    def _analyze_ji_shen(self, bazi_data: BaziData) -> List[Dict[str, Any]]:
        """åˆ†æå‰ç¥"""
        ji_shen = []
        pillars = bazi_data.get_pillars()
        day_master = bazi_data.get_day_master()
        month_branch = bazi_data.get_month_branch()
        
        # å¤©å¾·è´µäºº
        tiande_target = self.shensha_tables['tiande'].get(month_branch)
        if tiande_target:
            for pillar, (gan, zhi) in pillars.items():
                if gan == tiande_target:
                    ji_shen.append({
                        'name': 'å¤©å¾·è´µäºº',
                        'level': 'å¤§å‰',
                        'position': pillar,
                        'description': 'å¤©å¾·åŠäººï¼Œå‰è”ä¸€èº«ï¼Œäº‹å‡å‰è´¤ã€‚',
                        'weight': 15
                    })
                    break
        
        # æœˆå¾·è´µäºº
        yuede_target = self.shensha_tables['yuede'].get(month_branch)
        if yuede_target:
            for pillar, (gan, zhi) in pillars.items():
                if gan == yuede_target:
                    ji_shen.append({
                        'name': 'æœˆå¾·è´µäºº',
                        'level': 'å¤§å‰',
                        'position': pillar,
                        'description': 'æœˆå¾·è´µäººï¼Œé€¢å‡¶åŒ–å‰ï¼Œé‡éš¾å‘ˆç¥¥ã€‚',
                        'weight': 12
                    })
                    break
        
        # å¤©ä¹™è´µäºº
        tianyi_targets = self.shensha_tables['tianyi'].get(day_master, '')
        if tianyi_targets:
            for pillar, (gan, zhi) in pillars.items():
                if zhi in tianyi_targets:
                    ji_shen.append({
                        'name': 'å¤©ä¹™è´µäºº',
                        'level': 'å¤§å‰',
                        'position': pillar,
                        'description': 'å¤©ä¹™è´µäººï¼Œé€¢å‡¶åŒ–å‰ï¼Œé‡éš¾å‘ˆç¥¥ã€‚',
                        'weight': 15
                    })
        
        # æ–‡æ˜Œè´µäººï¼ˆæŒ‰æ—¥å¹²ï¼‰
        wenchang_target = self.shensha_tables['wenchang'].get(day_master)
        if wenchang_target:
            for pillar, (gan, zhi) in pillars.items():
                if zhi == wenchang_target:
                    ji_shen.append({
                        'name': 'æ–‡æ˜Œè´µäºº',
                        'level': 'ä¸­å‰',
                        'position': pillar,
                        'description': 'æ–‡æ˜Œè´µäººï¼Œä¸»èªæ˜æ™ºæ…§ï¼Œå­¦ä¸šæœ‰æˆã€‚',
                        'weight': 10
                    })
                    break
        
        # å­¦å ‚ï¼ˆæŒ‰æ—¥å¹²ï¼‰
        xuetang_target = self._get_xuetang(day_master)
        if xuetang_target:
            for pillar, (gan, zhi) in pillars.items():
                if zhi == xuetang_target:
                    ji_shen.append({
                        'name': 'å­¦å ‚',
                        'level': 'ä¸­å‰',
                        'position': pillar,
                        'description': 'å­¦å ‚æ˜Ÿï¼Œä¸»å­¦ä¹ èƒ½åŠ›ï¼Œå®œè¿›ä¿®æ·±é€ ã€‚',
                        'weight': 8
                    })
                    break
        
        # è¯é¦†ï¼ˆæŒ‰æ—¥å¹²ï¼‰
        ciguan_target = self._get_ciguan(day_master)
        if ciguan_target:
            for pillar, (gan, zhi) in pillars.items():
                if zhi == ciguan_target:
                    ji_shen.append({
                        'name': 'è¯é¦†',
                        'level': 'ä¸­å‰',
                        'position': pillar,
                        'description': 'è¯é¦†æ˜Ÿï¼Œä¸»æ–‡é‡‡å£æ‰ï¼Œå®œä»äº‹æ–‡åŒ–å·¥ä½œã€‚',
                        'weight': 8
                    })
                    break
        
        # ç¦„ç¥ï¼ˆæŒ‰æ—¥å¹²ï¼‰
        lushen_target = self._get_lushen(day_master)
        if lushen_target:
            for pillar, (gan, zhi) in pillars.items():
                if zhi == lushen_target:
                    ji_shen.append({
                        'name': 'ç¦„ç¥',
                        'level': 'å¤§å‰',
                        'position': pillar,
                        'description': 'ç¦„ç¥æ˜Ÿï¼Œä¸»å¯Œè´µè£åï¼Œå®œç§¯æè¿›å–ã€‚',
                        'weight': 12
                    })
                    break

        # ğŸ”¥ ä¿®å¤ï¼šåç›–ï¼ˆä»¥æ—¥æ”¯ä¸ºåŸºå‡†ï¼ŒæŒ‰ã€Šä¸‰å‘½é€šä¼šã€‹ç†è®ºï¼‰
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"åç›–è€…ï¼Œå–»å¦‚å®ç›–ï¼Œå¤©æœ‰æ­¤æ˜Ÿå…¶å½¢å¦‚ç›–ï¼Œå¤šä¸»å­¤å¯¡ï¼Œçºµè´µäº¦ä¸å…å­¤ç‹¬ã€‚"
        # æŸ¥æ³•ï¼šå¯…åˆæˆŒè§æˆŒï¼Œäº¥å¯æœªè§æœªï¼Œç”³å­è¾°è§è¾°ï¼Œå·³é…‰ä¸‘è§ä¸‘ã€‚
        day_branch = pillars['day'][1]
        huagai_target = self._huagai(day_branch)  # ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨æ—¥æ”¯è€Œä¸æ˜¯å¹´æ”¯
        if huagai_target:
            for pillar, (gan, zhi) in pillars.items():
                if zhi == huagai_target:
                    ji_shen.append({
                        'name': 'åç›–',
                        'level': 'ä¸­å‰',  # ğŸ”¥ ä¿®å¤ï¼šåç›–æ˜¯ä¸­æ€§åå‰ï¼Œä¸»è‰ºæœ¯æ‰å
                        'position': pillar,
                        'description': 'åç›–é«˜æ¦‚ï¼Œä¸»è‰ºæœ¯æ‰åã€æ¸…é«˜å­¤å‚²ï¼Œå®œå‘å±•æ–‡åŒ–ã€è‰ºæœ¯æ–¹é¢çš„æ‰èƒ½ã€‚',
                        'weight': 8  # ğŸ”¥ ä¿®å¤ï¼šç»™äºˆé€‚å½“æƒé‡
                    })
                    break

        # çº¢é¸¾ã€å¤©å–œï¼ˆæŒ‰å¹´æ”¯å¼•åŠ¨ï¼‰
        year_branch = pillars['year'][1]
        hongluan_target, tianxi_target = self._hongluan_tianxi_by_year(year_branch)
        for pillar, (gan, zhi) in pillars.items():
            if zhi == hongluan_target:
                ji_shen.append({
                    'name': 'çº¢é¸¾',
                    'level': 'å°å‰',
                    'position': pillar,
                    'description': 'çº¢é¸¾æ˜ŸåŠ¨ï¼Œä¸»å©šå–œäººç¼˜ï¼Œå®œæŠŠæ¡è‰¯æœºã€‚',
                    'weight': 6
                })
            if zhi == tianxi_target:
                ji_shen.append({
                    'name': 'å¤©å–œ',
                    'level': 'å°å‰',
                    'position': pillar,
                    'description': 'å¤©å–œæ˜ŸåŠ¨ï¼Œä¸»å–œåº†å‰ç¥¥ï¼Œå®œç§¯æè¿›å–ã€‚',
                    'weight': 6
                })

        # ğŸ”¥ ä¿®å¤ï¼šé©¿é©¬æ˜Ÿï¼ˆä»¥å¹´æ”¯ä¸ºåŸºå‡†ï¼ŒæŒ‰ã€Šä¸‰å‘½é€šä¼šã€‹ç†è®ºï¼‰
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"é©¿é©¬è€…ï¼Œä¸‰åˆå±€å¯¹å†²ä¹Ÿã€‚ç”³å­è¾°é©¬åœ¨å¯…ï¼Œå¯…åˆæˆŒé©¬åœ¨ç”³ï¼Œå·³é…‰ä¸‘é©¬åœ¨äº¥ï¼Œäº¥å¯æœªé©¬åœ¨å·³ã€‚"
        # é©¿é©¬ä¸»å˜åŠ¨ã€å‡ºè¡Œã€äº‹ä¸šå˜è¿ï¼Œä¸€èˆ¬ç®—ä¸­æ€§åå‰ï¼Œåˆ©äºäº‹ä¸šå‘å±•
        yima_target = self._yima(year_branch)
        if yima_target:
            for pillar, (gan, zhi) in pillars.items():
                if zhi == yima_target:
                    ji_shen.append({
                        'name': 'é©¿é©¬',
                        'level': 'å°å‰',
                        'position': pillar,
                        'description': 'é©¿é©¬å¼€é€šï¼Œä¸»åŠ¨å˜åŠ¨ã€å‡ºè¡Œã€äº‹ä¸šå˜è¿ï¼Œå¤„ç†å¤–å‡ºäº‹åŠ¡æœ‰åˆ©ã€‚',
                        'weight': 6
                    })
                    break

        # ğŸ”¥ æ–°å¢ï¼šå°†æ˜Ÿï¼ˆæŒ‰å¹´æ”¯æŸ¥æ³•ï¼ŒæŒ‰ã€Šä¸‰å‘½é€šä¼šã€‹ç†è®ºï¼‰
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å°†æ˜Ÿè€…ï¼Œä¸‰åˆå±€ä¸­ç¥ä¹Ÿã€‚å¯…åˆæˆŒè§åˆï¼Œç”³å­è¾°è§å­ï¼Œäº¥å¯æœªè§å¯ï¼Œå·³é…‰ä¸‘è§é…‰ã€‚"
        # å°†æ˜Ÿä¸»é¢†å¯¼æ‰èƒ½ã€æƒå¨ã€äº‹ä¸šæˆå°±
        jiangxing_target = self._jiangxing(year_branch)
        if jiangxing_target:
            for pillar, (gan, zhi) in pillars.items():
                if zhi == jiangxing_target:
                    ji_shen.append({
                        'name': 'å°†æ˜Ÿ',
                        'level': 'å¤§å‰',
                        'position': pillar,
                        'description': 'å°†æ˜Ÿä¸´å‘½ï¼Œä¸»é¢†å¯¼æ‰èƒ½ã€æƒå¨æ˜¾èµ«ï¼Œäº‹ä¸šæœ‰æˆï¼Œå®œç§¯æè¿›å–ã€‚',
                        'weight': 12
                    })
                    break

        # ğŸ”¥ æ–°å¢ï¼šé‡‘èˆ†ï¼ˆæŒ‰æ—¥å¹²æŸ¥æ³•ï¼ŒæŒ‰ã€Šä¸‰å‘½é€šä¼šã€‹ç†è®ºï¼‰
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"é‡‘èˆ†è€…ï¼Œæ—¥å¹²ä¸´é•¿ç”ŸåäºŒå®«ä¹‹å¸æ—ºä½ä¹Ÿã€‚"
        # ç®€åŒ–æŸ¥æ³•ï¼šç”²æ—¥è§è¾°ï¼Œä¹™æ—¥è§å·³ï¼Œä¸™æ—¥è§æœªï¼Œä¸æ—¥è§ç”³ï¼ŒæˆŠæ—¥è§æœªï¼Œå·±æ—¥è§ç”³ï¼Œåºšæ—¥è§æˆŒï¼Œè¾›æ—¥è§äº¥ï¼Œå£¬æ—¥è§ä¸‘ï¼Œç™¸æ—¥è§å¯…
        jinyu_target = self._jinyu(day_master)
        if jinyu_target:
            for pillar, (gan, zhi) in pillars.items():
                if zhi == jinyu_target:
                    ji_shen.append({
                        'name': 'é‡‘èˆ†',
                        'level': 'ä¸­å‰',
                        'position': pillar,
                        'description': 'é‡‘èˆ†ä¸´å‘½ï¼Œä¸»å¯Œè´µè£åï¼Œè½¦é©¬æ˜¾è¾¾ï¼Œå®œç§¯æè¿›å–ã€‚',
                        'weight': 10
                    })
                    break

        # ğŸ”¥ æ–°å¢ï¼šå¤ªæè´µäººï¼ˆæŒ‰æ—¥å¹²æŸ¥æ³•ï¼ŒæŒ‰ã€Šä¸‰å‘½é€šä¼šã€‹ç†è®ºï¼‰
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å¤ªæè€…ï¼Œå¤©åœ°æœªåˆ†ï¼Œæ··æ²Œåˆå¼€ä¹Ÿã€‚"
        # æŸ¥æ³•ï¼šç”²ä¹™æ—¥è§å­åˆï¼Œä¸™ä¸æ—¥è§å¯é…‰ï¼ŒæˆŠå·±æ—¥è§è¾°æˆŒä¸‘æœªï¼Œåºšè¾›æ—¥è§å¯…ç”³ï¼Œå£¬ç™¸æ—¥è§å·³äº¥
        taiji_targets = self._taiji_guiren(day_master)
        if taiji_targets:
            for pillar, (gan, zhi) in pillars.items():
                if zhi in taiji_targets:
                    ji_shen.append({
                        'name': 'å¤ªæè´µäºº',
                        'level': 'å¤§å‰',
                        'position': pillar,
                        'description': 'å¤ªæè´µäººä¸´å‘½ï¼Œä¸»èªæ˜æ™ºæ…§ï¼Œå­¦é—®æ·±åšï¼Œå®œä»äº‹æ–‡åŒ–ã€å“²å­¦ã€å®—æ•™ç­‰é¢†åŸŸã€‚',
                        'weight': 12
                    })
                    break

        # ğŸ”¥ æ–°å¢ï¼šå›½å°è´µäººï¼ˆæŒ‰å¹´å¹²æŸ¥æ³•ï¼ŒæŒ‰ã€Šä¸‰å‘½é€šä¼šã€‹ç†è®ºï¼‰
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å›½å°è€…ï¼Œæœå»·ä¹‹å°ä¹Ÿã€‚"
        # æŸ¥æ³•ï¼šç”²è§æˆŒï¼Œä¹™è§äº¥ï¼Œä¸™è§ä¸‘ï¼Œä¸è§å¯…ï¼ŒæˆŠè§ä¸‘ï¼Œå·±è§å¯…ï¼Œåºšè§è¾°ï¼Œè¾›è§å·³ï¼Œå£¬è§æœªï¼Œç™¸è§ç”³
        guoyin_target = self._guoyin_guiren(bazi_data.get_pillars()['year'][0])
        if guoyin_target:
            for pillar, (gan, zhi) in pillars.items():
                if zhi == guoyin_target:
                    ji_shen.append({
                        'name': 'å›½å°è´µäºº',
                        'level': 'å¤§å‰',
                        'position': pillar,
                        'description': 'å›½å°è´µäººä¸´å‘½ï¼Œä¸»å®˜è¿äº¨é€šï¼ŒæŒæƒæœ‰å°ï¼Œå®œä»äº‹å…¬èŒã€ç®¡ç†ç­‰å·¥ä½œã€‚',
                        'weight': 13
                    })
                    break

        # ğŸ”¥ æ–°å¢ï¼šç¦æ˜Ÿè´µäººï¼ˆæŒ‰æ—¥å¹²æŸ¥æ³•ï¼ŒæŒ‰ã€Šä¸‰å‘½é€šä¼šã€‹ç†è®ºï¼‰
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"ç¦æ˜Ÿè€…ï¼Œç¦å¾·ä¹‹æ˜Ÿä¹Ÿã€‚"
        # æŸ¥æ³•ï¼šç”²è§ä¸™ï¼Œä¹™è§ä¸ï¼Œä¸™è§æˆŠï¼Œä¸è§å·±ï¼ŒæˆŠè§åºšï¼Œå·±è§è¾›ï¼Œåºšè§å£¬ï¼Œè¾›è§ç™¸ï¼Œå£¬è§ç”²ï¼Œç™¸è§ä¹™
        fuxing_target = self._fuxing_guiren(day_master)
        if fuxing_target:
            for pillar, (gan, zhi) in pillars.items():
                if gan == fuxing_target:
                    ji_shen.append({
                        'name': 'ç¦æ˜Ÿè´µäºº',
                        'level': 'ä¸­å‰',
                        'position': pillar,
                        'description': 'ç¦æ˜Ÿè´µäººä¸´å‘½ï¼Œä¸»ç¦æ°”æ·±åšï¼Œç”Ÿæ´»å®‰é€¸ï¼Œå®œçŸ¥è¶³å¸¸ä¹ã€‚',
                        'weight': 10
                    })
                    break

        # ğŸ”¥ æ–°å¢ï¼šä¸‰å¥‡è´µäººï¼ˆæŒ‰å¹´æœˆæ—¥å¹²æŸ¥æ³•ï¼ŒæŒ‰ã€Šä¸‰å‘½é€šä¼šã€‹ç†è®ºï¼‰
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"ä¸‰å¥‡è€…ï¼Œå¤©åœ°äººä¸‰å¥‡ä¹Ÿã€‚å¤©ä¸Šä¸‰å¥‡ï¼šç”²æˆŠåºšï¼›åœ°ä¸‹ä¸‰å¥‡ï¼šä¹™ä¸™ä¸ï¼›äººä¸­ä¸‰å¥‡ï¼šå£¬ç™¸è¾›ã€‚"
        sanqi_result = self._sanqi_guiren(pillars)
        if sanqi_result:
            ji_shen.append({
                'name': 'ä¸‰å¥‡è´µäºº',
                'level': 'å¤§å‰',
                'position': sanqi_result['position'],
                'description': f"ä¸‰å¥‡è´µäººä¸´å‘½ï¼ˆ{sanqi_result['type']}ï¼‰ï¼Œä¸»å¥‡æ‰å¼‚ç¦€ï¼Œéå‡¡æˆå°±ï¼Œå®œæŠŠæ¡æœºé‡ã€‚",
                'weight': 15
            })

        # ğŸ”¥ æ–°å¢ï¼šå¤©å®˜è´µäººï¼ˆæŒ‰æ—¥å¹²æŸ¥æ³•ï¼ŒæŒ‰ã€Šä¸‰å‘½é€šä¼šã€‹ç†è®ºï¼‰
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å¤©å®˜è€…ï¼Œå¤©ä¹‹æ‰€æˆä¹Ÿã€‚"
        # æŸ¥æ³•ï¼šç”²è§æœªï¼Œä¹™è§ç”³ï¼Œä¸™è§é…‰ï¼Œä¸è§æˆŒï¼ŒæˆŠè§äº¥ï¼Œå·±è§å­ï¼Œåºšè§ä¸‘ï¼Œè¾›è§å¯…ï¼Œå£¬è§å¯ï¼Œç™¸è§è¾°
        tianguan_target = self._tianguan_guiren(day_master)
        if tianguan_target:
            for pillar, (gan, zhi) in pillars.items():
                if zhi == tianguan_target:
                    ji_shen.append({
                        'name': 'å¤©å®˜è´µäºº',
                        'level': 'ä¸­å‰',
                        'position': pillar,
                        'description': 'å¤©å®˜è´µäººä¸´å‘½ï¼Œä¸»å®˜è¿äº¨é€šï¼Œå®œä»äº‹å…¬èŒã€ç®¡ç†ç­‰å·¥ä½œã€‚',
                        'weight': 11
                    })
                    break

        # ğŸ”¥ æ–°å¢ï¼šå¤©èµ¦ï¼ˆæŒ‰æ—¥å¹²æ—¥æ”¯æŸ¥æ³•ï¼ŒæŒ‰ã€Šä¸‰å‘½é€šä¼šã€‹ç†è®ºï¼‰
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å¤©èµ¦è€…ï¼Œå¤©ä¹‹æ‰€èµ¦ä¹Ÿã€‚"
        # æŸ¥æ³•ï¼šæ˜¥ï¼ˆå¯…å¯è¾°ï¼‰æˆŠå¯…æ—¥ï¼Œå¤ï¼ˆå·³åˆæœªï¼‰ç”²åˆæ—¥ï¼Œç§‹ï¼ˆç”³é…‰æˆŒï¼‰æˆŠç”³æ—¥ï¼Œå†¬ï¼ˆäº¥å­ä¸‘ï¼‰ç”²å­æ—¥
        day_branch = pillars['day'][1]
        tianshe_result = self._tianshe(day_master, day_branch, month_branch)
        if tianshe_result:
            ji_shen.append({
                'name': 'å¤©èµ¦',
                'level': 'å¤§å‰',
                'position': 'day',
                'description': 'å¤©èµ¦ä¸´å‘½ï¼Œä¸»é€¢å‡¶åŒ–å‰ï¼Œé‡éš¾å‘ˆç¥¥ï¼Œå®œç§¯æè¿›å–ã€‚',
                'weight': 14
            })

        return ji_shen
    
    def _analyze_xiong_shen(self, bazi_data: BaziData) -> List[Dict[str, Any]]:
        """åˆ†æå‡¶ç¥"""
        # âœ… ä¿®å¤ï¼šåœ¨å‡½æ•°å¼€å§‹å°±å»ºç«‹å»é‡æœºåˆ¶ï¼Œç¡®ä¿æ¯ä¸ªå‡¶ç¥ç±»å‹åªæ·»åŠ ä¸€æ¬¡
        xiong_shen = []
        xiong_shen_names_seen = set()  # è®°å½•å·²æ·»åŠ çš„å‡¶ç¥åç§°ï¼ˆç”¨äºæœ€ç»ˆå»é‡æ£€æŸ¥ï¼‰
        pillars = bazi_data.get_pillars()
        day_master = bazi_data.get_day_master()
        month_branch = bazi_data.get_month_branch()
        
        # âœ… ç»Ÿä¸€ï¼šç¾Šåˆƒï¼ˆæŒ‰æ—¥å¹²æŸ¥è¡¨æ³•ï¼Œä¸èƒ½ç”¨ä¸‰åˆ/å…­åˆæ³•ï¼‰
        # ã€Šä¸‰å‘½é€šä¼šÂ·è®ºç¾Šåˆƒã€‹ï¼š"ç¾Šåˆƒè€…ï¼Œç¦„å‰ä¸€ä½ä¹Ÿ"
        # è¯´æ˜ï¼šç¾Šåˆƒæ˜¯"ç¦„å‰ä¸€ä½"çš„å…³ç³»ï¼Œä¸èƒ½ç”¨ä¸‰åˆ/å…­åˆæ³•è®¡ç®—ï¼Œå¿…é¡»ç”¨æŸ¥è¡¨æ³•
        # ç†è®ºä¾æ®ï¼šç”²ç¦„åœ¨å¯…ï¼Œåˆƒåœ¨å¯ï¼ˆå¯…å‰ä¸€ä½ï¼‰ï¼›ä¹™ç¦„åœ¨å¯ï¼Œåˆƒåœ¨å¯…ï¼ˆå¯å‰ä¸€ä½ï¼‰ç­‰
        yangren_target = self.shensha_tables['yangren'].get(day_master)
        if yangren_target:
            for pillar, (gan, zhi) in pillars.items():
                if zhi == yangren_target:
                    xiong_shen.append({
                        'name': 'ç¾Šåˆƒ',
                        'level': 'å¤§å‡¶',
                        'position': pillar,
                        'description': 'ç¾Šåˆƒä¸»åˆ‘ä¼¤ï¼Œæ€§æ ¼åˆšçƒˆï¼Œæ˜“æœ‰è¡€å…‰ä¹‹ç¾ã€‚ï¼ˆæŒ‰æ—¥å¹²æŸ¥è¡¨æ³•ï¼Œä¸èƒ½ç”¨ä¸‰åˆ/å…­åˆæ³•ï¼‰',
                        'weight': 12
                    })
                    break
        
        # âœ… ç»Ÿä¸€ï¼šåŠ«ç…ï¼ˆä¸‰åˆå±€ç»åœ°æ³•ï¼‰- åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹åŸæ–‡
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"æ°´ç»åœ¨å·³ï¼Œç”³å­è¾°ä»¥å·³ä¸ºåŠ«ç…ï¼›ç«ç»åœ¨äº¥ï¼Œå¯…åˆæˆŒä»¥äº¥ä¸ºåŠ«ç…ï¼›
        #                é‡‘ç»åœ¨å¯…ï¼Œå·³é…‰ä¸‘ä»¥å¯…ä¸ºåŠ«ç…ï¼›æœ¨ç»åœ¨ç”³ï¼Œäº¥å¯æœªä»¥ç”³ä¸ºåŠ«ç…"
        # âœ… ä¸‰åˆæ³•æŸ¥æ³•ï¼ˆåŸºäºäº”è¡ŒåäºŒé•¿ç”Ÿç»åœ°ï¼‰ï¼š
        # - ç”³å­è¾°ï¼ˆæ°´å±€ï¼‰ï¼šåŠ«ç…åœ¨å·³ï¼ˆæ°´ç»äºå·³ï¼‰âœ… ä¸‰åˆæ³•
        # - å¯…åˆæˆŒï¼ˆç«å±€ï¼‰ï¼šåŠ«ç…åœ¨äº¥ï¼ˆç«ç»äºäº¥ï¼‰âœ… ä¸‰åˆæ³•
        # - å·³é…‰ä¸‘ï¼ˆé‡‘å±€ï¼‰ï¼šåŠ«ç…åœ¨å¯…ï¼ˆé‡‘ç»äºå¯…ï¼‰âœ… ä¸‰åˆæ³•
        # - äº¥å¯æœªï¼ˆæœ¨å±€ï¼‰ï¼šåŠ«ç…åœ¨ç”³ï¼ˆæœ¨ç»äºç”³ï¼‰âœ… ä¸‰åˆæ³•
        # ç†è®ºä¾æ®ï¼šäº”è¡ŒåäºŒé•¿ç”Ÿè¡¨ï¼ˆç»åœ°ï¼‰
        SANHE_JIESHA_MAP = {
            ('ç”³', 'å­', 'è¾°'): 'å·³',  # ç”³å­è¾°æ°´å±€ -> åŠ«ç…åœ¨å·³
            ('å¯…', 'åˆ', 'æˆŒ'): 'äº¥',  # å¯…åˆæˆŒç«å±€ -> åŠ«ç…åœ¨äº¥
            ('å·³', 'é…‰', 'ä¸‘'): 'å¯…',  # å·³é…‰ä¸‘é‡‘å±€ -> åŠ«ç…åœ¨å¯…
            ('äº¥', 'å¯', 'æœª'): 'ç”³',  # äº¥å¯æœªæœ¨å±€ -> åŠ«ç…åœ¨ç”³
        }
        
        # è·å–å››æŸ±åœ°æ”¯
        all_branches = [pillars[pos][1] for pos in ['year', 'month', 'day', 'hour']]
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å®Œæ•´ä¸‰åˆå±€ï¼ˆå¿…é¡»3ä¸ªåœ°æ”¯ï¼‰
        for sanhe_branches, jiesha_branch in SANHE_JIESHA_MAP.items():
            # æ£€æŸ¥å››æŸ±ä¸­æ˜¯å¦åŒ…å«ä¸‰åˆå±€çš„æ‰€æœ‰3ä¸ªåœ°æ”¯
            sanhe_count = sum(1 for b in sanhe_branches if b in all_branches)
            
            # ğŸ”¥ ä¿®å¤ï¼šåªæœ‰å®Œæ•´ä¸‰åˆå±€ï¼ˆ3ä¸ªåœ°æ”¯ï¼‰æ‰ç®—æˆå±€
            if sanhe_count >= 3:
                # æ£€æŸ¥å››æŸ±ä¸­æ˜¯å¦æœ‰åŠ«ç…ä½
                for pillar, (gan, zhi) in pillars.items():
                    if zhi == jiesha_branch:
                        xiong_shen.append({
                            'name': 'åŠ«ç…',
                            'level': 'ä¸­å‡¶',
                            'position': pillar,
                            'description': 'åŠ«ç…ä¸»ç ´è´¢ï¼Œæ˜“é­å°äººï¼Œäº‹ä¸šä¸é¡ºã€‚',
                            'weight': 8
                        })
                        break  # ä¸€ä¸ªä¸‰åˆå±€åªç®—ä¸€æ¬¡åŠ«ç…
        
        # âœ… ç»Ÿä¸€ï¼šå­¤è¾°ã€å¯¡å®¿ï¼ˆåŸºäºä¸‰åˆå±€æŸ¥è¡¨æ³•ï¼‰
        # ã€Šä¸‰å‘½é€šä¼šÂ·è®ºå­¤è¾°å¯¡å®¿ã€‹ï¼šæŒ‰å¹´æ”¯ä¸‰åˆå±€æŸ¥è¡¨
        # ç†è®ºä¾æ®ï¼šä¸‰åˆå±€çš„å‰åè¾°ä½
        # - ç”³å­è¾°ï¼ˆæ°´å±€ï¼‰ï¼šå­¤è¾°åœ¨å¯…ï¼ˆå‰è¾°ï¼‰ï¼Œå¯¡å®¿åœ¨æˆŒï¼ˆåè¾°ï¼‰
        # - äº¥å¯æœªï¼ˆæœ¨å±€ï¼‰ï¼šå­¤è¾°åœ¨å·³ï¼ˆå‰è¾°ï¼‰ï¼Œå¯¡å®¿åœ¨ä¸‘ï¼ˆåè¾°ï¼‰
        # - å¯…åˆæˆŒï¼ˆç«å±€ï¼‰ï¼šå­¤è¾°åœ¨ç”³ï¼ˆå‰è¾°ï¼‰ï¼Œå¯¡å®¿åœ¨è¾°ï¼ˆåè¾°ï¼‰
        # - å·³é…‰ä¸‘ï¼ˆé‡‘å±€ï¼‰ï¼šå­¤è¾°åœ¨äº¥ï¼ˆå‰è¾°ï¼‰ï¼Œå¯¡å®¿åœ¨æœªï¼ˆåè¾°ï¼‰
        year_branch = pillars['year'][1]
        gucheng_target, guasu_target = self._gucheng_guasu(year_branch)
        gucheng_found = False
        guasu_found = False
        for pillar, (gan, zhi) in pillars.items():
            if not gucheng_found and zhi == gucheng_target:
                xiong_shen.append({
                    'name': 'å­¤è¾°',
                    'level': 'å°å‡¶',
                    'position': pillar,
                    'description': 'å­¤è¾°ä¸»æ€§æƒ…å­¤å‚²ï¼Œå®œå¢è¿›æ²Ÿé€šä¸åˆä½œã€‚ï¼ˆä¸‰åˆå±€æŸ¥è¡¨æ³•ï¼‰',
                    'weight': 5
                })
                gucheng_found = True
            if not guasu_found and zhi == guasu_target:
                xiong_shen.append({
                    'name': 'å¯¡å®¿',
                    'level': 'å°å‡¶',
                    'position': pillar,
                    'description': 'å¯¡å®¿ä¸»ç‹¬å¤„å°‘ç¼˜ï¼Œå®œé‡è§†æƒ…æ„Ÿç»´ç³»ã€‚ï¼ˆä¸‰åˆå±€æŸ¥è¡¨æ³•ï¼‰',
                    'weight': 5
                })
                guasu_found = True

        # ğŸ”¥ ä¿®å¤ï¼šåç›–åº”è¯¥åœ¨å‰ç¥åˆ—è¡¨ä¸­ï¼Œè€Œä¸æ˜¯å‡¶ç¥åˆ—è¡¨
        # åç›–åˆ¤æ–­å·²ç»ç§»åˆ° _analyze_ji_shen æ–¹æ³•ä¸­

        # âœ… ç»Ÿä¸€ï¼šç©ºäº¡ï¼ˆ60ç”²å­æ—¬ç©ºæ³•ï¼Œä¸èƒ½ç”¨ä¸‰åˆ/å…­åˆæ³•ï¼‰
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"ç©ºäº¡è€…ï¼Œå…­ç”²æ—¬ç©ºä¹Ÿ"
        # è¯´æ˜ï¼šç©ºäº¡æ˜¯åŸºäº60ç”²å­æ—¬çš„æŸ¥æ³•ï¼Œä¸èƒ½ç”¨ä¸‰åˆ/å…­åˆæ³•ï¼Œå¿…é¡»ç”¨60ç”²å­æ—¬ç©ºæ³•
        # ç†è®ºä¾æ®ï¼šæ¯ä¸ªæ—¬æœ‰10ä¸ªå¹²æ”¯ï¼Œå‰©ä¸‹çš„2ä¸ªåœ°æ”¯ä¸ºç©ºäº¡
        day_pillar = pillars['day']
        kongwang_pair = self._kongwang(day_pillar)
        if kongwang_pair:
            kongwang_positions = []
            for pillar, (gan, zhi) in pillars.items():
                if zhi in kongwang_pair:
                    kongwang_positions.append(pillar)
            
            # æ”¶é›†å®Œæ‰€æœ‰ä½ç½®åå†æ·»åŠ ï¼Œé¿å…é‡å¤
            if kongwang_positions:
                xiong_shen.append({
                    'name': 'ç©ºäº¡',
                    'level': 'å°å‡¶',
                    'position': 'ã€'.join(kongwang_positions) if len(kongwang_positions) > 1 else kongwang_positions[0],
                    'description': 'ç©ºäº¡ä¸»è™šè€—ï¼Œäº‹å¤šåå¤ï¼Œå®œç¨³å¥è¡Œäº‹ã€‚ï¼ˆ60ç”²å­æ—¬ç©ºæ³•ï¼Œä¸èƒ½ç”¨ä¸‰åˆ/å…­åˆæ³•ï¼‰',
                    'weight': 4
                })

        # âœ… ç»Ÿä¸€ï¼šå¤©ç½—åœ°ç½‘ï¼ˆåŸºäºä¼ ç»ŸæŸ¥è¡¨æ³•ï¼Œæ— æ˜ç¡®ä¸‰åˆ/å…­åˆæ³•ä¾æ®ï¼‰
        # è¯´æ˜ï¼šå¤©ç½—åœ°ç½‘æœ‰å¤šç§æŸ¥æ³•ï¼Œä½†éƒ½æ²¡æœ‰æ˜ç¡®çš„ä¸‰åˆå±€æˆ–å…­åˆæ³•ä¾æ®
        # ä¼ ç»ŸæŸ¥æ³•ï¼šè¾°æˆŒå¹´æ”¯è§æˆŒäº¥ä¸ºå¤©ç½—ï¼Œå·³äº¥å¹´æ”¯è§è¾°å·³ä¸ºåœ°ç½‘
        # âš ï¸ æ³¨æ„ï¼šæ­¤ç¥ç…ä¸èƒ½ç”¨ä¸‰åˆ/å…­åˆæ³•ï¼Œé‡‡ç”¨ä¼ ç»ŸæŸ¥è¡¨æ³•
        year_branch = pillars['year'][1]
        # âœ… ä¿®å¤ï¼šå¤©ç½—åœ°ç½‘åªæ·»åŠ ä¸€æ¬¡ï¼Œé¿å…é‡å¤
        if year_branch in {'è¾°', 'æˆŒ'}:
            # å¤©ç½—ï¼šè¾°æˆŒå¹´æ”¯ï¼Œå››æŸ±è§æˆŒäº¥ï¼ˆä¼ ç»ŸæŸ¥è¡¨æ³•ï¼Œéä¸‰åˆ/å…­åˆæ³•ï¼‰
            tianluo_positions = []
            for pillar, (gan, zhi) in pillars.items():
                if zhi in {'æˆŒ', 'äº¥'}:
                    tianluo_positions.append(pillar)
            
            if tianluo_positions:
                xiong_shen.append({
                    'name': 'å¤©ç½—',
                    'level': 'ä¸­å‡¶',
                    'position': 'ã€'.join(tianluo_positions) if len(tianluo_positions) > 1 else tianluo_positions[0],
                    'description': 'å¤©ç½—ä¸»å›°ç¼šé˜»æ»ï¼Œå®œé¿é™©è¶‹å‰ã€‚ï¼ˆä¼ ç»ŸæŸ¥è¡¨æ³•ï¼Œéä¸‰åˆ/å…­åˆæ³•ï¼‰',
                    'weight': 6
                })
        elif year_branch in {'å·³', 'äº¥'}:
            # åœ°ç½‘ï¼šå·³äº¥å¹´æ”¯ï¼Œå››æŸ±è§è¾°å·³ï¼ˆä¼ ç»ŸæŸ¥è¡¨æ³•ï¼Œéä¸‰åˆ/å…­åˆæ³•ï¼‰
            diwang_positions = []
            for pillar, (gan, zhi) in pillars.items():
                if zhi in {'è¾°', 'å·³'}:
                    diwang_positions.append(pillar)
            
            if diwang_positions:
                xiong_shen.append({
                    'name': 'åœ°ç½‘',
                    'level': 'ä¸­å‡¶',
                    'position': 'ã€'.join(diwang_positions) if len(diwang_positions) > 1 else diwang_positions[0],
                    'description': 'åœ°ç½‘ä¸»ç¾ç»Šçº ç¼ ï¼Œå®œå¾ªæ³•å®ˆåºã€‚ï¼ˆä¼ ç»ŸæŸ¥è¡¨æ³•ï¼Œéä¸‰åˆ/å…­åˆæ³•ï¼‰',
                    'weight': 6
                })

        # âœ… ç»Ÿä¸€ï¼šæ¡ƒèŠ±ï¼ˆä¸‰åˆå±€æ²æµ´æ³•ï¼‰- åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹åŸæ–‡
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å’¸æ± è€…ï¼Œä¸‰åˆå±€æ²æµ´ä¹Ÿã€‚å¯…åˆæˆŒè§å¯ï¼Œç”³å­è¾°è§é…‰ï¼Œäº¥å¯æœªè§å­ï¼Œå·³é…‰ä¸‘è§åˆã€‚"
        # âœ… ä¸‰åˆæ³•æŸ¥æ³•ï¼ˆåŸºäºäº”è¡ŒåäºŒé•¿ç”Ÿæ²æµ´ï¼‰ï¼š
        # - å¯…åˆæˆŒï¼ˆç«å±€ï¼‰ï¼šæ¡ƒèŠ±åœ¨å¯ï¼ˆç«æ²æµ´åœ¨å¯ï¼‰âœ… ä¸‰åˆæ³•
        # - ç”³å­è¾°ï¼ˆæ°´å±€ï¼‰ï¼šæ¡ƒèŠ±åœ¨é…‰ï¼ˆæ°´æ²æµ´åœ¨é…‰ï¼‰âœ… ä¸‰åˆæ³•
        # - äº¥å¯æœªï¼ˆæœ¨å±€ï¼‰ï¼šæ¡ƒèŠ±åœ¨å­ï¼ˆæœ¨æ²æµ´åœ¨å­ï¼‰âœ… ä¸‰åˆæ³•
        # - å·³é…‰ä¸‘ï¼ˆé‡‘å±€ï¼‰ï¼šæ¡ƒèŠ±åœ¨åˆï¼ˆé‡‘æ²æµ´åœ¨åˆï¼‰âœ… ä¸‰åˆæ³•
        # ç†è®ºä¾æ®ï¼šäº”è¡ŒåäºŒé•¿ç”Ÿè¡¨ï¼ˆæ²æµ´ä½ï¼‰
        # é‡‡ç”¨ä»¥å¹´æ”¯ä¸ºä¸»çš„æŸ¥æ³•ï¼ˆæ›´å¸¸ç”¨ï¼‰
        year_branch = pillars['year'][1]
        taohua_map = {
            'å¯…': 'å¯', 'åˆ': 'å¯', 'æˆŒ': 'å¯',  # å¯…åˆæˆŒè§å¯
            'ç”³': 'é…‰', 'å­': 'é…‰', 'è¾°': 'é…‰',  # ç”³å­è¾°è§é…‰
            'äº¥': 'å­', 'å¯': 'å­', 'æœª': 'å­',  # äº¥å¯æœªè§å­
            'å·³': 'åˆ', 'é…‰': 'åˆ', 'ä¸‘': 'åˆ'   # å·³é…‰ä¸‘è§åˆ
        }
        taohua_target = taohua_map.get(year_branch)
        # âœ… ä¿®å¤ï¼šæ¡ƒèŠ±åªæ·»åŠ ä¸€æ¬¡ï¼Œé¿å…é‡å¤
        if taohua_target:
            for pillar, (gan, zhi) in pillars.items():
                if zhi == taohua_target:
                    xiong_shen.append({
                        'name': 'æ¡ƒèŠ±',
                        'level': 'å°å‡¶',  # ä¸­æ€§åå°å‡¶ï¼šä¸»æƒ…æ„Ÿæ³¢åŠ¨ï¼Œéœ€æ­£å·±è‡ªæŒ
                        'position': pillar,
                        'description': 'æ¡ƒèŠ±ï¼ˆå’¸æ± ï¼‰åŠ¨ï¼Œä¸»æƒ…æ„Ÿæ³¢åŠ¨ã€äººç¼˜å¤æ‚ï¼Œè™½æœ‰é­…åŠ›ä½†éœ€æ­£å·±è‡ªæŒï¼Œé¿å…æ„Ÿæƒ…çº è‘›ã€‚',
                        'weight': 4
                    })
                    break  # âœ… ä¿®å¤ï¼šæ‰¾åˆ°å°±é€€å‡ºï¼Œé¿å…é‡å¤

        # âœ… ç»Ÿä¸€ï¼šä¸‰åˆ‘åˆ†æï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šÂ·è®ºä¸‰åˆ‘ã€‹ï¼Œä¸èƒ½ç”¨ä¸‰åˆ/å…­åˆæ³•ï¼‰
        # ã€Šä¸‰å‘½é€šä¼šÂ·è®ºä¸‰åˆ‘ã€‹ï¼š"åˆ‘è€…ï¼Œä¼¤ä¹Ÿ"
        # è¯´æ˜ï¼šä¸‰åˆ‘æ˜¯åœ°æ”¯é—´çš„åˆ‘ä¼¤å…³ç³»ï¼Œä¸èƒ½ç”¨ä¸‰åˆ/å…­åˆæ³•è®¡ç®—ï¼Œå¿…é¡»ç›´æ¥åˆ¤æ–­åœ°æ”¯ç»„åˆ
        # ç†è®ºä¾æ®ï¼šæ— æ©ä¹‹åˆ‘ï¼ˆå¯…å·³ç”³äº’åˆ‘ï¼‰ã€æ— ç¤¼ä¹‹åˆ‘ï¼ˆå­å¯äº’åˆ‘ï¼‰ã€æƒåŠ¿ä¹‹åˆ‘ï¼ˆä¸‘æˆŒæœªäº’åˆ‘ï¼‰ã€è‡ªåˆ‘
        sanxing_result = self._sanxing(pillars)
        if sanxing_result:
            seen_sanxing_types = set()  # è®°å½•å·²æ·»åŠ çš„ä¸‰åˆ‘ç±»å‹
            for item in sanxing_result:
                sanxing_key = item['name']  # ä¸‰åˆ‘ç±»å‹åç§°
                if sanxing_key not in seen_sanxing_types:
                    xiong_shen.append({
                        'name': item['name'],
                        'level': item['level'],
                        'position': item['position'],
                        'description': item['description'],
                        'weight': item['weight']
                    })
                    seen_sanxing_types.add(sanxing_key)

        # âœ… ç»Ÿä¸€ï¼šå®˜ç¬¦ç…ï¼ˆå¤ªå²å‰äº”è¾°æŸ¥è¡¨æ³•ï¼Œä¸èƒ½ç”¨ä¸‰åˆ/å…­åˆæ³•ï¼‰
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å®˜ç¬¦ç…ã€‚å–å¤ªå²å‰äº”è¾°ï¼Œæ˜¯æ—¥æ—¶é‡ä¹‹ã€‚å¹³ç”Ÿå¤šå®˜ç¾ï¼Œæ›´å¹¶ç¾Šåˆƒï¼Œä¹ƒåˆ‘å¾’ä¹‹å‘½ã€‚"
        # è¯´æ˜ï¼šå®˜ç¬¦ç…æ˜¯"å¤ªå²å‰äº”è¾°"çš„å›ºå®šå…³ç³»ï¼Œä¸èƒ½ç”¨ä¸‰åˆ/å…­åˆæ³•ï¼Œå¿…é¡»ç”¨æŸ¥è¡¨æ³•
        guanfu_result = self._guanfu_shitou(pillars)
        if guanfu_result:
            xiong_shen.append({
                'name': 'å®˜ç¬¦ç…',
                'level': 'ä¸­å‡¶',
                'position': guanfu_result['position'],
                'description': 'å®˜ç¬¦ç…ä¸»å®˜ç¾ï¼Œæ›´å¹¶ç¾Šåˆƒï¼Œä¹ƒåˆ‘å¾’ä¹‹å‘½ã€‚å¹³ç”Ÿå¤šå®˜ç¾ï¼Œå®œå¾ªæ³•å®ˆåºï¼Œé¿å…æ˜¯éã€‚ï¼ˆå¤ªå²å‰äº”è¾°æŸ¥è¡¨æ³•ï¼Œä¸èƒ½ç”¨ä¸‰åˆ/å…­åˆæ³•ï¼‰',
                'weight': 10
            })

        # âœ… ç»Ÿä¸€ï¼šå‹¾ç»ç…ï¼ˆå‘½å‰åä¸‰è¾°è®¡ç®—æ³•ï¼Œä¸èƒ½ç”¨ä¸‰åˆ/å…­åˆæ³•ï¼‰
        # ã€Šä¸‰å‘½é€šä¼šÂ·è®ºå‹¾ç»ã€‹ï¼š"å‹¾è€…ï¼Œç‰µè¿ä¹‹ä¹‰ï¼›ç»è€…ï¼Œç¾ç»Šä¹‹å"
        # "é˜³ç”·é˜´å¥³ï¼Œå‘½å‰ä¸‰è¾°ä¸ºå‹¾ï¼›å‘½åä¸‰è¾°ä¸ºç»ï¼›é˜´ç”·é˜³å¥³ï¼Œå‘½å‰ä¸‰è¾°ä¸ºç»ï¼Œå‘½åä¸‰è¾°ä¸ºå‹¾"
        # è¯´æ˜ï¼šå‹¾ç»ç…æ˜¯"å‘½å‰åä¸‰è¾°"çš„å›ºå®šå…³ç³»ï¼Œä¸èƒ½ç”¨ä¸‰åˆ/å…­åˆæ³•ï¼Œå¿…é¡»ç”¨è®¡ç®—æ–¹æ³•
        goujiao_result = self._goujiao_shitou(bazi_data)
        if goujiao_result:
            for item in goujiao_result:
                xiong_shen.append({
                    'name': item['name'],
                    'level': item['level'],
                    'position': item['position'],
                    'description': f"{item['description']}ï¼ˆå‘½å‰åä¸‰è¾°è®¡ç®—æ³•ï¼Œä¸èƒ½ç”¨ä¸‰åˆ/å…­åˆæ³•ï¼‰",
                    'weight': item['weight']
                })

        # âœ… ç»Ÿä¸€ï¼šç¾ç…ï¼ˆä¸‰åˆå±€å†²ç ´å°†æ˜Ÿæ³•ï¼‰- åŸºäºã€Šä¸‰å‘½é€šä¼šÂ·è®ºç¾ç…ã€‹
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"ç¾ç…è€…ï¼Œå…¶æ€§å‹‡çŒ›ï¼Œå¸¸å±…åŠ«ç…ä¹‹å‰ï¼Œå†²ç ´å°†æ˜Ÿï¼Œè°“ä¹‹ç¾ç…ã€‚"
        # "æ­¤ç…ä¸»è¡€å…‰æ¨ªæ­»ã€‚åœ¨æ°´ç«ï¼Œé˜²ç„šæººï¼›é‡‘æœ¨æ–åˆƒï¼›åœŸå è½ï¼Œç˜Ÿç–«å…‹èº«ï¼Œå¤§å‡¶ã€‚"
        # âœ… ä¸‰åˆæ³•æŸ¥æ³•ï¼ˆåŸºäºä¸‰åˆå±€å°†æ˜Ÿå¯¹å†²ï¼‰ï¼š
        # - ç”³å­è¾°å°†æ˜Ÿåœ¨å­ï¼Œç¾ç…åœ¨åˆï¼ˆåˆå†²å­ï¼‰âœ… ä¸‰åˆæ³•
        # - å¯…åˆæˆŒå°†æ˜Ÿåœ¨åˆï¼Œç¾ç…åœ¨å­ï¼ˆå­å†²åˆï¼‰âœ… ä¸‰åˆæ³•
        # - å·³é…‰ä¸‘å°†æ˜Ÿåœ¨é…‰ï¼Œç¾ç…åœ¨å¯ï¼ˆå¯å†²é…‰ï¼‰âœ… ä¸‰åˆæ³•
        # - äº¥å¯æœªå°†æ˜Ÿåœ¨å¯ï¼Œç¾ç…åœ¨é…‰ï¼ˆé…‰å†²å¯ï¼‰âœ… ä¸‰åˆæ³•
        zhaisha_result = self._zhaisha(pillars)
        if zhaisha_result:
            xiong_shen.append({
                'name': 'ç¾ç…',
                'level': 'å¤§å‡¶',
                'position': zhaisha_result['position'],
                'description': f"ç¾ç…ä¸»è¡€å…‰æ¨ªæ­»ã€‚åœ¨æ°´ç«ï¼Œé˜²ç„šæººï¼›é‡‘æœ¨æ–åˆƒï¼›åœŸå è½ï¼Œç˜Ÿç–«å…‹èº«ã€‚{zhaisha_result['wuxing_note']}ï¼ˆä¸‰åˆå±€å†²ç ´å°†æ˜Ÿæ³•ï¼‰",
                'weight': 13
            })

        # âœ… ç»Ÿä¸€ï¼šå…­å„ï¼ˆä¸‰åˆå±€æ­»åœ°æ³•ï¼‰- åŸºäºã€Šä¸‰å‘½é€šä¼šÂ·è®ºå…­å„ã€‹
        # ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å…­å„è€…ï¼Œä¸‰åˆå±€æ­»åœ°ä¹Ÿ"
        # "è‹¥æœ‰æ•‘æŠ¤ï¼Œæœ‰æ‰¶æŒï¼Œé€¢ç”Ÿæ—ºå…¼è´µæ°”ç›¸åŠ©ï¼Œåˆ™å‰ï¼Œç©¶ç«Ÿä¸€ç”Ÿè¹‡æ»ã€‚"
        liue_result = self._liue(pillars)
        if liue_result:
            xiong_shen.append({
                'name': 'å…­å„',
                'level': 'ä¸­å‡¶',
                'position': liue_result['position'],
                'description': 'å…­å„ä¸»é­éš¾ï¼Œä¸€ç”Ÿè¹‡æ»ã€‚è‹¥æœ‰æ•‘æŠ¤ã€æ‰¶æŒã€é€¢ç”Ÿæ—ºå…¼è´µæ°”ç›¸åŠ©ï¼Œåˆ™å‰ã€‚ï¼ˆä¸‰åˆå±€æ­»åœ°æ³•ï¼‰',
                'weight': 8
            })

        # æ³¨æ„ï¼šçº¢é¸¾ã€å¤©å–œæ˜¯å‰ç¥ï¼Œä¸åº”è¯¥åœ¨å‡¶ç¥åˆ†æä¸­
        # è¿™äº›åº”è¯¥åœ¨ _analyze_ji_shen ä¸­å¤„ç†ï¼Œè¿™é‡Œåªè¿”å›å‡¶ç¥

        # âœ… æœ€ç»ˆå»é‡æ£€æŸ¥ï¼šç¡®ä¿æ²¡æœ‰é‡å¤çš„å‡¶ç¥åç§°
        # å¦‚æœæœ‰é‡å¤ï¼ˆå¯èƒ½æ˜¯ä¸åŒä»£ç è·¯å¾„äº§ç”Ÿçš„ï¼‰ï¼Œä¿ç•™ç¬¬ä¸€ä¸ªï¼ˆé€šå¸¸æƒé‡æ›´é«˜æˆ–æ›´å®Œæ•´ï¼‰
        final_xiong_shen = []
        final_seen_names = set()
        for item in xiong_shen:
            name = item.get('name', 'æœªçŸ¥')
            if name not in final_seen_names:
                final_xiong_shen.append(item)
                final_seen_names.add(name)
            else:
                # å¦‚æœå‘ç°é‡å¤ï¼Œè®°å½•æ—¥å¿—ï¼ˆç”¨äºè°ƒè¯•ï¼‰
                print(f"âš ï¸ æ£€æµ‹åˆ°é‡å¤çš„å‡¶ç¥ï¼š{name}ï¼Œå·²è‡ªåŠ¨å»é‡")

        return final_xiong_shen
    
    def _calculate_jiesha_positions(self, year_branch: str) -> List[str]:
        """
        âœ… ä¿®å¤ï¼šæ ¹æ®å¹´æ”¯è®¡ç®—åŠ«ç…ä½ç½®ï¼ˆä¸‰åˆå±€ç»åœ°ï¼‰
        ã€Šä¸‰å‘½é€šä¼šã€‹"åŠ«ç…è€…ï¼Œä¸‰åˆå±€ç»åœ°ä¹Ÿ"ï¼š
        ã€Šä¸‰å‘½é€šä¼šã€‹åŸæ–‡ï¼š"æ°´ç»åœ¨å·³ï¼Œç”³å­è¾°ä»¥å·³ä¸ºåŠ«ç…ï¼›ç«ç»åœ¨äº¥ï¼Œå¯…åˆæˆŒä»¥äº¥ä¸ºåŠ«ç…ï¼›
                          é‡‘ç»åœ¨å¯…ï¼Œå·³é…‰ä¸‘ä»¥å¯…ä¸ºåŠ«ç…ï¼›æœ¨ç»åœ¨ç”³ï¼Œäº¥å¯æœªä»¥ç”³ä¸ºåŠ«ç…"
        
        æ­£ç¡®æŸ¥æ³•ï¼š
        - ç”³å­è¾°è§å·³ä¸ºåŠ«ç…ï¼ˆç”³å­è¾°ç»åœ¨å·³ï¼Œæ°´ç»äºå·³ï¼‰âœ…
        - äº¥å¯æœªè§ç”³ä¸ºåŠ«ç…ï¼ˆäº¥å¯æœªç»åœ¨ç”³ï¼Œæœ¨ç»äºç”³ï¼‰âœ…
        - å¯…åˆæˆŒè§äº¥ä¸ºåŠ«ç…ï¼ˆå¯…åˆæˆŒç»åœ¨äº¥ï¼Œç«ç»äºäº¥ï¼‰âœ…
        - å·³é…‰ä¸‘è§å¯…ä¸ºåŠ«ç…ï¼ˆå·³é…‰ä¸‘ç»åœ¨å¯…ï¼Œé‡‘ç»äºå¯…ï¼‰âœ…
        """
        jiesha_map = {
            'ç”³': 'å·³',  # ç”³å­è¾°ç»åœ¨å·³ï¼ˆæ°´ç»äºå·³ï¼‰âœ… ä¿®å¤
            'å­': 'å·³',   # ç”³å­è¾°ç»åœ¨å·³ âœ… ä¿®å¤
            'è¾°': 'å·³',   # ç”³å­è¾°ç»åœ¨å·³ âœ… ä¿®å¤
            'äº¥': 'ç”³',   # äº¥å¯æœªç»åœ¨ç”³ï¼ˆæœ¨ç»äºç”³ï¼‰âœ…
            'å¯': 'ç”³',   # äº¥å¯æœªç»åœ¨ç”³ âœ…
            'æœª': 'ç”³',   # äº¥å¯æœªç»åœ¨ç”³ âœ…
            'å¯…': 'äº¥',   # å¯…åˆæˆŒç»åœ¨äº¥ï¼ˆç«ç»äºäº¥ï¼‰âœ…
            'åˆ': 'äº¥',   # å¯…åˆæˆŒç»åœ¨äº¥ âœ…
            'æˆŒ': 'äº¥',   # å¯…åˆæˆŒç»åœ¨äº¥ âœ…
            'å·³': 'å¯…',   # å·³é…‰ä¸‘ç»åœ¨å¯…ï¼ˆé‡‘ç»äºå¯…ï¼‰âœ…
            'é…‰': 'å¯…',   # å·³é…‰ä¸‘ç»åœ¨å¯… âœ…
            'ä¸‘': 'å¯…'    # å·³é…‰ä¸‘ç»åœ¨å¯… âœ…
        }
        jiesha_zhi = jiesha_map.get(year_branch)
        return [jiesha_zhi] if jiesha_zhi else []

    def _gucheng_guasu(self, year_branch: str) -> tuple[str, str]:
        # å¸¸ç”¨è¡¨ï¼š
        # ç”³å­è¾°ï¼šå­¤è¾°åœ¨å¯…ï¼Œå¯¡å®¿åœ¨æˆŒ
        # äº¥å¯æœªï¼šå­¤è¾°åœ¨å·³ï¼Œå¯¡å®¿åœ¨ä¸‘
        # å¯…åˆæˆŒï¼šå­¤è¾°åœ¨ç”³ï¼Œå¯¡å®¿åœ¨è¾°
        # å·³é…‰ä¸‘ï¼šå­¤è¾°åœ¨äº¥ï¼Œå¯¡å®¿åœ¨æœª
        group = None
        if year_branch in {'ç”³', 'å­', 'è¾°'}:
            return 'å¯…', 'æˆŒ'
        if year_branch in {'äº¥', 'å¯', 'æœª'}:
            return 'å·³', 'ä¸‘'
        if year_branch in {'å¯…', 'åˆ', 'æˆŒ'}:
            return 'ç”³', 'è¾°'
        if year_branch in {'å·³', 'é…‰', 'ä¸‘'}:
            return 'äº¥', 'æœª'
        return '', ''

    def _huagai(self, branch: str) -> str:
        """
        åç›–æŸ¥æ³• - åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç†è®º
        ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨æ—¥æ”¯ä½œä¸ºåŸºå‡†ï¼ˆè€Œä¸æ˜¯å¹´æ”¯ï¼‰
        
        æŸ¥æ³•ï¼šå¯…åˆæˆŒè§æˆŒï¼Œäº¥å¯æœªè§æœªï¼Œç”³å­è¾°è§è¾°ï¼Œå·³é…‰ä¸‘è§ä¸‘ã€‚
        """
        # ä¸‰åˆå±€å¯¹åº”çš„åç›–åœ°æ”¯
        if branch in {'å¯…', 'åˆ', 'æˆŒ'}:
            return 'æˆŒ'  # å¯…åˆæˆŒè§æˆŒ
        if branch in {'äº¥', 'å¯', 'æœª'}:
            return 'æœª'  # äº¥å¯æœªè§æœª
        if branch in {'ç”³', 'å­', 'è¾°'}:
            return 'è¾°'  # ç”³å­è¾°è§è¾°
        if branch in {'å·³', 'é…‰', 'ä¸‘'}:
            return 'ä¸‘'  # å·³é…‰ä¸‘è§ä¸‘
        return ''
    
    def _yima(self, year_branch: str) -> str:
        """
        é©¿é©¬æŸ¥æ³• - åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç†è®º
        ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"é©¿é©¬è€…ï¼Œä¸‰åˆå±€å¯¹å†²ä¹Ÿã€‚ç”³å­è¾°é©¬åœ¨å¯…ï¼Œå¯…åˆæˆŒé©¬åœ¨ç”³ï¼Œå·³é…‰ä¸‘é©¬åœ¨äº¥ï¼Œäº¥å¯æœªé©¬åœ¨å·³ã€‚"
        
        æŸ¥æ³•ï¼šä»¥å¹´æ”¯ä¸ºå‡†ï¼Œä¸‰åˆå±€çš„å¯¹å†²åœ°æ”¯ä¸ºé©¿é©¬
        - ç”³å­è¾°ï¼ˆæ°´å±€ï¼‰â†’ é©¿é©¬åœ¨å¯…ï¼ˆå¯¹å†²ï¼‰
        - å¯…åˆæˆŒï¼ˆç«å±€ï¼‰â†’ é©¿é©¬åœ¨ç”³ï¼ˆå¯¹å†²ï¼‰
        - å·³é…‰ä¸‘ï¼ˆé‡‘å±€ï¼‰â†’ é©¿é©¬åœ¨äº¥ï¼ˆå¯¹å†²ï¼‰
        - äº¥å¯æœªï¼ˆæœ¨å±€ï¼‰â†’ é©¿é©¬åœ¨å·³ï¼ˆå¯¹å†²ï¼‰
        """
        if year_branch in {'ç”³', 'å­', 'è¾°'}:
            return 'å¯…'  # ç”³å­è¾°é©¬åœ¨å¯…
        if year_branch in {'å¯…', 'åˆ', 'æˆŒ'}:
            return 'ç”³'  # å¯…åˆæˆŒé©¬åœ¨ç”³
        if year_branch in {'å·³', 'é…‰', 'ä¸‘'}:
            return 'äº¥'  # å·³é…‰ä¸‘é©¬åœ¨äº¥
        if year_branch in {'äº¥', 'å¯', 'æœª'}:
            return 'å·³'  # äº¥å¯æœªé©¬åœ¨å·³
        return ''

    def _kongwang(self, day_pillar: tuple[str, str]) -> tuple[str, str] | None:
        """
        ğŸ”¥ ä¿®å¤ï¼šæ ¹æ®æ—¥æŸ±è®¡ç®—ç©ºäº¡ï¼ˆå…­ç”²æ—¬ç©ºæ³•ï¼‰- ä½¿ç”¨60ç”²å­æŸ¥è¡¨æ³•
        ç©ºäº¡æ˜¯æŒ‰å…­ç”²æ—¬è®¡ç®—çš„ï¼Œä¸æ˜¯æŒ‰æ—¥å¹²ï¼š
        - ç”²å­æ—¬ï¼ˆç”²å­ï½ç™¸é…‰ï¼‰ï¼šæˆŒäº¥ç©º
        - ç”²æˆŒæ—¬ï¼ˆç”²æˆŒï½ç™¸æœªï¼‰ï¼šç”³é…‰ç©º
        - ç”²ç”³æ—¬ï¼ˆç”²ç”³ï½ç™¸å·³ï¼‰ï¼šåˆæœªç©º
        - ç”²åˆæ—¬ï¼ˆç”²åˆï½ç™¸å¯ï¼‰ï¼šè¾°å·³ç©º
        - ç”²è¾°æ—¬ï¼ˆç”²è¾°ï½ç™¸ä¸‘ï¼‰ï¼šå¯…å¯ç©º
        - ç”²å¯…æ—¬ï¼ˆç”²å¯…ï½ç™¸äº¥ï¼‰ï¼šå­ä¸‘ç©º
        
        æ­£ç¡®æ–¹æ³•ï¼šç›´æ¥åœ¨60ç”²å­è¡¨ä¸­æŸ¥æ‰¾æ—¥æŸ±ä½ç½®ï¼Œç¡®å®šæ‰€å±æ—¬
        """
        gan, zhi = day_pillar
        day_gz = gan + zhi
        
        # 60ç”²å­å®Œæ•´åˆ—è¡¨
        LIUSHI_JIAZI = [
            'ç”²å­', 'ä¹™ä¸‘', 'ä¸™å¯…', 'ä¸å¯', 'æˆŠè¾°', 'å·±å·³', 'åºšåˆ', 'è¾›æœª', 'å£¬ç”³', 'ç™¸é…‰',  # 0-9: ç”²å­æ—¬
            'ç”²æˆŒ', 'ä¹™äº¥', 'ä¸™å­', 'ä¸ä¸‘', 'æˆŠå¯…', 'å·±å¯', 'åºšè¾°', 'è¾›å·³', 'å£¬åˆ', 'ç™¸æœª',  # 10-19: ç”²æˆŒæ—¬
            'ç”²ç”³', 'ä¹™é…‰', 'ä¸™æˆŒ', 'ä¸äº¥', 'æˆŠå­', 'å·±ä¸‘', 'åºšå¯…', 'è¾›å¯', 'å£¬è¾°', 'ç™¸å·³',  # 20-29: ç”²ç”³æ—¬
            'ç”²åˆ', 'ä¹™æœª', 'ä¸™ç”³', 'ä¸é…‰', 'æˆŠæˆŒ', 'å·±äº¥', 'åºšå­', 'è¾›ä¸‘', 'å£¬å¯…', 'ç™¸å¯',  # 30-39: ç”²åˆæ—¬
            'ç”²è¾°', 'ä¹™å·³', 'ä¸™åˆ', 'ä¸æœª', 'æˆŠç”³', 'å·±é…‰', 'åºšæˆŒ', 'è¾›äº¥', 'å£¬å­', 'ç™¸ä¸‘',  # 40-49: ç”²è¾°æ—¬
            'ç”²å¯…', 'ä¹™å¯', 'ä¸™è¾°', 'ä¸å·³', 'æˆŠåˆ', 'å·±æœª', 'åºšç”³', 'è¾›é…‰', 'å£¬æˆŒ', 'ç™¸äº¥',  # 50-59: ç”²å¯…æ—¬
        ]
        
        # åœ¨60ç”²å­ä¸­æ‰¾åˆ°æ—¥æŸ±ä½ç½®
        if day_gz in LIUSHI_JIAZI:
            idx = LIUSHI_JIAZI.index(day_gz)
            xun_idx = idx // 10  # ç¡®å®šæ‰€å±çš„æ—¬ï¼ˆ0-5ï¼‰
            
            # å…­ç”²æ—¬ç©ºå¯¹ç…§è¡¨
            kongwang_map = {
                0: ('æˆŒ', 'äº¥'),   # ç”²å­æ—¬ï¼šæˆŒäº¥ç©º
                1: ('ç”³', 'é…‰'),   # ç”²æˆŒæ—¬ï¼šç”³é…‰ç©º
                2: ('åˆ', 'æœª'),   # ç”²ç”³æ—¬ï¼šåˆæœªç©º
                3: ('è¾°', 'å·³'),   # ç”²åˆæ—¬ï¼šè¾°å·³ç©º
                4: ('å¯…', 'å¯'),   # ç”²è¾°æ—¬ï¼šå¯…å¯ç©º
                5: ('å­', 'ä¸‘'),   # ç”²å¯…æ—¬ï¼šå­ä¸‘ç©º
            }
            
            return kongwang_map.get(xun_idx)
        
        return None

    def _is_taohua(self, zhi: str, day_master: str) -> bool:
        """
        ğŸ”¥ å·²åºŸå¼ƒï¼šæ­¤å‡½æ•°ä½¿ç”¨é”™è¯¯çš„æŒ‰æ—¥å¹²æŸ¥è¡¨æ³•
        æ¡ƒèŠ±åº”è¯¥æŒ‰ä¸‰åˆå±€è®¡ç®—ï¼šç”³å­è¾°è§é…‰ã€äº¥å¯æœªè§å­ã€å¯…åˆæˆŒè§å¯ã€å·³é…‰ä¸‘è§åˆ
        å®é™…ä»£ç ä¸­å·²ç»åœ¨_analyze_xiong_shenæ–¹æ³•ä¸­æ­£ç¡®å®ç°äº†æŒ‰ä¸‰åˆå±€è®¡ç®—çš„æ¡ƒèŠ±
        æ­¤å‡½æ•°ä¿ç•™ä½†ä¸ä½¿ç”¨ï¼Œæˆ–å¯åˆ é™¤
        """
        # é”™è¯¯çš„æ–¹æ³•ï¼šæŒ‰æ—¥å¹²æŸ¥è¡¨ï¼ˆä¸åº”ä½¿ç”¨ï¼‰
        taohua_map = {
            'ç”²': 'é…‰', 'ä¹™': 'é…‰',
            'ä¸™': 'å¯', 'ä¸': 'å¯',
            'æˆŠ': 'å­', 'å·±': 'å­',
            'åºš': 'åˆ', 'è¾›': 'åˆ',
            'å£¬': 'å¯', 'ç™¸': 'å¯'
        }
        return zhi == taohua_map.get(day_master)

    def _hongluan_tianxi(self, zhi: str) -> str:
        # çº¢é¸¾å¤©å–œï¼ˆå¸¸ç”¨å¯¹ç…§ï¼Œç¤ºæ„ç”¨ï¼Œåç»­å¯æ‰©ï¼‰
        table = {
            'å­': 'å¤©å–œ', 'åˆ': 'çº¢é¸¾',
            'ä¸‘': 'çº¢é¸¾', 'æœª': 'å¤©å–œ',
            'å¯…': 'å¤©å–œ', 'ç”³': 'çº¢é¸¾',
            'å¯': 'çº¢é¸¾', 'é…‰': 'å¤©å–œ',
            'è¾°': 'å¤©å–œ', 'æˆŒ': 'çº¢é¸¾',
            'å·³': 'çº¢é¸¾', 'äº¥': 'å¤©å–œ'
        }
        return table.get(zhi, '')

    def _hongluan_tianxi_by_year(self, year_branch: str) -> tuple[str, str]:
        """æŒ‰å¹´æ”¯å¼•åŠ¨çº¢é¸¾/å¤©å–œï¼ˆå…¨é‡è¡¨ï¼‰"""
        # å¸¸ç”¨å®Œæ•´è¡¨ï¼š
        # å­ï¼šçº¢é¸¾å¯ã€å¤©å–œé…‰ï¼›ä¸‘ï¼šçº¢é¸¾å¯…ã€å¤©å–œç”³ï¼›å¯…ï¼šçº¢é¸¾ä¸‘ã€å¤©å–œæœªï¼›å¯ï¼šçº¢é¸¾å­ã€å¤©å–œåˆï¼›
        # è¾°ï¼šçº¢é¸¾äº¥ã€å¤©å–œå·³ï¼›å·³ï¼šçº¢é¸¾æˆŒã€å¤©å–œè¾°ï¼›åˆï¼šçº¢é¸¾é…‰ã€å¤©å–œå­ï¼›æœªï¼šçº¢é¸¾ç”³ã€å¤©å–œä¸‘ï¼›
        # ç”³ï¼šçº¢é¸¾æœªã€å¤©å–œä¸‘ï¼›é…‰ï¼šçº¢é¸¾åˆã€å¤©å–œå­ï¼›æˆŒï¼šçº¢é¸¾å·³ã€å¤©å–œäº¥ï¼›äº¥ï¼šçº¢é¸¾è¾°ã€å¤©å–œæˆŒ
        table_hl = {
            'å­':'å¯','ä¸‘':'å¯…','å¯…':'ä¸‘','å¯':'å­','è¾°':'äº¥','å·³':'æˆŒ',
            'åˆ':'é…‰','æœª':'ç”³','ç”³':'æœª','é…‰':'åˆ','æˆŒ':'å·³','äº¥':'è¾°'
        }
        table_tx = {
            'å­':'é…‰','ä¸‘':'ç”³','å¯…':'æœª','å¯':'åˆ','è¾°':'å·³','å·³':'è¾°',
            'åˆ':'å­','æœª':'ä¸‘','ç”³':'ä¸‘','é…‰':'å­','æˆŒ':'äº¥','äº¥':'æˆŒ'
        }
        return table_hl.get(year_branch, ''), table_tx.get(year_branch, '')

    def _get_xuetang(self, day_gan: str) -> str:
        """å­¦å ‚ï¼ˆæŒ‰æ—¥å¹²å–æ”¯ï¼Œå¸¸ç”¨è¡¨ï¼‰"""
        # ç”²å·³ã€ä¹™åˆã€ä¸™ç”³ã€ä¸é…‰ã€æˆŠäº¥ã€å·±å­ã€åºšå¯…ã€è¾›å¯ã€å£¬å·³ã€ç™¸åˆ
        table = {
            'ç”²':'å·³','ä¹™':'åˆ','ä¸™':'ç”³','ä¸':'é…‰','æˆŠ':'äº¥',
            'å·±':'å­','åºš':'å¯…','è¾›':'å¯','å£¬':'å·³','ç™¸':'åˆ'
        }
        return table.get(day_gan, '')

    def _get_ciguan(self, day_gan: str) -> str:
        """è¯é¦†ï¼ˆæŒ‰æ—¥å¹²å–æ”¯ï¼Œå¸¸ç”¨è¡¨ï¼Œä¸å­¦å ‚ç›¸å¯¹ï¼‰"""
        # ç”²åˆã€ä¹™å·³ã€ä¸™é…‰ã€ä¸ç”³ã€æˆŠå­ã€å·±äº¥ã€åºšå¯ã€è¾›å¯…ã€å£¬åˆã€ç™¸å·³
        table = {
            'ç”²':'åˆ','ä¹™':'å·³','ä¸™':'é…‰','ä¸':'ç”³','æˆŠ':'å­',
            'å·±':'äº¥','åºš':'å¯','è¾›':'å¯…','å£¬':'åˆ','ç™¸':'å·³'
        }
        return table.get(day_gan, '')

    def _get_lushen(self, day_gan: str) -> str:
        """ç¦„ç¥ï¼ˆæŒ‰æ—¥å¹²ç¦„ä½ï¼‰"""
        # ç”²å¯…ã€ä¹™å¯ã€ä¸™å·³ã€ä¸åˆã€æˆŠå·³ã€å·±åˆã€åºšç”³ã€è¾›é…‰ã€å£¬äº¥ã€ç™¸å­
        table = {
            'ç”²':'å¯…','ä¹™':'å¯','ä¸™':'å·³','ä¸':'åˆ','æˆŠ':'å·³',
            'å·±':'åˆ','åºš':'ç”³','è¾›':'é…‰','å£¬':'äº¥','ç™¸':'å­'
        }
        return table.get(day_gan, '')
    
    def _calculate_shensha_score(self, ji_shen: List[Dict], xiong_shen: List[Dict], bazi_data: BaziData = None) -> float:
        """
        è®¡ç®—ç¥ç…è¯„åˆ† - åŸºäºã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ç­‰ç»å…¸ç†è®º
        âœ… ä¿®å¤ï¼šä¸å†ä½¿ç”¨base_score + ji_score - xiong_scoreçš„ç®€å•ç´¯åŠ 
        æ”¹ä¸ºåŸºäºç»å…¸ç†è®ºçš„ç»¼åˆåˆ¤æ–­ï¼Œè€ƒè™‘ç¥ç…ç»„åˆå’Œå…·ä½“ä½œç”¨
        
        ç†è®ºä¾æ®ï¼š
        1. ã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ï¼š"äºŒå¾·æ‰¶æŒï¼Œä¼—å‡¶è§£æ•£"
        2. "å‡¡å‘½ä¸­å¸¦å‡¶ç…ï¼Œå¾—æ­¤äºŒå¾·æ‰¶åŒ–ï¼Œå‡¶ä¸ä¸ºç”š"
        3. "å¤©å¾·èƒœæœˆå¾·ä¹Ÿ"
        4. ç¥ç…éœ€ç»“åˆåç¥å’Œæ ¼å±€ç»¼åˆåˆ¤æ–­
        """
        # âœ… ä¿®å¤ï¼šåŸºäºç»å…¸ç†è®ºç»¼åˆåˆ¤æ–­ï¼Œè€Œä¸æ˜¯ç®€å•ç´¯åŠ 
        
        # 1. è·å–ç¥ç…åç§°é›†åˆ
        ji_names = {shen.get('name', '') for shen in ji_shen}
        xiong_names = {shen.get('name', '') for shen in xiong_shen}
        
        # 2. æ£€æŸ¥å…³é”®ç¥ç…ç»„åˆï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç†è®ºï¼‰
        level_reason = self._judge_shensha_level_classical(ji_shen, xiong_shen, ji_names, xiong_names, bazi_data)
        
        # 3. å°†ç­‰çº§è½¬æ¢ä¸ºåˆ†æ•°ï¼ˆç”¨äºå…¼å®¹æ€§ï¼Œä½†ä¸ä½œä¸ºä¸»è¦åˆ¤æ–­ä¾æ®ï¼‰
        level_to_score = {
            'å¤§å‰': 90.0,
            'å‰': 75.0,
            'ä¸­å¹³': 55.0,
            'å‡¶': 35.0,
            'å¤§å‡¶': 20.0
        }
        
        level = level_reason.get('level', 'ä¸­å¹³')
        return level_to_score.get(level, 55.0)
    
    def _judge_shensha_level_classical(self, ji_shen: List[Dict], xiong_shen: List[Dict],
                                       ji_names: set, xiong_names: set,
                                       bazi_data: BaziData = None) -> Dict[str, Any]:
        """
        åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç»å…¸ç†è®ºåˆ¤æ–­ç¥ç…ç­‰çº§
        
        è¿”å›: {'level': 'å¤§å‰/å‰/ä¸­å¹³/å‡¶/å¤§å‡¶', 'reason': 'åˆ¤æ–­ä¾æ®'}
        """
        from ..core.utils import get_ten_god
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # ä¸Šç­‰å‰æ ¼ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ç­‰ç»å…¸è®ºè¿°ï¼‰
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        # 1. å¤©æœˆå¾·åˆï¼ˆã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ï¼š"äºŒå¾·æ‰¶æŒï¼Œä¼—å‡¶è§£æ•£"ï¼‰
        if 'å¤©å¾·è´µäºº' in ji_names and 'æœˆå¾·è´µäºº' in ji_names:
            # å¤©å¾·èƒœæœˆå¾·ï¼ŒäºŒå¾·å¹¶è§ï¼Œå¤§å‰
            # å³ä½¿æœ‰å‡¶ç…ï¼Œä¹Ÿèƒ½åŒ–è§£ï¼ˆã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å‡¡å‘½ä¸­å¸¦å‡¶ç…ï¼Œå¾—æ­¤äºŒå¾·æ‰¶åŒ–ï¼Œå‡¶ä¸ä¸ºç”š"ï¼‰
            if len(xiong_names) > 0:
                return {
                    'level': 'å‰',
                    'reason': 'å¤©æœˆå¾·åˆï¼ŒäºŒå¾·æ‰¶æŒï¼Œä¼—å‡¶è§£æ•£ï¼ˆã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ï¼š"äºŒå¾·æ‰¶æŒï¼Œä¼—å‡¶è§£æ•£ã€‚å‡¡å‘½ä¸­å¸¦å‡¶ç…ï¼Œå¾—æ­¤äºŒå¾·æ‰¶åŒ–ï¼Œå‡¶ä¸ä¸ºç”šã€‚"ï¼‰'
                }
            else:
                return {
                    'level': 'å¤§å‰',
                    'reason': 'å¤©æœˆå¾·åˆï¼ŒäºŒå¾·æ‰¶æŒï¼Œå¤§å‰ä¹‹è±¡ï¼ˆã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ï¼š"å¤©å¾·èƒœæœˆå¾·ä¹Ÿ"ï¼‰'
                }
        
        # 2. å¤©å¾·è´µäººå•ç‹¬å‡ºç°ï¼ˆã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ï¼š"å¤©å¾·èƒœæœˆå¾·ä¹Ÿ"ï¼‰
        if 'å¤©å¾·è´µäºº' in ji_names:
            if len(xiong_names) == 0:
                return {
                    'level': 'å‰',
                    'reason': 'å¤©å¾·è´µäººï¼Œä¸»ç™»å°è¾…ä¹‹ä½ï¼ˆã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ï¼š"å¤©å¾·è€…ï¼Œäº”è¡Œç¦å¾·ä¹‹è¾°"ï¼‰'
                }
            elif len(xiong_names) <= 2:
                return {
                    'level': 'ä¸­å¹³',
                    'reason': 'å¤©å¾·è´µäººï¼Œèƒ½åŒ–è§£éƒ¨åˆ†å‡¶ç…ï¼ˆã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ï¼š"å‡¡å‘½ä¸­å¸¦å‡¶ç…ï¼Œå¾—æ­¤äºŒå¾·æ‰¶åŒ–ï¼Œå‡¶ä¸ä¸ºç”š"ï¼‰'
                }
        
        # 3. ç¾Šåˆƒé©¾æ€ï¼ˆã€Šæ¸Šæµ·å­å¹³ã€‹ï¼šç¾Šåˆƒé©¾æ€ï¼Œè‹±é›„ç‹¬å‹ä¸‡äººï¼‰
        # ç¾Šåˆƒ + ä¸ƒæ€ï¼Œåè€Œæˆæ ¼
        has_yangren = 'ç¾Šåˆƒ' in xiong_names
        has_qisha = False
        if bazi_data and has_yangren:
            day_master = bazi_data.get_day_master()
            pillars = bazi_data.get_pillars()
            for pillar, (gan, zhi) in pillars.items():
                ten_god = get_ten_god(day_master, gan)
                if ten_god == 'åå®˜':  # åå®˜å³ä¸ƒæ€
                    has_qisha = True
                    break
                # æ£€æŸ¥è—å¹²ä¸­çš„ä¸ƒæ€
                from ..core.constants import DIZHI_CANGGAN
                for canggan, _ in DIZHI_CANGGAN.get(zhi, []):
                    if get_ten_god(day_master, canggan) == 'åå®˜':
                        has_qisha = True
                        break
                if has_qisha:
                    break
        
        if has_yangren and has_qisha:
            # ç¾Šåˆƒé©¾æ€ï¼Œåå‡¶ä¸ºå‰
            return {
                'level': 'å‰',
                'reason': 'ç¾Šåˆƒé©¾æ€ï¼Œè‹±é›„ç‹¬å‹ä¸‡äººï¼ˆã€Šæ¸Šæµ·å­å¹³ã€‹ï¼šç¾Šåˆƒé©¾æ€ï¼Œåå‡¶ä¸ºå‰ï¼Œä¸»æ­¦è´µã€æƒå¨ï¼‰'
            }
        
        # 4. å¤©ä¹™è´µäºº + ä¸‰å¥‡è´µäººï¼ˆã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ï¼š"ä¸ä¸‰å¥‡ã€å¤©ä¹™è´µåŒå¹¶ï¼Œå°¤ä¸ºå‰åº†"ï¼‰
        if 'å¤©ä¹™è´µäºº' in ji_names and len(ji_names) >= 3:
            return {
                'level': 'å¤§å‰',
                'reason': 'å¤©ä¹™è´µäººä¸ä¸‰å¥‡è´µäººåŒå¹¶ï¼Œå°¤ä¸ºå‰åº†ï¼ˆã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ï¼š"ä¸ä¸‰å¥‡ã€å¤©ä¹™è´µåŒå¹¶ï¼Œå°¤ä¸ºå‰åº†"ï¼‰'
            }
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # ä¸­ç­‰å‰æ ¼
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        # 5. å¤šä¸ªå‰ç¥æ±‡èšï¼ˆä½†æ— ç‰¹æ®Šç»„åˆï¼‰
        if len(ji_names) >= 3 and len(xiong_names) == 0:
            return {
                'level': 'å‰',
                'reason': 'å¤šä¸ªå‰ç¥æ±‡èšï¼Œä¸»ç¦å¯¿ä¸¤å…¨ï¼ˆã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ï¼šå…¥è´±æ ¼ï¼Œä¸€ç”Ÿæ¸©é¥±ï¼Œç¦å¯¿ä¸¤å…¨ï¼‰'
            }
        
        # 6. å¤©ä¹™è´µäººå•ç‹¬å‡ºç°
        if 'å¤©ä¹™è´µäºº' in ji_names:
            if len(xiong_names) == 0:
                return {
                    'level': 'å‰',
                    'reason': 'å¤©ä¹™è´µäººï¼Œä¸»å¯Œè´µï¼ˆã€Šä¸‰å‘½é€šä¼šã€‹ï¼šå¤©ä¹™è´µäººï¼Œæœ€å‰ä¹‹ç¥ï¼‰'
                }
            else:
                return {
                    'level': 'ä¸­å¹³',
                    'reason': 'å¤©ä¹™è´µäººï¼Œä½†é‡å‡¶ç…ï¼Œå‰å‡¶å‚åŠï¼ˆã€Šä¸‰å‘½é€šä¼šã€‹ï¼šè´µäººé€¢å‡¶ï¼Œéœ€ç»“åˆå…¶ä»–å› ç´ åˆ¤æ–­ï¼‰'
                }
        
        # 7. æ–‡æ˜Œè´µäºº + åç›–ï¼ˆåˆ©äºå­¦æœ¯è‰ºæœ¯ï¼‰
        if 'æ–‡æ˜Œ' in ji_names and 'åç›–' in ji_names:
            return {
                'level': 'å‰',
                'reason': 'æ–‡æ˜Œè´µäººé‡åç›–ï¼Œåˆ©äºå­¦æœ¯è‰ºæœ¯ï¼ˆã€Šä¸‰å‘½é€šä¼šã€‹ï¼šæ–‡æ˜Œä¸»æ–‡æ‰ï¼Œåç›–ä¸»è‰ºæœ¯ï¼‰'
            }
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # å‡¶æ ¼åˆ¤æ–­
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        # 8. å¤šä¸ªå‡¶ç…æ±‡èšï¼ˆæ— å‰ç¥åŒ–è§£ï¼‰
        if len(xiong_names) >= 3 and len(ji_names) == 0:
            return {
                'level': 'å¤§å‡¶',
                'reason': 'å¤šä¸ªå‡¶ç…æ±‡èšä¸”æ— å‰ç¥åŒ–è§£ï¼Œä¸»å‡¶ï¼ˆã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ï¼šå‡¡å‘½ä¸­å¸¦å‡¶ç…ï¼Œéœ€å‰ç¥åŒ–è§£ï¼‰'
            }
        
        # 9. ç¾Šåˆƒå•ç‹¬å‡ºç°ï¼ˆæ— ä¸ƒæ€åˆ¶çº¦ï¼‰
        if has_yangren and not has_qisha:
            return {
                'level': 'å‡¶',
                'reason': 'ç¾Šåˆƒæ— åˆ¶ï¼Œä¸»åˆšå¼ºæš´çƒˆï¼ˆã€Šä¸‰å‘½é€šä¼šã€‹ï¼šç¾Šåˆƒä¸»å‡¶ï¼Œéœ€æœ‰åˆ¶åŒ–ï¼‰'
            }
        
        # 10. å­¤è¾°å¯¡å®¿åŒç°ï¼ˆã€Šä¸‰å‘½é€šä¼šã€‹ï¼šåŠ é‡å­¤ç‹¬ï¼‰
        if 'å­¤è¾°' in xiong_names and 'å¯¡å®¿' in xiong_names:
            return {
                'level': 'å‡¶',
                'reason': 'å­¤è¾°å¯¡å®¿åŒç°ï¼Œä¸»å­¤ç‹¬ï¼ˆã€Šä¸‰å‘½é€šä¼šã€‹ï¼šå­¤è¾°å¯¡å®¿åŒç°ï¼ŒåŠ é‡å­¤ç‹¬ï¼‰'
            }
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # ä¸€èˆ¬æƒ…å†µåˆ¤æ–­ï¼ˆéœ€ç»“åˆå…·ä½“ç»„åˆï¼‰
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        # 11. å‰å‡¶ç¥æ•°é‡å¯¹æ¯”
        ji_count = len(ji_names)
        xiong_count = len(xiong_names)
        
        if ji_count > xiong_count * 2:
            return {
                'level': 'å‰',
                'reason': 'å‰ç¥æ˜æ˜¾å¤šäºå‡¶ç¥ï¼Œä¸»å‰ï¼ˆã€Šä¸‰å‘½é€šä¼šã€‹ï¼šå‰ç¥å¤šä¸»ç¦ï¼‰'
            }
        elif xiong_count > ji_count * 2:
            return {
                'level': 'å‡¶',
                'reason': 'å‡¶ç¥æ˜æ˜¾å¤šäºå‰ç¥ï¼Œä¸»å‡¶ï¼ˆã€Šä¸‰å‘½é€šä¼šã€‹ï¼šå‡¶ç¥å¤šä¸»ç¥¸ï¼‰'
            }
        elif ji_count > 0 and xiong_count == 0:
            return {
                'level': 'å‰',
                'reason': 'æœ‰å‰ç¥æ— å‡¶ç¥ï¼Œä¸»å‰ï¼ˆã€Šä¸‰å‘½é€šä¼šã€‹ï¼šå‰ç¥ä¸»ç¦ï¼‰'
            }
        elif xiong_count > 0 and ji_count == 0:
            return {
                'level': 'å‡¶',
                'reason': 'æœ‰å‡¶ç¥æ— å‰ç¥ï¼Œä¸»å‡¶ï¼ˆã€Šä¸‰å‘½é€šä¼šã€‹ï¼šå‡¶ç¥ä¸»ç¥¸ï¼‰'
            }
        
        # 12. å‰å‡¶å‚åŠ
        if ji_count > 0 and xiong_count > 0:
            return {
                'level': 'ä¸­å¹³',
                'reason': 'å‰å‡¶ç¥å¹¶å­˜ï¼Œå‰å‡¶å‚åŠï¼Œéœ€ç»“åˆæ ¼å±€å’Œå¤§è¿å…·ä½“åˆ†æï¼ˆã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹ï¼šéœ€ç»“åˆæ ¼å±€å’Œåç¥é…ç½®åˆ¤æ–­ï¼‰'
            }
        
        # 13. æ— ç¥ç…æˆ–ç¥ç…å¾ˆå°‘
        return {
            'level': 'ä¸­å¹³',
            'reason': 'ç¥ç…è¾ƒå°‘æˆ–æ— æ˜æ˜¾ç¥ç…ï¼Œéœ€ç»“åˆæ ¼å±€å’Œåç¥é…ç½®åˆ¤æ–­ï¼ˆã€Šä¸‰å‘½é€šä¼šã€‹ï¼šç¥ç…ä¸ºè¾…åŠ©ï¼Œæ ¼å±€ä¸ºä¸»ï¼‰'
        }

    def _calculate_combo_bonus(self, ji_shen: List[Dict], xiong_shen: List[Dict], bazi_data: BaziData = None) -> float:
        """
        è®¡ç®—ç¥ç…ç»„åˆæ•ˆåº”åŠ æˆ
        âœ… æ–°å¢ï¼šæ ¹æ®ã€Šä¸‰å‘½é€šä¼šã€‹ç†è®ºï¼ŒæŸäº›ç¥ç…ç»„åˆæœ‰ç‰¹æ®Šæ•ˆåº”
        ğŸ”¥ ä¿®å¤ï¼šç¾Šåˆƒé©¾æ€åˆ¤æ–­éœ€è¦ä»åç¥ä¿¡æ¯ä¸­è·å–ä¸ƒæ€ï¼Œè€Œä¸æ˜¯ä»ç¥ç…ä¸­æŸ¥æ‰¾
        """
        bonus = 0.0

        ji_names = {shen.get('name', '') for shen in ji_shen}
        xiong_names = {shen.get('name', '') for shen in xiong_shen}

        # å¤©æœˆå¾·åˆï¼šå¤©å¾·è´µäºº + æœˆå¾·è´µäºº = å¤§å‰
        if 'å¤©å¾·è´µäºº' in ji_names and 'æœˆå¾·è´µäºº' in ji_names:
            bonus += 10.0

        # ä¸‰å¥‡è´µäººï¼šç”²æˆŠåºšã€ä¹™ä¸™ä¸ã€å£¬ç™¸è¾›
        # ï¼ˆç®€åŒ–åˆ¤æ–­ï¼šå¦‚æœæœ‰å¤šä¸ªè´µäººï¼‰
        if len(ji_names) >= 3:
            bonus += 5.0

        # ğŸ”¥ ä¿®å¤ï¼šç¾Šåˆƒé©¾æ€ï¼šç¾Šåˆƒ + ä¸ƒæ€ åŒæ—¶å‡ºç°ï¼Œåè€Œæˆæ ¼
        # ä¸ƒæ€æ˜¯åç¥ï¼Œä¸æ˜¯ç¥ç…ï¼Œéœ€è¦ä»å››æŸ±çš„åç¥ä¿¡æ¯ä¸­è·å–
        has_yangren = 'ç¾Šåˆƒ' in xiong_names
        has_qisha = False
        if bazi_data and has_yangren:
            # æ£€æŸ¥å››æŸ±ä¸­æ˜¯å¦æœ‰ä¸ƒæ€ï¼ˆåå®˜ï¼‰
            day_master = bazi_data.get_day_master()
            pillars = bazi_data.get_pillars()
            for pillar, (gan, zhi) in pillars.items():
                ten_god = get_ten_god(day_master, gan)
                if ten_god == 'ä¸ƒæ€':
                    has_qisha = True
                    break
        if has_yangren and has_qisha:
            bonus += 15.0  # ç¾Šåˆƒé©¾æ€ï¼Œåå‡¶ä¸ºå‰

        # é­ç½¡ + è´µäººï¼šé­ç½¡é‡è´µäººï¼Œåè€Œä¸å‰
        if 'é­ç½¡' in ji_names and ('å¤©ä¹™è´µäºº' in ji_names or 'å¤©å¾·è´µäºº' in ji_names):
            bonus -= 8.0  # é­ç½¡ä¸å–œè´µäºº

        # å­¤è¾°å¯¡å®¿åŒç°ï¼šåŠ é‡å­¤ç‹¬
        if 'å­¤è¾°' in xiong_names and 'å¯¡å®¿' in xiong_names:
            bonus -= 5.0

        # åç›– + æ–‡æ˜Œï¼šåˆ©äºå­¦æœ¯è‰ºæœ¯
        if 'åç›–' in ji_names and 'æ–‡æ˜Œ' in ji_names:
            bonus += 6.0

        return bonus
    
    def _determine_level(self, score: float) -> str:
        """ç¡®å®šç­‰çº§"""
        if score >= 85:
            return 'å¤§å‰'
        elif score >= 70:
            return 'å‰'
        elif score >= 55:
            return 'ä¸­å¹³'
        elif score >= 40:
            return 'å‡¶'
        else:
            return 'å¤§å‡¶'
    
    def _generate_description(self, ji_shen: List[Dict], xiong_shen: List[Dict]) -> str:
        """ç”Ÿæˆæè¿°"""
        ji_count = len(ji_shen)
        xiong_count = len(xiong_shen)
        
        if ji_count > xiong_count:
            return f"ç¥ç…åˆ†æï¼šå‰ç¥{ji_count}ä¸ªï¼Œå‡¶ç¥{xiong_count}ä¸ªï¼Œæ•´ä½“å‰åˆ©"
        elif ji_count < xiong_count:
            return f"ç¥ç…åˆ†æï¼šå‰ç¥{ji_count}ä¸ªï¼Œå‡¶ç¥{xiong_count}ä¸ªï¼Œéœ€è¦åŒ–è§£"
        else:
            return f"ç¥ç…åˆ†æï¼šå‰ç¥{ji_count}ä¸ªï¼Œå‡¶ç¥{xiong_count}ä¸ªï¼Œå‰å‡¶å‚åŠ"
    
    def _generate_advice(self, ji_shen: List[Dict], xiong_shen: List[Dict]) -> str:
        """ç”Ÿæˆå»ºè®®ï¼ˆåŒ…å«å‰ç¥åˆ©ç”¨å’Œå‡¶ç¥åŒ–è§£ï¼‰"""
        advice_parts = []
        
        if ji_shen:
            # ğŸ”¥ æ–°å¢ï¼šæ·»åŠ è¯¦ç»†å‰ç¥åˆ©ç”¨å»ºè®®
            ji_advice = self._get_ji_shen_advice(ji_shen)
            if ji_advice:
                advice_parts.append(f"å‰ç¥åˆ©ç”¨å»ºè®®ï¼š{ji_advice}")
            else:
                # å¦‚æœæ²¡æœ‰è¯¦ç»†å»ºè®®ï¼Œè‡³å°‘æ˜¾ç¤ºå‰ç¥åç§°
                ji_names = list(dict.fromkeys([shen['name'] for shen in ji_shen]))
                advice_parts.append(f"å‰ç¥ï¼š{', '.join(ji_names)}ï¼Œå®œå–„åŠ åˆ©ç”¨")
        
        if xiong_shen:
            # ğŸ”¥ ä¿®å¤ï¼šå»é‡å‡¶ç¥åç§°ï¼Œé¿å…é‡å¤æ˜¾ç¤º
            xiong_names = list(dict.fromkeys([shen['name'] for shen in xiong_shen]))
            advice_parts.append(f"å‡¶ç¥ï¼š{', '.join(xiong_names)}ï¼Œéœ€æ³¨æ„åŒ–è§£")
            
            # æ·»åŠ å…·ä½“åŒ–è§£å»ºè®®ï¼ˆ_get_hua_jie_adviceå†…éƒ¨ä¹Ÿä¼šå»é‡ï¼‰
            hua_jie_advice = self._get_hua_jie_advice(xiong_shen)
            if hua_jie_advice:
                advice_parts.append(f"åŒ–è§£å»ºè®®ï¼š{hua_jie_advice}")
        
        if not advice_parts:
            advice_parts.append("ç¥ç…å¹³è¡¡ï¼Œå®œä¿æŒç°çŠ¶")
        
        return 'ï¼›'.join(advice_parts)
    
    def _get_ji_shen_advice(self, ji_shen: List[Dict]) -> str:
        """
        è·å–å‰ç¥åˆ©ç”¨å»ºè®® - ğŸ”¥ æ–°å¢ï¼šä¸ºæ‰€æœ‰å‰ç¥æä¾›è¯¦ç»†çš„åˆ©ç”¨è¯´æ˜
        åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç­‰ç»å…¸ç†è®º
        """
        ji_advice_rules = {
            'å¤©å¾·è´µäºº': 'å¤©å¾·è´µäººä¹ƒé€¢å‡¶åŒ–å‰ä¹‹æœ€å¤§å‰ç¥ï¼Œå®œå¤šè¡Œå–„äº‹ç§¯å¾·ï¼Œåœ¨å…³é”®æ—¶åˆ»å¯æ±‚åŠ©è´µäººï¼Œä»äº‹æ…ˆå–„ã€å…¬ç›Šäº‹ä¸šèƒ½å¢å¼ºå…¶åŠ›é‡ï¼Œä½©æˆ´ç»¿è‰²æˆ–é’è‰²é¥°å“æœ‰åŠ©æå‡è´µäººè¿',
            'æœˆå¾·è´µäºº': 'æœˆå¾·è´µäººä¸»é€¢å‡¶åŒ–å‰ï¼Œå®œåœ¨æ¯æœˆå‰æ—¥è¡Œäº‹ï¼Œå¤šä¸å¾·é«˜æœ›é‡è€…äº¤å¾€ï¼Œä»äº‹ä¸æœˆäº®ã€å¥³æ€§ç›¸å…³çš„è¡Œä¸šæœ‰åˆ©ï¼Œä½©æˆ´é“¶è‰²æˆ–ç™½è‰²é¥°å“å¯å¢å¼ºå…¶ä½œç”¨',
            'å¤©ä¹™è´µäºº': 'å¤©ä¹™è´µäººä¸ºæœ€å°Šè´µä¹‹è´µäººæ˜Ÿï¼Œå®œç§¯æå¯»æ±‚è´µäººå¸®åŠ©ï¼Œä»äº‹ç®¡ç†ã€é¢†å¯¼å·¥ä½œæœ‰åˆ©ï¼Œåœ¨é‡è¦å†³ç­–æ—¶å’¨è¯¢æœ‰ç»éªŒçš„é•¿è¾ˆæˆ–ä¸Šçº§ï¼Œä½©æˆ´é‡‘è‰²é¥°å“å¯å¢å¼ºè´µäººè¿',
            'æ–‡æ˜Œè´µäºº': 'æ–‡æ˜Œè´µäººä¸»èªæ˜æ™ºæ…§ã€å­¦ä¸šæœ‰æˆï¼Œå®œä¸“å¿ƒå­¦ä¹ æ·±é€ ï¼Œä»äº‹æ–‡åŒ–ã€æ•™è‚²ã€å†™ä½œã€ç ”ç©¶ç­‰å·¥ä½œæœ‰åˆ©ï¼Œå¤šè¯»ä¹¦å­¦ä¹ ï¼Œä½©æˆ´æ–‡æˆ¿å››å®æˆ–æ–‡å…·ç±»é¥°å“å¯å¢å¼ºå…¶ä½œç”¨',
            'å­¦å ‚': 'å­¦å ‚æ˜Ÿä¸»å­¦ä¹ èƒ½åŠ›å¼ºï¼Œå®œç»§ç»­æ·±é€ ã€è¿›ä¿®æå‡ï¼Œé€‚åˆä»äº‹å­¦æœ¯ã€æ•™è‚²ã€åŸ¹è®­ç­‰å·¥ä½œï¼Œå¤šå‚ä¸å­¦ä¹ äº¤æµæ´»åŠ¨ï¼Œåœ¨ä¹¦æˆ¿æˆ–å­¦ä¹ ç¯å¢ƒä¸­å·¥ä½œæ›´èƒ½å‘æŒ¥å…¶ä½œç”¨',
            'è¯é¦†': 'è¯é¦†æ˜Ÿä¸»æ–‡é‡‡å£æ‰å‡ºä¼—ï¼Œå®œä»äº‹å†™ä½œã€æ¼”è®²ã€ç¿»è¯‘ã€ä¼ åª’ç­‰å·¥ä½œï¼Œå¤šç»ƒä¹ è¡¨è¾¾èƒ½åŠ›ï¼Œå‚ä¸æ–‡åŒ–æ´»åŠ¨ï¼Œä½©æˆ´ä¸æ–‡å­—ã€è¯­è¨€ç›¸å…³çš„é¥°å“å¯å¢å¼ºå…¶åŠ›é‡',
            'ç¦„ç¥': 'ç¦„ç¥ä¸»å¯Œè´µè£åã€è´¢è¿äº¨é€šï¼Œå®œç§¯æè¿›å–ã€åŠªåŠ›å·¥ä½œï¼Œä»äº‹ç¨³å®šçš„å·¥ä½œæˆ–åˆ›ä¸šæœ‰åˆ©ï¼Œç†è´¢æŠ•èµ„éœ€è°¨æ…ï¼Œä½©æˆ´é»„è‰²æˆ–é‡‘è‰²é¥°å“å¯å¢å¼ºè´¢è¿',
            'åç›–': 'åç›–ä¸»è‰ºæœ¯æ‰åã€æ¸…é«˜å­¤å‚²ï¼Œå®œå‘å±•æ–‡åŒ–ã€è‰ºæœ¯ã€å®—æ•™ã€å“²å­¦ç­‰æ–¹é¢çš„æ‰èƒ½ï¼Œé€‚åˆä»äº‹è‰ºæœ¯åˆ›ä½œã€è®¾è®¡ã€ç„å­¦ç­‰å·¥ä½œï¼Œä¿æŒç‹¬ç«‹æ€è€ƒï¼Œé¿å…è¿‡åº¦ä¸–ä¿—åŒ–',
            'çº¢é¸¾': 'çº¢é¸¾æ˜Ÿä¸»å©šå–œäººç¼˜ï¼Œå•èº«è€…å®œæŠŠæ¡æœºä¼šå¯»æ‰¾è‰¯ç¼˜ï¼Œå·²å©šè€…å®œå¢è¿›å¤«å¦»æ„Ÿæƒ…ï¼Œä»äº‹ä¸å©šåº†ã€ç¾å®¹ã€æœè£…ç­‰ç›¸å…³è¡Œä¸šæœ‰åˆ©ï¼Œä½©æˆ´çº¢è‰²æˆ–ç²‰è‰²é¥°å“å¯å¢å¼ºæ¡ƒèŠ±è¿',
            'å¤©å–œ': 'å¤©å–œæ˜Ÿä¸»å–œåº†å‰ç¥¥ï¼Œå®œåœ¨å–œåº†åœºåˆå‚ä¸æ´»åŠ¨ï¼Œå¤šä¸äººåˆ†äº«å¿«ä¹ï¼Œä»äº‹å¨±ä¹ã€é¤é¥®ã€æ—…æ¸¸ç­‰è¡Œä¸šæœ‰åˆ©ï¼Œä¿æŒä¹è§‚ç§¯æçš„å¿ƒæ€ï¼Œä½©æˆ´çº¢è‰²é¥°å“å¯å¢å¼ºå–œåº†ä¹‹æ°”',
            'é©¿é©¬': 'é©¿é©¬ä¸»å˜åŠ¨ã€å‡ºè¡Œã€äº‹ä¸šå˜è¿ï¼Œå®œæŠŠæ¡å¤–å‡ºã€å‡ºå·®ã€è¿ç§»çš„æœºä¼šï¼Œä»äº‹è´¸æ˜“ã€ç‰©æµã€äº¤é€šã€æ—…æ¸¸ç­‰è¡Œä¸šæœ‰åˆ©ï¼Œä¸»åŠ¨æ±‚å˜å¯å¸¦æ¥å¥½è¿ï¼Œä½©æˆ´é©¬å½¢é¥°å“å¯å¢å¼ºå…¶ä½œç”¨',
            'å°†æ˜Ÿ': 'å°†æ˜Ÿä¸»é¢†å¯¼æ‰èƒ½ã€æƒå¨æ˜¾èµ«ï¼Œå®œä»äº‹ç®¡ç†ã€é¢†å¯¼ã€å†›äº‹ã€æ‰§æ³•ç­‰å·¥ä½œï¼ŒåŸ¹å…»é¢†å¯¼åŠ›å’Œç»„ç»‡èƒ½åŠ›ï¼Œåœ¨é‡è¦æ—¶æœºå‹‡äºæ‹…å½“ï¼Œä½©æˆ´è±¡å¾æƒå¨çš„é¥°å“å¯å¢å¼ºå…¶åŠ›é‡',
            'é‡‘èˆ†': 'é‡‘èˆ†ä¸»å¯Œè´µè£åã€è½¦é©¬æ˜¾è¾¾ï¼Œå®œä»äº‹ä¸äº¤é€šã€ç‰©æµã€æ±½è½¦ç›¸å…³çš„å·¥ä½œï¼Œæ³¨é‡ç”Ÿæ´»å“è´¨çš„æå‡ï¼Œå¤šå‡ºè¡Œæ¸¸å†å¼€é˜”çœ¼ç•Œï¼Œä½©æˆ´ä¸è½¦è¾†ã€äº¤é€šå·¥å…·ç›¸å…³çš„é¥°å“å¯å¢å¼ºå…¶ä½œç”¨',
            'å¤ªæè´µäºº': 'å¤ªæè´µäººä¸»èªæ˜æ™ºæ…§ã€å­¦é—®æ·±åšï¼Œå®œä»äº‹æ–‡åŒ–ã€å“²å­¦ã€å®—æ•™ã€ç„å­¦ç­‰é¢†åŸŸçš„å·¥ä½œï¼Œå¤šå­¦ä¹ ä¼ ç»Ÿæ–‡åŒ–ï¼Œä¿®èº«å…»æ€§ï¼Œä¿æŒå†…å¿ƒå¹³å’Œï¼Œä½©æˆ´ä¸å¤ªæã€é˜´é˜³ç›¸å…³çš„é¥°å“å¯å¢å¼ºå…¶åŠ›é‡',
            'å›½å°è´µäºº': 'å›½å°è´µäººä¸»å®˜è¿äº¨é€šã€æŒæƒæœ‰å°ï¼Œå®œä»äº‹å…¬èŒã€ç®¡ç†ã€è¡Œæ”¿ç­‰å·¥ä½œï¼Œæ³¨é‡è¯šä¿¡å’Œè´£ä»»æ„Ÿï¼Œå»ºç«‹è‰¯å¥½å£°èª‰ï¼Œåœ¨å…³é”®æ—¶æœºæŠŠæ¡æ™‹å‡æœºä¼šï¼Œä½©æˆ´å°ç« ç±»é¥°å“å¯å¢å¼ºå®˜è¿',
            'ç¦æ˜Ÿè´µäºº': 'ç¦æ˜Ÿè´µäººä¸»ç¦æ°”æ·±åšã€ç”Ÿæ´»å®‰é€¸ï¼Œå®œçŸ¥è¶³å¸¸ä¹ï¼Œå¤šè¡Œå–„äº‹ç§¯ç´¯ç¦å¾·ï¼Œä»äº‹ç¨³å®šã€ç¦åˆ©å¥½çš„å·¥ä½œæœ‰åˆ©ï¼Œæ³¨é‡å®¶åº­å’Œç¦ï¼Œä½©æˆ´ä¸ç¦å­—ã€è™è ç›¸å…³çš„é¥°å“å¯å¢å¼ºç¦è¿',
            'ä¸‰å¥‡è´µäºº': 'ä¸‰å¥‡è´µäººä¸»å¥‡æ‰å¼‚ç¦€ã€éå‡¡æˆå°±ï¼Œå®œæŠŠæ¡ç‰¹æ®Šæœºé‡ï¼Œä»äº‹åˆ›æ–°ã€ç§‘æŠ€ã€è‰ºæœ¯ç­‰å‰æ²¿é¢†åŸŸæœ‰åˆ©ï¼Œå‹‡äºçªç ´å¸¸è§„ï¼Œå‘æŒ¥ç‹¬ç‰¹æ‰èƒ½ï¼Œä½©æˆ´å…·æœ‰ç‰¹æ®Šæ„ä¹‰çš„é¥°å“å¯å¢å¼ºå…¶åŠ›é‡',
            'å¤©å®˜è´µäºº': 'å¤©å®˜è´µäººä¸»å®˜è¿äº¨é€šï¼Œå®œä»äº‹å…¬èŒã€ç®¡ç†ã€å¸æ³•ç­‰å·¥ä½œï¼Œæ³¨é‡å“å¾·ä¿®å…»ï¼Œéµå®ˆæ³•å¾‹æ³•è§„ï¼Œåœ¨å®˜åœºæˆ–èŒåœºä¸­å»ºç«‹è‰¯å¥½å…³ç³»ï¼Œä½©æˆ´è±¡å¾æƒåŠ›çš„é¥°å“å¯å¢å¼ºå®˜è¿',
            'å¤©èµ¦': 'å¤©èµ¦ä¸»é€¢å‡¶åŒ–å‰ã€é‡éš¾å‘ˆç¥¥ï¼Œæ˜¯å¤§èµ¦ä¹‹æ˜Ÿï¼Œå®œåœ¨å›°éš¾æ—¶æœŸä¿æŒä¿¡å¿ƒï¼Œä»äº‹æ…ˆå–„ã€æ•‘åŠ©ã€åŒ»ç–—ç­‰å·¥ä½œæœ‰åˆ©ï¼Œå¤šå¸®åŠ©ä»–äººå¯å¢å¼ºå…¶åŒ–è§£å‡¶é™©çš„åŠ›é‡ï¼Œä½©æˆ´ç»¿è‰²é¥°å“å¯å¢å¼ºå…¶ä½œç”¨'
        }
        
        # ğŸ”¥ å»é‡ï¼Œæ¯ä¸ªå‰ç¥åªæ˜¾ç¤ºä¸€æ¬¡åˆ©ç”¨å»ºè®®
        seen_names = set()
        advice_list = []
        for shen in ji_shen:
            name = shen['name']
            if name in ji_advice_rules and name not in seen_names:
                advice_list.append(f"{name}ï¼š{ji_advice_rules[name]}")
                seen_names.add(name)
        
        return 'ï¼›'.join(advice_list) if advice_list else ""
    
    def _get_hua_jie_advice(self, xiong_shen: List[Dict]) -> str:
        """
        è·å–å‡¶ç¥åŒ–è§£å»ºè®® - ğŸ”¥ å®Œå–„ï¼šä¸ºæ‰€æœ‰å‡¶ç¥æä¾›è¯¦ç»†çš„åŒ–è§£è¯´æ˜
        åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç­‰ç»å…¸ç†è®º
        """
        hua_jie_rules = {
            'ç¾Šåˆƒ': 'ç¾Šåˆƒä¸»åˆ‘ä¼¤ï¼Œæ€§æ ¼åˆšçƒˆï¼Œæ˜“æœ‰è¡€å…‰ä¹‹ç¾ã€‚åŒ–è§£æ–¹æ³•ï¼šä½©æˆ´é‡‘é“¶é¥°å“ï¼ˆé‡‘å±å¯åˆ¶æœ¨ï¼ŒåŒ–è§£ç¾Šåˆƒä¹‹é”æ°”ï¼‰ï¼Œé¿å…å†²åŠ¨è¡Œäº‹ï¼Œå¤šè¡Œå–„äº‹ç§¯å¾·ï¼Œç»ƒä¹ é™å¿ƒä¿®è¡Œçš„åŠŸå¤«ï¼Œé¿å…å‚ä¸å±é™©æ´»åŠ¨ï¼Œæ³¨æ„äº¤é€šå®‰å…¨',
            'åŠ«ç…': 'åŠ«ç…ä¸»ç ´è´¢ï¼Œæ˜“é­å°äººï¼Œäº‹ä¸šä¸é¡ºã€‚åŒ–è§£æ–¹æ³•ï¼šä½©æˆ´ç‰çŸ³ï¼ˆåœŸå¯ç”Ÿé‡‘ï¼ŒåŒ–è§£åŠ«ç…ä¹‹å‡¶æ€§ï¼‰ï¼Œé¿å…å€Ÿè´·å’Œæ‹…ä¿ï¼Œè°¨æ…äº¤å‹ï¼Œè¿œç¦»æ˜¯éä¹‹åœ°ï¼Œå¤šç»“äº¤æ­£ç›´å‹äººï¼Œæ³¨é‡ä¿¡ç”¨å»ºè®¾',
            'æ¡ƒèŠ±': 'æ¡ƒèŠ±ï¼ˆå’¸æ± ï¼‰ä¸»åŠ¨ï¼Œä¸»æƒ…æ„Ÿæ³¢åŠ¨ã€äººç¼˜å¤æ‚ï¼Œè™½æœ‰é­…åŠ›ä½†éœ€æ­£å·±è‡ªæŒã€‚åŒ–è§£æ–¹æ³•ï¼šä¿®èº«å…»æ€§ï¼Œæ­£å·±è‡ªæŒï¼Œé¿å…æ„Ÿæƒ…çº è‘›ï¼Œä¿æŒæƒ…æ„Ÿä¸“ä¸€ï¼Œä»äº‹æ–‡åŒ–è‰ºæœ¯å·¥ä½œå¯è½¬åŒ–å…¶èƒ½é‡ï¼Œä½©æˆ´æ°´æ™¶ç±»é¥°å“å¯å¢å¼ºæ­£é¢ä½œç”¨',
            'å­¤è¾°': 'å­¤è¾°ä¸»æ€§æƒ…å­¤å‚²ï¼Œäººé™…å…³ç³»æ·¡è–„ã€‚åŒ–è§£æ–¹æ³•ï¼šå¤šå‚ä¸ç¤¾äº¤æ´»åŠ¨ï¼ŒåŸ¹å…»å…´è¶£çˆ±å¥½ï¼Œä¸»åŠ¨ä¸äººäº¤æµåˆä½œï¼Œå‚åŠ å›¢ä½“æ´»åŠ¨ï¼ŒåŸ¹å…»å›¢é˜Ÿç²¾ç¥ï¼Œé¿å…è¿‡åº¦ç‹¬å¤„ï¼Œä»äº‹éœ€è¦åä½œçš„å·¥ä½œæœ‰åˆ©',
            'å¯¡å®¿': 'å¯¡å®¿ä¸»ç‹¬å¤„å°‘ç¼˜ï¼Œæƒ…æ„Ÿå­¤ç‹¬ã€‚åŒ–è§£æ–¹æ³•ï¼šé‡è§†å®¶åº­å…³ç³»ï¼Œå¤šé™ªä¼´å®¶äººï¼ŒåŸ¹å…»æƒ…æ„Ÿäº¤æµï¼Œå‚ä¸å®¶åº­èšä¼šï¼ŒåŸ¹å…»å® ç‰©æˆ–æ¤ç‰©ï¼Œä»äº‹ä¸ç…§é¡¾ä»–äººç›¸å…³çš„å·¥ä½œï¼Œä½©æˆ´è±¡å¾å›¢åœ†çš„é¥°å“',
            'åç›–': 'åç›–ä¸»è‰ºæœ¯æ‰åä½†æ˜“å­¤é«˜ï¼Œéœ€æ³¨æ„äººé™…å…³ç³»ã€‚åŒ–è§£æ–¹æ³•ï¼šå‘å±•è‰ºæœ¯æ‰èƒ½ï¼Œå­¦ä¹ ä¼ ç»Ÿæ–‡åŒ–ï¼Œä¿æŒæ¸…é«˜å“æ ¼ä½†ä¸å¤±è°¦é€Šï¼Œå¤šä¸å¿—åŒé“åˆè€…äº¤æµï¼Œé¿å…è¿‡åº¦å­¤åƒ»ï¼Œä»äº‹æ–‡åŒ–è‰ºæœ¯å·¥ä½œå¯å‘æŒ¥å…¶æ­£é¢ä½œç”¨',
            'ç©ºäº¡': 'ç©ºäº¡ä¸»è™šè€—ï¼Œäº‹å¤šåå¤ï¼Œå®¹æ˜“è½ç©ºã€‚åŒ–è§£æ–¹æ³•ï¼šè„šè¸å®åœ°ï¼Œé¿å…æŠ•æœºå–å·§ï¼Œæ³¨é‡å®é™…æ•ˆæœï¼Œåˆ¶å®šæ˜ç¡®ç›®æ ‡å’Œè®¡åˆ’ï¼Œå¤šåšå®é™…å·¥ä½œè€Œéç©ºæƒ³ï¼Œä½©æˆ´ä¸è¸å®ç¨³å®šç›¸å…³çš„é¥°å“ï¼Œä»äº‹åŠ¡å®çš„å·¥ä½œæœ‰åˆ©',
            'å¤©ç½—': 'å¤©ç½—ä¸»å›°ç¼šé˜»æ»ï¼Œå®¹æ˜“å—å›°ã€‚åŒ–è§£æ–¹æ³•ï¼šå¾ªè§„è¹ˆçŸ©ï¼Œé¿å…è¿æ³•ä¹±çºªï¼Œä¿æŒæ­£é“ï¼Œå¤šè¡Œå–„äº‹åŒ–è§£å›°å±€ï¼Œå¯»æ±‚è´µäººå¸®åŠ©ï¼Œä»äº‹æ­£å½“è¡Œä¸šï¼Œä½©æˆ´ä¸è‡ªç”±ã€çªç ´ç›¸å…³çš„é¥°å“å¯åŒ–è§£å›°ç¼š',
            'åœ°ç½‘': 'åœ°ç½‘ä¸»ç¾ç»Šçº ç¼ ï¼Œå®¹æ˜“é™·å…¥å›°å¢ƒã€‚åŒ–è§£æ–¹æ³•ï¼šè°¨æ…è¡Œäº‹ï¼Œé¿å…é™·é˜±ï¼Œä¿æŒæ¸…é†’å¤´è„‘ï¼Œè¿œç¦»æ˜¯éå’Œçº çº·ï¼Œå¤šä¸æ­£ç›´äººå£«äº¤å¾€ï¼Œä»äº‹ç®€å•æ˜äº†çš„å·¥ä½œï¼Œä½©æˆ´ä¸æ°´ç›¸å…³çš„é¥°å“ï¼ˆæ°´å¯åŒ–è§£åœ°ç½‘ä¹‹å›°ï¼‰',
            # ğŸ”¥ ä¸‰åˆ‘åŒ–è§£å»ºè®®ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šÂ·è®ºä¸‰åˆ‘ã€‹ï¼‰
            'æƒåŠ¿ä¹‹åˆ‘': 'æƒåŠ¿ä¹‹åˆ‘ä¸»å…¥è´±æ ¼åˆ™å¤šçŠ¯åˆ‘ä¹¦æš—æ˜§ä¹‹ç¾ï¼Œéœ€é¿å…æƒå¼ºå‡Œå¼±ã€‚åŒ–è§£æ–¹æ³•ï¼šä¿æŒè°¦é€Šä½è°ƒï¼Œé¿å…æƒå¼ºå‡Œå¼±ï¼Œå¤šè¡Œå–„äº‹ç§¯å¾·ï¼Œå¯ä½©æˆ´æœ¨è´¨é¥°å“åŒ–è§£ï¼ˆæœ¨å¯ç”Ÿç«ï¼ŒåŒ–è§£åœŸåˆ‘ï¼‰ï¼ŒåŸ¹å…»åŒ…å®¹å¿ƒæ€ï¼Œé¿å…ä¸äººäº‰æ‰§',
            'æ— æ©ä¹‹åˆ‘': 'æ— æ©ä¹‹åˆ‘ä¸»æƒ¨è™å¥½æ€ï¼Œå¥½ç«‹åŠŸä¸šï¼›å…¥è´±æ ¼åˆ™è¨€è¡Œä¹–è¶Šï¼Œè´ªåæ— åŒã€‚åŒ–è§£æ–¹æ³•ï¼šé‡è§†äººé™…å…³ç³»ï¼ŒçŸ¥æ©å›¾æŠ¥ï¼Œé¿å…å¿˜æ©è´Ÿä¹‰ï¼Œå®œå¤šç»“äº¤æ­£ç›´å‹äººï¼ŒåŸ¹å…»æ„Ÿæ©ä¹‹å¿ƒï¼Œä»äº‹ä¸å¸®åŠ©ä»–äººç›¸å…³çš„å·¥ä½œ',
            'æ— ç¤¼ä¹‹åˆ‘': 'æ— ç¤¼ä¹‹åˆ‘ä¸»ä¸åˆ©è¿‘ä¾ï¼›ä½å±…ä¸ä¹…ï¼›å…¥è´±æ ¼åˆ™æ‚–å‡¶æš´ï¼Œå¤šæ‹›åˆ‘ç¥¸ã€‚åŒ–è§£æ–¹æ³•ï¼šæ³¨æ„è¨€è¡Œè§„èŒƒï¼Œéµå®ˆç¤¼ä»ªï¼Œé¿å…å†²åŠ¨å†’å¤±ï¼Œå®œä¿®èº«å…»æ€§ï¼Œå­¦ä¹ ä¼ ç»Ÿæ–‡åŒ–ç¤¼ä»ªï¼ŒåŸ¹å…»æ¸©å’Œçš„æ€§æ ¼ï¼Œä»äº‹ä¸ç¤¼ä»ªç›¸å…³çš„å·¥ä½œ',
            'è‡ªåˆ‘': 'è‡ªåˆ‘ä¸»è‡ªæˆ‘åˆ‘ä¼¤ï¼Œå®¹æ˜“è‡ªæˆ‘æŠ˜ç£¨ã€‚åŒ–è§£æ–¹æ³•ï¼šè‡ªæˆ‘è°ƒèŠ‚æƒ…ç»ªï¼Œé¿å…æç«¯è¡Œä¸ºï¼Œä¿æŒå†…å¿ƒå¹³å’Œï¼Œå®œé™å¿ƒä¿®è¡Œï¼Œå­¦ä¹ å¿ƒç†å­¦æˆ–å†¥æƒ³ï¼ŒåŸ¹å…»å¥åº·çš„ç”Ÿæ´»æ–¹å¼ï¼Œä»äº‹ä¸è‡ªæˆ‘æå‡ç›¸å…³çš„å·¥ä½œ',
            # å…¶ä»–å‡¶ç¥åŒ–è§£å»ºè®®
            'å®˜ç¬¦ç…': 'å®˜ç¬¦ç…ä¸»å®˜ç¾ï¼Œæ›´å¹¶ç¾Šåˆƒï¼Œä¹ƒåˆ‘å¾’ä¹‹å‘½ã€‚å¹³ç”Ÿå¤šå®˜ç¾ã€‚åŒ–è§£æ–¹æ³•ï¼šå¾ªæ³•å®ˆåºï¼Œé¿å…è¿æ³•ä¹±çºªï¼Œè°¨è¨€æ…è¡Œï¼Œå®œä½©æˆ´é‡‘å±é¥°å“ï¼ˆé‡‘å¯åŒ–è§£å®˜ç¬¦ä¹‹å‡¶ï¼‰ï¼Œä»äº‹æ­£å½“èŒä¸šï¼Œå»ºç«‹è‰¯å¥½å£°èª‰ï¼Œå¤šä¸å¸æ³•ã€æ³•å¾‹ç›¸å…³äººå£«äº¤æµ',
            'å‹¾ç…': 'å‹¾ç…ä¸»ç‰µè¿ç¾ç»Šï¼Œä¸»éå‘½è€Œç»ˆï¼›å°äººé€¢ä¹‹ï¼Œéæ¨ªç¾ç¥¸ï¼›è¡Œå¹´è‡³æ­¤ï¼Œäº¦ä¸»å£èˆŒåˆ‘ç‹±ç­‰äº‹ã€‚åŒ–è§£æ–¹æ³•ï¼šé¿å…æ˜¯éå£èˆŒï¼Œè°¨æ…å¤„ç†äººé™…å…³ç³»ï¼Œè¿œç¦»çº çº·ï¼Œå®œå¤šè¡Œå–„äº‹åŒ–è§£ï¼Œä½©æˆ´æŠ¤èº«ç¬¦ï¼Œä»äº‹æ­£å½“è¡Œä¸š',
            'ç»ç…': 'ç»ç…ä¸»ç‰µè¿ç¾ç»Šï¼Œä¸»éå‘½è€Œç»ˆï¼›å°äººé€¢ä¹‹ï¼Œéæ¨ªç¾ç¥¸ï¼›è¡Œå¹´è‡³æ­¤ï¼Œäº¦ä¸»å£èˆŒåˆ‘ç‹±ç­‰äº‹ã€‚åŒ–è§£æ–¹æ³•ï¼šé¿å…å·å…¥æ˜¯éï¼Œè°¨æ…é€‰æ‹©åˆä½œä¼™ä¼´ï¼Œä¿æŒæ¸…é†’åˆ¤æ–­ï¼Œå¤šè¡Œå–„äº‹ï¼Œä½©æˆ´ä¸æ°´ç›¸å…³çš„é¥°å“ï¼ˆæ°´å¯åŒ–è§£ç»ç…ä¹‹çº ç¼ ï¼‰ï¼Œä»äº‹ç®€å•æ˜ç¡®çš„å·¥ä½œ',
            'å‹¾ç»ç…': 'å‹¾ç»ç…ä¸»ç‰µè¿ç¾ç»Šï¼Œä¸»éå‘½è€Œç»ˆï¼›å°äººé€¢ä¹‹ï¼Œéæ¨ªç¾ç¥¸ï¼›è¡Œå¹´è‡³æ­¤ï¼Œäº¦ä¸»å£èˆŒåˆ‘ç‹±ç­‰äº‹ã€‚åŒ–è§£æ–¹æ³•ï¼šé¿å…æ˜¯éå£èˆŒï¼Œè°¨æ…å¤„ç†äººé™…å…³ç³»ï¼Œè¿œç¦»çº çº·å’Œè¯‰è®¼ï¼Œå¤šè¡Œå–„äº‹åŒ–è§£ï¼Œä½©æˆ´æŠ¤èº«ç¬¦ï¼Œä»äº‹æ­£å½“è¡Œä¸šï¼Œå»ºç«‹è‰¯å¥½å£°èª‰',
            'ç¾ç…': 'ç¾ç…ä¸»è¡€å…‰æ¨ªæ­»ã€‚åœ¨æ°´ç«ï¼Œé˜²ç„šæººï¼›é‡‘æœ¨æ–åˆƒï¼›åœŸå è½ï¼Œç˜Ÿç–«å…‹èº«ã€‚åŒ–è§£æ–¹æ³•ï¼šæ³¨æ„å®‰å…¨ï¼Œé¿å…å±é™©æ´»åŠ¨ï¼Œå¯ä½©æˆ´æŠ¤èº«ç¬¦ï¼Œå¤šè¡Œå–„äº‹ï¼Œè¿œç¦»å±é™©åœºæ‰€ï¼Œä»äº‹å®‰å…¨å·¥ä½œï¼Œæ³¨æ„èº«ä½“å¥åº·ï¼Œå®šæœŸä½“æ£€ï¼Œä½©æˆ´ä¸å¹³å®‰ç›¸å…³çš„é¥°å“',
            'å…­å„': 'å…­å„ä¸»é­éš¾ï¼Œä¸€ç”Ÿè¹‡æ»ã€‚è‹¥æœ‰æ•‘æŠ¤ã€æ‰¶æŒã€é€¢ç”Ÿæ—ºå…¼è´µæ°”ç›¸åŠ©ï¼Œåˆ™å‰ã€‚åŒ–è§£æ–¹æ³•ï¼šä¿æŒç§¯æå¿ƒæ€ï¼Œå¯»æ±‚è´µäººç›¸åŠ©ï¼Œå¤šè¡Œå–„äº‹ç§¯å¾·ï¼Œå¯åŒ–è§£å„è¿ï¼Œä»äº‹ä¸å¸®åŠ©ä»–äººç›¸å…³çš„å·¥ä½œï¼ŒåŸ¹å…»åšå¼ºæ„å¿—ï¼Œä½©æˆ´ä¸å‰ç¥¥ç›¸å…³çš„é¥°å“ï¼Œå¤šä¸è´µäººäº¤å¾€'
        }
        
        # ğŸ”¥ ä¿®å¤ï¼šå»é‡ï¼Œæ¯ä¸ªç¥ç…åªæ˜¾ç¤ºä¸€æ¬¡åŒ–è§£å»ºè®®
        seen_names = set()
        advice_list = []
        for shen in xiong_shen:
            name = shen['name']
            if name in hua_jie_rules and name not in seen_names:
                advice_list.append(f"{name}ï¼š{hua_jie_rules[name]}")
                seen_names.add(name)
        
        return 'ï¼›'.join(advice_list) if advice_list else ""
    
    def _jiangxing(self, year_branch: str) -> str:
        """
        å°†æ˜ŸæŸ¥æ³• - åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç†è®º
        ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å°†æ˜Ÿè€…ï¼Œä¸‰åˆå±€ä¸­ç¥ä¹Ÿã€‚å¯…åˆæˆŒè§åˆï¼Œç”³å­è¾°è§å­ï¼Œäº¥å¯æœªè§å¯ï¼Œå·³é…‰ä¸‘è§é…‰ã€‚"
        
        æŸ¥æ³•ï¼šä»¥å¹´æ”¯ä¸ºå‡†ï¼Œä¸‰åˆå±€çš„ä¸­ç¥ä¸ºå°†æ˜Ÿ
        - ç”³å­è¾°ï¼ˆæ°´å±€ï¼‰â†’ å°†æ˜Ÿåœ¨å­ï¼ˆä¸­ç¥ï¼‰
        - å¯…åˆæˆŒï¼ˆç«å±€ï¼‰â†’ å°†æ˜Ÿåœ¨åˆï¼ˆä¸­ç¥ï¼‰
        - å·³é…‰ä¸‘ï¼ˆé‡‘å±€ï¼‰â†’ å°†æ˜Ÿåœ¨é…‰ï¼ˆä¸­ç¥ï¼‰
        - äº¥å¯æœªï¼ˆæœ¨å±€ï¼‰â†’ å°†æ˜Ÿåœ¨å¯ï¼ˆä¸­ç¥ï¼‰
        """
        if year_branch in {'ç”³', 'å­', 'è¾°'}:
            return 'å­'  # ç”³å­è¾°è§å­
        if year_branch in {'å¯…', 'åˆ', 'æˆŒ'}:
            return 'åˆ'  # å¯…åˆæˆŒè§åˆ
        if year_branch in {'å·³', 'é…‰', 'ä¸‘'}:
            return 'é…‰'  # å·³é…‰ä¸‘è§é…‰
        if year_branch in {'äº¥', 'å¯', 'æœª'}:
            return 'å¯'  # äº¥å¯æœªè§å¯
        return ''
    
    def _jinyu(self, day_master: str) -> str:
        """
        é‡‘èˆ†æŸ¥æ³• - åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç†è®º
        ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"é‡‘èˆ†è€…ï¼Œæ—¥å¹²ä¸´é•¿ç”ŸåäºŒå®«ä¹‹å¸æ—ºä½ä¹Ÿã€‚"
        
        æŸ¥æ³•ï¼šç”²æ—¥è§è¾°ï¼Œä¹™æ—¥è§å·³ï¼Œä¸™æ—¥è§æœªï¼Œä¸æ—¥è§ç”³ï¼ŒæˆŠæ—¥è§æœªï¼Œå·±æ—¥è§ç”³ï¼Œåºšæ—¥è§æˆŒï¼Œè¾›æ—¥è§äº¥ï¼Œå£¬æ—¥è§ä¸‘ï¼Œç™¸æ—¥è§å¯…
        """
        jinyu_map = {
            'ç”²': 'è¾°', 'ä¹™': 'å·³', 'ä¸™': 'æœª', 'ä¸': 'ç”³', 'æˆŠ': 'æœª',
            'å·±': 'ç”³', 'åºš': 'æˆŒ', 'è¾›': 'äº¥', 'å£¬': 'ä¸‘', 'ç™¸': 'å¯…'
        }
        return jinyu_map.get(day_master, '')
    
    def _taiji_guiren(self, day_master: str) -> List[str]:
        """
        å¤ªæè´µäººæŸ¥æ³• - åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç†è®º
        ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å¤ªæè€…ï¼Œå¤©åœ°æœªåˆ†ï¼Œæ··æ²Œåˆå¼€ä¹Ÿã€‚"
        
        æŸ¥æ³•ï¼šç”²ä¹™æ—¥è§å­åˆï¼Œä¸™ä¸æ—¥è§å¯é…‰ï¼ŒæˆŠå·±æ—¥è§è¾°æˆŒä¸‘æœªï¼Œåºšè¾›æ—¥è§å¯…ç”³ï¼Œå£¬ç™¸æ—¥è§å·³äº¥
        """
        taiji_map = {
            'ç”²': ['å­', 'åˆ'], 'ä¹™': ['å­', 'åˆ'],
            'ä¸™': ['å¯', 'é…‰'], 'ä¸': ['å¯', 'é…‰'],
            'æˆŠ': ['è¾°', 'æˆŒ', 'ä¸‘', 'æœª'], 'å·±': ['è¾°', 'æˆŒ', 'ä¸‘', 'æœª'],
            'åºš': ['å¯…', 'ç”³'], 'è¾›': ['å¯…', 'ç”³'],
            'å£¬': ['å·³', 'äº¥'], 'ç™¸': ['å·³', 'äº¥']
        }
        return taiji_map.get(day_master, [])
    
    def _guoyin_guiren(self, year_gan: str) -> str:
        """
        å›½å°è´µäººæŸ¥æ³• - åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç†è®º
        ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å›½å°è€…ï¼Œæœå»·ä¹‹å°ä¹Ÿã€‚"
        
        æŸ¥æ³•ï¼šç”²è§æˆŒï¼Œä¹™è§äº¥ï¼Œä¸™è§ä¸‘ï¼Œä¸è§å¯…ï¼ŒæˆŠè§ä¸‘ï¼Œå·±è§å¯…ï¼Œåºšè§è¾°ï¼Œè¾›è§å·³ï¼Œå£¬è§æœªï¼Œç™¸è§ç”³
        """
        guoyin_map = {
            'ç”²': 'æˆŒ', 'ä¹™': 'äº¥', 'ä¸™': 'ä¸‘', 'ä¸': 'å¯…', 'æˆŠ': 'ä¸‘',
            'å·±': 'å¯…', 'åºš': 'è¾°', 'è¾›': 'å·³', 'å£¬': 'æœª', 'ç™¸': 'ç”³'
        }
        return guoyin_map.get(year_gan, '')
    
    def _fuxing_guiren(self, day_master: str) -> str:
        """
        ç¦æ˜Ÿè´µäººæŸ¥æ³• - åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç†è®º
        ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"ç¦æ˜Ÿè€…ï¼Œç¦å¾·ä¹‹æ˜Ÿä¹Ÿã€‚"
        
        æŸ¥æ³•ï¼šç”²è§ä¸™ï¼Œä¹™è§ä¸ï¼Œä¸™è§æˆŠï¼Œä¸è§å·±ï¼ŒæˆŠè§åºšï¼Œå·±è§è¾›ï¼Œåºšè§å£¬ï¼Œè¾›è§ç™¸ï¼Œå£¬è§ç”²ï¼Œç™¸è§ä¹™
        """
        fuxing_map = {
            'ç”²': 'ä¸™', 'ä¹™': 'ä¸', 'ä¸™': 'æˆŠ', 'ä¸': 'å·±', 'æˆŠ': 'åºš',
            'å·±': 'è¾›', 'åºš': 'å£¬', 'è¾›': 'ç™¸', 'å£¬': 'ç”²', 'ç™¸': 'ä¹™'
        }
        return fuxing_map.get(day_master, '')
    
    def _sanqi_guiren(self, pillars: Dict[str, Tuple[str, str]]) -> Dict[str, Any] | None:
        """
        ä¸‰å¥‡è´µäººæŸ¥æ³• - åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç†è®º
        ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"ä¸‰å¥‡è€…ï¼Œå¤©åœ°äººä¸‰å¥‡ä¹Ÿã€‚å¤©ä¸Šä¸‰å¥‡ï¼šç”²æˆŠåºšï¼›åœ°ä¸‹ä¸‰å¥‡ï¼šä¹™ä¸™ä¸ï¼›äººä¸­ä¸‰å¥‡ï¼šå£¬ç™¸è¾›ã€‚"
        
        æŸ¥æ³•ï¼šå¹´æœˆæ—¥å¤©å¹²æŒ‰é¡ºåºå‡ºç°ä¸‰å¥‡
        - å¤©ä¸Šä¸‰å¥‡ï¼šç”²æˆŠåºšï¼ˆé¡ºæ¬¡å‡ºç°ï¼‰
        - åœ°ä¸‹ä¸‰å¥‡ï¼šä¹™ä¸™ä¸ï¼ˆé¡ºæ¬¡å‡ºç°ï¼‰
        - äººä¸­ä¸‰å¥‡ï¼šå£¬ç™¸è¾›ï¼ˆé¡ºæ¬¡å‡ºç°ï¼‰
        """
        year_gan = pillars['year'][0]
        month_gan = pillars['month'][0]
        day_gan = pillars['day'][0]
        
        # å¤©ä¸Šä¸‰å¥‡ï¼šç”²æˆŠåºš
        if (year_gan == 'ç”²' and month_gan == 'æˆŠ' and day_gan == 'åºš') or \
           (year_gan == 'ç”²' and month_gan == 'åºš' and day_gan == 'æˆŠ') or \
           (month_gan == 'ç”²' and day_gan == 'æˆŠ') or (month_gan == 'ç”²' and day_gan == 'åºš') or \
           (year_gan == 'ç”²' and month_gan == 'æˆŠ') or (year_gan == 'ç”²' and day_gan == 'åºš') or \
           (year_gan == 'æˆŠ' and month_gan == 'åºš') or (year_gan == 'æˆŠ' and day_gan == 'ç”²') or \
           (month_gan == 'æˆŠ' and day_gan == 'ç”²') or (month_gan == 'æˆŠ' and day_gan == 'åºš'):
            # æ£€æŸ¥æ˜¯å¦å®Œæ•´ä¸‰å¥‡ï¼ˆä¸‰ä¸ªéƒ½å‡ºç°ï¼‰
            if 'ç”²' in [year_gan, month_gan, day_gan] and 'æˆŠ' in [year_gan, month_gan, day_gan] and 'åºš' in [year_gan, month_gan, day_gan]:
                return {'type': 'å¤©ä¸Šä¸‰å¥‡', 'position': 'year'}
        
        # åœ°ä¸‹ä¸‰å¥‡ï¼šä¹™ä¸™ä¸
        if (year_gan == 'ä¹™' and month_gan == 'ä¸™' and day_gan == 'ä¸') or \
           (year_gan == 'ä¹™' and month_gan == 'ä¸' and day_gan == 'ä¸™') or \
           (month_gan == 'ä¹™' and day_gan == 'ä¸™') or (month_gan == 'ä¹™' and day_gan == 'ä¸') or \
           (year_gan == 'ä¹™' and month_gan == 'ä¸™') or (year_gan == 'ä¹™' and day_gan == 'ä¸') or \
           (year_gan == 'ä¸™' and month_gan == 'ä¸') or (year_gan == 'ä¸™' and day_gan == 'ä¹™') or \
           (month_gan == 'ä¸™' and day_gan == 'ä¹™') or (month_gan == 'ä¸™' and day_gan == 'ä¸'):
            # æ£€æŸ¥æ˜¯å¦å®Œæ•´ä¸‰å¥‡ï¼ˆä¸‰ä¸ªéƒ½å‡ºç°ï¼‰
            if 'ä¹™' in [year_gan, month_gan, day_gan] and 'ä¸™' in [year_gan, month_gan, day_gan] and 'ä¸' in [year_gan, month_gan, day_gan]:
                return {'type': 'åœ°ä¸‹ä¸‰å¥‡', 'position': 'year'}
        
        # äººä¸­ä¸‰å¥‡ï¼šå£¬ç™¸è¾›
        if (year_gan == 'å£¬' and month_gan == 'ç™¸' and day_gan == 'è¾›') or \
           (year_gan == 'å£¬' and month_gan == 'è¾›' and day_gan == 'ç™¸') or \
           (month_gan == 'å£¬' and day_gan == 'ç™¸') or (month_gan == 'å£¬' and day_gan == 'è¾›') or \
           (year_gan == 'å£¬' and month_gan == 'ç™¸') or (year_gan == 'å£¬' and day_gan == 'è¾›') or \
           (year_gan == 'ç™¸' and month_gan == 'è¾›') or (year_gan == 'ç™¸' and day_gan == 'å£¬') or \
           (month_gan == 'ç™¸' and day_gan == 'å£¬') or (month_gan == 'ç™¸' and day_gan == 'è¾›'):
            # æ£€æŸ¥æ˜¯å¦å®Œæ•´ä¸‰å¥‡ï¼ˆä¸‰ä¸ªéƒ½å‡ºç°ï¼‰
            if 'å£¬' in [year_gan, month_gan, day_gan] and 'ç™¸' in [year_gan, month_gan, day_gan] and 'è¾›' in [year_gan, month_gan, day_gan]:
                return {'type': 'äººä¸­ä¸‰å¥‡', 'position': 'year'}
        
        return None
    
    def _tianguan_guiren(self, day_master: str) -> str:
        """
        å¤©å®˜è´µäººæŸ¥æ³• - åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç†è®º
        ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å¤©å®˜è€…ï¼Œå¤©ä¹‹æ‰€æˆä¹Ÿã€‚"
        
        æŸ¥æ³•ï¼šç”²è§æœªï¼Œä¹™è§ç”³ï¼Œä¸™è§é…‰ï¼Œä¸è§æˆŒï¼ŒæˆŠè§äº¥ï¼Œå·±è§å­ï¼Œåºšè§ä¸‘ï¼Œè¾›è§å¯…ï¼Œå£¬è§å¯ï¼Œç™¸è§è¾°
        """
        tianguan_map = {
            'ç”²': 'æœª', 'ä¹™': 'ç”³', 'ä¸™': 'é…‰', 'ä¸': 'æˆŒ', 'æˆŠ': 'äº¥',
            'å·±': 'å­', 'åºš': 'ä¸‘', 'è¾›': 'å¯…', 'å£¬': 'å¯', 'ç™¸': 'è¾°'
        }
        return tianguan_map.get(day_master, '')
    
    def _tianshe(self, day_master: str, day_branch: str, month_branch: str) -> bool:
        """
        å¤©èµ¦æŸ¥æ³• - åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç†è®º
        ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å¤©èµ¦è€…ï¼Œå¤©ä¹‹æ‰€èµ¦ä¹Ÿã€‚"
        
        æŸ¥æ³•ï¼šæ˜¥ï¼ˆå¯…å¯è¾°ï¼‰æˆŠå¯…æ—¥ï¼Œå¤ï¼ˆå·³åˆæœªï¼‰ç”²åˆæ—¥ï¼Œç§‹ï¼ˆç”³é…‰æˆŒï¼‰æˆŠç”³æ—¥ï¼Œå†¬ï¼ˆäº¥å­ä¸‘ï¼‰ç”²å­æ—¥
        """
        # æ˜¥å­£ï¼ˆå¯…å¯è¾°ï¼‰ï¼šæˆŠå¯…æ—¥
        if month_branch in {'å¯…', 'å¯', 'è¾°'}:
            return day_master == 'æˆŠ' and day_branch == 'å¯…'
        # å¤å­£ï¼ˆå·³åˆæœªï¼‰ï¼šç”²åˆæ—¥
        elif month_branch in {'å·³', 'åˆ', 'æœª'}:
            return day_master == 'ç”²' and day_branch == 'åˆ'
        # ç§‹å­£ï¼ˆç”³é…‰æˆŒï¼‰ï¼šæˆŠç”³æ—¥
        elif month_branch in {'ç”³', 'é…‰', 'æˆŒ'}:
            return day_master == 'æˆŠ' and day_branch == 'ç”³'
        # å†¬å­£ï¼ˆäº¥å­ä¸‘ï¼‰ï¼šç”²å­æ—¥
        elif month_branch in {'äº¥', 'å­', 'ä¸‘'}:
            return day_master == 'ç”²' and day_branch == 'å­'
        return False
    
    def _sanxing(self, pillars: Dict[str, Tuple[str, str]]) -> List[Dict[str, Any]]:
        """
        ğŸ”¥ æ–°å¢ï¼šä¸‰åˆ‘åˆ†æ - åŸºäºã€Šä¸‰å‘½é€šä¼šÂ·è®ºä¸‰åˆ‘ã€‹
        
        ã€Šä¸‰å‘½é€šä¼šã€‹ä¸‰åˆ‘ç†è®ºï¼š
        1. æ— æ©ä¹‹åˆ‘ï¼šå¯…åˆ‘å·³ï¼Œå·³åˆ‘ç”³ï¼Œç”³åˆ‘å¯…ï¼ˆä¸‰è€…äº’ç›¸åˆ‘ï¼‰
        2. æ— ç¤¼ä¹‹åˆ‘ï¼šå­åˆ‘å¯ï¼Œå¯åˆ‘å­
        3. æƒåŠ¿ä¹‹åˆ‘ï¼šä¸‘åˆ‘æˆŒï¼ŒæˆŒåˆ‘æœªï¼Œæœªåˆ‘ä¸‘ï¼ˆä¸‰è€…äº’ç›¸åˆ‘ï¼‰
        4. è‡ªåˆ‘ï¼šè¾°åˆ‘è¾°ï¼Œåˆåˆ‘åˆï¼Œé…‰åˆ‘é…‰ï¼Œäº¥åˆ‘äº¥
        """
        result = []
        all_branches = [pillars[pos][1] for pos in ['year', 'month', 'day', 'hour']]
        
        # 1. æ— æ©ä¹‹åˆ‘ï¼šå¯…å·³ç”³ï¼ˆä¸‰è€…äº’ç›¸åˆ‘ï¼‰
        # âœ… ä¿®å¤ï¼šåªæ·»åŠ ä¸€æ¬¡ï¼Œè®°å½•æ‰€æœ‰ç›¸å…³ä½ç½®
        yinsi_shen = {'å¯…', 'å·³', 'ç”³'}
        yinsi_count = sum(1 for b in all_branches if b in yinsi_shen)
        if yinsi_count >= 2:  # è‡³å°‘æœ‰ä¸¤ä¸ª
            yinsi_positions = []
            for pillar, (gan, zhi) in pillars.items():
                if zhi in yinsi_shen:
                    yinsi_positions.append(pillar)
            
            if yinsi_positions:
                result.append({
                    'name': 'æ— æ©ä¹‹åˆ‘',
                    'level': 'å¤§å‡¶' if yinsi_count >= 3 else 'ä¸­å‡¶',
                    'position': 'ã€'.join(yinsi_positions) if len(yinsi_positions) > 1 else yinsi_positions[0],
                    'description': 'æ— æ©ä¹‹åˆ‘ä¸»æƒ¨è™å¥½æ€ï¼Œå¥½ç«‹åŠŸä¸šï¼›å…¥è´±æ ¼åˆ™è¨€è¡Œä¹–è¶Šï¼Œè´ªåæ— åŒã€‚éœ€æ³¨æ„äººé™…å…³ç³»ï¼Œé¿å…å¿˜æ©å¤±ä¹‰ã€‚',
                    'weight': 12 if yinsi_count >= 3 else 10
                })
        
        # 2. æ— ç¤¼ä¹‹åˆ‘ï¼šå­åˆ‘å¯ï¼Œå¯åˆ‘å­
        # âœ… ä¿®å¤ï¼šåªæ·»åŠ ä¸€æ¬¡ï¼Œè®°å½•æ‰€æœ‰ç›¸å…³ä½ç½®
        if 'å­' in all_branches and 'å¯' in all_branches:
            wuli_positions = []
            for pillar, (gan, zhi) in pillars.items():
                if zhi in {'å­', 'å¯'}:
                    wuli_positions.append(pillar)
            
            if wuli_positions:
                result.append({
                    'name': 'æ— ç¤¼ä¹‹åˆ‘',
                    'level': 'ä¸­å‡¶',
                    'position': 'ã€'.join(wuli_positions) if len(wuli_positions) > 1 else wuli_positions[0],
                    'description': 'æ— ç¤¼ä¹‹åˆ‘ä¸»ä¸åˆ©è¿‘ä¾ï¼›ä½å±…ä¸ä¹…ï¼›å…¥è´±æ ¼åˆ™æ‚–å‡¶æš´ï¼Œå¤šæ‹›åˆ‘ç¥¸ã€‚éœ€æ³¨æ„è¨€è¡Œè§„èŒƒï¼Œé¿å…æ— ç¤¼è¡Œä¸ºã€‚',
                    'weight': 10
                })
        
        # 3. æƒåŠ¿ä¹‹åˆ‘ï¼šä¸‘æˆŒæœªï¼ˆä¸‰è€…äº’ç›¸åˆ‘ï¼‰
        # âœ… ä¿®å¤ï¼šåªæ·»åŠ ä¸€æ¬¡ï¼Œè®°å½•æ‰€æœ‰ç›¸å…³ä½ç½®
        chou_xu_wei = {'ä¸‘', 'æˆŒ', 'æœª'}
        chou_xu_wei_count = sum(1 for b in all_branches if b in chou_xu_wei)
        if chou_xu_wei_count >= 2:
            chou_xu_wei_positions = []
            for pillar, (gan, zhi) in pillars.items():
                if zhi in chou_xu_wei:
                    chou_xu_wei_positions.append(pillar)
            
            if chou_xu_wei_positions:
                result.append({
                    'name': 'æƒåŠ¿ä¹‹åˆ‘',
                    'level': 'å¤§å‡¶' if chou_xu_wei_count >= 3 else 'ä¸­å‡¶',
                    'position': 'ã€'.join(chou_xu_wei_positions) if len(chou_xu_wei_positions) > 1 else chou_xu_wei_positions[0],
                    'description': 'æƒåŠ¿ä¹‹åˆ‘ä¸»å…¥è´±æ ¼åˆ™å¤šçŠ¯åˆ‘ä¹¦æš—æ˜§ä¹‹ç¾ã€‚éœ€é¿å…æƒå¼ºå‡Œå¼±ï¼Œä¿æŒè°¦é€Šã€‚',
                    'weight': 11 if chou_xu_wei_count >= 3 else 9
                })
        
        # 4. è‡ªåˆ‘ï¼šè¾°è¾°ã€åˆåˆã€é…‰é…‰ã€äº¥äº¥
        zixing_map = {'è¾°', 'åˆ', 'é…‰', 'äº¥'}
        zixing_count = {}
        for b in all_branches:
            if b in zixing_map:
                zixing_count[b] = zixing_count.get(b, 0) + 1
        
        for zhi, count in zixing_count.items():
            if count >= 2:  # åŒä¸€åœ°æ”¯å‡ºç°2æ¬¡ä»¥ä¸Šä¸ºè‡ªåˆ‘
                for pillar, (gan, z) in pillars.items():
                    if z == zhi:
                        result.append({
                            'name': 'è‡ªåˆ‘',
                            'level': 'å¤§å‡¶',
                            'position': pillar,
                            'description': f'è‡ªåˆ‘ä¸»è‡ªæˆ‘åˆ‘ä¼¤ã€‚{zhi}è‡ªåˆ‘ï¼Œéœ€æ³¨æ„è‡ªæˆ‘è°ƒèŠ‚ï¼Œé¿å…æç«¯è¡Œä¸ºã€‚',
                            'weight': 11
                        })
                        break
        
        return result
    
    def _guanfu_shitou(self, pillars: Dict[str, Tuple[str, str]]) -> Dict[str, Any] | None:
        """
        ğŸ”¥ æ–°å¢ï¼šå®˜ç¬¦ç…åˆ†æ - åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹
        
        ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å®˜ç¬¦ç…ã€‚å–å¤ªå²å‰äº”è¾°ï¼Œæ˜¯æ—¥æ—¶é‡ä¹‹ã€‚å¹³ç”Ÿå¤šå®˜ç¾ï¼Œæ›´å¹¶ç¾Šåˆƒï¼Œä¹ƒåˆ‘å¾’ä¹‹å‘½ã€‚"
        
        æŸ¥æ³•ï¼šå¤ªå²å‰äº”è¾°ï¼ˆä»¥å¹´æ”¯ä¸ºå‡†ï¼‰
        - å­å¹´ï¼šå‰äº”è¾°ä¸ºå·³ï¼ˆå­â†’ä¸‘â†’å¯…â†’å¯â†’è¾°â†’å·³ï¼‰
        - é€šç”¨ï¼šå¹´æ”¯å‰æ¨5ä½
        """
        year_branch = pillars['year'][1]
        # åœ°æ”¯é¡ºåºï¼šå­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥
        dizhi_order = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥']
        
        year_index = dizhi_order.index(year_branch)
        guanfu_index = (year_index + 5) % 12
        guanfu_branch = dizhi_order[guanfu_index]
        
        # æ£€æŸ¥æ—¥æ—¶æ˜¯å¦è§å®˜ç¬¦
        for pillar in ['day', 'hour']:
            if pillars[pillar][1] == guanfu_branch:
                return {
                    'position': pillar,
                    'branch': guanfu_branch
                }
        
        return None
    
    def _goujiao_shitou(self, bazi_data: BaziData) -> List[Dict[str, Any]]:
        """
        ğŸ”¥ æ–°å¢ï¼šå‹¾ç»ç…åˆ†æ - åŸºäºã€Šä¸‰å‘½é€šä¼šÂ·è®ºå‹¾ç»ã€‹
        
        ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å‹¾è€…ï¼Œç‰µè¿ä¹‹ä¹‰ï¼›ç»è€…ï¼Œç¾ç»Šä¹‹å"
        "é˜³ç”·é˜´å¥³ï¼Œå‘½å‰ä¸‰è¾°ä¸ºå‹¾ï¼›å‘½åä¸‰è¾°ä¸ºç»ï¼›é˜´ç”·é˜³å¥³ï¼Œå‘½å‰ä¸‰è¾°ä¸ºç»ï¼Œå‘½åä¸‰è¾°ä¸ºå‹¾ã€‚"
        "ç…è‹¥å…‹èº«ï¼Œä¸»éå‘½è€Œç»ˆï¼›å°äººé€¢ä¹‹ï¼Œéæ¨ªç¾ç¥¸ï¼›è¡Œå¹´è‡³æ­¤ï¼Œäº¦ä¸»å£èˆŒåˆ‘ç‹±ç­‰äº‹ã€‚"
        
        æŸ¥æ³•ï¼š
        - é˜³ç”·é˜´å¥³ï¼šå‘½å‰ä¸‰è¾°ä¸ºå‹¾ï¼Œå‘½åä¸‰è¾°ä¸ºç»
        - é˜´ç”·é˜³å¥³ï¼šå‘½å‰ä¸‰è¾°ä¸ºç»ï¼Œå‘½åä¸‰è¾°ä¸ºå‹¾
        """
        result = []
        pillars = bazi_data.get_pillars()
        year_branch = pillars['year'][1]
        gender = bazi_data.gender  # ğŸ”¥ ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨genderå±æ€§ï¼Œä¸ä½¿ç”¨get_gender()æ–¹æ³•
        
        # åœ°æ”¯é¡ºåº
        dizhi_order = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥']
        year_index = dizhi_order.index(year_branch)
        
        # åˆ¤æ–­é˜´é˜³ï¼ˆå¹´å¹²é˜´é˜³ï¼‰
        year_gan = pillars['year'][0]
        yang_gan = {'ç”²', 'ä¸™', 'æˆŠ', 'åºš', 'å£¬'}
        is_yang_gan = year_gan in yang_gan
        
        # åˆ¤æ–­é˜´é˜³æ€§åˆ«ç»„åˆ
        # é˜³ç”·é˜´å¥³ï¼šå‘½å‰ä¸‰è¾°ä¸ºå‹¾ï¼Œå‘½åä¸‰è¾°ä¸ºç»
        # é˜´ç”·é˜³å¥³ï¼šå‘½å‰ä¸‰è¾°ä¸ºç»ï¼Œå‘½åä¸‰è¾°ä¸ºå‹¾
        if (is_yang_gan and gender == 'ç”·') or (not is_yang_gan and gender == 'å¥³'):
            # é˜³ç”·é˜´å¥³
            gou_index = (year_index + 3) % 12
            jiao_index = (year_index - 3) % 12
            gou_branch = dizhi_order[gou_index]
            jiao_branch = dizhi_order[jiao_index]
        else:
            # é˜´ç”·é˜³å¥³
            jiao_index = (year_index + 3) % 12
            gou_index = (year_index - 3) % 12
            gou_branch = dizhi_order[gou_index]
            jiao_branch = dizhi_order[jiao_index]
        
        # âœ… ä¿®å¤ï¼šæ£€æŸ¥å››æŸ±ä¸­æ˜¯å¦æœ‰å‹¾ç»ï¼Œæ¯ä¸ªç¥ç…åªæ·»åŠ ä¸€æ¬¡
        gou_positions = []
        jiao_positions = []
        for pillar, (gan, zhi) in pillars.items():
            if zhi == gou_branch:
                gou_positions.append(pillar)
            if zhi == jiao_branch:
                jiao_positions.append(pillar)
        
        # æ”¶é›†å®Œæ‰€æœ‰ä½ç½®åå†æ·»åŠ ï¼Œé¿å…é‡å¤
        if gou_positions:
            result.append({
                'name': 'å‹¾ç…',
                'level': 'ä¸­å‡¶',
                'position': 'ã€'.join(gou_positions) if len(gou_positions) > 1 else gou_positions[0],
                'description': 'å‹¾ç…ä¸»ç‰µè¿ç¾ç»Šï¼Œä¸»éå‘½è€Œç»ˆï¼›å°äººé€¢ä¹‹ï¼Œéæ¨ªç¾ç¥¸ï¼›è¡Œå¹´è‡³æ­¤ï¼Œäº¦ä¸»å£èˆŒåˆ‘ç‹±ç­‰äº‹ã€‚',
                'weight': 9
            })
        if jiao_positions:
            result.append({
                'name': 'ç»ç…',
                'level': 'ä¸­å‡¶',
                'position': 'ã€'.join(jiao_positions) if len(jiao_positions) > 1 else jiao_positions[0],
                'description': 'ç»ç…ä¸»ç‰µè¿ç¾ç»Šï¼Œä¸»éå‘½è€Œç»ˆï¼›å°äººé€¢ä¹‹ï¼Œéæ¨ªç¾ç¥¸ï¼›è¡Œå¹´è‡³æ­¤ï¼Œäº¦ä¸»å£èˆŒåˆ‘ç‹±ç­‰äº‹ã€‚',
                'weight': 9
            })
        
        return result
    
    def _zhaisha(self, pillars: Dict[str, Tuple[str, str]]) -> Dict[str, Any] | None:
        """
        âœ… ç»Ÿä¸€ï¼šç¾ç…åˆ†æ - åŸºäºã€Šä¸‰å‘½é€šä¼šÂ·è®ºç¾ç…ã€‹ä¸‰åˆå±€å†²ç ´å°†æ˜Ÿæ³•
        
        ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"ç¾ç…è€…ï¼Œå…¶æ€§å‹‡çŒ›ï¼Œå¸¸å±…åŠ«ç…ä¹‹å‰ï¼Œå†²ç ´å°†æ˜Ÿï¼Œè°“ä¹‹ç¾ç…ã€‚"
        "æ­¤ç…ä¸»è¡€å…‰æ¨ªæ­»ã€‚åœ¨æ°´ç«ï¼Œé˜²ç„šæººï¼Œé‡‘æœ¨æ–åˆƒï¼ŒåœŸå è½ï¼Œç˜Ÿç–«å…‹èº«ï¼Œå¤§å‡¶ã€‚"
        
        âœ… ä¸‰åˆæ³•æŸ¥æ³•ï¼ˆåŸºäºä¸‰åˆå±€å°†æ˜Ÿå¯¹å†²ï¼‰ï¼š
        - ç”³å­è¾°å°†æ˜Ÿåœ¨å­ï¼Œåˆå´å»å†²å­ï¼ˆåˆä¸ºç¾ç…ï¼‰âœ… ä¸‰åˆæ³•
        - å¯…åˆæˆŒå°†æ˜Ÿåœ¨åˆï¼Œå­å´å»å†²ï¼ˆå­ä¸ºç¾ç…ï¼‰âœ… ä¸‰åˆæ³•
        - å·³é…‰ä¸‘å°†æ˜Ÿåœ¨é…‰ï¼Œå¯å´å»å†²ï¼ˆå¯ä¸ºç¾ç…ï¼‰âœ… ä¸‰åˆæ³•
        - äº¥å¯æœªå°†æ˜Ÿåœ¨å¯ï¼Œé…‰å´å»å†²ï¼ˆé…‰ä¸ºç¾ç…ï¼‰âœ… ä¸‰åˆæ³•
        
        ç†è®ºä¾æ®ï¼šä¸‰åˆå±€ä¸­ç¥ä¸ºå°†æ˜Ÿï¼Œå…¶å¯¹å†²åœ°æ”¯ä¸ºç¾ç…
        """
        all_branches = [pillars[pos][1] for pos in ['year', 'month', 'day', 'hour']]
        
        # ä¸‰åˆå±€å¯¹åº”çš„å°†æ˜Ÿå’Œç¾ç…
        # ç”³å­è¾°ï¼šå°†æ˜Ÿåœ¨å­ï¼Œç¾ç…åœ¨åˆï¼ˆåˆå†²å­ï¼‰
        # å¯…åˆæˆŒï¼šå°†æ˜Ÿåœ¨åˆï¼Œç¾ç…åœ¨å­ï¼ˆå­å†²åˆï¼‰
        # å·³é…‰ä¸‘ï¼šå°†æ˜Ÿåœ¨é…‰ï¼Œç¾ç…åœ¨å¯ï¼ˆå¯å†²é…‰ï¼‰
        # äº¥å¯æœªï¼šå°†æ˜Ÿåœ¨å¯ï¼Œç¾ç…åœ¨é…‰ï¼ˆé…‰å†²å¯ï¼‰
        sanhe_zhaisha_map = {
            ('ç”³', 'å­', 'è¾°'): {'å°†æ˜Ÿ': 'å­', 'ç¾ç…': 'åˆ'},
            ('å¯…', 'åˆ', 'æˆŒ'): {'å°†æ˜Ÿ': 'åˆ', 'ç¾ç…': 'å­'},
            ('å·³', 'é…‰', 'ä¸‘'): {'å°†æ˜Ÿ': 'é…‰', 'ç¾ç…': 'å¯'},
            ('äº¥', 'å¯', 'æœª'): {'å°†æ˜Ÿ': 'å¯', 'ç¾ç…': 'é…‰'},
        }
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å®Œæ•´ä¸‰åˆå±€
        for sanhe_branches, zhaisha_info in sanhe_zhaisha_map.items():
            sanhe_count = sum(1 for b in sanhe_branches if b in all_branches)
            if sanhe_count >= 3:  # å®Œæ•´ä¸‰åˆå±€
                zhaisha_branch = zhaisha_info['ç¾ç…']
                # æ£€æŸ¥å››æŸ±ä¸­æ˜¯å¦æœ‰ç¾ç…
                for pillar, (gan, zhi) in pillars.items():
                    if zhi == zhaisha_branch:
                        # åˆ¤æ–­äº”è¡Œå±æ€§
                        wuxing_map = {
                            'åˆ': 'ç«', 'å­': 'æ°´',
                            'å¯': 'æœ¨', 'é…‰': 'é‡‘'
                        }
                        wuxing = wuxing_map.get(zhaisha_branch, '')
                        wuxing_note = {
                            'ç«': 'åœ¨æ°´ç«ï¼Œé˜²ç„šæºº',
                            'æ°´': 'åœ¨æ°´ç«ï¼Œé˜²ç„šæºº',
                            'é‡‘': 'é‡‘æœ¨æ–åˆƒ',
                            'æœ¨': 'é‡‘æœ¨æ–åˆƒ',
                            'åœŸ': 'åœŸå è½ï¼Œç˜Ÿç–«å…‹èº«'
                        }.get(wuxing, '')
                        
                        return {
                            'position': pillar,
                            'branch': zhaisha_branch,
                            'wuxing_note': wuxing_note
                        }
        
        return None
    
    def _liue(self, pillars: Dict[str, Tuple[str, str]]) -> Dict[str, Any] | None:
        """
        âœ… ç»Ÿä¸€ï¼šå…­å„åˆ†æ - åŸºäºã€Šä¸‰å‘½é€šä¼šÂ·è®ºå…­å„ã€‹ä¸‰åˆå±€æ­»åœ°æ³•
        
        ã€Šä¸‰å‘½é€šä¼šã€‹ï¼š"å„è€…ï¼Œé­ä¹éš¾è€…ä¹Ÿï¼Œå¸¸å±…é©¬å‰ä¸€è¾°ï¼ŒåŠ«åäºŒè¾°ï¼Œæ­»è€Œä¸ç”Ÿè°“ä¹‹å„ã€‚"
        "å…­å„è€…ï¼Œä¸‰åˆå±€æ­»åœ°ä¹Ÿ"
        "è‹¥æœ‰æ•‘æŠ¤ï¼Œæœ‰æ‰¶æŒï¼Œé€¢ç”Ÿæ—ºå…¼è´µæ°”ç›¸åŠ©ï¼Œåˆ™å‰ï¼Œç©¶ç«Ÿä¸€ç”Ÿè¹‡æ»ã€‚"
        
        âœ… ä¸‰åˆæ³•æŸ¥æ³•ï¼ˆåŸºäºäº”è¡ŒåäºŒé•¿ç”Ÿæ­»åœ°ï¼‰ï¼š
        - ç”³å­è¾°æ°´å±€ï¼šæ°´æ­»åœ¨å¯ï¼ˆå…­å„åœ¨å¯ï¼‰âœ… ä¸‰åˆæ³•
        - å¯…åˆæˆŒç«å±€ï¼šç«æ­»åœ¨é…‰ï¼ˆå…­å„åœ¨é…‰ï¼‰âœ… ä¸‰åˆæ³•
        - äº¥å¯æœªæœ¨å±€ï¼šæœ¨æ­»åœ¨åˆï¼ˆå…­å„åœ¨åˆï¼‰âœ… ä¸‰åˆæ³•
        - å·³é…‰ä¸‘é‡‘å±€ï¼šé‡‘æ­»åœ¨å­ï¼ˆå…­å„åœ¨å­ï¼‰âœ… ä¸‰åˆæ³•
        
        ç†è®ºä¾æ®ï¼šäº”è¡ŒåäºŒé•¿ç”Ÿè¡¨
        - æ°´ï¼šé•¿ç”Ÿç”³ï¼Œæ­»åœ°å¯
        - ç«ï¼šé•¿ç”Ÿå¯…ï¼Œæ­»åœ°é…‰
        - æœ¨ï¼šé•¿ç”Ÿäº¥ï¼Œæ­»åœ°åˆ
        - é‡‘ï¼šé•¿ç”Ÿå·³ï¼Œæ­»åœ°å­
        """
        all_branches = [pillars[pos][1] for pos in ['year', 'month', 'day', 'hour']]
        
        # âœ… ä¸‰åˆå±€å¯¹åº”çš„å…­å„ä½ç½®ï¼ˆæ­»åœ°ï¼‰- åŸºäºäº”è¡ŒåäºŒé•¿ç”Ÿç†è®º
        sanhe_liue_map = {
            ('ç”³', 'å­', 'è¾°'): 'å¯',  # æ°´æ­»åœ¨å¯ï¼ˆä¸‰åˆå±€æ­»åœ°ï¼‰âœ…
            ('å¯…', 'åˆ', 'æˆŒ'): 'é…‰',  # ç«æ­»åœ¨é…‰ï¼ˆä¸‰åˆå±€æ­»åœ°ï¼‰âœ…
            ('äº¥', 'å¯', 'æœª'): 'åˆ',  # æœ¨æ­»åœ¨åˆï¼ˆä¸‰åˆå±€æ­»åœ°ï¼‰âœ…
            ('å·³', 'é…‰', 'ä¸‘'): 'å­'   # é‡‘æ­»åœ¨å­ï¼ˆä¸‰åˆå±€æ­»åœ°ï¼‰âœ…
        }
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å®Œæ•´ä¸‰åˆå±€
        for sanhe_branches, liue_branch in sanhe_liue_map.items():
            sanhe_count = sum(1 for b in sanhe_branches if b in all_branches)
            if sanhe_count >= 3:  # å®Œæ•´ä¸‰åˆå±€
                # æ£€æŸ¥å››æŸ±ä¸­æ˜¯å¦æœ‰å…­å„
                for pillar, (gan, zhi) in pillars.items():
                    if zhi == liue_branch:
                        return {
                            'position': pillar,
                            'branch': liue_branch
                        }
        
        return None

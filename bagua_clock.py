 #!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å…«å¦æ—¶é’Ÿ V2.0.0
é›†æˆä¼ ç»Ÿå…«å­—ã€é£æ°´ã€æ‹©æ—¥ã€èµ·åç­‰åŠŸèƒ½çš„ç»¼åˆå‘½ç†åˆ†æç³»ç»Ÿ
ä¸»è¦åŠŸèƒ½ï¼š
- å…«å­—ç®—å‘½ï¼šç²¾ç¡®çš„å†œå†è½¬æ¢å’Œå…«å­—è®¡ç®—
- ç¥ç…åˆ†æï¼šä¼ ç»Ÿç¥ç…æŸ¥æ³•å’Œç»„åˆåˆ†æ
- è´¢è¿åˆ†æï¼šè´¢æ˜Ÿè¯†åˆ«å’Œå¤§è¿è´¢è¿åˆ†æ
- å©šå§»åˆ†æï¼šé…å¶æ˜Ÿåˆ†æå’Œå©šå§»è´¨é‡è¯„ä¼°
- èŒä¸šåˆ†æï¼šåŸºäºåç¥çš„èŒä¸šå»ºè®®
- é£æ°´åˆ†æï¼šå…«å®…å’Œç„ç©ºé£æ˜Ÿåˆ†æ
- æ‹©æ—¥åˆ†æï¼šå»ºé™¤åäºŒç¥å’Œé»„é“é»‘é“æ‹©æ—¥
- èµ·ååˆ†æï¼šäº”è¡Œå’Œç¬”ç”»èµ·åå»ºè®®
æŠ€æœ¯ç‰¹ç‚¹ï¼š
- ä½¿ç”¨lunar_pythonåº“ç¡®ä¿å†œå†è½¬æ¢å‡†ç¡®æ€§
- ç»Ÿä¸€çš„ç®—æ³•åŸºç¡€ï¼Œé¿å…å¤šå¥—ç®—æ³•æ··ä¹±
- åŸºäºä¼ ç»Ÿå‘½ç†å­¦ç†è®ºï¼Œåˆ†æç»“æœä¸“ä¸šå¯é 
- ç°ä»£åŒ–çš„PyQt5ç•Œé¢ï¼Œæ“ä½œç®€å•ç›´è§‚
ç‰ˆæƒæ‰€æœ‰ Â© 2025 æ¹–å—å…¨èˆªä¿¡æ¯é€šä¿¡æœ‰é™å…¬å¸
"""
import sys
import os
import math
import json
import requests
from datetime import datetime
from typing import Optional, Dict, Any, Tuple, List
from PyQt5 import QtCore
from PyQt5.QtWidgets import *
from PyQt5.QtCore import *
from PyQt5.QtGui import *
from PyQt5.QtCore import Qt

# PyQt5 å¯¼å…¥
try:
    from PyQt5.QtWidgets import QApplication
    from PyQt5.QtCore import Qt
    PYQT5_AVAILABLE = True
except ImportError:
    PYQT5_AVAILABLE = False
    print("[WARNING] PyQt5 æœªå®‰è£…ï¼ŒGUIåŠŸèƒ½ä¸å¯ç”¨")

# Pygame å¯¼å…¥ï¼ˆå¯é€‰ï¼‰
try:
    import pygame
    PYGAME_AVAILABLE = True
except ImportError:
    PYGAME_AVAILABLE = False
    print("[WARNING] pygame æœªå®‰è£…ï¼ŒéŸ³æ•ˆåŠŸèƒ½ä¸å¯ç”¨")

def _is_pygame_ready() -> bool:
    """æ£€æŸ¥ pygame æ˜¯å¦å¯ç”¨ä¸”å·²æˆåŠŸå¯¼å…¥ã€‚"""
    return PYGAME_AVAILABLE and 'pygame' in globals() and pygame is not None
# å¯¼å…¥å†œå†è½¬æ¢åº“ï¼Œç¡®ä¿å…«å­—è®¡ç®—å‡†ç¡®æ€§
# ğŸ”¥ æ–°å¢ï¼šå¯¼å…¥ sxtwl æœ¬åœ°å…«å­—è®¡ç®—æ¨¡å—
try:
    from sxtwl_adapter import compute_bazi_json, Rules, Location
    SXTWL_AVAILABLE = True
    print("[OK] sxtwl æœ¬åœ°å…«å­—è®¡ç®—æ¨¡å—å·²åŠ è½½")
except ImportError as e:
    SXTWL_AVAILABLE = False
    print(f"[WARNING] sxtwl æ¨¡å—æœªæ‰¾åˆ°: {e}")

# æœ¬åœ°å‘½ç†åˆ†æç³»ç»Ÿ - ç»Ÿä¸€ä½¿ç”¨å®Œæ•´ç‰ˆ
try:
    from local_mingli_analyzer_unified import UnifiedMingliAnalyzer
    LOCAL_ANALYZER_AVAILABLE = True
    print("[OK] ç»Ÿä¸€ç‰ˆæœ¬åœ°å‘½ç†åˆ†æç³»ç»Ÿå·²åŠ è½½")
except ImportError as e:
    LOCAL_ANALYZER_AVAILABLE = False
    print(f"[WARNING] ç»Ÿä¸€ç‰ˆå‘½ç†åˆ†æç³»ç»Ÿæœªæ‰¾åˆ°: {e}")

# ğŸ”¥ ä¿®å¤ï¼šåªå¯¼å…¥å·¥å…·å‡½æ•°ï¼Œä¸å¯¼å…¥å¤‡ç”¨åˆ†æå™¨
try:
    from classic_analyzer.common import compute_wuxing_distribution, evaluate_day_master_strength
    CLASSIC_ANALYZER_AVAILABLE = True
    print("[OK] ç»å…¸å‘½ç†åˆ†æå™¨å·¥å…·å‡½æ•° (classic_analyzer.common) å·²åŠ è½½")
except ImportError as e:
    CLASSIC_ANALYZER_AVAILABLE = False
    print(f"[WARNING] ç»å…¸å‘½ç†åˆ†æå™¨å·¥å…·å‡½æ•°æœªæ‰¾åˆ°: {e}")

# ğŸ”¥ æ–°å¢ï¼šå¯¼å…¥å…­ä¹¦ç»Ÿä¸€çŸ¥è¯†åº“åˆ†æå™¨ï¼ˆå¯é€‰ï¼‰
try:
    from chinese_metaphysics_library import UnifiedMetaphysicsAnalyzer
    from chinese_metaphysics_library.core.data_structures import BaziData, AnalysisConfig
    CML_UNIFIED_AVAILABLE = True
    print("[OK] å…­ä¹¦ç»Ÿä¸€çŸ¥è¯†åº“åˆ†æå™¨å·²åŠ è½½")
except Exception as e:
    CML_UNIFIED_AVAILABLE = False
    print(f"[WARNING] å…­ä¹¦ç»Ÿä¸€çŸ¥è¯†åº“åˆ†æå™¨æœªæ‰¾åˆ°: {e}")

# # ğŸ”¥ æ–°å¢ï¼šCSSè­¦å‘Šè¿‡æ»¤å™¨ï¼Œå‡å°‘æ— å…³çš„Unknown propertyè­¦å‘Š
# class CSSWarningFilter(logging.Filter):
#     """è¿‡æ»¤CSSç›¸å…³çš„æ— å…³è­¦å‘Š"""
#     def filter(self, record):
#         message = record.getMessage()
#         # è¿‡æ»¤æ‰å¸¸è§çš„Qt CSSè­¦å‘Š
#         if any(warning in message for warning in [
#             "Unknown property box-shadow",
#             "Unknown property transform",
#             "Unknown property transition",
#             "Unknown property filter",
#             "Unknown property backdrop-filter",
#             "Unknown property box-decoration-break"
#         ]):
#             return False
#         return True
#
# # è®¾ç½®æ—¥å¿—è¿‡æ»¤å™¨å’Œç¯å¢ƒå˜é‡ï¼ŒæŠ‘åˆ¶CSSè­¦å‘Š
# css_filter = CSSWarningFilter()
# logging.getLogger().addFilter(css_filter)
# os.environ['QT_LOGGING_RULES'] = '*=false;qt.qss.*=false'
# os.environ['QT_QSS_WARNINGS'] = 'false'
try:
    from lunar_python import Lunar, Solar, LunarYear
except ImportError:
    Lunar = Solar = None

# ä¿è¯æ§åˆ¶å°è¾“å‡ºåœ¨Windowsä¸‹ä¸ä¼šå› ç¼–ç æŠ¥é”™
try:
    sys.stdout.reconfigure(encoding='utf-8', errors='backslashreplace')
    sys.stderr.reconfigure(encoding='utf-8', errors='backslashreplace')
except Exception:
    pass
# å…¼å®¹æ€§å¤„ç†ï¼šä¿ç•™åŸæœ‰å¥åº·ç›‘æµ‹ç›¸å…³å˜é‡ï¼Œé¿å…ä»£ç é”™è¯¯
ADVANCED_HEALTH_MONITOR_AVAILABLE = False
AI_HEALTH_MONITOR_AVAILABLE = False
HEALTH_MONITOR_AVAILABLE = False

# åˆ›å»ºå ä½ç±»ï¼Œä¿æŒä»£ç å…¼å®¹æ€§

class AdvancedHealthMonitorWidget:
    def __init__(self, parent=None):
        pass
class AIHealthMonitorWidget:
    def __init__(self, parent=None):
        pass
class HealthMonitorWidget:
    def __init__(self, parent=None):
        pass
# å…«å¦æ—¶é’Ÿåˆå§‹åŒ–å®Œæˆ

class ProfessionalBaguaClock(QWidget):
    """å…«å¦æ—¶é’Ÿä¸»ç•Œé¢ç±»
    é›†æˆä¼ ç»Ÿå…«å­—ã€é£æ°´ã€æ‹©æ—¥ã€èµ·åç­‰åŠŸèƒ½çš„ç»¼åˆå‘½ç†åˆ†æç³»ç»Ÿ
    æä¾›ç°ä»£åŒ–çš„å›¾å½¢ç•Œé¢å’Œä¸“ä¸šçš„å‘½ç†åˆ†æåŠŸèƒ½
    """

    def check_cml_integrity(self):
        """
        æ£€æŸ¥å…­ä¹¦åº“å®Œæ•´æ€§å’Œå¯ç”¨æ€§ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
        è¿”å›ï¼š(æ˜¯å¦å¯ç”¨, é”™è¯¯ä¿¡æ¯)
        """
        if not CML_UNIFIED_AVAILABLE:
            return False, "å…­ä¹¦åº“æœªå®‰è£…ï¼ˆchinese_metaphysics_libraryï¼‰"
        
        try:
            test_analyzer = UnifiedMetaphysicsAnalyzer()
            required_analyzers = ['ä¸‰å‘½é€šä¼š', 'æ¸Šæµ·å­å¹³', 'å­å¹³çœŸè¯ ', 'æ»´å¤©é«“', 'ç©·é€šå®é‰´', 'å…°å°å¦™é€‰']
            missing = []
            for analyzer_name in required_analyzers:
                if analyzer_name not in test_analyzer.analyzers:
                    missing.append(analyzer_name)
            
            if missing:
                return False, f"ç¼ºå°‘åˆ†æå™¨ï¼š{', '.join(missing)}"
            
            return True, "å…­ä¹¦åº“å®Œæ•´å¯ç”¨"
        except Exception as e:
            return False, f"å…­ä¹¦åº“åˆå§‹åŒ–å¤±è´¥ï¼š{str(e)}"
    
    def format_analysis_error(self, module_name, error_msg, analyzer_name=""):
        """
        ç»Ÿä¸€çš„å…­ä¹¦åº“åˆ†æé”™è¯¯æç¤ºæ ¼å¼ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
        """
        error_text = f"ã€{module_name}ã€‘\n"
        error_text += f"â€¢ âš ï¸ å…­ä¹¦åº“åˆ†æå¤±è´¥ï¼š{error_msg}\n"
        if analyzer_name:
            error_text += f"â€¢ åˆ†æå™¨ï¼š{analyzer_name}\n"
        error_text += "â€¢ å¯èƒ½åŸå› ï¼š\n"
        error_text += "  1. å…­ä¹¦åº“æœªæ­£ç¡®å®‰è£…\n"
        error_text += "  2. æ•°æ®æ ¼å¼ä¸æ­£ç¡®\n"
        error_text += "  3. åˆ†æå™¨å†…éƒ¨é”™è¯¯\n"
        error_text += "â€¢ å»ºè®®ï¼š\n"
        error_text += "  1. æ£€æŸ¥å®‰è£…ï¼špip list | grep chinese-metaphysics-library\n"
        error_text += "  2. é‡æ–°å®‰è£…ï¼špip install --upgrade chinese_metaphysics_library\n"
        error_text += "  3. æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯\n"
        error_text += "\n"
        return error_text

    def __init__(self):
        super().__init__()
        self.setWindowTitle("å…«å¦æ—¶é’Ÿ V2.0.0")
        
        # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šå¯åŠ¨æ—¶æ£€æŸ¥å…­ä¹¦åº“å®Œæ•´æ€§
        if CML_UNIFIED_AVAILABLE:
            available, message = self.check_cml_integrity()
            if not available:
                from PyQt5.QtWidgets import QMessageBox
                reply = QMessageBox.warning(
                    None,
                    "å…­ä¹¦åº“æ£€æŸ¥å¤±è´¥",
                    f"å…­ä¹¦åº“å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥ï¼š{message}\n\n"
                    "ç¨‹åºé‡‡ç”¨ä¸¥æ ¼æ¨¡å¼ï¼Œéœ€è¦å®Œæ•´çš„å…­ä¹¦åº“æ‰èƒ½æ­£å¸¸è¿è¡Œã€‚\n"
                    "éƒ¨åˆ†åˆ†æåŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚\n\n"
                    "æ˜¯å¦ç»§ç»­è¿è¡Œï¼Ÿ",
                    QMessageBox.Yes | QMessageBox.No
                )
                if reply == QMessageBox.No:
                    import sys
                    sys.exit(1)
        else:
            from PyQt5.QtWidgets import QMessageBox
            reply = QMessageBox.warning(
                None,
                "å…­ä¹¦åº“æœªå®‰è£…",
                "ç¨‹åºéœ€è¦å…­ä¹¦åº“ï¼ˆchinese_metaphysics_libraryï¼‰æ‰èƒ½æ­£å¸¸è¿è¡Œã€‚\n\n"
                "ç¨‹åºé‡‡ç”¨ä¸¥æ ¼æ¨¡å¼ï¼Œåªä½¿ç”¨å…­ä¹¦åº“è¿›è¡Œåˆ†æã€‚\n"
                "éƒ¨åˆ†åˆ†æåŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚\n\n"
                "æ˜¯å¦ç»§ç»­è¿è¡Œï¼Ÿ",
                QMessageBox.Yes | QMessageBox.No
            )
            if reply == QMessageBox.No:
                import sys
                sys.exit(1)
        
        # ç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯
        # V2.0.0: å®Œæ•´çš„å…«å¦æ—¶é’Ÿç³»ç»Ÿï¼Œç®—æ³•ç»Ÿä¸€ï¼ŒåŠŸèƒ½å®Œå–„
        # æ—¶é’Ÿç¼©æ”¾åŠŸèƒ½
        self.base_size = 1000    # åŸºç¡€å°ºå¯¸

        # ä»é…ç½®æ–‡ä»¶è¯»å–ç¼©æ”¾è®¾ç½®
        settings = self.load_system_settings()
        default_scale = settings.get('default_scale', 65)  # é»˜è®¤65%
        # å¤„ç†ç¼©æ”¾å€¼ï¼šå¦‚æœæ˜¯ç™¾åˆ†æ¯”ï¼Œè½¬æ¢ä¸ºå°æ•°ï¼›å¦‚æœæ˜¯å°æ•°ï¼Œç›´æ¥ä½¿ç”¨
        if default_scale > 1:
            self.scale_factor = default_scale / 100.0  # 65 -> 0.65
        else:
            self.scale_factor = default_scale  # 0.65 -> 0.65
        print(f"ç¨‹åºå¯åŠ¨ï¼Œä½¿ç”¨ç¼©æ”¾{self.scale_factor*100:.0f}% (scale_factor={self.scale_factor})")
        self.current_size = int(self.base_size * self.scale_factor)
        self.setFixedSize(self.current_size, self.current_size)
        self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint)
        self.setAttribute(Qt.WA_TranslucentBackground)
        # åŠ¨ç”»å‚æ•° - ä¼˜åŒ–æ€§èƒ½ï¼šé™ä½å¸§ç‡
        self.animation_timer = QTimer()
        self.animation_timer.timeout.connect(self.update_animation)
        self.animation_timer.start(50)  # 20 FPSï¼Œå‡å°‘CPUå ç”¨
        # æ—¶é—´æ›´æ–°
        self.time_timer = QTimer()
        self.time_timer.timeout.connect(self.update_time)
        self.time_timer.start(1000)
        # åŠ¨ç”»çŠ¶æ€
        self.angle_offset = 0
        self.pulse_scale = 1.0
        self.glow_intensity = 0
        # å¥åº·æé†’çŠ¶æ€
        self.health_reminder_shown = {}  # è®°å½•æ¯ä¸ªå°æ—¶æ˜¯å¦å·²æ˜¾ç¤ºæé†’
        self.shichen_reminder_shown = {}  # è®°å½•æ¯ä¸ªæ—¶è¾°æ˜¯å¦å·²æ˜¾ç¤ºæé†’
        # è®¾ç½®ç¼“å­˜
        self.settings_cache = self.load_system_settings()
        # æ‚¬åœå¯¹è¯æ¡†çŠ¶æ€
        self.hover_dialog = None  # å½“å‰æ‚¬åœå¯¹è¯æ¡†
        self.current_hover_shichen = None  # å½“å‰æ‚¬åœçš„æ—¶è¾°ç´¢å¼•
        # å¯ç”¨é¼ æ ‡è·Ÿè¸ª
        self.setMouseTracking(True)
        # å…«å¦ä¿¡æ¯
        self.bagua_info = [
            ("ä¹¾", "â˜°", 0), ("å…‘", "â˜±", 45), ("ç¦»", "â˜²", 90), ("éœ‡", "â˜³", 135),
            ("å·½", "â˜´", 180), ("å", "â˜µ", 225), ("è‰®", "â˜¶", 270), ("å¤", "â˜·", 315)
        ]
        # æ—¶è¾°æ˜ å°„ - ä¿®æ­£ä¸ºä¼ ç»Ÿ12æ—¶è¾°å¯¹åº”
        self.time_bagua_map = {
            # å­æ—¶ (23:00-01:00) â†’ åå¦ â˜µ
            23: 5, 0: 5,
            # ä¸‘æ—¶ (01:00-03:00) â†’ è‰®å¦ â˜¶
            1: 6, 2: 6,
            # å¯…æ—¶ (03:00-05:00) â†’ éœ‡å¦ â˜³
            3: 3, 4: 3,
            # å¯æ—¶ (05:00-07:00) â†’ å·½å¦ â˜´
            5: 4, 6: 4,
            # è¾°æ—¶ (07:00-09:00) â†’ ç¦»å¦ â˜²
            7: 2, 8: 2,
            # å·³æ—¶ (09:00-11:00) â†’ å¤å¦ â˜·
            9: 7, 10: 7,
            # åˆæ—¶ (11:00-13:00) â†’ å…‘å¦ â˜±
            11: 1, 12: 1,
            # æœªæ—¶ (13:00-15:00) â†’ ä¹¾å¦ â˜°
            13: 0, 14: 0,
            # ç”³æ—¶ (15:00-17:00) â†’ åå¦ â˜µ
            15: 5, 16: 5,
            # é…‰æ—¶ (17:00-19:00) â†’ è‰®å¦ â˜¶
            17: 6, 18: 6,
            # æˆŒæ—¶ (19:00-21:00) â†’ éœ‡å¦ â˜³
            19: 3, 20: 3,
            # äº¥æ—¶ (21:00-23:00) â†’ å·½å¦ â˜´
            21: 4, 22: 4
        }
        self.current_time = datetime.now()
        self.drag_position = None

        # sxtwl è®¡ç®—ç»“æœä¿å­˜
        self.current_sxtwl_result = None  # ä¿å­˜å½“å‰çš„sxtwlè®¡ç®—ç»“æœ
        self.last_analysis_result = None  # ä¿å­˜æœ€åçš„åˆ†æç»“æœ

        # ... existing code ...

        # åˆ›å»ºæ ‡é¢˜æ 
        self.create_title_bar()
        # åˆ›å»ºåŠŸèƒ½æŒ‰é’®
        self.create_function_buttons()
        # åˆå§‹åŒ–è®°äº‹æœ¬å’Œé—¹é’Ÿ
        self.notepad_window = None
        self.alarm_window = None
        self.alarms = []
        self.load_alarms()

        # éŸ³é¢‘å¯ç”¨æ€§ç¼“å­˜
        self.audio_available = _is_pygame_ready()
        self._audio_warning_shown = False
        # å‡ºç”Ÿåœ°ç¼“å­˜
        self._custom_city_coords = None
        self._missing_location_warned = False

        # å…¼å®¹æ€§å˜é‡ï¼šä¿ç•™åŸæœ‰å˜é‡åï¼Œé¿å…ä»£ç é”™è¯¯
        self.health_monitor_window = None
        self.health_monitor = None
        self.camera_enabled = True  # å…¼å®¹æ€§ä¿ç•™

        # åˆå§‹åŒ–pygameéŸ³é¢‘ï¼ˆè‹¥å¯ç”¨ï¼‰
        if self.audio_available:
            pygame.mixer.init()
        # åˆ›å»ºç³»ç»Ÿæ‰˜ç›˜
        self.create_system_tray()
        # åˆ›å»ºç¼©æ”¾å¿«æ·é”®
        self.create_scale_shortcuts()
        # è®¾ç½®çª—å£é»˜è®¤ä½ç½®åˆ°å³ä¸Šè§’
        self.set_default_position()
        # è®¾ç½®æ ·å¼
        self.setStyleSheet("""
            QWidget {
                background: transparent;
                color: #FFD700;
            }
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 15px;
                color: #FFD700;
                font-weight: bold;
                padding: 8px;
                min-width: 60px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }
        """)
    def create_title_bar(self):
        """åˆ›å»ºä¸“ä¸šæ ‡é¢˜æ """
        title_bar = QFrame()
        title_bar.setFixedHeight(40)
        title_bar.setStyleSheet("""
            QFrame {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
            }
        """)
        layout = QHBoxLayout(title_bar)
        layout.setContentsMargins(10, 5, 10, 5)
        # æ ‡é¢˜
        title_label = QLabel("å…«å¦æ—¶é’Ÿ V2.0.0")
        title_label.setStyleSheet("""
            QLabel {
                color: #FFD700;
                font-size: 16px;
                font-weight: bold;
                background: transparent;
            }
        """)
        # æ§åˆ¶æŒ‰é’®
        btn_layout = QHBoxLayout()
        btn_layout.setSpacing(5)
        # æŒ‰é’®ç»Ÿä¸€æ ·å¼
        btn_style = """
            QPushButton {
                color: #FFFFFF;
                font-size: 20px;
                font-weight: bold;
                background: transparent;
                border: 2px solid #FFD700;
                border-radius: 15px;
            }
            QPushButton:hover {
                background: #333333;
                border-color: #FFA500;
            }
        """
        # éšè—æŒ‰é’®
        hide_btn = QPushButton("â”€")
        hide_btn.setFixedSize(30, 30)
        hide_btn.setStyleSheet(btn_style)
        hide_btn.clicked.connect(self.minimize_to_tray)
        # å…¨å±æŒ‰é’®
        max_btn = QPushButton("â– ")
        max_btn.setFixedSize(30, 30)
        max_btn.setStyleSheet(btn_style)
        max_btn.clicked.connect(self.toggle_fullscreen)
        # å…³é—­æŒ‰é’®
        close_btn = QPushButton("Ã—")
        close_btn.setFixedSize(30, 30)
        close_btn.setStyleSheet(btn_style + "QPushButton:hover {background: #FF4444; border-color: #FF6666;}")
        close_btn.clicked.connect(self.close_application)
        btn_layout.addWidget(hide_btn)
        btn_layout.addWidget(max_btn)
        btn_layout.addWidget(close_btn)
        layout.addWidget(title_label)
        layout.addStretch()
        layout.addLayout(btn_layout)
        # å°†æ ‡é¢˜æ æ·»åŠ åˆ°ä¸»çª—å£
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0)
        main_layout.addWidget(title_bar)
        main_layout.addStretch()
    def close_application(self):
        """å…³é—­åº”ç”¨ç¨‹åº - æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†ä¿æŠ¤ä¸»ç¨‹åºä¸è¢«æ„å¤–å…³é—­"""
        msg = QMessageBox(None)  # ç‹¬ç«‹æ¶ˆæ¯æ¡†ï¼Œé¿å…è¯¯å…³ä¸»çª—å£
        msg.setWindowTitle('ç¡®è®¤é€€å‡º')
        msg.setText('ç¡®å®šè¦é€€å‡ºå…«å¦æ—¶é’Ÿå—ï¼Ÿ\n\nç¨‹åºé€€å‡ºåï¼š\nâ€¢ å…«å¦æ—¶é’ŸåŠŸèƒ½å°†åœæ­¢\nâ€¢ æ—¶é—´æé†’åŠŸèƒ½å°†åœæ­¢\nâ€¢ æ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜')
        msg.setStandardButtons(QMessageBox.Yes | QMessageBox.No)
        msg.setDefaultButton(QMessageBox.No)
        msg.setWindowFlags(Qt.Dialog | Qt.WindowStaysOnTopHint | Qt.WindowCloseButtonHint)
        reply = msg.exec_()
        if reply == QMessageBox.Yes:
            # æ ‡è®°ä¸ºç¡®è®¤å…³é—­ï¼Œé¿å…closeEventé‡å¤è¯¢é—®
            self._confirmed_close = True
            # ä¿å­˜æ‰€æœ‰æ•°æ®
            self.save_alarms()
            if hasattr(self, 'advanced_health_monitor_window') and self.advanced_health_monitor_window:
                try:
                    if hasattr(self.advanced_health_monitor_window, 'is_monitoring') and self.advanced_health_monitor_window.is_monitoring:
                        self.advanced_health_monitor_window.stop_monitoring()
                    if hasattr(self.advanced_health_monitor_window, 'save_settings'):
                        self.advanced_health_monitor_window.save_settings()
                except:
                    pass
            # æ­£å¸¸é€€å‡ºç¨‹åº
            self.close()
    def toggle_fullscreen(self):
        """åˆ‡æ¢çœŸæ­£çš„å…¨å±çŠ¶æ€"""
        if not hasattr(self, 'is_fullscreen'):
            self.is_fullscreen = False
            self.original_scale_factor = self.scale_factor
            self.original_geometry = self.geometry()
        if self.is_fullscreen:
            # é€€å‡ºå…¨å±
            self.showNormal()
            self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint)
            self.show()
            # æ¢å¤åŸå§‹ç¼©æ”¾å’Œä½ç½®
            self.scale_factor = self.original_scale_factor
            self.setGeometry(self.original_geometry)
            self.update_size()
            self.is_fullscreen = False
        else:
            # è¿›å…¥å…¨å±
            self.original_scale_factor = self.scale_factor
            self.original_geometry = self.geometry()
            # è·å–å±å¹•å°ºå¯¸
            from PyQt5.QtWidgets import QDesktopWidget
            desktop = QDesktopWidget()
            screen_geometry = desktop.screenGeometry()
            # è®¡ç®—å…¨å±æ‰€éœ€çš„ç¼©æ”¾æ¯”ä¾‹
            screen_size = min(screen_geometry.width(), screen_geometry.height())
            fullscreen_scale = screen_size / self.base_size * 0.9  # ç•™10%è¾¹è·
            # è®¾ç½®å…¨å±ç¼©æ”¾
            self.scale_factor = fullscreen_scale
            # è®¾ç½®å…¨å±æ˜¾ç¤º
            self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint)
            self.showFullScreen()
            # æ›´æ–°å°ºå¯¸å’Œä½ç½®
            self.update_size()
            # å±…ä¸­æ˜¾ç¤º
            self.move((screen_geometry.width() - self.current_size) // 2,
                     (screen_geometry.height() - self.current_size) // 2)
            self.is_fullscreen = True
    def exit_fullscreen(self):
        """é€€å‡ºå…¨å±æ¨¡å¼"""
        if hasattr(self, 'is_fullscreen') and self.is_fullscreen:
            self.toggle_fullscreen()
    def create_system_tray(self):
        """åˆ›å»ºç³»ç»Ÿæ‰˜ç›˜"""
        if not QSystemTrayIcon.isSystemTrayAvailable():
            QMessageBox.critical(self, "ç³»ç»Ÿæ‰˜ç›˜", "ç³»ç»Ÿæ‰˜ç›˜ä¸å¯ç”¨")
            return
        # åˆ›å»ºæ‰˜ç›˜å›¾æ ‡
        self.tray_icon = QSystemTrayIcon(self)
        # è®¾ç½®æ‰˜ç›˜å›¾æ ‡ï¼ˆåˆ›å»ºç®€å•å›¾æ ‡ï¼‰
        pixmap = QPixmap(16, 16)
        pixmap.fill(QColor(255, 215, 0))  # é‡‘è‰²å›¾æ ‡
        self.tray_icon.setIcon(QIcon(pixmap))
        # åˆ›å»ºæ‰˜ç›˜èœå•
        tray_menu = QMenu()
        # æ˜¾ç¤º/éšè—åŠ¨ä½œ
        show_action = QAction("æ˜¾ç¤ºä¸»çª—å£", self)
        show_action.triggered.connect(self.show_from_tray)
        tray_menu.addAction(show_action)
        hide_action = QAction("éšè—åˆ°æ‰˜ç›˜", self)
        hide_action.triggered.connect(self.minimize_to_tray)
        tray_menu.addAction(hide_action)
        tray_menu.addSeparator()
        # è®°äº‹æœ¬åŠ¨ä½œ
        notepad_action = QAction("è®°äº‹æœ¬", self)
        notepad_action.triggered.connect(self.open_notepad)
        tray_menu.addAction(notepad_action)
        # é—¹é’ŸåŠ¨ä½œ
        alarm_action = QAction("é—¹é’Ÿ", self)
        alarm_action.triggered.connect(self.open_alarm_settings)
        tray_menu.addAction(alarm_action)
        # å…«å­—ç®—å‘½åŠ¨ä½œ
        if ADVANCED_HEALTH_MONITOR_AVAILABLE or AI_HEALTH_MONITOR_AVAILABLE or HEALTH_MONITOR_AVAILABLE:
            health_action = QAction("ğŸ”® å…«å¦æ—¶é’Ÿ", self)
            health_action.triggered.connect(self.open_health_monitor)
            tray_menu.addAction(health_action)
        tray_menu.addSeparator()
        # ç¼©æ”¾æ§åˆ¶åŠ¨ä½œ
        zoom_in_action = QAction("ğŸ” æ”¾å¤§ (Ctrl++)", self)
        zoom_in_action.triggered.connect(self.zoom_in)
        tray_menu.addAction(zoom_in_action)
        zoom_out_action = QAction("ğŸ” ç¼©å° (Ctrl+-)", self)
        zoom_out_action.triggered.connect(self.zoom_out)
        tray_menu.addAction(zoom_out_action)
        tray_menu.addSeparator()
        # é€€å‡ºåŠ¨ä½œ
        quit_action = QAction("é€€å‡º", self)
        quit_action.triggered.connect(self.close_application)
        tray_menu.addAction(quit_action)
        # è®¾ç½®æ‰˜ç›˜èœå•æ ·å¼
        tray_menu.setStyleSheet("""
            QMenu {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
                border: 2px solid #FFD700;
                color: #FFD700;
                padding: 5px;
            }
            QMenu::item {
                padding: 8px 20px;
                border-radius: 5px;
            }
            QMenu::item:selected {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
            }
        """)
        self.tray_icon.setContextMenu(tray_menu)
        # åŒå‡»æ‰˜ç›˜å›¾æ ‡æ˜¾ç¤ºçª—å£
        self.tray_icon.activated.connect(self.tray_icon_activated)
        # è®¾ç½®æ‰˜ç›˜æç¤º
        self.tray_icon.setToolTip("å…«å¦æ—¶é’Ÿ V2.0.0")
        # æ˜¾ç¤ºæ‰˜ç›˜å›¾æ ‡
        self.tray_icon.show()
    def create_scale_shortcuts(self):
        """åˆ›å»ºç¼©æ”¾å¿«æ·é”®"""
        # æ”¾å¤§å¿«æ·é”® Ctrl++
        zoom_in_shortcut = QShortcut(QKeySequence("Ctrl++"), self)
        zoom_in_shortcut.activated.connect(self.zoom_in)
        # ç¼©å°å¿«æ·é”® Ctrl+-
        zoom_out_shortcut = QShortcut(QKeySequence("Ctrl+-"), self)
        zoom_out_shortcut.activated.connect(self.zoom_out)
        # é‡ç½®å¤§å°å¿«æ·é”® Ctrl+0
        reset_size_shortcut = QShortcut(QKeySequence("Ctrl+0"), self)
        reset_size_shortcut.activated.connect(self.reset_size)
        # å…¨å±åˆ‡æ¢å¿«æ·é”® F11
        fullscreen_shortcut = QShortcut(QKeySequence("F11"), self)
        fullscreen_shortcut.activated.connect(self.toggle_fullscreen)
        # é€€å‡ºå…¨å±å¿«æ·é”® ESC
        escape_shortcut = QShortcut(QKeySequence("Escape"), self)
        escape_shortcut.activated.connect(self.exit_fullscreen)
    def set_default_position(self):
        """è®¾ç½®çª—å£é»˜è®¤ä½ç½®åˆ°å³ä¸Šè§’"""
        try:
            # è·å–å±å¹•å°ºå¯¸
            from PyQt5.QtWidgets import QDesktopWidget
            desktop = QDesktopWidget()
            screen_geometry = desktop.availableGeometry()

            # è®¡ç®—å³ä¸Šè§’ä½ç½®ï¼ˆè·ç¦»å³è¾¹å’Œä¸Šè¾¹å„ç•™20åƒç´ è¾¹è·ï¼‰
            x = screen_geometry.width() - self.current_size - 20
            y = 20
            # è®¾ç½®çª—å£ä½ç½®
            self.move(x, y)
        except:
            # å¦‚æœè·å–å±å¹•å°ºå¯¸å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®
            self.move(800, 20)
    def zoom_in(self):
        """æ”¾å¤§æ—¶é’Ÿ"""
        if self.scale_factor < 2.0:  # æœ€å¤§æ”¾å¤§åˆ°2å€
            self.scale_factor += 0.1
            self.update_size()
    def zoom_out(self):
        """ç¼©å°æ—¶é’Ÿ"""
        if self.scale_factor > 0.5:  # æœ€å°ç¼©å°åˆ°0.5å€
            self.scale_factor -= 0.1
            self.update_size()
    def reset_size(self):
        """é‡ç½®æ—¶é’Ÿå¤§å°"""
        self.scale_factor = 1.0
        self.update_size()



    def update_size(self):
        """æ›´æ–°çª—å£å¤§å°"""
        self.current_size = int(self.base_size * self.scale_factor)
        # ä¿å­˜å½“å‰ä½ç½®
        # current_pos = self.pos()  # æš‚æ—¶ä¸ä½¿ç”¨
        # æ›´æ–°çª—å£å¤§å°
        self.setFixedSize(self.current_size, self.current_size)
        # ä¿æŒçª—å£å±…ä¸­ï¼ˆå¯é€‰ï¼‰
        # self.move(current_pos.x() + (old_size - self.current_size) // 2,
        #           current_pos.y() + (old_size - self.current_size) // 2)
        # é‡æ–°åˆ›å»ºåŠŸèƒ½æŒ‰é’®ä»¥é€‚åº”æ–°å°ºå¯¸
        self.update_function_buttons()
        # æ›´æ–°ç¼©æ”¾æ˜¾ç¤º
        self.update_scale_display()
        # å¼ºåˆ¶é‡ç»˜
        self.update()
    def update_function_buttons(self):
        """æ›´æ–°åŠŸèƒ½æŒ‰é’®ä½ç½®å’Œæ ·å¼ä»¥é€‚åº”ç¼©æ”¾"""
        # è°ƒæ•´æŒ‰é’®ä½ç½®ï¼Œä¸è¦å¤ªé å³è¾¹ - ç¼©å°ä¸‰åˆ†ä¹‹ä¸€
        button_x = int(self.current_size - 100 * self.scale_factor)  # è·ç¦»å³è¾¹ä¹Ÿè¦ç¼©æ”¾ï¼Œç¼©å°åˆ°100

        # é‡æ–°è®¡ç®—æ ·å¼ï¼ˆæ ¹æ®å½“å‰ç¼©æ”¾å› å­ï¼‰- ä¼˜åŒ–å­—ä½“å’ŒæŒ‰é’®å°ºå¯¸
        button_font_size = max(10, int(20 * self.scale_factor))  # ç¼©å°å­—ä½“ï¼Œé¿å…æŒ¡ä½
        button_style = f"""
            QPushButton {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: {int(2 * self.scale_factor)}px solid #FFD700;
                border-radius: {int(15 * self.scale_factor)}px;
                color: #FFD700;
                font-weight: bold;
                font-size: {button_font_size}px;
                padding: {int(6 * self.scale_factor)}px;
                text-align: center;
            }}
            QPushButton:hover {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }}
        """
        zoom_font_size = max(12, int(22 * self.scale_factor))  # ç¼©å°å­—ä½“ï¼Œé¿å…æŒ¡ä½
        zoom_button_style = f"""
            QPushButton {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A4A2A, stop:1 #1A3A1A);
                border: {int(2 * self.scale_factor)}px solid #66FF66;
                border-radius: {int(12 * self.scale_factor)}px;
                color: #66FF66;
                font-weight: bold;
                font-size: {zoom_font_size}px;
                padding: {int(5 * self.scale_factor)}px;
                text-align: center;
            }}
            QPushButton:hover {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A6A4A, stop:1 #3A5A3A);
                border-color: #88FF88;
            }}
        """
        # æ›´æ–°æŒ‰é’®æ ·å¼
        self.notepad_btn.setStyleSheet(button_style)
        self.alarm_btn.setStyleSheet(button_style)
        self.settings_btn.setStyleSheet(button_style + """
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A6A4A, stop:1 #2A4A2A);
                border-color: #66FF66;
            }
        """)
        self.zoom_in_btn.setStyleSheet(zoom_button_style)
        self.zoom_out_btn.setStyleSheet(zoom_button_style)
        # è®¡ç®—æŒ‰é’®å°ºå¯¸ï¼Œç¡®ä¿ä¸ç¼©æ”¾åŒæ­¥
        button_width = int(85 * self.scale_factor)
        button_height = int(35 * self.scale_factor)
        zoom_button_height = int(32 * self.scale_factor)
        # è®°äº‹æœ¬æŒ‰é’®
        self.notepad_btn.setGeometry(button_x, int(60 * self.scale_factor),
                                    button_width, button_height)
        # é—¹é’ŸæŒ‰é’®
        self.alarm_btn.setGeometry(button_x, int(105 * self.scale_factor),
                                  button_width, button_height)
        # ç³»ç»Ÿè®¾ç½®æŒ‰é’®
        self.settings_btn.setGeometry(button_x, int(150 * self.scale_factor),
                                     button_width, button_height)
        # å…«å­—ç®—å‘½æŒ‰é’®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰- å¼ºåˆ¶æ˜¾ç¤º
        if hasattr(self, 'bazi_btn'):
            self.bazi_btn.setStyleSheet(button_style + """
                QPushButton:hover {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 #6A4A6A, stop:1 #4A2A4A);
                    border-color: #FFD700;
                }
            """)
            self.bazi_btn.setGeometry(button_x, int(195 * self.scale_factor),
                                       button_width, button_height)
            self.bazi_btn.setVisible(True)  # å¼ºåˆ¶æ˜¾ç¤º
            self.bazi_btn.raise_()  # æå‡åˆ°æœ€å‰é¢
            print(f"æ›´æ–°å…«å­—æŒ‰é’®ä½ç½®: ({button_x}, {int(195 * self.scale_factor)})")
        # ç¼©æ”¾æ§åˆ¶æŒ‰é’® - å…«å­—æŒ‰é’®æ€»æ˜¯å­˜åœ¨
        zoom_start_y = 240
        self.zoom_in_btn.setGeometry(button_x, int(zoom_start_y * self.scale_factor),
                                    button_width, zoom_button_height)
        self.zoom_out_btn.setGeometry(button_x, int((zoom_start_y + 40) * self.scale_factor),
                                     button_width, zoom_button_height)
    def minimize_to_tray(self):
        """æœ€å°åŒ–åˆ°ç³»ç»Ÿæ‰˜ç›˜"""
        if hasattr(self, 'tray_icon') and self.tray_icon.isVisible():
            self.hide()
            # ç§»é™¤æ‰˜ç›˜æç¤ºæ¶ˆæ¯ï¼Œé¿å…æ¯æ¬¡éƒ½å¼¹å‡ºé€šçŸ¥
        else:
            # å¦‚æœæ‰˜ç›˜ä¸å¯ç”¨ï¼Œåˆ™æœ€å°åŒ–çª—å£
            self.showMinimized()
    def show_from_tray(self):
        """ä»ç³»ç»Ÿæ‰˜ç›˜æ˜¾ç¤ºçª—å£"""
        self.show()
        self.raise_()
        self.activateWindow()
    def tray_icon_activated(self, reason):
        """æ‰˜ç›˜å›¾æ ‡æ¿€æ´»äº‹ä»¶"""
        # å•å‡»æ˜¾ç¤º/éšè—ï¼ŒåŒå‡»ä¹Ÿæ”¯æŒæ˜¾ç¤º/éšè—
        if reason in [QSystemTrayIcon.ActivationReason.Trigger, QSystemTrayIcon.ActivationReason.DoubleClick]:
            if self.isVisible():
                self.minimize_to_tray()
            else:
                self.show_from_tray()
    def create_function_buttons(self):
        """åˆ›å»ºåŠŸèƒ½æŒ‰é’®ï¼ˆè®°äº‹æœ¬ã€é—¹é’Ÿã€è®¾ç½®ã€ç¼©æ”¾æ§åˆ¶ï¼‰"""
        # æŒ‰é’®æ ·å¼ï¼ˆæ ¹æ®ç¼©æ”¾è°ƒæ•´å­—ä½“ï¼‰- ä¼˜åŒ–å­—ä½“å’ŒæŒ‰é’®å°ºå¯¸
        button_font_size = max(10, int(20 * self.scale_factor))  # ç¼©å°å­—ä½“ï¼Œé¿å…æŒ¡ä½
        button_style = f"""
            QPushButton {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: {int(2 * self.scale_factor)}px solid #FFD700;
                border-radius: {int(15 * self.scale_factor)}px;
                color: #FFD700;
                font-weight: bold;
                font-size: {button_font_size}px;
                padding: {int(6 * self.scale_factor)}px;
                text-align: center;
            }}
            QPushButton:hover {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }}
        """

        # ç¼©æ”¾æŒ‰é’®æ ·å¼ï¼ˆæ ¹æ®ç¼©æ”¾è°ƒæ•´å­—ä½“ï¼‰- ä¼˜åŒ–å­—ä½“å’ŒæŒ‰é’®å°ºå¯¸
        zoom_font_size = max(12, int(22 * self.scale_factor))  # ç¼©å°å­—ä½“ï¼Œé¿å…æŒ¡ä½
        zoom_button_style = f"""
            QPushButton {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A4A2A, stop:1 #1A3A1A);
                border: {int(2 * self.scale_factor)}px solid #66FF66;
                border-radius: {int(12 * self.scale_factor)}px;
                color: #66FF66;
                font-weight: bold;
                font-size: {zoom_font_size}px;
                padding: {int(5 * self.scale_factor)}px;
                text-align: center;
            }}
            QPushButton:hover {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A6A4A, stop:1 #3A5A3A);
                border-color: #88FF88;
            }}
        """
        # è®¡ç®—æŒ‰é’®å°ºå¯¸ï¼Œç¡®ä¿ä¸ç¼©æ”¾åŒæ­¥
        button_x = int(self.current_size - 95 * self.scale_factor)
        button_width = int(85 * self.scale_factor)
        button_height = int(35 * self.scale_factor)
        zoom_button_height = int(32 * self.scale_factor)
        # è®°äº‹æœ¬æŒ‰é’®
        self.notepad_btn = QPushButton("è®°äº‹æœ¬", self)
        self.notepad_btn.setStyleSheet(button_style)
        self.notepad_btn.setGeometry(button_x, int(60 * self.scale_factor), button_width, button_height)
        self.notepad_btn.clicked.connect(self.open_notepad)
        # é—¹é’ŸæŒ‰é’®
        self.alarm_btn = QPushButton("é—¹é’Ÿ", self)
        self.alarm_btn.setStyleSheet(button_style)
        self.alarm_btn.setGeometry(button_x, int(105 * self.scale_factor), button_width, button_height)
        self.alarm_btn.clicked.connect(self.open_alarm_settings)
        # ç³»ç»Ÿè®¾ç½®æŒ‰é’®
        self.settings_btn = QPushButton("è®¾ç½®", self)
        self.settings_btn.setStyleSheet(button_style + """
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A6A4A, stop:1 #2A4A2A);
                border-color: #66FF66;
            }
        """)
        self.settings_btn.setGeometry(button_x, int(150 * self.scale_factor), button_width, button_height)
        self.settings_btn.clicked.connect(self.open_system_settings)
        # å…«å­—ç®—å‘½æŒ‰é’® - ä¸»è¦åŠŸèƒ½å…¥å£
        print("åˆ›å»ºå…«å­—ç®—å‘½æŒ‰é’®...")
        self.bazi_btn = QPushButton("å…«å­—", self)
        self.bazi_btn.setStyleSheet(button_style + """
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A4A6A, stop:1 #4A2A4A);
                border-color: #FFD700;
            }
        """)
        self.bazi_btn.setGeometry(button_x, int(195 * self.scale_factor), button_width, button_height)
        self.bazi_btn.clicked.connect(self.show_bazi_suanming)
        self.bazi_btn.setToolTip("å…«å­—ç®—å‘½é£æ°´åˆ†æ")
        self.bazi_btn.setVisible(True)  # å¼ºåˆ¶æ˜¾ç¤º
        self.bazi_btn.raise_()  # æå‡åˆ°æœ€å‰é¢
        print(f"å…«å­—æŒ‰é’®å·²åˆ›å»ºï¼Œä½ç½®: ({button_x}, {int(195 * self.scale_factor)}), å¤§å°: ({button_width}, {button_height})")

        # æ‹©æ—¥æŒ‰é’® - ä¼ ç»Ÿæ‹©æ—¥åŠŸèƒ½å…¥å£
        self.zheri_btn = QPushButton("æ‹©æ—¥", self)
        self.zheri_btn.setStyleSheet(button_style + """
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A6A4A, stop:1 #2A4A2A);
                border-color: #66FF66;
            }
        """)
        self.zheri_btn.setGeometry(button_x, int(240 * self.scale_factor), button_width, button_height)
        self.zheri_btn.clicked.connect(self.show_zheri_analysis)
        self.zheri_btn.setToolTip("ä¼ ç»Ÿæ‹©æ—¥åˆ†æ")
        self.zheri_btn.setVisible(True)

        # ç¼©æ”¾æŒ‰é’®ä½ç½®
        zoom_start_y = 285

        # ç¼©æ”¾æ§åˆ¶æŒ‰é’®ç»„
        zoom_start_y = zoom_start_y
        self.zoom_in_btn = QPushButton("ğŸ”+", self)
        self.zoom_in_btn.setStyleSheet(zoom_button_style)
        self.zoom_in_btn.setGeometry(button_x, int(zoom_start_y * self.scale_factor), button_width, zoom_button_height)
        self.zoom_in_btn.setToolTip("æ”¾å¤§æ—¶é’Ÿ (Ctrl++)")
        self.zoom_in_btn.clicked.connect(self.zoom_in)
        self.zoom_out_btn = QPushButton("ğŸ”-", self)
        self.zoom_out_btn.setStyleSheet(zoom_button_style)
        self.zoom_out_btn.setGeometry(button_x, int((zoom_start_y + 40) * self.scale_factor), button_width, zoom_button_height)
        self.zoom_out_btn.setToolTip("ç¼©å°æ—¶é’Ÿ (Ctrl+-)")
        self.zoom_out_btn.clicked.connect(self.zoom_out)

    def show_zheri_analysis(self):
        """æ˜¾ç¤ºæ‹©æ—¥åˆ†æç•Œé¢"""
        dialog = QDialog(None)
        dialog.setWindowTitle("ğŸ”® ä¸“ä¸šæ‹©æ—¥åˆ†æ - å…«å¦æ—¶é’Ÿ")
        dialog.setFixedSize(1200, 780)  # è°ƒæ•´ä¸ºæ›´ç´§å‡‘å°ºå¯¸
        dialog.setWindowFlags(Qt.Dialog | Qt.WindowStaysOnTopHint)

        # åº”ç”¨ä¸å…«å­—ç®—å‘½ç›¸åŒçš„ä¸“ä¸šæ ·å¼
        dialog.setStyleSheet("""
            QDialog {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
                color: #FFD700;
                font-family: "Microsoft YaHei";
            }
            QGroupBox {
                font-weight: bold;
                border: 2px solid #FFD700;
                border-radius: 10px;
                margin-top: 10px;
                padding-top: 15px;
                background: rgba(42, 42, 42, 0.8);
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 15px;
                padding: 0 8px 0 8px;
                color: #FFD700;
                font-size: 14px;
            }
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFD700;
                font-weight: bold;
                padding: 10px;
                min-width: 100px;
                font-size: 13px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }
            QLineEdit, QDateEdit, QComboBox, QSpinBox {
                background: #FFFFFF;
                border: 2px solid #666666;
                border-radius: 5px;
                padding: 8px;
                color: #000000;
                font-size: 13px;
                min-height: 20px;
            }
            QLineEdit:focus, QDateEdit:focus, QComboBox:focus, QSpinBox:focus {
                border-color: #FFD700;
                background: #FFFACD;
            }
            QTextEdit {
                background: #2A2A2A;
                border: 2px solid #666666;
                border-radius: 5px;
                color: #FFD700;
                font-size: 13px;
                selection-background-color: #FFD700;
                selection-color: #000000;
                padding: 10px;
            }
            QRadioButton {
                color: #FFD700;
                font-weight: bold;
                font-size: 13px;
                spacing: 8px;
            }
            QRadioButton::indicator {
                width: 20px;
                height: 20px;
            }
            QRadioButton::indicator:unchecked {
                border: 2px solid #FFD700;
                border-radius: 10px;
                background: #2A2A2A;
            }
            QRadioButton::indicator:checked {
                border: 2px solid #FFD700;
                border-radius: 10px;
                background: qradialgradient(cx:0.5, cy:0.5, radius:0.5,
                    stop:0 #FFD700, stop:1 #FFA500);
            }
            QLabel {
                color: #FFD700;
                font-weight: bold;
                font-size: 15px;
            }
            QCheckBox {
                color: #FFD700;
                font-weight: bold;
                font-size: 13px;
            }
        """)

        # ä¸»å¸ƒå±€ - å·¦å³åˆ†æ ï¼Œå·¦ä¾§å æ›´å¤§æ¯”ä¾‹
        main_layout = QHBoxLayout(dialog)
        main_layout.setSpacing(24)
        main_layout.setContentsMargins(24, 24, 24, 24)

        # å·¦å³å„å ä¸€åŠç©ºé—´ï¼ˆå»é™¤å›ºå®šå®½åº¦ï¼Œäº¤ç»™å¸ƒå±€æƒé‡æ§åˆ¶ï¼‰
        left_widget = QWidget()
        left_layout = QVBoxLayout(left_widget)
        left_layout.setSpacing(18)

        # æ ‡é¢˜ - å¤§äºŒå·å­—ä½“
        title_label = QLabel("ğŸ”® ä¸“ä¸šæ‹©æ—¥åˆ†æç³»ç»Ÿ")
        title_label.setAlignment(Qt.AlignCenter)
        title_label.setStyleSheet("""
            font-size: 20px;
            font-weight: bold;
            color: #FFD700;
            margin: 15px;
            background: none;
            font-family: 'Microsoft YaHei';
        """)
        left_layout.addWidget(title_label)

        # æ‹©æ—¥æ¨¡å¼é€‰æ‹© - å¢å¤§å­—ä½“
        mode_group = QGroupBox("ğŸ¯ æ‹©æ—¥æ¨¡å¼")
        mode_group.setStyleSheet("""
            QGroupBox {
                font-size: 18px;
                font-weight: bold;
                color: #FFD700;
                border: 2px solid #FFD700;
                border-radius: 8px;
                margin-top: 10px;
                padding-top: 10px;
                font-family: 'Microsoft YaHei';
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 10px;
                padding: 0 5px 0 5px;
            }
        """)
        mode_layout = QVBoxLayout(mode_group)
        mode_layout.setSpacing(15)

        self.bazi_mode_radio = QRadioButton("ğŸ”® å…«å­—æ‹©æ—¥")
        self.bazi_mode_radio.setStyleSheet("""
            QRadioButton {
                font-size: 16px;
                color: #FFD700;
                font-weight: bold;
                font-family: 'Microsoft YaHei';
                spacing: 10px;
            }
        """)
        self.general_mode_radio = QRadioButton("ğŸ“… é»„é“å‰æ—¥")
        self.general_mode_radio.setStyleSheet("""
            QRadioButton {
                font-size: 16px;
                color: #FFD700;
                font-weight: bold;
                font-family: 'Microsoft YaHei';
                spacing: 10px;
            }
        """)
        self.general_mode_radio.setChecked(True)  # é»˜è®¤é€‰æ‹©é»„é“å‰æ—¥ï¼ˆæ— éœ€å…«å­—ï¼‰

        mode_layout.addWidget(self.bazi_mode_radio)
        mode_layout.addWidget(self.general_mode_radio)
        left_layout.addWidget(mode_group)

        # å…«å­—ä¿¡æ¯åŒºåŸŸ - ç®€åŒ–ä¸ºç›´æ¥è¾“å…¥å…«å­—
        self.bazi_group = QGroupBox("ğŸ‘¤ å…«å­—ä¿¡æ¯è¾“å…¥")
        bazi_layout = QVBoxLayout(self.bazi_group)
        bazi_layout.setSpacing(15)

        # é‡æ–°è®¾è®¡çš„å…«å­—è¾“å…¥ç•Œé¢ - ç¾è§‚å®ç”¨çš„å¸ƒå±€
        bazi_input_layout = QVBoxLayout()
        bazi_input_layout.setSpacing(20)

        # ç»Ÿä¸€çš„æ ·å¼å®šä¹‰
        # æ ‡ç­¾æ ·å¼ - å¾®è°ƒå°ºå¯¸
        label_style = """
            QLabel {
                font-size: 15px;
                color: #FFD700;
                font-weight: bold;
                font-family: 'Microsoft YaHei';
                min-width: 72px;
            }
        """

        # è¾“å…¥æ¡†æ ·å¼ - é™ä½é«˜åº¦/å†…è¾¹è·ï¼Œé¿å…å‹å­—
        input_style = """
            QLineEdit, QComboBox, QSpinBox {
                background: #FFFFFF;
                border: 2px solid #666666;
                border-radius: 6px;
                padding: 4px 8px;   /* ä¸Šä¸‹å†…è¾¹è·å‡åŠï¼Œä½¿é«˜åº¦æ›´çŸ® */
                color: #000000;
                font-size: 14px;    /* å­—ä½“ç•¥å°ï¼Œé¿å…æ–‡æœ¬è¢«å‹ */
                font-family: 'Microsoft YaHei';
                min-height: 22px;   /* æ§ä»¶æ›´çŸ® */
            }
            QLineEdit:focus, QComboBox:focus, QSpinBox:focus {
                border-color: #FFD700;
                background: #FFFACD;
            }
        """

        # ç¬¬ä¸€è¡Œï¼šå§“åï¼ˆçŸ­ï¼‰+ æ€§åˆ«
        row1_layout = QHBoxLayout()
        row1_layout.setSpacing(20)

        name_label = QLabel("ğŸ‘¤ å§“å:")
        name_label.setStyleSheet(label_style)
        row1_layout.addWidget(name_label)

        self.name_edit = QLineEdit()
        self.name_edit.setPlaceholderText("è¯·è¾“å…¥å§“å")
        self.name_edit.setFixedWidth(150)  # ç•¥æ”¾å®½ï¼Œé¿å…å‹å­—
        self.name_edit.setStyleSheet(input_style)
        row1_layout.addWidget(self.name_edit)

        gender_label = QLabel("âš¥ æ€§åˆ«:")
        gender_label.setStyleSheet(label_style)
        row1_layout.addWidget(gender_label)

        self.gender_combo = QComboBox()
        self.gender_combo.addItems(["ç”·", "å¥³"])
        self.gender_combo.setFixedWidth(80)  # çŸ­ä¸€ç‚¹çš„æ€§åˆ«é€‰æ‹©
        self.gender_combo.setStyleSheet(input_style)
        row1_layout.addWidget(self.gender_combo)

        row1_layout.addStretch()  # æ·»åŠ å¼¹æ€§ç©ºé—´
        bazi_input_layout.addLayout(row1_layout)

        # ç¬¬äºŒè¡Œï¼šå†œå†å¹´æœˆæ—¥ä¸€è¡Œæ˜¾ç¤º
        row2_layout = QHBoxLayout()
        row2_layout.setSpacing(20)

        birth_label = QLabel("ğŸ“… å†œå†:")
        birth_label.setStyleSheet(label_style)
        row2_layout.addWidget(birth_label)

        # å¹´ä»½
        self.birth_year = QSpinBox()
        self.birth_year.setRange(1900, 2100)
        self.birth_year.setValue(1990)
        self.birth_year.setSuffix("å¹´")
        self.birth_year.setFixedWidth(100)  # å›ºå®šå®½åº¦
        self.birth_year.setStyleSheet(input_style)
        row2_layout.addWidget(self.birth_year)

        # æœˆä»½
        self.birth_month = QComboBox()
        lunar_months = ["æ­£æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ",
                       "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "å†¬æœˆ", "è…Šæœˆ"]
        self.birth_month.addItems(lunar_months)
        self.birth_month.setFixedWidth(80)  # å›ºå®šå®½åº¦
        self.birth_month.setStyleSheet(input_style)
        row2_layout.addWidget(self.birth_month)

        # æ—¥æœŸ
        self.birth_day = QComboBox()
        lunar_days = ["åˆä¸€", "åˆäºŒ", "åˆä¸‰", "åˆå››", "åˆäº”", "åˆå…­", "åˆä¸ƒ", "åˆå…«", "åˆä¹", "åˆå",
                     "åä¸€", "åäºŒ", "åä¸‰", "åå››", "åäº”", "åå…­", "åä¸ƒ", "åå…«", "åä¹", "äºŒå",
                     "å»¿ä¸€", "å»¿äºŒ", "å»¿ä¸‰", "å»¿å››", "å»¿äº”", "å»¿å…­", "å»¿ä¸ƒ", "å»¿å…«", "å»¿ä¹", "ä¸‰å"]
        self.birth_day.addItems(lunar_days)
        self.birth_day.setFixedWidth(80)  # å›ºå®šå®½åº¦
        self.birth_day.setStyleSheet(input_style)
        row2_layout.addWidget(self.birth_day)

        # é—°æœˆé€‰æ‹©
        self.leap_month = QCheckBox("é—°æœˆ")
        self.leap_month.setStyleSheet("QCheckBox { font-size: 16px; color: #FFD700; font-weight: bold; font-family: 'Microsoft YaHei'; }")
        row2_layout.addWidget(self.leap_month)

        row2_layout.addStretch()  # æ·»åŠ å¼¹æ€§ç©ºé—´
        bazi_input_layout.addLayout(row2_layout)

        # ç¬¬ä¸‰è¡Œï¼šæ—¶è¾°ä¸ç²¾ç¡®æ—¶é—´ä¸€è¡Œæ˜¾ç¤º
        row3_layout = QHBoxLayout()
        row3_layout.setSpacing(12)  # è¡Œé—´è·æ›´ç´§å‡‘ï¼Œé¿å…é‡å 

        # æ—¶è¾°é€‰æ‹©
        time_label = QLabel("â° æ—¶è¾°:")
        time_label.setStyleSheet(label_style)
        row3_layout.addWidget(time_label)

        self.hour_combo = QComboBox()
        shichen_list = [
            "å­æ—¶(23:00-1:00)", "ä¸‘æ—¶(1:00-3:00)", "å¯…æ—¶(3:00-5:00)", "å¯æ—¶(5:00-7:00)",
            "è¾°æ—¶(7:00-9:00)", "å·³æ—¶(9:00-11:00)", "åˆæ—¶(11:00-13:00)", "æœªæ—¶(13:00-15:00)",
            "ç”³æ—¶(15:00-17:00)", "é…‰æ—¶(17:00-19:00)", "æˆŒæ—¶(19:00-21:00)", "äº¥æ—¶(21:00-23:00)"
        ]
        self.hour_combo.addItems(shichen_list)
        self.hour_combo.setFixedWidth(170)  # ç¼©çŸ­çº¦3-4å­—å®½ï¼Œä»ä¸å‹æ¡†
        self.hour_combo.setStyleSheet(input_style)
        row3_layout.addWidget(self.hour_combo)

        # ç²¾ç¡®æ—¶é—´
        precise_label = QLabel("ğŸ• ç²¾ç¡®:")
        precise_label.setStyleSheet(label_style)
        row3_layout.addWidget(precise_label)

        self.precise_hour = QSpinBox()
        self.precise_hour.setRange(0, 23)
        self.precise_hour.setValue(9)
        self.precise_hour.setSuffix("æ—¶")
        self.precise_hour.setFixedWidth(80)  # åŠ é•¿çº¦äºŒæ±‰å­—å®½åº¦
        self.precise_hour.setStyleSheet(input_style)
        row3_layout.addWidget(self.precise_hour)

        self.precise_minute = QSpinBox()
        self.precise_minute.setRange(0, 59)
        self.precise_minute.setValue(30)
        self.precise_minute.setSuffix("åˆ†")
        self.precise_minute.setFixedWidth(80)  # åŠ é•¿çº¦äºŒæ±‰å­—å®½åº¦
        self.precise_minute.setStyleSheet(input_style)
        row3_layout.addWidget(self.precise_minute)

        row3_layout.addStretch()  # æ·»åŠ å¼¹æ€§ç©ºé—´
        bazi_input_layout.addLayout(row3_layout)

        # ç¬¬å››è¡Œï¼šå‡ºç”Ÿåœ°ç‚¹
        row4_layout = QHBoxLayout()
        row4_layout.setSpacing(20)

        location_label = QLabel("ğŸŒ åœ°ç‚¹:")
        location_label.setStyleSheet(label_style)
        row4_layout.addWidget(location_label)

        # çœä»½
        self.birth_province = QComboBox()
        provinces = ["åŒ—äº¬å¸‚", "ä¸Šæµ·å¸‚", "å¤©æ´¥å¸‚", "é‡åº†å¸‚", "æ²³åŒ—çœ", "å±±è¥¿çœ", "è¾½å®çœ", "å‰æ—çœ",
                    "é»‘é¾™æ±Ÿçœ", "æ±Ÿè‹çœ", "æµ™æ±Ÿçœ", "å®‰å¾½çœ", "ç¦å»ºçœ", "æ±Ÿè¥¿çœ", "å±±ä¸œçœ", "æ²³å—çœ",
                    "æ¹–åŒ—çœ", "æ¹–å—çœ", "å¹¿ä¸œçœ", "æµ·å—çœ", "å››å·çœ", "è´µå·çœ", "äº‘å—çœ", "é™•è¥¿çœ",
                    "ç”˜è‚ƒçœ", "é’æµ·çœ", "å°æ¹¾çœ", "å†…è’™å¤", "å¹¿è¥¿", "è¥¿è—", "å®å¤", "æ–°ç–†", "é¦™æ¸¯", "æ¾³é—¨"]
        self.birth_province.addItems(provinces)
        self.birth_province.setFixedWidth(110)  # æ”¶çª„
        self.birth_province.setStyleSheet(input_style)
        row4_layout.addWidget(self.birth_province)

        # åŸå¸‚
        self.birth_city = QComboBox()
        self.birth_city.addItem("è¯·é€‰æ‹©åŸå¸‚")
        self.birth_city.setFixedWidth(130)  # ç¨æ”¾å®½ï¼Œé¿å…å‹å­—
        self.birth_city.setStyleSheet(input_style)
        row4_layout.addWidget(self.birth_city)
        # è¿æ¥çœä»½/åŸå¸‚äº‹ä»¶ï¼Œå¹¶ç«‹å³å¡«å……åŸå¸‚åˆ—è¡¨ï¼ˆæ‹©æ—¥ç•Œé¢ä½¿ç”¨æœ¬åœ°å®Œæ•´åº“ï¼Œé¿å…è·¨ç±»å¼•ç”¨ï¼‰
        def _zheri_city_db():
            return {
                "åŒ—äº¬å¸‚": {"cities": ["åŒ—äº¬", "æœé˜³", "æµ·æ·€", "ä¸°å°", "çŸ³æ™¯å±±", "é—¨å¤´æ²Ÿ", "æˆ¿å±±", "é€šå·", "é¡ºä¹‰", "æ˜Œå¹³", "å¤§å…´", "æ€€æŸ”", "å¹³è°·", "å¯†äº‘", "å»¶åº†"]},
                "ä¸Šæµ·å¸‚": {"cities": ["ä¸Šæµ·", "é»„æµ¦", "å¾æ±‡", "é•¿å®", "é™å®‰", "æ™®é™€", "è™¹å£", "æ¨æµ¦", "é—µè¡Œ", "å®å±±", "å˜‰å®š", "æµ¦ä¸œ", "é‡‘å±±", "æ¾æ±Ÿ", "é’æµ¦", "å¥‰è´¤", "å´‡æ˜"]},
                "å¤©æ´¥å¸‚": {"cities": ["å¤©æ´¥", "å’Œå¹³", "æ²³ä¸œ", "æ²³è¥¿", "å—å¼€", "æ²³åŒ—", "çº¢æ¡¥", "ä¸œä¸½", "è¥¿é’", "æ´¥å—", "åŒ—è¾°", "æ­¦æ¸…", "å®å»", "æ»¨æµ·", "å®æ²³", "é™æµ·", "è“Ÿå·"]},
                "é‡åº†å¸‚": {"cities": ["é‡åº†", "ä¸‡å·", "æ¶ªé™µ", "æ¸ä¸­", "å¤§æ¸¡å£", "æ±ŸåŒ—", "æ²™åªå", "ä¹é¾™å¡", "å—å²¸", "åŒ—ç¢š", "ç¶¦æ±Ÿ", "å¤§è¶³", "æ¸åŒ—", "å·´å—", "é»”æ±Ÿ", "é•¿å¯¿", "æ±Ÿæ´¥", "åˆå·", "æ°¸å·", "å—å·"]},
                "å¹¿ä¸œçœ": {"cities": ["å¹¿å·", "æ·±åœ³", "ç æµ·", "æ±•å¤´", "ä½›å±±", "éŸ¶å…³", "æ¹›æ±Ÿ", "è‚‡åº†", "æ±Ÿé—¨", "èŒ‚å", "æƒ å·", "æ¢…å·", "æ±•å°¾", "æ²³æº", "é˜³æ±Ÿ", "æ¸…è¿œ", "ä¸œè", "ä¸­å±±", "æ½®å·", "æ­é˜³", "äº‘æµ®"]},
                "æ±Ÿè‹çœ": {"cities": ["å—äº¬", "æ— é”¡", "å¾å·", "å¸¸å·", "è‹å·", "å—é€š", "è¿äº‘æ¸¯", "æ·®å®‰", "ç›åŸ", "æ‰¬å·", "é•‡æ±Ÿ", "æ³°å·", "å®¿è¿"]},
                "æµ™æ±Ÿçœ": {"cities": ["æ­å·", "å®æ³¢", "æ¸©å·", "å˜‰å…´", "æ¹–å·", "ç»å…´", "é‡‘å", "è¡¢å·", "èˆŸå±±", "å°å·", "ä¸½æ°´"]},
                "å±±ä¸œçœ": {"cities": ["æµå—", "é’å²›", "æ·„åš", "æ£åº„", "ä¸œè¥", "çƒŸå°", "æ½åŠ", "æµå®", "æ³°å®‰", "å¨æµ·", "æ—¥ç…§", "ä¸´æ²‚", "å¾·å·", "èŠåŸ", "æ»¨å·", "èæ³½"]},
                "æ²³å—çœ": {"cities": ["éƒ‘å·", "å¼€å°", "æ´›é˜³", "å¹³é¡¶å±±", "å®‰é˜³", "é¹¤å£", "æ–°ä¹¡", "ç„¦ä½œ", "æ¿®é˜³", "è®¸æ˜Œ", "æ¼¯æ²³", "ä¸‰é—¨å³¡", "å—é˜³", "å•†ä¸˜", "ä¿¡é˜³", "å‘¨å£", "é©»é©¬åº—", "æµæº"]},
                "å››å·çœ": {"cities": ["æˆéƒ½", "è‡ªè´¡", "æ”€æèŠ±", "æ³¸å·", "å¾·é˜³", "ç»µé˜³", "å¹¿å…ƒ", "é‚å®", "å†…æ±Ÿ", "ä¹å±±", "å—å……", "çœ‰å±±", "å®œå®¾", "å¹¿å®‰", "è¾¾å·", "é›…å®‰", "å·´ä¸­", "èµ„é˜³"]},
                "æ¹–åŒ—çœ": {"cities": ["æ­¦æ±‰", "é»„çŸ³", "åå °", "å®œæ˜Œ", "è¥„é˜³", "é„‚å·", "è†é—¨", "å­æ„Ÿ", "è†å·", "é»„å†ˆ", "å’¸å®", "éšå·", "æ©æ–½"]},
                "æ¹–å—çœ": {"cities": ["é•¿æ²™", "æ ªæ´²", "æ¹˜æ½­", "è¡¡é˜³", "é‚µé˜³", "å²³é˜³", "å¸¸å¾·", "å¼ å®¶ç•Œ", "ç›Šé˜³", "éƒ´å·", "æ°¸å·", "æ€€åŒ–", "å¨„åº•", "æ¹˜è¥¿"]},
                "æ²³åŒ—çœ": {"cities": ["çŸ³å®¶åº„", "å”å±±", "ç§¦çš‡å²›", "é‚¯éƒ¸", "é‚¢å°", "ä¿å®š", "å¼ å®¶å£", "æ‰¿å¾·", "æ²§å·", "å»ŠåŠ", "è¡¡æ°´"]},
                "å±±è¥¿çœ": {"cities": ["å¤ªåŸ", "å¤§åŒ", "é˜³æ³‰", "é•¿æ²»", "æ™‹åŸ", "æœ”å·", "æ™‹ä¸­", "è¿åŸ", "å¿»å·", "ä¸´æ±¾", "å•æ¢"]},
                "è¾½å®çœ": {"cities": ["æ²ˆé˜³", "å¤§è¿", "éå±±", "æŠšé¡º", "æœ¬æºª", "ä¸¹ä¸œ", "é”¦å·", "è¥å£", "é˜œæ–°", "è¾½é˜³", "ç›˜é”¦", "é“å²­", "æœé˜³", "è‘«èŠ¦å²›"]},
                "å‰æ—çœ": {"cities": ["é•¿æ˜¥", "å‰æ—", "å››å¹³", "è¾½æº", "é€šåŒ–", "ç™½å±±", "æ¾åŸ", "ç™½åŸ", "å»¶è¾¹"]},
                "é»‘é¾™æ±Ÿçœ": {"cities": ["å“ˆå°”æ»¨", "é½é½å“ˆå°”", "ç‰¡ä¸¹æ±Ÿ", "ä½³æœ¨æ–¯", "å¤§åº†", "ä¼Šæ˜¥", "ä¸ƒå°æ²³", "é¸¡è¥¿", "é¹¤å²—", "åŒé¸­å±±", "é»‘æ²³", "ç»¥åŒ–", "å¤§å…´å®‰å²­"]},
                "å®‰å¾½çœ": {"cities": ["åˆè‚¥", "èŠœæ¹–", "èšŒåŸ ", "æ·®å—", "é©¬éå±±", "æ·®åŒ—", "é“œé™µ", "å®‰åº†", "é»„å±±", "æ»å·", "é˜œé˜³", "å®¿å·", "å…­å®‰", "äº³å·", "æ± å·", "å®£åŸ"]},
                "ç¦å»ºçœ": {"cities": ["ç¦å·", "å¦é—¨", "è†ç”°", "ä¸‰æ˜", "æ³‰å·", "æ¼³å·", "å—å¹³", "é¾™å²©", "å®å¾·"]},
                "æ±Ÿè¥¿çœ": {"cities": ["å—æ˜Œ", "æ™¯å¾·é•‡", "èä¹¡", "ä¹æ±Ÿ", "æ–°ä½™", "é¹°æ½­", "èµ£å·", "å‰å®‰", "å®œæ˜¥", "æŠšå·", "ä¸Šé¥¶"]},
                "æµ·å—çœ": {"cities": ["æµ·å£", "ä¸‰äºš", "ä¸‰æ²™", "å„‹å·", "ç¼æµ·", "æ–‡æ˜Œ", "ä¸‡å®", "ä¸œæ–¹", "äº”æŒ‡å±±", "æ¾„è¿ˆ", "ä¸´é«˜", "é™µæ°´", "ä¹ä¸œ", "å®šå®‰", "å±¯æ˜Œ", "ç™½æ²™", "æ˜Œæ±Ÿ", "ä¿äº­", "ç¼ä¸­"]},
                "äº‘å—çœ": {"cities": ["æ˜†æ˜", "æ›²é–", "ç‰æºª", "ä¿å±±", "æ˜­é€š", "ä¸½æ±Ÿ", "æ™®æ´±", "ä¸´æ²§", "æ¥šé›„", "çº¢æ²³", "æ–‡å±±", "è¥¿åŒç‰ˆçº³", "å¤§ç†", "å¾·å®", "æ€’æ±Ÿ", "è¿ªåº†"]},
                "è´µå·çœ": {"cities": ["è´µé˜³", "å…­ç›˜æ°´", "éµä¹‰", "å®‰é¡º", "æ¯•èŠ‚", "é“œä»", "é»”è¥¿å—", "é»”ä¸œå—", "é»”å—"]},
                "é™•è¥¿çœ": {"cities": ["è¥¿å®‰", "é“œå·", "å®é¸¡", "å’¸é˜³", "æ¸­å—", "å»¶å®‰", "æ±‰ä¸­", "æ¦†æ—", "å®‰åº·", "å•†æ´›"]},
                "ç”˜è‚ƒçœ": {"cities": ["å…°å·", "å˜‰å³ªå…³", "é‡‘æ˜Œ", "ç™½é“¶", "å¤©æ°´", "æ­¦å¨", "å¼ æ–", "å¹³å‡‰", "é…’æ³‰", "åº†é˜³", "å®šè¥¿", "é™‡å—", "ä¸´å¤", "ç”˜å—"]},
                "é’æµ·çœ": {"cities": ["è¥¿å®", "æµ·ä¸œ", "æµ·åŒ—", "é»„å—", "æµ·å—", "æœæ´›", "ç‰æ ‘", "æµ·è¥¿"]},
                "å°æ¹¾çœ": {"cities": ["å°åŒ—", "æ–°åŒ—", "æ¡ƒå›­", "å°ä¸­", "å°å—", "é«˜é›„", "æ–°ç«¹", "å˜‰ä¹‰"]},
                "å†…è’™å¤": {"cities": ["å‘¼å’Œæµ©ç‰¹", "åŒ…å¤´", "ä¹Œæµ·", "èµ¤å³°", "é€šè¾½", "é„‚å°”å¤šæ–¯", "å‘¼ä¼¦è´å°”", "å·´å½¦æ·–å°”", "ä¹Œå…°å¯Ÿå¸ƒ", "å…´å®‰", "é”¡æ—éƒ­å‹’", "é˜¿æ‹‰å–„"]},
                "å¹¿è¥¿": {"cities": ["å—å®", "æŸ³å·", "æ¡‚æ—", "æ¢§å·", "åŒ—æµ·", "é˜²åŸæ¸¯", "é’¦å·", "è´µæ¸¯", "ç‰æ—", "ç™¾è‰²", "è´ºå·", "æ²³æ± ", "æ¥å®¾", "å´‡å·¦"]},
                "è¥¿è—": {"cities": ["æ‹‰è¨", "æ—¥å–€åˆ™", "æ˜Œéƒ½", "æ—èŠ", "å±±å—", "é‚£æ›²", "é˜¿é‡Œ"]},
                "å®å¤": {"cities": ["é“¶å·", "çŸ³å˜´å±±", "å´å¿ ", "å›ºåŸ", "ä¸­å«"]},
                "æ–°ç–†": {"cities": ["ä¹Œé²æœ¨é½", "å…‹æ‹‰ç›ä¾", "åé²ç•ª", "å“ˆå¯†", "æ˜Œå‰", "åšå°”å¡”æ‹‰", "å·´éŸ³éƒ­æ¥", "é˜¿å…‹è‹", "å…‹å­œå‹’è‹", "å–€ä»€", "å’Œç”°", "ä¼ŠçŠ", "å¡”åŸ", "é˜¿å‹’æ³°"]},
                "é¦™æ¸¯": {"cities": ["é¦™æ¸¯"]},
                "æ¾³é—¨": {"cities": ["æ¾³é—¨"]}
            }
        def _zheri_on_province_changed(province_name: str):
            db = _zheri_city_db()
            self.birth_city.blockSignals(True)
            self.birth_city.clear()
            self.birth_city.addItem("è¯·é€‰æ‹©åŸå¸‚")
            cities = db.get(province_name, {}).get("cities", [])
            if cities:
                self.birth_city.addItems(sorted(cities))
            self.birth_city.blockSignals(False)
        # ç»‘å®šå¹¶é¦–æ¬¡å¡«å……
        self.birth_province.currentTextChanged.connect(_zheri_on_province_changed)
        _zheri_on_province_changed(self.birth_province.currentText())


        row4_layout.addStretch()  # æ·»åŠ å¼¹æ€§ç©ºé—´
        bazi_input_layout.addLayout(row4_layout)

        # å°†æ‰€æœ‰è¾“å…¥å¸ƒå±€æ·»åŠ åˆ°å…«å­—ç»„ï¼ˆä¿ç•™ç»„ä»¶ï¼Œä½†é»˜è®¤éšè—å®¹å™¨ï¼‰
        bazi_layout.addLayout(bazi_input_layout)
        left_layout.addWidget(self.bazi_group)
        self.bazi_group.setVisible(False)

        # ç¬¬äº”è¡Œï¼šäº‹ä»¶ç±»å‹
        row5_layout = QHBoxLayout()
        row5_layout.setSpacing(20)

        event_type_label = QLabel("ğŸ“‹ äº‹ä»¶:")
        event_type_label.setStyleSheet(label_style)
        row5_layout.addWidget(event_type_label)

        self.event_combo = QComboBox()
        self.event_combo.addItems([
            "ç»“å©šå«å¨¶", "å¼€ä¸šå¼€å¼ ", "æ¬å®¶å…¥å®…", "åŠ¨åœŸå»ºæˆ¿", "å‡ºè¡Œæ—…æ¸¸",
            "å®‰è‘¬ä¸‹è‘¬", "ç­¾çº¦åˆä½œ", "æ±‚å­¦è€ƒè¯•", "æ±‚åŒ»æ²»ç—…", "ç¥­ç¥€ç¥ˆç¦"
        ])
        self.event_combo.setFixedWidth(150)  # å›ºå®šåˆé€‚å®½åº¦
        self.event_combo.setStyleSheet(input_style)
        row5_layout.addWidget(self.event_combo)

        row5_layout.addStretch()  # æ·»åŠ å¼¹æ€§ç©ºé—´
        bazi_input_layout.addLayout(row5_layout)

        # ç¬¬å…­è¡Œï¼šäº‹ä»¶æè¿°
        row6_layout = QHBoxLayout()
        row6_layout.setSpacing(20)

        event_desc_label = QLabel("ğŸ“ æè¿°:")
        event_desc_label.setStyleSheet(label_style)
        row6_layout.addWidget(event_desc_label)

        self.event_desc_edit = QLineEdit()
        self.event_desc_edit.setPlaceholderText("å¯é€‰ï¼šè¯¦ç»†æè¿°å…·ä½“äº‹ä»¶")
        self.event_desc_edit.setFixedWidth(360)  # æ”¶çª„ä»¥é€‚é…é»„é‡‘æ¯”ä¾‹
        self.event_desc_edit.setStyleSheet(input_style)
        row6_layout.addWidget(self.event_desc_edit)

        row6_layout.addStretch()  # æ·»åŠ å¼¹æ€§ç©ºé—´
        bazi_input_layout.addLayout(row6_layout)

        # ç¬¬ä¸ƒè¡Œï¼šæ‹©æ—¥èŒƒå›´
        row7_layout = QHBoxLayout()
        row7_layout.setSpacing(20)

        # å¼€å§‹æ—¥æœŸ
        start_label = QLabel("ğŸ“… å¼€å§‹:")
        start_label.setStyleSheet(label_style)
        row7_layout.addWidget(start_label)

        self.start_date_edit = QDateEdit()
        self.start_date_edit.setDate(QDate.currentDate())
        self.start_date_edit.setCalendarPopup(True)
        self.start_date_edit.setFixedWidth(130)  # å›ºå®šåˆé€‚å®½åº¦
        # ä¸ºQDateEditæ·»åŠ ç‰¹æ®Šæ ·å¼
        date_style = """
            QDateEdit {
                background: #FFFFFF;
                border: 2px solid #666666;
                border-radius: 6px;
                padding: 4px 8px;
                color: #000000;
                font-size: 14px;
                font-family: 'Microsoft YaHei';
                min-height: 22px;
            }
            QDateEdit:focus {
                border-color: #FFD700;
                background: #FFFACD;
            }
        """
        self.start_date_edit.setStyleSheet(date_style)
        row7_layout.addWidget(self.start_date_edit)

        # ç»“æŸæ—¥æœŸ
        end_label = QLabel("ğŸ“… ç»“æŸ:")
        end_label.setStyleSheet(label_style)
        row7_layout.addWidget(end_label)

        self.end_date_edit = QDateEdit()
        self.end_date_edit.setDate(QDate.currentDate().addMonths(3))
        self.end_date_edit.setCalendarPopup(True)
        self.end_date_edit.setFixedWidth(130)  # å›ºå®šåˆé€‚å®½åº¦
        self.end_date_edit.setStyleSheet(date_style)
        row7_layout.addWidget(self.end_date_edit)

        # é¦–é€‰æ—¶è¾°é€‰æ‹©ï¼ˆæ˜¾ç¤ºå®Œæ•´æ—¶è¾°åˆ—è¡¨ï¼‰
        row7_layout = QHBoxLayout()
        row7_layout.setSpacing(12)

        preferred_label = QLabel("â° é¦–é€‰æ—¶è¾°:")
        preferred_label.setStyleSheet(label_style)
        row7_layout.addWidget(preferred_label)

        self.preferred_hour_combo = QComboBox()
        self.preferred_hour_combo.addItems([
            "ä¸é™æ—¶è¾°",
            "å­æ—¶(23:00-1:00)", "ä¸‘æ—¶(1:00-3:00)", "å¯…æ—¶(3:00-5:00)",
            "å¯æ—¶(5:00-7:00)", "è¾°æ—¶(7:00-9:00)", "å·³æ—¶(9:00-11:00)",
            "åˆæ—¶(11:00-13:00)", "æœªæ—¶(13:00-15:00)", "ç”³æ—¶(15:00-17:00)",
            "é…‰æ—¶(17:00-19:00)", "æˆŒæ—¶(19:00-21:00)", "äº¥æ—¶(21:00-23:00)"
        ])
        self.preferred_hour_combo.setFixedWidth(180)
        self.preferred_hour_combo.setStyleSheet(input_style)
        row7_layout.addWidget(self.preferred_hour_combo)

        row7_layout.addStretch()  # æ·»åŠ å¼¹æ€§ç©ºé—´
        bazi_input_layout.addLayout(row7_layout)

        # é»„é“å‰æ—¥æ¨¡å¼çš„è¾“å…¥ç•Œé¢
        self.general_group = QGroupBox("ğŸ“… æ‹©æ—¥ä¿¡æ¯")
        self.general_group.setStyleSheet("""
            QGroupBox {
                font-size: 18px;
                font-weight: bold;
                color: #FFD700;
                border: 2px solid #FFD700;
                border-radius: 8px;
                margin-top: 10px;
                padding-top: 10px;
                font-family: 'Microsoft YaHei';
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 10px;
                padding: 0 5px 0 5px;
            }
        """)
        general_layout = QVBoxLayout(self.general_group)
        general_layout.setSpacing(20)

        # äº‹ä»¶ç±»å‹è¡Œ
        event_row = QHBoxLayout()
        event_row.setSpacing(12)

        event_label = QLabel("ğŸ“‹ äº‹ä»¶:")
        event_label.setStyleSheet(label_style)
        event_row.addWidget(event_label)

        self.general_event_combo = QComboBox()
        self.general_event_combo.addItems([
            "ç»“å©šå«å¨¶", "å¼€ä¸šå¼€å¼ ", "æ¬å®¶å…¥å®…", "åŠ¨åœŸå»ºæˆ¿", "å‡ºè¡Œæ—…æ¸¸",
            "å®‰è‘¬ä¸‹è‘¬", "ç­¾çº¦åˆä½œ", "æ±‚å­¦è€ƒè¯•", "æ±‚åŒ»æ²»ç—…", "ç¥­ç¥€ç¥ˆç¦"
        ])
        self.general_event_combo.setFixedWidth(150)
        self.general_event_combo.setStyleSheet(input_style)
        event_row.addWidget(self.general_event_combo)

        event_row.addStretch()
        general_layout.addLayout(event_row)

        # æ‹©æ—¥èŒƒå›´è¡Œ
        date_range_row = QHBoxLayout()
        date_range_row.setSpacing(12)

        range_label = QLabel("ğŸ“… èŒƒå›´:")
        range_label.setStyleSheet(label_style)
        date_range_row.addWidget(range_label)

        self.general_start_date = QDateEdit()
        self.general_start_date.setDate(QDate.currentDate())
        self.general_start_date.setCalendarPopup(True)
        self.general_start_date.setFixedWidth(170)  # æ”¾å®½ï¼Œé¿å…è¢«å‹
        self.general_start_date.setStyleSheet(date_style)
        date_range_row.addWidget(self.general_start_date)

        to_label = QLabel("è‡³")
        to_label.setStyleSheet(label_style)
        date_range_row.addWidget(to_label)

        self.general_end_date = QDateEdit()
        self.general_end_date.setDate(QDate.currentDate().addMonths(3))
        self.general_end_date.setCalendarPopup(True)
        self.general_end_date.setFixedWidth(170)  # æ”¾å®½ï¼Œé¿å…è¢«å‹
        self.general_end_date.setStyleSheet(date_style)
        date_range_row.addWidget(self.general_end_date)

        date_range_row.addStretch()
        general_layout.addLayout(date_range_row)

        left_layout.addWidget(self.general_group)

        # åˆ†ææŒ‰é’®
        analyze_btn = QPushButton("ğŸ”® å¼€å§‹æ‹©æ—¥åˆ†æ")
        analyze_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A4A6A, stop:1 #4A2A4A);
                border: 2px solid #FF66AA;
                border-radius: 8px;
                color: #FFD700;
                font-weight: bold;
                padding: 15px;
                font-size: 16px;
                min-height: 20px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #8A6A8A, stop:1 #6A4A6A);
                border-color: #FF88CC;
            }
        """)
        left_layout.addWidget(analyze_btn)

        # æ·»åŠ å¼¹æ€§ç©ºé—´
        left_layout.addStretch()

        # å³ä¾§ç»“æœæ˜¾ç¤ºåŒºåŸŸ
        right_widget = QWidget()
        right_layout = QVBoxLayout(right_widget)

        result_title = QLabel("ğŸ“‹ æ‹©æ—¥åˆ†æç»“æœ")
        result_title.setAlignment(Qt.AlignCenter)
        result_title.setStyleSheet("""
            QLabel {
                font-size: 20px;
                font-weight: bold;
                color: #FFD700;
                margin: 20px;
                background: none;
                font-family: 'Microsoft YaHei';
            }
        """)
        right_layout.addWidget(result_title)

        # ç»“æœæ˜¾ç¤º - ç¡®ä¿å­—ä½“æ ·å¼ç”Ÿæ•ˆ
        result_text = QTextEdit()
        result_text.setReadOnly(True)
        result_text.setPlaceholderText("è¯·é€‰æ‹©æ‹©æ—¥æ¨¡å¼å¹¶å¡«å†™ç›¸å…³ä¿¡æ¯ï¼Œç„¶åç‚¹å‡»ã€å¼€å§‹æ‹©æ—¥åˆ†æã€‘æŒ‰é’®...")

        # è®¾ç½®å­—ä½“ - åŒé‡ä¿é™©
        font = QFont("Microsoft YaHei", 18)  # ç›´æ¥è®¾ç½®18å·å­—ä½“
        font.setBold(False)
        result_text.setFont(font)

        # CSSæ ·å¼ - ç¡®ä¿å­—ä½“å¤§å°ç”Ÿæ•ˆ
        result_text.setStyleSheet("""
            QTextEdit {
                background-color: #2A2A2A;
                border: 3px solid #FFD700;
                border-radius: 10px;
                color: #FFD700;
                font-family: 'Microsoft YaHei';
                font-size: 18px;
                font-weight: normal;
                selection-background-color: #FFD700;
                selection-color: #000000;
                padding: 20px;
                line-height: 1.6;
            }
            QTextEdit::placeholder {
                color: #888888;
                font-size: 18px;
            }
        """)

        right_layout.addWidget(result_text)

        # å°†å·¦å³åŒºåŸŸæ·»åŠ åˆ°ä¸»å¸ƒå±€ï¼šå„å ä¸€åŠ
        main_layout.addWidget(left_widget, 1)
        main_layout.addWidget(right_widget, 1)

        # äº‹ä»¶å¤„ç†å‡½æ•°
        def on_mode_changed():
            """æ‹©æ—¥æ¨¡å¼æ”¹å˜æ—¶çš„å¤„ç†"""
            # å…«å­—æ‹©æ—¥æ¨¡å¼æ—¶æ˜¾ç¤ºå…«å­—è¾“å…¥ï¼Œé»„é“å‰æ—¥æ¨¡å¼æ—¶æ˜¾ç¤ºé€šç”¨è¾“å…¥
            is_bazi_mode = self.bazi_mode_radio.isChecked()
            self.bazi_group.setVisible(is_bazi_mode)
            self.general_group.setVisible(not is_bazi_mode)

        # è¿æ¥æ¨¡å¼åˆ‡æ¢ä¿¡å·
        self.bazi_mode_radio.toggled.connect(on_mode_changed)
        self.general_mode_radio.toggled.connect(on_mode_changed)

        # åˆå§‹åŒ–ç•Œé¢çŠ¶æ€
        on_mode_changed()

        def perform_zheri_analysis():
            """æ‰§è¡Œæ‹©æ—¥åˆ†æ"""
            try:
                # æ ¹æ®æ¨¡å¼è·å–ä¸åŒçš„ä¿¡æ¯
                if self.bazi_mode_radio.isChecked():
                    # å…«å­—æ‹©æ—¥æ¨¡å¼
                    event_type = self.event_combo.currentText()
                    event_desc = self.event_desc_edit.text()
                    start_date = self.start_date_edit.date().toPyDate()
                    end_date = self.end_date_edit.date().toPyDate()
                else:
                    # é»„é“å‰æ—¥æ¨¡å¼
                    event_type = self.general_event_combo.currentText()
                    event_desc = ""  # é»„é“å‰æ—¥æ¨¡å¼ä¸éœ€è¦è¯¦ç»†æè¿°
                    start_date = self.general_start_date.date().toPyDate()
                    end_date = self.general_end_date.date().toPyDate()
                preferred_hour = self.preferred_hour_combo.currentText()

                # æ ¹æ®æ¨¡å¼è¿›è¡Œåˆ†æ
                if self.general_mode_radio.isChecked():
                    # é»„é“å‰æ—¥æ¨¡å¼
                    result = self.analyze_general_auspicious_dates(
                        event_type, start_date, end_date, preferred_hour, event_desc
                    )
                else:
                    # å…«å­—æ‹©æ—¥æ¨¡å¼ - ç›´æ¥ä½¿ç”¨è¾“å…¥çš„å…«å­—ä¿¡æ¯
                    name = self.name_edit.text()
                    if not name:
                        result_text.setText("âŒ è¯·è¾“å…¥å§“å")
                        return

                    # è·å–å…«å­—ä¿¡æ¯
                    year = self.birth_year.value()
                    month_index = self.birth_month.currentIndex() + 1  # å†œå†æœˆä»½
                    day_index = self.birth_day.currentIndex() + 1     # å†œå†æ—¥æœŸ
                    hour_text = self.hour_combo.currentText()
                    hour = self.parse_hour_from_text(hour_text)
                    gender = self.gender_combo.currentText()
                    location = f"{self.birth_province.currentText()}{self.birth_city.currentText()}"

                    # è®¡ç®—å…«å­—
                    bazi_result = self.calculate_bazi_info(name, gender, year, month_index, day_index, hour, location)

                    if bazi_result:
                        result = self.analyze_bazi_auspicious_dates(
                            event_type, bazi_result, start_date, end_date, preferred_hour, event_desc
                        )
                    else:
                        result = "âŒ å…«å­—è®¡ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯"

                result_text.setText(result)

            except Exception as e:
                import traceback
                error_msg = f"âŒ æ‹©æ—¥åˆ†æå‡ºé”™ï¼š{str(e)}\n{traceback.format_exc()}"
                result_text.setText(error_msg)
                print(error_msg)  # åŒæ—¶æ‰“å°åˆ°æ§åˆ¶å°

        # è¿æ¥ä¿¡å·
        analyze_btn.clicked.connect(perform_zheri_analysis)

        # åº•éƒ¨å…³é—­æŒ‰é’®
        bottom_layout = QHBoxLayout()
        bottom_layout.addStretch()
        close_btn = QPushButton("âŒ å…³é—­çª—å£")
        close_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #8B4513, stop:1 #654321);
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFD700;
                font-weight: bold;
                padding: 10px 20px;
                font-size: 14px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #A0522D, stop:1 #8B4513);
                border-color: #FFA500;
            }
        """)
        close_btn.clicked.connect(dialog.accept)
        bottom_layout.addWidget(close_btn)
        bottom_layout.addStretch()

        # åˆ›å»ºåº•éƒ¨å®¹å™¨å¹¶æ·»åŠ åˆ°ä¸»å¸ƒå±€
        bottom_widget = QWidget()
        bottom_widget.setLayout(bottom_layout)

        # åˆ›å»ºå‚ç›´å¸ƒå±€å®¹å™¨åŒ…å«ä¸»å¸ƒå±€å’Œåº•éƒ¨æŒ‰é’®
        container_layout = QVBoxLayout()
        container_layout.addLayout(main_layout)
        container_layout.addWidget(bottom_widget)

        dialog.setLayout(container_layout)
        dialog.exec_()

    def _parse_hour_to_start_time(self, hour_text):
        """ä»æ—¶è¾°æ–‡æœ¬è§£æä¸ºèµ·å§‹å°æ—¶æ•°ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰"""
        hour_map = {
            "å­æ—¶(23:00-1:00)": 0,
            "ä¸‘æ—¶(1:00-3:00)": 1,
            "å¯…æ—¶(3:00-5:00)": 3,
            "å¯æ—¶(5:00-7:00)": 5,
            "è¾°æ—¶(7:00-9:00)": 7,
            "å·³æ—¶(9:00-11:00)": 9,
            "åˆæ—¶(11:00-13:00)": 11,
            "æœªæ—¶(13:00-15:00)": 13,
            "ç”³æ—¶(15:00-17:00)": 15,
            "é…‰æ—¶(17:00-19:00)": 17,
            "æˆŒæ—¶(19:00-21:00)": 19,
            "äº¥æ—¶(21:00-23:00)": 21
        }
        return hour_map.get(hour_text, 0)

    def analyze_general_auspicious_dates(self, event_type, start_date, end_date, preferred_hour, event_desc=""):
        """åˆ†æé»„é“å‰æ—¥ï¼ˆä¸éœ€è¦å…«å­—ï¼‰"""
        analysis = []
        analysis.append("ã€é»„é“å‰æ—¥åˆ†æã€‘")
        analysis.append("åŸºäºä¼ ç»Ÿé»„å†ç†è®ºï¼Œä¸ä¾èµ–ä¸ªäººå…«å­—")
        analysis.append("")

        # äº‹ä»¶ç±»å‹åˆ†æ
        analysis.append(f"ğŸ“… æ‹©æ—¥äº‹ä»¶ï¼š{event_type}")
        if event_desc:
            analysis.append(f"ğŸ“ äº‹ä»¶æè¿°ï¼š{event_desc}")
        analysis.append(f"ğŸ“† æ‹©æ—¥èŒƒå›´ï¼š{start_date} è‡³ {end_date}")
        if preferred_hour != "ä¸é™":
            analysis.append(f"â° é¦–é€‰æ—¶è¾°ï¼š{preferred_hour}")
        analysis.append("")

        # é»„é“å‰æ—¥åŸç†
        analysis.append("ã€é»„é“å‰æ—¥åŸç†ã€‘")
        analysis.append("â€¢ ä»¥äºŒåå…«å®¿è½®å€¼ä¸ºåŸºç¡€")
        analysis.append("â€¢ ç»“åˆå»ºé™¤åäºŒç¥")
        analysis.append("â€¢ é¿å¼€å„ç§å‡¶ç…æ—¥")
        analysis.append("â€¢ é€‰æ‹©å¤©å¾·ã€æœˆå¾·ç­‰å‰ç¥å½“å€¼æ—¥")
        analysis.append("")

        # é€šç”¨å‰æ—¥æ¨è
        analysis.extend(self.get_general_auspicious_dates(event_type, start_date, end_date))

        # æ—¶è¾°å»ºè®®
        analysis.extend(self.get_general_auspicious_hours(event_type, preferred_hour))

        # æ³¨æ„äº‹é¡¹
        analysis.append("\nã€æ³¨æ„äº‹é¡¹ã€‘")
        analysis.append("â€¢ é»„é“å‰æ—¥ä¸ºé€šç”¨å‰æ—¥ï¼Œé€‚åˆå¤§å¤šæ•°äºº")
        analysis.append("â€¢ å¦‚éœ€æ›´ç²¾å‡†çš„æ‹©æ—¥ï¼Œå»ºè®®ä½¿ç”¨å…«å­—æ‹©æ—¥")
        analysis.append("â€¢ é‡è¦äº‹ä»¶å»ºè®®å’¨è¯¢ä¸“ä¸šæ‹©æ—¥å¸ˆ")
        analysis.append("â€¢ æ‹©æ—¥åªæ˜¯è¾…åŠ©ï¼Œä¸ªäººåŠªåŠ›æ›´é‡è¦")

        return "\n".join(analysis)

    def analyze_bazi_auspicious_dates(self, event_type, bazi_result, start_date, end_date, preferred_hour, event_desc=""):
        """åˆ†æå…«å­—æ‹©æ—¥ï¼ˆéœ€è¦å…«å­—ï¼‰"""
        analysis = []
        analysis.append("ã€å…«å­—æ‹©æ—¥åˆ†æã€‘")
        analysis.append("åŸºäºä¸ªäººå…«å­—çš„ä¸“ä¸šæ‹©æ—¥åˆ†æ")
        analysis.append("")

        # ä¸ªäººä¿¡æ¯
        name = bazi_result.get('name', 'æœªçŸ¥')
        gender = bazi_result.get('gender', 'æœªçŸ¥')
        pillars = bazi_result.get('pillars', {})

        analysis.append(f"ğŸ‘¤ å§“åï¼š{name}")
        analysis.append(f"âš¥ æ€§åˆ«ï¼š{gender}")
        analysis.append(f"ğŸ”® å…«å­—ï¼š{pillars.get('year', '')} {pillars.get('month', '')} {pillars.get('day', '')} {pillars.get('hour', '')}")
        analysis.append("")

        # äº‹ä»¶ä¿¡æ¯
        analysis.append(f"ğŸ“… æ‹©æ—¥äº‹ä»¶ï¼š{event_type}")
        if event_desc:
            analysis.append(f"ğŸ“ äº‹ä»¶æè¿°ï¼š{event_desc}")
        analysis.append(f"ğŸ“† æ‹©æ—¥èŒƒå›´ï¼š{start_date} è‡³ {end_date}")
        if preferred_hour != "ä¸é™":
            analysis.append(f"â° é¦–é€‰æ—¶è¾°ï¼š{preferred_hour}")
        analysis.append("")

        # è°ƒç”¨æ‹©æ—¥åˆ†æå‡½æ•°ï¼ˆå…¼å®¹ï¼šè‹¥å½“å‰ç±»æ— è¯¥æ–¹æ³•åˆ™å›é€€åˆ° BaziSuanmingWindow çš„å®ç°ï¼‰
        try:
            if hasattr(self, 'analyze_auspicious_dates'):
                detailed_analysis = self.analyze_auspicious_dates(event_type, bazi_result, start_date, end_date)
            else:
                analyzer = BaziSuanmingWindow(None)
                detailed_analysis = analyzer.analyze_auspicious_dates(event_type, bazi_result, start_date, end_date)
        except Exception as _e:
            detailed_analysis = f"âš ï¸ æ·±åº¦æ‹©æ—¥æ¨¡å—æš‚ä¸å¯ç”¨ï¼š{_e}"
        analysis.append(detailed_analysis)

        return "\n".join(analysis)

    def get_general_auspicious_dates(self, event_type, start_date, end_date):
        """è·å–é€šç”¨é»„é“å‰æ—¥"""
        analysis = []
        analysis.append("ã€æ¨èå‰æ—¥ã€‘")

        # è¿™é‡Œå¯ä»¥å®ç°å…·ä½“çš„é»„é“å‰æ—¥è®¡ç®—é€»è¾‘
        # æš‚æ—¶æä¾›ç¤ºä¾‹
        from datetime import datetime, timedelta

        current_date = start_date
        recommended_dates = []

        while current_date <= end_date and len(recommended_dates) < 10:
            # ç®€å•çš„å‰æ—¥åˆ¤æ–­é€»è¾‘ï¼ˆå¯ä»¥æ‰©å±•ï¼‰
            day_of_week = current_date.weekday()
            day_of_month = current_date.day

            # é¿å¼€ä¸€äº›ä¼ ç»Ÿå¿Œæ—¥
            if day_of_week not in [3, 6] and day_of_month not in [4, 14, 24]:  # é¿å¼€å‘¨å››ã€å‘¨æ—¥å’Œ4ã€14ã€24æ—¥
                score = self.calculate_date_score(current_date, event_type)
                if score >= 70:
                    recommended_dates.append((current_date, score))

            current_date += timedelta(days=1)

        # æŒ‰è¯„åˆ†æ’åº
        recommended_dates.sort(key=lambda x: x[1], reverse=True)

        for i, (date, score) in enumerate(recommended_dates[:5]):
            weekday_names = ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­", "å‘¨æ—¥"]
            weekday = weekday_names[date.weekday()]

            # è·å–å†œå†ä¿¡æ¯
            lunar_info = self.get_lunar_date_info(date)
            lunar_str = lunar_info['description']

            analysis.append(f"â€¢ {date.strftime('%Yå¹´%mæœˆ%dæ—¥')} ({weekday}) {lunar_str} - è¯„åˆ†ï¼š{score}åˆ†")

        if not recommended_dates:
            analysis.append("â€¢ åœ¨æŒ‡å®šèŒƒå›´å†…æœªæ‰¾åˆ°ç‰¹åˆ«æ¨èçš„æ—¥æœŸ")
            analysis.append("â€¢ å»ºè®®æ‰©å¤§æ—¥æœŸèŒƒå›´æˆ–å’¨è¯¢ä¸“ä¸šæ‹©æ—¥å¸ˆ")

        return analysis

    def get_general_auspicious_hours(self, event_type, preferred_hour):
        """è·å–é€šç”¨å‰æ—¶"""
        analysis = []
        analysis.append("\nã€æ¨èæ—¶è¾°ã€‘")

        # ä¸åŒäº‹ä»¶ç±»å‹çš„æ¨èæ—¶è¾°
        event_hours = {
            "ç»“å©šå«å¨¶": ["è¾°æ—¶(7:00-9:00)", "å·³æ—¶(9:00-11:00)", "åˆæ—¶(11:00-13:00)"],
            "å¼€ä¸šå¼€å¼ ": ["è¾°æ—¶(7:00-9:00)", "å·³æ—¶(9:00-11:00)", "ç”³æ—¶(15:00-17:00)"],
            "æ¬å®¶å…¥å®…": ["è¾°æ—¶(7:00-9:00)", "åˆæ—¶(11:00-13:00)", "æœªæ—¶(13:00-15:00)"],
            "åŠ¨åœŸå»ºæˆ¿": ["å¯æ—¶(5:00-7:00)", "è¾°æ—¶(7:00-9:00)", "ç”³æ—¶(15:00-17:00)"],
            "å‡ºè¡Œæ—…æ¸¸": ["å¯æ—¶(5:00-7:00)", "è¾°æ—¶(7:00-9:00)", "ç”³æ—¶(15:00-17:00)"],
            "å®‰è‘¬ä¸‹è‘¬": ["å¯æ—¶(5:00-7:00)", "è¾°æ—¶(7:00-9:00)", "æˆŒæ—¶(19:00-21:00)"],
            "ç­¾çº¦åˆä½œ": ["è¾°æ—¶(7:00-9:00)", "å·³æ—¶(9:00-11:00)", "ç”³æ—¶(15:00-17:00)"],
            "æ±‚å­¦è€ƒè¯•": ["å¯æ—¶(5:00-7:00)", "è¾°æ—¶(7:00-9:00)", "å·³æ—¶(9:00-11:00)"],
            "æ±‚åŒ»æ²»ç—…": ["è¾°æ—¶(7:00-9:00)", "åˆæ—¶(11:00-13:00)", "ç”³æ—¶(15:00-17:00)"],
            "ç¥­ç¥€ç¥ˆç¦": ["å¯æ—¶(5:00-7:00)", "è¾°æ—¶(7:00-9:00)", "æˆŒæ—¶(19:00-21:00)"]
        }

        recommended_hours = event_hours.get(event_type, ["è¾°æ—¶(7:00-9:00)", "å·³æ—¶(9:00-11:00)", "åˆæ—¶(11:00-13:00)"])

        for hour in recommended_hours:
            if preferred_hour == "ä¸é™" or hour == preferred_hour:
                analysis.append(f"â€¢ {hour} â­â­â­")
            else:
                analysis.append(f"â€¢ {hour} â­â­")

        if preferred_hour != "ä¸é™" and preferred_hour not in recommended_hours:
            analysis.append(f"â€¢ {preferred_hour} â­ (æ‚¨çš„é¦–é€‰æ—¶è¾°)")

        return analysis

    def calculate_date_score(self, date, event_type):
        """è®¡ç®—æ—¥æœŸè¯„åˆ†ï¼ˆç®€åŒ–ç‰ˆï¼‰"""
        score = 60  # åŸºç¡€åˆ†

        # æ ¹æ®æ—¥æœŸç‰¹å¾åŠ åˆ†
        day_of_month = date.day
        day_of_week = date.weekday()

        # å‰åˆ©æ•°å­—åŠ åˆ†
        if day_of_month in [1, 6, 8, 9, 16, 18, 19, 26, 28, 29]:
            score += 10

        # å‘¨æœ«é€‚åˆæŸäº›äº‹ä»¶
        if day_of_week in [5, 6] and event_type in ["ç»“å©šå«å¨¶", "æ¬å®¶å…¥å®…", "ç¥­ç¥€ç¥ˆç¦"]:
            score += 5

        # å·¥ä½œæ—¥é€‚åˆå•†åŠ¡äº‹ä»¶
        if day_of_week in [0, 1, 2, 3, 4] and event_type in ["å¼€ä¸šå¼€å¼ ", "ç­¾çº¦åˆä½œ"]:
            score += 5

        # é¿å¼€ä¸€äº›ä¼ ç»Ÿå¿Œæ—¥
        if day_of_month in [4, 14, 24]:
            score -= 15

        if day_of_week == 3:  # å‘¨å››
            score -= 5

        return min(100, max(0, score))

    def calculate_bazi_info(self, name, gender, year, month, day, hour, location="åŒ—äº¬å¸‚"):
        """è®¡ç®—å…«å­—ä¿¡æ¯ï¼ˆç”¨äºæ‹©æ—¥åŠŸèƒ½ï¼‰"""
        try:
            # è°ƒç”¨ä¸»çª—å£çš„å…«å­—è®¡ç®—åŠŸèƒ½
            if hasattr(self, 'parent_window') and self.parent_window:
                # å¦‚æœæœ‰çˆ¶çª—å£ï¼Œä½¿ç”¨çˆ¶çª—å£çš„è®¡ç®—æ–¹æ³•
                return self.parent_window.calculate_bazi_local(year, month, day, hour, gender, name)
            else:
                # ç®€åŒ–çš„å…«å­—è®¡ç®—
                from datetime import datetime

                # æ—¶è¾°æ˜ å°„
                hour_map = {
                    "å­æ—¶(23:00-1:00)": 0, "ä¸‘æ—¶(1:00-3:00)": 1, "å¯…æ—¶(3:00-5:00)": 2,
                    "å¯æ—¶(5:00-7:00)": 3, "è¾°æ—¶(7:00-9:00)": 4, "å·³æ—¶(9:00-11:00)": 5,
                    "åˆæ—¶(11:00-13:00)": 6, "æœªæ—¶(13:00-15:00)": 7, "ç”³æ—¶(15:00-17:00)": 8,
                    "é…‰æ—¶(17:00-19:00)": 9, "æˆŒæ—¶(19:00-21:00)": 10, "äº¥æ—¶(21:00-23:00)": 11
                }

                hour_index = hour_map.get(hour, 0)
                is_leap = False
                try:
                    if hasattr(self, 'leap_month'):
                        is_leap = self.leap_month.isChecked()
                except Exception:
                    is_leap = False

                # ä½¿ç”¨lunar_pythonè¿›è¡Œç®€å•è®¡ç®—
                if Lunar:
                    lunar_month = self._normalize_lunar_month(year, month, is_leap)
                    lunar = Lunar.fromYmdHms(year, lunar_month, day, 1, 30, 0)

                    return {
                        'name': name,
                        'gender': gender,
                        'pillars': {
                            'year': lunar.getYearInGanZhi(),
                            'month': lunar.getMonthInGanZhi(),
                            'day': lunar.getDayInGanZhi(),
                            'hour': lunar.getTimeInGanZhi()
                        },
                        'day_master': lunar.getDayInGanZhi()[0],
                        'day_master_element': self.get_tiangan_wuxing(lunar.getDayInGanZhi()[0]),
                        'wuxing_distribution': {'æœ¨': 1, 'ç«': 1, 'åœŸ': 1, 'é‡‘': 1, 'æ°´': 1},
                        'birth_info': {
                            'year': year, 'month': month, 'day': day,
                            'hour': hour_index, 'location': location
                        }
                    }
                else:
                    # æœ€ç®€å•çš„å›é€€
                    return {
                        'name': name,
                        'gender': gender,
                        'pillars': {'year': 'åºšå­', 'month': 'æˆŠå¯…', 'day': 'ç™¸å·³', 'hour': 'ç”²å­'},
                        'day_master': 'ç™¸',
                        'day_master_element': 'æ°´',
                        'wuxing_distribution': {'æœ¨': 1, 'ç«': 1, 'åœŸ': 1, 'é‡‘': 1, 'æ°´': 1},
                        'birth_info': {
                            'year': year, 'month': month, 'day': day,
                            'hour': hour_index, 'location': location
                        }
                    }
        except Exception as e:
            print(f"å…«å­—è®¡ç®—å¤±è´¥: {e}")
            return None

    def get_tiangan_wuxing(self, tiangan):
        """è·å–å¤©å¹²äº”è¡Œ"""
        wuxing_map = {
            'ç”²': 'æœ¨', 'ä¹™': 'æœ¨',
            'ä¸™': 'ç«', 'ä¸': 'ç«',
            'æˆŠ': 'åœŸ', 'å·±': 'åœŸ',
            'åºš': 'é‡‘', 'è¾›': 'é‡‘',
            'å£¬': 'æ°´', 'ç™¸': 'æ°´'
        }
        return wuxing_map.get(tiangan, 'åœŸ')

    def parse_hour_from_text(self, hour_text):
        """ä»æ—¶è¾°æ–‡æœ¬ä¸­è§£æå‡ºæ—¶è¾°ç´¢å¼•ï¼ˆå…¬å¼€æ–¹æ³•ï¼‰"""
        hour_map = {
            "å­æ—¶(23:00-1:00)": 0, "ä¸‘æ—¶(1:00-3:00)": 1, "å¯…æ—¶(3:00-5:00)": 2,
            "å¯æ—¶(5:00-7:00)": 3, "è¾°æ—¶(7:00-9:00)": 4, "å·³æ—¶(9:00-11:00)": 5,
            "åˆæ—¶(11:00-13:00)": 6, "æœªæ—¶(13:00-15:00)": 7, "ç”³æ—¶(15:00-17:00)": 8,
            "é…‰æ—¶(17:00-19:00)": 9, "æˆŒæ—¶(19:00-21:00)": 10, "äº¥æ—¶(21:00-23:00)": 11
        }
        return hour_map.get(hour_text, 0)

    def get_lunar_date_info(self, date):
        """è·å–å†œå†æ—¥æœŸä¿¡æ¯"""
        try:
            if Solar and Lunar:
                from datetime import datetime
                dt = date if hasattr(date, 'hour') else datetime.combine(date, datetime.min.time())
                solar = Solar.fromDate(dt)
                lunar = solar.getLunar()
                lunar_month = lunar.getMonth()
                lunar_day = lunar.getDay()

                # æ ¼å¼åŒ–å†œå†æ—¥æœŸ
                month_names = ["", "æ­£æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ",
                              "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"]

                day_names = ["", "åˆä¸€", "åˆäºŒ", "åˆä¸‰", "åˆå››", "åˆäº”", "åˆå…­", "åˆä¸ƒ", "åˆå…«", "åˆä¹", "åˆå",
                            "åä¸€", "åäºŒ", "åä¸‰", "åå››", "åäº”", "åå…­", "åä¸ƒ", "åå…«", "åä¹", "äºŒå",
                            "å»¿ä¸€", "å»¿äºŒ", "å»¿ä¸‰", "å»¿å››", "å»¿äº”", "å»¿å…­", "å»¿ä¸ƒ", "å»¿å…«", "å»¿ä¹", "ä¸‰å"]

                month_str = month_names[lunar_month] if lunar_month < len(month_names) else f"{lunar_month}æœˆ"
                day_str = day_names[lunar_day] if lunar_day < len(day_names) else f"{lunar_day}æ—¥"

                # è·å–å¹²æ”¯æ—¥
                day_ganzhi = lunar.getDayInGanZhi()

                return {
                    'description': f"å†œå†{month_str}{day_str}ï¼ˆ{day_ganzhi}æ—¥ï¼‰",
                    'month': lunar_month,
                    'day': lunar_day,
                    'ganzhi': day_ganzhi
                }
            else:
                # ç®€åŒ–ç‰ˆæœ¬
                return {
                    'description': f"å†œå†{date.month}æœˆ{date.day}æ—¥",
                    'month': date.month,
                    'day': date.day,
                    'ganzhi': 'ç”²å­'
                }
        except Exception as e:
            print(f"å†œå†è½¬æ¢å¤±è´¥: {e}")
            return {
                'description': f"å†œå†{date.month}æœˆ{date.day}æ—¥",
                'month': date.month,
                'day': date.day,
                'ganzhi': 'ç”²å­'
            }
    def update_scale_display(self):
        """æ›´æ–°ç¼©æ”¾æ˜¾ç¤ºï¼ˆå·²ç§»é™¤æ˜¾ç¤ºæ ‡ç­¾ï¼‰"""
        pass
    def open_notepad(self):
        """æ‰“å¼€è®°äº‹æœ¬"""
        if not self.notepad_window:
            self.notepad_window = ProfessionalNotepad()
            # è®¾ç½®è®°äº‹æœ¬ä½ç½®åœ¨ä¸»çª—å£å³ä¾§ï¼Œè¾¹æ¡†å¯¹é½
            main_pos = self.pos()
            main_width = self.width()
            self.notepad_window.move(main_pos.x() + main_width + 10, main_pos.y())
        # ç¡®ä¿è®°äº‹æœ¬çª—å£åœ¨æœ€å‰é¢
        self.notepad_window.setWindowFlags(Qt.Window | Qt.WindowStaysOnTopHint)
        self.notepad_window.show()
        self.notepad_window.raise_()
        self.notepad_window.activateWindow()
    def open_alarm_settings(self):
        """æ‰“å¼€é—¹é’Ÿè®¾ç½®"""
        try:
            # ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨é—¹é’Ÿçª—å£ï¼Œé¿å…é‡å¤åˆ›å»º
            if hasattr(self, 'alarm_window') and self.alarm_window:
                print("é—¹é’Ÿçª—å£å·²å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤º...")
                self.alarm_window.show()
                self.alarm_window.raise_()
                self.alarm_window.activateWindow()
                return
            # åˆ›å»ºæ–°çš„é—¹é’Ÿçª—å£å®ä¾‹
            self.alarm_window = ProfessionalAlarmSettings(self)
            print("é—¹é’Ÿçª—å£å®ä¾‹åˆ›å»ºæˆåŠŸ")
            # è®¾ç½®ä½ç½®
            main_pos = self.pos()
            alarm_x = max(10, main_pos.x() - self.alarm_window.width() - 10)
            alarm_y = max(10, main_pos.y())
            self.alarm_window.move(alarm_x, alarm_y)
            # å¼ºåˆ¶æ˜¾ç¤ºçª—å£
            self.alarm_window.setVisible(True)
            self.alarm_window.show()
            self.alarm_window.raise_()
            self.alarm_window.activateWindow()
            self.alarm_window.setFocus()
            # ç¡®ä¿çª—å£åœ¨å±å¹•ä¸Šå¯è§
            self.alarm_window.move(alarm_x, alarm_y)
            # é—¹é’Ÿçª—å£æ˜¾ç¤ºå®Œæˆ
        except Exception as e:
            # æ‰“å¼€é—¹é’Ÿçª—å£æ—¶å‡ºé”™
            import traceback
            traceback.print_exc()
            QMessageBox.warning(self, "é”™è¯¯", f"æ— æ³•æ‰“å¼€é—¹é’Ÿçª—å£ï¼š{str(e)}")
    def open_system_settings(self):
        """æ‰“å¼€ç³»ç»Ÿè®¾ç½®"""
        try:
            # ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è®¾ç½®çª—å£ï¼Œé¿å…é‡å¤åˆ›å»º
            if hasattr(self, 'settings_window') and self.settings_window:
                print("ç³»ç»Ÿè®¾ç½®çª—å£å·²å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤º...")
                self.settings_window.show()
                self.settings_window.raise_()
                self.settings_window.activateWindow()
                return
            # åˆ›å»ºç³»ç»Ÿè®¾ç½®çª—å£
            # ğŸ”¥ ä¿®å¤ï¼šåˆ›å»ºç‹¬ç«‹çª—å£ï¼Œä¸è®¾ç½®çˆ¶çª—å£ï¼Œé¿å…å…³é—­æ—¶å½±å“ä¸»ç¨‹åº
            self.settings_window = SystemSettingsWindow(None)
            # ä¿å­˜ä¸»çª—å£å¼•ç”¨ï¼Œç”¨äºæ•°æ®äº¤äº’
            self.settings_window.parent_window = self
            # è®¾ç½®ä½ç½®
            main_pos = self.pos()
            settings_x = max(10, main_pos.x() - self.settings_window.width() - 10)
            settings_y = max(10, main_pos.y())
            self.settings_window.move(settings_x, settings_y)
            # å¼ºåˆ¶æ˜¾ç¤ºçª—å£
            self.settings_window.setVisible(True)
            self.settings_window.show()
            self.settings_window.raise_()
            self.settings_window.activateWindow()
            self.settings_window.setFocus()
            print("ç³»ç»Ÿè®¾ç½®çª—å£å·²æ˜¾ç¤º")
        except Exception as e:
            print(f"æ‰“å¼€ç³»ç»Ÿè®¾ç½®çª—å£æ—¶å‡ºé”™ï¼š{str(e)}")
            import traceback
            traceback.print_exc()
            QMessageBox.warning(self, "é”™è¯¯", f"æ— æ³•æ‰“å¼€ç³»ç»Ÿè®¾ç½®çª—å£ï¼š{str(e)}")
    def show_bazi_suanming(self):
        """æ˜¾ç¤ºå…«å­—ç®—å‘½çª—å£"""
        try:
            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å…«å­—çª—å£ï¼Œé¿å…é‡å¤åˆ›å»º
            if hasattr(self, 'bazi_window') and self.bazi_window:
                print("å…«å­—ç®—å‘½çª—å£å·²å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤º...")
                self.bazi_window.show()
                self.bazi_window.raise_()
                self.bazi_window.activateWindow()
                return
            print("åˆ›å»ºæ–°çš„å…«å­—ç®—å‘½çª—å£...")
            # ğŸ”¥ ä¿®å¤ï¼šåˆ›å»ºç‹¬ç«‹çª—å£ï¼Œä¸è®¾ç½®çˆ¶çª—å£ï¼Œé¿å…å…³é—­æ—¶å½±å“ä¸»ç¨‹åº
            self.bazi_window = BaziSuanmingWindow(None)
            # ä¿å­˜ä¸»çª—å£å¼•ç”¨ï¼Œç”¨äºæ•°æ®äº¤äº’
            self.bazi_window.parent_window = self
            # è®¾ç½®çª—å£ä½ç½®åœ¨å…«å¦æ—¶é’Ÿå·¦è¾¹ï¼Œé¿å…é‡å 
            main_pos = self.pos()
            main_width = self.width()
            bazi_width = self.bazi_window.width()
            # è®¡ç®—å·¦ä¾§ä½ç½®ï¼Œç¡®ä¿ä¸é‡å 
            bazi_x = max(10, main_pos.x() - bazi_width - 20)  # å·¦è¾¹è·ç¦»ä¸»çª—å£20åƒç´ 
            bazi_y = main_pos.y()  # ä¸ä¸»çª—å£é¡¶éƒ¨å¯¹é½
            # ç¡®ä¿çª—å£åœ¨å±å¹•èŒƒå›´å†…
            from PyQt5.QtWidgets import QDesktopWidget
            desktop = QDesktopWidget()
            screen_geometry = desktop.availableGeometry()
            # å¦‚æœå·¦è¾¹ç©ºé—´ä¸å¤Ÿï¼Œåˆ™æ”¾åœ¨å³è¾¹
            if bazi_x < 10:
                bazi_x = main_pos.x() + main_width + 20
                # å¦‚æœå³è¾¹ä¹Ÿæ”¾ä¸ä¸‹ï¼Œåˆ™é‡å æ˜¾ç¤ºä½†ç¨å¾®åç§»
                if bazi_x + bazi_width > screen_geometry.width():
                    bazi_x = main_pos.x() + 50
                    bazi_y = main_pos.y() + 50
            self.bazi_window.move(bazi_x, bazi_y)
            self.bazi_window.show()
            print(f"å…«å­—ç®—å‘½çª—å£å·²æ˜¾ç¤ºï¼Œä½ç½®: ({bazi_x}, {bazi_y})")
        except Exception as e:
            print(f"æ‰“å¼€å…«å­—ç®—å‘½çª—å£æ—¶å‡ºé”™ï¼š{str(e)}")
            import traceback
            traceback.print_exc()
            QMessageBox.warning(self, "é”™è¯¯", f"æ— æ³•æ‰“å¼€å…«å­—ç®—å‘½çª—å£ï¼š{str(e)}")
    def open_health_monitor(self):
        """å…¼å®¹æ€§å‡½æ•°ï¼šä¿ç•™åŸæœ‰å‡½æ•°åï¼Œå®é™…åŠŸèƒ½å·²è½¬ä¸ºå…«å­—ç®—å‘½"""
        try:
            # ä¼˜å…ˆä½¿ç”¨é«˜çº§å¥åº·ç›‘æµ‹ç³»ç»Ÿ
            if ADVANCED_HEALTH_MONITOR_AVAILABLE:
                # ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨çª—å£ï¼Œé¿å…é‡å¤åˆ›å»º
                if hasattr(self, 'advanced_health_monitor_window') and self.advanced_health_monitor_window:
                    print("é«˜çº§å¥åº·ç›‘æµ‹çª—å£å·²å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤º...")
                    self.advanced_health_monitor_window.show()
                    self.advanced_health_monitor_window.raise_()
                    self.advanced_health_monitor_window.activateWindow()
                    return
                # ğŸ”¥ å…³é”®ä¿®å¤ï¼šåˆ›å»ºç‹¬ç«‹çš„å¥åº·ç›‘æµ‹çª—å£ï¼ˆä¸è®¾ç½®çˆ¶çª—å£ï¼‰
                self.advanced_health_monitor_window = AdvancedHealthMonitorWidget(None)

                # ğŸ”¥ ä¿®å¤ï¼šä¸ç›´æ¥è¦†ç›–closeEventï¼Œè€Œæ˜¯ä½¿ç”¨ä¿¡å·è¿æ¥
                # ä¿å­˜åŸæœ‰çš„closeEventæ–¹æ³•
                original_close_event = self.advanced_health_monitor_window.closeEvent
                def enhanced_close_event(event):
                    try:
                        # å…ˆè°ƒç”¨åŸæœ‰çš„closeEventå¤„ç†ï¼ˆä¿æŒå¥åº·æ¨¡å—è‡ªèº«çš„æ¸…ç†é€»è¾‘ï¼‰
                        original_close_event(event)

                        # å¦‚æœåŸæœ‰å¤„ç†æ¥å—äº†å…³é—­äº‹ä»¶ï¼Œå†è¿›è¡Œä¸»ç¨‹åºçš„æ¸…ç†
                        if event.isAccepted():
                            # æ¸…ç©ºçª—å£å¼•ç”¨ï¼ˆå»¶è¿Ÿæ¸…ç†ï¼Œé¿å…å½±å“ä¸»ç¨‹åºï¼‰
                            QTimer.singleShot(100, lambda: setattr(self, 'advanced_health_monitor_window', None))
                    except Exception as e:
                        print(f"å¥åº·ç›‘æµ‹çª—å£å…³é—­æ—¶å‡ºé”™: {e}")
                        # ç¡®ä¿å³ä½¿å‡ºé”™ä¹Ÿæ¥å—å…³é—­äº‹ä»¶
                        event.accept()

                # ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„æ–¹å¼è¿æ¥closeEvent
                self.advanced_health_monitor_window.closeEvent = enhanced_close_event

                # ğŸ”¥ ä¿®å¤ï¼šç§»é™¤ä¸å­˜åœ¨çš„camera_checkboxç›¸å…³ä»£ç 

                def delayed_setup():
                    try:
                        # ç¡®ä¿çª—å£æ­£ç¡®æ˜¾ç¤º
                        if hasattr(self.advanced_health_monitor_window, 'show'):
                            self.advanced_health_monitor_window.show()
                            self.advanced_health_monitor_window.raise_()
                            self.advanced_health_monitor_window.activateWindow()
                    except Exception as e:
                        print(f"çª—å£è®¾ç½®é”™è¯¯: {e}")
                # å»¶è¿Ÿ100msæ‰§è¡Œè®¾ç½®
                QTimer.singleShot(100, delayed_setup)

                # ğŸ”¥ ä¿®å¤æ—¶åºé—®é¢˜ï¼šå»¶è¿Ÿè·å–æ­£ç¡®çš„çª—å£å°ºå¯¸å¹¶å®šä½

                def position_health_window():
                    """å»¶è¿Ÿå®šä½å¥åº·ç•Œé¢ï¼Œç¡®ä¿çª—å£å·²å®Œå…¨åˆå§‹åŒ–"""
                    try:
                        from PyQt5.QtWidgets import QDesktopWidget
                        desktop = QDesktopWidget()
                        screen_geometry = desktop.availableGeometry()
                        # è·å–æ—¶é’Ÿç•Œé¢å½“å‰ä½ç½®å’Œå¤§å°
                        main_pos = self.pos()
                        main_size = self.size()
                        # ğŸ”¥ ä¿®å¤ï¼šå¼ºåˆ¶åˆ·æ–°çª—å£ï¼Œç¡®ä¿å°ºå¯¸æ­£ç¡®
                        self.advanced_health_monitor_window.show()
                        self.advanced_health_monitor_window.update()
                        QApplication.processEvents()  # å¼ºåˆ¶å¤„ç†æ‰€æœ‰å¾…å¤„ç†äº‹ä»¶

                        # å†æ¬¡è·å–å¥åº·ç•Œé¢å°ºå¯¸ï¼ˆæ­¤æ—¶åº”è¯¥æ˜¯æ­£ç¡®çš„ï¼‰
                        health_width = self.advanced_health_monitor_window.width()
                        health_height = self.advanced_health_monitor_window.height()

                        # å¦‚æœè¿˜æ˜¯é»˜è®¤å°ºå¯¸ï¼Œä½¿ç”¨å·²çŸ¥çš„å¥åº·ç•Œé¢å°ºå¯¸
                        if health_width <= 100 or health_height <= 100:
                            health_width = 1200  # ğŸ”¥ ä¿®å¤ï¼šæ›´æ–°ä¸º1200Ã—800ç•Œé¢å°ºå¯¸
                            health_height = 800  # ğŸ”¥ ä¿®å¤ï¼šæ›´æ–°ä¸º1200Ã—800ç•Œé¢å°ºå¯¸
                            print(f"âš ï¸ ä½¿ç”¨é»˜è®¤å¥åº·ç•Œé¢å°ºå¯¸: {health_width}x{health_height}")
                        else:
                            print(f"âœ… è·å–åˆ°æ­£ç¡®çš„å¥åº·ç•Œé¢å°ºå¯¸: {health_width}x{health_height}")

                        # å¼ºåˆ¶è®¡ç®—å¥åº·ç•Œé¢ä½ç½®ï¼šæ—¶é’Ÿç•Œé¢å·¦ä¾§ï¼Œç•™30åƒç´ é—´éš”
                        health_x = main_pos.x() - health_width - 30
                        health_y = main_pos.y()  # ä¸æ—¶é’Ÿç•Œé¢é¡¶éƒ¨å¯¹é½

                        # å¦‚æœå·¦ä¾§ç©ºé—´ä¸å¤Ÿï¼Œè°ƒæ•´æ—¶é’Ÿç•Œé¢ä½ç½®ï¼Œç¡®ä¿å¥åº·ç•Œé¢èƒ½æ˜¾ç¤ºåœ¨å·¦ä¾§
                        if health_x < 10:
                            # é‡æ–°å®šä½æ—¶é’Ÿç•Œé¢ï¼Œç¡®ä¿å·¦ä¾§æœ‰è¶³å¤Ÿç©ºé—´
                            new_clock_x = health_width + 50  # å¥åº·ç•Œé¢å®½åº¦ + 50åƒç´ é—´éš”
                            new_clock_y = main_pos.y()
                            # ç¡®ä¿æ—¶é’Ÿç•Œé¢ä¸è¶…å‡ºå±å¹•å³è¾¹ç•Œ
                            if new_clock_x + main_size.width() > screen_geometry.width():
                                new_clock_x = screen_geometry.width() - main_size.width() - 10
                            # ç§»åŠ¨æ—¶é’Ÿç•Œé¢
                            self.move(new_clock_x, new_clock_y)
                            # é‡æ–°è®¡ç®—å¥åº·ç•Œé¢ä½ç½®
                            health_x = new_clock_x - health_width - 30
                            health_y = new_clock_y
                            print(f"ğŸ“ è°ƒæ•´æ—¶é’Ÿç•Œé¢ä½ç½®åˆ°: ({new_clock_x}, {new_clock_y})")
                        # ç¡®ä¿å¥åº·ç•Œé¢ä¸è¶…å‡ºå±å¹•è¾¹ç•Œ
                        health_x = max(10, health_x)
                        health_y = max(10, min(health_y, screen_geometry.height() - health_height - 10))
                        # ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ­£ç¡®è®¾ç½®å¥åº·ç•Œé¢ä½ç½®
                        self.advanced_health_monitor_window.move(health_x, health_y)
                        self.advanced_health_monitor_window.resize(health_width, health_height)
                        print(f"ğŸ“ æ—¶é’Ÿç•Œé¢æœ€ç»ˆä½ç½®: ({self.pos().x()}, {self.pos().y()}), å¤§å°: {main_size.width()}x{main_size.height()}")
                        print(f"ğŸ“ å¥åº·ç•Œé¢æœ€ç»ˆä½ç½®: ({health_x}, {health_y}), å¤§å°: {health_width}x{health_height}")
                        print(f"ğŸ“ ä¸¤ç•Œé¢é—´éš”: {self.pos().x() - health_x - health_width} åƒç´ ")
                        # ç¡®ä¿å¥åº·ç•Œé¢åœ¨æ­£ç¡®ä½ç½®æ˜¾ç¤º
                        self.advanced_health_monitor_window.raise_()
                        self.advanced_health_monitor_window.activateWindow()
                    except Exception as e:
                        print(f"âŒ å®šä½å¥åº·ç•Œé¢æ—¶å‡ºé”™: {e}")
                        import traceback
                        traceback.print_exc()

                # å»¶è¿Ÿ300msæ‰§è¡Œå®šä½ï¼Œç¡®ä¿çª—å£å®Œå…¨åˆå§‹åŒ–
                QTimer.singleShot(300, position_health_window)

                # åˆå§‹æ˜¾ç¤ºçª—å£ï¼ˆæœ€ç»ˆå®šä½åœ¨å»¶è¿Ÿå‡½æ•°ä¸­å®Œæˆï¼‰
                self.advanced_health_monitor_window.show()
                print("é«˜çº§å¥åº·ç›‘æµ‹çª—å£å·²æ˜¾ç¤º")
                return

            # å…¶æ¬¡ä½¿ç”¨AIå¢å¼ºç‰ˆ
            elif AI_HEALTH_MONITOR_AVAILABLE:
                # ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨AIçª—å£ï¼Œé¿å…é‡å¤åˆ›å»º
                if hasattr(self, 'ai_health_monitor_window') and self.ai_health_monitor_window:
                    print("AIå¥åº·ç›‘æµ‹çª—å£å·²å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤º...")
                    self.ai_health_monitor_window.show()
                    self.ai_health_monitor_window.raise_()
                    self.ai_health_monitor_window.activateWindow()
                    return
                # ğŸ”¥ å…³é”®ä¿®å¤ï¼šåˆ›å»ºç‹¬ç«‹çš„AIå¥åº·ç›‘æµ‹çª—å£ï¼ˆä¸è®¾ç½®çˆ¶çª—å£ï¼‰
                self.ai_health_monitor_window = AIHealthMonitorWidget(None)
                # è®¾ç½®ä½ç½®
                main_pos = self.pos()
                health_x = max(10, main_pos.x() - self.ai_health_monitor_window.width() - 10)
                health_y = max(10, main_pos.y() + 100)  # ç¨å¾®å¾€ä¸‹åç§»
                self.ai_health_monitor_window.move(health_x, health_y)
                # å¼ºåˆ¶æ˜¾ç¤ºçª—å£
                self.ai_health_monitor_window.setVisible(True)
                self.ai_health_monitor_window.show()
                self.ai_health_monitor_window.raise_()
                self.ai_health_monitor_window.activateWindow()
                self.ai_health_monitor_window.setFocus()
                print("AIå¥åº·ç›‘æµ‹çª—å£å·²æ˜¾ç¤º")
                return
            # æœ€åä½¿ç”¨åŸºç¡€ç‰ˆæœ¬
            elif HEALTH_MONITOR_AVAILABLE:
                # ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŸºç¡€çª—å£ï¼Œé¿å…é‡å¤åˆ›å»º
                if hasattr(self, 'health_monitor_window') and self.health_monitor_window:
                    print("åŸºç¡€å¥åº·ç›‘æµ‹çª—å£å·²å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤º...")
                    self.health_monitor_window.show()
                    self.health_monitor_window.raise_()
                    self.health_monitor_window.activateWindow()
                    return
                # ğŸ”¥ å…³é”®ä¿®å¤ï¼šåˆ›å»ºç‹¬ç«‹çš„å¥åº·ç›‘æµ‹çª—å£ï¼ˆä¸è®¾ç½®çˆ¶çª—å£ï¼‰
                self.health_monitor_window = HealthMonitorWidget(None)
                # è®¾ç½®ä½ç½®
                main_pos = self.pos()
                health_x = max(10, main_pos.x() - self.health_monitor_window.width() - 10)
                health_y = max(10, main_pos.y() + 200)  # ç¨å¾®å¾€ä¸‹åç§»
                self.health_monitor_window.move(health_x, health_y)
                # å¼ºåˆ¶æ˜¾ç¤ºçª—å£
                self.health_monitor_window.setVisible(True)
                self.health_monitor_window.show()
                self.health_monitor_window.raise_()
                self.health_monitor_window.activateWindow()
                self.health_monitor_window.setFocus()
                print("åŸºç¡€å¥åº·ç›‘æµ‹çª—å£å·²æ˜¾ç¤º")
                return
            else:
                QMessageBox.warning(self, "åŠŸèƒ½ä¸å¯ç”¨", "å¥åº·ç›‘æµ‹æ¨¡å—æœªå®‰è£…ï¼Œè¯·å®‰è£…ç›¸å…³ä¾èµ–ï¼š\npip install opencv-python requests pillow")
                return
        except Exception as e:
            print(f"æ‰“å¼€å¥åº·ç›‘æµ‹çª—å£æ—¶å‡ºé”™ï¼š{str(e)}")
            import traceback
            traceback.print_exc()
            QMessageBox.warning(self, "é”™è¯¯", f"æ— æ³•æ‰“å¼€å¥åº·ç›‘æµ‹çª—å£ï¼š{str(e)}")

    def update_time(self):
        """æ›´æ–°æ—¶é—´"""
        self.current_time = datetime.now()
        self.check_alarms()
        self.check_health_reminder()  # æ·»åŠ å¥åº·æé†’æ£€æŸ¥
        self.check_shichen_reminder()  # æ·»åŠ æ—¶è¾°æé†’æ£€æŸ¥
        self.update()
    def update_animation(self):
        """æ›´æ–°åŠ¨ç”»"""
        self.angle_offset += 1
        if self.angle_offset >= 360:
            self.angle_offset = 0
        # è„‰å†²æ•ˆæœ
        self.pulse_scale = 1.0 + 0.05 * math.sin(self.angle_offset * 0.1)
        # å‘å…‰å¼ºåº¦
        self.glow_intensity = 100 + 50 * math.sin(self.angle_offset * 0.05)
        self.update()
    def get_current_shichen_index(self, hour):
        """æ ¹æ®å½“å‰å°æ—¶è®¡ç®—æ—¶è¾°ç´¢å¼•"""
        # ä¼ ç»Ÿ12æ—¶è¾°å¯¹åº”å…³ç³»ï¼š
        # å­æ—¶ï¼š23-1ç‚¹ï¼Œä¸‘æ—¶ï¼š1-3ç‚¹ï¼Œå¯…æ—¶ï¼š3-5ç‚¹ï¼Œå¯æ—¶ï¼š5-7ç‚¹
        # è¾°æ—¶ï¼š7-9ç‚¹ï¼Œå·³æ—¶ï¼š9-11ç‚¹ï¼Œåˆæ—¶ï¼š11-13ç‚¹ï¼Œæœªæ—¶ï¼š13-15ç‚¹
        # ç”³æ—¶ï¼š15-17ç‚¹ï¼Œé…‰æ—¶ï¼š17-19ç‚¹ï¼ŒæˆŒæ—¶ï¼š19-21ç‚¹ï¼Œäº¥æ—¶ï¼š21-23ç‚¹
        if 23 <= hour <= 23:  # å­æ—¶ 23:00-23:59
            return 0
        elif 0 <= hour < 1:    # å­æ—¶ 0:00-0:59
            return 0
        elif 1 <= hour < 3:    # ä¸‘æ—¶ 1:00-2:59
            return 1
        elif 3 <= hour < 5:    # å¯…æ—¶ 3:00-4:59
            return 2
        elif 5 <= hour < 7:    # å¯æ—¶ 5:00-6:59
            return 3
        elif 7 <= hour < 9:    # è¾°æ—¶ 7:00-8:59
            return 4
        elif 9 <= hour < 11:   # å·³æ—¶ 9:00-10:59
            return 5
        elif 11 <= hour < 13:  # åˆæ—¶ 11:00-12:59
            return 6
        elif 13 <= hour < 15:  # æœªæ—¶ 13:00-14:59
            return 7
        elif 15 <= hour < 17:  # ç”³æ—¶ 15:00-16:59
            return 8
        elif 17 <= hour < 19:  # é…‰æ—¶ 17:00-18:59
            return 9
        elif 19 <= hour < 21:  # æˆŒæ—¶ 19:00-20:59
            return 10
        elif 21 <= hour < 23:  # äº¥æ—¶ 21:00-22:59
            return 11
        else:
            return 0  # é»˜è®¤è¿”å›å­æ—¶
    def paintEvent(self, event):
        """ç»˜åˆ¶äº‹ä»¶"""
        painter = QPainter(self)
        painter.setRenderHint(QPainter.Antialiasing)
        painter.setRenderHint(QPainter.SmoothPixmapTransform)
        # ç»˜åˆ¶ä¸“ä¸šèƒŒæ™¯
        self.draw_professional_background(painter)
        # ç»˜åˆ¶å…«å¦ç³»ç»Ÿ
        self.draw_bagua_system(painter)
        # ç»˜åˆ¶å¤ªæå›¾
        self.draw_taiji(painter)
        # ç»˜åˆ¶æ—¶é’Ÿ
        self.draw_clock(painter)
        # ç»˜åˆ¶æ—¶é—´æ–‡å­—
        self.draw_time_text(painter)
    def draw_professional_background(self, painter):
        """ç»˜åˆ¶ä¸“ä¸šèƒŒæ™¯"""
        center_x, center_y = self.current_size // 2, self.current_size // 2
        # å¾„å‘æ¸å˜èƒŒæ™¯
        gradient = QRadialGradient(center_x, center_y, self.current_size // 2)
        gradient.setColorAt(0, QColor(20, 10, 40))    # æ·±ç´«è‰²ä¸­å¿ƒ
        gradient.setColorAt(0.3, QColor(10, 5, 20))   # æ·±è“ç´«
        gradient.setColorAt(0.7, QColor(5, 2, 10))    # æ·±é»‘ç´«
        gradient.setColorAt(1, QColor(0, 0, 0))       # çº¯é»‘è¾¹ç¼˜
        painter.fillRect(self.rect(), gradient)
        # ç»˜åˆ¶æ˜Ÿç©ºæ•ˆæœ
        for i in range(200):
            star_angle = (i * 137.5 + self.angle_offset * 0.1) % 360
            star_radius = (50 + (i % 3) * 100 + math.sin(self.angle_offset * 0.01 + i) * 50) * self.scale_factor
            star_x = center_x + math.cos(math.radians(star_angle)) * star_radius
            star_y = center_y + math.sin(math.radians(star_angle)) * star_radius
            if 0 <= star_x <= self.current_size and 0 <= star_y <= self.current_size:
                star_brightness = 100 + 100 * math.sin(self.angle_offset * 0.02 + i * 0.1)
                painter.setPen(QPen(QColor(255, 255, 255, int(star_brightness)), 1))
                painter.drawPoint(int(star_x), int(star_y))
    def draw_bagua_system(self, painter):
        """ç»˜åˆ¶12æ—¶è¾°è¡¨ç›˜ç³»ç»Ÿï¼ˆé«˜äº®é—ªçƒ+å…«å¦åç§°å¤–ç½®+äº”è¡Œ+äº”è„ï¼‰"""
        center_x, center_y = self.current_size // 2, self.current_size // 2
        radius = int(360 * self.scale_factor)  # è¡¨ç›˜åŠå¾„ï¼ˆæ ¹æ®ç¼©æ”¾è°ƒæ•´ï¼‰

        # 12æ—¶è¾°ä¿¡æ¯åŠäº”è„å…­è…‘ - æ­£ç¡®çš„æ—¶è¾°å¯¹åº”å…³ç³»ï¼ˆå­æ—¶åœ¨12ç‚¹ä½ç½®å¼€å§‹ï¼Œé¡ºæ—¶é’ˆæ’åˆ—ï¼‰
        shichen_info = [
            ("å­", "å", 0, "èƒ†", "23:00-1:00"),    # 12ç‚¹ä½ç½®
            ("ä¸‘", "è‰®", 30, "è‚", "1:00-3:00"),     # 1ç‚¹ä½ç½®
            ("å¯…", "éœ‡", 60, "è‚º", "3:00-5:00"),     # 2ç‚¹ä½ç½®
            ("å¯", "å·½", 90, "å¤§è‚ ", "5:00-7:00"),   # 3ç‚¹ä½ç½®
            ("è¾°", "ç¦»", 120, "èƒƒ", "7:00-9:00"),    # 4ç‚¹ä½ç½®
            ("å·³", "å¤", 150, "è„¾", "9:00-11:00"),   # 5ç‚¹ä½ç½®
            ("åˆ", "å…‘", 180, "å¿ƒ", "11:00-13:00"),  # 6ç‚¹ä½ç½®
            ("æœª", "ä¹¾", 210, "å°è‚ ", "13:00-15:00"), # 7ç‚¹ä½ç½®
            ("ç”³", "å", 240, "è†€èƒ±", "15:00-17:00"), # 8ç‚¹ä½ç½®
            ("é…‰", "è‰®", 270, "è‚¾", "17:00-19:00"),   # 9ç‚¹ä½ç½®
            ("æˆŒ", "éœ‡", 300, "å¿ƒåŒ…", "19:00-21:00"), # 10ç‚¹ä½ç½®
            ("äº¥", "å·½", 330, "ä¸‰ç„¦", "21:00-23:00")  # 11ç‚¹ä½ç½®
        ]
        # å…«å¦äº”è¡Œæ˜ å°„
        bagua_wuxing = {
            "ä¹¾": "é‡‘", "å…‘": "é‡‘", "ç¦»": "ç«", "éœ‡": "æœ¨", "å·½": "æœ¨", "å": "æ°´", "è‰®": "åœŸ", "å¤": "åœŸ"
        }
        # å½“å‰æ—¶è¾°è®¡ç®— - ä¿®æ­£ä¸ºæ­£ç¡®çš„æ—¶è¾°è®¡ç®—
        current_hour = self.current_time.hour
        current_shichen_index = self.get_current_shichen_index(current_hour)
        current_second = self.current_time.second
        flash_on = (current_second % 2 == 0)
        # ç»˜åˆ¶12æ—¶è¾°æ ‡è®°
        for i, shichen_data in enumerate(shichen_info):
            shichen_name, _bagua_name, angle, organ, _time_range = shichen_data
            clock_angle = angle - 90
            x = center_x + math.cos(math.radians(clock_angle)) * radius
            y = center_y + math.sin(math.radians(clock_angle)) * radius
            if i == current_shichen_index and flash_on:
                painter.setBrush(QBrush(QColor(255, 215, 0, 120)))
                painter.setPen(QPen(QColor(255, 255, 255), int(4 * self.scale_factor)))
                highlight_size = int(38 * self.scale_factor)
                painter.drawEllipse(int(x - highlight_size), int(y - highlight_size), highlight_size * 2, highlight_size * 2)
            painter.setFont(QFont("Microsoft YaHei", int(24 * self.scale_factor), QFont.Bold))  # æ ¹æ®ç¼©æ”¾è°ƒæ•´å­—ä½“
            painter.setPen(QPen(QColor(0, 0, 0, 150), int(2 * self.scale_factor)))
            text_rect = painter.fontMetrics().boundingRect(shichen_name)
            shadow_offset = int(2 * self.scale_factor)
            painter.drawText(int(x - text_rect.width()/2 + shadow_offset), int(y + text_rect.height()/3 + shadow_offset), shichen_name)
            gradient_size = int(20 * self.scale_factor)
            gradient = QLinearGradient(x - gradient_size, y - gradient_size, x + gradient_size, y + gradient_size)
            gradient.setColorAt(0, QColor(255, 215, 0))
            gradient.setColorAt(1, QColor(255, 165, 0))
            painter.setPen(QPen(gradient, int(2 * self.scale_factor)))
            painter.drawText(int(x - text_rect.width()/2), int(y + text_rect.height()/3), shichen_name)
        painter.setPen(QPen(QColor(255, 215, 0, 100), int(2 * self.scale_factor)))
        for i in range(12):
            angle = i * 30 - 90
            line_offset = int(20 * self.scale_factor)
            outer_x = center_x + math.cos(math.radians(angle)) * (radius + line_offset)
            outer_y = center_y + math.sin(math.radians(angle)) * (radius + line_offset)
            inner_x = center_x + math.cos(math.radians(angle)) * (radius - line_offset)
            inner_y = center_y + math.sin(math.radians(angle)) * (radius - line_offset)
            painter.drawLine(int(outer_x), int(outer_y), int(inner_x), int(inner_y))
        # ç»˜åˆ¶ä¸­é—´å…«å¦ç¯åŠå…«å¦åç§°ã€äº”è¡Œ
        bagua_radius = int(140 * self.scale_factor)  # æ ¹æ®ç¼©æ”¾è°ƒæ•´å…«å¦åŠå¾„
        name_offset = int(70 * self.scale_factor)    # è°ƒæ•´å…«å¦åç§°åç§»
        wuxing_offset = int(105 * self.scale_factor) # è°ƒæ•´äº”è¡Œåç§»
        for i, (name, symbol, base_angle) in enumerate(self.bagua_info):
            bagua_angle = base_angle - 90
            bagua_x = center_x + math.cos(math.radians(bagua_angle)) * bagua_radius
            bagua_y = center_y + math.sin(math.radians(bagua_angle)) * bagua_radius
            current_bagua_name = shichen_info[current_shichen_index][1]
            if name == current_bagua_name and flash_on:
                painter.setBrush(QBrush(QColor(255, 215, 0, 120)))
                painter.setPen(QPen(QColor(255, 255, 255), int(3 * self.scale_factor)))
                bagua_highlight_size = int(32 * self.scale_factor)
                painter.drawEllipse(int(bagua_x - bagua_highlight_size), int(bagua_y - bagua_highlight_size),
                                  bagua_highlight_size * 2, bagua_highlight_size * 2)
            painter.setFont(QFont("SimSun", int(32 * self.scale_factor), QFont.Bold))  # æ ¹æ®ç¼©æ”¾è°ƒæ•´å…«å¦ç¬¦å·å­—ä½“
            painter.setPen(QPen(QColor(0, 0, 0, 150), int(3 * self.scale_factor)))
            symbol_rect = painter.fontMetrics().boundingRect(symbol)
            symbol_shadow_offset = int(2 * self.scale_factor)
            painter.drawText(int(bagua_x - symbol_rect.width()/2 + symbol_shadow_offset),
                           int(bagua_y + symbol_rect.height()/3 + symbol_shadow_offset), symbol)
            symbol_gradient_size = int(25 * self.scale_factor)
            gradient = QLinearGradient(bagua_x - symbol_gradient_size, bagua_y - symbol_gradient_size,
                                     bagua_x + symbol_gradient_size, bagua_y + symbol_gradient_size)
            gradient.setColorAt(0, QColor(255, 215, 0))
            gradient.setColorAt(1, QColor(255, 165, 0))
            painter.setPen(QPen(gradient, int(3 * self.scale_factor)))
            painter.drawText(int(bagua_x - symbol_rect.width()/2), int(bagua_y + symbol_rect.height()/3), symbol)
            # å…«å¦åç§°å¤–ç½®
            name_angle = math.radians(bagua_angle)
            name_x = center_x + math.cos(name_angle) * (bagua_radius + name_offset)
            name_y = center_y + math.sin(name_angle) * (bagua_radius + name_offset)
            painter.setFont(QFont("Microsoft YaHei", int(20 * self.scale_factor), QFont.Bold))
            painter.setPen(QPen(QColor(0, 0, 0, 120), int(1 * self.scale_factor)))
            name_rect = painter.fontMetrics().boundingRect(name)
            name_shadow_offset = int(1 * self.scale_factor)
            painter.drawText(int(name_x - name_rect.width()/2 + name_shadow_offset),
                           int(name_y + name_rect.height()/3 + name_shadow_offset), name)
            painter.setPen(QPen(QColor(255, 255, 255), int(2 * self.scale_factor)))
            painter.drawText(int(name_x - name_rect.width()/2), int(name_y + name_rect.height()/3), name)
            # äº”è¡Œå¤–ç½®ï¼ˆå¢åŠ è·ç¦»é¿å…é‡å ï¼‰
            wuxing = bagua_wuxing.get(name, "")
            wuxing_x = center_x + math.cos(name_angle) * (bagua_radius + wuxing_offset)
            wuxing_y = center_y + math.sin(name_angle) * (bagua_radius + wuxing_offset)
            painter.setFont(QFont("Microsoft YaHei", int(18 * self.scale_factor), QFont.Bold))
            painter.setPen(QPen(QColor(255, 215, 0), int(2 * self.scale_factor)))
            wuxing_rect = painter.fontMetrics().boundingRect(wuxing)
            painter.drawText(int(wuxing_x - wuxing_rect.width()/2), int(wuxing_y + wuxing_rect.height()/3), wuxing)
        # ç»˜åˆ¶æ‰€æœ‰äº”è„å…­è…‘åœ¨å¯¹åº”æ—¶è¾°ä½ç½®
        base_organ_radius = int(310 * self.scale_factor)  # åŸºç¡€äº”è„æ˜¾ç¤ºåŠå¾„
        for i, shichen_data in enumerate(shichen_info):
            shichen_name, _bagua_name, angle, organ, _time_range = shichen_data
            # ç¡®ä¿æ¯æ¬¡éƒ½è®¾ç½®ç»Ÿä¸€çš„å­—ä½“
            painter.setFont(QFont("Microsoft YaHei", int(18 * self.scale_factor), QFont.Bold))  # ç»Ÿä¸€å­—ä½“å¤§å°18px
            # æ ¹æ®å…·ä½“å™¨å®˜è°ƒæ•´è·ç¦»
            organ_radius = base_organ_radius
            if organ == "è†€èƒ±":  # ç”³æ—¶ - è†€èƒ±æ‹‰å¼€1.5mm (çº¦6åƒç´ )
                organ_radius = base_organ_radius - int(6 * self.scale_factor)
            elif organ == "å¿ƒåŒ…":  # æˆŒæ—¶ - å¿ƒåŒ…æ‹‰å¼€1mm (çº¦4åƒç´ )
                organ_radius = base_organ_radius - int(4 * self.scale_factor)
            elif organ == "å¤§è‚ ":  # å¯æ—¶ - å¤§è‚ æ‹‰å¼€0.5mm (çº¦2åƒç´ )
                organ_radius = base_organ_radius - int(2 * self.scale_factor)
            # è®¡ç®—å™¨å®˜ä½ç½®ï¼ˆåœ¨æ—¶è¾°å†…ä¾§ï¼‰
            organ_angle = angle - 90  # è°ƒæ•´è§’åº¦
            organ_x = center_x + math.cos(math.radians(organ_angle)) * organ_radius
            organ_y = center_y + math.sin(math.radians(organ_angle)) * organ_radius
            # è·å–æ–‡å­—å°ºå¯¸ï¼ˆç¡®ä¿ä½¿ç”¨ç»Ÿä¸€å­—ä½“ï¼‰
            organ_rect = painter.fontMetrics().boundingRect(organ)
            # å¦‚æœæ˜¯å½“å‰æ—¶è¾°ï¼Œé«˜äº®æ˜¾ç¤º
            if i == current_shichen_index and flash_on:
                # ç»˜åˆ¶é«˜äº®èƒŒæ™¯åœ†åœˆ
                painter.setBrush(QBrush(QColor(255, 215, 0, 80)))
                painter.setPen(QPen(QColor(255, 255, 255), int(2 * self.scale_factor)))
                highlight_padding_x = int(10 * self.scale_factor)
                highlight_padding_y = int(5 * self.scale_factor)
                painter.drawEllipse(int(organ_x - organ_rect.width()/2 - highlight_padding_x),
                                  int(organ_y - organ_rect.height()/2 - highlight_padding_y),
                                  organ_rect.width() + highlight_padding_x * 2,
                                  organ_rect.height() + highlight_padding_y * 2)
            # ç»˜åˆ¶å™¨å®˜åç§°é˜´å½±
            painter.setPen(QPen(QColor(0, 0, 0, 150), int(2 * self.scale_factor)))
            organ_shadow_offset = int(1 * self.scale_factor)
            painter.drawText(int(organ_x - organ_rect.width()/2 + organ_shadow_offset),
                           int(organ_y + organ_rect.height()/3 + organ_shadow_offset), organ)
            # ç»˜åˆ¶å™¨å®˜åç§°ä¸»ä½“
            if i == current_shichen_index:
                # å½“å‰æ—¶è¾°ç”¨é‡‘è‰²
                painter.setPen(QPen(QColor(255, 215, 0), int(3 * self.scale_factor)))
            else:
                # å…¶ä»–æ—¶è¾°ç”¨ç™½è‰²
                painter.setPen(QPen(QColor(255, 255, 255), int(2 * self.scale_factor)))
            painter.drawText(int(organ_x - organ_rect.width()/2), int(organ_y + organ_rect.height()/3), organ)
    def draw_taiji(self, painter):
        """ç»˜åˆ¶æ ‡å‡†å¤ªæå›¾ï¼ˆç¼©å°ç‰ˆï¼‰"""
        center_x, center_y = self.current_size // 2, self.current_size // 2
        taiji_radius = int(75 * self.scale_factor)  # æ ¹æ®ç¼©æ”¾è°ƒæ•´å¤ªæå›¾åŠå¾„
        # å¤ªæå›¾æ—‹è½¬
        rotation_angle = self.angle_offset * 0.5
        # ç»˜åˆ¶å¤ªæå›¾çš„å…‰æ™•æ•ˆæœ
        for glow_layer in range(8):
            glow_radius = taiji_radius + int((20 + glow_layer * 10) * self.scale_factor)
            glow_alpha = max(0, 150 - glow_layer * 15)
            glow_width = max(1, int((6 - glow_layer // 2) * self.scale_factor))
            painter.setPen(QPen(QColor(255, 215, 0, glow_alpha), glow_width))
            painter.setBrush(QBrush())
            painter.drawEllipse(center_x - glow_radius, center_y - glow_radius,
                              glow_radius * 2, glow_radius * 2)
        # ä¿å­˜ç»˜å›¾çŠ¶æ€
        painter.save()
        # ç§»åŠ¨åˆ°ä¸­å¿ƒç‚¹å¹¶æ—‹è½¬
        painter.translate(center_x, center_y)
        painter.rotate(rotation_angle)
        # ç»˜åˆ¶å¤ªæå›¾å¤–åœˆé‡‘è¾¹
        painter.setPen(QPen(QColor(255, 215, 0), int(6 * self.scale_factor)))
        painter.setBrush(QBrush())
        painter.drawEllipse(-taiji_radius, -taiji_radius, taiji_radius * 2, taiji_radius * 2)
        # ç»˜åˆ¶ç™½è‰²èƒŒæ™¯ï¼ˆæ— è¾¹æ¡†ï¼‰
        painter.setPen(QPen(Qt.NoPen))
        painter.setBrush(QBrush(QColor(255, 255, 255)))
        painter.drawEllipse(-taiji_radius, -taiji_radius, taiji_radius * 2, taiji_radius * 2)
        # ç»˜åˆ¶é»‘è‰²åŠåœ†ï¼ˆæ ‡å‡†å¤ªæå›¾çš„å·¦åŠéƒ¨åˆ†ï¼‰
        painter.setBrush(QBrush(QColor(0, 0, 0)))
        painter.drawPie(-taiji_radius, -taiji_radius, taiji_radius * 2, taiji_radius * 2,
                       90 * 16, 180 * 16)
        # ç»˜åˆ¶ä¸Šæ–¹å°åœ†ï¼ˆç™½è‰²ï¼Œåœ¨é»‘è‰²åŒºåŸŸï¼‰
        small_radius = taiji_radius // 2
        painter.setBrush(QBrush(QColor(255, 255, 255)))
        painter.drawEllipse(-small_radius, -taiji_radius, small_radius * 2, small_radius * 2)
        # ç»˜åˆ¶ä¸‹æ–¹å°åœ†ï¼ˆé»‘è‰²ï¼Œåœ¨ç™½è‰²åŒºåŸŸï¼‰
        painter.setBrush(QBrush(QColor(0, 0, 0)))
        painter.drawEllipse(-small_radius, 0, small_radius * 2, small_radius * 2)
        # ç»˜åˆ¶ä¸Šæ–¹å°åœ†ä¸­çš„é»‘ç‚¹
        dot_radius = taiji_radius // 6
        painter.setBrush(QBrush(QColor(0, 0, 0)))
        painter.drawEllipse(-dot_radius, -small_radius, dot_radius * 2, dot_radius * 2)
        # ç»˜åˆ¶ä¸‹æ–¹å°åœ†ä¸­çš„ç™½ç‚¹
        painter.setBrush(QBrush(QColor(255, 255, 255)))
        painter.drawEllipse(-dot_radius, small_radius - dot_radius, dot_radius * 2, dot_radius * 2)
        # æ¢å¤ç»˜å›¾çŠ¶æ€
        painter.restore()
    def draw_clock(self, painter):
        """ç»˜åˆ¶ä¸“ä¸šæ—¶é’ŸæŒ‡é’ˆï¼ˆé‡‘è‰²å…‰æŸ+å°„çº¿ç§’é’ˆï¼‰"""
        center_x, center_y = self.current_size // 2, self.current_size // 2
        radius = int(350 * self.scale_factor)
        hour = self.current_time.hour % 12
        minute = self.current_time.minute
        second = self.current_time.second
        # æ—¶é’ˆï¼ˆé‡‘è‰²å…‰æŸï¼‰
        hour_angle = (hour + minute / 60.0) * 30 - 90
        self.draw_gold_beam(painter, hour_angle, radius * 0.35, int(18 * self.scale_factor), QColor(255, 255, 180), QColor(255, 215, 0))
        # åˆ†é’ˆï¼ˆé‡‘è‰²å…‰æŸï¼‰
        minute_angle = minute * 6 - 90
        self.draw_gold_beam(painter, minute_angle, radius * 0.55, int(12 * self.scale_factor), QColor(255, 255, 220), QColor(255, 215, 0))
        # ç§’é’ˆï¼ˆé‡‘è‰²å°„çº¿ï¼Œæ¯ç§’å°„ä¸€æ¬¡ï¼‰
        if second % 1 == 0:
            second_angle = second * 6 - 90
            self.draw_gold_ray(painter, second_angle, radius * 0.75, int(8 * self.scale_factor), QColor(255, 255, 180), QColor(255, 215, 0))
        # ä¸­å¿ƒç‚¹
        painter.setBrush(QBrush(QColor(255, 215, 0)))
        painter.setPen(QPen(QColor(255, 165, 0), int(3 * self.scale_factor)))
        center_size = int(15 * self.scale_factor)
        painter.drawEllipse(center_x - center_size, center_y - center_size, center_size * 2, center_size * 2)
    def draw_gold_beam(self, painter, angle, length, width, color1, color2):
        """ç»˜åˆ¶é‡‘è‰²å…‰æŸï¼ˆæ—¶é’ˆ/åˆ†é’ˆï¼‰"""
        center_x, center_y = self.current_size // 2, self.current_size // 2
        # æ¸å˜å…‰æŸ
        gradient = QLinearGradient(center_x, center_y,
                                 center_x + math.cos(math.radians(angle)) * length,
                                 center_y + math.sin(math.radians(angle)) * length)
        gradient.setColorAt(0, color1)
        gradient.setColorAt(0.5, color2)
        gradient.setColorAt(1, QColor(255, 255, 255, 0))
        painter.setPen(QPen(gradient, width, QtCore.Qt.SolidLine, QtCore.Qt.RoundCap))
        end_x = center_x + math.cos(math.radians(angle)) * length
        end_y = center_y + math.sin(math.radians(angle)) * length
        painter.drawLine(center_x, center_y, int(end_x), int(end_y))
    def draw_gold_ray(self, painter, angle, length, width, color1, color2):
        """ç»˜åˆ¶é‡‘è‰²å°„çº¿ï¼ˆç§’é’ˆï¼‰"""
        center_x, center_y = self.current_size // 2, self.current_size // 2
        # å°„çº¿æ¸å˜
        gradient = QLinearGradient(center_x, center_y,
                                 center_x + math.cos(math.radians(angle)) * length,
                                 center_y + math.sin(math.radians(angle)) * length)
        gradient.setColorAt(0, color1)
        gradient.setColorAt(0.7, color2)
        gradient.setColorAt(1, QColor(255, 255, 255, 0))
        painter.setPen(QPen(gradient, width, QtCore.Qt.SolidLine, QtCore.Qt.RoundCap))
        end_x = center_x + math.cos(math.radians(angle)) * length
        end_y = center_y + math.sin(math.radians(angle)) * length
        painter.drawLine(center_x, center_y, int(end_x), int(end_y))
    def draw_time_text(self, painter):
        """å·¦ä¸Šè§’æ˜¾ç¤ºé˜³å†ã€é˜´å†ã€æ—¶é—´ä¸‰æ’ï¼ˆæ— å¤–æ¡†é»„è‰²å­—ä½“ï¼‰"""
        # è·å–é˜³å†æ—¶é—´
        solar_date = self.current_time.strftime("%Yå¹´%mæœˆ%dæ—¥")
        solar_time = self.current_time.strftime("%H:%M:%S")
        # è·å–é˜´å†æ—¶é—´
        lunar_date = ""
        try:
            if Lunar:
                lunar = Lunar.fromDate(self.current_time)
                lunar_date = f"{lunar.getYearInGanZhi()}å¹´{lunar.getMonthInChinese()}æœˆ{lunar.getDayInChinese()}"
        except:
            lunar_date = "è·å–å¤±è´¥"
        # å·¦ä¸Šè§’å¸ƒå±€ï¼Œä¸æ—¶é’Ÿè¾¹æ¡†å¹³è¡Œ
        margin = 10  # å·¦è¾¹è·
        top_margin = 60  # ä¸Šè¾¹è·ï¼Œå‘ä¸Šç§»åŠ¨5mmï¼ˆçº¦20åƒç´ ï¼‰
        # ä½¿ç”¨è®¾ç½®ä¸­çš„å­—ä½“å¤§å°ï¼Œæ ¹æ®ç¼©æ”¾è°ƒæ•´
        time_font_size = self.settings_cache.get('time_font_size', 10)
        painter.setFont(QFont("Microsoft YaHei", int(time_font_size * self.scale_factor), QFont.Normal))
        # è·å–å­—ä½“åº¦é‡ä¿¡æ¯
        font_metrics = painter.fontMetrics()
        line_height = font_metrics.height() + 6  # å¢åŠ è¡Œé—´è·
        # è®¡ç®—æ–‡å­—çš„èµ·å§‹Yä½ç½®
        text_start_y = top_margin + font_metrics.ascent()

        # ç»˜åˆ¶å››è¡Œæ–‡å­—ï¼ˆå·¦å¯¹é½ï¼Œé»„è‰²å­—ä½“ï¼Œæ— å¤–æ¡†ï¼‰
        painter.setPen(QPen(QColor(255, 215, 0), 2))  # é»„è‰²å­—ä½“
        # ç¬¬ä¸€è¡Œï¼šé˜³å†æ—¥æœŸ
        painter.drawText(margin, text_start_y, solar_date)
        # ç¬¬äºŒè¡Œï¼šé˜´å†æ—¥æœŸ
        painter.drawText(margin, text_start_y + line_height, lunar_date)
        # ç¬¬ä¸‰è¡Œï¼šæ—¶é—´
        painter.drawText(margin, text_start_y + line_height * 2, solar_time)
        # å·¦ä¸‹è§’æ˜¾ç¤ºç‰ˆæƒä¿¡æ¯
        self.draw_copyright_info(painter)
    def draw_copyright_info(self, painter):
        """åœ¨å·¦ä¸‹è§’æ˜¾ç¤ºç‰ˆæƒä¿¡æ¯"""
        # ç‰ˆæƒä¿¡æ¯æ–‡å­—
        copyright_text1 = "ç‰ˆæƒæ‰€æœ‰ Â© 2025 æ¹–å—å…¨èˆªä¿¡æ¯é€šä¿¡æœ‰é™å…¬å¸"
        copyright_text2 = "ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚"

        # è®¾ç½®å­—ä½“ï¼ˆä½¿ç”¨è®¾ç½®ä¸­çš„å­—ä½“å¤§å°ï¼‰ï¼Œæ ¹æ®ç¼©æ”¾è°ƒæ•´
        time_font_size = self.settings_cache.get('time_font_size', 14)
        painter.setFont(QFont("Microsoft YaHei", int(time_font_size * self.scale_factor), QFont.Normal))
        # è·å–å­—ä½“åº¦é‡ä¿¡æ¯
        font_metrics = painter.fontMetrics()
        line_height = font_metrics.height() + 2
        # è®¡ç®—å·¦ä¸‹è§’ä½ç½®
        margin = 10  # å·¦è¾¹è·
        bottom_margin = 20  # åº•è¾¹è·
        # è®¡ç®—Yä½ç½®ï¼ˆä»åº•éƒ¨å‘ä¸Šï¼‰
        y_pos1 = self.height() - bottom_margin - line_height
        y_pos2 = self.height() - bottom_margin
        # è®¾ç½®ç‰ˆæƒä¿¡æ¯é¢œè‰²ï¼ˆç¨å¾®é€æ˜çš„é‡‘è‰²ï¼‰
        painter.setPen(QPen(QColor(255, 215, 0, 180), 1))
        # ç»˜åˆ¶ç‰ˆæƒä¿¡æ¯
        painter.drawText(margin, y_pos1, copyright_text1)
        painter.drawText(margin, y_pos2, copyright_text2)
    def get_clicked_shichen(self, pos):
        """æ£€æµ‹é¼ æ ‡ç‚¹å‡»çš„æ—¶è¾°ï¼ˆæ”¯æŒç¼©æ”¾ï¼‰"""
        # æ ¹æ®ç¼©æ”¾è®¡ç®—å®é™…çš„ä¸­å¿ƒç‚¹å’ŒåŠå¾„
        center_x, center_y = self.current_size // 2, self.current_size // 2
        radius = int(360 * self.scale_factor)  # æ—¶è¾°æ˜¾ç¤ºåŠå¾„ï¼ˆæ ¹æ®ç¼©æ”¾è°ƒæ•´ï¼‰
        # è®¡ç®—ç‚¹å‡»ä½ç½®ç›¸å¯¹äºä¸­å¿ƒçš„è·ç¦»å’Œè§’åº¦
        dx = pos.x() - center_x
        dy = pos.y() - center_y
        distance = math.sqrt(dx * dx + dy * dy)

        # æ£€æŸ¥æ˜¯å¦åœ¨æ—¶è¾°ç¯å½¢åŒºåŸŸå†…ï¼ˆåŠå¾„Â±40åƒç´ èŒƒå›´ï¼Œä¹Ÿè¦ç¼©æ”¾ï¼‰
        tolerance = int(40 * self.scale_factor)
        if not (radius - tolerance <= distance <= radius + tolerance):
            return None
        # è®¡ç®—è§’åº¦ï¼ˆè½¬æ¢ä¸º0-360åº¦ï¼‰
        angle = math.degrees(math.atan2(dy, dx))
        if angle < 0:
            angle += 360

        # è°ƒæ•´è§’åº¦ï¼Œå› ä¸º12ç‚¹æ–¹å‘æ˜¯0åº¦ï¼ˆå­æ—¶ä½ç½®ï¼‰
        # ä»12ç‚¹å¼€å§‹é¡ºæ—¶é’ˆè®¡ç®—
        adjusted_angle = (angle + 90) % 360

        # è®¡ç®—å¯¹åº”çš„æ—¶è¾°ç´¢å¼•ï¼ˆæ¯ä¸ªæ—¶è¾°å 30åº¦ï¼‰
        shichen_index = int(adjusted_angle / 30) % 12
        return shichen_index
    def show_shichen_info(self, shichen_index):
        """æ˜¾ç¤ºæ—¶è¾°è¯¦ç»†ä¿¡æ¯"""
        # 12æ—¶è¾°è¯¦ç»†ä¿¡æ¯
        shichen_details = [
            {
                "name": "å­æ—¶",
                "time": "23:00-1:00",
                "bagua": "åå¦",
                "organ": "èƒ†ç»",
                "function": "èƒ†æ°”ç”Ÿå‘ï¼Œå¯åŠ¨å…¨èº«æ°”è¡€å¾ªç¯",
                "health": "åŠ¡å¿…ç¡çœ ï¼Œé¿å…ç†¬å¤œ",
                "tips": "æ­¤æ—¶åº”æ·±ç¡ï¼Œè®©èƒ†ç»å……åˆ†ä¼‘æ¯ï¼Œä¸ºæ˜æ—¥ç”Ÿå‘é˜³æ°”åšå‡†å¤‡ã€‚"
            },
            {
                "name": "ä¸‘æ—¶",
                "time": "1:00-3:00",
                "bagua": "è‰®å¦",
                "organ": "è‚ç»",
                "function": "è‚è—è¡€è§£æ¯’ï¼Œå‡€åŒ–è¡€æ¶²",
                "health": "æ·±åº¦ç¡çœ ï¼Œå¿Œé¥®é…’ã€ç”¨çœ¼",
                "tips": "è‚ç»å½“ä»¤ï¼Œè¡€å½’äºè‚ã€‚ç†¬å¤œæœ€ä¼¤è‚ï¼Œæ­¤æ—¶å¿…é¡»ç†Ÿç¡ã€‚"
            },
            {
                "name": "å¯…æ—¶",
                "time": "3:00-5:00",
                "bagua": "éœ‡å¦",
                "organ": "è‚ºç»",
                "function": "è‚ºåˆ†é…æ°”è¡€è‡³å…¨èº«",
                "health": "ä¿æŒç†Ÿç¡ï¼Œé¿å…æ—©æ™¨æˆ–è¿åŠ¨",
                "tips": "è‚ºæœç™¾è„‰ï¼Œå°†æ°”è¡€è¾“é€å…¨èº«ã€‚è€äººå¸¸åœ¨æ­¤æ—¶é†’æ¥å±æ­£å¸¸ã€‚"
            },
            {
                "name": "å¯æ—¶",
                "time": "5:00-7:00",
                "bagua": "å·½å¦",
                "organ": "å¤§è‚ ç»",
                "function": "æ’æ³„ç³Ÿç²•ï¼Œæ¸…ç†è‚ é“",
                "health": "å–æ¸©æ°´+æ’ä¾¿ï¼ŒæŒ‰æ‘©å¤©æ¢ç©´ä¿ƒä»£è°¢",
                "tips": "å¤§è‚ ç»å½“ä»¤ï¼Œæœ€ä½³æ’ä¾¿æ—¶é—´ã€‚ä¸€æ¯æ¸©æ°´ä¿ƒè¿›è‚ é“è •åŠ¨ã€‚"
            },
            {
                "name": "è¾°æ—¶",
                "time": "7:00-9:00",
                "bagua": "ç¦»å¦",
                "organ": "èƒƒç»",
                "function": "èƒƒè…ç†Ÿé£Ÿç‰©ï¼Œè½¬åŒ–èƒ½é‡",
                "health": "åƒè¥å…»æ—©é¤ï¼ˆå¦‚ç²¥ã€é¸¡è›‹ï¼‰ï¼Œå¿Œç©ºè…¹",
                "tips": "èƒƒç»æœ€æ—ºï¼Œæ—©é¤è¦åƒå¥½ã€‚æ­¤æ—¶æ¶ˆåŒ–èƒ½åŠ›æœ€å¼ºï¼Œè¥å…»å¸æ”¶æœ€ä½³ã€‚"
            },
            {
                "name": "å·³æ—¶",
                "time": "9:00-11:00",
                "bagua": "å¤å¦",
                "organ": "è„¾ç»",
                "function": "è„¾è¿åŒ–è¥å…»ï¼Œè¾“å¸ƒå…¨èº«",
                "health": "é«˜æ•ˆå·¥ä½œ/å­¦ä¹ ï¼Œé€‚å½“æ´»åŠ¨å››è‚¢",
                "tips": "è„¾ä¸»è¿åŒ–ï¼Œæ­¤æ—¶å·¥ä½œå­¦ä¹ æ•ˆç‡æœ€é«˜ï¼Œå¤§è„‘æ€ç»´æœ€æ´»è·ƒã€‚"
            },
            {
                "name": "åˆæ—¶",
                "time": "11:00-13:00",
                "bagua": "å…‘å¦",
                "organ": "å¿ƒç»",
                "function": "å¿ƒä¸»è¡€è„‰ï¼Œç»´æŒç¥å¿—",
                "health": "åˆä¼‘20-30åˆ†é’Ÿï¼Œå…»å¿ƒå®‰ç¥",
                "tips": "å¿ƒç»å½“ä»¤ï¼Œé€‚åˆå°æ†©ã€‚åˆç¡å¯å…»å¿ƒç¥ï¼Œä¸‹åˆç²¾åŠ›æ›´å……æ²›ã€‚"
            },
            {
                "name": "æœªæ—¶",
                "time": "13:00-15:00",
                "bagua": "ä¹¾å¦",
                "organ": "å°è‚ ç»",
                "function": "å°è‚ å¸æ”¶è¥å…»ï¼Œåˆ†æ¸…æµŠæ¶²",
                "health": "é¥­åè¡¥æ°´ï¼ˆå¦‚ç»¿èŒ¶ï¼‰ï¼Œä¿ƒè¥å…»å¸æ”¶",
                "tips": "å°è‚ åˆ†æ¸…æµŠï¼Œæ­¤æ—¶å¤šå–æ°´æœ‰åŠ©è¥å…»å¸æ”¶å’ŒåºŸç‰©æ’æ³„ã€‚"
            },
            {
                "name": "ç”³æ—¶",
                "time": "15:00-17:00",
                "bagua": "åå¦",
                "organ": "è†€èƒ±ç»",
                "function": "è†€èƒ±æ’æ³„æ°´æ¶²ï¼Œç–é€šé˜³æ°”",
                "health": "å¤šå–æ°´+è½»è¿åŠ¨ï¼ˆå¦‚æ•£æ­¥ã€æ•²æ‰“èƒŒéƒ¨ï¼‰",
                "tips": "è†€èƒ±ç»æœ€é•¿ï¼Œæ­¤æ—¶é€‚åˆè¿åŠ¨æ’æ¯’ï¼Œå¤šå–æ°´ä¿ƒè¿›ä»£è°¢ã€‚"
            },
            {
                "name": "é…‰æ—¶",
                "time": "17:00-19:00",
                "bagua": "è‰®å¦",
                "organ": "è‚¾ç»",
                "function": "è‚¾è—ç²¾åï¼Œè°ƒèŠ‚ç”Ÿæ®–ç”Ÿé•¿",
                "health": "æ¸…æ·¡æ™šé¤ï¼ŒæŒ‰æ‘©å¤ªæºªç©´æŠ¤è‚¾",
                "tips": "è‚¾ä¸ºå…ˆå¤©ä¹‹æœ¬ï¼Œæ­¤æ—¶å®œé™å…»ï¼Œæ™šé¤æ¸…æ·¡ï¼Œä¿æŠ¤è‚¾ç²¾ã€‚"
            },
            {
                "name": "æˆŒæ—¶",
                "time": "19:00-21:00",
                "bagua": "éœ‡å¦",
                "organ": "å¿ƒåŒ…ç»",
                "function": "å¿ƒåŒ…ä»£å¿ƒè¡Œä»¤ï¼Œä¿æŠ¤å¿ƒè„",
                "health": "æ”¾æ¾æƒ…ç»ªï¼ˆèŠå¤©ã€å†¥æƒ³ï¼‰ï¼ŒæŒ‰æ‘©å†…å…³ç©´",
                "tips": "å¿ƒåŒ…æŠ¤å¿ƒä¸»ï¼Œå®œæ”¾æ¾å¿ƒæƒ…ï¼Œä¸å®¶äººäº¤æµï¼Œå‡†å¤‡å…¥ç¡ã€‚"
            },
            {
                "name": "äº¥æ—¶",
                "time": "21:00-23:00",
                "bagua": "å·½å¦",
                "organ": "ä¸‰ç„¦ç»",
                "function": "ä¸‰ç„¦é€šç™¾è„‰ï¼Œåè°ƒæ°´æ°”è¿è¡Œ",
                "health": "å‡†å¤‡ç¡çœ ï¼Œæ³¡è„šã€å†¥æƒ³ç­‰æ´»åŠ¨",
                "tips": "ä¸‰ç„¦ä¸»æ°”åŒ–ï¼Œæ­¤æ—¶åº”å‡†å¤‡ç¡çœ ï¼Œæ³¡è„šå¯åŠ©çœ å®‰ç¥ã€‚"
            }
        ]
        if 0 <= shichen_index < len(shichen_details):
            info = shichen_details[shichen_index]
            self.show_shichen_dialog(info)
    def show_shichen_dialog(self, info):
        """æ˜¾ç¤ºæ—¶è¾°ä¿¡æ¯å¯¹è¯æ¡†"""
        dialog = QDialog(self)
        dialog.setWindowTitle(f"{info['name']} - è¯¦ç»†ä¿¡æ¯")
        dialog.setFixedSize(500, 400)
        dialog.setModal(True)
        # è®¾ç½®å¯¹è¯æ¡†æ ·å¼
        dialog.setStyleSheet("""
            QDialog {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
                color: #FFD700;
                border: 2px solid #FFD700;
                border-radius: 10px;
            }
            QLabel {
                color: #FFFFFF;
                font-size: 14px;
                padding: 5px;
                background: transparent;
            }
            QLabel#title {
                color: #FFD700;
                font-size: 18px;
                font-weight: bold;
                text-align: center;
            }
            QLabel#subtitle {
                color: #FFA500;
                font-size: 16px;
                font-weight: bold;
            }
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 15px;
                color: #FFD700;
                font-weight: bold;
                padding: 10px;
                min-width: 80px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }
        """)
        layout = QVBoxLayout()
        # æ ‡é¢˜
        title_label = QLabel(f"{info['name']} ({info['time']})")
        title_label.setObjectName("title")
        title_label.setAlignment(Qt.AlignCenter)
        layout.addWidget(title_label)
        # å¯¹åº”ç»ç»œ
        bagua_label = QLabel(f"å¯¹åº”ç»ç»œï¼š{info['bagua']} - {info['organ']}")
        bagua_label.setObjectName("subtitle")
        layout.addWidget(bagua_label)
        # åŠŸèƒ½æè¿°
        function_label = QLabel(f"åŠŸèƒ½ä½œç”¨ï¼š{info['function']}")
        layout.addWidget(function_label)
        # å…»ç”Ÿè¦ç‚¹
        health_label = QLabel(f"å…»ç”Ÿè¦ç‚¹ï¼š{info['health']}")
        layout.addWidget(health_label)
        # è¯¦ç»†è¯´æ˜
        tips_label = QLabel(f"è¯¦ç»†è¯´æ˜ï¼š{info['tips']}")
        tips_label.setWordWrap(True)
        layout.addWidget(tips_label)
        # å…³é—­æŒ‰é’®
        close_btn = QPushButton("å…³é—­")
        close_btn.clicked.connect(dialog.close)
        layout.addWidget(close_btn)
        dialog.setLayout(layout)
        dialog.exec_()
    def handle_hover_change(self, hover_shichen):
        """å¤„ç†é¼ æ ‡æ‚¬åœå˜åŒ–"""
        # å…³é—­å½“å‰æ‚¬åœå¯¹è¯æ¡†
        if self.hover_dialog:
            self.hover_dialog.close()
            self.hover_dialog = None
        self.current_hover_shichen = hover_shichen
        # å¦‚æœé¼ æ ‡æ‚¬åœåœ¨æ—¶è¾°ä¸Šï¼Œæ˜¾ç¤ºæ‚¬åœå¯¹è¯æ¡†
        if hover_shichen is not None:
            self.show_hover_dialog(hover_shichen)
    def show_hover_dialog(self, shichen_index):
        """æ˜¾ç¤ºæ‚¬åœå¯¹è¯æ¡†ï¼ˆå•ä¸€æ¡†ä½“ï¼Œä¸é€æ˜èƒŒæ™¯ï¼‰"""
        # è·å–æ—¶è¾°è¯¦ç»†ä¿¡æ¯
        shichen_details = [
            {
                "name": "å­æ—¶",
                "time": "23:00-1:00",
                "bagua": "åå¦",
                "organ": "èƒ†ç»",
                "function": "èƒ†æ°”ç”Ÿå‘ï¼Œå¯åŠ¨å…¨èº«æ°”è¡€å¾ªç¯",
                "health": "åŠ¡å¿…ç¡çœ ï¼Œé¿å…ç†¬å¤œ",
                "tips": "æ­¤æ—¶åº”æ·±ç¡ï¼Œè®©èƒ†ç»å……åˆ†ä¼‘æ¯ï¼Œä¸ºæ˜æ—¥ç”Ÿå‘é˜³æ°”åšå‡†å¤‡ã€‚"
            },
            {
                "name": "ä¸‘æ—¶",
                "time": "1:00-3:00",
                "bagua": "è‰®å¦",
                "organ": "è‚ç»",
                "function": "è‚è—è¡€è§£æ¯’ï¼Œå‡€åŒ–è¡€æ¶²",
                "health": "æ·±åº¦ç¡çœ ï¼Œå¿Œé¥®é…’ã€ç”¨çœ¼",
                "tips": "è‚ç»å½“ä»¤ï¼Œè¡€å½’äºè‚ã€‚ç†¬å¤œæœ€ä¼¤è‚ï¼Œæ­¤æ—¶å¿…é¡»ç†Ÿç¡ã€‚"
            },
            {
                "name": "å¯…æ—¶",
                "time": "3:00-5:00",
                "bagua": "éœ‡å¦",
                "organ": "è‚ºç»",
                "function": "è‚ºåˆ†é…æ°”è¡€è‡³å…¨èº«",
                "health": "ä¿æŒç†Ÿç¡ï¼Œé¿å…æ—©æ™¨æˆ–è¿åŠ¨",
                "tips": "è‚ºæœç™¾è„‰ï¼Œå°†æ°”è¡€è¾“é€å…¨èº«ã€‚è€äººå¸¸åœ¨æ­¤æ—¶é†’æ¥å±æ­£å¸¸ã€‚"
            },
            {
                "name": "å¯æ—¶",
                "time": "5:00-7:00",
                "bagua": "å·½å¦",
                "organ": "å¤§è‚ ç»",
                "function": "æ’æ³„ç³Ÿç²•ï¼Œæ¸…ç†è‚ é“",
                "health": "å–æ¸©æ°´+æ’ä¾¿ï¼ŒæŒ‰æ‘©å¤©æ¢ç©´ä¿ƒä»£è°¢",
                "tips": "å¤§è‚ ç»å½“ä»¤ï¼Œæœ€ä½³æ’ä¾¿æ—¶é—´ã€‚ä¸€æ¯æ¸©æ°´ä¿ƒè¿›è‚ é“è •åŠ¨ã€‚"
            },
            {
                "name": "è¾°æ—¶",
                "time": "7:00-9:00",
                "bagua": "ç¦»å¦",
                "organ": "èƒƒç»",
                "function": "èƒƒè…ç†Ÿé£Ÿç‰©ï¼Œè½¬åŒ–èƒ½é‡",
                "health": "åƒè¥å…»æ—©é¤ï¼ˆå¦‚ç²¥ã€é¸¡è›‹ï¼‰ï¼Œå¿Œç©ºè…¹",
                "tips": "èƒƒç»æœ€æ—ºï¼Œæ—©é¤è¦åƒå¥½ã€‚æ­¤æ—¶æ¶ˆåŒ–èƒ½åŠ›æœ€å¼ºï¼Œè¥å…»å¸æ”¶æœ€ä½³ã€‚"
            },
            {
                "name": "å·³æ—¶",
                "time": "9:00-11:00",
                "bagua": "å¤å¦",
                "organ": "è„¾ç»",
                "function": "è„¾è¿åŒ–è¥å…»ï¼Œè¾“å¸ƒå…¨èº«",
                "health": "é«˜æ•ˆå·¥ä½œ/å­¦ä¹ ï¼Œé€‚å½“æ´»åŠ¨å››è‚¢",
                "tips": "è„¾ä¸»è¿åŒ–ï¼Œæ­¤æ—¶å·¥ä½œå­¦ä¹ æ•ˆç‡æœ€é«˜ï¼Œå¤§è„‘æ€ç»´æœ€æ´»è·ƒã€‚"
            },
            {
                "name": "åˆæ—¶",
                "time": "11:00-13:00",
                "bagua": "å…‘å¦",
                "organ": "å¿ƒç»",
                "function": "å¿ƒä¸»è¡€è„‰ï¼Œç»´æŒç¥å¿—",
                "health": "åˆä¼‘20-30åˆ†é’Ÿï¼Œå…»å¿ƒå®‰ç¥",
                "tips": "å¿ƒç»å½“ä»¤ï¼Œé€‚åˆå°æ†©ã€‚åˆç¡å¯å…»å¿ƒç¥ï¼Œä¸‹åˆç²¾åŠ›æ›´å……æ²›ã€‚"
            },
            {
                "name": "æœªæ—¶",
                "time": "13:00-15:00",
                "bagua": "ä¹¾å¦",
                "organ": "å°è‚ ç»",
                "function": "å°è‚ å¸æ”¶è¥å…»ï¼Œåˆ†æ¸…æµŠæ¶²",
                "health": "é¥­åè¡¥æ°´ï¼ˆå¦‚ç»¿èŒ¶ï¼‰ï¼Œä¿ƒè¥å…»å¸æ”¶",
                "tips": "å°è‚ åˆ†æ¸…æµŠï¼Œæ­¤æ—¶å¤šå–æ°´æœ‰åŠ©è¥å…»å¸æ”¶å’ŒåºŸç‰©æ’æ³„ã€‚"
            },
            {
                "name": "ç”³æ—¶",
                "time": "15:00-17:00",
                "bagua": "åå¦",
                "organ": "è†€èƒ±ç»",
                "function": "è†€èƒ±æ’æ³„æ°´æ¶²ï¼Œç–é€šé˜³æ°”",
                "health": "å¤šå–æ°´+è½»è¿åŠ¨ï¼ˆå¦‚æ•£æ­¥ã€æ•²æ‰“èƒŒéƒ¨ï¼‰",
                "tips": "è†€èƒ±ç»æœ€é•¿ï¼Œæ­¤æ—¶é€‚åˆè¿åŠ¨æ’æ¯’ï¼Œå¤šå–æ°´ä¿ƒè¿›ä»£è°¢ã€‚"
            },
            {
                "name": "é…‰æ—¶",
                "time": "17:00-19:00",
                "bagua": "è‰®å¦",
                "organ": "è‚¾ç»",
                "function": "è‚¾è—ç²¾åï¼Œè°ƒèŠ‚ç”Ÿæ®–ç”Ÿé•¿",
                "health": "æ¸…æ·¡æ™šé¤ï¼ŒæŒ‰æ‘©å¤ªæºªç©´æŠ¤è‚¾",
                "tips": "è‚¾ä¸ºå…ˆå¤©ä¹‹æœ¬ï¼Œæ­¤æ—¶å®œé™å…»ï¼Œæ™šé¤æ¸…æ·¡ï¼Œä¿æŠ¤è‚¾ç²¾ã€‚"
            },
            {
                "name": "æˆŒæ—¶",
                "time": "19:00-21:00",
                "bagua": "éœ‡å¦",
                "organ": "å¿ƒåŒ…ç»",
                "function": "å¿ƒåŒ…ä»£å¿ƒè¡Œä»¤ï¼Œä¿æŠ¤å¿ƒè„",
                "health": "æ”¾æ¾æƒ…ç»ªï¼ˆèŠå¤©ã€å†¥æƒ³ï¼‰ï¼ŒæŒ‰æ‘©å†…å…³ç©´",
                "tips": "å¿ƒåŒ…æŠ¤å¿ƒä¸»ï¼Œå®œæ”¾æ¾å¿ƒæƒ…ï¼Œä¸å®¶äººäº¤æµï¼Œå‡†å¤‡å…¥ç¡ã€‚"
            },
            {
                "name": "äº¥æ—¶",
                "time": "21:00-23:00",
                "bagua": "å·½å¦",
                "organ": "ä¸‰ç„¦ç»",
                "function": "ä¸‰ç„¦é€šç™¾è„‰ï¼Œåè°ƒæ°´æ°”è¿è¡Œ",
                "health": "å‡†å¤‡ç¡çœ ï¼Œæ³¡è„šã€å†¥æƒ³ç­‰æ´»åŠ¨",
                "tips": "ä¸‰ç„¦ä¸»æ°”åŒ–ï¼Œæ­¤æ—¶åº”å‡†å¤‡ç¡çœ ï¼Œæ³¡è„šå¯åŠ©çœ å®‰ç¥ã€‚"
            }
        ]
        if 0 <= shichen_index < len(shichen_details):
            info = shichen_details[shichen_index]
            # åˆ›å»ºæ‚¬åœå¯¹è¯æ¡†ï¼ˆå•ä¸€æ¡†ä½“ï¼‰
            self.hover_dialog = QWidget()
            self.hover_dialog.setWindowFlags(Qt.ToolTip | Qt.FramelessWindowHint)
            self.hover_dialog.setFixedSize(380, 200)

            # è®¾ç½®å¯¹è¯æ¡†æ ·å¼ï¼ˆä¸é€æ˜èƒŒæ™¯ï¼Œæ¸…æ™°å¯è¯»ï¼‰
            self.hover_dialog.setStyleSheet("""
                QWidget {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 #2A2A2A, stop:1 #1A1A1A);
                    border: 2px solid #FFD700;
                    border-radius: 10px;
                }
            """)
            # åˆ›å»ºå•ä¸€æ ‡ç­¾æ˜¾ç¤ºæ‰€æœ‰ä¿¡æ¯
            info_text = f"""<div style="color: #FFD700; font-size: 16px; font-weight: bold; text-align: center; margin-bottom: 8px;">
{info['name']} ({info['time']})
</div>
<div style="color: #FFA500; font-size: 14px; font-weight: bold; margin-bottom: 6px;">
å¯¹åº”ç»ç»œï¼š{info['bagua']} - {info['organ']}
</div>
<div style="color: #FFFFFF; font-size: 12px; margin-bottom: 4px;">
åŠŸèƒ½ä½œç”¨ï¼š{info['function']}
</div>
<div style="color: #FFFFFF; font-size: 12px; margin-bottom: 4px;">
å…»ç”Ÿè¦ç‚¹ï¼š{info['health']}
</div>
<div style="color: #FFFFFF; font-size: 12px;">
è¯¦ç»†è¯´æ˜ï¼š{info['tips']}
</div>"""
            info_label = QLabel(info_text)
            info_label.setWordWrap(True)
            info_label.setAlignment(Qt.AlignTop)
            info_label.setStyleSheet("background: transparent; padding: 10px;")
            layout = QVBoxLayout()
            layout.setContentsMargins(0, 0, 0, 0)
            layout.addWidget(info_label)
            self.hover_dialog.setLayout(layout)

            # è®¡ç®—å¯¹è¯æ¡†ä½ç½®ï¼ˆé¼ æ ‡æ—è¾¹ï¼‰
            cursor_pos = QCursor.pos()
            self.hover_dialog.move(cursor_pos.x() + 15, cursor_pos.y() + 15)
            # æ˜¾ç¤ºå¯¹è¯æ¡†
            self.hover_dialog.show()

    def mousePressEvent(self, event):
        """é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶"""
        if event.button() == Qt.LeftButton:
            # æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æ—¶è¾°åŒºåŸŸ
            clicked_shichen = self.get_clicked_shichen(event.pos())
            if clicked_shichen is not None:
                self.show_shichen_info(clicked_shichen)
                event.accept()
                return
            # å¦‚æœæ²¡æœ‰ç‚¹å‡»æ—¶è¾°ï¼Œåˆ™è¿›è¡Œçª—å£æ‹–åŠ¨
            self.drag_position = event.globalPos() - self.frameGeometry().topLeft()
            event.accept()
    def mouseMoveEvent(self, event):
        """é¼ æ ‡ç§»åŠ¨äº‹ä»¶"""
        if event.buttons() == Qt.LeftButton and self.drag_position:
            self.move(event.globalPos() - self.drag_position)
            event.accept()
        else:
            # æ£€æŸ¥é¼ æ ‡æ‚¬åœçš„æ—¶è¾°
            hover_shichen = self.get_clicked_shichen(event.pos())
            if hover_shichen != self.current_hover_shichen:
                # é¼ æ ‡ç§»åˆ°æ–°çš„æ—¶è¾°æˆ–ç¦»å¼€æ—¶è¾°åŒºåŸŸ
                self.handle_hover_change(hover_shichen)
            event.accept()
    def wheelEvent(self, event):
        """é¼ æ ‡æ»šè½®äº‹ä»¶ - ç¼©æ”¾æ—¶é’Ÿ"""
        # è·å–æ»šè½®æ»šåŠ¨æ–¹å‘
        delta = event.angleDelta().y()
        # è®¡ç®—ç¼©æ”¾æ­¥é•¿ï¼ˆæ›´ç²¾ç»†çš„æ§åˆ¶ï¼‰
        zoom_step = 0.05
        if delta > 0:
            # å‘ä¸Šæ»šåŠ¨ - æ”¾å¤§
            if self.scale_factor < 2.0:  # æœ€å¤§æ”¾å¤§åˆ°2å€
                self.scale_factor += zoom_step
                self.update_size()
        else:
            # å‘ä¸‹æ»šåŠ¨ - ç¼©å°
            if self.scale_factor > 0.5:  # æœ€å°ç¼©å°åˆ°0.5å€
                self.scale_factor -= zoom_step
                self.update_size()
        event.accept()
    def load_alarms(self):
        """åŠ è½½é—¹é’Ÿ - å¢å¼ºå¼‚å¸¸å¤„ç†å’Œç¼–ç å¤„ç†"""
        self.alarms = []  # é»˜è®¤å€¼
        try:
            import os
            if not os.path.exists('alarms.json'):
                print("ğŸ“ é—¹é’Ÿæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®")
                self.create_default_alarms_file()
                return
            # å°è¯•å¤šç§ç¼–ç æ–¹å¼è¯»å–æ–‡ä»¶
            encodings = ['utf-8', 'utf-8-sig', 'gbk', 'cp1252']
            content = None
            for encoding in encodings:
                try:
                    with open('alarms.json', 'r', encoding=encoding) as f:
                        content = f.read().strip()
                        break
                except UnicodeDecodeError:
                    continue
            if content is None:
                print("âš ï¸ æ— æ³•è¯»å–é—¹é’Ÿæ–‡ä»¶ï¼Œé‡æ–°åˆ›å»º")
                self.create_default_alarms_file()
                return
            # æ¸…ç†å¯èƒ½çš„BOMå’Œç‰¹æ®Šå­—ç¬¦
            content = content.replace('\ufeff', '').replace('\x00', '').strip()
            if not content or content in ['', '[]', '[ ]']:
                print("ğŸ“ é—¹é’Ÿæ–‡ä»¶ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤é…ç½®")
                self.create_default_alarms_file()
                return
            # å°è¯•è§£æJSON
            try:
                self.alarms = json.loads(content)
                if not isinstance(self.alarms, list):
                    print("âš ï¸ é—¹é’Ÿæ•°æ®æ ¼å¼é”™è¯¯ï¼Œé‡ç½®ä¸ºç©ºåˆ—è¡¨")
                    self.create_default_alarms_file()
            except json.JSONDecodeError:
                print("âš ï¸ JSONæ ¼å¼é”™è¯¯ï¼Œé‡æ–°åˆ›å»ºæ–‡ä»¶")
                self.create_default_alarms_file()
        except Exception as e:
            print(f"âš ï¸ åŠ è½½é—¹é’Ÿæ—¶å‡ºç°æœªçŸ¥é”™è¯¯: {e}")
            self.create_default_alarms_file()
    def create_default_alarms_file(self):
        """åˆ›å»ºé»˜è®¤çš„é—¹é’Ÿæ–‡ä»¶"""
        try:
            self.alarms = []
            with open('alarms.json', 'w', encoding='utf-8') as f:
                json.dump([], f, ensure_ascii=False, indent=2)
            print("âœ… å·²åˆ›å»ºé»˜è®¤é—¹é’Ÿæ–‡ä»¶")
        except Exception as e:
            print(f"âŒ åˆ›å»ºé»˜è®¤é—¹é’Ÿæ–‡ä»¶å¤±è´¥: {e}")
            self.alarms = []
    def save_alarms(self):
        """ä¿å­˜é—¹é’Ÿ - å¢å¼ºå¼‚å¸¸å¤„ç†"""
        try:
            # å…ˆä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ï¼ŒæˆåŠŸåå†æ›¿æ¢åŸæ–‡ä»¶
            temp_filename = 'alarms_temp.json'
            with open(temp_filename, 'w', encoding='utf-8') as f:
                json.dump(self.alarms, f, ensure_ascii=False, indent=2)
            # éªŒè¯å†™å…¥çš„æ–‡ä»¶
            with open(temp_filename, 'r', encoding='utf-8') as f:
                json.load(f)  # éªŒè¯JSONæ ¼å¼æ­£ç¡®
            # æ›¿æ¢åŸæ–‡ä»¶
            import shutil
            shutil.move(temp_filename, 'alarms.json')
            print("âœ… é—¹é’Ÿæ•°æ®ä¿å­˜æˆåŠŸ")
        except json.JSONEncodeError as e:
            print(f"âš ï¸ é—¹é’Ÿæ•°æ®JSONç¼–ç é”™è¯¯: {e}")
        except (IOError, OSError, PermissionError) as e:
            print(f"âš ï¸ ä¿å­˜é—¹é’Ÿæ–‡ä»¶å¤±è´¥: {e}")
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            try:
                import os
                if os.path.exists('alarms_temp.json'):
                    os.remove('alarms_temp.json')
            except:
                pass
        except Exception as e:
            print(f"âš ï¸ ä¿å­˜é—¹é’Ÿæ—¶å‡ºç°æœªçŸ¥é”™è¯¯: {e}")
    def check_alarms(self):
        """æ£€æŸ¥é—¹é’Ÿ - å¢å¼ºæ•°æ®ç»“æ„è®¿é—®ä¿æŠ¤"""
        try:
            if not hasattr(self, 'alarms') or not isinstance(self.alarms, list):
                print("âš ï¸ é—¹é’Ÿæ•°æ®æ— æ•ˆ")
                return
            current_time = self.current_time.strftime("%H:%M")
            # éå†é—¹é’Ÿåˆ—è¡¨ï¼Œå¢åŠ è¾¹ç•Œæ£€æŸ¥
            for i, alarm in enumerate(self.alarms):
                try:
                    # æ£€æŸ¥é—¹é’Ÿæ•°æ®å®Œæ•´æ€§
                    if not isinstance(alarm, dict):
                        print(f"âš ï¸ é—¹é’Ÿ{i}æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè·³è¿‡")
                        continue
                    if 'time' not in alarm:
                        print(f"âš ï¸ é—¹é’Ÿ{i}ç¼ºå°‘æ—¶é—´ä¿¡æ¯ï¼Œè·³è¿‡")
                        continue
                    alarm_time = alarm['time']
                    if not isinstance(alarm_time, str):
                        print(f"âš ï¸ é—¹é’Ÿ{i}æ—¶é—´æ ¼å¼é”™è¯¯ï¼Œè·³è¿‡")
                        continue
                    # æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘é—¹é’Ÿ
                    if alarm_time == current_time and not alarm.get('triggered', False):
                        self.trigger_alarm(alarm)
                        alarm['triggered'] = True
                        print(f"âœ… è§¦å‘é—¹é’Ÿ{i}: {alarm_time}")
                    elif alarm_time != current_time:
                        alarm['triggered'] = False
                except Exception as e:
                    print(f"âš ï¸ å¤„ç†é—¹é’Ÿ{i}æ—¶å‡ºé”™: {e}")
                    continue
        except Exception as e:
            print(f"âš ï¸ æ£€æŸ¥é—¹é’Ÿæ—¶å‡ºé”™: {e}")

    def _ensure_audio_ready(self, context: str) -> bool:
        """
        ç¡®ä¿ pygame éŸ³é¢‘å¯ç”¨ã€‚
        åœ¨ä¸å¯ç”¨æˆ–åˆå§‹åŒ–å¤±è´¥æ—¶ï¼Œä»…æç¤ºä¸€æ¬¡å¹¶è¿”å› Falseã€‚
        """
        if not _is_pygame_ready():
            self.audio_available = False
            if not self._audio_warning_shown:
                warning = (
                    "å½“å‰ç¯å¢ƒæœªå®‰è£… pygameï¼Œæ— æ³•æ’­æ”¾æé†’éŸ³æ•ˆã€‚\n"
                    "è¯·åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…³é—­å£°éŸ³æé†’æˆ–å®‰è£… pygame åé‡è¯•ã€‚"
                )
                print(f"âš ï¸ [{context}] {warning}")
                try:
                    QMessageBox.warning(self, "éŸ³é¢‘ä¸å¯ç”¨", warning)
                except Exception:
                    pass
                self._audio_warning_shown = True
            return False
        try:
            if not pygame.mixer.get_init():
                pygame.mixer.init()
            self.audio_available = True
            return True
        except Exception as e:
            self.audio_available = False
            if not self._audio_warning_shown:
                warning = f"pygame éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥ï¼ŒåŸå› ï¼š{e}"
                print(f"âš ï¸ [{context}] {warning}")
                try:
                    QMessageBox.warning(self, "éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥", warning)
                except Exception:
                    pass
                self._audio_warning_shown = True
            return False
    def trigger_alarm(self, alarm):
        """è§¦å‘é—¹é’Ÿ - å¢å¼ºéŸ³é¢‘æ’­æ”¾å¼‚å¸¸å¤„ç†"""
        music_played = False
        try:
            # æ£€æŸ¥alarmå‚æ•°æœ‰æ•ˆæ€§
            if not isinstance(alarm, dict):
                print("âš ï¸ é—¹é’Ÿæ•°æ®æ ¼å¼é”™è¯¯")
                alarm = {'note': 'é—¹é’Ÿæé†’'}
            music_path = self.settings_cache.get('default_music_path', 'C:/Users/86188/Desktop/é‡‘å…‰å’’.mp3')
            import os
            audio_ready = self._ensure_audio_ready("é—¹é’Ÿæé†’")
            if audio_ready:
                if os.path.exists(music_path):
                    try:
                        pygame.mixer.music.load(music_path)
                        pygame.mixer.music.play()
                        music_played = True
                        print(f"âœ… é—¹é’ŸéŸ³ä¹æ’­æ”¾æˆåŠŸ: {music_path}")
                    except pygame.error as e:
                        print(f"âš ï¸ pygameéŸ³é¢‘æ’­æ”¾å¤±è´¥: {e}")
                    except (OSError, IOError) as e:
                        print(f"âš ï¸ éŸ³é¢‘æ–‡ä»¶è®¿é—®å¤±è´¥: {e}")
                else:
                    print(f"âš ï¸ éŸ³ä¹æ–‡ä»¶ä¸å­˜åœ¨: {music_path}")
            else:
                if not os.path.exists(music_path):
                    print(f"âš ï¸ éŸ³é¢‘æ¨¡å—ä¸å¯ç”¨ä¸”éŸ³ä¹æ–‡ä»¶ä¸å­˜åœ¨ï¼š{music_path}")
        except Exception as e:
            print(f"âš ï¸ æ’­æ”¾é—¹é’ŸéŸ³ä¹æ—¶å‡ºé”™: {e}")
        # æ˜¾ç¤ºé—¹é’Ÿæ¶ˆæ¯
        try:
            alarm_note = alarm.get('note', 'é—¹é’Ÿæé†’') if isinstance(alarm, dict) else 'é—¹é’Ÿæé†’'
            QMessageBox.information(self, "é—¹é’Ÿ", f"æ—¶é—´åˆ°äº†ï¼\n{alarm_note}")
        except Exception as e:
            print(f"âš ï¸ æ˜¾ç¤ºé—¹é’Ÿæ¶ˆæ¯å¤±è´¥: {e}")
        # åœæ­¢éŸ³ä¹
        if music_played and _is_pygame_ready():
            try:
                pygame.mixer.music.stop()
                print("âœ… é—¹é’ŸéŸ³ä¹å·²åœæ­¢")
            except Exception as e:
                print(f"âš ï¸ åœæ­¢é—¹é’ŸéŸ³ä¹æ—¶å‡ºé”™: {e}")
    def check_shichen_reminder(self):
        """æ£€æŸ¥æ—¶è¾°è‡ªåŠ¨æé†’"""
        # æ£€æŸ¥æ—¶è¾°æé†’æ˜¯å¦å¯ç”¨
        if not self.settings_cache.get('shichen_reminder_enabled', True):
            return
        current_hour = self.current_time.hour
        current_minute = self.current_time.minute
        # è®¡ç®—å½“å‰æ—¶è¾°ç´¢å¼•
        _current_shichen_index = (current_hour + 1) // 2 % 12
        # æ—¶è¾°åˆ‡æ¢æ—¶é—´ç‚¹ï¼ˆæ¯ä¸ªæ—¶è¾°çš„å¼€å§‹æ—¶é—´ï¼‰
        shichen_start_times = [
            (23, 0),  # å­æ—¶ 23:00
            (1, 0),   # ä¸‘æ—¶ 1:00
            (3, 0),   # å¯…æ—¶ 3:00
            (5, 0),   # å¯æ—¶ 5:00
            (7, 0),   # è¾°æ—¶ 7:00
            (9, 0),   # å·³æ—¶ 9:00
            (11, 0),  # åˆæ—¶ 11:00
            (13, 0),  # æœªæ—¶ 13:00
            (15, 0),  # ç”³æ—¶ 15:00
            (17, 0),  # é…‰æ—¶ 17:00
            (19, 0),  # æˆŒæ—¶ 19:00
            (21, 0)   # äº¥æ—¶ 21:00
        ]

        # æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æ—¶è¾°åˆ‡æ¢æ—¶é—´ï¼ˆå‰5åˆ†é’Ÿå†…ï¼‰
        for i, (start_hour, _start_minute) in enumerate(shichen_start_times):
            if current_hour == start_hour and 0 <= current_minute <= 5:
                # æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºè¿‡è¿™ä¸ªæ—¶è¾°çš„æé†’
                reminder_key = f"{i}_{self.current_time.strftime('%Y%m%d')}"
                if reminder_key not in self.shichen_reminder_shown:
                    self.show_shichen_info(i)
                    self.play_shichen_music()  # æ’­æ”¾æ—¶è¾°æé†’éŸ³ä¹
                    self.shichen_reminder_shown[reminder_key] = True
                    break
        # æ¸…ç†è¿‡æœŸçš„æé†’çŠ¶æ€ï¼ˆéå½“å¤©çš„è®°å½•ï¼‰
        if hasattr(self, 'shichen_reminder_shown'):
            for key in list(self.shichen_reminder_shown.keys()):
                if not key.endswith(self.current_time.strftime('%Y%m%d')):
                    del self.shichen_reminder_shown[key]
    def play_shichen_music(self):
        """æ’­æ”¾æ—¶è¾°æé†’éŸ³ä¹"""
        try:
            # è·å–éŸ³ä¹æ–‡ä»¶è·¯å¾„
            music_path = self.settings_cache.get('default_music_path', 'C:/Users/86188/Desktop/é‡‘å…‰å’’.mp3')
            if self._ensure_audio_ready("æ—¶è¾°æé†’"):
                if os.path.exists(music_path):
                    pygame.mixer.music.load(music_path)
                    volume = self.settings_cache.get('volume', 70) / 100.0
                    pygame.mixer.music.set_volume(volume)
                    pygame.mixer.music.play()
                    print(f"ğŸµ æ—¶è¾°æé†’éŸ³ä¹æ’­æ”¾ï¼š{music_path}")
                    duration = self.settings_cache.get('shichen_music_duration', 10)
                    QTimer.singleShot(duration * 1000, self.stop_shichen_music)
                else:
                    print(f"âš ï¸ æ—¶è¾°æé†’éŸ³ä¹æ–‡ä»¶ä¸å­˜åœ¨ï¼š{music_path}")
        except Exception as e:
            print(f"âš ï¸ æ’­æ”¾æ—¶è¾°æé†’éŸ³ä¹æ—¶å‡ºé”™ï¼š{e}")
    def stop_shichen_music(self):
        """åœæ­¢æ—¶è¾°æé†’éŸ³ä¹"""
        try:
            if _is_pygame_ready() and pygame.mixer.get_init():
                pygame.mixer.music.stop()
                print("âœ… æ—¶è¾°æé†’éŸ³ä¹å·²åœæ­¢")
        except Exception as e:
            print(f"âš ï¸ åœæ­¢æ—¶è¾°æé†’éŸ³ä¹æ—¶å‡ºé”™ï¼š{e}")
    def check_health_reminder(self):
        """æ£€æŸ¥å¥åº·æé†’"""
        # æ£€æŸ¥å¥åº·æé†’æ˜¯å¦å¯ç”¨
        if not self.settings_cache.get('health_reminder_enabled', True):
            return
        current_hour = self.current_time.hour
        current_minute = self.current_time.minute
        # å¥åº·æé†’æ—¶é—´ç‚¹
        health_reminders = {
            6: "ğŸŒ… æ—©å®‰ï¼å»ºè®®èµ·åºŠåå–ä¸€æ¯æ¸©æ°´",
            8: "ğŸ³ æ—©é¤æ—¶é—´ï¼Œè®°å¾—è¥å…»æ­é…",
            10: "ğŸ’§ å·¥ä½œé—´éš™ï¼Œè®°å¾—å–æ°´",
            12: "ğŸ½ï¸ åˆé¤æ—¶é—´ï¼Œå»ºè®®é€‚é‡è¿åŠ¨",
            14: "â˜• ä¸‹åˆèŒ¶æ—¶é—´ï¼Œå¯ä»¥å–æ¯èŒ¶",
            16: "ğŸš¶ é€‚åˆæ•£æ­¥ï¼Œæ´»åŠ¨ç­‹éª¨",
            18: "ğŸ½ï¸ æ™šé¤æ—¶é—´ï¼Œå»ºè®®æ¸…æ·¡é¥®é£Ÿ",
            20: "ğŸ“š å­¦ä¹ æ—¶é—´ï¼Œæ³¨æ„ç”¨çœ¼å«ç”Ÿ",
            22: "ğŸ˜´ å‡†å¤‡ç¡è§‰ï¼Œå»ºè®®æ³¡è„š",
            23: "ğŸŒ™ æ™šå®‰æ—¶é—´ï¼Œæ—©ç‚¹ä¼‘æ¯"
        }
        # æ£€æŸ¥æ˜¯å¦éœ€è¦æé†’ï¼ˆåªåœ¨æ•´ç‚¹æ˜¾ç¤ºä¸€æ¬¡ï¼‰
        if current_hour in health_reminders and current_minute == 0:
            # æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºè¿‡è¿™ä¸ªå°æ—¶çš„æé†’
            reminder_key = f"{current_hour}_{self.current_time.strftime('%Y%m%d')}"
            if not hasattr(self, 'health_reminder_shown'):
                self.health_reminder_shown = {}
            if reminder_key not in self.health_reminder_shown:
                self.show_health_reminder(health_reminders[current_hour])
                self.health_reminder_shown[reminder_key] = True
        elif current_minute != 0:
            # æ¸…é™¤éæ•´ç‚¹çš„æé†’çŠ¶æ€
            if hasattr(self, 'health_reminder_shown'):
                for key in list(self.health_reminder_shown.keys()):
                    if not key.endswith(self.current_time.strftime('%Y%m%d')):
                        del self.health_reminder_shown[key]
    def show_health_reminder(self, message):
        """æ˜¾ç¤ºå¥åº·æé†’å¼¹çª—"""
        msg_box = QMessageBox(self)
        msg_box.setWindowTitle("å¥åº·æé†’")
        msg_box.setText(message)
        msg_box.setIcon(QMessageBox.Information)
        msg_box.setWindowFlags(Qt.Dialog | Qt.WindowStaysOnTopHint | Qt.WindowCloseButtonHint)
        msg_box.setStyleSheet("""
            QMessageBox {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
                color: #FFD700;
                border: 2px solid #FFD700;
                border-radius: 10px;
            }
            QMessageBox QLabel {
                color: #FFFFFF;
                font-size: 16px;
                font-weight: bold;
                padding: 20px;
            }
            QMessageBox QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 15px;
                color: #FFD700;
                font-weight: bold;
                padding: 10px;
                min-width: 80px;
            }
            QMessageBox QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }
        """)
        # æ’­æ”¾éŸ³ä¹ - å¢å¼ºå¼‚å¸¸å¤„ç†
        music_played = False
        try:
            # ä»ç¼“å­˜è®¾ç½®ä¸­è¯»å–éŸ³ä¹è·¯å¾„å’ŒéŸ³é‡
            music_path = self.settings_cache.get('default_music_path', 'C:/Users/86188/Desktop/é‡‘å…‰å’’.mp3')
            volume = self.settings_cache.get('volume', 70) / 100.0
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            import os
            if self._ensure_audio_ready("å¥åº·æé†’"):
                if os.path.exists(music_path):
                    try:
                        pygame.mixer.music.load(music_path)
                        pygame.mixer.music.set_volume(max(0.0, min(1.0, volume)))  # ç¡®ä¿éŸ³é‡åœ¨æœ‰æ•ˆèŒƒå›´
                        pygame.mixer.music.play()
                        music_played = True
                        print(f"âœ… å¥åº·æé†’éŸ³ä¹æ’­æ”¾æˆåŠŸ")
                    except pygame.error as e:
                        print(f"âš ï¸ pygameéŸ³é¢‘æ’­æ”¾å¤±è´¥: {e}")
                    except (OSError, IOError) as e:
                        print(f"âš ï¸ éŸ³é¢‘æ–‡ä»¶è®¿é—®å¤±è´¥: {e}")
                else:
                    print(f"âš ï¸ éŸ³ä¹æ–‡ä»¶ä¸å­˜åœ¨: {music_path}")
        except Exception as e:
            print(f"âš ï¸ æ’­æ”¾å¥åº·æé†’éŸ³ä¹æ—¶å‡ºé”™: {e}")
        msg_box.exec_()
        # åœæ­¢éŸ³ä¹
        if music_played and _is_pygame_ready():
            try:
                pygame.mixer.music.stop()
                print("âœ… å¥åº·æé†’éŸ³ä¹å·²åœæ­¢")
            except Exception as e:
                print(f"âš ï¸ åœæ­¢å¥åº·æé†’éŸ³ä¹æ—¶å‡ºé”™: {e}")
    def load_system_settings(self):
        """åŠ è½½ç³»ç»Ÿè®¾ç½® - å¢å¼ºå¼‚å¸¸å¤„ç†"""
        default_settings = {
            'default_music_path': 'C:/Users/86188/Desktop/é‡‘å…‰å’’.mp3',
            'notepad_enabled': True,
            'alarm_enabled': True,
            'health_reminder_enabled': True,
            'shichen_reminder_enabled': True,
            'lunar_display_enabled': True,
            'volume': 70,
            'time_font_size': 10,
            'window_opacity': 100,
            'shichen_music_duration': 15,
            'health_reminder_interval': 60,
            'shichen_advance_minutes': 5,
            'autostart_enabled': False,
            'default_scale': 60,
            'camera_enabled': True
        }
        try:
            import os
            if not os.path.exists('system_settings.json'):
                print("ğŸ“ ç³»ç»Ÿè®¾ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®")
                return default_settings
            # å°è¯•å¤šç§ç¼–ç æ–¹å¼è¯»å–æ–‡ä»¶
            encodings = ['utf-8', 'utf-8-sig', 'gbk', 'cp1252']
            content = None
            for encoding in encodings:
                try:
                    with open('system_settings.json', 'r', encoding=encoding) as f:
                        content = f.read().strip()
                        break
                except UnicodeDecodeError:
                    continue
            if content is None:
                print("âš ï¸ æ— æ³•è¯»å–ç³»ç»Ÿè®¾ç½®æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®")
                self.save_system_settings(default_settings)
                return default_settings
            # æ¸…ç†å¯èƒ½çš„BOMå’Œç‰¹æ®Šå­—ç¬¦
            content = content.replace('\ufeff', '').replace('\x00', '').strip()
            if not content or content in ['', '{}', '{ }']:
                print("ğŸ“ ç³»ç»Ÿè®¾ç½®æ–‡ä»¶ä¸ºç©ºï¼Œåˆ›å»ºé»˜è®¤é…ç½®")
                self.save_system_settings(default_settings)
                return default_settings
            # å°è¯•è§£æJSON
            try:
                settings = json.loads(content)
                if not isinstance(settings, dict):
                    print("âš ï¸ ç³»ç»Ÿè®¾ç½®æ•°æ®æ ¼å¼é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤é…ç½®")
                    self.save_system_settings(default_settings)
                    return default_settings
                # å…¼å®¹æ—§å­—æ®µå
                if 'shichen_music_duration' not in settings and 'music_duration' in settings:
                    settings['shichen_music_duration'] = settings['music_duration']
                # åˆå¹¶é»˜è®¤è®¾ç½®ï¼Œç¡®ä¿æ‰€æœ‰å¿…éœ€çš„é”®éƒ½å­˜åœ¨
                for key, value in default_settings.items():
                    if key not in settings:
                        settings[key] = value
                return settings
            except json.JSONDecodeError:
                print("âš ï¸ ç³»ç»Ÿè®¾ç½®JSONæ ¼å¼é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤é…ç½®")
                self.save_system_settings(default_settings)
                return default_settings
        except json.JSONDecodeError as e:
            print(f"âš ï¸ ç³»ç»Ÿè®¾ç½®æ–‡ä»¶JSONæ ¼å¼é”™è¯¯: {e}")
            print("ğŸ”§ æ­£åœ¨é‡æ–°åˆ›å»ºç³»ç»Ÿè®¾ç½®æ–‡ä»¶...")
            self.save_system_settings(default_settings)
            return default_settings
        except (IOError, OSError, PermissionError) as e:
            print(f"âš ï¸ è¯»å–ç³»ç»Ÿè®¾ç½®æ–‡ä»¶å¤±è´¥: {e}")
            self.save_system_settings(default_settings)
            return default_settings
        except Exception as e:
            print(f"âš ï¸ åŠ è½½ç³»ç»Ÿè®¾ç½®æ—¶å‡ºç°æœªçŸ¥é”™è¯¯: {e}")
            self.save_system_settings(default_settings)
            return default_settings
    def save_system_settings(self, settings: dict):
        """ä¿å­˜ç³»ç»Ÿè®¾ç½®åˆ°ç£ç›˜ï¼Œå¹¶æ›´æ–°ç¼“å­˜ã€‚"""
        try:
            if not isinstance(settings, dict):
                raise ValueError("ç³»ç»Ÿè®¾ç½®å¿…é¡»æ˜¯å­—å…¸ç±»å‹")
            with open('system_settings.json', 'w', encoding='utf-8') as f:
                json.dump(settings, f, ensure_ascii=False, indent=2)
            self.settings_cache = settings
            print("âœ… ç³»ç»Ÿè®¾ç½®å·²ä¿å­˜")
        except Exception as e:
            print(f"âš ï¸ ä¿å­˜ç³»ç»Ÿè®¾ç½®å¤±è´¥: {e}")
    def closeEvent(self, event):
        """ä¸»ç¨‹åºå…³é—­äº‹ä»¶ - é˜²æ­¢æ„å¤–å…³é—­ï¼Œå¢å¼ºå®‰å…¨æ£€æŸ¥"""
        try:
            # å¦‚æœæ˜¯é€šè¿‡ç¡®è®¤å¯¹è¯æ¡†å…³é—­çš„ï¼Œç›´æ¥æ¥å—
            if hasattr(self, '_confirmed_close') and self._confirmed_close:
                # è¿›è¡Œå®‰å…¨çš„èµ„æºæ¸…ç†
                self._safe_cleanup()
                event.accept()
                return
            # å¦åˆ™è¯¢é—®ç”¨æˆ·æ˜¯å¦çœŸçš„è¦å…³é—­
            try:
                msg = QMessageBox(self)
                msg.setWindowTitle('ç¡®è®¤é€€å‡º')
                msg.setText('ç¡®å®šè¦é€€å‡ºå…«å¦æ—¶é’Ÿå—ï¼Ÿ\n\nä¸»ç¨‹åºé€€å‡ºåï¼š\nâ€¢ å…«å¦æ—¶é’ŸåŠŸèƒ½å°†åœæ­¢\nâ€¢ æ—¶é—´æé†’åŠŸèƒ½å°†åœæ­¢\nâ€¢ æ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜\n\nå¦‚æœåªæ˜¯æƒ³å…³é—­è­¦å‘Šçª—å£ï¼Œè¯·ç‚¹å‡»"å¦"')
                msg.setStandardButtons(QMessageBox.Yes | QMessageBox.No)
                msg.setDefaultButton(QMessageBox.No)
                msg.setWindowFlags(Qt.Dialog | Qt.WindowStaysOnTopHint | Qt.WindowCloseButtonHint)
                reply = msg.exec_()
                if reply == QMessageBox.Yes:
                    # æ ‡è®°ä¸ºç¡®è®¤å…³é—­
                    self._confirmed_close = True
                    # è¿›è¡Œå®‰å…¨çš„èµ„æºæ¸…ç†
                    self._safe_cleanup()
                    event.accept()
                else:
                    # ç”¨æˆ·é€‰æ‹©ä¸å…³é—­ä¸»ç¨‹åº
                    event.ignore()
            except Exception as e:
                print(f"âš ï¸ æ˜¾ç¤ºå…³é—­ç¡®è®¤å¯¹è¯æ¡†å¤±è´¥: {e}")
                # å¦‚æœå¯¹è¯æ¡†å¤±è´¥ï¼Œå…è®¸ç›´æ¥å…³é—­ä½†è¿›è¡Œæ¸…ç†
                self._safe_cleanup()
                event.accept()
        except Exception as e:
            print(f"âš ï¸ å¤„ç†å…³é—­äº‹ä»¶æ—¶å‡ºé”™: {e}")
            # æœ€åçš„å®‰å…¨æªæ–½
            event.accept()
    def _safe_cleanup(self):
        """å®‰å…¨çš„èµ„æºæ¸…ç†"""
        try:
            # ğŸ”„ å¼€å§‹å®‰å…¨èµ„æºæ¸…ç†
            # ä¿å­˜æ‰€æœ‰æ•°æ®
            try:
                self.save_alarms()
                print("âœ… é—¹é’Ÿæ•°æ®å·²ä¿å­˜")
            except Exception as e:
                print(f"âš ï¸ ä¿å­˜é—¹é’Ÿæ•°æ®å¤±è´¥: {e}")
            # å®‰å…¨å…³é—­æ‰€æœ‰å­çª—å£
            window_list = [
                ('advanced_health_monitor_window', 'é«˜çº§å¥åº·ç›‘æµ‹'),
                ('ai_health_monitor_window', 'AIå¥åº·ç›‘æµ‹'),
                ('health_monitor_window', 'åŸºç¡€å¥åº·ç›‘æµ‹'),
                ('notepad_window', 'è®°äº‹æœ¬'),
                ('alarm_window', 'é—¹é’Ÿè®¾ç½®'),
                ('settings_window', 'ç³»ç»Ÿè®¾ç½®')
            ]
            for window_attr, window_name in window_list:
                if hasattr(self, window_attr) and getattr(self, window_attr):
                    try:
                        window_obj = getattr(self, window_attr)
                        # ç‰¹æ®Šå¤„ç†å¥åº·ç›‘æµ‹çª—å£
                        if 'health_monitor' in window_attr:
                            # æ£€æŸ¥å¹¶åœæ­¢ç›‘æµ‹
                            if hasattr(window_obj, 'is_monitoring') and window_obj.is_monitoring:
                                if hasattr(window_obj, 'stop_monitoring'):
                                    window_obj.stop_monitoring()
                                    print(f"âœ… {window_name}ç›‘æµ‹å·²åœæ­¢")
                            # ä¿å­˜è®¾ç½®
                            if hasattr(window_obj, 'save_settings'):
                                window_obj.save_settings()
                                print(f"âœ… {window_name}è®¾ç½®å·²ä¿å­˜")
                        # å…³é—­çª—å£
                        if hasattr(window_obj, 'close'):
                            window_obj.close()
                            print(f"âœ… {window_name}çª—å£å·²å…³é—­")
                        # æ¸…ç©ºå¼•ç”¨
                        setattr(self, window_attr, None)
                    except Exception as e:
                        print(f"âš ï¸ å…³é—­{window_name}çª—å£å¤±è´¥: {e}")
            # åœæ­¢æ‰€æœ‰å®šæ—¶å™¨
            timer_list = ['time_timer', 'animation_timer', 'reminder_timer']
            for timer_name in timer_list:
                try:
                    if hasattr(self, timer_name):
                        timer_obj = getattr(self, timer_name)
                        if timer_obj and hasattr(timer_obj, 'stop'):
                            timer_obj.stop()
                            print(f"âœ… {timer_name}å·²åœæ­¢")
                except Exception as e:
                    print(f"âš ï¸ åœæ­¢{timer_name}å¤±è´¥: {e}")
            # åœæ­¢éŸ³ä¹æ’­æ”¾
            if _is_pygame_ready():
                try:
                    if pygame.mixer.get_init():
                        pygame.mixer.music.stop()
                        print("âœ… éŸ³ä¹æ’­æ”¾å·²åœæ­¢")
                except Exception:
                    pass
            # âœ… å®‰å…¨èµ„æºæ¸…ç†å®Œæˆ
        except Exception as e:
            # âš ï¸ å®‰å…¨èµ„æºæ¸…ç†å¤±è´¥
            pass
class SystemSettingsWindow(QWidget):
    """ç³»ç»Ÿè®¾ç½®çª—å£"""
    def __init__(self, parent=None):
        super().__init__(parent)
        self.parent_window = parent
        self.setWindowTitle("ç³»ç»Ÿè®¾ç½® - å…«å¦æ—¶é’Ÿ V2.0.0")
        self.setFixedSize(720, 750)
        self.setWindowFlags(Qt.Window | Qt.WindowStaysOnTopHint | Qt.WindowCloseButtonHint)
        self.settings = self.load_settings()
        self.init_ui()
        # è®¾ç½®æ ·å¼
        self.setStyleSheet("""
            QWidget {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
                color: #FFD700;
            }
            QGroupBox {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #3A3A3A, stop:1 #2A2A2A);
                border: 1px solid #FFD700;
                border-radius: 6px;
                color: #FFD700;
                font-weight: bold;
                font-size: 11px;
                padding: 8px;
                margin-top: 6px;
                margin-bottom: 4px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 10px;
                padding: 0 10px 0 10px;
            }
            QLineEdit {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #3A3A3A, stop:1 #2A2A2A);
                border: 1px solid #FFD700;
                border-radius: 4px;
                color: #FFFFFF;
                font-size: 11px;
                font-weight: bold;
                padding: 6px;
                min-height: 20px;
            }
            QCheckBox {
                color: #FFFFFF;
                font-size: 12px;
                spacing: 8px;
            }
            QCheckBox::indicator {
                width: 18px;
                height: 18px;
            }
            QCheckBox::indicator:unchecked {
                border: 2px solid #FFD700;
                border-radius: 3px;
                background: #2A2A2A;
            }
            QCheckBox::indicator:checked {
                border: 2px solid #FFD700;
                border-radius: 3px;
                background: #FFD700;
                image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAxMiAxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEwIDNMNC41IDguNUwyIDYiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+);
            }
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 12px;
                color: #FFD700;
                font-weight: bold;
                padding: 8px 15px;
                min-width: 80px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }
            QLabel {
                color: #FFD700;
                font-weight: bold;
                font-size: 12px;
            }
        """)
    def init_ui(self):
        """åˆå§‹åŒ–ç•Œé¢"""
        main_layout = QVBoxLayout()
        main_layout.setContentsMargins(12, 8, 12, 8)
        main_layout.setSpacing(6)
        # æ ‡é¢˜
        title = QLabel("âš™ï¸ ç³»ç»Ÿè®¾ç½®")
        title.setStyleSheet("""
            QLabel {
                color: #FFD700;
                font-size: 14px;
                font-weight: bold;
                padding: 3px;
                background: transparent;
            }
        """)
        title.setAlignment(Qt.AlignCenter)
        # åˆ›å»ºæ»šåŠ¨åŒºåŸŸ
        scroll_area = QScrollArea()
        scroll_area.setWidgetResizable(True)
        scroll_area.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        scroll_area.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)
        scroll_area.setStyleSheet("""
            QScrollArea {
                border: none;
                background: transparent;
            }
            QScrollBar:vertical {
                background: #2A2A2A;
                width: 12px;
                border-radius: 6px;
            }
            QScrollBar::handle:vertical {
                background: #FFD700;
                border-radius: 6px;
                min-height: 20px;
            }
        """)
        # æ»šåŠ¨å†…å®¹åŒºåŸŸ
        scroll_content = QWidget()
        content_layout = QVBoxLayout(scroll_content)
        content_layout.setSpacing(6)
        content_layout.setContentsMargins(8, 8, 8, 8)
        # éŸ³ä¹è®¾ç½®ç»„
        music_group = QGroupBox("ğŸµ éŸ³ä¹è®¾ç½®")
        music_layout = QVBoxLayout()
        music_layout.setSpacing(6)
        music_layout.setContentsMargins(6, 6, 6, 6)
        # é»˜è®¤éŸ³ä¹è·¯å¾„ - ä½¿ç”¨ç½‘æ ¼å¸ƒå±€èŠ‚çœç©ºé—´
        music_path_layout = QGridLayout()
        music_label = QLabel("éŸ³ä¹æ–‡ä»¶:")
        music_label.setFixedWidth(60)
        self.music_path_edit = QLineEdit(self.settings.get('default_music_path', 'C:/Users/86188/Desktop/é‡‘å…‰å’’.mp3'))
        self.music_path_edit.setMinimumHeight(28)
        music_path_layout.addWidget(music_label, 0, 0)
        music_path_layout.addWidget(self.music_path_edit, 0, 1)
        browse_btn = QPushButton("æµè§ˆ")
        browse_btn.setFixedSize(45, 28)
        browse_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 1px solid #FFD700;
                border-radius: 4px;
                color: #FFD700;
                font-weight: bold;
                font-size: 10px;
                padding: 2px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }
        """)
        browse_btn.clicked.connect(self.browse_music_file)
        test_music_btn = QPushButton("è¯•å¬")
        test_music_btn.setFixedSize(45, 28)
        test_music_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 1px solid #FFD700;
                border-radius: 4px;
                color: #FFD700;
                font-weight: bold;
                font-size: 10px;
                padding: 2px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }
        """)
        test_music_btn.clicked.connect(self.test_default_music)
        music_path_layout.addWidget(browse_btn, 0, 2)
        music_path_layout.addWidget(test_music_btn, 0, 3)
        music_layout.addLayout(music_path_layout)
        music_group.setLayout(music_layout)
        # åŠŸèƒ½å¼€å…³ç»„
        function_group = QGroupBox("ğŸ”§ åŠŸèƒ½æ¨¡å—")
        function_layout = QGridLayout()
        function_layout.setSpacing(6)
        function_layout.setContentsMargins(6, 6, 6, 6)
        function_layout.setColumnStretch(0, 1)
        function_layout.setColumnStretch(1, 1)
        self.notepad_checkbox = QCheckBox("æ™ºèƒ½è®°äº‹æœ¬")
        self.notepad_checkbox.setChecked(self.settings.get('notepad_enabled', True))
        self.alarm_checkbox = QCheckBox("é—¹é’Ÿæé†’")
        self.alarm_checkbox.setChecked(self.settings.get('alarm_enabled', True))
        self.health_reminder_checkbox = QCheckBox("å¥åº·æé†’")
        self.health_reminder_checkbox.setChecked(self.settings.get('health_reminder_enabled', True))
        self.shichen_reminder_checkbox = QCheckBox("æ—¶è¾°æé†’")
        self.shichen_reminder_checkbox.setChecked(self.settings.get('shichen_reminder_enabled', True))
        self.lunar_display_checkbox = QCheckBox("å†œå†æ˜¾ç¤º")
        self.lunar_display_checkbox.setChecked(self.settings.get('lunar_display_enabled', True))
        # å¥åº·ç›‘æµ‹æ‘„åƒå¤´å¼€å…³
        if ADVANCED_HEALTH_MONITOR_AVAILABLE or AI_HEALTH_MONITOR_AVAILABLE or HEALTH_MONITOR_AVAILABLE:
            self.camera_enabled_checkbox = QCheckBox("ğŸ¥ æ‘„åƒå¤´ç›‘æµ‹")
            self.camera_enabled_checkbox.setChecked(self.settings.get('camera_enabled', True))
            self.camera_enabled_checkbox.setToolTip("å¯ç”¨/ç¦ç”¨æ‘„åƒå¤´å¥åº·ç›‘æµ‹åŠŸèƒ½")
        function_layout.addWidget(self.notepad_checkbox, 0, 0)
        function_layout.addWidget(self.alarm_checkbox, 0, 1)
        function_layout.addWidget(self.health_reminder_checkbox, 1, 0)
        function_layout.addWidget(self.shichen_reminder_checkbox, 1, 1)
        function_layout.addWidget(self.lunar_display_checkbox, 2, 0)
        if ADVANCED_HEALTH_MONITOR_AVAILABLE or AI_HEALTH_MONITOR_AVAILABLE or HEALTH_MONITOR_AVAILABLE:
            function_layout.addWidget(self.camera_enabled_checkbox, 3, 0)
        function_group.setLayout(function_layout)
        # æ˜¾ç¤ºè®¾ç½®ç»„
        display_group = QGroupBox("ğŸ¨ æ˜¾ç¤ºè®¾ç½®")
        display_layout = QGridLayout()
        display_layout.setSpacing(6)
        display_layout.setContentsMargins(6, 6, 6, 6)
        # æ—¶é—´å­—ä½“å¤§å° - ç´§å‡‘å¸ƒå±€
        font_label = QLabel("æ—¶é—´å­—ä½“:")
        font_label.setFixedWidth(70)
        self.font_size_slider = QSlider(Qt.Horizontal)
        self.font_size_slider.setRange(8, 16)
        self.font_size_slider.setValue(self.settings.get('time_font_size', 14))
        self.font_size_slider.valueChanged.connect(self.update_font_size_label)
        self.font_size_slider.setMaximumWidth(120)
        self.font_size_label = QLabel(f"{self.font_size_slider.value()}px")
        self.font_size_label.setFixedWidth(30)

        # é€æ˜åº¦è®¾ç½® - ç´§å‡‘å¸ƒå±€
        opacity_label = QLabel("çª—å£é€æ˜åº¦:")
        opacity_label.setFixedWidth(70)
        self.opacity_slider = QSlider(Qt.Horizontal)
        self.opacity_slider.setRange(50, 100)
        self.opacity_slider.setValue(self.settings.get('window_opacity', 100))
        self.opacity_slider.valueChanged.connect(self.update_opacity_label)
        self.opacity_slider.setMaximumWidth(120)
        self.opacity_label = QLabel(f"{self.opacity_slider.value()}%")
        self.opacity_label.setFixedWidth(30)

        # ç½‘æ ¼å¸ƒå±€ - ä¸¤è¡Œç´§å‡‘æ’åˆ—
        display_layout.addWidget(font_label, 0, 0)
        display_layout.addWidget(self.font_size_slider, 0, 1)
        display_layout.addWidget(self.font_size_label, 0, 2)
        display_layout.addWidget(opacity_label, 1, 0)
        display_layout.addWidget(self.opacity_slider, 1, 1)
        display_layout.addWidget(self.opacity_label, 1, 2)
        display_group.setLayout(display_layout)
        # éŸ³é¢‘è®¾ç½®ç»„
        audio_group = QGroupBox("ğŸ”Š éŸ³é¢‘è®¾ç½®")
        audio_layout = QGridLayout()
        audio_layout.setSpacing(6)
        audio_layout.setContentsMargins(6, 6, 6, 6)
        # æé†’éŸ³é‡ - ç´§å‡‘å¸ƒå±€
        volume_label = QLabel("æé†’éŸ³é‡:")
        volume_label.setFixedWidth(70)
        self.volume_slider = QSlider(Qt.Horizontal)
        self.volume_slider.setRange(0, 100)
        self.volume_slider.setValue(self.settings.get('volume', 70))
        self.volume_slider.valueChanged.connect(self.update_volume_label)
        self.volume_slider.setMaximumWidth(120)
        self.volume_label = QLabel(f"{self.volume_slider.value()}%")
        self.volume_label.setFixedWidth(30)

        # éŸ³ä¹æ’­æ”¾æ—¶é•¿ - ç´§å‡‘å¸ƒå±€
        duration_label = QLabel("æ’­æ”¾æ—¶é•¿:")
        duration_label.setFixedWidth(70)
        self.duration_spinbox = QSpinBox()
        self.duration_spinbox.setRange(5, 60)
        self.duration_spinbox.setValue(
            self.settings.get('shichen_music_duration',
                              self.settings.get('music_duration', 15))
        )
        self.duration_spinbox.setSuffix("ç§’")
        self.duration_spinbox.setMinimumHeight(26)
        self.duration_spinbox.setMaximumWidth(80)
        self.duration_spinbox.setStyleSheet("""
            QSpinBox {
                background: #5A5A5A;
                border: 2px solid #FFD700;
                border-radius: 6px;
                color: #FFFFFF;
                font-size: 13px;
                font-weight: bold;
                padding: 6px;
            }
            QSpinBox::up-button, QSpinBox::down-button {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border: 1px solid #FFD700;
                width: 14px;
                height: 10px;
                border-radius: 2px;
            }
            QSpinBox::up-button {
                subcontrol-origin: border;
                subcontrol-position: top right;
                margin-right: 1px;
                margin-top: 1px;
            }
            QSpinBox::down-button {
                subcontrol-origin: border;
                subcontrol-position: bottom right;
                margin-right: 1px;
                margin-bottom: 1px;
            }
        """)
        # ç½‘æ ¼å¸ƒå±€ - ç´§å‡‘æ’åˆ—
        audio_layout.addWidget(volume_label, 0, 0)
        audio_layout.addWidget(self.volume_slider, 0, 1)
        audio_layout.addWidget(self.volume_label, 0, 2)
        audio_layout.addWidget(duration_label, 1, 0)
        audio_layout.addWidget(self.duration_spinbox, 1, 1)
        audio_group.setLayout(audio_layout)
        # æé†’è®¾ç½®ç»„
        reminder_group = QGroupBox("â° æé†’è®¾ç½®")
        reminder_layout = QGridLayout()
        reminder_layout.setSpacing(6)
        reminder_layout.setContentsMargins(6, 6, 6, 6)
        # å¥åº·æé†’é—´éš” - ç´§å‡‘å¸ƒå±€
        health_label = QLabel("å¥åº·æé†’é—´éš”:")
        health_label.setFixedWidth(90)
        self.health_interval_spinbox = QSpinBox()
        self.health_interval_spinbox.setRange(30, 240)
        self.health_interval_spinbox.setValue(self.settings.get('health_reminder_interval', 60))
        self.health_interval_spinbox.setSuffix("åˆ†é’Ÿ")
        self.health_interval_spinbox.setMinimumHeight(26)
        self.health_interval_spinbox.setMaximumWidth(80)
        self.health_interval_spinbox.setStyleSheet("""
            QSpinBox {
                background: #5A5A5A;
                border: 2px solid #FFD700;
                border-radius: 6px;
                color: #FFFFFF;
                font-size: 13px;
                font-weight: bold;
                padding: 6px;
            }
            QSpinBox::up-button, QSpinBox::down-button {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border: 1px solid #FFD700;
                width: 14px;
                height: 10px;
                border-radius: 2px;
            }
            QSpinBox::up-button {
                subcontrol-origin: border;
                subcontrol-position: top right;
                margin-right: 1px;
                margin-top: 1px;
            }
            QSpinBox::down-button {
                subcontrol-origin: border;
                subcontrol-position: bottom right;
                margin-right: 1px;
                margin-bottom: 1px;
            }
        """)
        # æ—¶è¾°æé†’æå‰æ—¶é—´ - ç´§å‡‘å¸ƒå±€
        shichen_label = QLabel("æ—¶è¾°æé†’æå‰:")
        shichen_label.setFixedWidth(90)
        self.shichen_advance_spinbox = QSpinBox()
        self.shichen_advance_spinbox.setRange(0, 10)
        self.shichen_advance_spinbox.setValue(self.settings.get('shichen_advance_minutes', 5))
        self.shichen_advance_spinbox.setSuffix("åˆ†é’Ÿ")
        self.shichen_advance_spinbox.setMinimumHeight(26)
        self.shichen_advance_spinbox.setMaximumWidth(80)
        self.shichen_advance_spinbox.setStyleSheet("""
            QSpinBox {
                background: #5A5A5A;
                border: 2px solid #FFD700;
                border-radius: 6px;
                color: #FFFFFF;
                font-size: 13px;
                font-weight: bold;
                padding: 6px;
            }
            QSpinBox::up-button, QSpinBox::down-button {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border: 1px solid #FFD700;
                width: 14px;
                height: 10px;
                border-radius: 2px;
            }
            QSpinBox::up-button {
                subcontrol-origin: border;
                subcontrol-position: top right;
                margin-right: 1px;
                margin-top: 1px;
            }
            QSpinBox::down-button {
                subcontrol-origin: border;
                subcontrol-position: bottom right;
                margin-right: 1px;
                margin-bottom: 1px;
            }
        """)
        # ç½‘æ ¼å¸ƒå±€ - ä¸¤è¡Œç´§å‡‘æ’åˆ—
        reminder_layout.addWidget(health_label, 0, 0)
        reminder_layout.addWidget(self.health_interval_spinbox, 0, 1)
        reminder_layout.addWidget(shichen_label, 1, 0)
        reminder_layout.addWidget(self.shichen_advance_spinbox, 1, 1)
        reminder_group.setLayout(reminder_layout)
        # ç³»ç»Ÿè®¾ç½®ç»„
        system_group = QGroupBox("ğŸ–¥ï¸ ç³»ç»Ÿè®¾ç½®")
        system_layout = QGridLayout()
        system_layout.setSpacing(6)
        system_layout.setContentsMargins(6, 6, 6, 6)
        # å¼€æœºè‡ªå¯åŠ¨
        self.autostart_checkbox = QCheckBox("å¼€æœºè‡ªåŠ¨å¯åŠ¨")
        self.autostart_checkbox.setChecked(self.settings.get('autostart_enabled', False))
        # ç¼©æ”¾è®¾ç½® - ç´§å‡‘å¸ƒå±€
        scale_label = QLabel("å½“å‰ç¼©æ”¾:")
        scale_label.setFixedWidth(70)
        self.scale_slider = QSlider(Qt.Horizontal)
        self.scale_slider.setRange(50, 200)
        self.scale_slider.setMaximumWidth(120)
        # æ˜¾ç¤ºå½“å‰ä¸»çª—å£çš„å®é™…ç¼©æ”¾æ¯”ä¾‹
        current_scale = int(self.settings.get('default_scale', 100))
        if self.parent_window:
            current_scale = int(self.parent_window.scale_factor * 100)
        self.scale_slider.setValue(current_scale)
        self.scale_slider.valueChanged.connect(self.update_scale_label)
        self.scale_label = QLabel(f"{self.scale_slider.value()}%")
        self.scale_label.setFixedWidth(30)

        # ç½‘æ ¼å¸ƒå±€ - ç´§å‡‘æ’åˆ—
        system_layout.addWidget(self.autostart_checkbox, 0, 0, 1, 3)
        system_layout.addWidget(scale_label, 1, 0)
        system_layout.addWidget(self.scale_slider, 1, 1)
        system_layout.addWidget(self.scale_label, 1, 2)
        system_group.setLayout(system_layout)
        # æ·»åŠ æ‰€æœ‰ç»„åˆ°å†…å®¹å¸ƒå±€
        content_layout.addWidget(music_group)
        content_layout.addWidget(function_group)
        content_layout.addWidget(display_group)
        content_layout.addWidget(audio_group)
        content_layout.addWidget(reminder_group)
        content_layout.addWidget(system_group)
        content_layout.addStretch()
        # è®¾ç½®æ»šåŠ¨åŒºåŸŸ
        scroll_area.setWidget(scroll_content)
        # æŒ‰é’®åŒºåŸŸ - ç´§å‡‘å¸ƒå±€
        button_layout = QHBoxLayout()
        button_layout.setSpacing(10)
        button_layout.setContentsMargins(8, 8, 8, 6)
        save_btn = QPushButton("ğŸ’¾ ä¿å­˜")
        save_btn.setFixedSize(80, 32)
        save_btn.setStyleSheet("""
            QPushButton {
                font-size: 11px;
                font-weight: bold;
                padding: 4px 8px;
            }
        """)
        save_btn.clicked.connect(self.save_settings)
        reset_btn = QPushButton("ğŸ”„ é‡ç½®")
        reset_btn.setFixedSize(80, 32)
        reset_btn.setStyleSheet("""
            QPushButton {
                font-size: 11px;
                font-weight: bold;
                padding: 4px 8px;
            }
        """)
        reset_btn.clicked.connect(self.reset_settings)
        cancel_btn = QPushButton("âŒ å–æ¶ˆ")
        cancel_btn.setFixedSize(70, 32)
        cancel_btn.setStyleSheet("""
            QPushButton {
                font-size: 11px;
                font-weight: bold;
                padding: 4px 8px;
            }
        """)
        cancel_btn.clicked.connect(self.close)
        button_layout.addWidget(save_btn)
        button_layout.addWidget(reset_btn)
        button_layout.addStretch()
        button_layout.addWidget(cancel_btn)
        # æ·»åŠ åˆ°ä¸»å¸ƒå±€
        main_layout.addWidget(title)
        main_layout.addWidget(scroll_area)
        main_layout.addLayout(button_layout)
        self.setLayout(main_layout)
    def browse_music_file(self):
        """æµè§ˆéŸ³ä¹æ–‡ä»¶"""
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            "é€‰æ‹©éŸ³ä¹æ–‡ä»¶",
            "C:/Users/86188/Desktop/",
            "éŸ³ä¹æ–‡ä»¶ (*.mp3 *.wav *.ogg);;æ‰€æœ‰æ–‡ä»¶ (*)"
        )
        if file_path:
            self.music_path_edit.setText(file_path)
    def test_default_music(self):
        """æµ‹è¯•é»˜è®¤éŸ³ä¹"""
        try:
            music_path = self.music_path_edit.text().strip()
            if not music_path:
                QMessageBox.warning(self, "è­¦å‘Š", "è¯·å…ˆè®¾ç½®éŸ³ä¹è·¯å¾„ï¼")
                return
            import os
            if not os.path.exists(music_path):
                QMessageBox.warning(self, "é”™è¯¯", "éŸ³ä¹æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°é€‰æ‹©ã€‚")
                return
            if self.parent_window and hasattr(self.parent_window, "_ensure_audio_ready"):
                if not self.parent_window._ensure_audio_ready("ç³»ç»Ÿè®¾ç½®éŸ³ä¹æµ‹è¯•"):
                    return
            elif not _is_pygame_ready():
                QMessageBox.warning(self, "éŸ³é¢‘ä¸å¯ç”¨", "å½“å‰ç¯å¢ƒæœªå®‰è£… pygameï¼Œæ— æ³•æ’­æ”¾æµ‹è¯•éŸ³é¢‘ã€‚")
                return
            pygame.mixer.music.load(music_path)
            pygame.mixer.music.set_volume(self.volume_slider.value() / 100.0)
            pygame.mixer.music.play()
            QMessageBox.information(self, "æµ‹è¯•", "æ­£åœ¨æ’­æ”¾é»˜è®¤éŸ³ä¹...")
        except Exception as e:
            QMessageBox.warning(self, "é”™è¯¯", f"æ— æ³•æ’­æ”¾éŸ³ä¹ï¼š{str(e)}")
    def update_volume_label(self, value):
        """æ›´æ–°éŸ³é‡æ ‡ç­¾"""
        self.volume_label.setText(f"{value}%")
    def update_font_size_label(self, value):
        """æ›´æ–°å­—ä½“å¤§å°æ ‡ç­¾"""
        self.font_size_label.setText(f"{value}px")
    def update_opacity_label(self, value):
        """æ›´æ–°é€æ˜åº¦æ ‡ç­¾"""
        self.opacity_label.setText(f"{value}%")
    def update_scale_label(self, value):
        """æ›´æ–°ç¼©æ”¾æ ‡ç­¾"""
        self.scale_label.setText(f"{value}%")
    def load_settings(self):
        """åŠ è½½è®¾ç½®"""
        try:
            with open('system_settings.json', 'r', encoding='utf-8') as f:
                data = json.load(f)
        except Exception:
            data = {
                'default_music_path': 'C:/Users/86188/Desktop/é‡‘å…‰å’’.mp3',
                'notepad_enabled': True,
                'alarm_enabled': True,
                'health_reminder_enabled': True,
                'shichen_reminder_enabled': True,
                'lunar_display_enabled': True,
                'volume': 70,
                'time_font_size': 14,
                'window_opacity': 100,
                'shichen_music_duration': 15,
                'health_reminder_interval': 60,
                'shichen_advance_minutes': 5,
                'autostart_enabled': False,
                'default_scale': 60,
                'camera_enabled': True
            }
        if 'shichen_music_duration' not in data and 'music_duration' in data:
            data['shichen_music_duration'] = data['music_duration']
        return data
    def save_settings(self):
        """ä¿å­˜è®¾ç½®"""
        try:
            # è·å–å½“å‰ä¸»çª—å£çš„ç¼©æ”¾æ¯”ä¾‹
            current_scale = 100  # é»˜è®¤å€¼
            if self.parent_window:
                current_scale = int(self.parent_window.scale_factor * 100)
            settings = {
                'default_music_path': self.music_path_edit.text().strip(),
                'notepad_enabled': self.notepad_checkbox.isChecked(),
                'alarm_enabled': self.alarm_checkbox.isChecked(),
                'health_reminder_enabled': self.health_reminder_checkbox.isChecked(),
                'shichen_reminder_enabled': self.shichen_reminder_checkbox.isChecked(),
                'lunar_display_enabled': self.lunar_display_checkbox.isChecked(),
                'volume': self.volume_slider.value(),
                'time_font_size': self.font_size_slider.value(),
                'window_opacity': self.opacity_slider.value(),
                'shichen_music_duration': self.duration_spinbox.value(),
                'health_reminder_interval': self.health_interval_spinbox.value(),
                'shichen_advance_minutes': self.shichen_advance_spinbox.value(),
                'autostart_enabled': self.autostart_checkbox.isChecked(),
                'default_scale': current_scale  # ä¿å­˜å½“å‰å®é™…ç¼©æ”¾æ¯”ä¾‹
            }
            # å…¼å®¹æ—§å­—æ®µ
            settings['music_duration'] = settings['shichen_music_duration']
            # æ·»åŠ å¥åº·ç›‘æµ‹æ‘„åƒå¤´è®¾ç½®
            if ADVANCED_HEALTH_MONITOR_AVAILABLE or AI_HEALTH_MONITOR_AVAILABLE or HEALTH_MONITOR_AVAILABLE:
                settings['camera_enabled'] = self.camera_enabled_checkbox.isChecked()
            with open('system_settings.json', 'w', encoding='utf-8') as f:
                json.dump(settings, f, ensure_ascii=False, indent=2)
            # è®¾ç½®å¼€æœºè‡ªå¯åŠ¨
            self.set_autostart(settings['autostart_enabled'])
            # ç«‹å³åº”ç”¨è®¾ç½®åˆ°ä¸»çª—å£
            self.apply_settings_immediately(settings)
            QMessageBox.information(self, "æˆåŠŸ", "è®¾ç½®å·²ä¿å­˜å¹¶ç«‹å³ç”Ÿæ•ˆï¼")
            # ç§»é™¤è‡ªåŠ¨å…³é—­ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨å…³é—­è®¾ç½®çª—å£
            # self.close()
        except Exception as e:
            QMessageBox.warning(self, "é”™è¯¯", f"ä¿å­˜è®¾ç½®å¤±è´¥ï¼š{str(e)}")
    def apply_settings_immediately(self, settings):
        """ç«‹å³åº”ç”¨è®¾ç½®åˆ°ä¸»çª—å£"""
        try:
            if self.parent_window:
                # åº”ç”¨çª—å£é€æ˜åº¦
                opacity = settings.get('window_opacity', 100) / 100.0
                self.parent_window.setWindowOpacity(opacity)

                # ä¿å­˜å½“å‰ç¼©æ”¾æ¯”ä¾‹åˆ°è®¾ç½®ä¸­ï¼Œè€Œä¸æ˜¯åº”ç”¨è®¾ç½®ä¸­çš„ç¼©æ”¾æ¯”ä¾‹
                current_scale_percent = int(self.parent_window.scale_factor * 100)
                settings['default_scale'] = current_scale_percent
                # æ›´æ–°ä¸»çª—å£çš„ç³»ç»Ÿè®¾ç½®ç¼“å­˜
                self.parent_window.settings_cache = settings
                # åº”ç”¨éŸ³é‡è®¾ç½®åˆ°pygame
                if _is_pygame_ready():
                    try:
                        volume = settings.get('volume', 70) / 100.0
                        pygame.mixer.music.set_volume(volume)
                    except Exception as e:
                        print(f"âš ï¸ è®¾ç½®éŸ³é‡å¤±è´¥ï¼š{e}")

                # é‡æ–°åˆå§‹åŒ–åŠŸèƒ½æŒ‰é’®çŠ¶æ€ï¼ˆæ ¹æ®enabledè®¾ç½®ï¼‰
                if hasattr(self.parent_window, 'notepad_btn'):
                    self.parent_window.notepad_btn.setEnabled(settings.get('notepad_enabled', True))
                if hasattr(self.parent_window, 'alarm_btn'):
                    self.parent_window.alarm_btn.setEnabled(settings.get('alarm_enabled', True))

                # å¼ºåˆ¶é‡ç»˜ä¸»çª—å£ä»¥åº”ç”¨æ—¶é—´å­—ä½“å¤§å°ç­‰è®¾ç½®
                self.parent_window.update()
                print(f"è®¾ç½®å·²ç«‹å³åº”ç”¨ï¼šé€æ˜åº¦={opacity*100}%, ç¼©æ”¾={current_scale_percent}%, éŸ³é‡={settings.get('volume', 70)}%")
        except Exception as e:
            print(f"ç«‹å³åº”ç”¨è®¾ç½®æ—¶å‡ºé”™ï¼š{str(e)}")
    def reset_settings(self):
        """æ¢å¤é»˜è®¤è®¾ç½®"""
        # é¦–å…ˆéªŒè¯å¯†ç 
        if not self.verify_reset_password():
            return
        # é‡è¦è­¦å‘Šå¯¹è¯æ¡†
        warning_dialog = QMessageBox(self)
        warning_dialog.setWindowTitle("âš ï¸ é‡è¦è­¦å‘Š")
        warning_dialog.setIcon(QMessageBox.Warning)
        warning_dialog.setText("æ¢å¤é»˜è®¤è®¾ç½®å°†ä¼šï¼š")
        warning_dialog.setInformativeText(
            "1. é‡ç½®æ‰€æœ‰ç³»ç»Ÿè®¾ç½®ä¸ºé»˜è®¤å€¼\n"
            "2. æ¸…é™¤è®°äº‹æœ¬æ‰€æœ‰å†…å®¹\n"
            "3. æ¸…é™¤è®°äº‹æœ¬å¯†ç \n"
            "4. åˆ é™¤æ‰€æœ‰æ—¥ç¨‹å’Œæé†’\n"
            "5. æ¸…ç©ºé—¹é’Ÿè®¾ç½®\n\n"
            "æ­¤æ“ä½œä¸å¯æ¢å¤ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ"
        )
        warning_dialog.setStyleSheet("""
            QMessageBox {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
                color: #FFD700;
                border: 2px solid #FF6666;
                border-radius: 10px;
            }
            QMessageBox QLabel {
                color: #FFFFFF;
                font-size: 14px;
                font-weight: bold;
                padding: 10px;
            }
            QMessageBox QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 12px;
                color: #FFD700;
                font-weight: bold;
                padding: 8px 15px;
                min-width: 80px;
            }
            QMessageBox QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }
        """)
        # è‡ªå®šä¹‰æŒ‰é’®
        confirm_btn = warning_dialog.addButton("ç¡®è®¤é‡ç½®", QMessageBox.YesRole)
        _cancel_btn = warning_dialog.addButton("å–æ¶ˆ", QMessageBox.NoRole)
        warning_dialog.exec_()
        if warning_dialog.clickedButton() == confirm_btn:
            try:
                # é‡ç½®ç•Œé¢è®¾ç½®
                self.music_path_edit.setText('C:/Users/86188/Desktop/é‡‘å…‰å’’.mp3')
                self.notepad_checkbox.setChecked(True)
                self.alarm_checkbox.setChecked(True)
                self.health_reminder_checkbox.setChecked(True)
                self.shichen_reminder_checkbox.setChecked(True)
                self.lunar_display_checkbox.setChecked(True)
                if ADVANCED_HEALTH_MONITOR_AVAILABLE or AI_HEALTH_MONITOR_AVAILABLE or HEALTH_MONITOR_AVAILABLE:
                    self.camera_enabled_checkbox.setChecked(True)
                self.volume_slider.setValue(70)
                self.font_size_slider.setValue(14)
                self.opacity_slider.setValue(100)
                self.duration_spinbox.setValue(15)
                self.health_interval_spinbox.setValue(60)
                self.shichen_advance_spinbox.setValue(5)
                self.autostart_checkbox.setChecked(False)
                self.scale_slider.setValue(60)
                # æ¸…é™¤æ‰€æœ‰æ•°æ®æ–‡ä»¶
                self.clear_all_data_files()
                # ç«‹å³åº”ç”¨é»˜è®¤è®¾ç½®
                default_settings = {
                    'default_music_path': 'C:/Users/86188/Desktop/é‡‘å…‰å’’.mp3',
                    'notepad_enabled': True,
                    'alarm_enabled': True,
                    'health_reminder_enabled': True,
                    'shichen_reminder_enabled': True,
                    'lunar_display_enabled': True,
                    'volume': 70,
                    'time_font_size': 14,
                    'window_opacity': 100,
                    'shichen_music_duration': 15,
                    'health_reminder_interval': 60,
                    'shichen_advance_minutes': 5,
                    'autostart_enabled': False,
                    'default_scale': 60,
                    'camera_enabled': True
                }
                default_settings['music_duration'] = default_settings['shichen_music_duration']
                self.apply_settings_immediately(default_settings)
                QMessageBox.information(self, "å®Œæˆ",
                    "ç³»ç»Ÿå·²æ¢å¤é»˜è®¤è®¾ç½®å¹¶ç«‹å³ç”Ÿæ•ˆï¼\n"
                    "è®°äº‹æœ¬å†…å®¹å·²æ¸…é™¤ï¼Œå¯†ç å·²é‡ç½®ã€‚")
            except Exception as e:
                QMessageBox.warning(self, "é”™è¯¯", f"é‡ç½®å¤±è´¥ï¼š{str(e)}")
    def verify_reset_password(self):
        """éªŒè¯æ¢å¤é»˜è®¤è®¾ç½®çš„å¯†ç """
        try:
            # åŠ è½½å¯†ç è®¾ç½®
            password_data = self.load_password_data()
            stored_password = password_data.get('password', '')
            if not stored_password:
                # å¦‚æœæ²¡æœ‰è®¾ç½®å¯†ç ï¼Œç›´æ¥å…è®¸é‡ç½®
                return True
            else:
                # éªŒè¯å¯†ç 
                return self.check_reset_password(stored_password)
        except Exception as e:
            QMessageBox.warning(self, "é”™è¯¯", f"å¯†ç éªŒè¯å¤±è´¥ï¼š{str(e)}")
            return False
    def load_password_data(self):
        """åŠ è½½å¯†ç æ•°æ®"""
        try:
            with open('notepad_password.json', 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {'password': ''}
    def check_reset_password(self, stored_password):
        """æ£€æŸ¥æ¢å¤é»˜è®¤è®¾ç½®çš„å¯†ç """
        dialog = QDialog(self)
        dialog.setWindowTitle("ğŸ”’ éªŒè¯èº«ä»½")
        dialog.setFixedSize(350, 160)
        dialog.setModal(True)
        # è®¾ç½®å¯¹è¯æ¡†æ ·å¼
        dialog.setStyleSheet("""
            QDialog {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
                color: #FFD700;
                border: 2px solid #FF6666;
                border-radius: 10px;
            }
            QLabel {
                color: #FF6666;
                font-size: 14px;
                font-weight: bold;
                padding: 5px;
                margin: 3px 0px;
            }
            QLineEdit {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #3A3A3A, stop:1 #2A2A2A);
                border: 2px solid #FF6666;
                border-radius: 6px;
                color: #FFFFFF;
                font-size: 12px;
                font-weight: bold;
                padding: 6px;
                margin: 2px 0px;
                min-height: 20px;
                max-height: 25px;
            }
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FF6666;
                border-radius: 8px;
                color: #FF6666;
                font-weight: bold;
                font-size: 11px;
                padding: 6px 12px;
                margin: 3px;
                min-width: 65px;
                min-height: 25px;
                max-height: 30px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FF8888;
            }
        """)
        layout = QVBoxLayout()
        layout.setContentsMargins(15, 10, 15, 10)
        layout.setSpacing(8)
        # æ ‡é¢˜
        title_label = QLabel("âš ï¸ æ¢å¤é»˜è®¤è®¾ç½®éœ€è¦éªŒè¯å¯†ç ")
        title_label.setAlignment(Qt.AlignCenter)
        # å¯†ç è¾“å…¥
        password_edit = QLineEdit()
        password_edit.setEchoMode(QLineEdit.Password)
        password_edit.setPlaceholderText("è¾“å…¥è®°äº‹æœ¬å¯†ç ")
        # æŒ‰é’®åŒºåŸŸ
        button_layout = QHBoxLayout()
        button_layout.setSpacing(8)
        ok_btn = QPushButton("âœ… ç¡®å®š")
        cancel_btn = QPushButton("âŒ å–æ¶ˆ")
        def verify_password():
            import hashlib
            password = password_edit.text().strip()
            hashed_password = hashlib.sha256(password.encode()).hexdigest()
            if hashed_password == stored_password:
                dialog.accept()
            else:
                QMessageBox.warning(dialog, "é”™è¯¯", "å¯†ç é”™è¯¯ï¼æ— æ³•æ‰§è¡Œé‡ç½®æ“ä½œã€‚")
                password_edit.clear()
                password_edit.setFocus()
        # å›è½¦é”®éªŒè¯
        password_edit.returnPressed.connect(verify_password)
        ok_btn.clicked.connect(verify_password)
        cancel_btn.clicked.connect(dialog.reject)
        button_layout.addWidget(ok_btn)
        button_layout.addWidget(cancel_btn)
        # æ·»åŠ ç»„ä»¶åˆ°å¸ƒå±€
        layout.addWidget(title_label)
        layout.addSpacing(8)
        layout.addWidget(password_edit)
        layout.addSpacing(10)
        layout.addLayout(button_layout)
        dialog.setLayout(layout)

        # è‡ªåŠ¨èšç„¦åˆ°å¯†ç è¾“å…¥æ¡†
        password_edit.setFocus()
        return dialog.exec_() == QDialog.Accepted

    def clear_all_data_files(self):
        """æ¸…é™¤æ‰€æœ‰æ•°æ®æ–‡ä»¶"""
        import os
        files_to_clear = [
            'notes.txt',                # è®°äº‹æœ¬å†…å®¹
            'notepad_password.json',    # è®°äº‹æœ¬å¯†ç 
            'schedules.json',           # æ—¥ç¨‹å®‰æ’
            'reminders.json',           # æé†’äº‹é¡¹
            'alarms.json'               # é—¹é’Ÿè®¾ç½®
        ]
        for file_name in files_to_clear:
            try:
                if os.path.exists(file_name):
                    os.remove(file_name)
            except Exception as e:
                print(f"åˆ é™¤æ–‡ä»¶ {file_name} å¤±è´¥ï¼š{str(e)}")
    def set_autostart(self, enabled):
        """è®¾ç½®å¼€æœºè‡ªå¯åŠ¨"""
        try:
            import winreg
            import os
            import sys
            # æ³¨å†Œè¡¨è·¯å¾„
            reg_path = r"Software\Microsoft\Windows\CurrentVersion\Run"
            app_name = "å…«å¦æ—¶é’Ÿå¯†ç ä¿æŠ¤ç‰ˆ"
            # è·å–å½“å‰ç¨‹åºè·¯å¾„
            if getattr(sys, 'frozen', False):
                # å¦‚æœæ˜¯æ‰“åŒ…åçš„exe
                app_path = sys.executable
            else:
                # å¦‚æœæ˜¯Pythonè„šæœ¬
                app_path = os.path.abspath(__file__)
            # æ‰“å¼€æ³¨å†Œè¡¨é”®
            key = winreg.OpenKey(winreg.HKEY_CURRENT_USER, reg_path, 0, winreg.KEY_ALL_ACCESS)
            if enabled:
                # æ·»åŠ å¼€æœºè‡ªå¯åŠ¨
                winreg.SetValueEx(key, app_name, 0, winreg.REG_SZ, app_path)
                print(f"å·²è®¾ç½®å¼€æœºè‡ªå¯åŠ¨ï¼š{app_path}")
            else:
                # åˆ é™¤å¼€æœºè‡ªå¯åŠ¨
                try:
                    winreg.DeleteValue(key, app_name)
                    print("å·²å–æ¶ˆå¼€æœºè‡ªå¯åŠ¨")
                except FileNotFoundError:
                    # å¦‚æœæ³¨å†Œè¡¨é¡¹ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
                    pass
            winreg.CloseKey(key)
        except Exception as e:
            print(f"è®¾ç½®å¼€æœºè‡ªå¯åŠ¨å¤±è´¥ï¼š{str(e)}")
            QMessageBox.warning(self, "è­¦å‘Š", f"è®¾ç½®å¼€æœºè‡ªå¯åŠ¨å¤±è´¥ï¼š{str(e)}")
    def check_autostart_status(self):
        """æ£€æŸ¥å¼€æœºè‡ªå¯åŠ¨çŠ¶æ€"""
        try:
            import winreg
            reg_path = r"Software\Microsoft\Windows\CurrentVersion\Run"
            app_name = "å…«å¦æ—¶é’Ÿå¯†ç ä¿æŠ¤ç‰ˆ"
            key = winreg.OpenKey(winreg.HKEY_CURRENT_USER, reg_path, 0, winreg.KEY_READ)
            try:
                _value, _ = winreg.QueryValueEx(key, app_name)
                winreg.CloseKey(key)
                return True
            except FileNotFoundError:
                winreg.CloseKey(key)
                return False
        except Exception as e:
            print(f"æ£€æŸ¥å¼€æœºè‡ªå¯åŠ¨çŠ¶æ€å¤±è´¥ï¼š{str(e)}")
            return False

    def closeEvent(self, event):
        """çª—å£å…³é—­äº‹ä»¶ - ç¡®ä¿åªå…³é—­å½“å‰çª—å£ï¼Œä¸å½±å“ä¸»ç¨‹åº"""
        try:
            # æ¸…ç†çª—å£å¼•ç”¨ï¼Œé¿å…å†…å­˜æ³„æ¼
            if hasattr(self, 'parent_window') and self.parent_window:
                if hasattr(self.parent_window, 'settings_window'):
                    self.parent_window.settings_window = None

            # æ¥å—å…³é—­äº‹ä»¶ï¼Œåªå…³é—­å½“å‰çª—å£
            event.accept()
            print("ç³»ç»Ÿè®¾ç½®çª—å£å·²å…³é—­")

        except Exception as e:
            print(f"å…³é—­ç³»ç»Ÿè®¾ç½®çª—å£æ—¶å‡ºé”™: {e}")
            # ç¡®ä¿å³ä½¿å‡ºé”™ä¹Ÿæ¥å—å…³é—­äº‹ä»¶
            event.accept()
class ProfessionalNotepad(QWidget):
    """æ™ºèƒ½ç§˜ä¹¦è®°äº‹æœ¬"""
    def __init__(self):
        super().__init__()
        self.setWindowTitle("æ™ºèƒ½ç§˜ä¹¦ - å…«å¦æ—¶é’Ÿ V2.0.0")
        self.setFixedSize(800, 700)
        self.setWindowFlags(Qt.Window | Qt.WindowStaysOnTopHint)
        # åˆå§‹åŒ–æ•°æ®
        self.schedules = []  # æ—¥ç¨‹å®‰æ’åˆ—è¡¨
        self.reminders = []  # æé†’äº‹é¡¹åˆ—è¡¨
        self.password_verified = False  # å¯†ç éªŒè¯çŠ¶æ€
        # å…ˆéªŒè¯å¯†ç 
        if not self.verify_password():
            self.close()
            return
        self.init_ui()
        self.load_notes()
        self.load_schedules()
        # å®šæ—¶å™¨æ£€æŸ¥æé†’
        self.reminder_timer = QTimer()
        self.reminder_timer.timeout.connect(self.check_reminders)
        self.reminder_timer.start(30000)  # æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
        # è®¾ç½®æ ·å¼
        self.setStyleSheet("""
            QWidget {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
                color: #FFD700;
            }
            QTabWidget::pane {
                border: 2px solid #FFD700;
                border-radius: 10px;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #3A3A3A, stop:1 #2A2A2A);
            }
            QTabWidget::tab-bar {
                alignment: center;
            }
            QTabBar::tab {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-bottom: none;
                border-radius: 8px 8px 0 0;
                color: #FFD700;
                font-weight: bold;
                padding: 8px 15px;
                margin: 2px;
            }
            QTabBar::tab:selected {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }
            QTabBar::tab:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #5A5A5A, stop:1 #3A3A3A);
            }
            QTextEdit, QLineEdit {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #3A3A3A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFFFFF;
                font-size: 12px;
                padding: 8px;
            }
            QListWidget {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #3A3A3A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFFFFF;
                font-size: 12px;
                padding: 5px;
            }
            QListWidget::item {
                padding: 5px;
                border-bottom: 1px solid #555555;
            }
            QListWidget::item:selected {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                color: #FFA500;
            }
            QDateEdit, QTimeEdit, QComboBox, QSpinBox {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #FFFFFF, stop:1 #F0F0F0);
                border: 2px solid #FFD700;
                border-radius: 6px;
                color: #000000;
                font-size: 12px;
                font-weight: bold;
                padding: 5px;
                min-width: 80px;
            }
            QSpinBox {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #5A5A5A, stop:1 #4A4A4A);
                border: 2px solid #FFD700;
                border-radius: 6px;
                color: #FFFFFF;
                font-size: 12px;
                font-weight: bold;
                padding: 6px;
                min-width: 80px;
                min-height: 25px;
            }
            QSpinBox::up-button, QSpinBox::down-button {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border: 1px solid #FFD700;
                width: 16px;
                height: 12px;
                border-radius: 3px;
            }
            QSpinBox::up-button {
                subcontrol-origin: border;
                subcontrol-position: top right;
                margin-right: 2px;
                margin-top: 2px;
            }
            QSpinBox::down-button {
                subcontrol-origin: border;
                subcontrol-position: bottom right;
                margin-right: 2px;
                margin-bottom: 2px;
            }
            QSpinBox::up-button:hover, QSpinBox::down-button:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #7A7A7A, stop:1 #5A5A5A);
            }
            QComboBox::drop-down {
                border: none;
                width: 20px;
            }
            QComboBox::down-arrow {
                image: none;
                border: 1px solid #FFD700;
                width: 8px;
                height: 8px;
            }
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 12px;
                color: #FFD700;
                font-weight: bold;
                padding: 8px 12px;
                min-width: 80px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }
            QPushButton:pressed {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #3A3A3A, stop:1 #1A1A1A);
            }
            QLabel {
                color: #FFD700;
                font-weight: bold;
                font-size: 12px;
            }
        """)
    def init_ui(self):
        """åˆå§‹åŒ–æ™ºèƒ½ç§˜ä¹¦ç•Œé¢"""
        main_layout = QVBoxLayout()
        # æ ‡é¢˜
        title = QLabel("ğŸ¤– æ™ºèƒ½ç§˜ä¹¦ - ä¸“ä¸šç‰ˆ")
        title.setStyleSheet("""
            QLabel {
                color: #FFD700;
                font-size: 20px;
                font-weight: bold;
                padding: 10px;
                background: transparent;
            }
        """)
        title.setAlignment(Qt.AlignCenter)
        # åˆ›å»ºé€‰é¡¹å¡
        self.tab_widget = QTabWidget()
        # å¿«é€Ÿè®°äº‹é€‰é¡¹å¡
        self.create_notes_tab()
        # æ—¥ç¨‹ç®¡ç†é€‰é¡¹å¡
        self.create_schedule_tab()
        # æé†’äº‹é¡¹é€‰é¡¹å¡
        self.create_reminder_tab()
        # å†å²è®°å½•é€‰é¡¹å¡
        self.create_history_tab()
        main_layout.addWidget(title)
        main_layout.addWidget(self.tab_widget)
        self.setLayout(main_layout)
    def verify_password(self):
        """éªŒè¯å¯†ç """
        try:
            # åŠ è½½å¯†ç è®¾ç½®
            password_data = self.load_password_data()
            stored_password = password_data.get('password', '')
            if not stored_password:
                # é¦–æ¬¡ä½¿ç”¨ï¼Œè®¾ç½®å¯†ç 
                return self.set_initial_password()
            else:
                # éªŒè¯å¯†ç 
                return self.check_password(stored_password)
        except Exception as e:
            QMessageBox.warning(self, "é”™è¯¯", f"å¯†ç éªŒè¯å¤±è´¥ï¼š{str(e)}")
            return False
    def load_password_data(self):
        """åŠ è½½å¯†ç æ•°æ®"""
        try:
            with open('notepad_password.json', 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {'password': ''}
    def save_password_data(self, password):
        """ä¿å­˜å¯†ç æ•°æ®"""
        import hashlib
        # ä½¿ç”¨SHA256åŠ å¯†å¯†ç 
        hashed_password = hashlib.sha256(password.encode()).hexdigest()
        password_data = {'password': hashed_password}
        with open('notepad_password.json', 'w', encoding='utf-8') as f:
            json.dump(password_data, f, ensure_ascii=False, indent=2)
    def set_initial_password(self):
        """è®¾ç½®åˆå§‹å¯†ç """
        dialog = QDialog(self)
        dialog.setWindowTitle("ğŸ”’ è®¾ç½®è®°äº‹æœ¬å¯†ç ")
        dialog.setFixedSize(380, 240)
        dialog.setModal(True)
        # è®¾ç½®å¯¹è¯æ¡†æ ·å¼
        dialog.setStyleSheet("""
            QDialog {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
                color: #FFD700;
                border: 2px solid #FFD700;
                border-radius: 10px;
            }
            QLabel {
                color: #FFFFFF;
                font-size: 12px;
                font-weight: bold;
                padding: 2px;
                margin: 1px 0px;
            }
            QLabel#title {
                color: #FFD700;
                font-size: 14px;
                font-weight: bold;
                padding: 5px;
                margin: 3px 0px;
            }
            QLineEdit {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #3A3A3A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 6px;
                color: #FFFFFF;
                font-size: 12px;
                font-weight: bold;
                padding: 6px;
                margin: 2px 0px;
                min-height: 20px;
                max-height: 25px;
            }
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFD700;
                font-weight: bold;
                font-size: 11px;
                padding: 6px 12px;
                margin: 3px;
                min-width: 65px;
                min-height: 25px;
                max-height: 30px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }
        """)
        layout = QVBoxLayout()
        layout.setContentsMargins(15, 10, 15, 10)
        layout.setSpacing(6)
        # æ ‡é¢˜
        title_label = QLabel("ğŸ”’ é¦–æ¬¡ä½¿ç”¨ï¼Œè¯·è®¾ç½®è®°äº‹æœ¬å¯†ç ")
        title_label.setObjectName("title")
        title_label.setAlignment(Qt.AlignCenter)
        # å¯†ç è¾“å…¥åŒºåŸŸ
        password_label = QLabel("è¯·è¾“å…¥å¯†ç ï¼š")
        password_edit = QLineEdit()
        password_edit.setEchoMode(QLineEdit.Password)
        password_edit.setPlaceholderText("è¾“å…¥å¯†ç ï¼ˆ6-20ä½ï¼‰")
        # ç¡®è®¤å¯†ç åŒºåŸŸ
        confirm_label = QLabel("ç¡®è®¤å¯†ç ï¼š")
        confirm_edit = QLineEdit()
        confirm_edit.setEchoMode(QLineEdit.Password)
        confirm_edit.setPlaceholderText("å†æ¬¡è¾“å…¥å¯†ç ")
        # æŒ‰é’®åŒºåŸŸ
        button_layout = QHBoxLayout()
        button_layout.setSpacing(8)
        ok_btn = QPushButton("âœ… ç¡®å®š")
        cancel_btn = QPushButton("âŒ å–æ¶ˆ")
        def set_password():
            password = password_edit.text().strip()
            confirm = confirm_edit.text().strip()
            if len(password) < 6 or len(password) > 20:
                QMessageBox.warning(dialog, "è­¦å‘Š", "å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä½ä¹‹é—´ï¼")
                return
            if password != confirm:
                QMessageBox.warning(dialog, "è­¦å‘Š", "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼")
                return
            self.save_password_data(password)
            QMessageBox.information(dialog, "æˆåŠŸ", "å¯†ç è®¾ç½®æˆåŠŸï¼")
            dialog.accept()
        ok_btn.clicked.connect(set_password)
        cancel_btn.clicked.connect(dialog.reject)
        button_layout.addWidget(ok_btn)
        button_layout.addWidget(cancel_btn)
        # æ·»åŠ ç»„ä»¶åˆ°å¸ƒå±€
        layout.addWidget(title_label)
        layout.addSpacing(8)
        layout.addWidget(password_label)
        layout.addWidget(password_edit)
        layout.addSpacing(3)
        layout.addWidget(confirm_label)
        layout.addWidget(confirm_edit)
        layout.addSpacing(10)
        layout.addLayout(button_layout)
        dialog.setLayout(layout)

        # è‡ªåŠ¨èšç„¦åˆ°å¯†ç è¾“å…¥æ¡†
        password_edit.setFocus()
        return dialog.exec_() == QDialog.Accepted

    def check_password(self, stored_password):
        """æ£€æŸ¥å¯†ç """
        dialog = QDialog(self)
        dialog.setWindowTitle("ğŸ”’ éªŒè¯å¯†ç ")
        dialog.setFixedSize(320, 150)
        dialog.setModal(True)
        # è®¾ç½®å¯¹è¯æ¡†æ ·å¼
        dialog.setStyleSheet("""
            QDialog {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
                color: #FFD700;
                border: 2px solid #FFD700;
                border-radius: 10px;
            }
            QLabel {
                color: #FFD700;
                font-size: 14px;
                font-weight: bold;
                padding: 5px;
                margin: 3px 0px;
            }
            QLineEdit {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #3A3A3A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 6px;
                color: #FFFFFF;
                font-size: 12px;
                font-weight: bold;
                padding: 6px;
                margin: 2px 0px;
                min-height: 20px;
                max-height: 25px;
            }
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFD700;
                font-weight: bold;
                font-size: 11px;
                padding: 6px 12px;
                margin: 3px;
                min-width: 65px;
                min-height: 25px;
                max-height: 30px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }
        """)
        layout = QVBoxLayout()
        layout.setContentsMargins(15, 10, 15, 10)
        layout.setSpacing(8)
        # æ ‡é¢˜
        title_label = QLabel("ğŸ”’ è¯·è¾“å…¥è®°äº‹æœ¬å¯†ç ")
        title_label.setAlignment(Qt.AlignCenter)
        # å¯†ç è¾“å…¥
        password_edit = QLineEdit()
        password_edit.setEchoMode(QLineEdit.Password)
        password_edit.setPlaceholderText("è¾“å…¥å¯†ç ")
        # æŒ‰é’®åŒºåŸŸ
        button_layout = QHBoxLayout()
        button_layout.setSpacing(8)
        ok_btn = QPushButton("âœ… ç¡®å®š")
        cancel_btn = QPushButton("âŒ å–æ¶ˆ")
        def verify_password():
            import hashlib
            password = password_edit.text().strip()
            hashed_password = hashlib.sha256(password.encode()).hexdigest()
            if hashed_password == stored_password:
                dialog.accept()
            else:
                QMessageBox.warning(dialog, "é”™è¯¯", "å¯†ç é”™è¯¯ï¼")
                password_edit.clear()
                password_edit.setFocus()
        # å›è½¦é”®éªŒè¯
        password_edit.returnPressed.connect(verify_password)
        ok_btn.clicked.connect(verify_password)
        cancel_btn.clicked.connect(dialog.reject)
        button_layout.addWidget(ok_btn)
        button_layout.addWidget(cancel_btn)
        # æ·»åŠ ç»„ä»¶åˆ°å¸ƒå±€
        layout.addWidget(title_label)
        layout.addSpacing(8)
        layout.addWidget(password_edit)
        layout.addSpacing(10)
        layout.addLayout(button_layout)
        dialog.setLayout(layout)

        # è‡ªåŠ¨èšç„¦åˆ°å¯†ç è¾“å…¥æ¡†
        password_edit.setFocus()
        return dialog.exec_() == QDialog.Accepted

    def create_notes_tab(self):
        """åˆ›å»ºå¿«é€Ÿè®°äº‹é€‰é¡¹å¡"""
        notes_widget = QWidget()
        layout = QVBoxLayout()
        # æ–‡æœ¬ç¼–è¾‘åŒº
        self.text_edit = QTextEdit()
        self.text_edit.setPlaceholderText("åœ¨è¿™é‡Œè¾“å…¥æ‚¨çš„å¿«é€Ÿç¬”è®°...")
        # è®¾ç½®å­—ä½“
        font = self.text_edit.font()
        font.setPointSize(20)  # å¢å¤§å­—ä½“åˆ°20ptï¼Œæé«˜å¯è¯»æ€§
        font.setFamily("Microsoft YaHei")
        self.text_edit.setFont(font)
        # æŒ‰é’®åŒºåŸŸ
        btn_layout = QHBoxLayout()
        save_btn = QPushButton("ğŸ’¾ ä¿å­˜ç¬”è®°")
        save_btn.clicked.connect(self.save_notes)
        clear_btn = QPushButton("ğŸ—‘ï¸ æ¸…ç©º")
        clear_btn.clicked.connect(self.clear_notes)
        btn_layout.addWidget(save_btn)
        btn_layout.addWidget(clear_btn)
        btn_layout.addStretch()
        layout.addWidget(self.text_edit)
        layout.addLayout(btn_layout)
        notes_widget.setLayout(layout)
        self.tab_widget.addTab(notes_widget, "ğŸ“ å¿«é€Ÿè®°äº‹")
    def create_schedule_tab(self):
        """åˆ›å»ºæ—¥ç¨‹ç®¡ç†é€‰é¡¹å¡"""
        schedule_widget = QWidget()
        layout = QVBoxLayout()
        # æ·»åŠ æ—¥ç¨‹åŒºåŸŸ
        add_layout = QHBoxLayout()
        # æ—¥æœŸé€‰æ‹©
        self.date_edit = QDateEdit()
        self.date_edit.setDate(QDate.currentDate())
        self.date_edit.setCalendarPopup(True)
        # æ—¶é—´é€‰æ‹©
        self.time_edit = QTimeEdit()
        self.time_edit.setTime(QTime.currentTime())
        # äº‹é¡¹è¾“å…¥
        self.event_edit = QLineEdit()
        self.event_edit.setPlaceholderText("è¾“å…¥æ—¥ç¨‹äº‹é¡¹...")
        # ç±»å‹é€‰æ‹©
        self.type_combo = QComboBox()
        self.type_combo.addItems(["ğŸ“… ä¼šè®®", "ğŸ’Š åƒè¯", "ğŸš— å‡ºè¡Œ", "ğŸ“ ç”µè¯", "ğŸ¯ å…¶ä»–"])
        add_btn = QPushButton("â• æ·»åŠ æ—¥ç¨‹")
        add_btn.clicked.connect(self.add_schedule)
        add_layout.addWidget(QLabel("æ—¥æœŸ:"))
        add_layout.addWidget(self.date_edit)
        add_layout.addWidget(QLabel("æ—¶é—´:"))
        add_layout.addWidget(self.time_edit)
        add_layout.addWidget(QLabel("ç±»å‹:"))
        add_layout.addWidget(self.type_combo)
        add_layout.addWidget(self.event_edit)
        add_layout.addWidget(add_btn)
        # æ—¥ç¨‹åˆ—è¡¨
        self.schedule_list = QListWidget()
        # æ“ä½œæŒ‰é’®
        btn_layout = QHBoxLayout()
        edit_btn = QPushButton("âœï¸ ç¼–è¾‘")
        edit_btn.clicked.connect(self.edit_schedule)
        delete_btn = QPushButton("ğŸ—‘ï¸ åˆ é™¤")
        delete_btn.clicked.connect(self.delete_schedule)
        btn_layout.addWidget(edit_btn)
        btn_layout.addWidget(delete_btn)
        btn_layout.addStretch()
        layout.addLayout(add_layout)
        layout.addWidget(QLabel("ğŸ“‹ æ—¥ç¨‹åˆ—è¡¨:"))
        layout.addWidget(self.schedule_list)
        layout.addLayout(btn_layout)
        schedule_widget.setLayout(layout)
        self.tab_widget.addTab(schedule_widget, "ğŸ“… æ—¥ç¨‹ç®¡ç†")
    def create_reminder_tab(self):
        """åˆ›å»ºæé†’äº‹é¡¹é€‰é¡¹å¡"""
        reminder_widget = QWidget()
        layout = QVBoxLayout()
        # æ·»åŠ æé†’åŒºåŸŸ
        add_layout = QHBoxLayout()
        # æé†’æ—¶é—´
        self.reminder_time_edit = QTimeEdit()
        self.reminder_time_edit.setTime(QTime.currentTime())
        # æé†’å†…å®¹
        self.reminder_edit = QLineEdit()
        self.reminder_edit.setPlaceholderText("è¾“å…¥æé†’å†…å®¹...")
        # é‡å¤é€‰é¡¹
        self.repeat_combo = QComboBox()
        self.repeat_combo.addItems(["ä¸€æ¬¡æ€§", "æ¯å¤©", "å·¥ä½œæ—¥", "å‘¨æœ«"])
        # éŸ³ä¹é€‰æ‹©
        self.music_combo = QComboBox()
        self.music_combo.addItems(["ğŸ”” é»˜è®¤æç¤ºéŸ³", "ğŸµ è½»éŸ³ä¹", "â° é—¹é’ŸéŸ³", "ğŸ¶ è‡ªå®šä¹‰"])
        add_reminder_btn = QPushButton("â° æ·»åŠ æé†’")
        add_reminder_btn.clicked.connect(self.add_reminder)
        add_layout.addWidget(QLabel("æ—¶é—´:"))
        add_layout.addWidget(self.reminder_time_edit)
        add_layout.addWidget(QLabel("é‡å¤:"))
        add_layout.addWidget(self.repeat_combo)
        add_layout.addWidget(QLabel("éŸ³ä¹:"))
        add_layout.addWidget(self.music_combo)
        add_layout.addWidget(self.reminder_edit)
        add_layout.addWidget(add_reminder_btn)
        # æé†’åˆ—è¡¨
        self.reminder_list = QListWidget()
        # æ“ä½œæŒ‰é’®
        btn_layout = QHBoxLayout()
        test_btn = QPushButton("ğŸ”Š æµ‹è¯•éŸ³ä¹")
        test_btn.clicked.connect(self.test_music)
        edit_reminder_btn = QPushButton("âœï¸ ç¼–è¾‘")
        edit_reminder_btn.clicked.connect(self.edit_reminder)
        delete_reminder_btn = QPushButton("ğŸ—‘ï¸ åˆ é™¤")
        delete_reminder_btn.clicked.connect(self.delete_reminder)
        btn_layout.addWidget(test_btn)
        btn_layout.addWidget(edit_reminder_btn)
        btn_layout.addWidget(delete_reminder_btn)
        btn_layout.addStretch()
        layout.addLayout(add_layout)
        layout.addWidget(QLabel("â° æé†’åˆ—è¡¨:"))
        layout.addWidget(self.reminder_list)
        layout.addLayout(btn_layout)
        reminder_widget.setLayout(layout)
        self.tab_widget.addTab(reminder_widget, "â° æé†’äº‹é¡¹")
    def create_history_tab(self):
        """åˆ›å»ºå†å²è®°å½•é€‰é¡¹å¡"""
        history_widget = QWidget()
        layout = QVBoxLayout()
        # æœç´¢åŒºåŸŸ
        search_layout = QHBoxLayout()
        self.search_edit = QLineEdit()
        self.search_edit.setPlaceholderText("æœç´¢å†å²è®°å½•...")
        search_btn = QPushButton("ğŸ” æœç´¢")
        search_btn.clicked.connect(self.search_history)
        refresh_btn = QPushButton("ğŸ”„ åˆ·æ–°")
        refresh_btn.clicked.connect(self.refresh_history)
        search_layout.addWidget(self.search_edit)
        search_layout.addWidget(search_btn)
        search_layout.addWidget(refresh_btn)
        # å†å²è®°å½•åˆ—è¡¨
        self.history_list = QListWidget()
        # è¯¦æƒ…æ˜¾ç¤º
        self.history_detail = QTextEdit()
        self.history_detail.setReadOnly(True)
        self.history_detail.setMaximumHeight(150)
        # è®¾ç½®å­—ä½“
        font = self.history_detail.font()
        font.setPointSize(20)  # å¢å¤§å­—ä½“åˆ°20ptï¼Œæé«˜å¯è¯»æ€§
        font.setFamily("Microsoft YaHei")
        self.history_detail.setFont(font)
        layout.addLayout(search_layout)
        layout.addWidget(QLabel("ğŸ“š å†å²è®°å½•:"))
        layout.addWidget(self.history_list)
        layout.addWidget(QLabel("ğŸ“– è¯¦æƒ…:"))
        layout.addWidget(self.history_detail)
        history_widget.setLayout(layout)
        self.tab_widget.addTab(history_widget, "ğŸ“š å†å²è®°å½•")
        # è¿æ¥ä¿¡å·
        self.history_list.itemClicked.connect(self.show_history_detail)
    def save_notes(self):
        """ä¿å­˜ç¬”è®°"""
        try:
            with open('notes.txt', 'w', encoding='utf-8') as f:
                f.write(self.text_edit.toPlainText())
            QMessageBox.information(self, "ä¿å­˜æˆåŠŸ", "ç¬”è®°å·²ä¿å­˜åˆ° notes.txt")
        except Exception as e:
            QMessageBox.warning(self, "ä¿å­˜å¤±è´¥", f"ä¿å­˜å¤±è´¥ï¼š{str(e)}")
    def load_notes(self):
        """åŠ è½½ç¬”è®°"""
        try:
            with open('notes.txt', 'r', encoding='utf-8') as f:
                self.text_edit.setPlainText(f.read())
        except:
            pass
    def clear_notes(self):
        """æ¸…ç©ºç¬”è®°"""
        reply = QMessageBox.question(self, "ç¡®è®¤æ¸…ç©º", "ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¬”è®°å—ï¼Ÿ",
                                   QMessageBox.Yes | QMessageBox.No)
        if reply == QMessageBox.Yes:
            self.text_edit.clear()
    def add_schedule(self):
        """æ·»åŠ æ—¥ç¨‹"""
        date = self.date_edit.date().toString("yyyy-MM-dd")
        time = self.time_edit.time().toString("HH:mm")
        event_type = self.type_combo.currentText()
        event = self.event_edit.text().strip()
        if not event:
            QMessageBox.warning(self, "è­¦å‘Š", "è¯·è¾“å…¥æ—¥ç¨‹äº‹é¡¹ï¼")
            return
        schedule_item = {
            'id': len(self.schedules),
            'date': date,
            'time': time,
            'type': event_type,
            'event': event,
            'created': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        self.schedules.append(schedule_item)
        self.update_schedule_list()
        self.save_schedules()
        # æ¸…ç©ºè¾“å…¥
        self.event_edit.clear()
        self.time_edit.setTime(QTime.currentTime())
        QMessageBox.information(self, "æˆåŠŸ", "æ—¥ç¨‹å·²æ·»åŠ ï¼")
    def edit_schedule(self):
        """ç¼–è¾‘æ—¥ç¨‹"""
        current_row = self.schedule_list.currentRow()
        if current_row < 0:
            QMessageBox.warning(self, "è­¦å‘Š", "è¯·é€‰æ‹©è¦ç¼–è¾‘çš„æ—¥ç¨‹ï¼")
            return
        schedule = self.schedules[current_row]
        # åˆ›å»ºç¼–è¾‘å¯¹è¯æ¡†
        dialog = QDialog(self)
        dialog.setWindowTitle("ç¼–è¾‘æ—¥ç¨‹")
        dialog.setFixedSize(400, 300)
        layout = QVBoxLayout()
        # ç¼–è¾‘æ§ä»¶
        date_edit = QDateEdit()
        date_edit.setDate(QDate.fromString(schedule['date'], "yyyy-MM-dd"))
        time_edit = QTimeEdit()
        time_edit.setTime(QTime.fromString(schedule['time'], "HH:mm"))
        type_combo = QComboBox()
        type_combo.addItems(["ğŸ“… ä¼šè®®", "ğŸ’Š åƒè¯", "ğŸš— å‡ºè¡Œ", "ğŸ“ ç”µè¯", "ğŸ¯ å…¶ä»–"])
        type_combo.setCurrentText(schedule['type'])
        event_edit = QLineEdit(schedule['event'])
        # æŒ‰é’®
        btn_layout = QHBoxLayout()
        save_btn = QPushButton("ä¿å­˜")
        cancel_btn = QPushButton("å–æ¶ˆ")
        def save_changes():
            self.schedules[current_row].update({
                'date': date_edit.date().toString("yyyy-MM-dd"),
                'time': time_edit.time().toString("HH:mm"),
                'type': type_combo.currentText(),
                'event': event_edit.text().strip()
            })
            self.update_schedule_list()
            self.save_schedules()
            dialog.accept()
            QMessageBox.information(self, "æˆåŠŸ", "æ—¥ç¨‹å·²æ›´æ–°ï¼")
        save_btn.clicked.connect(save_changes)
        cancel_btn.clicked.connect(dialog.reject)
        btn_layout.addWidget(save_btn)
        btn_layout.addWidget(cancel_btn)
        layout.addWidget(QLabel("æ—¥æœŸ:"))
        layout.addWidget(date_edit)
        layout.addWidget(QLabel("æ—¶é—´:"))
        layout.addWidget(time_edit)
        layout.addWidget(QLabel("ç±»å‹:"))
        layout.addWidget(type_combo)
        layout.addWidget(QLabel("äº‹é¡¹:"))
        layout.addWidget(event_edit)
        layout.addLayout(btn_layout)
        dialog.setLayout(layout)
        dialog.exec_()

    def delete_schedule(self):
        """åˆ é™¤æ—¥ç¨‹"""
        current_row = self.schedule_list.currentRow()
        if current_row < 0:
            QMessageBox.warning(self, "è­¦å‘Š", "è¯·é€‰æ‹©è¦åˆ é™¤çš„æ—¥ç¨‹ï¼")
            return
        reply = QMessageBox.question(self, "ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ—¥ç¨‹å—ï¼Ÿ",
                                   QMessageBox.Yes | QMessageBox.No)
        if reply == QMessageBox.Yes:
            del self.schedules[current_row]
            # é‡æ–°åˆ†é…ID
            for i, schedule in enumerate(self.schedules):
                schedule['id'] = i
            self.update_schedule_list()
            self.save_schedules()
            QMessageBox.information(self, "æˆåŠŸ", "æ—¥ç¨‹å·²åˆ é™¤ï¼")
    def add_reminder(self):
        """æ·»åŠ æé†’"""
        time = self.reminder_time_edit.time().toString("HH:mm")
        content = self.reminder_edit.text().strip()
        repeat = self.repeat_combo.currentText()
        music = self.music_combo.currentText()
        if not content:
            QMessageBox.warning(self, "è­¦å‘Š", "è¯·è¾“å…¥æé†’å†…å®¹ï¼")
            return
        reminder_item = {
            'id': len(self.reminders),
            'time': time,
            'content': content,
            'repeat': repeat,
            'music': music,
            'enabled': True,
            'created': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        self.reminders.append(reminder_item)
        self.update_reminder_list()
        self.save_reminders()
        # æ¸…ç©ºè¾“å…¥
        self.reminder_edit.clear()
        self.reminder_time_edit.setTime(QTime.currentTime())
        QMessageBox.information(self, "æˆåŠŸ", "æé†’å·²æ·»åŠ ï¼")
    def edit_reminder(self):
        """ç¼–è¾‘æé†’"""
        current_row = self.reminder_list.currentRow()
        if current_row < 0:
            QMessageBox.warning(self, "è­¦å‘Š", "è¯·é€‰æ‹©è¦ç¼–è¾‘çš„æé†’ï¼")
            return
        # å®ç°ç¼–è¾‘æé†’çš„é€»è¾‘ï¼ˆç±»ä¼¼ç¼–è¾‘æ—¥ç¨‹ï¼‰
        QMessageBox.information(self, "æç¤º", "ç¼–è¾‘æé†’åŠŸèƒ½å¼€å‘ä¸­...")
    def delete_reminder(self):
        """åˆ é™¤æé†’"""
        current_row = self.reminder_list.currentRow()
        if current_row < 0:
            QMessageBox.warning(self, "è­¦å‘Š", "è¯·é€‰æ‹©è¦åˆ é™¤çš„æé†’ï¼")
            return
        reply = QMessageBox.question(self, "ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæé†’å—ï¼Ÿ",
                                   QMessageBox.Yes | QMessageBox.No)
        if reply == QMessageBox.Yes:
            del self.reminders[current_row]
            # é‡æ–°åˆ†é…ID
            for i, reminder in enumerate(self.reminders):
                reminder['id'] = i
            self.update_reminder_list()
            self.save_reminders()
            QMessageBox.information(self, "æˆåŠŸ", "æé†’å·²åˆ é™¤ï¼")
    def test_music(self):
        """æµ‹è¯•éŸ³ä¹"""
        music_type = self.music_combo.currentText()
        try:
            # åŠ è½½ç³»ç»Ÿè®¾ç½®
            settings = self.load_system_settings()
            default_music_path = settings.get('default_music_path', 'C:/Users/86188/Desktop/é‡‘å…‰å’’.mp3')
            volume = settings.get('volume', 70) / 100.0
            if "é»˜è®¤æç¤ºéŸ³" in music_type:
                import winsound
                winsound.MessageBeep(winsound.MB_ICONASTERISK)
                QMessageBox.information(self, "æµ‹è¯•", "å·²æ’­æ”¾ç³»ç»Ÿæç¤ºéŸ³ã€‚")
                return
            if not self._ensure_audio_ready("æé†’éŸ³æµ‹è¯•"):
                return
            import os
            if not os.path.exists(default_music_path):
                QMessageBox.warning(self, "é”™è¯¯", "é»˜è®¤éŸ³ä¹æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆåœ¨ç³»ç»Ÿè®¾ç½®ä¸­é…ç½®ã€‚")
                return
            pygame.mixer.music.load(default_music_path)
            if "è½»éŸ³ä¹" in music_type:
                pygame.mixer.music.set_volume(volume * 0.7)
            else:
                pygame.mixer.music.set_volume(volume)
            pygame.mixer.music.play()
            QMessageBox.information(self, "æµ‹è¯•", f"æ­£åœ¨æ’­æ”¾ï¼š{music_type}")
        except Exception as e:
            QMessageBox.warning(self, "é”™è¯¯", f"æ— æ³•æ’­æ”¾éŸ³ä¹ï¼š{str(e)}")
    def load_system_settings(self):
        """åŠ è½½ç³»ç»Ÿè®¾ç½®"""
        try:
            if os.path.exists('system_settings.json'):
                with open('system_settings.json', 'r', encoding='utf-8') as f:
                    settings = json.load(f)
                    # éªŒè¯å’Œä¿®å¤ç¼©æ”¾å€¼
                    if 'default_scale' in settings:
                        scale = settings['default_scale']
                        # å¦‚æœæ˜¯ç™¾åˆ†æ¯”å€¼ï¼Œè½¬æ¢ä¸ºå°æ•°
                        if scale > 1:
                            settings['default_scale'] = scale / 100.0
                    return settings
            else:
                # è¿”å›é»˜è®¤è®¾ç½®
                return {
                    'default_scale': 0.65,
                    'default_music_path': 'C:/Users/86188/Desktop/é‡‘å…‰å’’.mp3',
                    'notepad_enabled': True,
                    'alarm_enabled': True,
                    'health_reminder_enabled': True,
                    'volume': 70
                }
        except Exception as e:
            print(f"åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥: {e}")
            return {
                'default_scale': 0.65,
                'default_music_path': 'C:/Users/86188/Desktop/é‡‘å…‰å’’.mp3',
                'notepad_enabled': True,
                'alarm_enabled': True,
                'health_reminder_enabled': True,
                'volume': 70
            }
    def search_history(self):
        """æœç´¢å†å²è®°å½•"""
        search_text = self.search_edit.text().strip()
        if not search_text:
            self.refresh_history()
            return
        # å®ç°æœç´¢é€»è¾‘
        QMessageBox.information(self, "æç¤º", f"æœç´¢åŠŸèƒ½å¼€å‘ä¸­...æœç´¢è¯ï¼š{search_text}")
    def refresh_history(self):
        """åˆ·æ–°å†å²è®°å½•"""
        self.history_list.clear()
        # åŠ è½½å†å²è®°å½•
        try:
            # åŠ è½½æ—¥ç¨‹å†å²
            for schedule in self.schedules:
                item_text = f"ğŸ“… {schedule['date']} {schedule['time']} - {schedule['type']} - {schedule['event']}"
                self.history_list.addItem(item_text)
            # åŠ è½½æé†’å†å²
            for reminder in self.reminders:
                item_text = f"â° {reminder['time']} - {reminder['content']} ({reminder['repeat']})"
                self.history_list.addItem(item_text)
        except Exception as e:
            QMessageBox.warning(self, "é”™è¯¯", f"åŠ è½½å†å²è®°å½•å¤±è´¥ï¼š{str(e)}")
    def show_history_detail(self, item):
        """æ˜¾ç¤ºå†å²è¯¦æƒ…"""
        item_text = item.text()
        # æ ¹æ®é€‰ä¸­çš„é¡¹ç›®æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
        self.history_detail.setText(f"è¯¦ç»†ä¿¡æ¯ï¼š\n{item_text}\n\nåˆ›å»ºæ—¶é—´ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    def update_schedule_list(self):
        """æ›´æ–°æ—¥ç¨‹åˆ—è¡¨"""
        self.schedule_list.clear()
        for schedule in self.schedules:
            item_text = f"{schedule['date']} {schedule['time']} - {schedule['type']} - {schedule['event']}"
            self.schedule_list.addItem(item_text)
    def update_reminder_list(self):
        """æ›´æ–°æé†’åˆ—è¡¨"""
        self.reminder_list.clear()
        for reminder in self.reminders:
            status = "âœ…" if reminder['enabled'] else "âŒ"
            item_text = f"{status} {reminder['time']} - {reminder['content']} ({reminder['repeat']})"
            self.reminder_list.addItem(item_text)
    def load_schedules(self):
        """åŠ è½½æ—¥ç¨‹æ•°æ®"""
        try:
            with open('schedules.json', 'r', encoding='utf-8') as f:
                self.schedules = json.load(f)
            self.update_schedule_list()
        except:
            self.schedules = []
        try:
            with open('reminders.json', 'r', encoding='utf-8') as f:
                self.reminders = json.load(f)
            self.update_reminder_list()
        except:
            self.reminders = []
    def save_schedules(self):
        """ä¿å­˜æ—¥ç¨‹æ•°æ®"""
        with open('schedules.json', 'w', encoding='utf-8') as f:
            json.dump(self.schedules, f, ensure_ascii=False, indent=2)
    def save_reminders(self):
        """ä¿å­˜æé†’æ•°æ®"""
        with open('reminders.json', 'w', encoding='utf-8') as f:
            json.dump(self.reminders, f, ensure_ascii=False, indent=2)
    def check_reminders(self):
        """æ£€æŸ¥æé†’äº‹é¡¹"""
        current_time = QTime.currentTime()
        current_day = QDate.currentDate().dayOfWeek()  # 1=Monday, 7=Sunday
        for reminder in self.reminders:
            if not reminder['enabled']:
                continue
            reminder_time = QTime.fromString(reminder['time'], "HH:mm")
            # æ£€æŸ¥æ—¶é—´æ˜¯å¦åŒ¹é…ï¼ˆå…è®¸1åˆ†é’Ÿè¯¯å·®ï¼‰
            time_diff = abs(current_time.secsTo(reminder_time))
            if time_diff > 60:  # è¶…è¿‡1åˆ†é’Ÿå°±è·³è¿‡
                continue
            # æ£€æŸ¥é‡å¤è§„åˆ™
            repeat_type = reminder['repeat']
            should_remind = False
            if repeat_type == "ä¸€æ¬¡æ€§":
                should_remind = True
            elif repeat_type == "æ¯å¤©":
                should_remind = True
            elif repeat_type == "å·¥ä½œæ—¥" and current_day <= 5:
                should_remind = True
            elif repeat_type == "å‘¨æœ«" and current_day > 5:
                should_remind = True
            if should_remind:
                self.show_reminder_popup(reminder)
    def show_reminder_popup(self, reminder):
        """æ˜¾ç¤ºæé†’å¼¹çª—"""
        music_played = False
        try:
            settings = self.load_system_settings()
            default_music_path = settings.get('default_music_path', 'C:/Users/86188/Desktop/é‡‘å…‰å’’.mp3')
            volume = settings.get('volume', 70) / 100.0
            music_type = reminder['music']
            if "é»˜è®¤æç¤ºéŸ³" in music_type:
                import winsound
                winsound.MessageBeep(winsound.MB_ICONASTERISK)
            else:
                if self._ensure_audio_ready("æ—¥ç¨‹æé†’"):
                    import os
                    if not os.path.exists(default_music_path):
                        print(f"âš ï¸ æé†’éŸ³ä¹æ–‡ä»¶ä¸å­˜åœ¨ï¼š{default_music_path}")
                    else:
                        pygame.mixer.music.load(default_music_path)
                        if "è½»éŸ³ä¹" in music_type:
                            pygame.mixer.music.set_volume(volume * 0.7)
                        else:
                            pygame.mixer.music.set_volume(volume)
                        pygame.mixer.music.play()
                        music_played = True
        except Exception as e:
            print(f"âš ï¸ æ’­æ”¾æé†’éŸ³ä¹å¤±è´¥ï¼š{e}")

        msg_box = QMessageBox(None)  # åˆ›å»ºç‹¬ç«‹æ¶ˆæ¯æ¡†
        msg_box.setWindowTitle("â° æ™ºèƒ½æé†’")
        msg_box.setText(f"ğŸ”” æé†’æ—¶é—´åˆ°äº†ï¼\n\nğŸ“ {reminder['content']}")
        msg_box.setIcon(QMessageBox.Information)
        later_btn = msg_box.addButton("5åˆ†é’Ÿåæé†’", QMessageBox.ActionRole)
        msg_box.addButton("å·²å®Œæˆ", QMessageBox.AcceptRole)
        msg_box.setStyleSheet("""
            QMessageBox {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
                color: #FFD700;
                border: 2px solid #FFD700;
                border-radius: 10px;
            }
            QMessageBox QLabel {
                color: #FFFFFF;
                font-size: 16px;
                font-weight: bold;
                padding: 20px;
            }
            QMessageBox QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 15px;
                color: #FFD700;
                font-weight: bold;
                padding: 10px;
                min-width: 100px;
            }
            QMessageBox QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }
        """)
        msg_box.exec_()

        if msg_box.clickedButton() == later_btn:
            QTimer.singleShot(5 * 60 * 1000, lambda: self.show_reminder_popup(reminder))

        if music_played and _is_pygame_ready():
            try:
                pygame.mixer.music.stop()
            except Exception:
                pass
class ProfessionalAlarmSettings(QWidget):
    """ä¸“ä¸šé—¹é’Ÿè®¾ç½®"""
    def __init__(self, parent=None):
        super().__init__(parent)
        self.parent_window = parent
        self._audio_warning_shown = False
        self.setWindowTitle("é—¹é’Ÿè®¾ç½® - å…«å¦æ—¶é’Ÿ V2.0.0")
        self.setFixedSize(500, 600)
        self.setWindowFlags(Qt.Window | Qt.WindowStaysOnTopHint | Qt.WindowCloseButtonHint)
        self.alarms = []
        self.init_ui()
        self.load_alarms()
        # è®¾ç½®æ ·å¼
        self.setStyleSheet("""
            QWidget {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
                color: #FFD700;
            }
            QListWidget {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #3A3A3A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 10px;
                color: #FFFFFF;
                font-size: 14px;
                padding: 10px;
            }
            QTimeEdit {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #3A3A3A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFFFFF;
                font-size: 14px;
                padding: 8px;
            }
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 15px;
                color: #FFD700;
                font-weight: bold;
                padding: 10px;
                min-width: 80px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }
        """)
    def init_ui(self):
        """åˆå§‹åŒ–ç•Œé¢"""
        layout = QVBoxLayout()
        # æ ‡é¢˜
        title = QLabel("â° é—¹é’Ÿè®¾ç½® - ä¸“ä¸šç‰ˆ")
        title.setStyleSheet("""
            QLabel {
                color: #FFD700;
                font-size: 20px;
                font-weight: bold;
                padding: 10px;
                background: transparent;
            }
        """)
        title.setAlignment(Qt.AlignCenter)
        # æ—¶é—´è®¾ç½®åŒºåŸŸ
        time_group = QGroupBox("ğŸ• æ—¶é—´è®¾ç½®")
        time_group.setStyleSheet("""
            QGroupBox {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #3A3A3A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 10px;
                color: #FFD700;
                font-weight: bold;
                font-size: 14px;
                padding: 10px;
                margin-top: 10px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 10px;
                padding: 0 10px 0 10px;
            }
        """)
        time_layout = QVBoxLayout()
        # å°æ—¶è®¾ç½®
        hour_layout = QHBoxLayout()
        hour_layout.addWidget(QLabel("å°æ—¶:"))
        self.hour_display = QLabel("12")
        self.hour_display.setStyleSheet("""
            QLabel {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #3A3A3A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFFFFF;
                font-size: 24px;
                font-weight: bold;
                padding: 10px;
                min-width: 60px;
                text-align: center;
            }
        """)
        self.hour_display.setAlignment(Qt.AlignCenter)
        self.current_hour = 12
        hour_btn_layout = QVBoxLayout()
        hour_up_btn = QPushButton("â–²")
        hour_up_btn.setFixedSize(30, 25)
        hour_up_btn.clicked.connect(self.hour_up)
        hour_down_btn = QPushButton("â–¼")
        hour_down_btn.setFixedSize(30, 25)
        hour_down_btn.clicked.connect(self.hour_down)
        hour_btn_layout.addWidget(hour_up_btn)
        hour_btn_layout.addWidget(hour_down_btn)
        hour_layout.addWidget(self.hour_display)
        hour_layout.addLayout(hour_btn_layout)
        hour_layout.addStretch()
        # åˆ†é’Ÿè®¾ç½®
        minute_layout = QHBoxLayout()
        minute_layout.addWidget(QLabel("åˆ†é’Ÿ:"))
        self.minute_display = QLabel("00")
        self.minute_display.setStyleSheet("""
            QLabel {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #3A3A3A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFFFFF;
                font-size: 24px;
                font-weight: bold;
                padding: 10px;
                min-width: 60px;
                text-align: center;
            }
        """)
        self.minute_display.setAlignment(Qt.AlignCenter)
        self.current_minute = 0
        minute_btn_layout = QVBoxLayout()
        minute_up_btn = QPushButton("â–²")
        minute_up_btn.setFixedSize(30, 25)
        minute_up_btn.clicked.connect(self.minute_up)
        minute_down_btn = QPushButton("â–¼")
        minute_down_btn.setFixedSize(30, 25)
        minute_down_btn.clicked.connect(self.minute_down)
        minute_btn_layout.addWidget(minute_up_btn)
        minute_btn_layout.addWidget(minute_down_btn)
        minute_layout.addWidget(self.minute_display)
        minute_layout.addLayout(minute_btn_layout)
        minute_layout.addStretch()
        time_layout.addLayout(hour_layout)
        time_layout.addLayout(minute_layout)
        time_group.setLayout(time_layout)
        # å¤‡æ³¨è¾“å…¥
        note_layout = QHBoxLayout()
        note_layout.addWidget(QLabel("å¤‡æ³¨:"))
        self.note_edit = QLineEdit()
        self.note_edit.setPlaceholderText("é—¹é’Ÿå¤‡æ³¨...")
        note_layout.addWidget(self.note_edit)
        # æŒ‰é’®åŒºåŸŸ
        btn_layout = QHBoxLayout()
        add_btn = QPushButton("â• æ·»åŠ é—¹é’Ÿ")
        add_btn.clicked.connect(self.add_alarm)
        delete_btn = QPushButton("ğŸ—‘ï¸ åˆ é™¤é—¹é’Ÿ")
        delete_btn.clicked.connect(self.delete_alarm)
        btn_layout.addWidget(add_btn)
        btn_layout.addWidget(delete_btn)
        btn_layout.addStretch()
        # é—¹é’Ÿåˆ—è¡¨
        self.alarm_list = QListWidget()
        layout.addWidget(title)
        layout.addWidget(time_group)
        layout.addLayout(note_layout)
        layout.addLayout(btn_layout)
        layout.addWidget(QLabel("ğŸ“‹ é—¹é’Ÿåˆ—è¡¨:"))
        layout.addWidget(self.alarm_list)
        self.setLayout(layout)
    def hour_up(self):
        """å°æ—¶å¢åŠ """
        self.current_hour = (self.current_hour % 24) + 1
        if self.current_hour == 25:
            self.current_hour = 1
        self.hour_display.setText(f"{self.current_hour:02d}")
    def hour_down(self):
        """å°æ—¶å‡å°‘"""
        self.current_hour = self.current_hour - 1
        if self.current_hour < 1:
            self.current_hour = 24
        self.hour_display.setText(f"{self.current_hour:02d}")
    def minute_up(self):
        """åˆ†é’Ÿå¢åŠ """
        self.current_minute = (self.current_minute + 1) % 60
        self.minute_display.setText(f"{self.current_minute:02d}")
    def minute_down(self):
        """åˆ†é’Ÿå‡å°‘"""
        self.current_minute = (self.current_minute - 1) % 60
        self.minute_display.setText(f"{self.current_minute:02d}")
    def add_alarm(self):
        """æ·»åŠ é—¹é’Ÿ"""
        # ä»æ˜¾ç¤ºå™¨è·å–æ—¶é—´
        time_str = f"{self.current_hour:02d}:{self.current_minute:02d}"
        note = self.note_edit.text().strip()
        if not note:
            note = f"é—¹é’Ÿæé†’ - {time_str}"
        alarm = {
            'time': time_str,
            'note': note,
            'triggered': False,
            'created': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        self.alarms.append(alarm)
        self.update_alarm_list()
        self.save_alarms()
        self._notify_parent_alarm_change()
        self.note_edit.clear()
        QMessageBox.information(self, "æˆåŠŸ", f"é—¹é’Ÿå·²æ·»åŠ ï¼š{time_str}\nå¤‡æ³¨ï¼š{note}")
    def delete_alarm(self):
        """åˆ é™¤é—¹é’Ÿ"""
        current_row = self.alarm_list.currentRow()
        if current_row >= 0:
            del self.alarms[current_row]
            self.update_alarm_list()
            self.save_alarms()
            self._notify_parent_alarm_change()
            QMessageBox.information(self, "æˆåŠŸ", "é—¹é’Ÿå·²åˆ é™¤")
        else:
            QMessageBox.warning(self, "é”™è¯¯", "è¯·é€‰æ‹©è¦åˆ é™¤çš„é—¹é’Ÿ")
    def update_alarm_list(self):
        """æ›´æ–°é—¹é’Ÿåˆ—è¡¨"""
        self.alarm_list.clear()
        for alarm in self.alarms:
            display_text = f"{alarm['time']} - {alarm.get('note', 'æ— å¤‡æ³¨')}"
            self.alarm_list.addItem(display_text)
    def load_alarms(self):
        """åŠ è½½é—¹é’Ÿ"""
        try:
            with open('alarms.json', 'r', encoding='utf-8') as f:
                self.alarms = json.load(f)
            self.update_alarm_list()
        except:
            self.alarms = []
    def save_alarms(self):
        """ä¿å­˜é—¹é’Ÿ"""
        with open('alarms.json', 'w', encoding='utf-8') as f:
            json.dump(self.alarms, f, ensure_ascii=False, indent=2)
    def _notify_parent_alarm_change(self):
        """é€šçŸ¥ä¸»çª—å£åˆ·æ–°é—¹é’Ÿæ•°æ®ã€‚"""
        try:
            if self.parent_window and hasattr(self.parent_window, 'load_alarms'):
                self.parent_window.load_alarms()
        except Exception as e:
            print(f"âš ï¸ åŒæ­¥ä¸»çª—å£é—¹é’Ÿå¤±è´¥: {e}")

    def _ensure_audio_ready(self, context: str) -> bool:
        """
        æ£€æŸ¥å¹¶åˆå§‹åŒ– pygame éŸ³é¢‘ã€‚
        ä¼˜å…ˆå¤ç”¨ä¸»çª—å£çš„é€»è¾‘ï¼Œé¿å…é‡å¤å¼¹çª—ã€‚
        """
        if self.parent_window and hasattr(self.parent_window, "_ensure_audio_ready"):
            return self.parent_window._ensure_audio_ready(context)
        if not _is_pygame_ready():
            if not self._audio_warning_shown:
                QMessageBox.warning(
                    self,
                    "éŸ³é¢‘ä¸å¯ç”¨",
                    "å½“å‰ç¯å¢ƒæœªå®‰è£… pygameï¼Œæ— æ³•æ’­æ”¾æé†’éŸ³æ•ˆã€‚\n"
                    "è¯·å®‰è£… pygame æˆ–å°†æé†’éŸ³æ•ˆåˆ‡æ¢ä¸ºç³»ç»Ÿæç¤ºéŸ³ã€‚"
                )
                self._audio_warning_shown = True
            return False
        try:
            if not pygame.mixer.get_init():
                pygame.mixer.init()
            return True
        except Exception as e:
            if not self._audio_warning_shown:
                QMessageBox.warning(self, "éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥", f"pygame æ— æ³•åˆå§‹åŒ–éŸ³é¢‘ï¼š{e}")
                self._audio_warning_shown = True
            return False


class BaziSuanmingWindow(QWidget):
    """å…«å­—ç®—å‘½é£æ°´çª—å£"""
    def __init__(self, parent=None):
        super().__init__(parent)
        self.parent_window = parent
        self.setWindowTitle("å…«å­—ç®—å‘½é£æ°´ - å…«å¦æ—¶é’Ÿ V2.0.0")
        self.resize(1200, 800)  # æ”¹ä¸ºå¯è°ƒæ•´å¤§å°
        # è®¾ç½®ä¸ºæ™®é€šçª—å£ï¼Œç¡®ä¿å¯ä»¥æ‹–åŠ¨å’Œè°ƒæ•´å¤§å°
        self.setWindowFlags(Qt.Window | Qt.WindowTitleHint | Qt.WindowSystemMenuHint |
                           Qt.WindowMinimizeButtonHint | Qt.WindowMaximizeButtonHint |
                           Qt.WindowCloseButtonHint)
        # ç¡®ä¿çª—å£å¯ä»¥ç§»åŠ¨
        self.setWindowFlag(Qt.WindowStaysOnTopHint, False)
        # åˆå§‹åŒ–æ‹–åŠ¨å˜é‡
        self.drag_position = None

        # åˆå§‹åŒ–æœ¬åœ°å‘½ç†åˆ†æå™¨ï¼ˆå®Œæ•´ç‰ˆï¼‰
        if LOCAL_ANALYZER_AVAILABLE:
            self.local_analyzer = UnifiedMingliAnalyzer()
            print("âœ“ BaziSuanmingWindow: å®Œæ•´ç‰ˆæœ¬åœ°å‘½ç†åˆ†æå™¨åˆå§‹åŒ–æˆåŠŸ")
        else:
            self.local_analyzer = None
            print("âš ï¸ BaziSuanmingWindow: æœ¬åœ°å‘½ç†åˆ†æå™¨æœªåˆå§‹åŒ–")

        # åˆå§‹åŒ–ç»¼åˆæ·±åº¦åˆ†æå™¨ - æš‚æ—¶ç¦ç”¨ï¼ˆæ¡†æ¶ä»£ç ï¼ŒåŒ…å«è™šå‡æ•°æ®ï¼‰
        self.comprehensive_analyzer = None

        # åˆå§‹åŒ–å†œå†è½¬æ¢å™¨
        self.init_lunar_data()
        # åˆå§‹åŒ–é¥°ç‰©å»ºè®®çŸ¥è¯†åº“
        self.init_accessories_database()
        self.init_ui()
        self.apply_styles()
    def init_lunar_data(self):
        """åˆå§‹åŒ–å†œå†æ•°æ®"""
        # å†œå†æœˆä»½åç§°
        self.lunar_months = [
            "æ­£æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ",
            "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "å†¬æœˆ", "è…Šæœˆ"
        ]
        # å†œå†æ—¥æœŸåç§°
        self.lunar_days = [
            "åˆä¸€", "åˆäºŒ", "åˆä¸‰", "åˆå››", "åˆäº”", "åˆå…­", "åˆä¸ƒ", "åˆå…«", "åˆä¹", "åˆå",
            "åä¸€", "åäºŒ", "åä¸‰", "åå››", "åäº”", "åå…­", "åä¸ƒ", "åå…«", "åä¹", "äºŒå",
            "å»¿ä¸€", "å»¿äºŒ", "å»¿ä¸‰", "å»¿å››", "å»¿äº”", "å»¿å…­", "å»¿ä¸ƒ", "å»¿å…«", "å»¿ä¹", "ä¸‰å"
        ]
        # æ—¶è¾°åˆ—è¡¨
        self.shichen_list = [
            "å­æ—¶(23:00-1:00)", "ä¸‘æ—¶(1:00-3:00)", "å¯…æ—¶(3:00-5:00)", "å¯æ—¶(5:00-7:00)",
            "è¾°æ—¶(7:00-9:00)", "å·³æ—¶(9:00-11:00)", "åˆæ—¶(11:00-13:00)", "æœªæ—¶(13:00-15:00)",
            "ç”³æ—¶(15:00-17:00)", "é…‰æ—¶(17:00-19:00)", "æˆŒæ—¶(19:00-21:00)", "äº¥æ—¶(21:00-23:00)"
        ]
        # åˆå§‹åŒ–åŸå¸‚æ•°æ®åº“
        self.init_city_database()
    def init_city_database(self):
        """åˆå§‹åŒ–åŸå¸‚æ•°æ®åº“"""
        # ç®€åŒ–çš„çœä»½å’Œä¸»è¦åŸå¸‚æ•°æ®åº“
        self.city_database = {
            "åŒ—äº¬å¸‚": {
                "cities": ["åŒ—äº¬", "æœé˜³", "æµ·æ·€", "ä¸°å°", "çŸ³æ™¯å±±", "é—¨å¤´æ²Ÿ", "æˆ¿å±±", "é€šå·", "é¡ºä¹‰", "æ˜Œå¹³", "å¤§å…´", "æ€€æŸ”", "å¹³è°·", "å¯†äº‘", "å»¶åº†"]
            },
            "ä¸Šæµ·å¸‚": {
                "cities": ["ä¸Šæµ·", "é»„æµ¦", "å¾æ±‡", "é•¿å®", "é™å®‰", "æ™®é™€", "è™¹å£", "æ¨æµ¦", "é—µè¡Œ", "å®å±±", "å˜‰å®š", "æµ¦ä¸œ", "é‡‘å±±", "æ¾æ±Ÿ", "é’æµ¦", "å¥‰è´¤", "å´‡æ˜"]
            },
            "å¤©æ´¥å¸‚": {
                "cities": ["å¤©æ´¥", "å’Œå¹³", "æ²³ä¸œ", "æ²³è¥¿", "å—å¼€", "æ²³åŒ—", "çº¢æ¡¥", "ä¸œä¸½", "è¥¿é’", "æ´¥å—", "åŒ—è¾°", "æ­¦æ¸…", "å®å»", "æ»¨æµ·", "å®æ²³", "é™æµ·", "è“Ÿå·"]
            },
            "é‡åº†å¸‚": {
                "cities": ["é‡åº†", "ä¸‡å·", "æ¶ªé™µ", "æ¸ä¸­", "å¤§æ¸¡å£", "æ±ŸåŒ—", "æ²™åªå", "ä¹é¾™å¡", "å—å²¸", "åŒ—ç¢š", "ç¶¦æ±Ÿ", "å¤§è¶³", "æ¸åŒ—", "å·´å—", "é»”æ±Ÿ", "é•¿å¯¿", "æ±Ÿæ´¥", "åˆå·", "æ°¸å·", "å—å·"]
            },
            "å¹¿ä¸œçœ": {
                "cities": ["å¹¿å·", "æ·±åœ³", "ç æµ·", "æ±•å¤´", "ä½›å±±", "éŸ¶å…³", "æ¹›æ±Ÿ", "è‚‡åº†", "æ±Ÿé—¨", "èŒ‚å", "æƒ å·", "æ¢…å·", "æ±•å°¾", "æ²³æº", "é˜³æ±Ÿ", "æ¸…è¿œ", "ä¸œè", "ä¸­å±±", "æ½®å·", "æ­é˜³", "äº‘æµ®"]
            },
            "æ±Ÿè‹çœ": {
                "cities": ["å—äº¬", "æ— é”¡", "å¾å·", "å¸¸å·", "è‹å·", "å—é€š", "è¿äº‘æ¸¯", "æ·®å®‰", "ç›åŸ", "æ‰¬å·", "é•‡æ±Ÿ", "æ³°å·", "å®¿è¿"]
            },
            "æµ™æ±Ÿçœ": {
                "cities": ["æ­å·", "å®æ³¢", "æ¸©å·", "å˜‰å…´", "æ¹–å·", "ç»å…´", "é‡‘å", "è¡¢å·", "èˆŸå±±", "å°å·", "ä¸½æ°´"]
            },
            "å±±ä¸œçœ": {
                "cities": ["æµå—", "é’å²›", "æ·„åš", "æ£åº„", "ä¸œè¥", "çƒŸå°", "æ½åŠ", "æµå®", "æ³°å®‰", "å¨æµ·", "æ—¥ç…§", "ä¸´æ²‚", "å¾·å·", "èŠåŸ", "æ»¨å·", "èæ³½"]
            },
            "æ²³å—çœ": {
                "cities": ["éƒ‘å·", "å¼€å°", "æ´›é˜³", "å¹³é¡¶å±±", "å®‰é˜³", "é¹¤å£", "æ–°ä¹¡", "ç„¦ä½œ", "æ¿®é˜³", "è®¸æ˜Œ", "æ¼¯æ²³", "ä¸‰é—¨å³¡", "å—é˜³", "å•†ä¸˜", "ä¿¡é˜³", "å‘¨å£", "é©»é©¬åº—", "æµæº"]
            },
            "å››å·çœ": {
                "cities": ["æˆéƒ½", "è‡ªè´¡", "æ”€æèŠ±", "æ³¸å·", "å¾·é˜³", "ç»µé˜³", "å¹¿å…ƒ", "é‚å®", "å†…æ±Ÿ", "ä¹å±±", "å—å……", "çœ‰å±±", "å®œå®¾", "å¹¿å®‰", "è¾¾å·", "é›…å®‰", "å·´ä¸­", "èµ„é˜³"]
            },
            "æ¹–åŒ—çœ": {
                "cities": ["æ­¦æ±‰", "é»„çŸ³", "åå °", "å®œæ˜Œ", "è¥„é˜³", "é„‚å·", "è†é—¨", "å­æ„Ÿ", "è†å·", "é»„å†ˆ", "å’¸å®", "éšå·", "æ©æ–½"]
            },
            "æ¹–å—çœ": {
                "cities": ["é•¿æ²™", "æ ªæ´²", "æ¹˜æ½­", "è¡¡é˜³", "é‚µé˜³", "å²³é˜³", "å¸¸å¾·", "å¼ å®¶ç•Œ", "ç›Šé˜³", "éƒ´å·", "æ°¸å·", "æ€€åŒ–", "å¨„åº•", "æ¹˜è¥¿"]
            },
            "æ²³åŒ—çœ": {"cities": ["çŸ³å®¶åº„", "å”å±±", "ç§¦çš‡å²›", "é‚¯éƒ¸", "é‚¢å°", "ä¿å®š", "å¼ å®¶å£", "æ‰¿å¾·", "æ²§å·", "å»ŠåŠ", "è¡¡æ°´"]},
            "å±±è¥¿çœ": {"cities": ["å¤ªåŸ", "å¤§åŒ", "é˜³æ³‰", "é•¿æ²»", "æ™‹åŸ", "æœ”å·", "æ™‹ä¸­", "è¿åŸ", "å¿»å·", "ä¸´æ±¾", "å•æ¢"]},
            "è¾½å®çœ": {"cities": ["æ²ˆé˜³", "å¤§è¿", "éå±±", "æŠšé¡º", "æœ¬æºª", "ä¸¹ä¸œ", "é”¦å·", "è¥å£", "é˜œæ–°", "è¾½é˜³", "ç›˜é”¦", "é“å²­", "æœé˜³", "è‘«èŠ¦å²›"]},
            "å‰æ—çœ": {"cities": ["é•¿æ˜¥", "å‰æ—", "å››å¹³", "è¾½æº", "é€šåŒ–", "ç™½å±±", "æ¾åŸ", "ç™½åŸ", "å»¶è¾¹"]},
            "é»‘é¾™æ±Ÿçœ": {"cities": ["å“ˆå°”æ»¨", "é½é½å“ˆå°”", "ç‰¡ä¸¹æ±Ÿ", "ä½³æœ¨æ–¯", "å¤§åº†", "ä¼Šæ˜¥", "ä¸ƒå°æ²³", "é¸¡è¥¿", "é¹¤å²—", "åŒé¸­å±±", "é»‘æ²³", "ç»¥åŒ–", "å¤§å…´å®‰å²­"]},
            "å®‰å¾½çœ": {"cities": ["åˆè‚¥", "èŠœæ¹–", "èšŒåŸ ", "æ·®å—", "é©¬éå±±", "æ·®åŒ—", "é“œé™µ", "å®‰åº†", "é»„å±±", "æ»å·", "é˜œé˜³", "å®¿å·", "å…­å®‰", "äº³å·", "æ± å·", "å®£åŸ"]},
            "ç¦å»ºçœ": {"cities": ["ç¦å·", "å¦é—¨", "è†ç”°", "ä¸‰æ˜", "æ³‰å·", "æ¼³å·", "å—å¹³", "é¾™å²©", "å®å¾·"]},
            "æ±Ÿè¥¿çœ": {"cities": ["å—æ˜Œ", "æ™¯å¾·é•‡", "èä¹¡", "ä¹æ±Ÿ", "æ–°ä½™", "é¹°æ½­", "èµ£å·", "å‰å®‰", "å®œæ˜¥", "æŠšå·", "ä¸Šé¥¶"]},
            "æµ·å—çœ": {"cities": ["æµ·å£", "ä¸‰äºš", "ä¸‰æ²™", "å„‹å·", "ç¼æµ·", "æ–‡æ˜Œ", "ä¸‡å®", "ä¸œæ–¹", "äº”æŒ‡å±±", "æ¾„è¿ˆ", "ä¸´é«˜", "é™µæ°´", "ä¹ä¸œ", "å®šå®‰", "å±¯æ˜Œ", "ç™½æ²™", "æ˜Œæ±Ÿ", "ä¿äº­", "ç¼ä¸­"]},
            "äº‘å—çœ": {"cities": ["æ˜†æ˜", "æ›²é–", "ç‰æºª", "ä¿å±±", "æ˜­é€š", "ä¸½æ±Ÿ", "æ™®æ´±", "ä¸´æ²§", "æ¥šé›„", "çº¢æ²³", "æ–‡å±±", "è¥¿åŒç‰ˆçº³", "å¤§ç†", "å¾·å®", "æ€’æ±Ÿ", "è¿ªåº†"]},
            "è´µå·çœ": {"cities": ["è´µé˜³", "å…­ç›˜æ°´", "éµä¹‰", "å®‰é¡º", "æ¯•èŠ‚", "é“œä»", "é»”è¥¿å—", "é»”ä¸œå—", "é»”å—"]},
            "é™•è¥¿çœ": {"cities": ["è¥¿å®‰", "é“œå·", "å®é¸¡", "å’¸é˜³", "æ¸­å—", "å»¶å®‰", "æ±‰ä¸­", "æ¦†æ—", "å®‰åº·", "å•†æ´›"]},
            "ç”˜è‚ƒçœ": {"cities": ["å…°å·", "å˜‰å³ªå…³", "é‡‘æ˜Œ", "ç™½é“¶", "å¤©æ°´", "æ­¦å¨", "å¼ æ–", "å¹³å‡‰", "é…’æ³‰", "åº†é˜³", "å®šè¥¿", "é™‡å—", "ä¸´å¤", "ç”˜å—"]},
            "é’æµ·çœ": {"cities": ["è¥¿å®", "æµ·ä¸œ", "æµ·åŒ—", "é»„å—", "æµ·å—", "æœæ´›", "ç‰æ ‘", "æµ·è¥¿"]},
            "å°æ¹¾çœ": {"cities": ["å°åŒ—", "æ–°åŒ—", "æ¡ƒå›­", "å°ä¸­", "å°å—", "é«˜é›„", "æ–°ç«¹", "å˜‰ä¹‰"]},
            "å†…è’™å¤": {"cities": ["å‘¼å’Œæµ©ç‰¹", "åŒ…å¤´", "ä¹Œæµ·", "èµ¤å³°", "é€šè¾½", "é„‚å°”å¤šæ–¯", "å‘¼ä¼¦è´å°”", "å·´å½¦æ·–å°”", "ä¹Œå…°å¯Ÿå¸ƒ", "å…´å®‰", "é”¡æ—éƒ­å‹’", "é˜¿æ‹‰å–„"]},
            "å¹¿è¥¿": {"cities": ["å—å®", "æŸ³å·", "æ¡‚æ—", "æ¢§å·", "åŒ—æµ·", "é˜²åŸæ¸¯", "é’¦å·", "è´µæ¸¯", "ç‰æ—", "ç™¾è‰²", "è´ºå·", "æ²³æ± ", "æ¥å®¾", "å´‡å·¦"]},
            "è¥¿è—": {"cities": ["æ‹‰è¨", "æ—¥å–€åˆ™", "æ˜Œéƒ½", "æ—èŠ", "å±±å—", "é‚£æ›²", "é˜¿é‡Œ"]},
            "å®å¤": {"cities": ["é“¶å·", "çŸ³å˜´å±±", "å´å¿ ", "å›ºåŸ", "ä¸­å«"]},
            "æ–°ç–†": {"cities": ["ä¹Œé²æœ¨é½", "å…‹æ‹‰ç›ä¾", "åé²ç•ª", "å“ˆå¯†", "æ˜Œå‰", "åšå°”å¡”æ‹‰", "å·´éŸ³éƒ­æ¥", "é˜¿å…‹è‹", "å…‹å­œå‹’è‹", "å–€ä»€", "å’Œç”°", "ä¼ŠçŠ", "å¡”åŸ", "é˜¿å‹’æ³°"]},
            "é¦™æ¸¯": {"cities": ["é¦™æ¸¯"]},
            "æ¾³é—¨": {"cities": ["æ¾³é—¨"]}
        }
    def on_province_changed(self, province_name):
        """çœä»½é€‰æ‹©æ”¹å˜æ—¶æ›´æ–°åŸå¸‚åˆ—è¡¨"""
        self.birth_city.clear()
        self.birth_city.addItem("è¯·é€‰æ‹©åŸå¸‚")
        if province_name in self.city_database:
            cities = self.city_database[province_name]["cities"]
            self.birth_city.addItems(sorted(cities))
    def on_city_selected(self, city_name):
        """åŸå¸‚é€‰æ‹©äº‹ä»¶"""
        # çœŸå¤ªé˜³æ—¶æ ¡æ­£åŠŸèƒ½å·²ç§»é™¤ï¼Œæ­¤æ–¹æ³•ä¿ç•™ä¸ºç©º
        pass
    def on_precise_time_changed(self):
        """ç²¾ç¡®æ—¶é—´æ”¹å˜æ—¶çš„å¤„ç†"""
        # çœŸå¤ªé˜³æ—¶æ ¡æ­£åŠŸèƒ½å·²ç§»é™¤
        self.update_shichen_from_precise_time()
    def update_time_correction(self):
        """æ›´æ–°æ—¶é—´æ ¡æ­£ä¿¡æ¯æ˜¾ç¤º - åŠŸèƒ½å·²ç§»é™¤"""
        # çœŸå¤ªé˜³æ—¶æ ¡æ­£åŠŸèƒ½å·²ç§»é™¤
        """

            ,
            "æ²³åŒ—çœ": {"cities": ["çŸ³å®¶åº„", "å”å±±", "ç§¦çš‡å²›", "é‚¯éƒ¸", "é‚¢å°", "ä¿å®š", "å¼ å®¶å£", "æ‰¿å¾·", "æ²§å·", "å»ŠåŠ", "è¡¡æ°´"]},
            "å±±è¥¿çœ": {"cities": ["å¤ªåŸ", "å¤§åŒ", "é˜³æ³‰", "é•¿æ²»", "æ™‹åŸ", "æœ”å·", "æ™‹ä¸­", "è¿åŸ", "å¿»å·", "ä¸´æ±¾", "å•æ¢"]},
            "è¾½å®çœ": {"cities": ["æ²ˆé˜³", "å¤§è¿", "éå±±", "æŠšé¡º", "æœ¬æºª", "ä¸¹ä¸œ", "é”¦å·", "è¥å£", "é˜œæ–°", "è¾½é˜³", "ç›˜é”¦", "é“å²­", "æœé˜³", "è‘«èŠ¦å²›"]},
            "å‰æ—çœ": {"cities": ["é•¿æ˜¥", "å‰æ—", "å››å¹³", "è¾½æº", "é€šåŒ–", "ç™½å±±", "æ¾åŸ", "ç™½åŸ", "å»¶è¾¹"]},
            "é»‘é¾™æ±Ÿçœ": {"cities": ["å“ˆå°”æ»¨", "é½é½å“ˆå°”", "ç‰¡ä¸¹æ±Ÿ", "ä½³æœ¨æ–¯", "å¤§åº†", "ä¼Šæ˜¥", "ä¸ƒå°æ²³", "é¸¡è¥¿", "é¹¤å²—", "åŒé¸­å±±", "é»‘æ²³", "ç»¥åŒ–", "å¤§å…´å®‰å²­"]},
            "å®‰å¾½çœ": {"cities": ["åˆè‚¥", "èŠœæ¹–", "èšŒåŸ ", "æ·®å—", "é©¬éå±±", "æ·®åŒ—", "é“œé™µ", "å®‰åº†", "é»„å±±", "æ»å·", "é˜œé˜³", "å®¿å·", "å…­å®‰", "äº³å·", "æ± å·", "å®£åŸ"]},
            "ç¦å»ºçœ": {"cities": ["ç¦å·", "å¦é—¨", "è†ç”°", "ä¸‰æ˜", "æ³‰å·", "æ¼³å·", "å—å¹³", "é¾™å²©", "å®å¾·"]},
            "æ±Ÿè¥¿çœ": {"cities": ["å—æ˜Œ", "æ™¯å¾·é•‡", "èä¹¡", "ä¹æ±Ÿ", "æ–°ä½™", "é¹°æ½­", "èµ£å·", "å‰å®‰", "å®œæ˜¥", "æŠšå·", "ä¸Šé¥¶"]},
            "æµ·å—çœ": {"cities": ["æµ·å£", "ä¸‰äºš", "ä¸‰æ²™", "å„‹å·", "ç¼æµ·", "æ–‡æ˜Œ", "ä¸‡å®", "ä¸œæ–¹", "äº”æŒ‡å±±", "æ¾„è¿ˆ", "ä¸´é«˜", "é™µæ°´", "ä¹ä¸œ"]},
            "äº‘å—çœ": {"cities": ["æ˜†æ˜", "æ›²é–", "ç‰æºª", "ä¿å±±", "æ˜­é€š", "ä¸½æ±Ÿ", "æ™®æ´±", "ä¸´æ²§", "æ¥šé›„", "çº¢æ²³", "æ–‡å±±", "è¥¿åŒç‰ˆçº³", "å¤§ç†", "å¾·å®", "æ€’æ±Ÿ", "è¿ªåº†"]},
            "è´µå·çœ": {"cities": ["è´µé˜³", "å…­ç›˜æ°´", "éµä¹‰", "å®‰é¡º", "æ¯•èŠ‚", "é“œä»", "é»”è¥¿å—", "é»”ä¸œå—", "é»”å—"]},
            "é™•è¥¿çœ": {"cities": ["è¥¿å®‰", "é“œå·", "å®é¸¡", "å’¸é˜³", "æ¸­å—", "å»¶å®‰", "æ±‰ä¸­", "æ¦†æ—", "å®‰åº·", "å•†æ´›"]},
            "ç”˜è‚ƒçœ": {"cities": ["å…°å·", "å˜‰å³ªå…³", "é‡‘æ˜Œ", "ç™½é“¶", "å¤©æ°´", "æ­¦å¨", "å¼ æ–", "å¹³å‡‰", "é…’æ³‰", "åº†é˜³", "å®šè¥¿", "é™‡å—", "ä¸´å¤", "ç”˜å—"]},
            "é’æµ·çœ": {"cities": ["è¥¿å®", "æµ·ä¸œ", "æµ·åŒ—", "é»„å—", "æµ·å—", "æœæ´›", "ç‰æ ‘", "æµ·è¥¿"]},
            "å°æ¹¾çœ": {"cities": ["å°åŒ—", "æ–°åŒ—", "æ¡ƒå›­", "å°ä¸­", "å°å—", "é«˜é›„", "æ–°ç«¹", "å˜‰ä¹‰"]},
            "å†…è’™å¤": {"cities": ["å‘¼å’Œæµ©ç‰¹", "åŒ…å¤´", "ä¹Œæµ·", "èµ¤å³°", "é€šè¾½", "é„‚å°”å¤šæ–¯", "å‘¼ä¼¦è´å°”", "å·´å½¦æ·–å°”", "ä¹Œå…°å¯Ÿå¸ƒ", "å…´å®‰", "é”¡æ—éƒ­å‹’", "é˜¿æ‹‰å–„"]},
            "å¹¿è¥¿": {"cities": ["å—å®", "æŸ³å·", "æ¡‚æ—", "æ¢§å·", "åŒ—æµ·", "é˜²åŸæ¸¯", "é’¦å·", "è´µæ¸¯", "ç‰æ—", "ç™¾è‰²", "è´ºå·", "æ²³æ± ", "æ¥å®¾", "å´‡å·¦"]},
            "è¥¿è—": {"cities": ["æ‹‰è¨", "æ—¥å–€åˆ™", "æ˜Œéƒ½", "æ—èŠ", "å±±å—", "é‚£æ›²", "é˜¿é‡Œ"]},
            "å®å¤": {"cities": ["é“¶å·", "çŸ³å˜´å±±", "å´å¿ ", "å›ºåŸ", "ä¸­å«"]},
            "æ–°ç–†": {"cities": ["ä¹Œé²æœ¨é½", "å…‹æ‹‰ç›ä¾", "åé²ç•ª", "å“ˆå¯†", "æ˜Œå‰", "åšå°”å¡”æ‹‰", "å·´éŸ³éƒ­æ¥", "é˜¿å…‹è‹", "å…‹å­œå‹’è‹", "å–€ä»€", "å’Œç”°", "ä¼ŠçŠ", "å¡”åŸ", "é˜¿å‹’æ³°"]},
            "é¦™æ¸¯": {"cities": ["é¦™æ¸¯"]},
            "æ¾³é—¨": {"cities": ["æ¾³é—¨"]}

        """

        pass

    def update_shichen_from_precise_time(self):
        """æ ¹æ®ç²¾ç¡®æ—¶é—´è‡ªåŠ¨æ›´æ–°æ—¶è¾°é€‰æ‹©"""
        try:
            hour = self.precise_hour.value()
            minute = self.precise_minute.value()
            shichen_name = self.get_shichen_from_time(hour, minute)
            # åœ¨æ—¶è¾°åˆ—è¡¨ä¸­æ‰¾åˆ°å¯¹åº”é¡¹
            for i, item in enumerate(self.shichen_list):
                if shichen_name in item:
                    self.hour_combo.setCurrentIndex(i)
                    break
        except Exception:
            pass
    def get_city_longitude(self, city_name):
        """è·å–åŸå¸‚ç»åº¦ï¼ˆç®€åŒ–ç‰ˆï¼‰"""
        # ä¸»è¦åŸå¸‚ç»åº¦æ•°æ®
        city_coordinates = {
            "åŒ—äº¬": 116.4, "ä¸Šæµ·": 121.5, "å¤©æ´¥": 117.2, "é‡åº†": 106.5,
            "å¹¿å·": 113.3, "æ·±åœ³": 114.1, "æ­å·": 120.2, "å—äº¬": 118.8,
            "æ­¦æ±‰": 114.3, "æˆéƒ½": 104.1, "è¥¿å®‰": 108.9, "é•¿æ²™": 112.9,
            "æ²ˆé˜³": 123.4, "å¤§è¿": 121.6, "é’å²›": 120.4, "å¦é—¨": 118.1,
            "æ˜†æ˜": 102.7, "å—å®": 108.4, "å“ˆå°”æ»¨": 126.6, "é•¿æ˜¥": 125.3,
            "çŸ³å®¶åº„": 114.5, "å¤ªåŸ": 112.5, "å‘¼å’Œæµ©ç‰¹": 111.7, "å…°å·": 103.8,
            "è¥¿å®": 101.8, "é“¶å·": 106.2, "ä¹Œé²æœ¨é½": 87.6, "æ‹‰è¨": 91.1
        }
        return city_coordinates.get(city_name)
    def calculate_solar_time(self, hour, minute, longitude):
        """è®¡ç®—çœŸå¤ªé˜³æ—¶"""
        # ç»åº¦æ—¶å·®è®¡ç®—ï¼ˆæ¯åº¦4åˆ†é’Ÿï¼‰
        time_diff_minutes = (longitude - 120) * 4
        # è½¬æ¢ä¸ºå°æ—¶å’Œåˆ†é’Ÿ
        hour_diff = int(time_diff_minutes // 60)
        minute_diff = int(time_diff_minutes % 60)
        # åº”ç”¨æ ¡æ­£
        solar_hour = hour + hour_diff
        solar_minute = minute + minute_diff
        # å¤„ç†è¿›ä½å’Œå€Ÿä½
        if solar_minute < 0:
            solar_minute += 60
            solar_hour -= 1
        elif solar_minute >= 60:
            solar_minute -= 60
            solar_hour += 1
        # å¤„ç†å°æ—¶è¶Šç•Œ
        if solar_hour < 0:
            solar_hour += 24
        elif solar_hour >= 24:
            solar_hour -= 24
        return solar_hour, solar_minute
    def get_shichen_from_time(self, hour, minute):
        """æ ¹æ®æ—¶é—´è·å–æ—¶è¾°åç§°"""
        # æ—¶è¾°å¯¹åº”è¡¨
        if (hour == 23) or (hour == 0):
            return "å­æ—¶"
        elif 1 <= hour <= 2:
            return "ä¸‘æ—¶"
        elif 3 <= hour <= 4:
            return "å¯…æ—¶"
        elif 5 <= hour <= 6:
            return "å¯æ—¶"
        elif 7 <= hour <= 8:
            return "è¾°æ—¶"
        elif 9 <= hour <= 10:
            return "å·³æ—¶"
        elif 11 <= hour <= 12:
            return "åˆæ—¶"
        elif 13 <= hour <= 14:
            return "æœªæ—¶"
        elif 15 <= hour <= 16:
            return "ç”³æ—¶"
        elif 17 <= hour <= 18:
            return "é…‰æ—¶"
        elif 19 <= hour <= 20:
            return "æˆŒæ—¶"
        elif 21 <= hour <= 22:
            return "äº¥æ—¶"
        else:
            return "æœªçŸ¥"

    def generate_personalized_noble_advice(self, pillars, day_master):
        """ç”Ÿæˆä¸ªæ€§åŒ–çš„è´µäººè¿å»ºè®® - ä¿®å¤ç‰ˆï¼Œä¸ç¥ç…åˆ†æå®Œå…¨åŒæ­¥"""
        all_branches = [pillars['year'][1], pillars['month'][1], pillars['day'][1], pillars['hour'][1]]
        all_stems = [pillars['year'][0], pillars['month'][0], pillars['day'][0], pillars['hour'][0]]

        advice = []
        found_nobles = []

        # ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ä¸ç¥ç…åˆ†æå®Œå…¨ä¸€è‡´çš„è´µäººç±»å‹

        # å¤©å¾·è´µäºº
        tiande_map = {
            'å­': 'ä¸', 'ä¸‘': 'ä¸', 'å¯…': 'ä¸™', 'å¯': 'ç”²', 'è¾°': 'ç”²',
            'å·³': 'ç™¸', 'åˆ': 'ç™¸', 'æœª': 'å£¬', 'ç”³': 'å£¬', 'é…‰': 'è¾›',
            'æˆŒ': 'è¾›', 'äº¥': 'åºš'
        }
        month_branch = all_branches[1]  # æœˆæ”¯
        if month_branch in tiande_map and tiande_map[month_branch] in all_stems:
            found_nobles.append('å¤©å¾·è´µäºº')

        # æœˆå¾·è´µäºº
        yuede_map = {
            'å¯…': 'ä¸™', 'å¯': 'ç”²', 'è¾°': 'ç”²', 'å·³': 'ç™¸', 'åˆ': 'ç™¸',
            'æœª': 'å£¬', 'ç”³': 'å£¬', 'é…‰': 'è¾›', 'æˆŒ': 'è¾›', 'äº¥': 'åºš',
            'å­': 'ä¸', 'ä¸‘': 'ä¸'
        }
        if month_branch in yuede_map and yuede_map[month_branch] in all_stems:
            found_nobles.append('æœˆå¾·è´µäºº')

        # ç¦„ç¥
        lushen_map = {
            'ç”²': 'å¯…', 'ä¹™': 'å¯', 'ä¸™': 'å·³', 'ä¸': 'åˆ', 'æˆŠ': 'å·³',
            'å·±': 'åˆ', 'åºš': 'ç”³', 'è¾›': 'é…‰', 'å£¬': 'äº¥', 'ç™¸': 'å­'
        }
        if day_master in lushen_map and lushen_map[day_master] in all_branches:
            found_nobles.append('ç¦„ç¥')

        # ğŸ”§ åˆ é™¤é‡å¤çš„è´µäººå®šä¹‰ï¼Œå·²åœ¨ä¸Šé¢å®šä¹‰è¿‡

        # åŸºäºä¼ ç»Ÿå‘½ç†å­¦çš„è´µäººåˆ†æ
        advice.append("\nâ€¢ è´µäººç¥ç…åˆ†æï¼š")

        if 'å¤©å¾·è´µäºº' in found_nobles:
            advice.append("  å¤©å¾·è´µäººï¼šé€¢å‡¶åŒ–å‰ï¼Œé‡éš¾å‘ˆç¥¥")

        if 'æœˆå¾·è´µäºº' in found_nobles:
            advice.append("  æœˆå¾·è´µäººï¼šæ€§æƒ…æ¸©å’Œï¼Œç¦å¾·æ·±åš")

        if 'ç¦„ç¥' in found_nobles:
            advice.append("  å»ºç¦„ç¥ç…ï¼šè‡ªç«‹è‡ªå¼ºï¼Œè¡£é£Ÿæ— å¿§")

        if not found_nobles:
            advice.append("  å‘½ä¸­è´µäººè¾ƒå°‘ï¼Œå®œå¤šè¡Œå–„äº‹ï¼Œå¹¿ç»“å–„ç¼˜")

        # ä¼ ç»Ÿè´µäººè¦ç‚¹
        advice.append("\nâ€¢ ä¼ ç»Ÿè´µäººè¦ç‚¹ï¼š")
        advice.append("  è´µäººç¥ç…ä¸»å‰ç¥¥ï¼Œé€¢ä¹‹å¤šæœ‰åŠ©åŠ›")
        advice.append("  è´µäººä¸ç‹¬ç”¨ï¼Œéœ€é…åˆæ ¼å±€åˆ†æ")
        advice.append("  å¾·è¡Œä¸ºæœ¬ï¼Œç¥ç…ä¸ºè¾…")

        return "\n".join(advice)

    def check_sanhejiu_combination(self, pattern, all_branches):
        """ç»Ÿä¸€çš„ä¸‰åˆå±€åˆ¤æ–­å‡½æ•° - è§£å†³ä¸‰ä¸ªç¥ç…åˆ†æå‡½æ•°çš„å†²çª"""
        pattern_chars = [char for char in pattern if char in all_branches]
        pattern_count = len(pattern_chars)

        # ä¸¥æ ¼åˆ¤æ–­ï¼šå¿…é¡»æ˜¯ä¸‰åˆæˆå±€æˆ–è€…æ­£ç¡®çš„åŠåˆ
        valid_combination = False
        pattern_desc = ""

        if pattern_count == 3:
            # ä¸‰åˆæˆå±€
            valid_combination = True
            pattern_desc = "ã€".join(pattern_chars) + "ä¸‰åˆæˆå±€"
        elif pattern_count == 2:
            # æ£€æŸ¥æ˜¯å¦æ˜¯æ­£ç¡®çš„åŠåˆç»„åˆ
            if pattern == 'ç”³å­è¾°':
                # ç”³å­åŠåˆï¼Œå­è¾°åŠåˆï¼Œç”³è¾°ä¸æ˜¯åŠåˆ
                if ('ç”³' in pattern_chars and 'å­' in pattern_chars) or ('å­' in pattern_chars and 'è¾°' in pattern_chars):
                    valid_combination = True
                    pattern_desc = "ã€".join(pattern_chars) + "åŠåˆ"
            elif pattern == 'å¯…åˆæˆŒ':
                # å¯…åˆåŠåˆï¼ŒåˆæˆŒåŠåˆï¼Œå¯…æˆŒä¸æ˜¯åŠåˆ
                if ('å¯…' in pattern_chars and 'åˆ' in pattern_chars) or ('åˆ' in pattern_chars and 'æˆŒ' in pattern_chars):
                    valid_combination = True
                    pattern_desc = "ã€".join(pattern_chars) + "åŠåˆ"
            elif pattern == 'å·³é…‰ä¸‘':
                # å·³é…‰åŠåˆï¼Œé…‰ä¸‘ä¸æ˜¯åŠåˆï¼åªæœ‰å·³é…‰æ‰æ˜¯æ­£ç¡®çš„åŠåˆ
                if ('å·³' in pattern_chars and 'é…‰' in pattern_chars):
                    valid_combination = True
                    pattern_desc = "ã€".join(pattern_chars) + "åŠåˆ"
            elif pattern == 'äº¥å¯æœª':
                # äº¥å¯åŠåˆï¼Œå¯æœªåŠåˆï¼Œäº¥æœªä¸æ˜¯åŠåˆ
                if ('äº¥' in pattern_chars and 'å¯' in pattern_chars) or ('å¯' in pattern_chars and 'æœª' in pattern_chars):
                    valid_combination = True
                    pattern_desc = "ã€".join(pattern_chars) + "åŠåˆ"

        return valid_combination, pattern_desc, pattern_chars

    def init_accessories_database(self):
        """åˆå§‹åŒ–é¥°ç‰©å»ºè®®çŸ¥è¯†åº“"""
        # é¥°ç‰©å»ºè®®çŸ¥è¯†åº“
        self.accessories_suggestions = {
            'æœ¨': {
                'é¢œè‰²': ['ç»¿è‰²', 'é’è‰²', 'ç¿ ç»¿'],
                'æè´¨': ['æœ¨è´¨', 'ç«¹åˆ¶', 'è—¤åˆ¶'],
                'å®çŸ³': ['ç¿¡ç¿ ', 'ç»¿æ¾çŸ³', 'å­”é›€çŸ³', 'ç»¿ç›ç‘™'],
                'å½¢çŠ¶': ['é•¿æ–¹å½¢', 'åœ†æŸ±å½¢'],
                'æ•°å­—': [3, 8]
            },
            'ç«': {
                'é¢œè‰²': ['çº¢è‰²', 'æ©™è‰²', 'ç´«è‰²'],
                'æè´¨': ['çš®é©', 'ä¸ç»¸'],
                'å®çŸ³': ['çº¢å®çŸ³', 'çŸ³æ¦´çŸ³', 'çº¢ç›ç‘™', 'çŠç‘š'],
                'å½¢çŠ¶': ['ä¸‰è§’å½¢', 'å°–å½¢'],
                'æ•°å­—': [2, 7]
            },
            'åœŸ': {
                'é¢œè‰²': ['é»„è‰²', 'æ£•è‰²', 'åœŸé»„'],
                'æè´¨': ['é™¶ç“·', 'ç‰çŸ³', 'æ°´æ™¶'],
                'å®çŸ³': ['é»„æ°´æ™¶', 'ç¥ç€', 'èœœèœ¡', 'é»„ç‰'],
                'å½¢çŠ¶': ['æ­£æ–¹å½¢', 'åšé‡å½¢'],
                'æ•°å­—': [5, 10]
            },
            'é‡‘': {
                'é¢œè‰²': ['ç™½è‰²', 'é‡‘è‰²', 'é“¶è‰²'],
                'æè´¨': ['é‡‘å±', 'ç™½é‡‘', 'é“¶é¥°'],
                'å®çŸ³': ['é’»çŸ³', 'ç™½æ°´æ™¶', 'çç ', 'ç™½ç‰'],
                'å½¢çŠ¶': ['åœ†å½¢', 'æ¤­åœ†å½¢'],
                'æ•°å­—': [4, 9]
            },
            'æ°´': {
                'é¢œè‰²': ['é»‘è‰²', 'è“è‰²', 'æ·±è“'],
                'æè´¨': ['ç»ç’ƒ', 'æ°´æ™¶', 'é»‘æ›œçŸ³'],
                'å®çŸ³': ['è“å®çŸ³', 'æµ·è“å®', 'é»‘ç›ç‘™', 'é»‘æ°´æ™¶'],
                'å½¢çŠ¶': ['æ³¢æµªå½¢', 'ä¸è§„åˆ™å½¢'],
                'æ•°å­—': [1, 6]
            }
        }
        # åˆå§‹åŒ–æé†’å®šæ—¶å™¨
        self.reminder_timer = QTimer()
        self.reminder_timer.timeout.connect(self.check_daily_reminders)
        self.reminder_timer.start(3600000)  # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
        # å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºè¿åŠ¿æé†’ï¼‰
        self.current_user_info = None
    def init_ui(self):
        """åˆå§‹åŒ–ç”¨æˆ·ç•Œé¢"""
        main_layout = QVBoxLayout(self)
        main_layout.setSpacing(10)
        # æ ‡é¢˜
        title_label = QLabel("ğŸ”® å…«å­—ç®—å‘½é£æ°´ç³»ç»Ÿ")
        title_label.setAlignment(Qt.AlignCenter)
        title_label.setStyleSheet("font-size: 24px; font-weight: bold; color: #FFD700; margin: 10px;")
        main_layout.addWidget(title_label)
        # åˆ›å»ºé€‰é¡¹å¡
        tab_widget = QTabWidget()
        tab_widget.setStyleSheet("""
            QTabWidget::pane {
                border: 2px solid #FFD700;
                border-radius: 5px;
            }
            QTabBar::tab {
                background: #3A3A3A;
                color: #FFD700;
                padding: 8px 16px;
                margin-right: 2px;
                border-top-left-radius: 5px;
                border-top-right-radius: 5px;
            }
            QTabBar::tab:selected {
                background: #FFD700;
                color: #000000;
            }
        """)
        # å…«å­—ç®—å‘½é€‰é¡¹å¡
        bazi_tab = self.create_bazi_tab()
        tab_widget.addTab(bazi_tab, "å…«å­—ç®—å‘½")
        # èµ·ååˆ†æé€‰é¡¹å¡
        naming_tab = self.create_naming_tab()
        tab_widget.addTab(naming_tab, "èµ·ååˆ†æ")
        # é£æ°´åˆ†æé€‰é¡¹å¡
        fengshui_tab = self.create_fengshui_tab()
        tab_widget.addTab(fengshui_tab, "é£æ°´åˆ†æ")
        main_layout.addWidget(tab_widget)
        # åº•éƒ¨æŒ‰é’® - å¢å¤§å…³é—­æŒ‰é’®
        button_layout = QHBoxLayout()
        # æ·»åŠ è¯¦ç»†è¿åŠ¿æŒ‰é’®
        detail_btn = QPushButton("ğŸ“Š æŸ¥çœ‹è¯¦ç»†è¿åŠ¿")
        detail_btn.clicked.connect(self.show_fortune_detail)
        detail_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4CAF50, stop:1 #45a049);
                color: white;
                font-weight: bold;
                font-size: 14px;
                padding: 10px 20px;
                border-radius: 5px;
                border: none;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #45a049, stop:1 #3d8b40);
            }
        """)
        close_btn = QPushButton("âŒ å…³é—­çª—å£")
        close_btn.clicked.connect(self.close)
        close_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #FF6B6B, stop:1 #FF5252);
                color: white;
                font-weight: bold;
                font-size: 14px;
                padding: 10px 20px;
                border-radius: 5px;
                border: none;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #FF5252, stop:1 #E53935);
            }
        """)
        button_layout.addWidget(detail_btn)
        button_layout.addStretch()
        button_layout.addWidget(close_btn)
        main_layout.addLayout(button_layout)
    def create_bazi_tab(self):
        """åˆ›å»ºå…«å­—ç®—å‘½é€‰é¡¹å¡"""
        widget = QWidget()
        layout = QHBoxLayout(widget)
        # å·¦ä¾§è¾“å…¥åŒºåŸŸ
        input_group = QGroupBox("ä¸ªäººä¿¡æ¯è¾“å…¥")
        input_layout = QVBoxLayout(input_group)
        # å§“åè¾“å…¥ï¼ˆå¯é€‰ï¼‰
        name_layout = QHBoxLayout()
        name_layout.addWidget(QLabel("å§“åï¼ˆå¯é€‰ï¼‰:"))
        self.name_edit = QLineEdit()
        self.name_edit.setPlaceholderText("å¯ä¸å¡«ï¼Œç›´æ¥åˆ†æå…«å­—")
        name_layout.addWidget(self.name_edit)
        input_layout.addLayout(name_layout)
        # æ€§åˆ«é€‰æ‹©
        gender_layout = QHBoxLayout()
        gender_layout.addWidget(QLabel("æ€§åˆ«:"))
        self.gender_combo = QComboBox()
        self.gender_combo.addItems(["ç”·", "å¥³"])
        gender_layout.addWidget(self.gender_combo)
        gender_layout.addStretch()
        input_layout.addLayout(gender_layout)

        # APIé…ç½®ç•Œé¢å·²éšè—ï¼Œç›´æ¥ä½¿ç”¨deepseek_config.jsonæ–‡ä»¶
        # ä½†ä¿ç•™å¿…è¦çš„å±æ€§ä»¥ç¡®ä¿APIè°ƒç”¨åŠŸèƒ½æ­£å¸¸
        self.api_key_edit = None  # ä¸åˆ›å»ºç•Œé¢å…ƒç´ 
        self.internal_api_key = None  # ä¿ç•™å†…éƒ¨å˜é‡

        # é™é»˜åŠ è½½APIé…ç½®
        self.load_api_config_silent()

        # å†œå†å‡ºç”Ÿæ—¥æœŸ
        birth_group = QGroupBox("å‡ºç”Ÿæ—¥æœŸï¼ˆå†œå†ï¼‰")
        birth_layout = QGridLayout(birth_group)
        # å¹´ä»½
        birth_layout.addWidget(QLabel("å¹´ä»½:"), 0, 0)
        self.birth_year = QSpinBox()
        self.birth_year.setRange(1900, 2100)
        self.birth_year.setValue(1990)
        self.birth_year.setSuffix("å¹´")
        birth_layout.addWidget(self.birth_year, 0, 1)
        # æœˆä»½
        birth_layout.addWidget(QLabel("æœˆä»½:"), 0, 2)
        self.birth_month = QComboBox()
        self.birth_month.addItems(self.lunar_months)
        birth_layout.addWidget(self.birth_month, 0, 3)
        # æ—¥æœŸ
        birth_layout.addWidget(QLabel("æ—¥æœŸ:"), 1, 0)
        self.birth_day = QComboBox()
        self.birth_day.addItems(self.lunar_days)
        birth_layout.addWidget(self.birth_day, 1, 1)
        # é—°æœˆé€‰æ‹©
        self.leap_month = QCheckBox("é—°æœˆ")
        birth_layout.addWidget(self.leap_month, 1, 2, 1, 2)
        input_layout.addWidget(birth_group)
        # å‡ºç”Ÿæ—¶è¾°
        time_layout = QHBoxLayout()
        time_layout.addWidget(QLabel("å‡ºç”Ÿæ—¶è¾°:"))
        self.hour_combo = QComboBox()
        self.hour_combo.addItems(self.shichen_list)
        time_layout.addWidget(self.hour_combo)
        # ğŸ”§ æ–°å¢ï¼šç²¾ç¡®æ—¶é—´è¾“å…¥
        time_layout.addWidget(QLabel("ç²¾ç¡®æ—¶é—´(å¯é€‰):"))
        self.precise_hour = QSpinBox()
        self.precise_hour.setRange(0, 23)
        self.precise_hour.setValue(1)  # é»˜è®¤1ç‚¹
        self.precise_hour.setSuffix("æ—¶")
        time_layout.addWidget(self.precise_hour)
        self.precise_minute = QSpinBox()
        self.precise_minute.setRange(0, 59)
        self.precise_minute.setValue(30)  # é»˜è®¤30åˆ†
        self.precise_minute.setSuffix("åˆ†")
        time_layout.addWidget(self.precise_minute)
        # è¿æ¥ç²¾ç¡®æ—¶é—´å˜åŒ–äº‹ä»¶
        self.precise_hour.valueChanged.connect(self.on_precise_time_changed)
        self.precise_minute.valueChanged.connect(self.on_precise_time_changed)
        input_layout.addLayout(time_layout)
        # å‡ºç”Ÿåœ°ç‚¹ï¼ˆå¯é€‰ï¼‰
        location_group = QGroupBox("å‡ºç”Ÿåœ°ç‚¹ï¼ˆå¯é€‰ï¼‰")
        location_layout = QGridLayout(location_group)
        location_layout.addWidget(QLabel("çœä»½:"), 0, 0)
        self.birth_province = QComboBox()
        provinces = ["åŒ—äº¬å¸‚", "ä¸Šæµ·å¸‚", "å¤©æ´¥å¸‚", "é‡åº†å¸‚", "æ²³åŒ—çœ", "å±±è¥¿çœ", "è¾½å®çœ", "å‰æ—çœ",
                    "é»‘é¾™æ±Ÿçœ", "æ±Ÿè‹çœ", "æµ™æ±Ÿçœ", "å®‰å¾½çœ", "ç¦å»ºçœ", "æ±Ÿè¥¿çœ", "å±±ä¸œçœ", "æ²³å—çœ",
                    "æ¹–åŒ—çœ", "æ¹–å—çœ", "å¹¿ä¸œçœ", "æµ·å—çœ", "å››å·çœ", "è´µå·çœ", "äº‘å—çœ", "é™•è¥¿çœ",
                    "ç”˜è‚ƒçœ", "é’æµ·çœ", "å°æ¹¾çœ", "å†…è’™å¤", "å¹¿è¥¿", "è¥¿è—", "å®å¤", "æ–°ç–†", "é¦™æ¸¯", "æ¾³é—¨"]
        self.birth_province.addItems(provinces)
        location_layout.addWidget(self.birth_province, 0, 1)
        location_layout.addWidget(QLabel("åŸå¸‚:"), 0, 2)
        self.birth_city = QComboBox()
        self.birth_city.addItem("è¯·é€‰æ‹©åŸå¸‚")

        # è¿æ¥çœä»½é€‰æ‹©äº‹ä»¶ï¼Œå½“çœä»½æ”¹å˜æ—¶æ›´æ–°åŸå¸‚åˆ—è¡¨
        self.birth_province.currentTextChanged.connect(self.on_province_changed)
        # è¿æ¥åŸå¸‚é€‰æ‹©äº‹ä»¶
        self.birth_city.currentTextChanged.connect(self.on_city_selected)
        location_layout.addWidget(self.birth_city, 0, 3)
        # çœŸå¤ªé˜³æ—¶æ ¡æ­£åŠŸèƒ½å·²ç§»é™¤
        input_layout.addWidget(location_group)
        # æ—¶é—´æ ¡æ­£æ˜¾ç¤ºåŒºåŸŸå·²ç§»é™¤
        # æŒ‰é’®ç»„
        button_layout = QHBoxLayout()
        # è®¡ç®—æŒ‰é’®
        calc_btn = QPushButton("ğŸ”® å¼€å§‹æ’å…«å­—")
        calc_btn.clicked.connect(self.calculate_bazi)
        calc_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A4A6A, stop:1 #4A2A4A);
                border: 2px solid #FF66AA;
                border-radius: 8px;
                color: #FFD700;
                font-weight: bold;
                padding: 10px;
                font-size: 14px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #8A6A8A, stop:1 #6A4A6A);
                border-color: #FF88CC;
            }
        """)
        button_layout.addWidget(calc_btn)
        # è¿åŠ¿æŸ¥çœ‹æŒ‰é’®
        fortune_btn = QPushButton("ğŸ“Š æŸ¥çœ‹è¿åŠ¿")
        fortune_btn.clicked.connect(self.show_fortune_detail)
        fortune_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A6A4A, stop:1 #2A4A2A);
                border: 2px solid #66FF66;
                border-radius: 8px;
                color: #FFD700;
                font-weight: bold;
                padding: 10px;
                font-size: 14px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A8A6A, stop:1 #4A6A4A);
                border-color: #88FF88;
            }
        """)
        button_layout.addWidget(fortune_btn)
        # ä¿å­˜ä¿¡æ¯æŒ‰é’®
        save_btn = QPushButton("ğŸ’¾ ä¿å­˜ä¿¡æ¯")
        save_btn.clicked.connect(self.save_person_info)
        save_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2196F3, stop:1 #1976D2);
                border: 2px solid #42A5F5;
                border-radius: 8px;
                color: #FFD700;
                font-weight: bold;
                padding: 10px;
                font-size: 14px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #42A5F5, stop:1 #2196F3);
                border-color: #64B5F6;
            }
        """)
        button_layout.addWidget(save_btn)
        # åŠ è½½ä¿¡æ¯æŒ‰é’®
        load_btn = QPushButton("ğŸ“‚ åŠ è½½ä¿¡æ¯")
        load_btn.clicked.connect(self.load_person_info)
        load_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #FF9800, stop:1 #F57C00);
                border: 2px solid #FFB74D;
                border-radius: 8px;
                color: #FFD700;
                font-weight: bold;
                padding: 10px;
                font-size: 14px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #FFB74D, stop:1 #FF9800);
                border-color: #FFCC02;
            }
        """)
        button_layout.addWidget(load_btn)
        # åˆ é™¤ä¿¡æ¯æŒ‰é’®
        delete_btn = QPushButton("ğŸ—‘ï¸ åˆ é™¤ä¿¡æ¯")
        delete_btn.clicked.connect(self.delete_person_info)
        delete_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #f44336, stop:1 #d32f2f);
                border: 2px solid #ef5350;
                border-radius: 8px;
                color: #FFD700;
                font-weight: bold;
                padding: 10px;
                font-size: 14px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #ef5350, stop:1 #f44336);
                border-color: #e57373;
            }
        """)
        button_layout.addWidget(delete_btn)
        input_layout.addLayout(button_layout)
        input_layout.addStretch()
        layout.addWidget(input_group)
        # å³ä¾§ç»“æœæ˜¾ç¤ºåŒºåŸŸ
        result_group = QGroupBox("å…«å­—å‘½ç†åˆ†æ")
        result_layout = QVBoxLayout(result_group)
        self.bazi_result = QTextEdit()
        self.bazi_result.setReadOnly(True)
        self.bazi_result.setPlaceholderText("è¯·è¾“å…¥ä¸ªäººä¿¡æ¯åç‚¹å‡»\"å¼€å§‹æ’å…«å­—\"æŸ¥çœ‹è¯¦ç»†åˆ†æ...")

        # ğŸ”¥ å…³é”®é…ç½®ï¼šç¡®ä¿èƒ½æ˜¾ç¤ºé•¿æ–‡æœ¬
        # QTextEdit æœ¬èº«æ²¡æœ‰ setMaximumBlockCountï¼Œéœ€é€šè¿‡å…¶ QTextDocument è®¾ç½®
        self.bazi_result.document().setMaximumBlockCount(0)  # æ— é™åˆ¶æ–‡æœ¬å—æ•°é‡
        self.bazi_result.setUndoRedoEnabled(False)  # ç¦ç”¨æ’¤é”€é‡åšä»¥èŠ‚çœå†…å­˜

        # ğŸ”¥ ä¿®å¤ï¼šè®¾ç½®ç¼–ç å’Œå­—ä½“ï¼Œç¡®ä¿ä¸­æ–‡æ­£ç¡®æ˜¾ç¤º
        # QTextEdité»˜è®¤ä½¿ç”¨UTF-8ï¼Œä½†éœ€è¦ç¡®ä¿å­—ä½“æ”¯æŒä¸­æ–‡
        font = QFont("Microsoft YaHei", 20)  # ä½¿ç”¨å¾®è½¯é›…é»‘å­—ä½“ï¼Œæ”¯æŒä¸­æ–‡
        font.setStyleHint(QFont.SansSerif)
        self.bazi_result.setFont(font)

        # ç¡®ä¿æ–‡æ¡£ä½¿ç”¨UTF-8ç¼–ç 
        self.bazi_result.document().setDefaultFont(font)

        # è®¾ç½®æ ·å¼ï¼Œç¡®ä¿æ–‡æœ¬å®Œæ•´æ˜¾ç¤º
        self.bazi_result.setStyleSheet("""
            QTextEdit {
                background-color: #2b2b2b;
                color: #FFD700; /* é‡‘é»„è‰²æ–‡å­—ï¼Œæå‡å¯è¯»æ€§ */
                border: 2px solid #4a4a4a;
                border-radius: 5px;
                padding: 10px;
                line-height: 1.6;
                selection-background-color: #4a4a4a;
                selection-color: #ffffff;
            }
        """)

        # ğŸ”¥ P0ä¿®å¤ï¼šæ·»åŠ å¯¼å‡ºæŠ¥å‘ŠæŒ‰é’®
        export_btn_layout = QHBoxLayout()
        export_btn = QPushButton("ğŸ“„ å¯¼å‡ºå®Œæ•´æŠ¥å‘Š")
        export_btn.setStyleSheet("""
            QPushButton {
                background-color: #4a4a4a;
                color: #FFD700;
                border: 2px solid #FFD700;
                border-radius: 5px;
                padding: 8px 16px;
                font-size: 14px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #5a5a5a;
            }
            QPushButton:pressed {
                background-color: #3a3a3a;
            }
        """)
        export_btn.clicked.connect(self.export_full_report)
        export_btn_layout.addStretch()
        export_btn_layout.addWidget(export_btn)
        export_btn_layout.addStretch()
        result_layout.addLayout(export_btn_layout)

        result_layout.addWidget(self.bazi_result)
        layout.addWidget(result_group)
        return widget

    def load_api_config_silent(self):
        """é™é»˜åŠ è½½APIé…ç½®ï¼ˆä¸æ›´æ–°ç•Œé¢ï¼‰"""
        try:
            # ä»é…ç½®æ–‡ä»¶è¯»å–
            with open('deepseek_config.json', 'r', encoding='utf-8') as f:
                import json
                config = json.load(f)
                api_key = config.get('api_key', '')
                if api_key:
                    self.internal_api_key = api_key
        except:
            # é…ç½®æ–‡ä»¶ä¸å­˜åœ¨æˆ–è¯»å–å¤±è´¥ï¼Œä¿æŒé»˜è®¤å€¼
            pass

    # APIæµ‹è¯•æ–¹æ³•å·²ç§»é™¤ï¼Œç›´æ¥ä½¿ç”¨deepseek_config.jsonæ–‡ä»¶

    def get_deepseek_api_key(self):
        """è·å–DeepSeek APIå¯†é’¥ - æ”¯æŒæ–°æ—§é…ç½®æ–‡ä»¶æ ¼å¼"""
        # ä¼˜å…ˆä»è½¯ä»¶å†…éƒ¨é…ç½®è¯»å–
        if hasattr(self, 'internal_api_key') and self.internal_api_key:
            return self.internal_api_key

        # ä»é…ç½®æ–‡ä»¶è¯»å–
        try:
            with open('deepseek_config.json', 'r', encoding='utf-8') as f:
                import json
                config = json.load(f)

                # æ–°æ ¼å¼ï¼šå¤šAIé…ç½®
                if 'deepseek' in config:
                    api_key = config['deepseek'].get('api_key')
                # æ—§æ ¼å¼ï¼šå…¼å®¹æ€§æ”¯æŒ
                else:
                    api_key = config.get('api_key')

                if api_key:
                    # ç¼“å­˜åˆ°å†…éƒ¨å˜é‡
                    self.internal_api_key = api_key
                    return api_key
        except:
            pass

        # ä»ç¯å¢ƒå˜é‡è¯»å–ï¼ˆå¤‡ç”¨ï¼‰
        import os
        api_key = os.getenv('DEEPSEEK_API_KEY')
        if api_key:
            return api_key

        return None

    def get_ai_configs(self):
        """è·å–æ‰€æœ‰AIé…ç½®"""
        try:
            with open('deepseek_config.json', 'r', encoding='utf-8') as f:
                import json
                config = json.load(f)

                # æ–°æ ¼å¼ï¼šè¿”å›å®Œæ•´é…ç½®
                if 'deepseek' in config:
                    return config
                # æ—§æ ¼å¼ï¼šè½¬æ¢ä¸ºæ–°æ ¼å¼
                else:
                    return {
                        'deepseek': {
                            'api_key': config.get('api_key', ''),
                            'enabled': True,
                            'weight': 1.0
                        },
                        'wenxin': {'enabled': False, 'weight': 0.0},
                        'tongyi': {'enabled': False, 'weight': 0.0}
                    }
        except:
            # é»˜è®¤é…ç½®
            return {
                'deepseek': {'enabled': True, 'weight': 1.0, 'api_key': ''},
                'wenxin': {'enabled': False, 'weight': 0.0},
                'tongyi': {'enabled': False, 'weight': 0.0}
            }

    def test_wenxin_connection(self):
        """æµ‹è¯•æ–‡å¿ƒä¸€è¨€è¿æ¥"""
        print("ğŸ§ª æµ‹è¯•æ–‡å¿ƒä¸€è¨€APIè¿æ¥...")
        try:
            import requests
            import json

            # è¯»å–é…ç½®
            with open('deepseek_config.json', 'r', encoding='utf-8') as f:
                config = json.load(f)
            api_key = config['wenxin']['api_key']

            # ğŸ”¥ ä½¿ç”¨V2 APIï¼ˆOpenAIå…¼å®¹æ ¼å¼ï¼‰
            api_url = "https://qianfan.baidubce.com/v2/chat/completions"

            headers = {
                'Authorization': f'Bearer {api_key}',
                'Content-Type': 'application/json'
            }
            data = {
                "model": "ernie-4.0-8k",
                "messages": [{"role": "user", "content": "è¯·å›å¤'æ–‡å¿ƒä¸€è¨€æµ‹è¯•æˆåŠŸ'"}],
                "temperature": 0.3,
                "max_tokens": 50
            }

            response = requests.post(api_url, headers=headers, json=data, timeout=30)
            print(f"ğŸ“Š çŠ¶æ€ç : {response.status_code}")

            if response.status_code == 200:
                result = response.json()
                reply = result.get('result', '')
                print(f"âœ… æ–‡å¿ƒä¸€è¨€å›å¤: {reply}")
                return True
            else:
                print(f"âŒ è°ƒç”¨å¤±è´¥: {response.text}")
                return False

        except Exception as e:
            print(f"âŒ æµ‹è¯•å¼‚å¸¸: {e}")
            return False

    def test_deepseek_emergency(self):
        """ç´§æ€¥æµ‹è¯•DeepSeekè¿æ¥å’Œåˆ†æèƒ½åŠ›"""
        print("ğŸš¨ ç´§æ€¥æµ‹è¯•DeepSeek...")

        try:
            import time
            import requests

            # è¯»å–API Key
            api_key = self.get_deepseek_api_key()
            if not api_key:
                return "âŒ DeepSeek APIå¯†é’¥æœªé…ç½®"

            print(f"ğŸ” API Key: {api_key[:20]}...")

            # æµ‹è¯•1: ç®€å•è¿æ¥æµ‹è¯•
            print("ğŸ“¡ æµ‹è¯•1: ç®€å•è¿æ¥...")
            headers = {
                'Authorization': f'Bearer {api_key}',
                'Content-Type': 'application/json'
            }

            simple_data = {
                "model": "deepseek-chat",
                "messages": [{"role": "user", "content": "ä½ å¥½"}],
                "temperature": 0.3,
                "max_tokens": 10
            }

            start_time = time.time()
            response = requests.post(
                'https://api.deepseek.com/chat/completions',
                headers=headers,
                json=simple_data,
                timeout=15  # çŸ­è¶…æ—¶
            )
            end_time = time.time()

            print(f"â±ï¸ ç®€å•è¯·æ±‚å“åº”æ—¶é—´: {end_time - start_time:.2f}ç§’")
            print(f"ğŸ“Š å“åº”çŠ¶æ€: {response.status_code}")

            if response.status_code != 200:
                return f"âŒ DeepSeekè¿æ¥å¤±è´¥: {response.status_code}"

            # æµ‹è¯•2: å…«å­—åˆ†ææµ‹è¯•
            print("ğŸ“¡ æµ‹è¯•2: å…«å­—åˆ†æ...")
            bazi_data = {
                "model": "deepseek-chat",
                "messages": [
                    {"role": "system", "content": "ä½ æ˜¯ä¸€ä½ç²¾é€šä¸­å›½ä¼ ç»Ÿå‘½ç†å­¦çš„å¤§å¸ˆã€‚"},
                    {"role": "user", "content": "è¯·ç®€å•åˆ†æå…«å­—ï¼šåºšåˆ è¾›å·³ æˆŠåˆ æˆŠåˆï¼Œç”·æ€§ï¼Œ1990å¹´5æœˆ15æ—¥åˆæ—¶å‡ºç”Ÿã€‚"}
                ],
                "temperature": 0.01,
                "max_tokens": 1000
            }

            start_time = time.time()
            response = requests.post(
                'https://api.deepseek.com/chat/completions',
                headers=headers,
                json=bazi_data,
                timeout=60  # 60ç§’è¶…æ—¶
            )
            end_time = time.time()

            print(f"â±ï¸ å…«å­—åˆ†æå“åº”æ—¶é—´: {end_time - start_time:.2f}ç§’")
            print(f"ğŸ“Š å“åº”çŠ¶æ€: {response.status_code}")

            if response.status_code == 200:
                result = response.json()
                if 'choices' in result and len(result['choices']) > 0:
                    content = result['choices'][0]['message']['content']
                    print(f"âœ… DeepSeekå…«å­—åˆ†ææˆåŠŸ!")
                    print(f"ğŸ“ åˆ†æå†…å®¹é•¿åº¦: {len(content)}")
                    print(f"ğŸ“ å†…å®¹é¢„è§ˆ: {content[:200]}...")
                    return "âœ… DeepSeekè¿æ¥å’Œåˆ†æéƒ½æ­£å¸¸"
                else:
                    return f"âš ï¸ DeepSeekå“åº”æ ¼å¼å¼‚å¸¸: {result}"
            else:
                return f"âŒ DeepSeekå…«å­—åˆ†æå¤±è´¥: {response.status_code}"

        except requests.exceptions.Timeout as e:
            return f"â° DeepSeekè¿æ¥è¶…æ—¶: {str(e)}"
        except requests.exceptions.ConnectionError as e:
            return f"ğŸŒ DeepSeekè¿æ¥é”™è¯¯: {str(e)}"
        except Exception as e:
            return f"âŒ DeepSeekæµ‹è¯•å¼‚å¸¸: {str(e)}"

    def test_tongyi_connection(self):
        """æµ‹è¯•é€šä¹‰åƒé—®è¿æ¥ï¼ˆå¿«é€Ÿæµ‹è¯•ï¼‰"""
        try:
            config = self.load_ai_config().get('tongyi', {})
            if not config.get('enabled', False):
                return "é€šä¹‰åƒé—®æœªå¯ç”¨"

            # å¿«é€Ÿæµ‹è¯•ï¼Œä½¿ç”¨çŸ­è¶…æ—¶
            import requests
            import time
            api_key = config.get('api_key', '')

            headers = {
                'Authorization': f'Bearer {api_key}',
                'Content-Type': 'application/json',
                'X-DashScope-SSE': 'disable'
            }

            data = {
                "model": "qwen-max",
                "input": {
                    "messages": [{"role": "user", "content": "è¯·å›å¤'é€šä¹‰åƒé—®æµ‹è¯•æˆåŠŸ'"}]
                },
                "parameters": {
                    "temperature": 0.3,
                    "max_tokens": 50
                }
            }

            print("ğŸš€ å¼€å§‹æµ‹è¯•é€šä¹‰åƒé—®å“åº”æ—¶é—´...")
            start_time = time.time()

            response = requests.post(
                'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
                headers=headers,
                json=data,
                timeout=15  # å¿«é€Ÿæµ‹è¯•ï¼Œ15ç§’è¶…æ—¶
            )

            end_time = time.time()
            duration = end_time - start_time

            if response.status_code == 200:
                result = response.json()
                if 'output' in result and 'text' in result['output']:
                    reply = result['output']['text']
                    return f"âœ… é€šä¹‰åƒé—®è¿æ¥æˆåŠŸï¼Œè€—æ—¶: {duration:.2f}ç§’ï¼Œå›å¤: {reply[:50]}..."
                else:
                    return f"âš ï¸ é€šä¹‰åƒé—®å“åº”æ ¼å¼å¼‚å¸¸ï¼Œè€—æ—¶: {duration:.2f}ç§’: {result}"
            else:
                return f"âŒ é€šä¹‰åƒé—®HTTPé”™è¯¯ï¼Œè€—æ—¶: {duration:.2f}ç§’: {response.status_code}"

        except requests.exceptions.Timeout:
            return "â° é€šä¹‰åƒé—®è¿æ¥è¶…æ—¶ï¼ˆ15ç§’ï¼‰ - ç½‘ç»œå¯èƒ½è¾ƒæ…¢"
        except requests.exceptions.ConnectionError:
            return "ğŸŒ é€šä¹‰åƒé—®è¿æ¥é”™è¯¯ - æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨"
        except Exception as e:
            return f"âŒ é€šä¹‰åƒé—®è¿æ¥å¤±è´¥: {str(e)}"

    def test_tongyi_full_analysis(self):
        """æµ‹è¯•é€šä¹‰åƒé—®å®Œæ•´å…«å­—åˆ†æçš„å“åº”æ—¶é—´"""
        try:
            config = self.load_ai_config().get('tongyi', {})
            if not config.get('enabled', False):
                return "é€šä¹‰åƒé—®æœªå¯ç”¨"

            print("ğŸ§ª å¼€å§‹æµ‹è¯•é€šä¹‰åƒé—®å®Œæ•´åˆ†æå“åº”æ—¶é—´...")

            # ä½¿ç”¨ç®€åŒ–çš„å…«å­—åˆ†ææç¤ºè¯
            test_prompt = """è¯·åˆ†æä»¥ä¸‹å…«å­—ï¼š
æ€§åˆ«ï¼šç”·
å››æŸ±ï¼šæˆŠåˆ å£¬æˆŒ è¾›æœª å·±ä¸‘
è¯·ç®€è¦åˆ†ææ—¥ä¸»å¼ºå¼±ã€ç”¨ç¥å¿Œç¥ã€äº‹ä¸šè´¢è¿ã€‚é™åˆ¶åœ¨200å­—ä»¥å†…ã€‚"""

            import time
            start_time = time.time()

            # è°ƒç”¨å®Œæ•´çš„é€šä¹‰åƒé—®API
            result = self.call_tongyi_api(test_prompt, config)

            end_time = time.time()
            duration = end_time - start_time

            if result and len(result) > 50:
                return f"âœ… é€šä¹‰åƒé—®å®Œæ•´åˆ†ææˆåŠŸï¼Œè€—æ—¶: {duration:.2f}ç§’ï¼Œç»“æœé•¿åº¦: {len(result)}å­—ç¬¦"
            else:
                return f"âš ï¸ é€šä¹‰åƒé—®å®Œæ•´åˆ†æå¼‚å¸¸ï¼Œè€—æ—¶: {duration:.2f}ç§’ï¼Œç»“æœ: {result[:100]}..."

        except Exception as e:
            return f"âŒ é€šä¹‰åƒé—®å®Œæ•´åˆ†ææµ‹è¯•å¤±è´¥: {str(e)}"

    def call_wenxin_api(self, prompt, config, sys_prompt=None):
        """è°ƒç”¨åƒå¸†å¹³å°æ–‡å¿ƒä¸€è¨€APIï¼ˆä½¿ç”¨ä¹‹å‰æˆåŠŸçš„æ–¹å¼ï¼‰"""
        import requests
        import json

        api_key = config.get('api_key', '')
        if not api_key:
            raise Exception("åƒå¸†å¹³å°APIå¯†é’¥æœªé…ç½®")

        # ğŸ”¥ æ ¹æ®æµ‹è¯•æ–‡ä»¶ï¼Œä½¿ç”¨V2 APIï¼ˆOpenAIå…¼å®¹æ ¼å¼ï¼‰
        api_url = "https://qianfan.baidubce.com/v2/chat/completions"

        headers = {
            'Authorization': f'Bearer {api_key}',
            'Content-Type': 'application/json'
        }

        # ğŸ”¥ ä½¿ç”¨V2 APIï¼ˆOpenAIå…¼å®¹æ ¼å¼ï¼‰- æ ¹æ®æµ‹è¯•æ–‡ä»¶ä¿®å¤
        messages = []
        if sys_prompt:
            messages.append({"role": "system", "content": sys_prompt})
        messages.append({"role": "user", "content": prompt})

        data = {
            "model": "ernie-4.0-8k",  # ä½¿ç”¨æˆåŠŸç‡100%çš„æ¨¡å‹
            "messages": messages,
            "temperature": 0.01,  # ä¸DeepSeekä¿æŒä¸€è‡´
            "max_tokens": 2048  # ä¿®å¤ï¼šæ–‡å¿ƒä¸€è¨€æœ€å¤§æ”¯æŒ2048
        }

        print(f"ğŸ”§ ä½¿ç”¨åƒå¸†å¹³å°V2 API (ERNIE-4.0-8Kæ¨¡å‹)")
        print(f"ğŸ“ ç³»ç»Ÿæç¤ºè¯é•¿åº¦: {len(sys_prompt) if sys_prompt else 0}")
        print(f"ğŸ“ ç”¨æˆ·æç¤ºè¯é•¿åº¦: {len(prompt)}")
        print(f"ğŸ“¡ API URL: {api_url}")

        print(f"ğŸ” åƒå¸†å¹³å°Bearer Tokenè®¤è¯")
        print(f"ğŸ“Š è¯·æ±‚æ•°æ®: {json.dumps(data, ensure_ascii=False)}")

        # å‘é€è¯·æ±‚ï¼ˆç¦ç”¨ä»£ç†é¿å…è¿æ¥é—®é¢˜ï¼‰
        proxies = {'http': None, 'https': None}
        response = requests.post(api_url, headers=headers, json=data, timeout=150, proxies=proxies)  # æ¢å¤åŸå§‹è¶…æ—¶æ—¶é—´150ç§’

        print(f"ğŸ“Š åƒå¸†å¹³å°å“åº”çŠ¶æ€: {response.status_code}")
        print(f"ğŸ“‹ åƒå¸†å¹³å°å“åº”å†…å®¹: {response.text[:500]}...")

        if response.status_code == 200:
            result = response.json()


            # æ£€æŸ¥å¤šç§å¯èƒ½çš„è¿”å›æ ¼å¼ï¼ˆV2 APIå…¼å®¹OpenAIæ ¼å¼ï¼‰
            if 'choices' in result and len(result['choices']) > 0:
                # OpenAIå…¼å®¹æ ¼å¼
                choice = result['choices'][0]
                if 'message' in choice and 'content' in choice['message']:
                    content = choice['message']['content']

                    return content
                elif 'text' in choice:
                    content = choice['text']

                    return content
            elif 'result' in result and result['result']:
                # ä¼ ç»Ÿæ ¼å¼
                content = result['result']

                return content
            elif 'data' in result:
                content = str(result['data'])

                return content
            else:
                raise Exception(f"åƒå¸†å¹³å°è¿”å›æ ¼å¼ä¸è¯†åˆ«: {result}")
        else:
            error_info = ""
            try:
                error_data = response.json()
                error_info = error_data.get('error_msg', error_data.get('error', {}).get('message', response.text))
            except:
                error_info = response.text
            raise Exception(f"åƒå¸†å¹³å°APIè°ƒç”¨å¤±è´¥: {response.status_code} - {error_info}")

    def call_tongyi_api(self, prompt, config, sys_prompt=None):
        """è°ƒç”¨é€šä¹‰åƒé—®APIï¼ˆå¼ºåŒ–ç½‘ç»œè¿æ¥ï¼‰"""
        import requests
        import time

        api_key = config.get('api_key', '')
        if not api_key:
            raise Exception("é€šä¹‰åƒé—®APIå¯†é’¥æœªé…ç½®")

        # ğŸ”¥ ä¼˜åŒ–ç½‘ç»œè¿æ¥é…ç½®
        session = requests.Session()

        # é…ç½®è¿æ¥æ± å’Œé‡è¯•ï¼ˆæ›´ä¿å®ˆçš„è®¾ç½®ï¼‰
        from requests.adapters import HTTPAdapter
        from urllib3.util.retry import Retry

        retry_strategy = Retry(
            total=2,  # å‡å°‘è‡ªåŠ¨é‡è¯•æ¬¡æ•°ï¼Œæˆ‘ä»¬æ‰‹åŠ¨æ§åˆ¶é‡è¯•
            backoff_factor=0.5,
            status_forcelist=[429, 500, 502, 503, 504],
            connect=2,  # è¿æ¥é‡è¯•æ¬¡æ•°
            read=2,     # è¯»å–é‡è¯•æ¬¡æ•°
        )
        adapter = HTTPAdapter(
            max_retries=retry_strategy,
            pool_connections=10,
            pool_maxsize=10
        )
        session.mount("https://", adapter)

        session.headers.update({
            'Authorization': f'Bearer {api_key}',
            'Content-Type': 'application/json',
            'X-DashScope-SSE': 'disable',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'Connection': 'keep-alive',
            'Accept': 'application/json'
        })

        # æ„å»ºæ¶ˆæ¯åˆ—è¡¨
        messages = []
        if sys_prompt:
            messages.append({"role": "system", "content": sys_prompt})
        else:
            messages.append({"role": "system", "content": "ä½ æ˜¯ä¸€ä½ç²¾é€šä¸­å›½ä¼ ç»Ÿå‘½ç†å­¦çš„å¤§å¸ˆï¼Œæ“…é•¿è¿ç”¨é€»è¾‘æ¨ç†åˆ†æå…«å­—å‘½ç†ã€‚"})
        messages.append({"role": "user", "content": prompt})

        data = {
            "model": "qwen-max",
            "input": {
                "messages": messages
            },
            "parameters": {
                "temperature": 0.01,  # ä¸DeepSeekä¿æŒä¸€è‡´
                "max_tokens": 8000,   # ä¸DeepSeekä¿æŒä¸€è‡´ï¼Œç¡®ä¿å®Œæ•´è¿”å›
                "top_p": 0.9,         # ä¼˜åŒ–å‚æ•°
                "repetition_penalty": 1.0  # å‡å°‘é‡å¤æƒ©ç½š
            }
        }

        # ğŸ”¥ è®¾ç½®é€šä¹‰åƒé—®è¶…æ—¶ä¸º200ç§’ï¼Œè¶…æ—¶ç›´æ¥è·³è¿‡
        max_retries = 1  # åªå°è¯•1æ¬¡ï¼Œé¿å…æµªè´¹æ—¶é—´
        timeout_list = [200]  # 200ç§’è¶…æ—¶ï¼Œè¶…æ—¶ç›´æ¥è·³è¿‡

        for attempt in range(max_retries):
            try:
                timeout = timeout_list[attempt] if attempt < len(timeout_list) else 200  # é»˜è®¤ä¹Ÿæ˜¯200ç§’
                print(f"ğŸ”„ é€šä¹‰åƒé—®ç¬¬{attempt + 1}æ¬¡å°è¯• (è¶…æ—¶:{timeout}ç§’)...")

                # ç¦ç”¨ä»£ç†é¿å…è¿æ¥é—®é¢˜
                session.proxies.update({'http': None, 'https': None})
                response = session.post(
                    'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
                    json=data,
                    timeout=timeout  # æ¢å¤åŸå§‹è¶…æ—¶æ—¶é—´
                )

                print(f"ğŸ“Š é€šä¹‰åƒé—®å“åº”çŠ¶æ€: {response.status_code}")
                print(f"ğŸ“‹ é€šä¹‰åƒé—®å“åº”å†…å®¹: {response.text[:200]}...")

                if response.status_code == 200:
                    result = response.json()


                    if 'output' in result and 'text' in result['output']:
                        content = result['output']['text']
                        return content
                    elif 'choices' in result and len(result['choices']) > 0:
                        content = result['choices'][0].get('message', {}).get('content', '')
                        if content:

                            return content
                    else:
                        raise Exception(f"é€šä¹‰åƒé—®è¿”å›æ ¼å¼ä¸è¯†åˆ«: {result}")
                else:
                    error_info = ""
                    try:
                        error_data = response.json()
                        error_info = error_data.get('message', error_data.get('error', {}).get('message', response.text))
                    except:
                        error_info = response.text
                    raise Exception(f"HTTP {response.status_code} - {error_info}")

            except requests.exceptions.Timeout:
                print(f"â° é€šä¹‰åƒé—®ç¬¬{attempt + 1}æ¬¡è¶…æ—¶ ({timeout}ç§’)")
                if attempt < max_retries - 1:
                    wait_time = 2 + attempt
                    print(f"â³ ç­‰å¾…{wait_time}ç§’åé‡è¯•...")
                    time.sleep(wait_time)
                    continue
                else:
                    # ğŸ”¥ 200ç§’è¶…æ—¶ç›´æ¥è·³è¿‡ï¼Œä¸æŠ›å‡ºå¼‚å¸¸
                    print(f"â° é€šä¹‰åƒé—®200ç§’è¶…æ—¶ï¼Œç›´æ¥è·³è¿‡")
                    return "â° é€šä¹‰åƒé—®å“åº”è¶…æ—¶ï¼Œå·²è·³è¿‡æ­¤AIåˆ†æ"

            except requests.exceptions.ConnectionError as e:
                print(f"ğŸŒ é€šä¹‰åƒé—®ç¬¬{attempt + 1}æ¬¡è¿æ¥é”™è¯¯: {e}")
                if attempt < max_retries - 1:
                    time.sleep(3)
                    continue
                else:
                    # ğŸ”¥ è¿æ¥å¤±è´¥ä¹Ÿç›´æ¥è·³è¿‡ï¼Œä¸æŠ›å‡ºå¼‚å¸¸
                    print(f"ğŸŒ é€šä¹‰åƒé—®ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œç›´æ¥è·³è¿‡")
                    return "ğŸŒ é€šä¹‰åƒé—®ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œå·²è·³è¿‡æ­¤AIåˆ†æ"

            except Exception as e:
                print(f"âŒ é€šä¹‰åƒé—®ç¬¬{attempt + 1}æ¬¡è°ƒç”¨å¼‚å¸¸: {e}")
                if attempt < max_retries - 1:
                    time.sleep(2)
                    continue
                else:
                    # ğŸ”¥ å…¶ä»–å¼‚å¸¸ä¹Ÿç›´æ¥è·³è¿‡ï¼Œä¸æŠ›å‡ºå¼‚å¸¸
                    print(f"âŒ é€šä¹‰åƒé—®è°ƒç”¨å¤±è´¥ï¼Œç›´æ¥è·³è¿‡")
                    return f"âŒ é€šä¹‰åƒé—®è°ƒç”¨å¤±è´¥: {str(e)}"


    def save_person_info(self):
        """ä¿å­˜å‘½ä¸»ä¿¡æ¯"""
        try:
            import json
            import os
            # è·å–å½“å‰è¾“å…¥çš„ä¿¡æ¯
            person_info = {
                'name': self.name_edit.text(),
                'year': self.birth_year.value(),
                'month': self.birth_month.currentIndex(),
                'day': self.birth_day.currentIndex(),
                'hour': self.hour_combo.currentIndex(),
                'gender': self.gender_combo.currentText(),
                'leap_month': self.leap_month.isChecked(),
                'province': self.birth_province.currentText(),
                'city': self.birth_city.currentText() if hasattr(self, 'birth_city') else '',
                'precise_hour': self.precise_hour.value() if hasattr(self, 'precise_hour') else None,
                'precise_minute': self.precise_minute.value() if hasattr(self, 'precise_minute') else None
            }
            # æ£€æŸ¥ä¿¡æ¯æ˜¯å¦å®Œæ•´
            if not person_info['name']:
                QMessageBox.warning(self, "ä¿å­˜å¤±è´¥", "è¯·å…ˆè¾“å…¥å§“åï¼")
                return

            # ğŸ”§ æ–°å¢ï¼šä¿å­˜å®Œæ•´çš„åˆ†æç»“æœ
            if hasattr(self, 'current_sxtwl_result') and self.current_sxtwl_result:
                person_info['sxtwl_result'] = self.current_sxtwl_result
                person_info['analysis_timestamp'] = datetime.now().isoformat()

                # æ·»åŠ äº”è¡Œåˆ†ææ‘˜è¦
                if 'wuxing_distribution' in self.current_sxtwl_result:
                    wuxing_dist = self.current_sxtwl_result['wuxing_distribution']
                    total_wuxing = sum(wuxing_dist.values()) if wuxing_dist else 1
                    wuxing_summary = {}
                    for element, count in wuxing_dist.items():
                        percentage = (count / total_wuxing * 100) if total_wuxing > 0 else 0
                        wuxing_summary[element] = {
                            'count': count,
                            'percentage': round(percentage, 1),
                            'strength': 'åæ—º' if percentage >= 30 else 'åå¼±' if percentage <= 10 else 'é€‚ä¸­'
                        }
                    person_info['wuxing_summary'] = wuxing_summary

                    # æ·»åŠ äº”è¡Œç¼ºå¤±å’Œè¡¥æ•‘å»ºè®®
                    missing = [k for k, v in wuxing_dist.items() if v == 0]
                    if missing:
                        person_info['missing_elements'] = missing
                        person_info['remedy_suggestions'] = {}
                        for element in missing:
                            person_info['remedy_suggestions'][element] = self.get_wuxing_remedy(element)

            # åˆ›å»ºä¿å­˜ç›®å½•
            save_dir = "saved_persons"
            if not os.path.exists(save_dir):
                os.makedirs(save_dir)
            # ä¿å­˜æ–‡ä»¶
            filename = f"{save_dir}/{person_info['name']}.json"
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(person_info, f, ensure_ascii=False, indent=2)
            QMessageBox.information(self, "ä¿å­˜æˆåŠŸ", f"å‘½ä¸»ä¿¡æ¯å·²ä¿å­˜ï¼š{person_info['name']}\nåŒ…å«å®Œæ•´çš„äº”è¡Œåˆ†æç»“æœ")
        except Exception as e:
            QMessageBox.critical(self, "ä¿å­˜å¤±è´¥", f"ä¿å­˜è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š{str(e)}")
    def load_person_info(self):
        """åŠ è½½å‘½ä¸»ä¿¡æ¯"""
        try:
            import json
            import os
            from PyQt5.QtWidgets import QInputDialog
            # æ£€æŸ¥ä¿å­˜ç›®å½•
            save_dir = "saved_persons"
            if not os.path.exists(save_dir):
                QMessageBox.information(self, "æç¤º", "æš‚æ— ä¿å­˜çš„å‘½ä¸»ä¿¡æ¯")
                return
            # è·å–æ‰€æœ‰ä¿å­˜çš„æ–‡ä»¶
            files = [f for f in os.listdir(save_dir) if f.endswith('.json')]
            if not files:
                QMessageBox.information(self, "æç¤º", "æš‚æ— ä¿å­˜çš„å‘½ä¸»ä¿¡æ¯")
                return
            # è®©ç”¨æˆ·é€‰æ‹©è¦åŠ è½½çš„æ–‡ä»¶
            names = [f.replace('.json', '') for f in files]
            name, ok = QInputDialog.getItem(self, "é€‰æ‹©å‘½ä¸»", "è¯·é€‰æ‹©è¦åŠ è½½çš„å‘½ä¸»ä¿¡æ¯ï¼š", names, 0, False)
            if ok and name:
                filename = f"{save_dir}/{name}.json"
                with open(filename, 'r', encoding='utf-8') as f:
                    person_info = json.load(f)
                # å¡«å……ç•Œé¢
                self.name_edit.setText(person_info.get('name', ''))
                self.birth_year.setValue(person_info.get('year', 1990))
                self.birth_month.setCurrentIndex(person_info.get('month', 0))
                self.birth_day.setCurrentIndex(person_info.get('day', 0))
                self.hour_combo.setCurrentIndex(person_info.get('hour', 0))
                self.gender_combo.setCurrentText(person_info.get('gender', 'ç”·'))
                self.leap_month.setChecked(person_info.get('leap_month', False))
                province_value = person_info.get('province', 'åŒ—äº¬å¸‚')
                self.birth_province.setCurrentText(province_value)
                try:
                    self.on_province_changed(province_value)
                except Exception:
                    pass
                city_value = person_info.get('city', '')
                if hasattr(self, 'birth_city') and city_value:
                    index = self.birth_city.findText(city_value)
                    if index >= 0:
                        self.birth_city.setCurrentIndex(index)
                if hasattr(self, 'precise_hour') and person_info.get('precise_hour') is not None:
                    self.precise_hour.setValue(int(person_info.get('precise_hour', 0)))
                if hasattr(self, 'precise_minute') and person_info.get('precise_minute') is not None:
                    self.precise_minute.setValue(int(person_info.get('precise_minute', 0)))
                QMessageBox.information(self, "åŠ è½½æˆåŠŸ", f"å·²åŠ è½½å‘½ä¸»ä¿¡æ¯ï¼š{name}")
        except Exception as e:
            QMessageBox.critical(self, "åŠ è½½å¤±è´¥", f"åŠ è½½è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š{str(e)}")
    def delete_person_info(self):
        """åˆ é™¤å‘½ä¸»ä¿¡æ¯"""
        try:
            import json
            import os
            from PyQt5.QtWidgets import QInputDialog, QMessageBox
            # æ£€æŸ¥ä¿å­˜ç›®å½•
            save_dir = "saved_persons"
            if not os.path.exists(save_dir):
                QMessageBox.information(self, "æç¤º", "æš‚æ— ä¿å­˜çš„å‘½ä¸»ä¿¡æ¯")
                return
            # è·å–æ‰€æœ‰ä¿å­˜çš„æ–‡ä»¶
            files = [f for f in os.listdir(save_dir) if f.endswith('.json')]
            if not files:
                QMessageBox.information(self, "æç¤º", "æš‚æ— ä¿å­˜çš„å‘½ä¸»ä¿¡æ¯")
                return
            # è®©ç”¨æˆ·é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶
            names = [f.replace('.json', '') for f in files]
            name, ok = QInputDialog.getItem(self, "é€‰æ‹©å‘½ä¸»", "è¯·é€‰æ‹©è¦åˆ é™¤çš„å‘½ä¸»ä¿¡æ¯ï¼š", names, 0, False)
            if ok and name:
                # ç¡®è®¤åˆ é™¤
                reply = QMessageBox.question(self, "ç¡®è®¤åˆ é™¤", f"ç¡®å®šè¦åˆ é™¤å‘½ä¸»ä¿¡æ¯ï¼š{name}ï¼Ÿ",
                                           QMessageBox.Yes | QMessageBox.No, QMessageBox.No)
                if reply == QMessageBox.Yes:
                    filename = f"{save_dir}/{name}.json"
                    os.remove(filename)
                    QMessageBox.information(self, "åˆ é™¤æˆåŠŸ", f"å·²åˆ é™¤å‘½ä¸»ä¿¡æ¯ï¼š{name}")
        except Exception as e:
            QMessageBox.critical(self, "åˆ é™¤å¤±è´¥", f"åˆ é™¤è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š{str(e)}")
    def create_naming_tab(self):
        """åˆ›å»ºèµ·ååˆ†æé€‰é¡¹å¡"""
        widget = QWidget()
        layout = QHBoxLayout(widget)
        # å·¦ä¾§è¾“å…¥åŒºåŸŸ
        input_group = QGroupBox("ä¸“ä¸šèµ·åä¿¡æ¯")
        input_layout = QVBoxLayout(input_group)

        # æç¤ºä¿¡æ¯
        tip_label = QLabel("ğŸ’¡ ä¸“ä¸šèµ·åéœ€è¦å‡†ç¡®çš„ç”Ÿè¾°å…«å­—å’Œå‡ºç”Ÿåœ°ä¿¡æ¯")
        tip_label.setStyleSheet("color: #FF6B35; font-weight: bold; padding: 5px;")
        input_layout.addWidget(tip_label)

        # å§“æ°è¾“å…¥
        surname_layout = QHBoxLayout()
        surname_layout.addWidget(QLabel("å§“æ°*:"))
        self.naming_surname_edit = QLineEdit()
        self.naming_surname_edit.setPlaceholderText("è¯·è¾“å…¥å§“æ°ï¼Œå¦‚ï¼šå¼ ")
        surname_layout.addWidget(self.naming_surname_edit)
        input_layout.addLayout(surname_layout)

        # æ€§åˆ«é€‰æ‹©
        naming_gender_layout = QHBoxLayout()
        naming_gender_layout.addWidget(QLabel("æ€§åˆ«*:"))
        self.naming_gender_combo = QComboBox()
        self.naming_gender_combo.addItems(["ç”·", "å¥³"])
        naming_gender_layout.addWidget(self.naming_gender_combo)
        input_layout.addLayout(naming_gender_layout)

        # ç”Ÿè¾°ä¿¡æ¯åŒºåŸŸ
        birth_group = QGroupBox("ç”Ÿè¾°å…«å­—ä¿¡æ¯")
        birth_layout = QVBoxLayout(birth_group)

        # å‡ºç”Ÿå¹´æœˆæ—¥
        date_layout = QHBoxLayout()
        date_layout.addWidget(QLabel("å‡ºç”Ÿæ—¥æœŸ*:"))
        self.naming_birth_year = QSpinBox()
        self.naming_birth_year.setRange(1900, 2030)
        self.naming_birth_year.setValue(2000)
        date_layout.addWidget(self.naming_birth_year)
        date_layout.addWidget(QLabel("å¹´"))

        self.naming_birth_month = QComboBox()
        self.naming_birth_month.addItems([f"{i}æœˆ" for i in range(1, 13)])
        date_layout.addWidget(self.naming_birth_month)

        self.naming_birth_day = QComboBox()
        self.naming_birth_day.addItems([f"{i}æ—¥" for i in range(1, 32)])
        date_layout.addWidget(self.naming_birth_day)
        birth_layout.addLayout(date_layout)

        # å‡ºç”Ÿæ—¶è¾°
        time_layout = QHBoxLayout()
        time_layout.addWidget(QLabel("å‡ºç”Ÿæ—¶è¾°*:"))
        self.naming_hour_combo = QComboBox()
        self.naming_hour_combo.addItems(self.shichen_list)
        time_layout.addWidget(self.naming_hour_combo)
        birth_layout.addLayout(time_layout)

        # å‡ºç”Ÿåœ°ä¿¡æ¯
        location_layout = QHBoxLayout()
        location_layout.addWidget(QLabel("å‡ºç”Ÿåœ°*:"))
        self.naming_province = QComboBox()
        self.naming_province.addItems(["åŒ—äº¬å¸‚", "ä¸Šæµ·å¸‚", "å¤©æ´¥å¸‚", "é‡åº†å¸‚", "å¹¿ä¸œçœ", "æ±Ÿè‹çœ", "æµ™æ±Ÿçœ", "å±±ä¸œçœ", "æ²³å—çœ", "å››å·çœ", "æ¹–åŒ—çœ", "æ¹–å—çœ", "æ²³åŒ—çœ", "ç¦å»ºçœ", "å®‰å¾½çœ", "æ±Ÿè¥¿çœ", "äº‘å—çœ", "å¹¿è¥¿çœ", "å±±è¥¿çœ", "å‰æ—çœ", "é»‘é¾™æ±Ÿçœ", "è¾½å®çœ", "é™•è¥¿çœ", "ç”˜è‚ƒçœ", "é’æµ·çœ", "è´µå·çœ", "æµ·å—çœ", "å®å¤çœ", "æ–°ç–†çœ", "è¥¿è—çœ", "å†…è’™å¤çœ"])
        location_layout.addWidget(self.naming_province)

        self.naming_city = QComboBox()
        self.naming_city.addItem("è¯·é€‰æ‹©åŸå¸‚")
        location_layout.addWidget(self.naming_city)
        birth_layout.addLayout(location_layout)

        # è¿æ¥çœä»½å˜åŒ–äº‹ä»¶
        self.naming_province.currentTextChanged.connect(self.on_naming_province_changed)

        input_layout.addWidget(birth_group)

        # èµ·åé€‰é¡¹
        options_group = QGroupBox("èµ·åé€‰é¡¹")
        options_layout = QVBoxLayout(options_group)

        # åå­—å­—æ•°é€‰æ‹©
        name_length_layout = QHBoxLayout()
        name_length_layout.addWidget(QLabel("åå­—å­—æ•°:"))
        self.name_length_combo = QComboBox()
        self.name_length_combo.addItems(["å•å­—å(1å­—)", "åŒå­—å(2å­—)", "ä¸‰å­—å(3å­—)", "å…¨éƒ¨æ¨è"])
        self.name_length_combo.setCurrentText("åŒå­—å(2å­—)")
        name_length_layout.addWidget(self.name_length_combo)
        options_layout.addLayout(name_length_layout)

        # èµ·åé£æ ¼ - å¢å¼ºç‰ˆ
        style_layout = QHBoxLayout()
        style_layout.addWidget(QLabel("èµ·åé£æ ¼:"))
        self.naming_style_combo = QComboBox()
        self.naming_style_combo.addItems([
            "å‘¨æ˜“ç»å…¸", "è¯—ç»é›…éŸµ", "æ¥šè¾è±ªæ”¾", "è®ºè¯­æ™ºæ…§",
            "å”è¯—å®‹è¯", "å¤å…¸åè‘—", "ç°ä»£æ—¶å°š", "å¯“æ„å‰ç¥¥",
            "äº”è¡Œå¹³è¡¡", "ç”Ÿè‚–å–œå¿Œ", "éŸ³éŸµå’Œè°", "ä¹¦é¦™é—¨ç¬¬"
        ])
        style_layout.addWidget(self.naming_style_combo)
        options_layout.addLayout(style_layout)

        # æ¨èæ•°é‡
        count_layout = QHBoxLayout()
        count_layout.addWidget(QLabel("æ¨èæ•°é‡:"))
        self.name_count_spin = QSpinBox()
        self.name_count_spin.setRange(5, 50)
        self.name_count_spin.setValue(10)
        count_layout.addWidget(self.name_count_spin)
        options_layout.addLayout(count_layout)

        input_layout.addWidget(options_group)

        # åŠŸèƒ½æŒ‰é’®åŒºåŸŸ
        button_layout = QHBoxLayout()

        # è®¡ç®—å…«å­—æŒ‰é’®
        calc_bazi_btn = QPushButton("ğŸ“Š è®¡ç®—å…«å­—")
        calc_bazi_btn.clicked.connect(self.calculate_naming_bazi)
        calc_bazi_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2196F3, stop:1 #1976D2);
                border: 2px solid #2196F3;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                padding: 10px;
                font-size: 14px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #1976D2, stop:1 #2196F3);
                border-color: #1976D2;
            }
        """)
        button_layout.addWidget(calc_bazi_btn)

        # ä¸“ä¸šèµ·åæŒ‰é’®
        professional_naming_btn = QPushButton("ğŸ¯ ä¸“ä¸šèµ·å")
        professional_naming_btn.clicked.connect(self.professional_naming_clicked)
        professional_naming_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4CAF50, stop:1 #45a049);
                border: 2px solid #4CAF50;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                padding: 10px;
                font-size: 14px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #45a049, stop:1 #4CAF50);
                border-color: #45a049;
            }
        """)
        button_layout.addWidget(professional_naming_btn)

        # å§“ååˆ†ææŒ‰é’®
        analyze_existing_btn = QPushButton("ğŸ” åˆ†æç°æœ‰å§“å")
        analyze_existing_btn.clicked.connect(self.analyze_existing_name)
        analyze_existing_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #FF9800, stop:1 #F57C00);
                border: 2px solid #FF9800;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                padding: 10px;
                font-size: 14px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #F57C00, stop:1 #FF9800);
                border-color: #F57C00;
            }
        """)
        button_layout.addWidget(analyze_existing_btn)

        # é‡åæ£€æŸ¥æŒ‰é’®
        duplicate_check_btn = QPushButton("ğŸ” é‡åæ£€æŸ¥")
        duplicate_check_btn.clicked.connect(self.check_name_duplicates)
        duplicate_check_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #E91E63, stop:1 #C2185B);
                border: 2px solid #E91E63;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                padding: 10px;
                font-size: 14px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #C2185B, stop:1 #E91E63);
                border-color: #C2185B;
            }
        """)
        button_layout.addWidget(duplicate_check_btn)

        input_layout.addLayout(button_layout)
        input_layout.addStretch()
        layout.addWidget(input_group)

        # å³ä¾§ç»“æœæ˜¾ç¤ºåŒºåŸŸ
        result_group = QGroupBox("ä¸“ä¸šèµ·åç»“æœ")
        result_layout = QVBoxLayout(result_group)

        # å…«å­—ä¿¡æ¯æ˜¾ç¤º
        self.naming_bazi_info = QTextEdit()
        self.naming_bazi_info.setReadOnly(True)
        self.naming_bazi_info.setMaximumHeight(120)
        self.naming_bazi_info.setPlaceholderText("å…«å­—ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º...")
        # è®¾ç½®å­—ä½“
        font = self.naming_bazi_info.font()
        font.setPointSize(20)  # å¢å¤§å­—ä½“åˆ°20ptï¼Œæé«˜å¯è¯»æ€§
        font.setFamily("Microsoft YaHei")
        self.naming_bazi_info.setFont(font)
        result_layout.addWidget(QLabel("å…«å­—ä¿¡æ¯:"))
        result_layout.addWidget(self.naming_bazi_info)

        # èµ·åç»“æœæ˜¾ç¤º
        self.naming_result = QTextEdit()
        self.naming_result.setReadOnly(True)
        self.naming_result.setPlaceholderText("è¯·å…ˆè®¡ç®—å…«å­—ï¼Œç„¶åç‚¹å‡»\"ä¸“ä¸šèµ·å\"æŸ¥çœ‹æ¨èåå­—...")
        # è®¾ç½®å­—ä½“
        font = self.naming_result.font()
        font.setPointSize(20)  # å¢å¤§å­—ä½“åˆ°20ptï¼Œæé«˜å¯è¯»æ€§
        font.setFamily("Microsoft YaHei")
        self.naming_result.setFont(font)
        result_layout.addWidget(QLabel("èµ·åç»“æœ:"))
        result_layout.addWidget(self.naming_result)

        layout.addWidget(result_group)
        return widget

    def on_naming_province_changed(self, province_name):
        """èµ·åç•Œé¢çœä»½é€‰æ‹©æ”¹å˜æ—¶æ›´æ–°åŸå¸‚åˆ—è¡¨ - ä¿®å¤ç‰ˆ"""
        self.naming_city.clear()

        if province_name in self.city_database:
            cities = self.city_database[province_name]["cities"]
            if cities:
                self.naming_city.addItem("è¯·é€‰æ‹©åŸå¸‚")
                self.naming_city.addItems(sorted(cities))
            else:
                # å¦‚æœçœä»½æ²¡æœ‰åŸå¸‚æ•°æ®ï¼Œä½¿ç”¨çœä»½åä½œä¸ºåŸå¸‚
                self.naming_city.addItem(province_name.replace("çœ", "").replace("å¸‚", ""))
        else:
            # å¦‚æœçœä»½ä¸åœ¨æ•°æ®åº“ä¸­ï¼Œä½¿ç”¨çœä»½åä½œä¸ºåŸå¸‚
            city_name = province_name.replace("çœ", "").replace("å¸‚", "").replace("è‡ªæ²»åŒº", "").replace("ç‰¹åˆ«è¡Œæ”¿åŒº", "")
            self.naming_city.addItem(city_name)

    def calculate_naming_bazi(self):
        """è®¡ç®—èµ·åç”¨çš„å…«å­— - ä¿®å¤ç‰ˆï¼Œé¿å…å¡æ­»"""
        try:
            print("ğŸ”§ å¼€å§‹èµ·åå…«å­—è®¡ç®—...")

            # è·å–è¾“å…¥ä¿¡æ¯
            surname = self.naming_surname_edit.text().strip()
            gender = self.naming_gender_combo.currentText()
            year = self.naming_birth_year.value()
            month = self.naming_birth_month.currentIndex() + 1
            day = self.naming_birth_day.currentIndex() + 1
            hour_text = self.naming_hour_combo.currentText()
            province = self.naming_province.currentText()
            city = self.naming_city.currentText()

            print(f"ğŸ“ èµ·åä¿¡æ¯: {surname} {gender} {year}-{month}-{day} {hour_text} {province} {city}")

            # éªŒè¯è¾“å…¥
            if not surname:
                QMessageBox.warning(self, "è¾“å…¥é”™è¯¯", "è¯·è¾“å…¥å§“æ°ï¼")
                return

            # ä¿®å¤ï¼šå¦‚æœåŸå¸‚ä¸ºç©ºæˆ–è€…æ˜¯"è¯·é€‰æ‹©åŸå¸‚"ï¼Œä½¿ç”¨çœä»½å
            if not city or city == "è¯·é€‰æ‹©åŸå¸‚" or city.strip() == "":
                city = province.replace("çœ", "").replace("å¸‚", "").replace("è‡ªæ²»åŒº", "").replace("ç‰¹åˆ«è¡Œæ”¿åŒº", "")
                print(f"ğŸ”§ åŸå¸‚ä¸ºç©ºï¼Œä½¿ç”¨çœä»½åä½œä¸ºåŸå¸‚: {city}")

            if not city:
                QMessageBox.warning(self, "è¾“å…¥é”™è¯¯", "æ— æ³•ç¡®å®šå‡ºç”Ÿåœ°ä¿¡æ¯ï¼")
                return

            # è§£ææ—¶è¾°
            hour_index = self.shichen_list.index(hour_text)

            # ğŸ”¥ ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨æœ¬åœ°è®¡ç®—ï¼Œé¿å…APIè°ƒç”¨å¡æ­»
            print("ğŸ”§ ä½¿ç”¨æœ¬åœ°å…«å­—è®¡ç®—ï¼Œé¿å…APIè°ƒç”¨...")
            bazi_result = self.calculate_bazi_local_only(year, month, day, hour_index, gender, surname)

            # ä¿å­˜èµ·åç”¨çš„å…«å­—ç»“æœ
            self.naming_bazi_result = bazi_result
            self.naming_person_info = {
                'surname': surname,
                'gender': gender,
                'year': year,
                'month': month,
                'day': day,
                'hour': hour_text,
                'province': province,
                'city': city
            }

            # æ˜¾ç¤ºè¯¦ç»†å…«å­—ä¿¡æ¯
            bazi_info = self.format_detailed_bazi_info(surname, gender, year, month, day, hour_text, province, city, bazi_result)

            self.naming_bazi_info.setText(bazi_info)
            QMessageBox.information(self, "è®¡ç®—å®Œæˆ", "å…«å­—è®¡ç®—å®Œæˆï¼ç°åœ¨å¯ä»¥è¿›è¡Œä¸“ä¸šèµ·åäº†ã€‚")

        except Exception as e:
            QMessageBox.critical(self, "è®¡ç®—é”™è¯¯", f"å…«å­—è®¡ç®—å¤±è´¥ï¼š{str(e)}")

    def format_detailed_bazi_info(self, surname, gender, year, month, day, hour_text, province, city, bazi_result):
        """æ ¼å¼åŒ–è¯¦ç»†çš„å…«å­—ä¿¡æ¯"""
        try:
            # åŸºç¡€ä¿¡æ¯
            info = f"""ã€åŸºç¡€ä¿¡æ¯ã€‘
å§“æ°ï¼š{surname}  æ€§åˆ«ï¼š{gender}
å‡ºç”Ÿï¼š{year}å¹´{month}æœˆ{day}æ—¥ {hour_text}
å‡ºç”Ÿåœ°ï¼š{province} {city}

ã€å…«å­—å››æŸ±ã€‘
å¹´æŸ±ï¼š{bazi_result['year_pillar']}  æœˆæŸ±ï¼š{bazi_result['month_pillar']}  æ—¥æŸ±ï¼š{bazi_result['day_pillar']}  æ—¶æŸ±ï¼š{bazi_result['hour_pillar']}
æ—¥ä¸»ï¼š{bazi_result['day_master']}ï¼ˆ{bazi_result['day_master_element']}ï¼‰

ã€äº”è¡Œåˆ†å¸ƒã€‘"""

            # è¯¦ç»†äº”è¡Œåˆ†æ
            wuxing_dist = bazi_result['wuxing_distribution']
            total_wuxing = sum(wuxing_dist.values())

            for element, count in wuxing_dist.items():
                percentage = (count / total_wuxing * 100) if total_wuxing > 0 else 0
                strength = "æ—º" if percentage >= 30 else "å¼±" if percentage <= 15 else "å¹³"
                info += f"\n{element}ï¼š{count}ä¸ªï¼ˆ{percentage:.1f}%ï¼‰- {strength}"

            # åç¥åˆ†æ
            if 'ten_gods' in bazi_result and bazi_result['ten_gods']:
                info += f"\n\nã€åç¥é…ç½®ã€‘"
                ten_gods = bazi_result['ten_gods']
                for position in ['year', 'month', 'hour']:
                    if position in ten_gods:
                        pillar_name = {'year': 'å¹´å¹²', 'month': 'æœˆå¹²', 'hour': 'æ—¶å¹²'}[position]
                        info += f"\n{pillar_name}ï¼š{ten_gods[position]}"

            # æ ¼å±€åˆ†æ
            info += f"\n\nã€å‘½æ ¼ç‰¹å¾ã€‘"
            try:
                pattern_info = bazi_result.get('bazi_pattern', {})
                pattern_type = pattern_info.get('pattern_type', 'æœªçŸ¥')
                pattern_desc = pattern_info.get('pattern_description', '')

                # ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿å­—ç¬¦ä¸²ç¼–ç æ­£ç¡®ï¼Œé¿å…ä¹±ç 
                # è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶å¤„ç†ç¼–ç 
                if isinstance(pattern_type, bytes):
                    pattern_type = pattern_type.decode('utf-8', errors='replace')
                elif not isinstance(pattern_type, str):
                    pattern_type = str(pattern_type)

                if isinstance(pattern_desc, bytes):
                    pattern_desc = pattern_desc.decode('utf-8', errors='replace')
                elif not isinstance(pattern_desc, str):
                    pattern_desc = str(pattern_desc) if pattern_desc else ''

                info += f"\næ ¼å±€ï¼š{pattern_type}"
                if pattern_desc and pattern_desc.strip():
                    info += f"\nè¯´æ˜ï¼š{pattern_desc}"
            except Exception as e:
                info += f"\næ ¼å±€ï¼šæ˜¾ç¤ºå¤±è´¥ï¼ˆ{str(e)}ï¼‰"

            # äº”è¡Œç¼ºå¤±åˆ†æ
            missing_elements = [k for k, v in wuxing_dist.items() if v == 0]
            if missing_elements:
                info += f"\n\nã€äº”è¡Œç¼ºå¤±ã€‘ç¼º{', '.join(missing_elements)}ï¼Œèµ·åæ—¶éœ€è¦é‡ç‚¹è¡¥å……"

            # æ—ºè¡°åˆ†æ
            strong_elements = [k for k, v in wuxing_dist.items() if v >= 3]
            if strong_elements:
                info += f"\nã€äº”è¡Œåæ—ºã€‘{', '.join(strong_elements)}åæ—ºï¼Œèµ·åæ—¶éœ€è¦å¹³è¡¡"

            return info

        except Exception as e:
            return f"å…«å­—ä¿¡æ¯æ ¼å¼åŒ–å¤±è´¥ï¼š{str(e)}"

    def calculate_bazi_with_location(self, year, month, day, hour_index, gender, province, city):
        """æ ¹æ®å‡ºç”Ÿåœ°è®¡ç®—å…«å­—ï¼ˆè€ƒè™‘çœŸå¤ªé˜³æ—¶ï¼‰"""
        # è·å–åŸå¸‚ç»åº¦
        longitude = self.get_city_longitude(city)
        if longitude:
            # è®¡ç®—çœŸå¤ªé˜³æ—¶æ ¡æ­£
            hour_correction = (longitude - 120) / 15  # æ¯15åº¦1å°æ—¶
            corrected_hour = (hour_index * 2 + 23 + hour_correction) % 24
            corrected_hour_index = int(corrected_hour // 2)
        else:
            corrected_hour_index = hour_index

        # ä½¿ç”¨æ ¡æ­£åçš„æ—¶è¾°è®¡ç®—å…«å­—
        return self.calculate_bazi_core(year, month, day, corrected_hour_index, gender, False)

    def professional_naming_clicked(self):
        """ä¸“ä¸šèµ·åæŒ‰é’®ç‚¹å‡»äº‹ä»¶"""
        try:
            print("ğŸ¯ ä¸“ä¸šèµ·åæŒ‰é’®è¢«ç‚¹å‡»ï¼")

            # æ£€æŸ¥æ˜¯å¦å·²è®¡ç®—å…«å­—
            if not hasattr(self, 'naming_bazi_result') or not self.naming_bazi_result:
                print("âŒ å…«å­—ç»“æœä¸å­˜åœ¨ï¼Œéœ€è¦å…ˆè®¡ç®—å…«å­—")
                QMessageBox.warning(self, "æç¤º", "è¯·å…ˆç‚¹å‡»\"è®¡ç®—å…«å­—\"ï¼")
                return

            print("âœ… å…«å­—ç»“æœå­˜åœ¨ï¼Œç»§ç»­èµ·ååˆ†æ")

            # è·å–èµ·åé€‰é¡¹
            name_length = self.name_length_combo.currentText()
            naming_style = self.naming_style_combo.currentText()
            name_count = self.name_count_spin.value()

            print(f"ğŸ”§ èµ·åé€‰é¡¹: é•¿åº¦={name_length}, é£æ ¼={naming_style}, æ•°é‡={name_count}")

            # æ ¹æ®å­—æ•°é€‰æ‹©ç”Ÿæˆä¸åŒçš„åå­—
            results = []

            if "å•å­—å" in name_length or "å…¨éƒ¨æ¨è" in name_length:
                single_names = self.generate_single_character_names(
                    self.naming_person_info['surname'],
                    self.naming_bazi_result,
                    self.naming_person_info['gender'],
                    naming_style,
                    name_count // 3 if "å…¨éƒ¨æ¨è" in name_length else name_count
                )
                results.extend(single_names)

            if "åŒå­—å" in name_length or "å…¨éƒ¨æ¨è" in name_length:
                double_names = self.generate_double_character_names(
                    self.naming_person_info['surname'],
                    self.naming_bazi_result,
                    self.naming_person_info['gender'],
                    naming_style,
                    name_count // 3 if "å…¨éƒ¨æ¨è" in name_length else name_count
                )
                results.extend(double_names)

            if "ä¸‰å­—å" in name_length or "å…¨éƒ¨æ¨è" in name_length:
                triple_names = self.generate_triple_character_names(
                    self.naming_person_info['surname'],
                    self.naming_bazi_result,
                    self.naming_person_info['gender'],
                    naming_style,
                    name_count // 3 if "å…¨éƒ¨æ¨è" in name_length else name_count
                )
                results.extend(triple_names)

            # æ˜¾ç¤ºç»“æœ
            if isinstance(results, list):
                result_text = "\n".join(results)
            else:
                result_text = results

            self.naming_result.setText(f"ğŸ¯ ä¸“ä¸šèµ·åæ¨è ({naming_style}é£æ ¼)\n\n{result_text}")

        except Exception as e:
            QMessageBox.critical(self, "èµ·åé”™è¯¯", f"ä¸“ä¸šèµ·åå¤±è´¥ï¼š{str(e)}")

    def analyze_existing_name(self):
        """åˆ†æç°æœ‰å§“å"""
        # å¼¹å‡ºå¯¹è¯æ¡†è¾“å…¥ç°æœ‰å§“å
        from PyQt5.QtWidgets import QInputDialog
        name, ok = QInputDialog.getText(self, "åˆ†æç°æœ‰å§“å", "è¯·è¾“å…¥è¦åˆ†æçš„å§“åï¼ˆä¸å«å§“æ°ï¼‰:")
        if ok and name:
            if not hasattr(self, 'naming_bazi_result') or not self.naming_bazi_result:
                QMessageBox.warning(self, "æç¤º", "è¯·å…ˆç‚¹å‡»\"è®¡ç®—å…«å­—\"ï¼")
                return

            surname = self.naming_person_info['surname']
            gender = self.naming_person_info['gender']
            result = self.analyze_name_fortune(surname, name, self.naming_bazi_result, gender)

            if isinstance(result, list):
                result_text = "\n".join(result)
            else:
                result_text = result

            self.naming_result.setText(f"ğŸ” å§“ååˆ†æç»“æœ\n\n{result_text}")

    def analyze_name_clicked(self):
        """èµ·ååˆ†ææŒ‰é’®ç‚¹å‡»äº‹ä»¶"""
        try:
            # è·å–è¾“å…¥ä¿¡æ¯
            surname = self.surname_edit.text().strip()
            given_name = self.given_name_edit.text().strip()
            gender = self.naming_gender_combo.currentText()
            analysis_type = self.analysis_type_combo.currentText()
            # éªŒè¯è¾“å…¥
            if not surname:
                QMessageBox.warning(self, "è¾“å…¥é”™è¯¯", "è¯·è¾“å…¥å§“æ°ï¼")
                return
            # æ£€æŸ¥æ˜¯å¦æœ‰å…«å­—ä¿¡æ¯
            if not hasattr(self, 'current_bazi_result') or not self.current_bazi_result:
                QMessageBox.warning(self, "æç¤º", "è¯·å…ˆåœ¨\"å…«å­—ç®—å‘½\"é€‰é¡¹å¡ä¸­è®¡ç®—å…«å­—ï¼Œå†è¿›è¡Œèµ·ååˆ†æï¼")
                return
            # æ ¹æ®åˆ†æç±»å‹è¿›è¡Œä¼ ç»Ÿæœ¬åœ°è®¡ç®—
            if analysis_type == "å§“ååˆ†æ":
                if not given_name:
                    QMessageBox.warning(self, "è¾“å…¥é”™è¯¯", "å§“ååˆ†æéœ€è¦è¾“å…¥å®Œæ•´çš„å§“åï¼")
                    return
                result = self.analyze_name_fortune(surname, given_name, self.current_bazi_result, gender)
            elif analysis_type == "èµ·åå»ºè®®":
                result = self.suggest_name_improvements(surname, self.current_bazi_result, gender)
            else:  # å§“åæ¨è
                result = self.generate_name_suggestions(surname, self.current_bazi_result, gender, 5)

            # æ˜¾ç¤ºç»“æœ
            if isinstance(result, list):
                result_text = "\n".join(result)
            else:
                result_text = result
            self.naming_result.setText(f"ğŸ”® {analysis_type}ç»“æœ\n\n{result_text}")
        except Exception as e:
            QMessageBox.critical(self, "åˆ†æé”™è¯¯", f"èµ·ååˆ†æå¤±è´¥ï¼š{str(e)}")
    def create_fengshui_tab(self):
        """åˆ›å»ºé£æ°´åˆ†æé€‰é¡¹å¡"""
        widget = QWidget()
        layout = QHBoxLayout(widget)
        # å·¦ä¾§è¾“å…¥åŒºåŸŸ
        input_group = QGroupBox("é£æ°´ä¿¡æ¯è¾“å…¥")
        input_layout = QVBoxLayout(input_group)
        # é£æ°´ç±»å‹é€‰æ‹©
        type_layout = QHBoxLayout()
        type_layout.addWidget(QLabel("é£æ°´ç±»å‹:"))
        self.fengshui_type = QComboBox()
        self.fengshui_type.addItems(["é˜³å®…(ä½å®…)", "é˜´å®…(å¢“åœ°)", "åŠå…¬å®¤"])
        self.fengshui_type.currentTextChanged.connect(self.on_fengshui_type_changed)
        type_layout.addWidget(self.fengshui_type)
        input_layout.addLayout(type_layout)
        # æˆ¿å±‹æœå‘
        direction_layout = QHBoxLayout()
        direction_layout.addWidget(QLabel("æˆ¿å±‹æœå‘:"))
        self.house_direction = QComboBox()
        directions = ["ååŒ—æœå—", "åä¸œæœè¥¿", "åå—æœåŒ—", "åè¥¿æœä¸œ",
                     "åä¸œåŒ—æœè¥¿å—", "åè¥¿å—æœä¸œåŒ—", "åä¸œå—æœè¥¿åŒ—", "åè¥¿åŒ—æœä¸œå—"]
        self.house_direction.addItems(directions)
        direction_layout.addWidget(self.house_direction)
        input_layout.addLayout(direction_layout)
        # å»ºç­‘ä¿¡æ¯
        building_layout = QGridLayout()
        building_layout.addWidget(QLabel("å»ºç­‘å±‚æ•°:"), 0, 0)
        self.total_floors = QSpinBox()
        self.total_floors.setRange(1, 100)
        self.total_floors.setValue(6)
        building_layout.addWidget(self.total_floors, 0, 1)
        building_layout.addWidget(QLabel("æ‰€åœ¨æ¥¼å±‚:"), 0, 2)
        self.current_floor = QSpinBox()
        self.current_floor.setRange(1, 100)
        self.current_floor.setValue(3)
        building_layout.addWidget(self.current_floor, 0, 3)
        building_layout.addWidget(QLabel("å»ºç­‘é¢ç§¯:"), 1, 0)
        self.house_area = QSpinBox()
        self.house_area.setRange(20, 1000)
        self.house_area.setValue(100)
        self.house_area.setSuffix("ã¡")
        building_layout.addWidget(self.house_area, 1, 1)
        input_layout.addLayout(building_layout)
        # å±…ä½äººå‘˜ä¿¡æ¯
        residents_group = QGroupBox("å±…ä½äººå‘˜")
        residents_layout = QVBoxLayout(residents_group)
        # ä¸»äººä¿¡æ¯
        main_layout = QHBoxLayout()
        main_layout.addWidget(QLabel("ä¸»äºº:"))
        self.main_resident = QLineEdit()
        self.main_resident.setPlaceholderText("å§“å(æ€§åˆ«) å‡ºç”Ÿä¿¡æ¯")
        main_layout.addWidget(self.main_resident)
        residents_layout.addLayout(main_layout)
        # å…¶ä»–æˆå‘˜
        self.other_residents = QTextEdit()
        self.other_residents.setMaximumHeight(80)
        self.other_residents.setPlaceholderText("å…¶ä»–å®¶åº­æˆå‘˜ä¿¡æ¯ï¼Œæ¯è¡Œä¸€ä¸ª")
        residents_layout.addWidget(self.other_residents)
        input_layout.addWidget(residents_group)
        # ç‰¹æ®Šéœ€æ±‚
        needs_layout = QHBoxLayout()
        needs_layout.addWidget(QLabel("ç‰¹æ®Šéœ€æ±‚:"))
        self.special_needs = QComboBox()
        needs = ["ç»¼åˆåˆ†æ", "å‚¬æ—ºäº‹ä¸š", "å¢è¿›è´¢è¿", "æ”¹å–„å¥åº·", "ä¿ƒè¿›å­¦ä¸š", "å’Œè°å®¶åº­", "æ‹›æ¡ƒèŠ±"]
        self.special_needs.addItems(needs)
        needs_layout.addWidget(self.special_needs)
        input_layout.addLayout(needs_layout)
        # åˆ†ææŒ‰é’®
        analyze_btn = QPushButton("ğŸ” å¼€å§‹é£æ°´åˆ†æ")
        analyze_btn.clicked.connect(self.analyze_fengshui)
        analyze_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A6A4A, stop:1 #2A4A2A);
                border: 2px solid #66FF66;
                border-radius: 8px;
                color: #FFD700;
                font-weight: bold;
                padding: 10px;
                font-size: 16px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A8A6A, stop:1 #4A6A4A);
                border-color: #88FF88;
            }
        """)
        input_layout.addWidget(analyze_btn)
        input_layout.addStretch()
        layout.addWidget(input_group)
        # å³ä¾§ç»“æœæ˜¾ç¤ºåŒºåŸŸ
        result_group = QGroupBox("é£æ°´åˆ†æç»“æœ")
        result_layout = QVBoxLayout(result_group)
        self.fengshui_result = QTextEdit()
        self.fengshui_result.setReadOnly(True)
        self.fengshui_result.setPlaceholderText("è¯·è¾“å…¥æˆ¿å±‹ä¿¡æ¯åç‚¹å‡»\"å¼€å§‹é£æ°´åˆ†æ\"æŸ¥çœ‹è¯¦ç»†åˆ†æ...")
        # è®¾ç½®æ›´å¤§çš„å­—ä½“
        font = self.fengshui_result.font()
        font.setPointSize(20)  # å¢å¤§å­—ä½“åˆ°20ptï¼Œæé«˜å¯è¯»æ€§
        font.setFamily("Microsoft YaHei")
        self.fengshui_result.setFont(font)
        result_layout.addWidget(self.fengshui_result)
        layout.addWidget(result_group)
        return widget
    def on_fengshui_type_changed(self, fengshui_type):
        """é£æ°´ç±»å‹æ”¹å˜æ—¶çš„å¤„ç†"""
        # é£æ°´ç±»å‹å¤„ç†ï¼ˆæš‚æ—¶ä¿ç•™åŸºç¡€åŠŸèƒ½ï¼‰
        if "é˜´å®…" in fengshui_type:
            print("é˜´å®…é£æ°´åˆ†æ")
        elif "åŠå…¬å®¤" in fengshui_type:
            print("åŠå…¬å®¤é£æ°´åˆ†æ")
        else:
            print("é˜³å®…é£æ°´åˆ†æ")
    def apply_styles(self):
        """åº”ç”¨çª—å£æ ·å¼"""
        self.setStyleSheet("""
            QWidget {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
                color: #FFD700;
                font-family: "Microsoft YaHei";
            }
            QGroupBox {
                font-weight: bold;
                border: 2px solid #FFD700;
                border-radius: 10px;
                margin-top: 10px;
                padding-top: 10px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 10px;
                padding: 0 5px 0 5px;
            }
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFD700;
                font-weight: bold;
                padding: 8px;
                min-width: 80px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
                border-color: #FFA500;
            }
            QLineEdit, QDateEdit, QComboBox, QSpinBox {
                background: #FFFFFF;
                border: 2px solid #666666;
                border-radius: 5px;
                padding: 2px 6px;      /* æ›´çŸ®ï¼šä¸Šä¸‹ç¼©å° */
                color: #000000;
                font-size: 14px;       /* ç»Ÿä¸€å­—å· */
                min-height: 24px;      /* ç»Ÿä¸€é«˜åº¦ */
                max-height: 24px;      /* å¼ºåˆ¶ä¸€è‡´ */
            }
            QLineEdit:focus, QDateEdit:focus, QComboBox:focus, QSpinBox:focus {
                border-color: #FFD700;
            }
            QTextEdit {
                background: #2A2A2A;
                border: 2px solid #666666;
                border-radius: 5px;
                color: #FFD700;
                font-size: 20px; /* å…¨å±€æå‡åˆ°20pxï¼Œç¡®ä¿å¯è¯»æ€§ */
            }
            QLabel {
                color: #FFD700;
                font-weight: bold;
            }
            QCheckBox {
                color: #FFD700;
            }
            QCheckBox::indicator {
                width: 18px;
                height: 18px;
            }
            QCheckBox::indicator:unchecked {
                border: 2px solid #666666;
                background: #3A3A3A;
                border-radius: 3px;
            }
            QCheckBox::indicator:checked {
                border: 2px solid #FFD700;
                background: #FFD700;
                border-radius: 3px;
            }
        """)
    def cleanup_previous_analysis(self):
        """æ¸…ç†ä¹‹å‰åˆ†æçš„èµ„æºï¼Œé˜²æ­¢é—ªé€€"""
        try:
            # 1. åœæ­¢å¹¶æ¸…ç†å€’è®¡æ—¶å®šæ—¶å™¨
            if hasattr(self, 'countdown_timer') and self.countdown_timer is not None:
                try:
                    if self.countdown_timer.isActive():
                        self.countdown_timer.stop()
                    self.countdown_timer.deleteLater()
                except Exception as timer_error:
                    print(f"âš ï¸ å®šæ—¶å™¨æ¸…ç†å¼‚å¸¸: {timer_error}")
                finally:
                    self.countdown_timer = None
                print("ğŸ§¹ æ¸…ç†å€’è®¡æ—¶å®šæ—¶å™¨")

            # 2. ç­‰å¾…å¹¶æ¸…ç†APIçº¿ç¨‹
            if hasattr(self, 'api_thread') and self.api_thread:
                if self.api_thread.is_alive():
                    print("â³ ç­‰å¾…ä¹‹å‰çš„APIçº¿ç¨‹ç»“æŸ...")
                    self.api_thread.join(timeout=2)  # æœ€å¤šç­‰å¾…2ç§’
                    if self.api_thread.is_alive():
                        print("âš ï¸ APIçº¿ç¨‹æœªèƒ½æ­£å¸¸ç»“æŸ")
                self.api_thread = None
                print("ğŸ§¹ æ¸…ç†APIçº¿ç¨‹")

            # 3. æ¸…ç†åˆ†æå‚æ•°
            if hasattr(self, 'analysis_params'):
                self.analysis_params = None

            # 4. é‡ç½®åˆ†æçŠ¶æ€
            self.remaining_time = 480  # ğŸ”¥ é‡ç½®å€’è®¡æ—¶ä¸º8åˆ†é’Ÿ

            print("âœ… èµ„æºæ¸…ç†å®Œæˆ")

        except Exception as e:
            print(f"âŒ èµ„æºæ¸…ç†å¤±è´¥: {e}")

    def calculate_bazi(self):
        """è®¡ç®—å…«å­— - å¸¦è¿›åº¦æ˜¾ç¤ºå’Œå€’è®¡æ—¶ï¼Œæ”¯æŒçœŸå¤ªé˜³æ—¶æ ¡æ­£"""
        # ğŸ”¥ ä¿®å¤BUGï¼šå¼ºåŒ–èµ„æºæ¸…ç†ï¼Œé˜²æ­¢é‡å¤è°ƒç”¨å¯¼è‡´é—ªé€€
        try:
            # 1. æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹
            if hasattr(self, 'api_thread') and self.api_thread and self.api_thread.is_alive():
                print("âš ï¸ APIè°ƒç”¨æ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤è¯·æ±‚")
                return

            # 2. å¼ºåˆ¶æ¸…ç†ä¹‹å‰çš„èµ„æº
            self.cleanup_previous_analysis()

        except Exception as e:
            print(f"âš ï¸ èµ„æºæ¸…ç†å¼‚å¸¸: {e}")
            # å³ä½¿æ¸…ç†å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œ

        try:
            # å¼€å§‹è®¡ç®—å…«å­—
            # è·å–è¾“å…¥ä¿¡æ¯
            name = self.name_edit.text().strip()
            gender = self.gender_combo.currentText()
            year = self.birth_year.value()
            month = self.birth_month.currentIndex() + 1  # æœˆä»½ä»1å¼€å§‹
            day = self.birth_day.currentIndex() + 1      # æ—¥æœŸä»1å¼€å§‹
            hour_text = self.hour_combo.currentText()
            is_leap = self.leap_month.isChecked()

            # è¾“å…¥æ•°æ®éªŒè¯å®Œæˆ

            # å§“åä¸ºå¯é€‰ï¼Œå¦‚æœæ²¡æœ‰è¾“å…¥åˆ™ä½¿ç”¨é»˜è®¤åç§°
            if not name:
                name = "å‘½ä¸»"

            # è§£ææ—¶è¾°
            hour_index = self.shichen_list.index(hour_text)
            # æ—¶è¾°è§£æå®Œæˆ

            # è·å–å‡ºç”Ÿåœ°ä¿¡æ¯
            province = self.birth_province.currentText() if hasattr(self, 'birth_province') else "åŒ—äº¬å¸‚"
            city = self.birth_city.currentText() if hasattr(self, 'birth_city') else "åŒ—äº¬å¸‚"

            # å¼€å§‹è¿›åº¦æ˜¾ç¤ºå’Œå€’è®¡æ—¶
            self.start_analysis_progress(name, gender, year, month, day, hour_text, hour_index, is_leap, province, city)

        except Exception as e:
            # è®¡ç®—è¿‡ç¨‹å‘ç”Ÿé”™è¯¯
            import traceback
            traceback.print_exc()
            QMessageBox.critical(self, "è¾“å…¥é”™è¯¯", f"è¾“å…¥æ•°æ®æœ‰è¯¯ï¼š{str(e)}")

    def start_analysis_progress(self, name, gender, year, month, day, hour_text, hour_index, is_leap, province=None, city=None):
        """å¼€å§‹åˆ†æè¿›åº¦æ˜¾ç¤ºï¼ˆæ¢å¤å€’è®¡æ—¶åŠŸèƒ½ï¼‰"""
        # ğŸ”¥ ä¿®å¤ï¼šé˜²æ­¢é‡å¤å¯åŠ¨
        if hasattr(self, 'countdown_timer') and self.countdown_timer is not None and self.countdown_timer.isActive():
            print("âš ï¸ åˆ†æè¿›åº¦å·²åœ¨è¿è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤å¯åŠ¨")
            return

        # ä¿å­˜å‚æ•°ä¾›åç»­ä½¿ç”¨
        self.analysis_params = {
            'name': name,
            'gender': gender,
            'year': year,
            'month': month,
            'day': day,
            'hour_text': hour_text,
            'hour_index': hour_index,
            'is_leap': is_leap,
            'province': province,
            'city': city,
            'precise_hour': self.precise_hour.value() if hasattr(self, 'precise_hour') else None,
            'precise_minute': self.precise_minute.value() if hasattr(self, 'precise_minute') else None
        }

        # ä¼ ç»Ÿç‰ˆï¼šæœ¬åœ°è¿ç®—ï¼Œç«‹å³å‡ºç»“æœï¼Œæ— éœ€å€’è®¡æ—¶
        try:
            result = self.calculate_bazi_core(year, month, day, hour_index, gender, is_leap, name)
            self.display_bazi_result(name, gender, year, month, day, hour_text, result)
            self.current_user_info = {
                'name': name,
                'gender': gender,
                'year': year,
                'month': month,
                'day': day,
                'hour_text': hour_text,
                'pillars': result.get('pillars', {}),
                'wuxing': result.get('wuxing_distribution', {}),
                'day_master': result.get('day_master', '?'),
                'day_master_element': result.get('day_master_element', '?')
            }
            return
        except Exception as e:
            error_text = f"""âš ï¸ å…«å­—åˆ†æå¤±è´¥

é”™è¯¯ä¿¡æ¯ï¼š{str(e)}

è¯·æ£€æŸ¥è¾“å…¥æˆ–ç¨åé‡è¯•"""
            # ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿æ–‡æœ¬ç¼–ç æ­£ç¡®
            if isinstance(error_text, bytes):
                error_text = error_text.decode('utf-8', errors='replace')
            self.bazi_result.setPlainText(error_text)
            return

        # ä»¥ä¸‹æ—§æµç¨‹ï¼ˆå€’è®¡æ—¶+å¼‚æ­¥çº¿ç¨‹ï¼‰ä¿ç•™å¤‡ç”¨ï¼Œå¦‚éœ€æ¢å¤å¯å»æ‰ä¸Šæ–¹returnã€‚

        # æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯
        self.show_progress_message(name, gender, year, month, day, hour_text)

        # åˆå§‹åŒ–å€’è®¡æ—¶ï¼ˆæ¢å¤åŸæœ‰åŠŸèƒ½ï¼‰
        import time
        self.countdown_seconds = 480  # ğŸ”¥ æ”¹ä¸º8åˆ†é’Ÿ = 480ç§’
        self.analysis_start_time = time.time()

        # å¯åŠ¨å€’è®¡æ—¶å®šæ—¶å™¨ï¼ˆæ¢å¤åŸæœ‰åŠŸèƒ½ï¼‰
        self.countdown_timer = QTimer()
        self.countdown_timer.timeout.connect(self.update_countdown)
        self.countdown_timer.start(1000)  # æ¯ç§’æ›´æ–°ä¸€æ¬¡

        # å¯åŠ¨APIè°ƒç”¨çº¿ç¨‹ï¼ˆæ¢å¤åŸæœ‰åŠŸèƒ½ï¼‰
        import threading
        self.api_thread = threading.Thread(
            target=self.perform_bazi_calculation_with_countdown,
            args=(year, month, day, hour_index, gender, is_leap, name)
        )
        self.api_thread.daemon = True
        self.api_thread.start()

    def perform_bazi_calculation_with_countdown(self, year, month, day, hour_index, gender, is_leap, name):
        """åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œå…«å­—è®¡ç®—ï¼ˆå¸¦å€’è®¡æ—¶ï¼‰"""
        try:
            # æ‰§è¡Œå…«å­—è®¡ç®—
            result = self.calculate_bazi_core(year, month, day, hour_index, gender, is_leap, name)

            # ğŸ”¥ ä¿®å¤ï¼šç›´æ¥åœ¨ä¸»çº¿ç¨‹ä¸­æ›´æ–°UIï¼Œé¿å…é‡å¤è°ƒç”¨
            from PyQt5.QtCore import QMetaObject, Qt, Q_ARG
            QMetaObject.invokeMethod(self, "on_api_call_completed",
                                   Qt.QueuedConnection,
                                   Q_ARG("PyQt_PyObject", result))

        except Exception as e:
            # ğŸ”¥ ä¿®å¤ï¼šç›´æ¥åœ¨ä¸»çº¿ç¨‹ä¸­æ˜¾ç¤ºé”™è¯¯ï¼Œé¿å…é‡å¤è°ƒç”¨
            from PyQt5.QtCore import QMetaObject, Qt, Q_ARG
            QMetaObject.invokeMethod(self, "on_api_call_failed",
                                   Qt.QueuedConnection,
                                   Q_ARG("PyQt_PyObject", str(e)))




    def show_progress_message(self, name, gender, year, month, day, hour_text):
        """æ˜¾ç¤ºè¿›åº¦æ¶ˆæ¯"""
        progress_text = f"""æ­£åœ¨è¿›è¡Œä¸“ä¸šå…«å­—åˆ†æ......

å‰©ä½™æ—¶é—´ï¼š8åˆ†00ç§’

ğŸ”® æ­£åœ¨åˆ†ææ‚¨çš„å‘½ç†ä¿¡æ¯ï¼Œè¯·ç¨å€™..."""
        # ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿æ–‡æœ¬ç¼–ç æ­£ç¡®
        if isinstance(progress_text, bytes):
            progress_text = progress_text.decode('utf-8', errors='replace')
        self.bazi_result.setPlainText(progress_text)

    def update_countdown(self):
        """æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º"""
        # æ£€æŸ¥è®¡ç®—æ˜¯å¦å®Œæˆ
        if hasattr(self, 'bazi_calculation_success'):
            self.countdown_timer.stop()
            if self.bazi_calculation_success:
                # è®¡ç®—æˆåŠŸï¼Œæ˜¾ç¤ºç»“æœ
                params = self.analysis_params
                self.display_bazi_result(
                    params['name'], params['gender'], params['year'],
                    params['month'], params['day'], params['hour_text'],
                    self.bazi_calculation_result
                )
                # æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
                self.current_user_info = {
                    'name': params['name'],
                    'gender': params['gender'],
                    'year': params['year'],
                    'month': params['month'],
                    'day': params['day'],
                    'hour_text': params['hour_text'],
                    'pillars': self.bazi_calculation_result.get('pillars', {}),
                    'wuxing': self.bazi_calculation_result.get('wuxing_distribution', {}),
                    'day_master': self.bazi_calculation_result.get('day_master', '?'),
                    'day_master_element': self.bazi_calculation_result.get('day_master_element', '?')
                }
            else:
                # è®¡ç®—å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯
                error_text = f"""âŒ å…«å­—åˆ†æå¤±è´¥

é”™è¯¯ä¿¡æ¯ï¼š{getattr(self, 'bazi_calculation_error', 'æœªçŸ¥é”™è¯¯')}

è¯·æ£€æŸ¥ï¼š
1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
2. è¾“å…¥ä¿¡æ¯æ˜¯å¦æ­£ç¡®
3. ç¨åé‡è¯•"""
                # ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿æ–‡æœ¬ç¼–ç æ­£ç¡®
                if isinstance(error_text, bytes):
                    error_text = error_text.decode('utf-8', errors='replace')
                self.bazi_result.setPlainText(error_text)

            # æ¸…ç†çŠ¶æ€
            delattr(self, 'bazi_calculation_success')
            if hasattr(self, 'bazi_calculation_result'):
                delattr(self, 'bazi_calculation_result')
            if hasattr(self, 'bazi_calculation_error'):
                delattr(self, 'bazi_calculation_error')
            return

        self.countdown_seconds -= 1

        # è®¡ç®—åˆ†é’Ÿå’Œç§’
        minutes = self.countdown_seconds // 60
        seconds = self.countdown_seconds % 60

        # æ›´æ–°ç®€åŒ–çš„æ˜¾ç¤ºæ–‡æœ¬
        progress_text = f"""åˆ†ææ­£åœ¨è¿›è¡Œä¸­......

å‰©ä½™æ—¶é—´ï¼š{minutes}åˆ†{seconds:02d}ç§’"""
        # ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿æ–‡æœ¬ç¼–ç æ­£ç¡®
        if isinstance(progress_text, bytes):
            progress_text = progress_text.decode('utf-8', errors='replace')
        self.bazi_result.setPlainText(progress_text)

        # å¦‚æœå€’è®¡æ—¶ç»“æŸï¼Œåœæ­¢å®šæ—¶å™¨
        if self.countdown_seconds <= 0:
            if hasattr(self, 'countdown_timer') and self.countdown_timer is not None:
                try:
                    self.countdown_timer.stop()
                except Exception as e:
                    print(f"âš ï¸ å€’è®¡æ—¶ç»“æŸåœæ­¢å®šæ—¶å™¨å¼‚å¸¸: {e}")
            # å¦‚æœAPIè°ƒç”¨è¿˜æ²¡å®Œæˆï¼Œæ˜¾ç¤ºè¶…æ—¶ä¿¡æ¯
            if hasattr(self, 'api_thread') and self.api_thread.is_alive():
                self.show_timeout_message()



    @pyqtSlot("PyQt_PyObject")
    def on_api_call_completed(self, bazi_result):
        """APIè°ƒç”¨å®Œæˆçš„å›è°ƒ"""
        # ğŸ”¥ ä¿®å¤BUGï¼šå¼ºåŒ–èµ„æºæ¸…ç†ï¼Œé˜²æ­¢é—ªé€€
        try:
            # 1. åœæ­¢å€’è®¡æ—¶å®šæ—¶å™¨
            if hasattr(self, 'countdown_timer') and self.countdown_timer is not None:
                try:
                    if self.countdown_timer.isActive():
                        self.countdown_timer.stop()
                    self.countdown_timer.deleteLater()
                except Exception as timer_error:
                    print(f"âš ï¸ å®Œæˆå›è°ƒå®šæ—¶å™¨æ¸…ç†å¼‚å¸¸: {timer_error}")
                finally:
                    self.countdown_timer = None

            # 2. æ¸…ç†çº¿ç¨‹çŠ¶æ€ï¼ˆä½†ä¿ç•™APIå¯†é’¥ç­‰èµ„æºç»™é€šä¿—è§£é‡Šä½¿ç”¨ï¼‰
            if hasattr(self, 'api_thread'):
                self.api_thread = None

            print("âœ… ä¸»åˆ†æå®Œæˆï¼Œèµ„æºéƒ¨åˆ†æ¸…ç†ï¼ˆä¿ç•™é€šä¿—è§£é‡Šæ‰€éœ€èµ„æºï¼‰")

        except Exception as e:
            print(f"âš ï¸ å®Œæˆå›è°ƒæ¸…ç†å¼‚å¸¸: {e}")

        # ä¿å­˜å…«å­—ç»“æœ
        self.current_bazi_result = bazi_result

        # æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºè¯¦ç»†è¿åŠ¿åŠŸèƒ½ï¼‰
        params = self.analysis_params
        self.current_user_info = {
            'name': params['name'],
            'gender': params['gender'],
            'year': params['year'],
            'month': params['month'],
            'day': params['day'],
            'hour_text': params['hour_text'],
            'pillars': bazi_result.get('pillars', {}),
            'wuxing': bazi_result.get('wuxing_distribution', {}),
            'day_master': bazi_result.get('day_master', '?'),
            'day_master_element': bazi_result.get('day_master_element', '?')
        }

        # æ˜¾ç¤ºç»“æœ
        # å¼€å§‹æ˜¾ç¤ºAPIç»“æœ
        self.display_bazi_result(
            params['name'], params['gender'], params['year'],
            params['month'], params['day'], params['hour_text'],
            bazi_result
        )
        # APIç»“æœæ˜¾ç¤ºå®Œæˆ

    @pyqtSlot("PyQt_PyObject")
    def on_api_call_failed(self, error_message):
        """APIè°ƒç”¨å¤±è´¥çš„å›è°ƒ"""
        # ğŸ”¥ ä¿®å¤BUGï¼šå¼ºåŒ–èµ„æºæ¸…ç†ï¼Œé˜²æ­¢é—ªé€€
        try:
            # 1. åœæ­¢å€’è®¡æ—¶å®šæ—¶å™¨
            if hasattr(self, 'countdown_timer') and self.countdown_timer is not None:
                try:
                    if self.countdown_timer.isActive():
                        self.countdown_timer.stop()
                    self.countdown_timer.deleteLater()
                except Exception as timer_error:
                    print(f"âš ï¸ å¤±è´¥å›è°ƒå®šæ—¶å™¨æ¸…ç†å¼‚å¸¸: {timer_error}")
                finally:
                    self.countdown_timer = None

            # 2. æ¸…ç†çº¿ç¨‹çŠ¶æ€
            if hasattr(self, 'api_thread'):
                self.api_thread = None

            print("âœ… APIè°ƒç”¨å¤±è´¥ï¼Œèµ„æºå·²æ¸…ç†")

        except Exception as e:
            print(f"âš ï¸ å¤±è´¥å›è°ƒæ¸…ç†å¼‚å¸¸: {e}")

        # APIè°ƒç”¨å¤±è´¥å¤„ç†
        try:
            # å‹å¥½çš„é”™è¯¯æç¤º
            if "402" in str(error_message) and "Insufficient Balance" in str(error_message):
                user_message = """DeepSeek APIé…é¢ä¸è¶³

å¯èƒ½åŸå› ï¼š
â€¢ æœ¬æœˆå…è´¹é¢åº¦å·²ç”¨å®Œ
â€¢ è´¦æˆ·éœ€è¦éªŒè¯æˆ–å……å€¼

è§£å†³æ–¹æ¡ˆï¼š
1. ç™»å½•DeepSeekå®˜ç½‘æŸ¥çœ‹è´¦æˆ·çŠ¶æ€
2. ç­‰å¾…ä¸‹æœˆå…è´¹é¢åº¦é‡ç½®
3. æˆ–è¿›è¡Œå°‘é‡å……å€¼ç»§ç»­ä½¿ç”¨

DeepSeekå®˜ç½‘ï¼šhttps://www.deepseek.com/

è¯¦ç»†å¸®åŠ©è¯·æŸ¥çœ‹ deepseek_help.md æ–‡ä»¶"""
            else:
                user_message = f"å…«å­—è®¡ç®—å¤±è´¥ï¼š{str(error_message)}"

            QMessageBox.critical(self, "è®¡ç®—é”™è¯¯", user_message)

            # æ¢å¤åˆå§‹çŠ¶æ€
            self.bazi_result.setText("è¯·è¾“å…¥ä¸ªäººä¿¡æ¯åç‚¹å‡»\"å¼€å§‹æ’å…«å­—\"æŸ¥çœ‹è¯¦ç»†åˆ†æ...")

        except Exception as e:
            print(f"âš ï¸ é”™è¯¯å¤„ç†å¼‚å¸¸: {e}")
            try:
                QMessageBox.critical(self, "è®¡ç®—é”™è¯¯", "å…«å­—è®¡ç®—å¤±è´¥")
                self.bazi_result.setText("è¯·è¾“å…¥ä¸ªäººä¿¡æ¯åç‚¹å‡»\"å¼€å§‹æ’å…«å­—\"æŸ¥çœ‹è¯¦ç»†åˆ†æ...")
            except:
                pass  # æœ€åçš„ä¿æŠ¤

    def closeEvent(self, event):
        """çª—å£å…³é—­äº‹ä»¶ - å¼ºåŒ–èµ„æºæ¸…ç†ï¼Œé˜²æ­¢é—ªé€€"""
        try:
            print("ğŸ”„ å…«å­—çª—å£æ­£åœ¨å…³é—­ï¼Œæ¸…ç†èµ„æº...")

            # 1. å¼ºåˆ¶åœæ­¢æ‰€æœ‰å®šæ—¶å™¨
            if hasattr(self, 'countdown_timer') and self.countdown_timer is not None:
                try:
                    if self.countdown_timer.isActive():
                        self.countdown_timer.stop()
                    self.countdown_timer.deleteLater()
                except Exception as timer_error:
                    print(f"âš ï¸ çª—å£å…³é—­å®šæ—¶å™¨æ¸…ç†å¼‚å¸¸: {timer_error}")
                finally:
                    self.countdown_timer = None

            # 2. ç­‰å¾…APIçº¿ç¨‹ç»“æŸ
            if hasattr(self, 'api_thread') and self.api_thread:
                if self.api_thread.is_alive():
                    print("â³ ç­‰å¾…APIçº¿ç¨‹ç»“æŸ...")
                    self.api_thread.join(timeout=3)  # æœ€å¤šç­‰å¾…3ç§’
                    if self.api_thread.is_alive():
                        print("âš ï¸ APIçº¿ç¨‹å¼ºåˆ¶ç»“æŸ")
                self.api_thread = None

            # 3. æ¸…ç†å…¶ä»–èµ„æº
            if hasattr(self, 'analysis_params'):
                self.analysis_params = None

            print("âœ… å…«å­—çª—å£èµ„æºæ¸…ç†å®Œæˆ")

        except Exception as e:
            print(f"âš ï¸ çª—å£å…³é—­æ¸…ç†å¼‚å¸¸: {e}")
        finally:
            # ç¡®ä¿çª—å£èƒ½æ­£å¸¸å…³é—­
            event.accept()

    def show_timeout_message(self):
        """æ˜¾ç¤ºè¶…æ—¶æ¶ˆæ¯"""
        timeout_text = """åˆ†æè¶…æ—¶ï¼Œè¯·é‡æ–°å°è¯•ã€‚"""
        self.bazi_result.setText(timeout_text)

    def calculate_bazi_core(self, year, month, day, hour_index, gender, _is_leap, name="æœªæä¾›"):
        """å…«å­—è®¡ç®—æ ¸å¿ƒç®—æ³• - ä¿®å¤èµ·ååˆ†æå¡æ­»é—®é¢˜"""
        # ğŸ”¥ ä¿®å¤ï¼šèµ·ååˆ†ææ—¶ä½¿ç”¨æœ¬åœ°è®¡ç®—ï¼Œé¿å…APIè°ƒç”¨å¡æ­»
        try:
            # âš¡ ä¼ ç»Ÿç‰ˆå¼ºåˆ¶ä½¿ç”¨æœ¬åœ°åˆ†æï¼Œä¸ä¾èµ–ä»»ä½•API
            print("ğŸŒŸ ä¼ ç»Ÿç‰ˆæ¨¡å¼ï¼šä½¿ç”¨å®Œå…¨æœ¬åœ°åŒ–åˆ†æ")
            return self.calculate_bazi_locally(year, month, day, hour_index, gender, name, is_leap=_is_leap)

        except Exception as e:
            print(f"âš ï¸ æœ¬åœ°åˆ†æå¤±è´¥ï¼Œå›é€€åˆ°ç®€åŒ–è®¡ç®—: {e}")
            return self.calculate_bazi_local_only(year, month, day, hour_index, gender, name, is_leap=_is_leap)

    def calculate_bazi_local_only(self, year, month, day, hour_index, gender, name="æœªæä¾›", is_leap=False):
        """æœ¬åœ°å…«å­—è®¡ç®— - ä¸“é—¨ç”¨äºèµ·ååˆ†æï¼Œé¿å…APIè°ƒç”¨å¡æ­»"""
        try:
            print(f"ğŸ”§ å¼€å§‹æœ¬åœ°å…«å­—è®¡ç®—: {year}å¹´{month}æœˆ{day}æ—¥ æ—¶è¾°{hour_index} {gender}")

            # ä½¿ç”¨ sxtwl å’Œ lunar-python è¿›è¡Œæœ¬åœ°è®¡ç®—
            if SXTWL_AVAILABLE:
                try:
                    from lunar_python import Lunar, Solar

                    # æ—¶è¾°è½¬æ¢
                    hour_map = {0: (23, 30), 1: (1, 30), 2: (3, 30), 3: (5, 30), 4: (7, 30), 5: (9, 30),
                               6: (11, 30), 7: (13, 30), 8: (15, 30), 9: (17, 30), 10: (19, 30), 11: (21, 30)}
                    input_hour, input_minute = hour_map.get(hour_index, (1, 30))

                    # å†œå†è½¬å…¬å†ï¼ˆå¤„ç†é—°æœˆï¼‰
                    lunar_month = self._normalize_lunar_month(year, month, is_leap)
                    lunar = Lunar.fromYmdHms(year, lunar_month, day, input_hour, input_minute, 0)
                    solar = lunar.getSolar()

                    # ä½¿ç”¨ sxtwl è®¡ç®—å››æŸ±
                    province = None
                    city = None
                    if hasattr(self, 'analysis_params'):
                        province = self.analysis_params.get('province')
                        city = self.analysis_params.get('city')
                    longitude, latitude, location_name = self._get_birth_location(province, city)
                    # âœ… ä¿®å¤ï¼šå¦‚æœç»çº¬åº¦è·å–å¤±è´¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ
                    if longitude is None or latitude is None:
                        # é™çº§æ–¹æ¡ˆ1ï¼šå°è¯•ä½¿ç”¨çœä»½çš„é»˜è®¤ç»çº¬åº¦ï¼ˆçœä¼šåŸå¸‚ï¼‰
                        if province:
                            province_coordinates = {
                                "æ¹–å—": (112.98, 28.2),  # é•¿æ²™
                                "æ¹–åŒ—": (114.31, 30.52),  # æ­¦æ±‰
                                "å¹¿ä¸œ": (113.27, 23.13),  # å¹¿å·
                                "æµ™æ±Ÿ": (120.19, 30.26),  # æ­å·
                                "æ±Ÿè‹": (118.78, 32.04),  # å—äº¬
                                "å±±ä¸œ": (117.00, 36.65),  # æµå—
                                "æ²³å—": (113.65, 34.76),  # éƒ‘å·
                                "å››å·": (104.06, 30.67),  # æˆéƒ½
                                "é™•è¥¿": (108.95, 34.27),  # è¥¿å®‰
                                "æ²³åŒ—": (114.48, 38.03),  # çŸ³å®¶åº„
                                "å±±è¥¿": (112.53, 37.87),  # å¤ªåŸ
                                "è¾½å®": (123.38, 41.80),  # æ²ˆé˜³
                                "å‰æ—": (125.32, 43.88),  # é•¿æ˜¥
                                "é»‘é¾™æ±Ÿ": (126.63, 45.75),  # å“ˆå°”æ»¨
                                "å®‰å¾½": (117.27, 31.86),  # åˆè‚¥
                                "ç¦å»º": (119.30, 26.08),  # ç¦å·
                                "æ±Ÿè¥¿": (115.89, 28.68),  # å—æ˜Œ
                                "æµ·å—": (110.35, 20.02),  # æµ·å£
                                "è´µå·": (106.71, 26.57),  # è´µé˜³
                                "äº‘å—": (102.73, 25.04),  # æ˜†æ˜
                                "ç”˜è‚ƒ": (103.73, 36.03),  # å…°å·
                                "é’æµ·": (101.74, 36.56),  # è¥¿å®
                                "å®å¤": (106.27, 38.47),  # é“¶å·
                                "æ–°ç–†": (87.68, 43.77),  # ä¹Œé²æœ¨é½
                                "è¥¿è—": (91.11, 29.97),  # æ‹‰è¨
                                "å†…è’™å¤": (111.65, 40.82),  # å‘¼å’Œæµ©ç‰¹
                                "å¹¿è¥¿": (108.33, 22.84),  # å—å®
                            }
                            # æ¸…ç†çœä»½åç§°
                            clean_province = province.replace("çœ", "").replace("å¸‚", "").replace("è‡ªæ²»åŒº", "").replace("ç‰¹åˆ«è¡Œæ”¿åŒº", "")
                            if clean_province in province_coordinates:
                                longitude, latitude = province_coordinates[clean_province]
                                print(f"âš ï¸ ç»çº¬åº¦è·å–å¤±è´¥ï¼Œä½¿ç”¨çœä»½é»˜è®¤å€¼ï¼š{clean_province} -> ({longitude}, {latitude})")
                            else:
                                # é™çº§æ–¹æ¡ˆ2ï¼šä½¿ç”¨ä¸œå…«åŒºä¸­å¿ƒç»åº¦ï¼ˆ120åº¦ï¼‰
                                longitude, latitude = 120.0, 35.0  # ä¸œå…«åŒºä¸­å¿ƒï¼Œä¸­å›½ä¸­éƒ¨çº¬åº¦
                                print(f"âš ï¸ ç»çº¬åº¦è·å–å¤±è´¥ï¼Œä½¿ç”¨ä¸œå…«åŒºæ ‡å‡†å€¼ï¼š({longitude}, {latitude})")
                        else:
                            # é™çº§æ–¹æ¡ˆ2ï¼šä½¿ç”¨ä¸œå…«åŒºä¸­å¿ƒç»åº¦ï¼ˆ120åº¦ï¼‰
                            longitude, latitude = 120.0, 35.0  # ä¸œå…«åŒºä¸­å¿ƒï¼Œä¸­å›½ä¸­éƒ¨çº¬åº¦
                            print(f"âš ï¸ ç»çº¬åº¦è·å–å¤±è´¥ï¼Œä½¿ç”¨ä¸œå…«åŒºæ ‡å‡†å€¼ï¼š({longitude}, {latitude})")
                    
                    location_obj = Location(lon=longitude, lat=latitude) if longitude is not None and latitude is not None else None
                    sxtwl_result = compute_bazi_json(
                        year=solar.getYear(),
                        month=solar.getMonth(),
                        day=solar.getDay(),
                        hour=input_hour,
                        minute=input_minute,
                        second=0,
                        tz_offset_hours=8.0,
                        rules=Rules(use_true_solar_time=True),
                        location=location_obj
                    )

                    # æ·»åŠ äº”è¡Œåˆ†å¸ƒè®¡ç®—åˆ°sxtwl_resultä¸­
                    try:
                        sxtwl_pillars = sxtwl_result['pillars']
                        if CLASSIC_ANALYZER_AVAILABLE:
                            # ä½¿ç”¨ç»å…¸åˆ†æå™¨çš„äº”è¡Œåˆ†å¸ƒè®¡ç®—
                            from classic_analyzer.common import compute_wuxing_distribution
                            pillars_for_wuxing = {
                                'year': (sxtwl_pillars['year'][0], sxtwl_pillars['year'][1]),
                                'month': (sxtwl_pillars['month'][0], sxtwl_pillars['month'][1]),
                                'day': (sxtwl_pillars['day'][0], sxtwl_pillars['day'][1]),
                                'hour': (sxtwl_pillars['hour'][0], sxtwl_pillars['hour'][1])
                            }
                            wuxing_dist = compute_wuxing_distribution(pillars_for_wuxing)
                            sxtwl_result['wuxing_distribution'] = wuxing_dist
                        else:
                            # ä½¿ç”¨æœ¬åœ°è®¡ç®—
                            pillars_dict = {
                                'year': [sxtwl_pillars['year'][0], sxtwl_pillars['year'][1]],
                                'month': [sxtwl_pillars['month'][0], sxtwl_pillars['month'][1]],
                                'day': [sxtwl_pillars['day'][0], sxtwl_pillars['day'][1]],
                                'hour': [sxtwl_pillars['hour'][0], sxtwl_pillars['hour'][1]]
                            }
                            wuxing_dist = self.calculate_wuxing_distribution(pillars_dict)
                            sxtwl_result['wuxing_distribution'] = wuxing_dist
                    except Exception as e:
                        print(f"âš ï¸ äº”è¡Œåˆ†å¸ƒè®¡ç®—å¤±è´¥: {e}")
                        # è®¾ç½®é»˜è®¤å€¼é¿å…æ˜¾ç¤ºé”™è¯¯
                        sxtwl_result['wuxing_distribution'] = {'æœ¨': 0, 'ç«': 0, 'åœŸ': 0, 'é‡‘': 0, 'æ°´': 0}

                    pillars = sxtwl_result['pillars']

                    # æ„å»ºè¿”å›ç»“æœ
                    result = {
                        'year_pillar': pillars['year'],
                        'month_pillar': pillars['month'],
                        'day_pillar': pillars['day'],
                        'hour_pillar': pillars['hour'],
                        'day_master': pillars['day'][0],
                        'day_master_element': self.get_wuxing_by_tiangan(pillars['day'][0]),
                        'pillars': {
                            'year': [pillars['year'][0], pillars['year'][1]],
                            'month': [pillars['month'][0], pillars['month'][1]],
                            'day': [pillars['day'][0], pillars['day'][1]],
                            'hour': [pillars['hour'][0], pillars['hour'][1]]
                        },
                        'wuxing_distribution': self.calculate_wuxing_distribution({
                            'year': [pillars['year'][0], pillars['year'][1]],
                            'month': [pillars['month'][0], pillars['month'][1]],
                            'day': [pillars['day'][0], pillars['day'][1]],
                            'hour': [pillars['hour'][0], pillars['hour'][1]]
                        }),
                        'bazi_pattern': {
                            'pattern_type': 'æœ¬åœ°è®¡ç®—æ ¼å±€',
                            'pattern_description': 'åŸºäºæœ¬åœ°ç®—æ³•çš„ç®€åŒ–æ ¼å±€åˆ†æ'
                        },
                        'ten_gods': self.calculate_ten_gods_simple(pillars['day'][0], {
                            'year': [pillars['year'][0], pillars['year'][1]],
                            'month': [pillars['month'][0], pillars['month'][1]],
                            'day': [pillars['day'][0], pillars['day'][1]],
                            'hour': [pillars['hour'][0], pillars['hour'][1]]
                        }),
                        'birth_info': {
                            'year': year,
                            'month': month,
                            'day': day,
                            'hour_index': hour_index,
                            'gender': gender,
                            'name': name,
                            'solar_year': solar.getYear(),
                            'solar_month': solar.getMonth(),
                            'solar_day': solar.getDay(),
                            'solar_hour': input_hour,
                            'solar_minute': input_minute,
                            'lunar_month': month,
                            'lunar_day': day,
                            'is_leap': is_leap,
                            'province': province,
                            'city': city,
                            'longitude': longitude,
                            'latitude': latitude
                        }
                    }

                    print(f"âœ… æœ¬åœ°å…«å­—è®¡ç®—æˆåŠŸ: {result['year_pillar']} {result['month_pillar']} {result['day_pillar']} {result['hour_pillar']}")
                    self.last_birth_info = result.get('birth_info', {})
                    return result

                except Exception as e:
                    print(f"âŒ sxtwlæœ¬åœ°è®¡ç®—å¤±è´¥: {e}")

            # å›é€€åˆ° lunar-python ç®€å•è®¡ç®—
            try:
                from lunar_python import Lunar
                lunar_month = self._normalize_lunar_month(year, month, is_leap)
                lunar = Lunar.fromYmdHms(year, lunar_month, day, 1, 30, 0)

                year_gan_zhi = lunar.getYearInGanZhi()
                month_gan_zhi = lunar.getMonthInGanZhi()
                day_gan_zhi = lunar.getDayInGanZhi()
                hour_gan_zhi = lunar.getTimeInGanZhi()

                # è§£æå¹²æ”¯
                def parse_ganzhi(ganzhi):
                    return [ganzhi[0], ganzhi[1]]

                pillars_dict = {
                    'year': parse_ganzhi(year_gan_zhi),
                    'month': parse_ganzhi(month_gan_zhi),
                    'day': parse_ganzhi(day_gan_zhi),
                    'hour': parse_ganzhi(hour_gan_zhi)
                }

                day_master = pillars_dict['day'][0]

                result = {
                    'year_pillar': year_gan_zhi,
                    'month_pillar': month_gan_zhi,
                    'day_pillar': day_gan_zhi,
                    'hour_pillar': hour_gan_zhi,
                    'day_master': day_master,
                    'day_master_element': self.get_wuxing_by_tiangan(day_master),
                    'pillars': pillars_dict,
                    'wuxing_distribution': self.calculate_wuxing_distribution(pillars_dict),
                    'bazi_pattern': {
                        'pattern_type': 'lunar-pythonç®€åŒ–æ ¼å±€',
                        'pattern_description': 'åŸºäºlunar-pythonçš„ç®€åŒ–æ ¼å±€åˆ†æ'
                    },
                    'ten_gods': self.calculate_ten_gods_simple(day_master, pillars_dict),
                    'birth_info': {
                        'year': year,
                        'month': month,
                        'day': day,
                        'hour_index': hour_index,
                        'gender': gender,
                        'name': name,
                        'solar_year': solar.getYear(),
                        'solar_month': solar.getMonth(),
                        'solar_day': solar.getDay(),
                        'solar_hour': input_hour,
                        'solar_minute': input_minute,
                        'lunar_month': month,
                        'lunar_day': day,
                        'is_leap': is_leap,
                        'province': province,
                        'city': city,
                        'longitude': longitude,
                        'latitude': latitude
                    }
                }

                print(f"âœ… lunar-pythonæœ¬åœ°è®¡ç®—æˆåŠŸ: {result['year_pillar']} {result['month_pillar']} {result['day_pillar']} {result['hour_pillar']}")
                self.last_birth_info = result.get('birth_info', {})
                return result

            except Exception as e:
                print(f"âŒ lunar-pythonè®¡ç®—å¤±è´¥: {e}")

            # æœ€åçš„å›é€€æ–¹æ¡ˆ
            return self.get_fallback_bazi_result(year, month, day, hour_index, gender, name)

        except Exception as e:
            print(f"âŒ æœ¬åœ°å…«å­—è®¡ç®—å®Œå…¨å¤±è´¥: {e}")
            return self.get_fallback_bazi_result(year, month, day, hour_index, gender, name)

    def calculate_ten_gods_simple(self, day_master, pillars_dict):
        """ç®€åŒ–çš„åç¥è®¡ç®—"""
        try:
            tiangan_wuxing = self.get_tiangan_wuxing_info()
            ten_gods = {}

            for position, (tg, dz) in pillars_dict.items():
                if position != 'day':  # æ—¥ä¸»ä¸è®¡ç®—åç¥
                    ten_god = self.get_ten_god_relation(tg, day_master, tiangan_wuxing)
                    ten_gods[position] = ten_god

            return ten_gods
        except Exception as e:
            print(f"åç¥è®¡ç®—å¤±è´¥: {e}")
            return {}

    def get_fallback_bazi_result(self, year, month, day, hour_index, gender, name):
        """Fallback å·²åºŸå¼ƒï¼šç»Ÿä¸€æŠ›å‡ºå¼‚å¸¸æé†’ç”¨æˆ·é‡æ–°è®¡ç®—ã€‚"""
        raise RuntimeError("å…«å­—è®¡ç®—å¤±è´¥ï¼Œæœªç”Ÿæˆå‘½ç›˜ï¼Œè¯·æ£€æŸ¥è¾“å…¥å‚æ•°åé‡è¯•ã€‚")

    def call_deepseek_api(self, prompt):
        """è°ƒç”¨DeepSeek API"""
        headers = {
            'Authorization': f'Bearer {self.api_key}',
            'Content-Type': 'application/json'
        }

        data = {
            "model": "deepseek-chat",
            "messages": [
                {"role": "system", "content": "ä½ æ˜¯ä¸€ä½ç²¾é€šä¸­å›½ä¼ ç»Ÿå‘½ç†å­¦çš„å¤§å¸ˆï¼Œæ“…é•¿å…«å­—åˆ†æã€äº”è¡Œç†è®ºã€åç¥æ¨ç®—ç­‰ã€‚è¯·ç”¨ä¸“ä¸šã€å‡†ç¡®ã€è¯¦ç»†çš„æ–¹å¼è¿›è¡Œå‘½ç†åˆ†æã€‚"},
                {"role": "user", "content": prompt}
            ],
            "temperature": 0.3,
            "max_tokens": 4000
        }

        response = requests.post(
            'https://api.deepseek.com/chat/completions',
            headers=headers,
            json=data,
            timeout=240  # ğŸ”¥ ä¿®å¤ï¼šDeepSeekéœ€è¦200ç§’ä»¥ä¸Š
        )

        if response.status_code == 200:
            result = response.json()
            return result['choices'][0]['message']['content']
        else:
            raise Exception(f"APIè°ƒç”¨å¤±è´¥: {response.status_code}")



    def merge_ai_results(self, ai_results):
        """èåˆå¤šä¸ªAIçš„åˆ†æç»“æœ"""
        successful_results = {k: v for k, v in ai_results.items() if v['status'] == 'success' and v['content']}

        if not successful_results:
            return "æŠ±æ­‰ï¼Œæ‰€æœ‰AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚"

        # é‡æ–°è®¡ç®—æƒé‡ï¼ˆåªè€ƒè™‘æˆåŠŸçš„AIï¼‰
        total_weight = sum(result['weight'] for result in successful_results.values())
        if total_weight > 0:
            for result in successful_results.values():
                result['normalized_weight'] = result['weight'] / total_weight

        # ç”Ÿæˆèåˆç»“æœ
        merged_content = "ğŸ¤– å¤šAIååŒåˆ†æç»“æœ\n"
        merged_content += "=" * 50 + "\n\n"

        # æŒ‰æƒé‡æ’åº
        sorted_results = sorted(successful_results.items(), key=lambda x: x[1]['normalized_weight'], reverse=True)

        # ä¸»è¦åˆ†æï¼ˆæƒé‡æœ€é«˜çš„AIï¼‰
        main_ai, main_result = sorted_results[0]
        merged_content += f"ã€ä¸»è¦åˆ†æã€‘æ¥æºï¼š{main_ai.upper()}\n"
        merged_content += main_result['content'] + "\n\n"

        # è¡¥å……è§‚ç‚¹ï¼ˆå…¶ä»–AIçš„ä¸åŒè§è§£ï¼‰
        if len(sorted_results) > 1:
            merged_content += "ã€è¡¥å……è§‚ç‚¹ã€‘\n"
            for ai_name, result in sorted_results[1:]:
                merged_content += f"\nğŸ’¡ {ai_name.upper()}è¡¥å……ï¼š\n"
                # æå–å…³é”®ä¸åŒè§‚ç‚¹ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œåªå–å‰200å­—ï¼‰
                supplement = result['content'][:200] + "..." if len(result['content']) > 200 else result['content']
                merged_content += supplement + "\n"

        # æ·»åŠ AIååŒä¿¡æ¯
        merged_content += f"\nğŸ“Š æœ¬æ¬¡åˆ†æä½¿ç”¨äº† {len(successful_results)} ä¸ªAIæ¨¡å‹ååŒè®¡ç®—\n"
        merged_content += "ğŸ¯ ç»“æœç»è¿‡æ™ºèƒ½èåˆå¤„ç†ï¼Œæé«˜äº†åˆ†æçš„å‡†ç¡®æ€§å’Œå…¨é¢æ€§\n"

        return merged_content

    def merge_ai_results_simple(self, ai_results):
        """æ˜¾ç¤ºæ‰€æœ‰AIåˆ†æç»“æœ - å®Œæ•´æ˜¾ç¤ºä¸‰ä¸ªAIçš„å†…å®¹ï¼ˆåŒ…æ‹¬å¤±è´¥çš„ï¼‰"""
        # ğŸ”¥ æ–°é€»è¾‘ï¼šæ˜¾ç¤ºæ‰€æœ‰AIçš„ç»“æœï¼ŒåŒ…æ‹¬æˆåŠŸå’Œå¤±è´¥çš„
        merged_content = ""

        # æŒ‰ç…§å›ºå®šé¡ºåºæ˜¾ç¤ºï¼šDeepSeek -> æ–‡å¿ƒä¸€è¨€ -> é€šä¹‰åƒé—®
        ai_order = ['deepseek', 'wenxin', 'tongyi']
        ai_names = {
            'deepseek': 'DeepSeek AI åˆ†æ',
            'wenxin': 'æ–‡å¿ƒä¸€è¨€ AI åˆ†æ',
            'tongyi': 'é€šä¹‰åƒé—® AI åˆ†æ'
        }

        for ai_key in ai_order:
            if ai_key in ai_results:
                ai_name = ai_names[ai_key]
                result = ai_results[ai_key]

                merged_content += f"\n{'='*60}\n"
                merged_content += f"ğŸ¤– {ai_name}\n"
                merged_content += f"{'='*60}\n\n"

                # æ˜¾ç¤ºå†…å®¹ï¼Œæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥
                if result['status'] == 'success' and result['content']:
                    merged_content += result['content'] + "\n\n"
                elif result['status'] in ['failed_but_show', 'disabled_but_show'] and result['content']:
                    merged_content += result['content'] + "\n\n"
                else:
                    merged_content += f"âŒ {ai_name}æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚\n\n"

        # å¦‚æœæ‰€æœ‰AIéƒ½å¤±è´¥äº†
        if not any(result.get('content') for result in ai_results.values()):
            return "æŠ±æ­‰ï¼Œæ‰€æœ‰åˆ†ææœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚"

        return merged_content

    def create_clean_fusion_report(self, successful_results):
        """åˆ›å»ºåŸºäºå¤šæ•°ä¸€è‡´æ€§éªŒè¯çš„èåˆæŠ¥å‘Š"""
        # ğŸ”¥ æ–°å¢ï¼šåŸºäºä½ çš„éœ€æ±‚ï¼Œå®ç°ä¸‰AIç›¸äº’éªŒè¯æœºåˆ¶
        # è§„åˆ™ï¼š2ä¸ªæˆ–3ä¸ªAIç›¸åŒçš„ç»“è®ºè®¤ä¸ºæ˜¯æ­£ç¡®çš„
        # DeepSeekå’Œæ–‡å¿ƒä¸€è¨€æ¯”è¾ƒå‡†ç¡®ï¼Œé€šä¹‰åƒé—®æœ‰æ˜æ˜¾é”™è¯¯

        # è·å–ä¸‰ä¸ªAIçš„åˆ†æç»“æœ
        deepseek_content = successful_results.get('deepseek', {}).get('content', '')
        wenxin_content = successful_results.get('wenxin', {}).get('content', '')
        tongyi_content = successful_results.get('tongyi', {}).get('content', '')

        # å¦‚æœåªæœ‰ä¸€ä¸ªAIæœ‰ç»“æœï¼Œç›´æ¥è¿”å›
        available_ais = [ai for ai in ['deepseek', 'wenxin', 'tongyi'] if successful_results.get(ai, {}).get('content')]
        if len(available_ais) == 1:
            return successful_results[available_ais[0]]['content']

        # ğŸ”¥ å®ç°å¤šæ•°ä¸€è‡´æ€§éªŒè¯
        return self.build_consensus_report(deepseek_content, wenxin_content, tongyi_content, available_ais)

    def build_consensus_report(self, deepseek_content, wenxin_content, tongyi_content, available_ais):
        """æ„å»ºåŸºäºå¤šæ•°ä¸€è‡´æ€§çš„éªŒè¯æŠ¥å‘Š"""
        # ğŸ”¥ é™é»˜éªŒè¯ï¼Œä¸æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯

        # è§£æå„AIçš„å…³é”®åˆ¤æ–­ï¼ˆé™é»˜ï¼‰
        deepseek_judgments = self.extract_key_judgments(deepseek_content, 'DeepSeek') if deepseek_content else {}
        wenxin_judgments = self.extract_key_judgments(wenxin_content, 'æ–‡å¿ƒä¸€è¨€') if wenxin_content else {}
        tongyi_judgments = self.extract_key_judgments(tongyi_content, 'é€šä¹‰åƒé—®') if tongyi_content else {}

        # è¿›è¡Œä¸€è‡´æ€§éªŒè¯ï¼ˆé™é»˜ï¼‰
        consensus_results = self.perform_consensus_validation(deepseek_judgments, wenxin_judgments, tongyi_judgments)

        # æ„å»ºéªŒè¯æŠ¥å‘Š
        return self.assemble_consensus_report(deepseek_content, wenxin_content, tongyi_content, consensus_results, available_ais)

    def extract_key_judgments(self, content, ai_name):
        """æå–AIåˆ†æä¸­çš„å…³é”®åˆ¤æ–­"""
        judgments = {
            'day_master_strength': '',  # æ—¥ä¸»å¼ºå¼±
            'useful_god': '',          # ç”¨ç¥
            'avoid_god': '',           # å¿Œç¥
            'wealth_level': '',        # è´¢è¿ç­‰çº§
            'career_direction': '',    # äº‹ä¸šæ–¹å‘
            'marriage_timing': '',     # å©šå§»æ—¶é—´
            'health_risks': '',        # å¥åº·é£é™©
            'lucky_years': '',         # å¹¸è¿å¹´ä»½
            'pattern_type': ''         # æ ¼å±€ç±»å‹
        }

        lines = content.split('\n')
        for line in lines:
            line = line.strip()

            # æ—¥ä¸»å¼ºå¼±åˆ¤æ–­
            if any(keyword in line for keyword in ['æ—¥ä¸»', 'åå¼º', 'åå¼±', 'ä¸­å’Œ', 'å¤ªæ—º', 'å¤ªå¼±']):
                if 'åå¼º' in line or 'å¤ªæ—º' in line:
                    judgments['day_master_strength'] = 'åå¼º'
                elif 'åå¼±' in line or 'å¤ªå¼±' in line:
                    judgments['day_master_strength'] = 'åå¼±'
                elif 'ä¸­å’Œ' in line:
                    judgments['day_master_strength'] = 'ä¸­å’Œ'

            # ç”¨ç¥å¿Œç¥
            if 'ç”¨ç¥' in line and ('æœ¨' in line or 'ç«' in line or 'åœŸ' in line or 'é‡‘' in line or 'æ°´' in line):
                judgments['useful_god'] = self.extract_elements_from_line(line)
            if 'å¿Œç¥' in line and ('æœ¨' in line or 'ç«' in line or 'åœŸ' in line or 'é‡‘' in line or 'æ°´' in line):
                judgments['avoid_god'] = self.extract_elements_from_line(line)

            # è´¢è¿ç­‰çº§
            if any(keyword in line for keyword in ['è´¢è¿', 'è´¢å¯Œ']) and any(indicator in line for indicator in ['ç­‰çº§', 'æ°´å¹³', 'ç¨‹åº¦', 'å¼ºå¼±']):
                judgments['wealth_level'] = line

            # äº‹ä¸šæ–¹å‘
            if any(keyword in line for keyword in ['é€‚åˆ', 'è¡Œä¸š', 'èŒä¸š']) and len(line) < 100:
                judgments['career_direction'] = line

            # å©šå§»æ—¶é—´
            if any(keyword in line for keyword in ['ç»“å©š', 'å©šå§»']) and any(time in line for time in ['å¹´', 'å²']):
                judgments['marriage_timing'] = line

        # ğŸ”¥ é™é»˜è¿”å›ï¼Œä¸æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        return judgments

    def extract_elements_from_line(self, line):
        """ä»æ–‡æœ¬è¡Œä¸­æå–äº”è¡Œå…ƒç´ """
        elements = []
        for element in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']:
            if element in line:
                elements.append(element)
        return 'ã€'.join(elements)

    def perform_consensus_validation(self, deepseek_judgments, wenxin_judgments, tongyi_judgments):
        """æ‰§è¡Œä¸€è‡´æ€§éªŒè¯ - 2ä¸ªæˆ–3ä¸ªç›¸åŒçš„åˆ¤æ–­è®¤ä¸ºæ­£ç¡®"""
        consensus_results = {}
        all_judgments = [deepseek_judgments, wenxin_judgments, tongyi_judgments]
        ai_names = ['DeepSeek', 'æ–‡å¿ƒä¸€è¨€', 'é€šä¹‰åƒé—®']

        # å¯¹æ¯ä¸ªå…³é”®åˆ¤æ–­è¿›è¡ŒæŠ•ç¥¨
        for key in deepseek_judgments.keys():
            votes = {}
            ai_votes = {}

            for i, judgments in enumerate(all_judgments):
                if judgments and key in judgments and judgments[key]:
                    value = judgments[key]
                    if value not in votes:
                        votes[value] = 0
                        ai_votes[value] = []
                    votes[value] += 1
                    ai_votes[value].append(ai_names[i])

            # æ‰¾å‡ºå¾—ç¥¨æœ€å¤šçš„åˆ¤æ–­
            if votes:
                max_votes = max(votes.values())
                consensus_value = None
                consensus_ais = []

                for value, vote_count in votes.items():
                    if vote_count == max_votes:
                        consensus_value = value
                        consensus_ais = ai_votes[value]
                        break

                # ğŸ”¥ å…³é”®é€»è¾‘ï¼š2ä¸ªæˆ–3ä¸ªAIä¸€è‡´æ‰è®¤ä¸ºå¯ä¿¡
                if max_votes >= 2:
                    confidence = "é«˜" if max_votes == 3 else "ä¸­"
                    # ğŸ”¥ ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœé€šä¹‰åƒé—®å•ç‹¬ä¸€ç¥¨ï¼Œé™ä½å¯ä¿¡åº¦
                    if max_votes == 1 and 'é€šä¹‰åƒé—®' in consensus_ais:
                        confidence = "ä½"
                        consensus_results[key] = {
                            'value': consensus_value,
                            'confidence': confidence,
                            'supporting_ais': consensus_ais,
                            'note': 'ä»…é€šä¹‰åƒé—®æ”¯æŒï¼Œå¯ä¿¡åº¦è¾ƒä½'
                        }
                    else:
                        consensus_results[key] = {
                            'value': consensus_value,
                            'confidence': confidence,
                            'supporting_ais': consensus_ais,
                            'note': f'{len(consensus_ais)}ä¸ªAIä¸€è‡´è®¤ä¸º'
                        }
                else:
                    # æ²¡æœ‰ä¸€è‡´æ€§ï¼Œæ ‡è®°ä¸ºåˆ†æ­§
                    consensus_results[key] = {
                        'value': 'å­˜åœ¨åˆ†æ­§',
                        'confidence': 'ä½',
                        'supporting_ais': [],
                        'note': 'å„AIåˆ¤æ–­ä¸ä¸€è‡´'
                    }

        # ğŸ”¥ é™é»˜è¿”å›éªŒè¯ç»“æœï¼Œä¸æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        return consensus_results

    def assemble_consensus_report(self, deepseek_content, wenxin_content, tongyi_content, consensus_results, available_ais):
        """ç»„è£…åŸºäºä¸€è‡´æ€§éªŒè¯çš„æŠ¥å‘Š - åªæ˜¾ç¤ºçº¯å‡€çš„åˆ†æå†…å®¹"""

        # ğŸ”¥ æ ¹æ®ä½ çš„è¦æ±‚ï¼šä¸æ˜¾ç¤ºéªŒè¯è¿‡ç¨‹ï¼Œç›´æ¥æ˜¾ç¤ºæœ€ç»ˆåˆ†æå†…å®¹

        # ğŸ”¥ ä¿®æ­£ï¼šç›´æ¥ä½¿ç”¨éªŒè¯åçš„æœ€å‡†ç¡®ç»“æœï¼Œä¸è¿›è¡Œé¢å¤–æå–
        # ä¼˜å…ˆé¡ºåºï¼šé€‰æ‹©è´¨é‡æœ€å¥½çš„å•ä¸€AIç»“æœ
        if deepseek_content:
            # DeepSeekç»“æœå¯ç”¨ï¼Œç›´æ¥ä½¿ç”¨ï¼ˆå·²ç»è¿‡ä¸‰AIéªŒè¯ï¼‰
            report = self.clean_analysis_content(deepseek_content)
        elif wenxin_content:
            # æ–‡å¿ƒä¸€è¨€ç»“æœå¯ç”¨ï¼Œç›´æ¥ä½¿ç”¨
            report = self.clean_analysis_content(wenxin_content)
        elif tongyi_content:
            # é€šä¹‰åƒé—®ç»“æœå¯ç”¨ï¼Œç›´æ¥ä½¿ç”¨
            report = self.clean_analysis_content(tongyi_content)
        else:
            report = "æš‚æ— å¯ç”¨çš„åˆ†æç»“æœã€‚"

        return report

    def clean_analysis_content(self, content):
        """æ¸…ç†åˆ†æå†…å®¹ï¼Œå»é™¤è°ƒè¯•ä¿¡æ¯å’Œä¸ç›¸å…³å†…å®¹"""
        if not content:
            return ""

        lines = content.split('\n')
        cleaned_lines = []

        # éœ€è¦è¿‡æ»¤çš„è°ƒè¯•ä¿¡æ¯å…³é”®è¯
        debug_keywords = [
            'ğŸ”§', 'ğŸ“¡', 'ğŸ“Š', 'ğŸ”', 'ğŸš€', 'âœ…', 'âŒ', 'âš ï¸',
            'APIè°ƒç”¨', 'å“åº”çŠ¶æ€', 'è¯·æ±‚æ•°æ®', 'è°ƒè¯•', 'æµ‹è¯•',
            'åˆ†æä¾æ®', 'å¯¹æ¯”ä¾æ®', 'éªŒè¯è¿‡ç¨‹', 'è®¡ç®—è¿‡ç¨‹'
        ]

        for line in lines:
            line = line.strip()

            # è·³è¿‡ç©ºè¡Œ
            if not line:
                continue

            # è·³è¿‡è°ƒè¯•ä¿¡æ¯
            if any(keyword in line for keyword in debug_keywords):
                continue

            # è·³è¿‡çº¯æŠ€æœ¯è¯´æ˜
            if line.startswith('ã€') and any(tech in line for tech in ['API', 'è°ƒè¯•', 'æµ‹è¯•', 'éªŒè¯']):
                continue

            cleaned_lines.append(line)

        return '\n'.join(cleaned_lines)



    def build_validated_fusion_report(self, primary_ai, cultural_ai, validator_ai):
        """æ„å»ºç»è¿‡éªŒè¯çš„èåˆæŠ¥å‘Š"""
        if not primary_ai:
            return "åˆ†ææœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚"

        # è·å–DeepSeekçš„ä¸»ä½“åˆ†æ
        primary_content = primary_ai[1]['content']
        main_sections = self.parse_clean_sections(primary_content)

        # è·å–æ–‡å¿ƒä¸€è¨€çš„ä¼ ç»Ÿæ–‡åŒ–è¡¥å……
        cultural_supplements = {}
        if cultural_ai:
            cultural_content = cultural_ai[1]['content']
            cultural_sections = self.parse_clean_sections(cultural_content)
            cultural_supplements = self.extract_cultural_insights(cultural_sections)

        # é€šä¹‰åƒé—®äº¤å‰éªŒè¯
        validation_results = {}
        if validator_ai:
            validator_content = validator_ai[1]['content']
            validation_results = self.perform_cross_validation(primary_content, cultural_ai[1]['content'] if cultural_ai else "", validator_content)

        # æ„å»ºæœ€ç»ˆæŠ¥å‘Š
        return self.assemble_final_report(main_sections, cultural_supplements, validation_results)

    def extract_cultural_insights(self, cultural_sections):
        """æå–ä¼ ç»Ÿæ–‡åŒ–è§‚ç‚¹"""
        insights = {}
        cultural_keywords = ['ä¼ ç»Ÿ', 'æ–‡åŒ–', 'ç»å…¸', 'å¤æ³•', 'å…¸ç±', 'å“å¾·', 'ä¿®å…»', 'å¾·è¡Œ', 'ä»ä¹‰', 'ç¤¼ä»ª']

        for section_name, section_content in cultural_sections.items():
            section_insights = []
            lines = section_content.split('\n')

            for line in lines:
                line = line.strip()
                if any(keyword in line for keyword in cultural_keywords):
                    clean_line = line.replace('â€¢', '').replace('-', '').strip()
                    if len(clean_line) > 10:
                        section_insights.append(clean_line)

                if len(section_insights) >= 2:  # æ¯ä¸ªç« èŠ‚æœ€å¤š2ä¸ªæ–‡åŒ–è§‚ç‚¹
                    break

            if section_insights:
                insights[section_name] = section_insights

        return insights

    def perform_cross_validation(self, primary_content, cultural_content, validator_content):
        """é€šä¹‰åƒé—®äº¤å‰éªŒè¯"""
        validation_results = {
            'accuracy_check': '',
            'logic_check': '',
            'consistency_check': ''
        }

        # æå–éªŒè¯è§‚ç‚¹
        validator_lines = [line.strip() for line in validator_content.split('\n') if line.strip()]

        # å¯»æ‰¾éªŒè¯æ€§è¯­å¥
        validation_keywords = ['éªŒè¯', 'ç¡®è®¤', 'ç¬¦åˆ', 'å‡†ç¡®', 'é€»è¾‘', 'åˆç†', 'ç§‘å­¦', 'å®¢è§‚']
        accuracy_keywords = ['æ­£ç¡®', 'å‡†ç¡®', 'ç²¾ç¡®', 'å¯é ']
        logic_keywords = ['é€»è¾‘', 'æ¨ç†', 'åˆ†æ', 'åˆ¤æ–­']

        for line in validator_lines:
            if any(keyword in line for keyword in accuracy_keywords):
                if not validation_results['accuracy_check']:
                    validation_results['accuracy_check'] = line
            elif any(keyword in line for keyword in logic_keywords):
                if not validation_results['logic_check']:
                    validation_results['logic_check'] = line
            elif any(keyword in line for keyword in validation_keywords):
                if not validation_results['consistency_check']:
                    validation_results['consistency_check'] = line

        return validation_results

    def assemble_final_report(self, main_sections, cultural_supplements, validation_results):
        """ç»„è£…æœ€ç»ˆæŠ¥å‘Š"""
        report = ""

        for section_name, section_content in main_sections.items():
            # æ˜¾ç¤ºä¸»ä½“åˆ†æï¼ˆDeepSeek 70%ï¼‰
            report += f"{section_name}\n"
            report += section_content

            # æ·»åŠ ä¼ ç»Ÿæ–‡åŒ–è¡¥å……ï¼ˆæ–‡å¿ƒä¸€è¨€ 30%ï¼‰
            if section_name in cultural_supplements:
                report += "\n"
                for insight in cultural_supplements[section_name]:
                    report += f"â€¢ {insight}\n"

            # éªŒè¯ä¿¡æ¯å·²èå…¥åˆ†æå†…å®¹ï¼Œä¸å•ç‹¬æ˜¾ç¤º

            report += "\n\n"

        return report.strip()

    def get_validation_note(self, validation_results):
        """è·å–éªŒè¯è¯´æ˜"""
        # é€‰æ‹©æœ€æœ‰ä»·å€¼çš„éªŒè¯ä¿¡æ¯
        for check_type, check_result in validation_results.items():
            if check_result and len(check_result) > 10:
                # ç®€åŒ–éªŒè¯ä¿¡æ¯ï¼Œå»æ‰æŠ€æœ¯æœ¯è¯­
                clean_validation = check_result.replace('é€šä¹‰åƒé—®', '').replace('éªŒè¯', '').strip()
                if clean_validation:
                    return f"ç»éªŒè¯ï¼š{clean_validation}"
        return ""

    def parse_clean_sections(self, content):
        """è§£æå†…å®¹ç« èŠ‚ - çº¯å‡€ç‰ˆæœ¬"""
        sections = {}
        lines = content.split('\n')
        current_section = "ç»¼åˆåˆ†æ"
        current_content = []

        for line in lines:
            line = line.strip()
            if not line:
                continue

            # æ£€æµ‹ç« èŠ‚æ ‡é¢˜ï¼ˆä¸€ã€äºŒã€ä¸‰ç­‰ï¼‰
            if any(marker in line for marker in ["ä¸€ã€", "äºŒã€", "ä¸‰ã€", "å››ã€", "äº”ã€", "å…­ã€", "ä¸ƒã€", "å…«ã€", "ä¹ã€", "åã€"]):
                # ä¿å­˜å‰ä¸€ä¸ªç« èŠ‚
                if current_content:
                    sections[current_section] = '\n'.join(current_content)
                # å¼€å§‹æ–°ç« èŠ‚
                current_section = line
                current_content = []
            else:
                current_content.append(line)

        # ä¿å­˜æœ€åä¸€ä¸ªç« èŠ‚
        if current_content:
            sections[current_section] = '\n'.join(current_content)

        return sections

    def extract_supplementary_insights(self, successful_results, primary_ai):
        """æå–å…¶ä»–AIçš„è¡¥å……è§‚ç‚¹"""
        supplements = {}

        for ai_name, result in successful_results.items():
            if ai_name == primary_ai:
                continue

            ai_sections = self.parse_clean_sections(result['content'])

            for section_name, section_content in ai_sections.items():
                if section_name not in supplements:
                    supplements[section_name] = []

                # æå–å…³é”®è§‚ç‚¹ï¼Œé¿å…é‡å¤
                key_insights = self.extract_key_insights_clean(section_content)
                if key_insights:
                    supplements[section_name].extend(key_insights)

        return supplements

    def extract_key_insights_clean(self, content):
        """æå–å…³é”®è§‚ç‚¹ - çº¯å‡€ç‰ˆæœ¬"""
        lines = [line.strip() for line in content.split('\n') if line.strip()]
        insights = []

        for line in lines:
            # å¯»æ‰¾æœ‰ä»·å€¼çš„è§‚ç‚¹ï¼ˆåŒ…å«å»ºè®®ã€ç‰¹ç‚¹ã€åˆ†æç­‰ï¼‰
            if any(keyword in line for keyword in ['å»ºè®®', 'é€‚åˆ', 'æ³¨æ„', 'å®œ', 'å¿Œ', 'ç‰¹ç‚¹', 'ä¼˜åŠ¿', 'ä¸è¶³', 'éœ€è¦']):
                # æ¸…ç†æ ¼å¼ç¬¦å·
                clean_line = line.replace('â€¢', '').replace('-', '').replace('*', '').strip()
                if len(clean_line) > 10 and clean_line not in insights:
                    insights.append(clean_line)

            if len(insights) >= 3:  # é™åˆ¶æ•°é‡
                break

        return insights

    def build_clean_report(self, main_sections, supplements):
        """æ„å»ºçº¯å‡€çš„èåˆæŠ¥å‘Š"""
        report = ""

        for section_name, section_content in main_sections.items():
            # æ˜¾ç¤ºç« èŠ‚æ ‡é¢˜å’Œå†…å®¹
            report += f"{section_name}\n"
            report += section_content

            # å¦‚æœæœ‰è¡¥å……è§‚ç‚¹ï¼Œè‡ªç„¶èå…¥
            if section_name in supplements and supplements[section_name]:
                report += "\n"
                for insight in supplements[section_name]:
                    report += f"â€¢ {insight}\n"

            report += "\n\n"

        return report.strip()

    def format_analysis_error(self, module_name, error_msg, analyzer_name=""):
        """
        ç»Ÿä¸€çš„å…­ä¹¦åº“åˆ†æé”™è¯¯æç¤ºæ ¼å¼ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
        """
        error_text = f"ã€{module_name}ã€‘\n"
        error_text += f"â€¢ âš ï¸ å…­ä¹¦åº“åˆ†æå¤±è´¥ï¼š{error_msg}\n"
        if analyzer_name:
            error_text += f"â€¢ åˆ†æå™¨ï¼š{analyzer_name}\n"
        error_text += "â€¢ å¯èƒ½åŸå› ï¼š\n"
        error_text += "  1. å…­ä¹¦åº“æœªæ­£ç¡®å®‰è£…\n"
        error_text += "  2. æ•°æ®æ ¼å¼ä¸æ­£ç¡®\n"
        error_text += "  3. åˆ†æå™¨å†…éƒ¨é”™è¯¯\n"
        error_text += "â€¢ å»ºè®®ï¼š\n"
        error_text += "  1. æ£€æŸ¥å®‰è£…ï¼špip list | grep chinese-metaphysics-library\n"
        error_text += "  2. é‡æ–°å®‰è£…ï¼špip install --upgrade chinese_metaphysics_library\n"
        error_text += "  3. æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯\n"
        error_text += "\n"
        return error_text

    def calculate_bazi_locally(self, year, month, day, hour_index, gender, name="æœªæä¾›", is_leap=False):
        """æœ¬åœ°å…«å­—è®¡ç®—æ–¹æ³• - å®Œå…¨æœ¬åœ°åŒ–ï¼Œä¸ä¾èµ–ä»»ä½•API"""
        from datetime import datetime  # ç¡®ä¿datetimeå¯ç”¨

        print(f"âœ¨ å¼€å§‹æœ¬åœ°å…«å­—åˆ†æ: {year}å¹´{month}æœˆ{day}æ—¥ æ—¶è¾°{hour_index} {gender}")

        try:
            # 1. ä½¿ç”¨ sxtwl è®¡ç®—å››æŸ±
            if not SXTWL_AVAILABLE:
                return self.get_fallback_bazi_result(year, month, day, hour_index, gender, name)

            from lunar_python import Lunar, Solar

            # æ—¶è¾°è½¬æ¢
            hour_map = {0: (23, 30), 1: (1, 30), 2: (3, 30), 3: (5, 30), 4: (7, 30), 5: (9, 30),
                       6: (11, 30), 7: (13, 30), 8: (15, 30), 9: (17, 30), 10: (19, 30), 11: (21, 30)}
            input_hour, input_minute = hour_map.get(hour_index, (1, 30))

            # è·å–ç²¾ç¡®æ—¶é—´ï¼ˆå¦‚æœç•Œé¢æœ‰æä¾›ï¼‰
            try:
                if hasattr(self, 'precise_hour') and hasattr(self, 'precise_minute'):
                    input_hour = self.precise_hour.value()
                    input_minute = self.precise_minute.value()
                    print(f"âœ“ ä½¿ç”¨ç•Œé¢ç²¾ç¡®æ—¶é—´: {input_hour}:{input_minute}")
            except Exception:
                pass

            # å†œå†è½¬å…¬å†
            lunar_month = self._normalize_lunar_month(year, month, is_leap)
            lunar = Lunar.fromYmdHms(year, lunar_month, day, input_hour, input_minute, 0)
            solar = lunar.getSolar()

            # è·å–å‡ºç”Ÿåœ°ç»çº¬åº¦
            province = None
            city = None
            try:
                if hasattr(self, 'analysis_params'):
                    province = self.analysis_params.get('province')
                    city = self.analysis_params.get('city')
                if (not province or not city) and hasattr(self, 'birth_province') and hasattr(self, 'birth_city'):
                    province = self.birth_province.currentText()
                    city = self.birth_city.currentText()
            except Exception:
                pass
            longitude, latitude, _ = self._get_birth_location(province, city)
            # âœ… ä¿®å¤ï¼šå¦‚æœç»çº¬åº¦è·å–å¤±è´¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆï¼ˆä¸ç¬¬8422è¡Œé€»è¾‘ä¸€è‡´ï¼‰
            if longitude is None or latitude is None:
                if province:
                    clean_province = province.replace("çœ", "").replace("å¸‚", "").replace("è‡ªæ²»åŒº", "").replace("ç‰¹åˆ«è¡Œæ”¿åŒº", "")
                    province_coordinates = {
                        "æ¹–å—": (112.98, 28.2), "æ¹–åŒ—": (114.31, 30.52), "å¹¿ä¸œ": (113.27, 23.13),
                        "æµ™æ±Ÿ": (120.19, 30.26), "æ±Ÿè‹": (118.78, 32.04), "å±±ä¸œ": (117.00, 36.65),
                        "æ²³å—": (113.65, 34.76), "å››å·": (104.06, 30.67), "é™•è¥¿": (108.95, 34.27),
                        "æ²³åŒ—": (114.48, 38.03), "å±±è¥¿": (112.53, 37.87), "è¾½å®": (123.38, 41.80),
                        "å‰æ—": (125.32, 43.88), "é»‘é¾™æ±Ÿ": (126.63, 45.75), "å®‰å¾½": (117.27, 31.86),
                        "ç¦å»º": (119.30, 26.08), "æ±Ÿè¥¿": (115.89, 28.68), "æµ·å—": (110.35, 20.02),
                        "è´µå·": (106.71, 26.57), "äº‘å—": (102.73, 25.04), "ç”˜è‚ƒ": (103.73, 36.03),
                        "é’æµ·": (101.74, 36.56), "å®å¤": (106.27, 38.47), "æ–°ç–†": (87.68, 43.77),
                        "è¥¿è—": (91.11, 29.97), "å†…è’™å¤": (111.65, 40.82), "å¹¿è¥¿": (108.33, 22.84),
                    }
                    if clean_province in province_coordinates:
                        longitude, latitude = province_coordinates[clean_province]
                        print(f"âš ï¸ ç»çº¬åº¦è·å–å¤±è´¥ï¼Œä½¿ç”¨çœä»½é»˜è®¤å€¼ï¼š{clean_province} -> ({longitude}, {latitude})")
                    else:
                        longitude, latitude = 120.0, 35.0
                        print(f"âš ï¸ ç»çº¬åº¦è·å–å¤±è´¥ï¼Œä½¿ç”¨ä¸œå…«åŒºæ ‡å‡†å€¼ï¼š({longitude}, {latitude})")
                else:
                    longitude, latitude = 120.0, 35.0
                    print(f"âš ï¸ ç»çº¬åº¦è·å–å¤±è´¥ï¼Œä½¿ç”¨ä¸œå…«åŒºæ ‡å‡†å€¼ï¼š({longitude}, {latitude})")

            # ä½¿ç”¨ sxtwl è®¡ç®—å››æŸ±
            location_obj = Location(lon=longitude, lat=latitude) if longitude is not None and latitude is not None else None
            sxtwl_result = compute_bazi_json(
                year=solar.getYear(),
                month=solar.getMonth(),
                day=solar.getDay(),
                hour=input_hour,
                minute=input_minute,
                second=0,
                tz_offset_hours=8.0,
                rules=Rules(use_true_solar_time=True),
                location=location_obj
            )

            pillars = sxtwl_result['pillars']
            # ğŸ”¥ ä¿®å¤ï¼šæ­£ç¡®æ ¼å¼åŒ–pillarsæ˜¾ç¤ºï¼ˆå¤„ç†åˆ—è¡¨å’Œå­—ç¬¦ä¸²ä¸¤ç§æ ¼å¼ï¼‰
            def format_pillar(p):
                if isinstance(p, list) and len(p) >= 2:
                    return f"{p[0]}{p[1]}"
                elif isinstance(p, str):
                    return p
                else:
                    return str(p)

            year_str = format_pillar(pillars['year'])
            month_str = format_pillar(pillars['month'])
            day_str = format_pillar(pillars['day'])
            hour_str = format_pillar(pillars['hour'])

            print(f"âœ“ sxtwlå››æŸ±è®¡ç®—æˆåŠŸ: {year_str} {month_str} {day_str} {hour_str}")

            # ğŸ”¥ å…³é”®ä¿®å¤ï¼šè½¬æ¢pillarsæ ¼å¼ä¸ºåˆ†æå™¨æœŸæœ›çš„æ ¼å¼
            # sxtwlè¿”å›: {"year": "ç”²å­"}
            # åˆ†æå™¨æœŸæœ›: {"year": "ç”²å­"} (pillars['year'][0] = 'ç”²', pillars['year'][1] = 'å­')
            # æ³¨ï¼šsxtwlè¿”å›çš„å·²ç»æ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨å³å¯

            # ä¿å­˜ç»“æœ
            # æ·»åŠ äº”è¡Œåˆ†å¸ƒè®¡ç®—åˆ°sxtwl_resultä¸­
            try:
                if CLASSIC_ANALYZER_AVAILABLE:
                    # ä½¿ç”¨ç»å…¸åˆ†æå™¨çš„äº”è¡Œåˆ†å¸ƒè®¡ç®—
                    from classic_analyzer.common import compute_wuxing_distribution
                    pillars_for_wuxing = {
                        'year': (pillars['year'][0], pillars['year'][1]),
                        'month': (pillars['month'][0], pillars['month'][1]),
                        'day': (pillars['day'][0], pillars['day'][1]),
                        'hour': (pillars['hour'][0], pillars['hour'][1])
                    }
                    wuxing_dist = compute_wuxing_distribution(pillars_for_wuxing)
                    sxtwl_result['wuxing_distribution'] = wuxing_dist
                else:
                    # ä½¿ç”¨æœ¬åœ°è®¡ç®—
                    pillars_dict = {
                        'year': [pillars['year'][0], pillars['year'][1]],
                        'month': [pillars['month'][0], pillars['month'][1]],
                        'day': [pillars['day'][0], pillars['day'][1]],
                        'hour': [pillars['hour'][0], pillars['hour'][1]]
                    }
                    wuxing_dist = self.calculate_wuxing_distribution(pillars_dict)
                    sxtwl_result['wuxing_distribution'] = wuxing_dist
            except Exception as e:
                print(f"âš ï¸ äº”è¡Œåˆ†å¸ƒè®¡ç®—å¤±è´¥: {e}")
                # è®¾ç½®é»˜è®¤å€¼é¿å…æ˜¾ç¤ºé”™è¯¯
                sxtwl_result['wuxing_distribution'] = {'æœ¨': 0, 'ç«': 0, 'åœŸ': 0, 'é‡‘': 0, 'æ°´': 0}

            self.current_sxtwl_result = sxtwl_result
            self.last_sxtwl_result = sxtwl_result

            # å‡†å¤‡å‡ºç”Ÿä¿¡æ¯
            birth_info = {
                'year': year,
                'month': month,
                'day': day,
                'hour_index': hour_index,
                'gender': gender,
                'name': name,
                'solar_year': solar.getYear(),
                'solar_month': solar.getMonth(),
                'solar_day': solar.getDay(),
                'solar_hour': input_hour,
                'solar_minute': input_minute,
                'solar_second': 0,
                'lunar_month': month,
                'lunar_day': day,
                'is_leap': is_leap,
                'province': province,
                'city': city,
                'longitude': longitude,
                'latitude': latitude,
                'timezone_offset': 8.0,
                'use_true_solar_time': True,
                'analysis_datetime': datetime.now(),
            }
            self.last_birth_info = birth_info

            # 2. ä½¿ç”¨ç»å…¸å‘½ç†åˆ†æå™¨è¿›è¡Œåˆ†æ
            analysis_text = ""

            # ğŸ”¥ ä¼˜å…ˆä½¿ç”¨ç»å…¸å‘½ç†åˆ†æå™¨ï¼ˆæ–°çš„æ¨¡å—åŒ–ç³»ç»Ÿï¼‰
            print(f"ğŸ” è°ƒè¯•ä¿¡æ¯ï¼šCLASSIC_ANALYZER_AVAILABLE = {CLASSIC_ANALYZER_AVAILABLE}")
            print(f"ğŸ” è°ƒè¯•ä¿¡æ¯ï¼šå¼€å§‹åˆ†æï¼Œå››æŸ± = {pillars}")
            if CLASSIC_ANALYZER_AVAILABLE:
                try:
                    print(f"âœ¨ å¼€å§‹ç»å…¸å‘½ç†åˆ†æï¼ˆæ–°ç³»ç»Ÿï¼‰...")

                    # è½¬æ¢pillarsæ ¼å¼
                    # ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„extract_gan_zhiå‡½æ•°æå–å¤©å¹²åœ°æ”¯
                    year_gan, year_zhi = self.extract_gan_zhi(pillars.get('year', ''))
                    month_gan, month_zhi = self.extract_gan_zhi(pillars.get('month', ''))
                    day_gan, day_zhi = self.extract_gan_zhi(pillars.get('day', ''))
                    hour_gan, hour_zhi = self.extract_gan_zhi(pillars.get('hour', ''))

                    day_master = day_gan
                    pillars_for_analyzer = {
                        'year': (year_gan, year_zhi),
                        'month': (month_gan, month_zhi),
                        'day': (day_gan, day_zhi),
                        'hour': (hour_gan, hour_zhi)
                    }
                    pillars_struct = {k: [v[0], v[1]] for k, v in pillars_for_analyzer.items()}
                    tiangan_wuxing_map = self.get_tiangan_wuxing_info()
                    dizhi_info_map = self.get_dizhi_info()
                    # ğŸ”¥ ä¿®å¤ï¼šç»Ÿä¸€ä½¿ç”¨classic_analyzer.commonä¸­çš„get_ten_godå‡½æ•°ï¼ˆå·²ä¿®å¤æ­£å°/åå°é€»è¾‘ï¼‰
                    from classic_analyzer.common import get_ten_god
                    ten_gods_detail = {}
                    for pos, (tg, dz) in pillars_for_analyzer.items():
                        if pos != 'day':
                            # ä½¿ç”¨ç»Ÿä¸€çš„get_ten_godå‡½æ•°ï¼Œç¡®ä¿åç¥è®¡ç®—æ­£ç¡®
                            ten_god = get_ten_god(day_master, tg)
                            ten_gods_detail[pos] = {'ten_god': ten_god, 'tiangan': tg, 'dizhi': dz}
                    # ğŸ”¥ ä¿®å¤ï¼šåˆå§‹åŒ–æ—¶ä½¿ç”¨æœªçŸ¥ï¼Œç­‰æ—¥ä¸»å¼ºå¼±åˆ†æåå†ç¡®å®š
                    bazi_snapshot = {
                        'pillars': pillars_struct,
                        'day_master': day_master,
                        'day_master_element': self.get_wuxing_by_tiangan(day_master),
                        'dizhi_info': dizhi_info_map,
                        'bazi_pattern': {'pattern_type': 'æœªçŸ¥'}  # ç­‰å¾…æ—¥ä¸»å¼ºå¼±åˆ†æåç¡®å®š
                    }

                    # âœ… ä¼˜å…ˆä½¿ç”¨å…­ä¹¦ç»Ÿä¸€çŸ¥è¯†åº“åˆ†æå™¨ï¼ˆå¿…é¡»åœ¨æ‰€æœ‰åˆ†æä¹‹å‰åˆå§‹åŒ–ï¼‰
                    bazi_data_cml = None
                    unified_analyzer_cml = None
                    if CML_UNIFIED_AVAILABLE:
                        try:
                            # åˆ›å»ºBaziDataå¯¹è±¡ï¼ˆéœ€è¦å››æŸ±æ•°æ®å’Œå‡ºç”Ÿä¿¡æ¯ï¼‰
                            # è½¬æ¢hour_indexä¸ºå®é™…hourï¼ˆ0-23ï¼‰
                            hour_index_to_hour = {
                                0: 23, 1: 1, 2: 3, 3: 5, 4: 7, 5: 9,
                                6: 11, 7: 13, 8: 15, 9: 17, 10: 19, 11: 21
                            }
                            actual_hour = hour_index_to_hour.get(birth_info.get('hour_index', 0),
                                                                 birth_info.get('solar_hour', 0))
                            if isinstance(actual_hour, str):
                                try:
                                    actual_hour = int(actual_hour)
                                except:
                                    actual_hour = 0

                            bazi_data_cml = BaziData(
                                year=(pillars['year'][0], pillars['year'][1]),
                                month=(pillars['month'][0], pillars['month'][1]),
                                day=(pillars['day'][0], pillars['day'][1]),
                                hour=(pillars['hour'][0], pillars['hour'][1]),
                                birth_year=birth_info['solar_year'],
                                birth_month=birth_info['solar_month'],
                                birth_day=birth_info['solar_day'],
                                birth_hour=int(actual_hour),
                                gender=gender
                            )
                            # åˆ›å»ºç»Ÿä¸€åˆ†æå™¨
                            unified_analyzer_cml = UnifiedMetaphysicsAnalyzer()
                            print(f"âœ… å…­ä¹¦ç»Ÿä¸€çŸ¥è¯†åº“åˆ†æå™¨å·²åˆå§‹åŒ–")
                        except Exception as e:
                            print(f"âš ï¸ å…­ä¹¦åº“åˆå§‹åŒ–å¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()
                            bazi_data_cml = None
                            unified_analyzer_cml = None

                    # 1. è´¢è¿åˆ†æï¼ˆåŸºäºã€Šæ¸Šæµ·å­å¹³ã€‹ï¼‰- ä¸¥æ ¼æ¨¡å¼ï¼šåªä½¿ç”¨å…­ä¹¦åº“
                    # âœ… ä¿®å¤ï¼šç§»é™¤é‡å¤æ˜¾ç¤ºï¼Œè´¢è¿è¯¦ç»†åˆ†æåœ¨ã€è´¢å¯Œç»“æ„åˆ†æã€‘ä¸­æ˜¾ç¤º
                    # æ­¤å¤„åªæ˜¾ç¤ºç®€è¦ä¿¡æ¯ï¼Œé¿å…ä¸ã€è´¢å¯Œç»“æ„åˆ†æã€‘é‡å¤
                    print(f"ğŸ” å¼€å§‹è´¢è¿åˆ†æï¼ˆä¸¥æ ¼æ¨¡å¼ï¼šåªä½¿ç”¨å…­ä¹¦åº“ï¼‰...")
                    # æ³¨æ„ï¼šè´¢è¿è¯¦ç»†åˆ†æå·²åœ¨ã€è´¢å¯Œç»“æ„åˆ†æã€‘éƒ¨åˆ†æ˜¾ç¤ºï¼ˆç¬¬10909-10980è¡Œï¼‰ï¼Œæ­¤å¤„è·³è¿‡ä»¥é¿å…é‡å¤
                    print(f"âœ… è´¢è¿åˆ†æå·²åœ¨ã€è´¢å¯Œç»“æ„åˆ†æã€‘ä¸­æ˜¾ç¤ºï¼Œè·³è¿‡æ­¤å¤„")
                    # ä¸å†åœ¨æ­¤å¤„é‡å¤æ˜¾ç¤ºè´¢è¿åˆ†æï¼Œæ‰€æœ‰è´¢è¿ç›¸å…³ä¿¡æ¯ç»Ÿä¸€åœ¨ã€è´¢å¯Œç»“æ„åˆ†æã€‘ä¸­æ˜¾ç¤º

                    # 1.1 è´¢è¿è¯¦ç»†é¢„æµ‹ï¼ˆæœ€ä½³é˜¶æ®µ/æ–¹å‘/è­¦ç¤º/è§„åˆ’ï¼‰- å ä½å˜é‡
                    best_spans = []
                    warn_spans = []
                    invest_dir = ''
                    plan = ''

                    # åˆå§‹åŒ–ç»“æœå˜é‡ï¼ˆé¿å…æœªå®šä¹‰é”™è¯¯ï¼‰
                    caiyun_result = {}  # è´¢è¿åˆ†æç»“æœï¼ˆå·²æ”¹ä¸ºä½¿ç”¨wealth_analysisï¼‰
                    shensha_result = {}
                    geju_result = {}
                    yongshen_result = {}
                    tiaohou_result = {}

                    # âœ… åˆ é™¤é”™è¯¯çš„"å…­ä¹¦ç»¼åˆåˆ†æ"
                    # å…­æœ¬ä¹¦æ˜¯çŸ¥è¯†åº“ï¼Œä¸åº”è¯¥"æ•´åˆ"åœ¨ä¸€èµ·
                    # æ¯ä¸ªåˆ†æé¡¹ç›®åº”è¯¥å¼•ç”¨å…·ä½“çš„ç»å…¸è‘—ä½œä½œä¸ºä¾æ®

                    # ğŸ”¥ ä¿®å¤ï¼šå…ˆç”¨ç¥åˆ†æï¼Œå†å¤§è¿åˆ†æï¼ˆå¤§è¿åˆ¤æ–­éœ€è¦ç”¨ç¥ä¿¡æ¯ï¼‰
                    # 5. ç”¨ç¥åˆ†æï¼ˆåŸºäºã€Šå­å¹³çœŸè¯ ã€‹ã€Šæ»´å¤©é«“ã€‹ï¼‰- æå‰æ‰§è¡Œ
                    print(f"ğŸ” å¼€å§‹ç”¨ç¥åˆ†æï¼ˆæå‰æ‰§è¡Œï¼Œä¾›å¤§è¿åˆ¤æ–­ä½¿ç”¨ï¼‰...")
                    # ğŸ”¥ åˆå§‹åŒ–å˜é‡ï¼šä¿å­˜æå‰åˆ†æçš„å®Œæ•´ç»“æœï¼Œä¾›åç»­å¤ç”¨
                    ziping_result_early = None
                    ditian_result_early = None
                    yongshen_result = {}
                    if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                        try:
                            # ä½¿ç”¨å…­ä¹¦åº“çš„ã€Šå­å¹³çœŸè¯ ã€‹å’Œã€Šæ»´å¤©é«“ã€‹ç”¨ç¥åˆ†æ
                            ziping_result_early = unified_analyzer_cml.analyzers['å­å¹³çœŸè¯ '].analyze(bazi_data_cml)
                            ditian_result_early = unified_analyzer_cml.analyzers['æ»´å¤©é«“'].analyze(bazi_data_cml)
                            yongshen_info = ziping_result_early.details.get('yongshen_info', {})
                            # ğŸ”¥ ä¼˜åŒ–ï¼šä¿å­˜å®Œæ•´çš„ç”¨ç¥ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ–¹æ³•ã€ç”¨ç¥ã€å–œå¿Œç­‰ï¼‰
                            yongshen_result = {
                                'yongshen_xiji': {
                                    'xishen': yongshen_info.get('xishen', '').split('ã€') if yongshen_info.get('xishen') else [],
                                    'jishen': yongshen_info.get('jishen', '').split('ã€') if yongshen_info.get('jishen') else []
                                },
                                'yongshen_method': yongshen_info.get('method', ''),  # ğŸ”¥ æ–°å¢ï¼šä¿å­˜ç”¨ç¥æ–¹æ³•
                                'yongshen': yongshen_info.get('yongshen', ''),  # ğŸ”¥ æ–°å¢ï¼šä¿å­˜ç”¨ç¥
                                'month_yongshen': {
                                    'month_gan': pillars.get('month', ['', ''])[0] if isinstance(pillars.get('month'), (list, tuple)) else ''
                                },
                                'source': 'å…­ä¹¦åº“_å­å¹³çœŸè¯ '  # ğŸ”¥ æ–°å¢ï¼šæ ‡è®°æ¥æº
                            }
                            print(f"âœ… ç”¨ç¥åˆ†æï¼ˆæå‰ï¼‰å®Œæˆ: {yongshen_result}")
                        except Exception as e:
                            print(f"âš ï¸ æå‰ç”¨ç¥åˆ†æå¤±è´¥: {e}")
                            yongshen_result = {}
                            ziping_result_early = None
                            ditian_result_early = None
                    else:
                        # ğŸ”¥ ä¿®å¤ï¼šå…­ä¹¦åº“ä¸å¯ç”¨æ—¶ï¼Œä¸å†é™çº§åˆ°å¤‡ç”¨åˆ†æå™¨ï¼Œç›´æ¥è¿”å›ç©ºç»“æœ
                        print(f"âš ï¸ å…­ä¹¦åº“ä¸å¯ç”¨ï¼Œç”¨ç¥åˆ†æè·³è¿‡")
                        yongshen_result = {}
                        ziping_result_early = None
                        ditian_result_early = None

                    # 2. å¤§è¿åˆ†æï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ï¼‰
                    print(f"ğŸ” å¼€å§‹å¤§è¿åˆ†æ...")
                    if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                        try:
                            # ä½¿ç”¨å…­ä¹¦åº“çš„ã€Šä¸‰å‘½é€šä¼šã€‹å¤§è¿åˆ†æ
                            dayun_result_cml = unified_analyzer_cml.analyzers['ä¸‰å‘½é€šä¼š'].analyze_dayun(bazi_data_cml)
                            analysis_text += f"ã€å¤§è¿åˆ†æã€‘ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ï¼‰\n"
                            # ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨descriptionä¸­çš„ä¿¡æ¯ï¼Œé¿å…é‡å¤
                            direction = dayun_result_cml.details.get('direction', 'æœªçŸ¥')
                            xiji_details = dayun_result_cml.details.get('xiji_details', {})
                            # ğŸ”¥ ä¿®å¤ï¼šèµ·è¿å¹´é¾„æ˜¾ç¤ºNoneçš„é—®é¢˜
                            qiyun_age_value = dayun_result_cml.details.get('qiyun_age')
                            if qiyun_age_value is None:
                                qiyun_age_display = "æœªçŸ¥"
                            else:
                                # ğŸ”¥ ä¿®å¤ï¼šèµ·è¿å¹´é¾„æ˜¾ç¤ºï¼Œå¦‚æœæ¥è¿‘æ•´æ•°åˆ™æ˜¾ç¤ºæ•´æ•°ï¼ˆä¿®å¤0.7æ˜¾ç¤ºä¸º1çš„é—®é¢˜ï¼‰
                                if isinstance(qiyun_age_value, float):
                                    # å¦‚æœæ¥è¿‘æ•´æ•°ï¼ˆå·®å€¼å°äº0.05ï¼‰ï¼Œæ˜¾ç¤ºæ•´æ•°
                                    # ä¾‹å¦‚ï¼š0.7 â†’ 0.7ï¼ˆæ˜¾ç¤ºï¼‰ï¼Œ1.0 â†’ 1ï¼ˆæ˜¾ç¤ºï¼‰ï¼Œ1.2 â†’ 1.2ï¼ˆæ˜¾ç¤ºï¼‰
                                    rounded_age = round(qiyun_age_value)
                                    if abs(qiyun_age_value - rounded_age) < 0.05:
                                        qiyun_age_display = str(rounded_age)
                                    else:
                                        qiyun_age_display = f"{qiyun_age_value:.1f}"
                                else:
                                    qiyun_age_display = str(int(qiyun_age_value)) if qiyun_age_value else "æœªçŸ¥"

                            # å¦‚æœdescriptionä¸­æœ‰å†…å®¹ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™æ„å»ºä¿¡æ¯
                            if dayun_result_cml.description and dayun_result_cml.description.strip():
                                # descriptionä¸­å·²ç»åŒ…å«äº†æ–¹å‘ç­‰ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨
                                analysis_text += f"{dayun_result_cml.description}\n"
                                # ğŸ”¥ ä¿®å¤ï¼šå¦‚æœdescriptionä¸­æ²¡æœ‰åŒ…å«"å¤§è¿æ–¹å‘"ï¼Œæ‰å•ç‹¬æ˜¾ç¤º
                                if 'å¤§è¿æ–¹å‘' not in dayun_result_cml.description:
                                    analysis_text += f"å¤§è¿æ–¹å‘ï¼š{direction}\n"
                            else:
                                # å¤‡ç”¨ï¼šæ‰‹åŠ¨æ„å»ºä¿¡æ¯
                                pillars_count = len(dayun_result_cml.details.get('dayun_pillars', [])) or 10
                                analysis_text += f"å¤§è¿æ–¹å‘ï¼š{direction}ï¼›å…±æ’{pillars_count}æ­¥ï¼›"
                                xiji_summary = xiji_details.get('summary', 'å¤§è¿è¾ƒä¸ºæœ‰åˆ©ï¼Œéƒ¨åˆ†æ­¥è¿åŠ©åŠ›æ—¥ä¸»')
                                analysis_text += f"{xiji_summary}\n"

                            analysis_text += f"èµ·è¿å¹´é¾„ï¼š{qiyun_age_display}å²\n"
                            # ğŸ”¥ ä¿®å¤ï¼šæœ‰åˆ©å¤§è¿å’Œä¸åˆ©å¤§è¿æ˜¾ç¤ºä¸ºæ•´æ•°
                            helpful_count = xiji_details.get('helpful_count', 0)
                            harmful_count = xiji_details.get('harmful_count', 0)
                            analysis_text += f"å¤§è¿å–œå¿Œï¼š{xiji_details.get('xiji', 'æœªçŸ¥')}ï¼ˆ{xiji_details.get('summary', '')}ï¼‰\n"
                            analysis_text += f"æœ‰åˆ©å¤§è¿ï¼š{int(helpful_count)}æ­¥\n"
                            analysis_text += f"ä¸åˆ©å¤§è¿ï¼š{int(harmful_count)}æ­¥\n"
                            analysis_text += f"\n{dayun_result_cml.advice}\n\n"
                            # å¤§è¿æ¯æ­¥æ˜ç»†ï¼ˆåŸºäºå…­ä¹¦åº“è¿”å›çš„ dayun_pillars + èµ·è¿å¹´é¾„æ¨å¯¼ï¼‰
                            try:
                                pillars_list = dayun_result_cml.details.get('dayun_pillars', []) or []
                                qy_age_raw = dayun_result_cml.details.get('qiyun_age')
                                # ğŸ”¥ ä¿®å¤ï¼šå¦‚æœèµ·è¿å¹´é¾„æ˜¯Noneæˆ–0ï¼Œä½¿ç”¨é»˜è®¤å€¼æˆ–è·³è¿‡æ˜ç»†
                                if qy_age_raw is None or qy_age_raw == 0:
                                    qy_age = 0  # å¦‚æœæ— æ³•è·å–èµ·è¿å¹´é¾„ï¼Œä»0å¼€å§‹
                                else:
                                    qy_age = float(qy_age_raw)

                                # è·å–å‡ºç”Ÿå¹´ä»½ï¼ˆç”¨äºè®¡ç®—å…¬å†å¹´ä»½ï¼‰
                                birth_year = birth_info.get('solar_year') or birth_info.get('year')
                                if not birth_year:
                                    birth_year = year  # ä½¿ç”¨è¾“å…¥çš„å¹´

                                # è·å–æ—¥ä¸»ï¼ˆç”¨äºåˆ¤æ–­å‰å‡¶ï¼‰
                                # ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„extract_gan_zhiå‡½æ•°æå–æ—¥ä¸»
                                # ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿pillarså˜é‡å­˜åœ¨ï¼ˆä»sxtwl_resultè·å–ï¼‰
                                if 'pillars' not in locals() and 'pillars' not in globals():
                                    # å¦‚æœpillarsä¸å­˜åœ¨ï¼Œå°è¯•ä»sxtwl_resultè·å–
                                    try:
                                        pillars = sxtwl_result.get('pillars', {}) if 'sxtwl_result' in locals() else {}
                                        print(f"ğŸ” è°ƒè¯•ï¼šä»sxtwl_resultè·å–pillars: {pillars}")
                                    except:
                                        pillars = {}
                                        print(f"âš ï¸ è­¦å‘Šï¼šæ— æ³•è·å–pillarså˜é‡")

                                day_master, _ = self.extract_gan_zhi(pillars.get('day', '')) if 'day' in pillars else ('', '')
                                print(f"ğŸ” è°ƒè¯•ï¼šæå–çš„æ—¥ä¸»={day_master}, pillars['day']={pillars.get('day', 'ä¸å­˜åœ¨')}")

                                # ğŸ”¥ ä¿®å¤ï¼šè·å–ç”¨ç¥åˆ†æç»“æœï¼ˆç”¨äºå‡†ç¡®åˆ¤æ–­å¤§è¿å‰å‡¶ï¼‰
                                xishen_wuxing = None
                                jishen_wuxing = None
                                try:
                                    from classic_analyzer.common import TIANGAN_WUXING, DIZHI_WUXING, DIZHI_CANGGAN_WEIGHTS

                                    # ğŸ”¥ æ–¹æ³•0ï¼šä¼˜å…ˆæ£€æŸ¥äº”è¡Œè¿‡æ—ºç‰¹æ®Šæƒ…å†µï¼ˆåœŸå¤šé‡‘åŸ‹ã€æ°´å¤šæœ¨æ¼‚ç­‰ï¼‰
                                    # è¿™æ˜¯æœ€ä¼˜å…ˆçš„åˆ¤æ–­ï¼Œå› ä¸ºç‰¹æ®Šæƒ…å†µéœ€è¦ç‰¹æ®Šç”¨ç¥
                                    print(f"ğŸ” è°ƒè¯•ï¼šå¼€å§‹æ–¹æ³•0ï¼Œday_master={day_master}, pillarsç±»å‹={type(pillars)}, pillarså†…å®¹={pillars if isinstance(pillars, dict) else 'ä¸æ˜¯å­—å…¸'}")
                                    if day_master and day_master in TIANGAN_WUXING:
                                        day_master_wuxing = TIANGAN_WUXING[day_master]
                                        print(f"ğŸ” è°ƒè¯•ï¼šæ—¥ä¸»äº”è¡Œ={day_master_wuxing}")

                                        # ç»Ÿè®¡å››æŸ±äº”è¡Œåˆ†å¸ƒ
                                        wuxing_count = {}
                                        for pos in ['year', 'month', 'day', 'hour']:
                                            if pos in pillars:
                                                print(f"ğŸ” è°ƒè¯•ï¼šå¤„ç†{pos}æŸ±ï¼Œå€¼={pillars[pos]}, ç±»å‹={type(pillars[pos])}")
                                                pillar_value = pillars[pos]
                                                # ğŸ”¥ ä¿®å¤ï¼šæ”¯æŒå¤šç§æ ¼å¼ï¼ˆå­—ç¬¦ä¸²'æˆŠåˆ'æˆ–å…ƒç»„('æˆŠ','åˆ')ï¼‰
                                                if isinstance(pillar_value, str) and len(pillar_value) >= 2:
                                                    # å­—ç¬¦ä¸²æ ¼å¼ï¼š'æˆŠåˆ' -> ('æˆŠ', 'åˆ')
                                                    gan, zhi = pillar_value[0], pillar_value[1]
                                                elif isinstance(pillar_value, (list, tuple)) and len(pillar_value) >= 2:
                                                    # å…ƒç»„æ ¼å¼ï¼š('æˆŠ', 'åˆ')
                                                    gan, zhi = pillar_value[0], pillar_value[1]
                                                else:
                                                    gan, zhi = '', ''

                                                if gan and gan in TIANGAN_WUXING:
                                                    wx = TIANGAN_WUXING[gan]
                                                    wuxing_count[wx] = wuxing_count.get(wx, 0) + 1.0
                                                if zhi and zhi in DIZHI_CANGGAN_WEIGHTS:
                                                    canggan_list = DIZHI_CANGGAN_WEIGHTS.get(zhi, [])
                                                    for cg, weight in canggan_list:
                                                        if cg in TIANGAN_WUXING:
                                                            wx = TIANGAN_WUXING[cg]
                                                            # ç»Ÿä¸€æƒé‡ä½“ç³»ï¼šè—å¹²æƒé‡ä¸æŠ˜åŠï¼Œä¿æŒä¸åˆ†æå™¨ä¸€è‡´
                                                            wuxing_count[wx] = wuxing_count.get(wx, 0) + weight

                                        # æ£€æŸ¥æ˜¯å¦æœ‰äº”è¡Œè¿‡æ—ºä¸”åŸ‹å…‹æ—¥ä¸»
                                        WUXING_EXCESS_THRESHOLD = 3.5
                                        WUXING_BURIED_MAP = {
                                            'åœŸ': {'buried': 'é‡‘', 'wealth': 'æœ¨', 'drain': 'æ°´'},  # åœŸå¤šé‡‘åŸ‹ï¼Œå–œæœ¨ç–åœŸã€æ°´æ·˜æ´—
                                            'æ°´': {'buried': 'æœ¨', 'wealth': 'ç«', 'drain': 'åœŸ'},  # æ°´å¤šæœ¨æ¼‚ï¼Œå–œç«æš–æœ¨ã€åœŸåˆ¶æ°´
                                            'ç«': {'buried': 'åœŸ', 'wealth': 'æ°´', 'drain': 'é‡‘'},  # ç«å¤šåœŸç„¦ï¼Œå–œæ°´æ¶¦åœŸã€é‡‘ç”Ÿæ°´
                                            'æœ¨': {'buried': 'ç«', 'wealth': 'é‡‘', 'drain': 'åœŸ'},  # æœ¨å¤šç«å¡ï¼Œå–œé‡‘åˆ¶æœ¨ã€åœŸæ³„ç«
                                            'é‡‘': {'buried': 'æ°´', 'wealth': 'ç«', 'drain': 'æœ¨'},  # é‡‘å¤šæ°´æµŠï¼Œå–œç«åˆ¶é‡‘ã€æœ¨ç”Ÿç«
                                        }

                                        excess_element = None
                                        for element in ['åœŸ', 'æ°´', 'ç«', 'æœ¨', 'é‡‘']:
                                            if wuxing_count.get(element, 0) >= WUXING_EXCESS_THRESHOLD:
                                                buried_info = WUXING_BURIED_MAP.get(element, {})
                                                if buried_info.get('buried') == day_master_wuxing:
                                                    excess_element = element
                                                    break

                                        # å¦‚æœå­˜åœ¨äº”è¡Œè¿‡æ—ºæƒ…å†µï¼Œç›´æ¥è®¾ç½®ç‰¹æ®Šç”¨ç¥
                                        if excess_element:
                                            buried_info = WUXING_BURIED_MAP[excess_element]
                                            wealth_element = buried_info.get('wealth', '')
                                            drain_element = buried_info.get('drain', '')

                                            # è®¾ç½®å–œç¥å’Œå¿Œç¥
                                            xishen_wuxing = []
                                            if wealth_element:
                                                xishen_wuxing.append(wealth_element)
                                            if drain_element:
                                                xishen_wuxing.append(drain_element)

                                            jishen_wuxing = [excess_element, day_master_wuxing]  # è¿‡æ—ºçš„äº”è¡Œå’Œæ—¥ä¸»äº”è¡Œéƒ½æ˜¯å¿Œç¥

                                            print(f"âœ… æ£€æµ‹åˆ°{excess_element}å¤š{day_master_wuxing}åŸ‹ç‰¹æ®Šæƒ…å†µï¼Œè®¾ç½®ç”¨ç¥: å–œç¥{xishen_wuxing}, å¿Œç¥{jishen_wuxing}")
                                            print(f"ğŸ” äº”è¡Œç»Ÿè®¡ç»“æœ: {wuxing_count}, é˜ˆå€¼: {WUXING_EXCESS_THRESHOLD}, æ£€æµ‹åˆ°è¿‡æ—ºå…ƒç´ : {excess_element}")
                                        else:
                                            print(f"âš ï¸ æœªæ£€æµ‹åˆ°äº”è¡Œè¿‡æ—ºç‰¹æ®Šæƒ…å†µï¼Œäº”è¡Œç»Ÿè®¡: {wuxing_count}, æ—¥ä¸»äº”è¡Œ: {day_master_wuxing}, é˜ˆå€¼: {WUXING_EXCESS_THRESHOLD}")
                                            # ğŸ”¥ è°ƒè¯•ï¼šæ‰“å°è¯¦ç»†çš„äº”è¡Œç»Ÿè®¡ä¿¡æ¯
                                            for element, count in wuxing_count.items():
                                                print(f"  {element}: {count} ({'â‰¥' if count >= WUXING_EXCESS_THRESHOLD else '<'} {WUXING_EXCESS_THRESHOLD})")
                                    else:
                                        print(f"âš ï¸ æ–¹æ³•0è·³è¿‡ï¼šday_master={day_master}, day_master in TIANGAN_WUXING={day_master in TIANGAN_WUXING if day_master else False}")

                                    # ğŸ”¥ æ–¹æ³•1ï¼šä¼˜å…ˆä½¿ç”¨æå‰åˆ†æçš„ç”¨ç¥ç»“æœï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
                                    # åªæœ‰åœ¨æ²¡æœ‰æ£€æµ‹åˆ°ç‰¹æ®Šæƒ…å†µæ—¶æ‰ä½¿ç”¨å¸¸è§„ç”¨ç¥åˆ¤æ–­
                                    if not xishen_wuxing and not jishen_wuxing:
                                        print(f"âš ï¸ æœªæ£€æµ‹åˆ°äº”è¡Œè¿‡æ—ºç‰¹æ®Šæƒ…å†µï¼Œå°†ä½¿ç”¨å¸¸è§„ç”¨ç¥åˆ¤æ–­")
                                        if ziping_result_early:
                                            try:
                                                print(f"ğŸ” è°ƒè¯•ï¼šziping_result_earlyå­˜åœ¨ï¼Œå¼€å§‹æå–ç”¨ç¥...")
                                                yongshen_info = ziping_result_early.details.get('yongshen_info', {})
                                                print(f"ğŸ” è°ƒè¯•ï¼šyongshen_info = {yongshen_info}")
                                                xishen_str = yongshen_info.get('xishen', '')
                                                jishen_str = yongshen_info.get('jishen', '')
                                                print(f"ğŸ” è°ƒè¯•ï¼šåŸå§‹å­—ç¬¦ä¸² - å–œç¥:{xishen_str}, å¿Œç¥:{jishen_str}")

                                                # ğŸ”¥ ä¿®å¤ï¼šä»å­—ç¬¦ä¸²ä¸­æå–äº”è¡Œï¼ˆå¥å£®è§£æï¼Œæ”¯æŒæ— åˆ†éš”æƒ…å†µï¼‰
                                                if xishen_str:
                                                    s = xishen_str
                                                    for sep in ['ã€', 'ï¼Œ', ',', 'å’Œ', 'åŠ', ' ']:
                                                        s = s.replace(sep, '|')
                                                    xishen_list = [t for t in s.split('|') if t in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                                    if not xishen_list:
                                                        # æ— åˆ†éš”ç¬¦æ—¶ï¼Œé€å­—ç¬¦æå–
                                                        xishen_list = [ch for ch in xishen_str if ch in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                                    xishen_wuxing = [wx.strip() for wx in xishen_list if wx.strip() in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                                    print(f"ğŸ” è°ƒè¯•ï¼šæå–åçš„å–œç¥åˆ—è¡¨: {xishen_wuxing}")
                                                if jishen_str:
                                                    s2 = jishen_str
                                                    for sep in ['ã€', 'ï¼Œ', ',', 'å’Œ', 'åŠ', ' ']:
                                                        s2 = s2.replace(sep, '|')
                                                    jishen_list = [t for t in s2.split('|') if t in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                                    if not jishen_list:
                                                        # æ— åˆ†éš”ç¬¦æ—¶ï¼Œé€å­—ç¬¦æå–
                                                        jishen_list = [ch for ch in jishen_str if ch in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                                    jishen_wuxing = [wx.strip() for wx in jishen_list if wx.strip() in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                                    print(f"ğŸ” è°ƒè¯•ï¼šæå–åçš„å¿Œç¥åˆ—è¡¨: {jishen_wuxing}")

                                                print(f"âœ… ä»æå‰åˆ†æç»“æœæå–ç”¨ç¥: å–œç¥{xishen_wuxing}, å¿Œç¥{jishen_wuxing}")
                                            except Exception as e:
                                                print(f"âš ï¸ ä»æå‰åˆ†æç»“æœæå–ç”¨ç¥å¤±è´¥: {e}")
                                                import traceback
                                                traceback.print_exc()

                                    # ğŸ”¥ æ–¹æ³•2ï¼šå¦‚æœæå‰åˆ†æç»“æœä¸å¯ç”¨ï¼Œä»å…­ä¹¦åº“é‡æ–°åˆ†æ
                                    if (not xishen_wuxing and not jishen_wuxing) and CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                                        try:
                                            # å°è¯•è·å–å…­ä¹¦åº“çš„ç”¨ç¥åˆ†æç»“æœ
                                            ziping_result = unified_analyzer_cml.analyzers.get('å­å¹³çœŸè¯ ')
                                            if ziping_result:
                                                try:
                                                    ziping_analysis = ziping_result.analyze(bazi_data_cml)
                                                    yongshen_info = ziping_analysis.details.get('yongshen_info', {})
                                                    xishen_str = yongshen_info.get('xishen', '')
                                                    jishen_str = yongshen_info.get('jishen', '')

                                                    # ä»å­—ç¬¦ä¸²ä¸­æå–äº”è¡Œï¼ˆå¥å£®è§£æï¼Œæ”¯æŒæ— åˆ†éš”æƒ…å†µï¼‰
                                                    if xishen_str:
                                                        s = xishen_str
                                                        for sep in ['ã€', 'ï¼Œ', ',', 'å’Œ', 'åŠ', ' ']:
                                                            s = s.replace(sep, '|')
                                                        xishen_list = [t for t in s.split('|') if t in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                                        if not xishen_list:
                                                            xishen_list = [ch for ch in xishen_str if ch in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                                        xishen_wuxing = [wx.strip() for wx in xishen_list if wx.strip() in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                                    if jishen_str:
                                                        s2 = jishen_str
                                                        for sep in ['ã€', 'ï¼Œ', ',', 'å’Œ', 'åŠ', ' ']:
                                                            s2 = s2.replace(sep, '|')
                                                        jishen_list = [t for t in s2.split('|') if t in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                                        if not jishen_list:
                                                            jishen_list = [ch for ch in jishen_str if ch in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                                        jishen_wuxing = [wx.strip() for wx in jishen_list if wx.strip() in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                                except Exception:
                                                    pass
                                        except Exception:
                                            pass

                                    # ğŸ”¥ æ–¹æ³•3ï¼šä»classic_analyzerçš„ç”¨ç¥åˆ†æç»“æœä¸­æå–ï¼ˆä½œä¸ºæœ€åå¤‡é€‰ï¼‰
                                    # ğŸ”¥ ä¼˜åŒ–ï¼šä¼˜å…ˆä½¿ç”¨å…­ä¹¦åº“ç»“æœï¼Œclassic_analyzerä»…ä½œä¸ºæœ€åå¤‡é€‰
                                    if (not xishen_wuxing and not jishen_wuxing) and yongshen_result and isinstance(yongshen_result, dict) and len(yongshen_result) > 0:
                                        # ğŸ”¥ æ–°å¢ï¼šæ£€æŸ¥æ¥æºï¼Œå¦‚æœæ˜¯classic_analyzerï¼Œå†æ¬¡å°è¯•å…­ä¹¦åº“
                                        source = yongshen_result.get('source', '')
                                        if source == 'classic_analyzer' and CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                                            # æœ€åä¸€æ¬¡å°è¯•ä½¿ç”¨å…­ä¹¦åº“
                                            try:
                                                ziping_final = unified_analyzer_cml.analyzers.get('å­å¹³çœŸè¯ ')
                                                if ziping_final:
                                                    ziping_analysis_final = ziping_final.analyze(bazi_data_cml)
                                                    yongshen_info_final = ziping_analysis_final.details.get('yongshen_info', {})
                                                    xishen_str_final = yongshen_info_final.get('xishen', '')
                                                    jishen_str_final = yongshen_info_final.get('jishen', '')
                                                    if xishen_str_final:
                                                        xishen_list_final = xishen_str_final.replace('ã€', ',').replace('ï¼Œ', ',').split(',')
                                                        xishen_wuxing = [wx.strip() for wx in xishen_list_final if wx.strip() in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                                    if jishen_str_final:
                                                        jishen_list_final = jishen_str_final.replace('ã€', ',').replace('ï¼Œ', ',').split(',')
                                                        jishen_wuxing = [wx.strip() for wx in jishen_list_final if wx.strip() in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                                    if xishen_wuxing or jishen_wuxing:
                                                        print(f"âœ… æœ€åå°è¯•ï¼šæˆåŠŸä»å…­ä¹¦åº“è·å–ç”¨ç¥ä¿¡æ¯")
                                                        # è·³è¿‡classic_analyzerçš„å¤„ç†ï¼Œç»§ç»­ä½¿ç”¨å…­ä¹¦åº“ç»“æœ
                                            except Exception:
                                                pass

                                        # ä»yongshen_xijiä¸­æå–
                                        yongshen_xiji = yongshen_result.get('yongshen_xiji', {})
                                        if yongshen_xiji:
                                            xishen_list = yongshen_xiji.get('xishen', [])
                                            jishen_list = yongshen_xiji.get('jishen', [])

                                            # ä»åç¥åç§°æˆ–å¤©å¹²åœ°æ”¯ä¸­æå–äº”è¡Œ
                                            xishen_wuxing = []
                                            for xs in xishen_list:
                                                if isinstance(xs, str):
                                                    # å¦‚æœæ˜¯å¤©å¹²ï¼Œç›´æ¥è·å–äº”è¡Œ
                                                    if xs in TIANGAN_WUXING:
                                                        xishen_wuxing.append(TIANGAN_WUXING[xs])
                                                    # å¦‚æœæ˜¯åç¥åç§°ï¼Œéœ€è¦æ ¹æ®ç”¨ç¥ç±»å‹æ¨æ–­äº”è¡Œ
                                                    # æš‚æ—¶è·³è¿‡å¤æ‚é€»è¾‘
                                                elif isinstance(xs, tuple) and len(xs) == 2:
                                                    gan_xs, zhi_xs = xs
                                                    if gan_xs in TIANGAN_WUXING:
                                                        xishen_wuxing.append(TIANGAN_WUXING[gan_xs])
                                                    if zhi_xs in DIZHI_WUXING:
                                                        xishen_wuxing.append(DIZHI_WUXING[zhi_xs])

                                            jishen_wuxing = []
                                            for js in jishen_list:
                                                if isinstance(js, str):
                                                    if js in TIANGAN_WUXING:
                                                        jishen_wuxing.append(TIANGAN_WUXING[js])
                                                elif isinstance(js, tuple) and len(js) == 2:
                                                    gan_js, zhi_js = js
                                                    if gan_js in TIANGAN_WUXING:
                                                        jishen_wuxing.append(TIANGAN_WUXING[gan_js])
                                                    if zhi_js in DIZHI_WUXING:
                                                        jishen_wuxing.append(DIZHI_WUXING[zhi_js])

                                            # å»é‡
                                            if xishen_wuxing:
                                                xishen_wuxing = list(set(xishen_wuxing))
                                            if jishen_wuxing:
                                                jishen_wuxing = list(set(jishen_wuxing))

                                        # æ–¹æ³•4ï¼ˆæ ¹æœ¬ä¿®å¤ï¼‰ï¼šåŸºäºæ—¥ä¸»å¼ºå¼±ä¸äº”è¡Œåˆ†å¸ƒæ¨æ–­å–œå¿Œï¼ˆæ‰¶æŠ‘æ³•ï¼‰
                                        if not xishen_wuxing and not jishen_wuxing:
                                            try:
                                                # è®¡ç®—äº”è¡Œåˆ†å¸ƒä¸æ—¥ä¸»å¼ºå¼±
                                                pillars_for_wuxing = {
                                                    'year': (pillars['year'][0], pillars['year'][1]),
                                                    'month': (pillars['month'][0], pillars['month'][1]),
                                                    'day': (pillars['day'][0], pillars['day'][1]),
                                                    'hour': (pillars['hour'][0], pillars['hour'][1])
                                                } if isinstance(pillars.get('year'), (list, tuple)) else pillars_for_analyzer
                                                profile = evaluate_day_master_strength(pillars_for_wuxing)
                                                day_el = profile.element  # æ—¥ä¸»äº”è¡Œ
                                                dist = profile.distribution
                                                # äº”è¡Œç”Ÿå…‹æ˜ å°„
                                                sheng_map = {'æœ¨': 'ç«', 'ç«': 'åœŸ', 'åœŸ': 'é‡‘', 'é‡‘': 'æ°´', 'æ°´': 'æœ¨'}
                                                sheng_reverse = {v: k for k, v in sheng_map.items()}
                                                ke_map = {'æœ¨': 'åœŸ', 'åœŸ': 'æ°´', 'æ°´': 'ç«', 'ç«': 'é‡‘', 'é‡‘': 'æœ¨'}
                                                ke_reverse = {v: k for k, v in ke_map.items()}
                                                resource_el = sheng_reverse.get(day_el, '')   # ç”Ÿæˆ‘è€…ï¼ˆå°ï¼‰
                                                drain_el = sheng_map.get(day_el, '')          # æˆ‘ç”Ÿè€…ï¼ˆé£Ÿä¼¤ï¼‰
                                                officer_el = ke_reverse.get(day_el, '')       # å…‹æˆ‘è€…ï¼ˆå®˜æ€ï¼‰
                                                wealth_el = ke_map.get(day_el, '')            # æˆ‘å…‹è€…ï¼ˆè´¢ï¼‰

                                                xs, js = [], []

                                                if profile.strength in ('æ—º', 'ä¸­æ—º'):
                                                    # èº«å¼ºï¼šä»¥æ³„ä¸ºç”¨ï¼Œè¾…ä»¥åˆ¶å°
                                                    if drain_el:
                                                        xs.append(drain_el)
                                                    # è‹¥å°ï¼ˆåœŸç­‰ï¼‰æ˜æ˜¾åæ—ºï¼ŒåŠ å…¥å…‹å°ä¹‹æ°”ï¼ˆå¦‚æœ¨å…‹åœŸï¼‰
                                                    heavy_el = max(dist.keys(), key=lambda k: dist[k]) if dist else ''
                                                    if resource_el and (dist.get(resource_el, 0) >= dist.get(day_el, 0) or heavy_el == resource_el):
                                                        xs.append(ke_reverse.get(resource_el, ''))
                                                    # å¿Œï¼šå°ã€å®˜æ€ã€åŒæ°”
                                                    for w in [resource_el, officer_el, day_el]:
                                                        if w:
                                                            js.append(w)
                                                else:
                                                    # èº«å¼±ï¼šä»¥å°æ¯”ä¸ºå–œï¼Œå¿Œé£Ÿä¼¤è´¢å®˜
                                                    for w in [resource_el, day_el]:
                                                        if w:
                                                            xs.append(w)
                                                    for w in [drain_el, wealth_el, officer_el]:
                                                        if w:
                                                            js.append(w)

                                                # å»é‡ï¼Œä»…ä¿ç•™äº”è¡Œå­—
                                                def uniq_wx(lst):
                                                    result = []
                                                    for w in lst:
                                                        if w in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´'] and w not in result:
                                                            result.append(w)
                                                    return result
                                                xishen_wuxing = uniq_wx(xs)
                                                jishen_wuxing = uniq_wx(js)
                                                print(f"âœ… æ ¹æœ¬ä¿®å¤æ¨æ–­ç”¨ç¥ï¼šå–œç¥{xishen_wuxing} å¿Œç¥{jishen_wuxing} å¼ºå¼±={profile.strength} åˆ†å¸ƒ={dist}")
                                            except Exception as e:
                                                print(f"âš ï¸ æ ¹æœ¬ä¿®å¤æ¨æ–­ç”¨ç¥å¤±è´¥ï¼š{e}")

                                    # ï¼ˆå·²ç§»é™¤ï¼‰åŸ"æ–¹æ³•5ï¼šä»æœˆä»¤ç”¨ç¥ç®€åŒ–æ¨æ–­"ä¼šå¯¼è‡´ç³»ç»Ÿæ€§åå·®ï¼Œæ”¹ä¸ºåŸºäºæ‰¶æŠ‘æ³•çš„æ ¹æœ¬æ¨æ–­ã€‚

                                    # ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿å˜é‡ç±»å‹æ­£ç¡®ï¼ˆåˆ—è¡¨è€Œä¸æ˜¯Noneï¼‰- ç»Ÿä¸€å¤„ç†
                                    if xishen_wuxing is None:
                                        xishen_wuxing = []
                                    if jishen_wuxing is None:
                                        jishen_wuxing = []

                                    print(f"ğŸ” æœ€ç»ˆæå–çš„ç”¨ç¥ä¿¡æ¯: å–œç¥{xishen_wuxing}, å¿Œç¥{jishen_wuxing}")
                                    if not xishen_wuxing and not jishen_wuxing:
                                        print(f"âš ï¸ è­¦å‘Šï¼šç”¨ç¥ä¿¡æ¯ä¸ºç©ºï¼Œå°†ä½¿ç”¨äº”è¡Œç”Ÿå…‹åˆ¤æ–­å¤§è¿å‰å‡¶")
                                    else:
                                        print(f"âœ… ç”¨ç¥ä¿¡æ¯å·²æ­£ç¡®è®¾ç½®: å–œç¥{xishen_wuxing}, å¿Œç¥{jishen_wuxing}ï¼Œå°†ç”¨äºå¤§è¿å‰å‡¶åˆ¤æ–­")
                                except Exception as e:
                                    print(f"âš ï¸ è·å–ç”¨ç¥ä¿¡æ¯å¤±è´¥: {e}")
                                    import traceback
                                    traceback.print_exc()
                                    # ç¡®ä¿å¤±è´¥æ—¶ä¹Ÿæ˜¯ç©ºåˆ—è¡¨è€Œä¸æ˜¯None
                                    if xishen_wuxing is None:
                                        xishen_wuxing = []
                                    if jishen_wuxing is None:
                                        jishen_wuxing = []

                                if pillars_list:
                                    analysis_text += f"å¤§è¿æ˜ç»†ï¼š\n"
                                    # ğŸ”¥ ä¿®å¤ï¼šè·å–DayunAnalyzerå®ä¾‹ï¼ˆè€Œä¸æ˜¯SantonghuiAnalyzerï¼‰
                                    santonghui_analyzer = unified_analyzer_cml.analyzers['ä¸‰å‘½é€šä¼š']
                                    dayun_analyzer = santonghui_analyzer.dayun_analyzer

                                    # ğŸ”¥ æ–°å¢ï¼šå¯¼å…¥å¹¶åˆå§‹åŒ–æ ¼å±€åˆ†æå™¨
                                    try:
                                        from chinese_metaphysics_library.santonghui.dayun_pattern_analyzer import DayunPatternAnalyzer
                                        pattern_analyzer = DayunPatternAnalyzer()
                                        use_pattern_analyzer = True
                                    except Exception as e:
                                        print(f"âš ï¸ æ ¼å±€åˆ†æå™¨å¯¼å…¥å¤±è´¥: {e}")
                                        use_pattern_analyzer = False

                                    # ğŸ”¥ æ–°å¢ï¼šæå–æ ¼å±€ä¿¡æ¯ï¼ˆä»ä¹‹å‰çš„åˆ†æç»“æœï¼‰
                                    pattern_info = {}
                                    if ziping_result_early:
                                        try:
                                            # è°ƒè¯•ï¼šæ‰“å°ziping_result_earlyçš„å†…å®¹
                                            print(f"ğŸ” ziping_result_early.details keys: {list(ziping_result_early.details.keys()) if hasattr(ziping_result_early, 'details') else 'No details'}")
                                            print(f"ğŸ” ziping_result_early.description: {ziping_result_early.description if hasattr(ziping_result_early, 'description') else 'No description'}")

                                            pattern_info = {
                                                'pattern': ziping_result_early.details.get('pattern', ''),
                                                'status': ziping_result_early.details.get('pattern_status', ''),
                                                'issue': ''  # æ ¼å±€ç—…ç—‡ï¼Œéœ€è¦ä»descriptionæˆ–äº”è¡Œç»Ÿè®¡ä¸­æå–
                                            }
                                            # å°è¯•ä»descriptionä¸­æå–æ ¼å±€ç—…ç—‡
                                            desc = ziping_result_early.description or ''
                                            if 'å°é‡' in desc or 'å°æ˜Ÿè¿‡é‡' in desc or 'å°æ˜Ÿè¿‡æ—º' in desc:
                                                pattern_info['issue'] = 'å°é‡'
                                            elif 'åœŸé‡' in desc or 'åœŸå¤š' in desc:
                                                pattern_info['issue'] = 'åœŸé‡'

                                            # å¦‚æœdescriptionä¸­æ²¡æœ‰ï¼Œä»äº”è¡Œç»Ÿè®¡ä¸­åˆ¤æ–­
                                            if not pattern_info['issue']:
                                                # ä»sxtwl_resultä¸­è·å–äº”è¡Œåˆ†å¸ƒ
                                                wuxing_dist = sxtwl_result.get('wuxing_distribution', {}) if sxtwl_result else {}
                                                if wuxing_dist:
                                                    # åˆ¤æ–­åœŸæ˜¯å¦è¿‡æ—ºï¼ˆè¶…è¿‡3.5ï¼‰
                                                    if wuxing_dist.get('åœŸ', 0) > 3.5:
                                                        pattern_info['issue'] = 'åœŸé‡'
                                                # åˆ¤æ–­å°æ˜Ÿæ˜¯å¦è¿‡æ—ºï¼ˆéœ€è¦ç»“åˆåç¥ç»Ÿè®¡ï¼‰
                                                ten_god_count = ziping_result_early.details.get('ten_god_count', {})
                                                yin_count = ten_god_count.get('æ­£å°', 0) + ten_god_count.get('åå°', 0)
                                                if yin_count > 3.0:
                                                    pattern_info['issue'] = 'å°é‡'

                                            print(f"ğŸ” æå–çš„æ ¼å±€ä¿¡æ¯: {pattern_info}")
                                        except Exception as e:
                                            print(f"âš ï¸ æå–æ ¼å±€ä¿¡æ¯å¤±è´¥: {e}")
                                            import traceback
                                            traceback.print_exc()

                                    # ğŸ”¥ æ–°å¢ï¼šæå–ç”¨ç¥æ–¹æ³•ï¼ˆåœ¨å¾ªç¯å¤–éƒ¨ï¼Œä¾›æ‰€æœ‰å¤§è¿æ­¥ä½¿ç”¨ï¼‰
                                    yongshen_method = None
                                    if ziping_result_early:
                                        try:
                                            yongshen_info_temp = ziping_result_early.details.get('yongshen_info', {})
                                            yongshen_method = yongshen_info_temp.get('method', '')
                                            if not yongshen_method:
                                                for _k in ['yongshen_method', 'æ–¹æ³•', 'ç”¨ç¥æ–¹æ³•']:
                                                    if yongshen_info_temp.get(_k):
                                                        yongshen_method = yongshen_info_temp.get(_k)
                                                        break
                                        except Exception:
                                            pass
                                    # å¦‚æœziping_result_earlyæ²¡æœ‰ï¼Œä»yongshen_resultè·å–
                                    if not yongshen_method and yongshen_result and isinstance(yongshen_result, dict):
                                        yongshen_method = yongshen_result.get('yongshen_method', '')

                                    # ğŸ”¥ æ–°å¢ï¼šæ„é€ ç”¨ç¥ä¿¡æ¯ï¼ˆä¾›æ ¼å±€åˆ†æå™¨ä½¿ç”¨ï¼‰
                                    yongshen_info_for_pattern = {
                                        'xishen_wuxing': xishen_wuxing or [],
                                        'jishen_wuxing': jishen_wuxing or [],
                                        'method': yongshen_method or ''
                                    }

                                    debug_msg = f"ğŸ” å¼€å§‹ç”Ÿæˆå¤§è¿æ˜ç»†ï¼Œå…±{len(pillars_list)}æ­¥ï¼Œæ—¥ä¸»:{day_master}"
                                    print(debug_msg)
                                    # å†™å…¥è°ƒè¯•æ–‡ä»¶
                                    with open('dayun_debug.txt', 'a', encoding='utf-8') as f:
                                        f.write(f"\n{debug_msg}\n")
                                        f.write(f"æ ¼å±€ä¿¡æ¯: {pattern_info}\n")
                                        f.write(f"ç”¨ç¥ä¿¡æ¯: {yongshen_info_for_pattern}\n")
                                    for i, p in enumerate(pillars_list, start=1):
                                        try:
                                            gan, zhi = p
                                        except Exception:
                                            # è‹¥ä¸ºå­—ç¬¦ä¸²å¦‚"ç”²å­"ï¼Œåˆ™æ‹†åˆ†æˆ–ç›´æ¥æ˜¾ç¤º
                                            gz = str(p)
                                            gan = gz[0] if len(gz) >= 1 else ''
                                            zhi = gz[1] if len(gz) >= 2 else ''

                                        # è®¡ç®—å¹´é¾„èŒƒå›´
                                        start_age = qy_age + (i - 1) * 10
                                        end_age = start_age + 9

                                        # ğŸ”¥ ä¿®å¤ï¼šå¹´ä»½è®¡ç®—ä½¿ç”¨å–æ•´åçš„å¹´é¾„ï¼ˆä¼ ç»Ÿç®—æ³•ï¼‰
                                        # èµ·è¿å¹´é¾„åº”è¯¥æŒ‰æ•´å²è®¡ç®—ï¼ˆå››èˆäº”å…¥ï¼‰ï¼Œå¹´ä»½ = å‡ºç”Ÿå¹´ä»½ + æ•´å²å¹´é¾„
                                        start_age_int = int(round(start_age))
                                        end_age_int = int(round(end_age))

                                        # è®¡ç®—å…¬å†å¹´ä»½èŒƒå›´
                                        start_year = birth_year + start_age_int
                                        end_year = birth_year + end_age_int

                                        # ğŸ”¥ ä¿®å¤ï¼šåˆ¤æ–­å‰å‡¶ï¼ˆä¼ å…¥ç”¨ç¥ä¿¡æ¯ï¼‰
                                        jixiong_info = {'xiji': 'å¹³', 'level': 'å¹³è¿'}
                                        debug_msg = f"ğŸ” æ£€æŸ¥æ¡ä»¶: day_master={day_master}, hasattr={hasattr(dayun_analyzer, '_judge_single_dayun_xiji')}"
                                        print(debug_msg)
                                        with open('dayun_debug.txt', 'a', encoding='utf-8') as f:
                                            f.write(f"{debug_msg}\n")
                                        if day_master and hasattr(dayun_analyzer, '_judge_single_dayun_xiji'):
                                            try:
                                                # ğŸ”¥ ç¡®ä¿å‚æ•°ç±»å‹æ­£ç¡®ï¼ˆåˆ—è¡¨è€Œä¸æ˜¯Noneï¼‰
                                                # ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ç”¨ç¥ä¿¡æ¯ï¼ˆå¦‚æœxishen_wuxing/jishen_wuxingæ˜¯Noneï¼Œåˆ™ä½¿ç”¨ç©ºåˆ—è¡¨ï¼‰
                                                xishen_param = xishen_wuxing if (xishen_wuxing is not None and len(xishen_wuxing) > 0) else []
                                                jishen_param = jishen_wuxing if (jishen_wuxing is not None and len(jishen_wuxing) > 0) else []

                                                # ğŸ”¥ è°ƒè¯•ï¼šæ‰“å°ä¼ å…¥çš„å‚æ•°ï¼ˆæ˜¾ç¤ºåŸå§‹å€¼å’Œå¤„ç†åçš„å€¼ï¼‰
                                                debug_msg = f"ğŸ” è°ƒç”¨å¤§è¿åˆ¤æ–­: {gan}{zhi}, æ—¥ä¸»{day_master}, åŸå§‹å–œç¥{xishen_wuxing}, åŸå§‹å¿Œç¥{jishen_wuxing}, å¤„ç†åå–œç¥{xishen_param}, å¤„ç†åå¿Œç¥{jishen_param}"
                                                print(debug_msg)
                                                with open('dayun_debug.txt', 'a', encoding='utf-8') as f:
                                                    f.write(f"{debug_msg}\n")

                                                # ğŸ”¥ ä¼˜åŒ–ï¼šæå–ç”¨ç¥æ–¹æ³•ï¼ˆè°ƒå€™/ç—…è¯/é€šå…³/æ‰¶æŠ‘ï¼‰
                                                # ä¼˜å…ˆçº§ï¼š1) ziping_result_early 2) yongshen_result 3) é‡æ–°åˆ†æ
                                                yongshen_method = None
                                                if ziping_result_early:
                                                    try:
                                                        yongshen_info_temp = ziping_result_early.details.get('yongshen_info', {})
                                                        yongshen_method = yongshen_info_temp.get('method', '')
                                                        if not yongshen_method:
                                                            for _k in ['yongshen_method', 'æ–¹æ³•', 'ç”¨ç¥æ–¹æ³•']:
                                                                if yongshen_info_temp.get(_k):
                                                                    yongshen_method = yongshen_info_temp.get(_k)
                                                                    break
                                                        print(f"ğŸ” è°ƒè¯•ï¼šç”¨ç¥æ–¹æ³•ï¼ˆä»ziping_result_earlyï¼‰= {yongshen_method}")
                                                    except Exception:
                                                        pass

                                                # ğŸ”¥ æ–°å¢ï¼šå¦‚æœziping_result_earlyæ²¡æœ‰ï¼Œä»yongshen_resultè·å–
                                                if not yongshen_method and yongshen_result and isinstance(yongshen_result, dict):
                                                    yongshen_method = yongshen_result.get('yongshen_method', '')
                                                    if yongshen_method:
                                                        print(f"ğŸ” è°ƒè¯•ï¼šç”¨ç¥æ–¹æ³•ï¼ˆä»yongshen_resultï¼‰= {yongshen_method}")

                                                # ğŸ”¥ æ–°å¢ï¼šå¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œå°è¯•ä»å…­ä¹¦åº“é‡æ–°åˆ†æ
                                                if not yongshen_method and CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                                                    try:
                                                        ziping_temp = unified_analyzer_cml.analyzers.get('å­å¹³çœŸè¯ ')
                                                        if ziping_temp:
                                                            ziping_analysis_temp = ziping_temp.analyze(bazi_data_cml)
                                                            yongshen_info_temp = ziping_analysis_temp.details.get('yongshen_info', {})
                                                            yongshen_method = yongshen_info_temp.get('method', '')
                                                            if not yongshen_method:
                                                                for _k in ['yongshen_method', 'æ–¹æ³•', 'ç”¨ç¥æ–¹æ³•']:
                                                                    if yongshen_info_temp.get(_k):
                                                                        yongshen_method = yongshen_info_temp.get(_k)
                                                                        break
                                                            if yongshen_method:
                                                                print(f"ğŸ” è°ƒè¯•ï¼šç”¨ç¥æ–¹æ³•ï¼ˆé‡æ–°åˆ†æï¼‰= {yongshen_method}")
                                                    except Exception:
                                                        pass

                                                jixiong_info = dayun_analyzer._judge_single_dayun_xiji(
                                                    gan, zhi, day_master,
                                                    xishen_wuxing=xishen_param,
                                                    jishen_wuxing=jishen_param,
                                                    pillars=pillars_for_analyzer,
                                                    yongshen_method=yongshen_method
                                                )
                                                # ğŸ”¥ è°ƒè¯•ï¼šæ‰“å°åˆ¤æ–­ç»“æœ
                                                debug_msg = f"âœ… å¤§è¿{gan}{zhi}åˆ¤æ–­ç»“æœ: {jixiong_info}"
                                                print(debug_msg)
                                                with open('dayun_debug.txt', 'a', encoding='utf-8') as f:
                                                    f.write(f"{debug_msg}\n")
                                            except Exception as e:
                                                print(f"âš ï¸ å¤§è¿å‰å‡¶åˆ¤æ–­å¤±è´¥: {e}")
                                                import traceback
                                                traceback.print_exc()
                                                pass
                                        else:
                                            debug_msg = f"âš ï¸ å¤§è¿{gan}{zhi}: æ¡ä»¶ä¸æ»¡è¶³"
                                            print(debug_msg)
                                            with open('dayun_debug.txt', 'a', encoding='utf-8') as f:
                                                f.write(f"{debug_msg}\n")
                                            if not day_master:
                                                debug_msg = f"âš ï¸ å¤§è¿{gan}{zhi}: æ—¥ä¸»ä¸ºç©ºï¼Œæ— æ³•åˆ¤æ–­"
                                                print(debug_msg)
                                                with open('dayun_debug.txt', 'a', encoding='utf-8') as f:
                                                    f.write(f"{debug_msg}\n")
                                            if not hasattr(dayun_analyzer, '_judge_single_dayun_xiji'):
                                                debug_msg = f"âš ï¸ å¤§è¿{gan}{zhi}: dayun_analyzeræ²¡æœ‰_judge_single_dayun_xijiæ–¹æ³•"
                                                print(debug_msg)
                                                with open('dayun_debug.txt', 'a', encoding='utf-8') as f:
                                                    f.write(f"{debug_msg}\n")

                                        # ğŸ”¥ æ–°å¢ï¼šä½¿ç”¨æ ¼å±€åˆ†æå™¨åˆ¤æ–­ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                                        if use_pattern_analyzer and pattern_info.get('pattern'):
                                            try:
                                                pattern_result = pattern_analyzer.judge_dayun_step(
                                                    gan, zhi, day_master,
                                                    pillars_for_analyzer,
                                                    pattern_info,
                                                    yongshen_info_for_pattern
                                                )
                                                description = pattern_result.get('description', '')
                                                level_from_pattern = pattern_result.get('level', 'ä¸­å¹³')
                                                reason = pattern_result.get('reason', '')

                                                # æ˜ å°„ç­‰çº§åˆ°æç¤ºè¯
                                                level_map = {'å¤§å‰': 'å¤§å–œ', 'å‰': 'å°å–œ', 'ä¸­å¹³': 'ä¸­ç­‰', 'å°å‡¶': 'ä¸€èˆ¬', 'å‡¶': 'è°¨æ…'}
                                                label_txt = level_map.get(level_from_pattern, 'ä¸­ç­‰')

                                                # æ ¼å¼åŒ–æ˜¾ç¤ºï¼šåºå·. å¹²æ”¯ å¹´é¾„èŒƒå›´ å…¬å†å¹´ä»½èŒƒå›´ æè¿°
                                                analysis_text += f"    {i:>2}. {gan}{zhi} ({start_age_int}-{end_age_int}å², {start_year}-{end_year}å¹´)ï¼š{description}\n"

                                                # å†™å…¥è°ƒè¯•ä¿¡æ¯
                                                with open('dayun_debug.txt', 'a', encoding='utf-8') as f:
                                                    f.write(f"âœ… æ ¼å±€åˆ†æå™¨åˆ¤æ–­: {gan}{zhi} -> {description} (ç­‰çº§:{level_from_pattern}, ç†ç”±:{reason})\n")
                                            except Exception as e:
                                                print(f"âš ï¸ æ ¼å±€åˆ†æå™¨åˆ¤æ–­å¤±è´¥: {e}")
                                                import traceback
                                                traceback.print_exc()
                                                # é™çº§åˆ°åŸæœ‰é€»è¾‘
                                                xiji = jixiong_info.get('xiji', 'å¹³')
                                                level = jixiong_info.get('level', 'å¹³è¿')
                                                label_map_primary = {'å¤§å–œ': 'å¤§å–œ', 'å°å–œ': 'å°å–œ', 'å¹³': 'ä¸­ç­‰', 'å°å¿Œ': 'ä¸€èˆ¬', 'å¤§å¿Œ': 'è°¨æ…'}
                                                label_map_secondary = {'å¤§å‰': 'å¤§å–œ', 'å‰': 'å°å–œ', 'ä¸­å¹³': 'ä¸­ç­‰', 'å°å‡¶': 'ä¸€èˆ¬', 'å‡¶': 'è°¨æ…'}
                                                label_txt = label_map_primary.get(xiji, label_map_secondary.get(level, 'ä¸­ç­‰'))
                                                
                                                # âœ… æ–°å¢ï¼šåˆ¤æ–­å½“å‰å¤§è¿å’Œå…³é”®è½¬æŠ˜
                                                from datetime import datetime
                                                current_year = datetime.now().year
                                                current_age = current_year - birth_year
                                                is_current = start_age_int <= current_age < end_age_int
                                                
                                                is_key_turning = False
                                                turning_reason = ''
                                                if zhi in ['è¾°', 'æˆŒ', 'ä¸‘', 'æœª'] and gan in ['æˆŠ', 'å·±']:
                                                    if 'åœŸé‡' in str(dayun_result_cml.description or '') or 'åŸ‹é‡‘' in str(dayun_result_cml.description or ''):
                                                        is_key_turning = True
                                                        turning_reason = 'åœŸé‡åŸ‹é‡‘æœ€é‡'
                                                
                                                mark = ''
                                                if is_current:
                                                    mark = ' âš ï¸ å½“å‰å¤§è¿'
                                                elif is_key_turning:
                                                    mark = f' ğŸ”¥ å…³é”®è½¬æŠ˜ï¼š{turning_reason}'
                                                
                                                analysis_text += f"    {i:>2}. {gan}{zhi} {start_age_int}~{end_age_int}å² ({start_year}-{end_year}å¹´) ç­‰çº§ï¼š{label_txt}{mark}\n"
                                        else:
                                            # ä½¿ç”¨åŸæœ‰é€»è¾‘
                                            xiji = jixiong_info.get('xiji', 'å¹³')
                                            level = jixiong_info.get('level', 'å¹³è¿')
                                            reason = jixiong_info.get('reason', '')  # âœ… æ–°å¢ï¼šæ˜¾ç¤ºåˆ¤æ–­ä¾æ®
                                            label_map_primary = {'å¤§å–œ': 'å¤§å–œ', 'å°å–œ': 'å°å–œ', 'å¹³': 'ä¸­ç­‰', 'å°å¿Œ': 'ä¸€èˆ¬', 'å¤§å¿Œ': 'è°¨æ…'}
                                            label_map_secondary = {'å¤§å‰': 'å¤§å–œ', 'å‰': 'å°å–œ', 'ä¸­å¹³': 'ä¸­ç­‰', 'å°å‡¶': 'ä¸€èˆ¬', 'å‡¶': 'è°¨æ…'}
                                            label_txt = label_map_primary.get(xiji, label_map_secondary.get(level, 'ä¸­ç­‰'))
                                            if reason:
                                                analysis_text += f"    {i:>2}. {gan}{zhi} {start_age_int}~{end_age_int}å² ({start_year}-{end_year}å¹´) ç­‰çº§ï¼š{label_txt}ï¼ˆ{reason}ï¼‰\n"
                                            else:
                                                analysis_text += f"    {i:>2}. {gan}{zhi} {start_age_int}~{end_age_int}å² ({start_year}-{end_year}å¹´) ç­‰çº§ï¼š{label_txt}\n"
                                    analysis_text += "\n"
                            except Exception as e:
                                import traceback
                                print(f"âš ï¸ å¤§è¿æ˜ç»†ç”Ÿæˆå¤±è´¥: {e}")
                                traceback.print_exc()
                                pass
                            print(f"âœ… å…­ä¹¦åº“å¤§è¿åˆ†æå®Œæˆ")
                            # ä¿å­˜ç»“æœä¾›åç»­ä½¿ç”¨
                            dayun_result = {
                                'qiyun_info': {
                                    'qiyun_age_desc': f"{dayun_result_cml.details.get('qiyun_age', 'æœªçŸ¥')}å²",
                                    'shun_ni': dayun_result_cml.details.get('direction', 'æœªçŸ¥')
                                },
                                'jixiong_info': {
                                    'jixiong': dayun_result_cml.level,
                                    'classic_basis': 'ã€Šä¸‰å‘½é€šä¼šÂ·å¤§è¿ç¯‡ã€‹',
                                    'detail': ''  # å…­ä¹¦åº“å¤§è¿åˆ†æä¸æä¾›è¯¦ç»†åˆ—è¡¨
                                },
                                'dayun_list': []  # å…­ä¹¦åº“å¤§è¿åˆ†æä¸æä¾›è¯¦ç»†åˆ—è¡¨
                            }
                            # åˆå§‹åŒ–å˜é‡ä¾›åç»­ä½¿ç”¨
                            qiyun_info = dayun_result['qiyun_info']
                            jixiong_info = dayun_result['jixiong_info']
                        except Exception as e:
                            print(f"âš ï¸ å…­ä¹¦åº“å¤§è¿åˆ†æå¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()
                            # ğŸ”¥ ä¿®å¤ï¼šä¸å†é™çº§åˆ°å¤‡ç”¨åˆ†æå™¨ï¼Œç›´æ¥æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                            analysis_text += f"ã€å¤§è¿åˆ†æã€‘ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ï¼‰\n"
                            analysis_text += f"âš ï¸ å¤§è¿åˆ†æå¤±è´¥ï¼š{str(e)}\n"
                            analysis_text += f"è¯·æ£€æŸ¥å‡ºç”Ÿä¿¡æ¯æ˜¯å¦å®Œæ•´å‡†ç¡®ã€‚\n\n"
                    else:
                        # ğŸ”¥ ä¿®å¤ï¼šå…­ä¹¦åº“ä¸å¯ç”¨æ—¶ï¼Œæ˜¾ç¤ºæ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
                        print(f"âš ï¸ å…­ä¹¦åº“åˆ†æå™¨ä¸å¯ç”¨")
                        analysis_text += f"ã€å¤§è¿åˆ†æã€‘ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ï¼‰\n"
                        analysis_text += f"âš ï¸ å…­ä¹¦åº“åˆ†æå™¨ä¸å¯ç”¨ï¼Œæ— æ³•è¿›è¡Œå¤§è¿åˆ†æã€‚\n"
                        analysis_text += f"è¯·ç¡®ä¿chinese_metaphysics_libraryå·²æ­£ç¡®å®‰è£…ã€‚\n\n"
                    # âœ… ä¿®å¤ï¼šç¡®ä¿jixiong_infoå·²å®šä¹‰
                    if 'jixiong_info' not in locals():
                        jixiong_info = dayun_result.get('jixiong_info', {}) if 'dayun_result' in locals() else {}
                    jixiong_detail = jixiong_info.get('detail')
                    if jixiong_detail and False:  # disabled corrupted block; replaced below
                        analysis_text += f"  â–· å‰å‡¶è¯¦è§£ï¼š\n"
                        for line in jixiong_detail.splitlines():
                            analysis_text += f"    {line}\n"
                        analysis_text += "\n"
                    # Rewritten clean output for å‰å‡¶è¯¦è§£ ä¸ å¤§è¿åˆ—è¡¨ï¼ˆå‰åæ­¥ï¼‰
                    if jixiong_detail:
                        analysis_text += f"  â–· å‰å‡¶è¯¦è§£ï¼š\n"
                        for line in jixiong_detail.splitlines():
                            analysis_text += f"    {line}\n"
                        analysis_text += "\n"
                    # â–· å¤§è¿åˆ—è¡¨ï¼ˆå‰åæ­¥ï¼‰
                    dayun_list = dayun_result.get('dayun_list', []) or []
                    if dayun_list:
                        analysis_text += f"  â–· å¤§è¿åˆ—è¡¨ï¼ˆå‰åæ­¥ï¼‰ï¼š\n"
                        for item in dayun_list[:10]:
                            gz = item.get('ganzhi', '')
                            tg = item.get('ten_god', '')
                            sa = item.get('start_age', '')
                            ea = item.get('end_age', '')
                            analysis_text += f"    {item.get('index', 0):>2}. {gz}ï¼ˆ{tg}ï¼‰ {sa}~{ea}å²\n"
                        analysis_text += "\n"

                    if False:

                        #     
                        dayun_list = dayun_result.get('dayun_list', []) or []
                        if dayun_list:
                            analysis_text += f"   \uff08\uff09\uff1a\n"
                            for item in dayun_list[:10]:
                                gz = item.get('ganzhi', '')
                                tg = item.get('ten_god', '')
                                sa = item.get('start_age', '')
                                ea = item.get('end_age', '')
                                analysis_text += f"    {item.get('index', 0):>2}. {gz}\uff08{tg}\uff09 {sa}~{ea}\u5c81\n"
                            analysis_text += "\n"


                    profile_raw = dayun_result.get('profile', {})
                    profile_proxy = None
                    if profile_raw:
                        analysis_text += f"ã€æ—¥ä¸»å¼ºå¼±ã€‘\n"
                        analysis_text += f"äº”è¡Œï¼š{profile_raw.get('element', 'æœªçŸ¥')}  å¼ºå¼±ï¼š{profile_raw.get('strength', 'æœªçŸ¥')}\n"
                        distribution = profile_raw.get('distribution', {})
                        if distribution:
                            dist_text = ' '.join([f"{k}:{v:.2f}" for k, v in distribution.items()])
                            analysis_text += f"äº”è¡Œåˆ†å¸ƒï¼š{dist_text}\n\n"
                        else:
                            analysis_text += "\n"

                        strength = profile_raw.get('strength')
                        if strength:
                            # ğŸ”¥ ä¿®å¤ï¼šæ ¹æ®æ—¥ä¸»å¼ºå¼±ç²¾ç¡®åˆ¤æ–­æ ¼å±€ç±»å‹
                            pattern_map = {
                                'æ—º': 'èº«å¼ºæ ¼',
                                'ä¸­æ—º': 'èº«å¼ºæ ¼',
                                'ä¸­å’Œ': 'ä¸­å’Œæ ¼',
                                'ä¸­å¼±': 'èº«å¼±æ ¼',
                                'å¼±': 'èº«å¼±æ ¼'
                            }
                            bazi_snapshot['bazi_pattern']['pattern_type'] = pattern_map.get(strength, 'ä¸­å’Œæ ¼')

                        class _DayunProfile:
                            def __init__(self, data: Dict[str, Any]):
                                self.element = data.get('element')
                                self.strength = data.get('strength')
                                self.support_power = data.get('support_power', 0.0)
                                self.pressure_power = data.get('pressure_power', 0.0)
                                self.distribution = data.get('distribution', {})

                        profile_proxy = _DayunProfile(profile_raw)

                    dayun_table = dayun_result.get('dayun_list', [])
                    if dayun_table:
                        analysis_text += "  â–· å¤§è¿åˆ—è¡¨ï¼ˆå‰åæ­¥ï¼‰ï¼š\n"
                        for item in dayun_table[:10]:
                            span = f"{item['start_age']}~{item['end_age']}å²"
                            combo = ' '.join([f"{k}:{v:.1f}" for k, v in item.get('combined_elements', {}).items()])
                            if profile_proxy:
                                # åˆ‡æ¢ä¸ºå…­ä¹¦åº“çš„å•æ­¥å¤§è¿å‰å‡¶åˆ¤æ–­ï¼ˆä¸å†ä½¿ç”¨ classic_analyzer.dayunï¼‰
                                if profile_proxy and (('dayun_analyzer' in locals()) or ('dayun_analyzer' in globals())):
                                    try:
                                        gz = item.get('ganzhi', '')
                                        gan = gz[0] if len(gz) >= 1 else ''
                                        zhi = gz[1] if len(gz) >= 2 else ''
                                        _info = dayun_analyzer._judge_single_dayun_xiji(
                                            gan, zhi, day_master,
                                            xishen_wuxing=xishen_wuxing or [],
                                            jishen_wuxing=jishen_wuxing or [],
                                            pillars=pillars_for_analyzer,
                                            yongshen_method=None
                                        )
                                        eval_info = {'jixiong': _info.get('level', 'æœªçŸ¥'), 'detail': _info.get('detail', '')}
                                    except Exception:
                                        eval_info = {'jixiong': 'æœªçŸ¥', 'detail': ''}
                                else:
                                    eval_info = {'jixiong': 'æœªçŸ¥', 'detail': ''}
                            else:
                                eval_info = {'jixiong': 'æœªçŸ¥', 'detail': ''}
                            level_text = eval_info.get('jixiong', 'æœªçŸ¥')
                            detail_line = ''
                            detail = eval_info.get('detail')
                            if detail:
                                detail_line = detail.splitlines()[0]
                            analysis_text += (
                                f"    - {span}ï¼š{item['ganzhi']}ï¼ˆ{item['ten_god']}ï¼‰ï¼Œ"
                                f"{level_text}ï¼Œäº”è¡Œ {combo}"
                            )
                            if detail_line:
                                analysis_text += f"ï¼›{detail_line}"
                            analysis_text += "\n"
                        analysis_text += "\n"

                        # âœ… ä¿®å¤ï¼šåŸºäºå¤§è¿å–œå¿Œç”Ÿæˆè´¢è¿è¯¦ç»†é¢„æµ‹ï¼ˆä¸æ‰“åˆ†ï¼‰
                        try:
                            evaluated = []
                            birth_year = birth_info.get('solar_year') or birth_info.get('year')

                            for item in dayun_table:
                                # åˆ‡æ¢ä¸ºå…­ä¹¦åº“çš„å•æ­¥å¤§è¿å‰å‡¶åˆ¤æ–­ï¼ˆä¸å†ä½¿ç”¨ classic_analyzer.dayunï¼‰
                                try:
                                    if (('dayun_analyzer' in locals()) or ('dayun_analyzer' in globals())) and profile_proxy:
                                        gz = item.get('ganzhi', '')
                                        gan = gz[0] if len(gz) >= 1 else ''
                                        zhi = gz[1] if len(gz) >= 2 else ''
                                        _info = dayun_analyzer._judge_single_dayun_xiji(
                                            gan, zhi, day_master,
                                            xishen_wuxing=xishen_wuxing or [],
                                            jishen_wuxing=jishen_wuxing or [],
                                            pillars=pillars_for_analyzer,
                                            yongshen_method=None
                                        )
                                        info = {'xiji': _info.get('xiji', 'å¹³'), 'jixiong': _info.get('level', 'æœªçŸ¥'), 'detail': _info.get('detail', ''), 'classic_basis': _info.get('classic_basis', '')}
                                    else:
                                        info = {'xiji': 'å¹³', 'jixiong': 'æœªçŸ¥', 'detail': ''}
                                except Exception:
                                    info = {'xiji': 'å¹³', 'jixiong': 'æœªçŸ¥', 'detail': ''}

                                # è®¡ç®—å…·ä½“å…¬å†å¹´ä»½
                                start_year = birth_year + item['start_age']
                                end_year = birth_year + item['end_age']
                                year_span = f"{start_year}-{end_year}å¹´"

                                # âœ… ä¿®å¤ï¼šä½¿ç”¨å–œå¿Œåˆ¤æ–­ï¼Œä¸ä½¿ç”¨åˆ†æ•°
                                xiji = info.get('xiji', 'å¹³')
                                level = info.get('jixiong', 'æœªçŸ¥')

                                evaluated.append({
                                    'span': f"{item['start_age']}~{item['end_age']}å²",
                                    'year_span': year_span,
                                    'start_year': start_year,
                                    'end_year': end_year,
                                    'ganzhi': item.get('ganzhi', ''),
                                    'xiji': xiji,  # å–œå¿Œåˆ¤æ–­
                                    'level': level,  # å‰å‡¶ç­‰çº§
                                    'detail': info.get('detail', ''),
                                    'classic_basis': info.get('classic_basis', ''),
                                    'is_current': is_current_dayun,  # âœ… æ–°å¢
                                    'is_key_turning': is_key_turning,  # âœ… æ–°å¢
                                    'turning_reason': turning_reason,  # âœ… æ–°å¢
                                    'mark': mark  # âœ… æ–°å¢
                                })

                            # âœ… ä¿®å¤ï¼šæœ€ä½³èµšé’±é˜¶æ®µ - é€‰å–œç¥å¤§è¿ï¼ˆå¤§å–œã€å°å–œï¼‰
                            best = [e for e in evaluated if e['xiji'] in ['å¤§å–œ', 'å°å–œ']][:3]
                            best_spans = []
                            for b in best:
                                # æå–ç¬¬ä¸€è¡Œè¯´æ˜
                                detail_lines = b['detail'].split('\n')
                                ganzhi_line = detail_lines[0] if detail_lines else ''
                                best_spans.append(f"{b['year_span']}ï¼ˆ{b['span']}ï¼Œ{b['ganzhi']}ï¼Œ{b['xiji']}ï¼‰")

                            # âœ… ä¿®å¤ï¼šç ´è´¢è­¦ç¤ºé˜¶æ®µ - é€‰å¿Œç¥å¤§è¿ï¼ˆå¤§å¿Œã€å°å¿Œï¼‰
                            warn = [e for e in evaluated if e['xiji'] in ['å¤§å¿Œ', 'å°å¿Œ']][:3]
                            warn_spans = []
                            for w in warn:
                                detail_lines = w['detail'].split('\n')
                                ganzhi_line = detail_lines[0] if detail_lines else ''
                                warn_spans.append(f"{w['year_span']}ï¼ˆ{w['span']}ï¼Œ{w['ganzhi']}ï¼Œ{w['xiji']}ï¼‰")

                        except Exception:
                            best_spans = []
                            warn_spans = []

                    # 3. ç¥ç…åˆ†æï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç†è®ºï¼‰
                    print(f"ğŸ” å¼€å§‹ç¥ç…åˆ†æ...")
                    if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                        try:
                            # ä½¿ç”¨å…­ä¹¦åº“çš„ã€Šä¸‰å‘½é€šä¼šã€‹ç¥ç…åˆ†æ
                            shensha_result_cml = unified_analyzer_cml.analyzers['ä¸‰å‘½é€šä¼š'].shensha_analyzer.analyze(bazi_data_cml)
                            ji_shen_list = shensha_result_cml.details.get('ji_shen', [])
                            xiong_shen_list = shensha_result_cml.details.get('xiong_shen', [])
                            
                            # ğŸ”¥ ä¿®å¤ï¼šç»Ÿè®¡å»é‡åçš„ç¥ç…æ•°é‡ï¼ˆæŒ‰åç§°å»é‡ï¼‰
                            ji_shen_names = set(item.get('name', 'æœªçŸ¥') for item in ji_shen_list)
                            xiong_shen_names = set(item.get('name', 'æœªçŸ¥') for item in xiong_shen_list)
                            ji_shen_unique_count = len(ji_shen_names)
                            xiong_shen_unique_count = len(xiong_shen_names)
                            
                            analysis_text += f"ã€ç¥ç…åˆ†æã€‘ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ï¼‰\n"
                            # å¦‚æœå»é‡åæ•°é‡ä¸åŸå§‹æ•°é‡ç›¸åŒï¼Œåªæ˜¾ç¤ºä¸€ä¸ªæ•°å­—ï¼›å¦åˆ™æ˜¾ç¤º"Xä¸ªï¼ˆYå¤„ï¼‰"
                            if len(ji_shen_list) == ji_shen_unique_count:
                                analysis_text += f"å‰ç¥ï¼š{ji_shen_unique_count}ä¸ª\n"
                            else:
                                analysis_text += f"å‰ç¥ï¼š{ji_shen_unique_count}ä¸ªï¼ˆå…±{len(ji_shen_list)}å¤„ï¼‰\n"
                            
                            if len(xiong_shen_list) == xiong_shen_unique_count:
                                analysis_text += f"å‡¶ç¥ï¼š{xiong_shen_unique_count}ä¸ª\n"
                            else:
                                analysis_text += f"å‡¶ç¥ï¼š{xiong_shen_unique_count}ä¸ªï¼ˆå…±{len(xiong_shen_list)}å¤„ï¼‰\n"
                            analysis_text += f"ç»¼åˆè¯„ä»·ï¼š{shensha_result_cml.level}\n"
                            # âœ… æ–°å¢ï¼šæ˜¾ç¤ºåŸºäºã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤©æœˆå¾·ã€‹çš„åˆ¤æ–­ä¾æ®
                            shensha_level_reason = shensha_result_cml.details.get('level_reason', {})
                            if isinstance(shensha_level_reason, dict) and shensha_level_reason.get('reason'):
                                analysis_text += f"åˆ¤æ–­ä¾æ®ï¼š{shensha_level_reason.get('reason', '')}\n"
                            analysis_text += "\n"
                            # ğŸ”¥ ä¿®å¤ï¼šä½ç½®è‹±æ–‡è½¬ä¸­æ–‡çš„æ˜ å°„
                            position_map = {
                                'year': 'å¹´æŸ±',
                                'month': 'æœˆæŸ±',
                                'day': 'æ—¥æŸ±',
                                'hour': 'æ—¶æŸ±',
                                'å¹´æŸ±': 'å¹´æŸ±',
                                'æœˆæŸ±': 'æœˆæŸ±',
                                'æ—¥æŸ±': 'æ—¥æŸ±',
                                'æ—¶æŸ±': 'æ—¶æŸ±'
                            }

                            if ji_shen_list:
                                analysis_text += "  âœ“ å‰ç¥è¯¦æƒ…ï¼š\n"
                                # âœ… æ•´åˆï¼šåŒºåˆ†è´µäººå’Œéè´µäººå‰ç¥
                                # è´µäººç±»å‹ï¼šåœ¨ç¥ç…åˆ†æä¸­åªæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯ï¼Œè¯¦ç»†ä¿¡æ¯åœ¨"è´µäººåˆ†æ"éƒ¨åˆ†æ˜¾ç¤º
                                guiren_types = ['å¤©ä¹™è´µäºº', 'å¤©å¾·è´µäºº', 'æœˆå¾·è´µäºº', 'æ–‡æ˜Œè´µäºº', 'å¤ªæè´µäºº', 
                                               'å›½å°è´µäºº', 'ç¦æ˜Ÿè´µäºº', 'ä¸‰å¥‡è´µäºº', 'å¤©å®˜è´µäºº', 'å­¦å ‚', 'è¯é¦†']
                                
                                non_guiren_ji = []
                                guiren_ji_names = set()
                                
                                for item in ji_shen_list:
                                    name = item.get('name', 'æœªçŸ¥')
                                    # åˆ¤æ–­æ˜¯å¦ä¸ºè´µäººç±»å‹
                                    is_guiren = name in guiren_types or 'è´µäºº' in name
                                    
                                    if is_guiren:
                                        # è´µäººç±»å‹ï¼šåªè®°å½•åç§°ï¼Œè¯¦ç»†ä¿¡æ¯åœ¨"è´µäººåˆ†æ"éƒ¨åˆ†æ˜¾ç¤º
                                        guiren_ji_names.add(name)
                                    else:
                                        # éè´µäººå‰ç¥ï¼šæ­£å¸¸æ˜¾ç¤ºè¯¦æƒ…
                                        non_guiren_ji.append(item)
                                
                                # æ˜¾ç¤ºéè´µäººå‰ç¥
                                for item in non_guiren_ji:
                                    position = item.get('position', 'æœªçŸ¥')
                                    position_cn = position_map.get(position, position)
                                    analysis_text += f"    â˜† {item.get('name', 'æœªçŸ¥')}ï¼ˆ{position_cn}ï¼‰æƒé‡ï¼š{item.get('weight', 0)}  {item.get('description', '')}\n"
                                
                                # å¦‚æœæœ‰è´µäººï¼Œæç¤ºåœ¨"è´µäººåˆ†æ"éƒ¨åˆ†æŸ¥çœ‹è¯¦æƒ…
                                if guiren_ji_names:
                                    guiren_list_str = 'ã€'.join(sorted(guiren_ji_names))
                                    analysis_text += f"    â˜† è´µäººæ˜Ÿï¼š{guiren_list_str}ï¼ˆè¯¦ç»†åˆ†æè§ä¸‹æ–¹ã€è´µäººåˆ†æã€‘ï¼‰\n"
                            if xiong_shen_list:
                                analysis_text += "  âœ— å‡¶ç¥è¯¦æƒ…ï¼š\n"
                                # ğŸ”¥ ä¿®å¤ï¼šå»é‡æ˜¾ç¤ºï¼Œç›¸åŒç¥ç…åç§°åˆå¹¶æ˜¾ç¤ºä½ç½®
                                # âœ… ä¿®å¤ï¼šå¤„ç†positionå¯èƒ½æ˜¯"monthã€day"è¿™æ ·çš„å­—ç¬¦ä¸²
                                xiong_dict = {}
                                for item in xiong_shen_list:
                                    name = item.get('name', 'æœªçŸ¥')
                                    position = item.get('position', 'æœªçŸ¥')
                                    weight = item.get('weight', 0)
                                    description = item.get('description', '')

                                    if name not in xiong_dict:
                                        xiong_dict[name] = {
                                            'positions': [],
                                            'weights': [],
                                            'description': description
                                        }
                                    
                                    # âœ… ä¿®å¤ï¼šå¤„ç†positionå¯èƒ½æ˜¯å¤šä¸ªä½ç½®ç”¨"ã€"è¿æ¥çš„å­—ç¬¦ä¸²
                                    if 'ã€' in str(position):
                                        # å¦‚æœæ˜¯å¤šä¸ªä½ç½®ï¼Œæ‹†åˆ†å¼€æ¥åˆ†åˆ«è½¬æ¢
                                        pos_list = [p.strip() for p in str(position).split('ã€')]
                                        for pos in pos_list:
                                            pos_cn = position_map.get(pos, pos)
                                            if pos_cn not in xiong_dict[name]['positions']:
                                                xiong_dict[name]['positions'].append(pos_cn)
                                    else:
                                        # å•ä¸ªä½ç½®
                                        position_cn = position_map.get(position, position)
                                        if position_cn not in xiong_dict[name]['positions']:
                                            xiong_dict[name]['positions'].append(position_cn)
                                    
                                    xiong_dict[name]['weights'].append(weight)

                                # æ˜¾ç¤ºå»é‡åçš„å‡¶ç¥
                                for name, info in xiong_dict.items():
                                    positions_str = 'ã€'.join(info['positions'])
                                    # å¦‚æœæœ‰å¤šä¸ªä½ç½®ï¼Œæ˜¾ç¤ºæ‰€æœ‰ä½ç½®ï¼›å¦åˆ™åªæ˜¾ç¤ºä¸€æ¬¡
                                    if len(info['positions']) > 1:
                                        # ç›¸åŒç¥ç…åœ¨å¤šä¸ªä½ç½®ï¼Œåˆå¹¶æ˜¾ç¤º
                                        max_weight = max(info['weights'])
                                        analysis_text += f"    âœ• {name}ï¼ˆ{positions_str}ï¼‰æƒé‡ï¼š{max_weight}  {info['description']}\n"
                                    else:
                                        analysis_text += f"    âœ• {name}ï¼ˆ{positions_str}ï¼‰æƒé‡ï¼š{info['weights'][0]}  {info['description']}\n"
                            if ji_shen_list or xiong_shen_list:
                                analysis_text += "\n"
                            # ç¥ç…ç»„åˆåˆ†æ
                            analysis_text += "  ğŸ“Œ ç¥ç…ç»„åˆæ•ˆåº”åˆ†æï¼š\n"
                            if ji_shen_list and xiong_shen_list:
                                # ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨å»é‡åçš„æ•°é‡
                                analysis_text += f"    â€¢ å‘½å±€ä¸­æ—¢æœ‰å‰ç¥{ji_shen_unique_count}ä¸ªï¼Œä¹Ÿæœ‰å‡¶ç¥{xiong_shen_unique_count}ä¸ª\n"
                                analysis_text += f"    â€¢ éœ€è¦æ ¹æ®å¤§è¿æµå¹´ï¼Œè¶‹å‰é¿å‡¶\n"
                            elif ji_shen_list:
                                analysis_text += f"    â€¢ å‘½å±€ä»¥å‰ç¥ä¸ºä¸»ï¼Œå…ˆå¤©è¿åŠ¿è¾ƒå¥½\n"
                            elif xiong_shen_list:
                                analysis_text += f"    â€¢ å‘½å±€å‡¶ç¥åå¤šï¼Œéœ€è¦åœ¨å¤§è¿ä¸­åŒ–è§£\n"
                            else:
                                analysis_text += f"    â€¢ å‘½å±€ç¥ç…å¹³è¡¡ï¼Œæ— ç‰¹æ®Šå‰å‡¶å¾å…†\n"
                            # âœ… ä¼˜åŒ–ï¼šæ•´ç†å»ºè®®æ ¼å¼ï¼ˆåªæ˜¾ç¤ºéè´µäººå‰ç¥å’Œå‡¶ç¥çš„å»ºè®®ï¼Œè´µäººå»ºè®®åœ¨"è´µäººåˆ†æ"éƒ¨åˆ†æ˜¾ç¤ºï¼‰
                            advice_text = shensha_result_cml.advice
                            if advice_text:
                                import re
                                
                                # è¯†åˆ«è´µäººç±»å‹ï¼ˆç”¨äºè¿‡æ»¤ï¼‰
                                guiren_types = ['å¤©ä¹™è´µäºº', 'å¤©å¾·è´µäºº', 'æœˆå¾·è´µäºº', 'æ–‡æ˜Œè´µäºº', 'å¤ªæè´µäºº', 
                                               'å›½å°è´µäºº', 'ç¦æ˜Ÿè´µäºº', 'ä¸‰å¥‡è´µäºº', 'å¤©å®˜è´µäºº', 'å­¦å ‚', 'è¯é¦†']
                                
                                # åˆ†ç¦»ä¸åŒç±»å‹çš„å»ºè®®
                                if "å‰ç¥åˆ©ç”¨å»ºè®®ï¼š" in advice_text:
                                    analysis_text += f"\nğŸ’¡ å‰ç¥åˆ©ç”¨å»ºè®®ï¼š\n"
                                    ji_part = advice_text.split("å‰ç¥åˆ©ç”¨å»ºè®®ï¼š")[1].split("ï¼›")[0].split("å‡¶ç¥ï¼š")[0].strip()
                                    # è§£ææ¯ä¸ªå‰ç¥çš„å»ºè®®ï¼ˆæ ¼å¼ï¼šç¥ç…åï¼šå»ºè®®å†…å®¹ï¼‰
                                    ji_items = ji_part.split('ï¼›')
                                    seen_ji = set()
                                    for item in ji_items:
                                        item = item.strip()
                                        if 'ï¼š' in item:
                                            name = item.split('ï¼š')[0].strip()
                                            # âœ… è¿‡æ»¤ï¼šè´µäººç±»å‹çš„å»ºè®®ä¸åœ¨ç¥ç…åˆ†æä¸­æ˜¾ç¤ºï¼Œåœ¨"è´µäººåˆ†æ"éƒ¨åˆ†æ˜¾ç¤º
                                            is_guiren = name in guiren_types or 'è´µäºº' in name
                                            if not is_guiren:
                                                advice = item.split('ï¼š', 1)[1].strip()
                                                if name and name not in seen_ji:
                                                    seen_ji.add(name)
                                                    analysis_text += f"  â€¢ {name}ï¼š{advice}\n"
                                    
                                    # å¦‚æœæœ‰è´µäººï¼Œæç¤ºåœ¨ä¸‹æ–¹æŸ¥çœ‹
                                    guiren_in_advice = [item.split('ï¼š')[0].strip() for item in ji_items if 'ï¼š' in item and (item.split('ï¼š')[0].strip() in guiren_types or 'è´µäºº' in item.split('ï¼š')[0].strip())]
                                    if guiren_in_advice:
                                        analysis_text += f"  â€¢ è´µäººåˆ©ç”¨å»ºè®®è¯¦è§ä¸‹æ–¹ã€è´µäººåˆ†æã€‘éƒ¨åˆ†\n"
                                
                                if "å‡¶ç¥ï¼š" in advice_text:
                                    xiong_part = advice_text.split("å‡¶ç¥ï¼š")[1].split("åŒ–è§£å»ºè®®ï¼š")[0].strip()
                                    # å»é‡å‡¶ç¥åç§°
                                    xiong_names = list(dict.fromkeys([n.strip() for n in re.split(r'[ï¼Œ,]\s*', xiong_part.replace("ï¼Œéœ€æ³¨æ„åŒ–è§£", "")) if n.strip()]))
                                    if xiong_names:
                                        analysis_text += f"\nâš ï¸ å‡¶ç¥ï¼š{', '.join(xiong_names)}ï¼Œéœ€æ³¨æ„åŒ–è§£\n"
                                
                                if "åŒ–è§£å»ºè®®ï¼š" in advice_text:
                                    hua_jie_part = advice_text.split("åŒ–è§£å»ºè®®ï¼š")[1].strip()
                                    analysis_text += f"\nğŸ”§ åŒ–è§£å»ºè®®ï¼š\n"
                                    # è§£ææ¯ä¸ªå‡¶ç¥çš„åŒ–è§£å»ºè®®ï¼ˆæ ¼å¼ï¼šç¥ç…åï¼šåŒ–è§£æ–¹æ³•ï¼‰
                                    hua_jie_items = hua_jie_part.split('ï¼›')
                                    seen_hua_jie = set()
                                    for item in hua_jie_items:
                                        item = item.strip()
                                        if 'ï¼š' in item:
                                            name = item.split('ï¼š')[0].strip()
                                            advice = item.split('ï¼š', 1)[1].strip()
                                            if name and name not in seen_hua_jie:
                                                seen_hua_jie.add(name)
                                                analysis_text += f"  â€¢ {name}ï¼š{advice}\n"
                            else:
                                analysis_text += f"\n"
                            print(f"âœ… å…­ä¹¦åº“ç¥ç…åˆ†æå®Œæˆ")
                        except Exception as e:
                            print(f"âš ï¸ å…­ä¹¦åº“ç¥ç…åˆ†æå¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()
                            # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                            analysis_text += self.format_analysis_error("ç¥ç…åˆ†æ", str(e), "ã€Šä¸‰å‘½é€šä¼šã€‹")
                    else:
                        # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                        analysis_text += self.format_analysis_error("ç¥ç…åˆ†æ", "å…­ä¹¦åº“ä¸å¯ç”¨", "ã€Šä¸‰å‘½é€šä¼šã€‹")

                    # 4. æ ¼å±€åˆ†æï¼ˆåŸºäºã€Šå­å¹³çœŸè¯ ã€‹ï¼‰
                    print(f"ğŸ” å¼€å§‹æ ¼å±€åˆ†æ...")
                    if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                        try:
                            # ğŸ”¥ ä¼˜å…ˆä½¿ç”¨ã€Šå­å¹³çœŸè¯ ã€‹æ ¼å±€åˆ†æ
                            ziping_result = unified_analyzer_cml.analyzers['å­å¹³çœŸè¯ '].analyze(bazi_data_cml)

                            # æå–æ ¼å±€ä¿¡æ¯
                            pattern = ziping_result.details.get('pattern', 'æœªçŸ¥')
                            pattern_status = ziping_result.details.get('pattern_status', 'æœªçŸ¥')
                            yongshen_info = ziping_result.details.get('yongshen_info', {})
                            ten_god_count = ziping_result.details.get('ten_god_count', {})
                            yin_count = ten_god_count.get('æ­£å°', 0) + ten_god_count.get('åå°', 0)

                            # è·å–äº”è¡Œåˆ†å¸ƒ
                            wuxing_dist_geju = sxtwl_result.get('wuxing_distribution', {}) if sxtwl_result else {}

                            # åˆ¤æ–­æ ¼å±€æˆè´¥å’ŒæŠ¤å«å…³ã€æ¸…æµŠå…³
                            if pattern_status == 'æˆæ ¼':
                                chengbai = 'æ ¼å±€æˆç«‹'
                                # æ£€æŸ¥æ˜¯å¦æœ‰å°æ˜Ÿè¿‡é‡çš„é—®é¢˜
                                if yin_count > 3.0:
                                    chengbai = 'æ ¼å±€æœ‰æˆï¼Œä½†å°æ˜Ÿè¿‡æ—ºï¼Œæ ¼å±€å±‚æ¬¡å—å½±å“'
                            else:
                                chengbai = pattern_status

                            # æŠ¤å«å…³ï¼šåŠ¨æ€åˆ†æï¼ˆåŸºäºã€Šå­å¹³çœŸè¯ ã€‹ç†è®ºï¼‰
                            from chinese_metaphysics_library.zipingzhenquan.unified_analyzer import ZipingzhenquanAnalyzer

                            huwei_result = ZipingzhenquanAnalyzer.analyze_huwei_guan(
                                day_master=day_master,
                                pillars=pillars,
                                pattern=pattern,
                                ten_god_count=ten_god_count
                            )
                            huwei = huwei_result.get('description', 'æ— æŠ¤å«')

                            # æ¸…æµŠå…³ï¼šæ£€æŸ¥åœŸæ˜¯å¦è¿‡é‡
                            qingzhuo = 'è¾ƒæ¸…'
                            if wuxing_dist_geju and wuxing_dist_geju.get('åœŸ', 0) > 3.5:
                                qingzhuo = 'å°æ˜Ÿé‡é‡ï¼ŒåœŸé‡åŸ‹é‡‘ï¼Œç•¥æ˜¾æµ‘æµŠ'

                            analysis_text += f"ã€æ ¼å±€åˆ†æã€‘ï¼ˆåŸºäºã€Šå­å¹³çœŸè¯ ã€‹ï¼‰\n"
                            analysis_text += f"æ ¼å±€ç±»å‹ï¼š{pattern}"
                            if yin_count > 3.0:
                                analysis_text += f"ï¼ˆä½†å°æ˜Ÿè¿‡é‡ï¼‰"
                            analysis_text += f"\n"
                            analysis_text += f"æ ¼å±€æˆè´¥ï¼š{chengbai}\n"
                            analysis_text += f"  â€¢ æŠ¤å«å…³ï¼š{huwei}\n"
                            analysis_text += f"  â€¢ çœŸå‡å…³ï¼šæ ¼å±€æˆç«‹\n"
                            analysis_text += f"  â€¢ æ¸…æµŠå…³ï¼š{qingzhuo}\n"
                            analysis_text += f"ç»å…¸ä¾æ®ï¼šã€Šå­å¹³çœŸè¯ ã€‹ï¼šæ ¼å±€æˆè´¥çœ‹é…åˆï¼ŒæŠ¤å«å¾—åŠ›åˆ™æ ¼å±€æ¸…çº¯ã€‚\n\n"

                            # ğŸ”¥ ä¿®å¤ï¼šæ›´æ–°bazi_patternä¸­çš„æ ¼å±€ç±»å‹
                            if pattern != 'æœªçŸ¥':
                                bazi_snapshot['bazi_pattern']['pattern_type'] = pattern

                            # æ›´æ–°æ—¥ä¸»å¼ºå¼±
                            strong = ziping_result.details.get('strong', False)
                            bazi_snapshot['bazi_pattern']['strength_label'] = 'èº«å¼º' if strong else 'èº«å¼±'

                            print(f"âœ… å…­ä¹¦åº“æ ¼å±€åˆ†æå®Œæˆï¼Œå·²æ›´æ–°bazi_pattern: {pattern}")
                        except Exception as e:
                            print(f"âš ï¸ å…­ä¹¦åº“æ ¼å±€åˆ†æå¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()
                            # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                            analysis_text += self.format_analysis_error("æ ¼å±€åˆ†æ", str(e), "ã€Šå­å¹³çœŸè¯ ã€‹")
                    else:
                        # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                        analysis_text += self.format_analysis_error("æ ¼å±€åˆ†æ", "å…­ä¹¦åº“ä¸å¯ç”¨", "ã€Šå­å¹³çœŸè¯ ã€‹")

                    # 5. ç”¨ç¥åˆ†æï¼ˆåŸºäºã€Šå­å¹³çœŸè¯ ã€‹ã€Šæ»´å¤©é«“ã€‹ï¼‰
                    print(f"ğŸ” å¼€å§‹ç”¨ç¥åˆ†æ...")
                    # ğŸ”¥ ä¼˜åŒ–ï¼šå¤ç”¨æå‰åˆ†æçš„ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—
                    if ziping_result_early and ditian_result_early:
                        # å¤ç”¨æå‰åˆ†æçš„ç»“æœ
                        print(f"âœ… å¤ç”¨æå‰ç”¨ç¥åˆ†æç»“æœï¼Œé¿å…é‡å¤è®¡ç®—")
                        analysis_text += f"ã€ç”¨ç¥åˆ†æã€‘\n"
                        analysis_text += f"ã€Šå­å¹³çœŸè¯ ã€‹åˆ†æï¼š\n"
                        yongshen_info = ziping_result_early.details.get('yongshen_info', {})
                        analysis_text += f"  â€¢ ç”¨ç¥æ–¹æ³•ï¼š{yongshen_info.get('method', 'æœªçŸ¥')}\n"
                        analysis_text += f"  â€¢ ç”¨ç¥ï¼š{yongshen_info.get('yongshen', 'æœªçŸ¥')}\n"
                        if yongshen_info.get('xishen'):
                            analysis_text += f"  â€¢ å–œç¥ï¼š{yongshen_info.get('xishen', 'æœªçŸ¥')}\n"
                        if yongshen_info.get('jishen'):
                            analysis_text += f"  â€¢ å¿Œç¥ï¼š{yongshen_info.get('jishen', 'æœªçŸ¥')}\n"
                        analysis_text += f"  â€¢ {ziping_result_early.description}\n"
                        analysis_text += f"\nã€Šæ»´å¤©é«“ã€‹åˆ†æï¼š\n"
                        analysis_text += f"  â€¢ {ditian_result_early.description}\n"
                        analysis_text += f"  â€¢ é€šæ ¹ï¼š{ditian_result_early.details.get('tongen_level', 'æœªçŸ¥')}\n"
                        analysis_text += f"  â€¢ é€å¹²ï¼š{ditian_result_early.details.get('tougan_level', 'æœªçŸ¥')}\n"
                        analysis_text += f"\nç»å…¸ä¾æ®ï¼šã€Šå­å¹³çœŸè¯ ã€‹å…«ã€è®ºç”¨ç¥ï¼›åäº”ã€è®ºç›¸ç¥ç´§è¦ã€ã€Šæ»´å¤©é«“ã€‹é€šæ ¹é€å¹²\n"
                        analysis_text += f"{ziping_result_early.advice}\n"
                        analysis_text += f"{ditian_result_early.advice}\n\n"
                        print(f"âœ… ç”¨ç¥åˆ†æå®Œæˆï¼ˆå¤ç”¨æå‰åˆ†æç»“æœï¼‰")
                    elif CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                        try:
                            # ä½¿ç”¨å…­ä¹¦åº“çš„ã€Šå­å¹³çœŸè¯ ã€‹å’Œã€Šæ»´å¤©é«“ã€‹ç”¨ç¥åˆ†æ
                            ziping_result = unified_analyzer_cml.analyzers['å­å¹³çœŸè¯ '].analyze(bazi_data_cml)
                            ditian_result = unified_analyzer_cml.analyzers['æ»´å¤©é«“'].analyze(bazi_data_cml)
                            analysis_text += f"ã€ç”¨ç¥åˆ†æã€‘\n"
                            analysis_text += f"ã€Šå­å¹³çœŸè¯ ã€‹åˆ†æï¼š\n"
                            yongshen_info = ziping_result.details.get('yongshen_info', {})
                            analysis_text += f"  â€¢ ç”¨ç¥æ–¹æ³•ï¼š{yongshen_info.get('method', 'æœªçŸ¥')}\n"
                            analysis_text += f"  â€¢ ç”¨ç¥ï¼š{yongshen_info.get('yongshen', 'æœªçŸ¥')}\n"
                            if yongshen_info.get('xishen'):
                                analysis_text += f"  â€¢ å–œç¥ï¼š{yongshen_info.get('xishen', 'æœªçŸ¥')}\n"
                            if yongshen_info.get('jishen'):
                                analysis_text += f"  â€¢ å¿Œç¥ï¼š{yongshen_info.get('jishen', 'æœªçŸ¥')}\n"
                            analysis_text += f"  â€¢ {ziping_result.description}\n"
                            analysis_text += f"\nã€Šæ»´å¤©é«“ã€‹åˆ†æï¼š\n"
                            analysis_text += f"  â€¢ {ditian_result.description}\n"
                            analysis_text += f"  â€¢ é€šæ ¹ï¼š{ditian_result.details.get('tongen_level', 'æœªçŸ¥')}\n"
                            analysis_text += f"  â€¢ é€å¹²ï¼š{ditian_result.details.get('tougan_level', 'æœªçŸ¥')}\n"
                            analysis_text += f"\nç»å…¸ä¾æ®ï¼šã€Šå­å¹³çœŸè¯ ã€‹å…«ã€è®ºç”¨ç¥ï¼›åäº”ã€è®ºç›¸ç¥ç´§è¦ã€ã€Šæ»´å¤©é«“ã€‹é€šæ ¹é€å¹²\n"
                            analysis_text += f"{ziping_result.advice}\n"
                            analysis_text += f"{ditian_result.advice}\n\n"
                            print(f"âœ… å…­ä¹¦åº“ç”¨ç¥åˆ†æå®Œæˆ")
                        except Exception as e:
                            print(f"âš ï¸ å…­ä¹¦åº“ç”¨ç¥åˆ†æå¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()
                            # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                            analysis_text += self.format_analysis_error("ç”¨ç¥åˆ†æ", str(e), "ã€Šå­å¹³çœŸè¯ ã€‹ã€Šæ»´å¤©é«“ã€‹")
                    else:
                        # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                        analysis_text += self.format_analysis_error("ç”¨ç¥åˆ†æ", "å…­ä¹¦åº“ä¸å¯ç”¨", "ã€Šå­å¹³çœŸè¯ ã€‹ã€Šæ»´å¤©é«“ã€‹")

                    # 6. è°ƒå€™åˆ†æï¼ˆåŸºäºã€Šç©·é€šå®é‰´ã€‹ï¼‰
                    print(f"ğŸ” å¼€å§‹è°ƒå€™åˆ†æ...")
                    if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                        try:
                            # ä½¿ç”¨å…­ä¹¦åº“çš„ã€Šç©·é€šå®é‰´ã€‹è°ƒå€™åˆ†æ
                            qiongtong_result = unified_analyzer_cml.analyzers['ç©·é€šå®é‰´'].analyze(bazi_data_cml)
                            analysis_text += f"ã€è°ƒå€™åˆ†æã€‘ï¼ˆåŸºäºã€Šç©·é€šå®é‰´ã€‹ï¼‰\n"
                            analysis_text += f"{qiongtong_result.description}\n"
                            details = qiongtong_result.details
                            if details.get('yongshen'):
                                analysis_text += f"è°ƒå€™ç”¨ç¥ï¼š{', '.join(details.get('yongshen', []))}\n"
                            if details.get('xishen'):
                                analysis_text += f"å–œç¥ï¼š{', '.join(details.get('xishen', []))}\n"
                            if details.get('jishen'):
                                analysis_text += f"å¿Œç¥ï¼š{', '.join(details.get('jishen', []))}\n"
                            analysis_text += f"å­£èŠ‚ï¼š{details.get('season', 'æœªçŸ¥')}  æ¸©åº¦ï¼š{details.get('temperature', 'æœªçŸ¥')}\n"
                            analysis_text += f"\n{qiongtong_result.advice}\n\n"
                            print(f"âœ… å…­ä¹¦åº“è°ƒå€™åˆ†æå®Œæˆ")
                        except Exception as e:
                            print(f"âš ï¸ å…­ä¹¦åº“è°ƒå€™åˆ†æå¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()
                            # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                            analysis_text += self.format_analysis_error("è°ƒå€™åˆ†æ", str(e), "ã€Šç©·é€šå®é‰´ã€‹")
                    else:
                        # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                        analysis_text += self.format_analysis_error("è°ƒå€™åˆ†æ", "å…­ä¹¦åº“ä¸å¯ç”¨", "ã€Šç©·é€šå®é‰´ã€‹")

                    # 6-1. ç‰¹æ®Šæ ¼å±€åˆ†æï¼ˆåŸºäºã€Šå…°å°å¦™é€‰ã€‹ï¼‰
                    if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                        try:
                            print(f"ğŸ” å¼€å§‹ç‰¹æ®Šæ ¼å±€åˆ†æ...")
                            lantai_result = unified_analyzer_cml.analyzers['å…°å°å¦™é€‰'].analyze(bazi_data_cml)
                            analysis_text += f"ã€ç‰¹æ®Šæ ¼å±€åˆ†æã€‘ï¼ˆåŸºäºã€Šå…°å°å¦™é€‰ã€‹ï¼‰\n"
                            analysis_text += f"{lantai_result.description}\n"
                            pattern_results = lantai_result.details.get('pattern_results', [])
                            if pattern_results:
                                for pattern in pattern_results:
                                    analysis_text += f"  â€¢ {pattern.get('name', 'æœªçŸ¥')}ï¼š{pattern.get('status', 'æœªçŸ¥')} - {pattern.get('description', '')}\n"
                            analysis_text += f"\n{lantai_result.advice}\n\n"
                            print(f"âœ… å…­ä¹¦åº“ç‰¹æ®Šæ ¼å±€åˆ†æå®Œæˆ")
                        except Exception as e:
                            print(f"âš ï¸ å…­ä¹¦åº“ç‰¹æ®Šæ ¼å±€åˆ†æå¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()

                    # 6+. å…­äº²ã€è´¢å¯Œã€äº‹ä¸šã€å¥åº·ç­‰è¡¥å……åˆ†æ
                    # ğŸ”¥ ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨å…­ä¹¦åº“ã€Šæ¸Šæµ·å­å¹³ã€‹åˆ†æå™¨ï¼Œç¡®ä¿100+åŠŸèƒ½éƒ½æ˜¾ç¤º
                    print(f"ğŸ” å¼€å§‹å…­äº²ã€è´¢å¯Œã€äº‹ä¸šã€å¥åº·ç­‰è¡¥å……åˆ†æï¼ˆä¼˜å…ˆä½¿ç”¨å…­ä¹¦åº“ã€Šæ¸Šæµ·å­å¹³ã€‹ï¼‰...")
                    
                    # ğŸ”¥ ä¼˜å…ˆä½¿ç”¨å…­ä¹¦åº“ã€Šæ¸Šæµ·å­å¹³ã€‹åˆ†æå™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                    yuanhai_result = None
                    if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                        try:
                            yuanhai_result = unified_analyzer_cml.analyzers['æ¸Šæµ·å­å¹³'].analyze(bazi_data_cml)
                            print(f"âœ… å…­ä¹¦åº“ã€Šæ¸Šæµ·å­å¹³ã€‹åˆ†æå®Œæˆï¼ŒåŒ…å«å®Œæ•´å…­äº²ã€å©šå§»ã€è´¢è¿ã€äº‹ä¸šã€å¥åº·åˆ†æ")
                        except Exception as e:
                            print(f"âš ï¸ å…­ä¹¦åº“ã€Šæ¸Šæµ·å­å¹³ã€‹åˆ†æå¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()
                    
                    # 1. å…­äº²å©šå§»åˆ†æï¼ˆä¼˜å…ˆä½¿ç”¨å…­ä¹¦åº“ï¼‰- ä¸¥æ ¼æ¨¡å¼ï¼šåªä½¿ç”¨å…­ä¹¦åº“
                    try:
                        if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                            if yuanhai_result and yuanhai_result.details.get('marriage_analysis') is not None:
                                marriage_analysis = yuanhai_result.details['marriage_analysis']
                                # âœ… ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„å­—å…¸ï¼ˆéç©ºï¼‰
                                if not isinstance(marriage_analysis, dict) or not marriage_analysis:
                                    analysis_text += self.format_analysis_error("å…­äº²å©šå§»åˆ†æ", "å©šå§»åˆ†ææ•°æ®ä¸ºç©º", "ã€Šæ¸Šæµ·å­å¹³ã€‹")
                                else:
                                    spouse_star = marriage_analysis.get('spouse_star', 'æœªçŸ¥')
                                    spouse_star_count = marriage_analysis.get('spouse_star_count', 0)
                                    spouse_palace = marriage_analysis.get('spouse_palace', 'æœªçŸ¥')
                                    marriage_assessment_raw = marriage_analysis.get('marriage_assessment', {})
                                    # âœ… ä¿®å¤ï¼šmarriage_assessmentç°åœ¨æ˜¯å­—å…¸æ ¼å¼
                                    if isinstance(marriage_assessment_raw, dict):
                                        marriage_assessment = marriage_assessment_raw.get('description', 'åˆ†æä¸­')
                                    else:
                                        marriage_assessment = str(marriage_assessment_raw) if marriage_assessment_raw else 'åˆ†æä¸­'
                                    spouse_features = marriage_analysis.get('spouse_features', {})
                                    
                                    analysis_text += "ã€å…­äº²å©šå§»åˆ†æã€‘ï¼ˆåŸºäºã€Šæ¸Šæµ·å­å¹³ã€‹ï¼‰\n"
                                    analysis_text += f"â€¢ é…å¶æ˜Ÿï¼š{spouse_star}{spouse_star_count}ä¸ªï¼ˆ{'è´¢æ˜Ÿ' if gender == 'ç”·' else 'å®˜æ˜Ÿ'}ï¼‰\n"
                                    analysis_text += f"â€¢ é…å¶å®«ï¼šæ—¥æ”¯{spouse_palace}\n"
                                    analysis_text += f"â€¢ å©šå§»è¯„ä¼°ï¼š{marriage_assessment}\n"
                                    
                                    # âœ… å¢å¼ºï¼šæ˜¾ç¤ºé…å¶ç‰¹å¾
                                    if spouse_features and isinstance(spouse_features, dict):
                                        personality = spouse_features.get('personality', '')
                                        if personality:
                                            analysis_text += f"â€¢ é…å¶ç‰¹å¾ï¼š{personality}\n"
                                    
                                    # âœ… å¢å¼ºï¼šæ˜¾ç¤ºå¦»å®«ç‰¹å¾è¯¦ç»†åˆ†æ
                                    palace_analysis = marriage_analysis.get('palace_analysis', {})
                                    if palace_analysis:
                                        if isinstance(palace_analysis, dict):
                                            description = palace_analysis.get('description', '')
                                            if description:
                                                analysis_text += f"\nâ€¢ å¦»å®«ç‰¹å¾è¯¦ç»†åˆ†æï¼š{description}\n"
                                            # å¦‚æœæœ‰å…¶ä»–è¯¦ç»†ä¿¡æ¯ï¼Œä¹Ÿæ˜¾ç¤º
                                            personality = palace_analysis.get('personality', '')
                                            pressure = palace_analysis.get('pressure', '')
                                            relationship = palace_analysis.get('relationship', '')
                                            if personality or pressure or relationship:
                                                analysis_text += f"  - æ€§æ ¼ç‰¹å¾ï¼š{personality}\n" if personality else ""
                                                analysis_text += f"  - å‹åŠ›ç¨‹åº¦ï¼š{pressure}\n" if pressure else ""
                                                analysis_text += f"  - å…³ç³»ç‰¹ç‚¹ï¼š{relationship}\n" if relationship else ""
                                    
                                    # âœ… å¢å¼ºï¼šæ˜¾ç¤ºåº”æœŸåˆ†æï¼ˆå…·ä½“å¹´ä»½å§»ç¼˜ä¿¡å·ï¼‰
                                    marriage_timing = marriage_analysis.get('marriage_timing', {})
                                    if marriage_timing:
                                        if isinstance(marriage_timing, dict):
                                            timing_analysis = marriage_timing.get('analysis', [])
                                            timing_description = marriage_timing.get('timing_description', '')
                                            timing_years = marriage_timing.get('timing_years', [])
                                            timing_years_detail = marriage_timing.get('timing_years_detail', [])  # âœ… æ–°å¢ï¼šå…·ä½“å¹´ä»½
                                            suggestion = marriage_timing.get('suggestion', '')
                                            
                                            # ä¼˜å…ˆæ˜¾ç¤ºtiming_descriptionï¼ˆå®Œæ•´æè¿°ï¼‰
                                            if timing_description:
                                                analysis_text += f"\nâ€¢ åº”æœŸåˆ†æï¼ˆå…·ä½“å¹´ä»½å§»ç¼˜ä¿¡å·ï¼‰ï¼š{timing_description}\n"
                                            elif timing_analysis:
                                                analysis_text += f"\nâ€¢ åº”æœŸåˆ†æï¼ˆå…·ä½“å¹´ä»½å§»ç¼˜ä¿¡å·ï¼‰ï¼š\n"
                                                for timing_text in timing_analysis:
                                                    analysis_text += f"  - {timing_text}\n"
                                            
                                            # âœ… æ˜¾ç¤ºç»“åˆå¤§è¿æµå¹´ç»¼åˆåˆ†æå¾—å‡ºçš„3ä¸ªå¹´ä»½
                                            if timing_years_detail:
                                                # timing_years_detail å·²ç»æ˜¯ç»“åˆå¤§è¿æµå¹´åˆ†æåçš„3ä¸ªå¹´ä»½
                                                year_list = []
                                                for y in timing_years_detail:
                                                    year_desc = f"{y.get('year', 0)}å¹´ï¼ˆ{y.get('ganzhi', '')}å¹´ï¼Œ{y.get('age', 0)}å²ï¼‰"
                                                    if y.get('dayun'):
                                                        year_desc += f"ï¼Œå¤§è¿{y.get('dayun', '')}"
                                                    year_list.append(year_desc)
                                                year_str = 'ã€'.join(year_list)
                                                analysis_text += f"  - æœ€æœ‰æœºä¼šçš„åº”æœŸå¹´ä»½ï¼ˆç»“åˆå¤§è¿æµå¹´ç»¼åˆåˆ†æï¼‰ï¼š{year_str}\n"
                                            elif timing_years:
                                                analysis_text += f"  - é‡ç‚¹å…³æ³¨å¹´ä»½ï¼ˆåœ°æ”¯ï¼‰ï¼š{', '.join([f'{y}å¹´' for y in timing_years])}\n"
                                            
                                            # æ˜¾ç¤ºå»ºè®®
                                            if suggestion:
                                                analysis_text += f"  - å»ºè®®ï¼š{suggestion}\n"
                                    
                                    analysis_text += "\nç»å…¸ä¾æ®ï¼šã€Šæ¸Šæµ·å­å¹³ã€‹å…­äº²ç« ã€ã€Šä¸‰å‘½é€šä¼šã€‹é…å¶å®«ç†è®º\n\n"
                                    print(f"âœ… å…­äº²å©šå§»åˆ†æå®Œæˆï¼ˆå…­ä¹¦åº“ï¼‰")
                            else:
                                # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                                analysis_text += self.format_analysis_error("å…­äº²å©šå§»åˆ†æ", "æ— æ³•è·å–å©šå§»åˆ†ææ•°æ®", "ã€Šæ¸Šæµ·å­å¹³ã€‹")
                        else:
                            # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                            analysis_text += self.format_analysis_error("å…­äº²å©šå§»åˆ†æ", "å…­ä¹¦åº“ä¸å¯ç”¨", "ã€Šæ¸Šæµ·å­å¹³ã€‹")
                    except Exception as e:
                        print(f"âš ï¸ å…­äº²å©šå§»åˆ†æå¤±è´¥: {e}")
                        import traceback
                        traceback.print_exc()
                        analysis_text += self.format_analysis_error("å…­äº²å©šå§»åˆ†æ", str(e), "ã€Šæ¸Šæµ·å­å¹³ã€‹")

                    # 2. å…­äº²å®Œæ•´åˆ†æï¼ˆä¼˜å…ˆä½¿ç”¨å…­ä¹¦åº“ï¼‰- ä¸¥æ ¼æ¨¡å¼ï¼šåªä½¿ç”¨å…­ä¹¦åº“
                    try:
                        if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                            if yuanhai_result and yuanhai_result.details.get('sixqin_analysis'):
                                sixqin_analysis = yuanhai_result.details['sixqin_analysis']
                                
                                # âœ… 1. çˆ¶äº²åˆ†æ
                                father_info = sixqin_analysis.get('father', {})
                                father_count = father_info.get('count', 0)
                                father_star_name = father_info.get('star_name', 'åè´¢')
                                father_position = father_info.get('position', 'çˆ¶æ˜Ÿä¸æ˜¾')
                                father_assessment = father_info.get('assessment', 'çˆ¶ç¼˜åˆ†æä¸­')
                                
                                # âœ… 2. æ¯äº²åˆ†æ
                                mother_info = sixqin_analysis.get('mother', {})
                                mother_count = mother_info.get('count', 0)
                                mother_position = mother_info.get('position', 'æ­£å°ä¸æ˜¾')
                                mother_assessment = mother_info.get('assessment', 'æ¯ç¼˜åˆ†æä¸­')
                                
                                # âœ… 3. å…„å¼Ÿå§å¦¹åˆ†æ
                                siblings_info = sixqin_analysis.get('siblings', {})
                                siblings_count = siblings_info.get('count', 0)
                                bijian_count = siblings_info.get('bijian_count', 0)
                                jiecai_count = siblings_info.get('jiecai_count', 0)
                                siblings_assessment = siblings_info.get('assessment', '')
                                siblings_relationship = siblings_info.get('relationship', '')
                                
                                # âœ… 4. å­å¥³åˆ†æ
                                children_info = sixqin_analysis.get('children', {})
                                children_count = children_info.get('count', 0)
                                shishen_count = children_info.get('shishen_count', 0)
                                shangguan_count = children_info.get('shangguan_count', 0)
                                children_assessment = children_info.get('assessment', '')
                                hour_pillar = children_info.get('hour_pillar', pillars_struct.get('hour', ['', ''])[1])
                                quantity_prediction = children_info.get('quantity_prediction', '')
                                
                                # âœ… 5. å…­äº²å…³ç³»åˆ†æ
                                relationship_info = sixqin_analysis.get('relationship', {})
                                relationship_summary = relationship_info.get('summary', '')
                                relationship_details = relationship_info.get('details', [])
                                
                                # âœ… 6. å…­äº²åŠ©åŠ›åˆ†æ
                                help_info = sixqin_analysis.get('help', {})
                                help_summary = help_info.get('summary', '')
                                help_level = help_info.get('level', 'æœªçŸ¥')
                                
                                # âœ… 7. éœ€è¦æ³¨æ„çš„å¹´ä»½
                                important_years = sixqin_analysis.get('important_years', [])
                                
                                # âœ… 8. å…­äº²å»ºè®®
                                advice = sixqin_analysis.get('advice', '')
                                
                                # ç”Ÿæˆå®Œæ•´å…­äº²åˆ†ææŠ¥å‘Š
                                analysis_text += "ã€å…­äº²å®Œæ•´åˆ†æã€‘ï¼ˆåŸºäºã€Šæ¸Šæµ·å­å¹³Â·å…­äº²ç« ã€‹ã€Šä¸‰å‘½é€šä¼šÂ·å…­äº²è®ºã€‹ï¼‰\n"
                                
                                # 1. çˆ¶äº²åˆ†æ
                                analysis_text += f"\nã€1. çˆ¶äº²åˆ†æã€‘\n"
                                analysis_text += f"â€¢ çˆ¶æ˜Ÿ({father_star_name})ï¼š{int(father_count)}ä¸ª\n"
                                analysis_text += f"â€¢ ä½ç½®ï¼š{father_position}\n"
                                analysis_text += f"â€¢ è¯„ä¼°ï¼š{father_assessment}\n"
                                
                                # 2. æ¯äº²åˆ†æ - âœ… å¢å¼ºï¼šæ˜¾ç¤ºå¥åº·è¯¦ç»†åˆ†æ
                                analysis_text += f"\nã€2. æ¯äº²åˆ†æã€‘\n"
                                analysis_text += f"â€¢ æ¯æ˜Ÿ(æ­£å°)ï¼š{int(mother_count)}ä¸ª\n"
                                analysis_text += f"â€¢ ä½ç½®ï¼š{mother_position}\n"
                                analysis_text += f"â€¢ è¯„ä¼°ï¼š{mother_assessment}\n"
                                # âœ… æ–°å¢ï¼šå¥åº·è¯¦ç»†åˆ†æ
                                mother_health = mother_info.get('health', '')
                                mother_health_detail = mother_info.get('health_detail', '')
                                if mother_health:
                                    analysis_text += f"â€¢ å¥åº·çŠ¶æ€ï¼š{mother_health}\n"
                                if mother_health_detail:
                                    analysis_text += f"  - è¯¦ç»†è¯´æ˜ï¼š{mother_health_detail}\n"
                                # âœ… æ–°å¢ï¼šåç¥å¼ºå¼±åˆ†æ
                                mother_in_month = mother_info.get('in_month', False)
                                mother_has_root = mother_info.get('has_root', False)
                                mother_caixing_hua_yin = mother_info.get('caixing_hua_yin', False)
                                mother_shishang_xie_yin = mother_info.get('shishang_xie_yin', False)
                                # âŒ åˆ é™¤ï¼šç»§æ¯åˆ¤æ–­åŠŸèƒ½å·²åˆ é™¤
                                if mother_in_month:
                                    analysis_text += f"  - æ­£å°å¾—ä»¤ï¼ˆåœ¨æœˆä»¤ï¼‰ï¼šæ˜¯\n"
                                if mother_has_root:
                                    analysis_text += f"  - æ­£å°æœ‰æ ¹ï¼šæ˜¯\n"
                                if mother_caixing_hua_yin:
                                    analysis_text += f"  - è´¢æ˜Ÿåå°ï¼šæ˜¯ï¼ˆéœ€æ³¨æ„ï¼‰\n"
                                if mother_shishang_xie_yin:
                                    analysis_text += f"  - é£Ÿä¼¤æ³„å°ï¼šæ˜¯ï¼ˆéœ€æ³¨æ„ï¼‰\n"
                                
                                # 3. å…„å¼Ÿå§å¦¹åˆ†æ - âœ… å¢å¼ºï¼šæ˜¾ç¤ºèƒ½åŠ›ä¸æ€§åˆ«åˆ¤æ–­
                                analysis_text += f"\nã€3. å…„å¼Ÿå§å¦¹åˆ†æã€‘\n"
                                analysis_text += f"â€¢ æ€»æ•°ï¼š{int(siblings_count)}ä¸ªï¼ˆæ¯”è‚©{int(bijian_count)}ä¸ª + åŠ«è´¢{int(jiecai_count)}ä¸ªï¼‰\n"
                                analysis_text += f"â€¢ è¯„ä¼°ï¼š{siblings_assessment}\n"
                                if siblings_relationship:
                                    analysis_text += f"â€¢ å…³ç³»ï¼š{siblings_relationship}\n"
                                # âœ… æ–°å¢ï¼šå…„å¼Ÿå§å¦¹èƒ½åŠ›ä¸æ€§åˆ«åˆ¤æ–­
                                siblings_list = siblings_info.get('siblings', [])
                                if siblings_list:
                                    analysis_text += f"â€¢ è¯¦ç»†åˆ—è¡¨ï¼š\n"
                                    for i, sibling in enumerate(siblings_list, 1):
                                        sibling_type = sibling.get('type', '')
                                        sibling_gender = sibling.get('gender', '')
                                        sibling_position = sibling.get('position', '')
                                        sibling_ability = sibling.get('ability', '')
                                        sibling_ten_god = sibling.get('ten_god', '')
                                        is_hidden = sibling.get('hidden', False)
                                        position_names = {'year': 'å¹´æŸ±', 'month': 'æœˆæŸ±', 'day': 'æ—¥æŸ±', 'hour': 'æ—¶æŸ±'}
                                        position_name = position_names.get(sibling_position, sibling_position)
                                        hidden_text = 'ï¼ˆè—å¹²ï¼‰' if is_hidden else 'ï¼ˆé€å¹²ï¼‰'
                                        analysis_text += f"  {i}. {sibling_type}ï¼ˆ{sibling_gender}ï¼‰ï¼š{sibling_ten_god}{hidden_text}ï¼Œåœ¨{position_name}ï¼Œ{sibling_ability}\n"
                                else:
                                    analysis_text += f"â€¢ è¯¦ç»†è¯´æ˜ï¼šå‘½å±€æ— æ¯”è‚©åŠ«è´¢ï¼Œå¤šä¸ºç‹¬ç”Ÿå­å¥³æˆ–å…„å¼Ÿå§å¦¹è¾ƒå°‘\n"
                                
                                # 4. å­å¥³åˆ†æ - âœ… å¢å¼ºï¼šæ˜¾ç¤ºå‰ç¨‹ä¸æ•°é‡é¢„æµ‹
                                analysis_text += f"\nã€4. å­å¥³åˆ†æã€‘\n"
                                analysis_text += f"â€¢ æ€»æ•°ï¼š{int(children_count)}ä¸ªï¼ˆé£Ÿç¥{int(shishen_count)}ä¸ª + ä¼¤å®˜{int(shangguan_count)}ä¸ªï¼‰\n"
                                analysis_text += f"â€¢ æ—¶æ”¯ï¼ˆå­å¥³å®«ï¼‰ï¼š{hour_pillar}\n"
                                analysis_text += f"â€¢ è¯„ä¼°ï¼š{children_assessment}\n"
                                if quantity_prediction:
                                    analysis_text += f"â€¢ æ•°é‡é¢„æµ‹ï¼š{quantity_prediction}\n"
                                # âœ… æ–°å¢ï¼šå­å¥³å‰ç¨‹é¢„æµ‹
                                children_future = children_info.get('future', '')
                                children_future_detail = children_info.get('future_detail', '')
                                if children_future:
                                    analysis_text += f"â€¢ å‰ç¨‹é¢„æµ‹ï¼š{children_future}\n"
                                if children_future_detail:
                                    analysis_text += f"  - è¯¦ç»†è¯´æ˜ï¼š{children_future_detail}\n"
                                # âœ… æ–°å¢ï¼šé£Ÿä¼¤ä½ç½®å’Œæ ¹æ°”åˆ†æ
                                children_in_hour = children_info.get('in_hour', False)
                                children_has_root = children_info.get('has_root', False)
                                if children_in_hour:
                                    analysis_text += f"  - é£Ÿä¼¤åœ¨æ—¶æŸ±ï¼šæ˜¯ï¼ˆæœ€ä½³ä½ç½®ï¼‰\n"
                                if children_has_root:
                                    analysis_text += f"  - é£Ÿä¼¤æœ‰æ ¹ï¼šæ˜¯ï¼ˆå­å¥³æœ‰åŠ›ï¼‰\n"
                                
                                # 5. å…­äº²å…³ç³»
                                analysis_text += f"\nã€5. å…­äº²å…³ç³»ã€‘\n"
                                if relationship_summary:
                                    analysis_text += f"â€¢ {relationship_summary}\n"
                                elif relationship_details:
                                    for detail in relationship_details:
                                        analysis_text += f"â€¢ {detail}\n"
                                
                                # 6. å…­äº²åŠ©åŠ›
                                analysis_text += f"\nã€6. å…­äº²åŠ©åŠ›ã€‘\n"
                                analysis_text += f"â€¢ åŠ©åŠ›ç­‰çº§ï¼š{help_level}\n"
                                if help_summary:
                                    analysis_text += f"â€¢ {help_summary}\n"
                                
                                # âœ… æ–°å¢ï¼šå…­äº²å®«ä½è¯¦ç»†åˆ†æï¼ˆå¹´æŸ±ã€æœˆæŸ±ã€æ—¶æŸ±ï¼‰
                                palace_analysis = sixqin_analysis.get('palace_analysis', {})
                                if palace_analysis:
                                    analysis_text += f"\nã€7. å…­äº²å®«ä½è¯¦ç»†åˆ†æã€‘\n"
                                    # å¹´æŸ±ï¼ˆçˆ¶æ¯å®«ï¼‰
                                    year_palace = palace_analysis.get('year_palace', {})
                                    if year_palace:
                                        year_desc = year_palace.get('description', '')
                                        year_canggans = year_palace.get('zhi_canggans', [])
                                        analysis_text += f"â€¢ å¹´æŸ±ï¼ˆçˆ¶æ¯å®«ï¼‰ï¼š{year_palace.get('ganzhi', '')} - {year_palace.get('main_role', '')}\n"
                                        if year_desc:
                                            analysis_text += f"  {year_desc}\n"
                                        if year_canggans:
                                            canggan_list = [f"{c['gan']}ï¼ˆ{c['ten_god']}ï¼Œæƒé‡{c['weight']:.1f}ï¼‰" for c in year_canggans]
                                            analysis_text += f"  - å¹´æ”¯è—å¹²ï¼š{'ã€'.join(canggan_list)}\n"
                                    # æœˆæŸ±ï¼ˆå…„å¼Ÿå®«ï¼‰
                                    month_palace = palace_analysis.get('month_palace', {})
                                    if month_palace:
                                        month_desc = month_palace.get('description', '')
                                        month_canggans = month_palace.get('zhi_canggans', [])
                                        analysis_text += f"â€¢ æœˆæŸ±ï¼ˆå…„å¼Ÿå®«ï¼Œæœˆä»¤ï¼‰ï¼š{month_palace.get('ganzhi', '')} - {month_palace.get('main_role', '')}\n"
                                        if month_desc:
                                            analysis_text += f"  {month_desc}\n"
                                        if month_canggans:
                                            canggan_list = [f"{c['gan']}ï¼ˆ{c['ten_god']}ï¼Œæƒé‡{c['weight']:.1f}ï¼‰" for c in month_canggans]
                                            analysis_text += f"  - æœˆæ”¯è—å¹²ï¼š{'ã€'.join(canggan_list)}\n"
                                    # æ—¶æŸ±ï¼ˆå­å¥³å®«ï¼‰
                                    hour_palace = palace_analysis.get('hour_palace', {})
                                    if hour_palace:
                                        hour_desc = hour_palace.get('description', '')
                                        hour_canggans = hour_palace.get('zhi_canggans', [])
                                        analysis_text += f"â€¢ æ—¶æŸ±ï¼ˆå­å¥³å®«ï¼‰ï¼š{hour_palace.get('ganzhi', '')} - {hour_palace.get('main_role', '')}\n"
                                        if hour_desc:
                                            analysis_text += f"  {hour_desc}\n"
                                        if hour_canggans:
                                            canggan_list = [f"{c['gan']}ï¼ˆ{c['ten_god']}ï¼Œæƒé‡{c['weight']:.1f}ï¼‰" for c in hour_canggans]
                                            analysis_text += f"  - æ—¶æ”¯è—å¹²ï¼š{'ã€'.join(canggan_list)}\n"
                                
                                # 8. éœ€è¦æ³¨æ„çš„å¹´ä»½
                                analysis_text += f"\nã€8. éœ€è¦æ³¨æ„çš„å¹´ä»½ã€‘\n"
                                if important_years:
                                    # âœ… å¢å¼ºï¼šæ”¯æŒæ–°çš„å­—å…¸æ ¼å¼ï¼ˆåŒ…å«textå’Œdetailï¼‰
                                    if isinstance(important_years, dict):
                                        year_texts = important_years.get('text', [])
                                        year_details = important_years.get('detail', {})
                                        
                                        # æ˜¾ç¤ºæ–‡å­—è¯´æ˜
                                        for year_note in year_texts:
                                            analysis_text += f"â€¢ {year_note}\n"
                                        
                                        # âœ… å¢å¼ºï¼šæ˜¾ç¤ºå…·ä½“å¹´ä»½ï¼ˆä¼˜å…ˆæ˜¾ç¤ºï¼Œè®©ç”¨æˆ·æ¸…æ¥šçœ‹åˆ°å…·ä½“å¹´ä»½ï¼‰
                                        if year_details:
                                            analysis_text += f"\nã€å…·ä½“å¹´ä»½è¯¦æƒ…ã€‘\n"
                                            for year_type, year_list in year_details.items():
                                                if year_list:
                                                    # æ ¼å¼åŒ–å¹´ä»½åˆ—è¡¨ï¼ˆæ˜¾ç¤ºå‰10ä¸ªï¼‰
                                                    year_str_list = []
                                                    for y in year_list[:10]:
                                                        year = y.get('year', 0)
                                                        ganzhi = y.get('ganzhi', '')
                                                        ten_god = y.get('ten_god', '')
                                                        source = y.get('source', '')
                                                        # æ›´æ¸…æ™°çš„æ ¼å¼ï¼šå¹´ä»½ï¼ˆå¹²æ”¯ï¼Œåç¥ï¼Œæ¥æºï¼‰
                                                        if source == 'å¤©å¹²':
                                                            year_str_list.append(f"{year}å¹´ï¼ˆ{ganzhi}å¹´ï¼Œ{ten_god}é€å¹²ï¼‰")
                                                        else:
                                                            year_str_list.append(f"{year}å¹´ï¼ˆ{ganzhi}å¹´ï¼Œ{source}ä¸º{ten_god}ï¼‰")
                                                    
                                                    if len(year_list) > 10:
                                                        year_str_list.append(f"ç­‰å…±{len(year_list)}ä¸ªå¹´ä»½")
                                                    year_str = 'ã€'.join(year_str_list)
                                                    
                                                    # æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒæ ‡ç­¾ï¼ˆæ›´æ¸…æ™°çš„è¯´æ˜ï¼‰
                                                    type_label = {
                                                        'å®˜æ€å¹´ä»½': 'å®˜æ€å¹´ä»½ï¼ˆå¤§è¿æµå¹´é€¢å®˜æ€ï¼Œéœ€æ³¨æ„å…„å¼Ÿå§å¦¹å…³ç³»æˆ–å¥åº·ï¼‰',
                                                        'çˆ¶æ˜Ÿå¹´ä»½': 'çˆ¶æ˜Ÿå¹´ä»½ï¼ˆå¤§è¿æµå¹´é€¢çˆ¶æ˜Ÿï¼Œéœ€æ³¨æ„çˆ¶äº²å¥åº·æˆ–å…³ç³»å˜åŒ–ï¼‰',
                                                        'æ­£å°å¹´ä»½': 'æ­£å°å¹´ä»½ï¼ˆå¤§è¿æµå¹´é€¢æ­£å°ï¼Œéœ€æ³¨æ„æ¯äº²å¥åº·æˆ–å…³ç³»å˜åŒ–ï¼‰',
                                                        'é£Ÿä¼¤å¹´ä»½': 'é£Ÿä¼¤å¹´ä»½ï¼ˆå¤§è¿æµå¹´é€¢é£Ÿä¼¤ï¼Œå¯èƒ½æœ‰æœºä¼šå¾—å­ï¼‰'
                                                    }.get(year_type, year_type)
                                                    analysis_text += f"â€¢ {type_label}ï¼š\n  {year_str}\n"
                                    else:
                                        # å…¼å®¹æ—§æ ¼å¼ï¼ˆçº¯åˆ—è¡¨ï¼‰
                                        for year_note in important_years:
                                            analysis_text += f"â€¢ {year_note}\n"
                                else:
                                    analysis_text += "â€¢ å…­äº²å…³ç³»ç›¸å¯¹ç¨³å®š\n"
                                
                                # 8. å…­äº²å»ºè®®
                                analysis_text += f"\nã€8. å…­äº²å»ºè®®ã€‘\n"
                                if advice:
                                    advice_list = advice.split('ï¼›')
                                    for adv in advice_list:
                                        if adv.strip():
                                            analysis_text += f"â€¢ {adv.strip()}\n"
                                
                                analysis_text += "\nç»å…¸ä¾æ®ï¼šã€Šæ¸Šæµ·å­å¹³Â·å…­äº²ç« ã€‹ã€Šä¸‰å‘½é€šä¼šÂ·å…­äº²è®ºã€‹\n\n"
                                print(f"âœ… å…­äº²å®Œæ•´åˆ†æå®Œæˆï¼ˆå…­ä¹¦åº“ï¼‰- å·²æ˜¾ç¤º8ä¸ªåˆ†æé¡¹ç›®")
                            else:
                                # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                                analysis_text += self.format_analysis_error("å…­äº²åˆ†æ", "æ— æ³•è·å–å…­äº²åˆ†ææ•°æ®", "ã€Šæ¸Šæµ·å­å¹³ã€‹")
                                analysis_text += "\n"
                        else:
                            # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                            analysis_text += self.format_analysis_error("å…­äº²åˆ†æ", "å…­ä¹¦åº“ä¸å¯ç”¨", "ã€Šæ¸Šæµ·å­å¹³ã€‹")
                            analysis_text += "\n"
                    except Exception as e:
                        print(f"âš ï¸ å…­äº²åˆ†æå¤±è´¥: {e}")
                        import traceback
                        traceback.print_exc()
                        analysis_text += self.format_analysis_error("å…­äº²åˆ†æ", str(e), "ã€Šæ¸Šæµ·å­å¹³ã€‹")
                        analysis_text += "\n"

                    # 4. å¥åº·åˆ†æï¼ˆä¼˜å…ˆä½¿ç”¨å…­ä¹¦åº“ï¼‰- ä¸¥æ ¼æ¨¡å¼ï¼šåªä½¿ç”¨å…­ä¹¦åº“
                    try:
                        if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                            if yuanhai_result and yuanhai_result.details.get('health_analysis'):
                                health_analysis = yuanhai_result.details['health_analysis']
                                day_master_wx = self.get_wuxing_by_tiangan(day_master)
                                day_branch = pillars_struct.get('day', ['?', '?'])[1] if pillars_struct else '?'
                                organ_map = {'æœ¨': 'è‚èƒ†', 'ç«': 'å¿ƒå°è‚ ', 'åœŸ': 'è„¾èƒƒ', 'é‡‘': 'è‚ºå¤§è‚ ', 'æ°´': 'è‚¾è†€èƒ±'}
                                organ = organ_map.get(day_master_wx, 'æœªçŸ¥')
                                
                                analysis_text += "ã€å¥åº·åˆ†æã€‘ï¼ˆåŸºäºã€Šæ¸Šæµ·å­å¹³ã€‹ï¼‰\n"
                                analysis_text += f"â€¢ æ—¥ä¸»äº”è¡Œï¼š{day_master_wx}  å¯¹åº”è„è…‘ï¼š{organ}\n"
                                analysis_text += f"â€¢ æ—¥æ”¯ï¼š{day_branch}  éœ€æ³¨æ„ç›¸å…³å¥åº·é—®é¢˜\n"
                                
                                # âœ… å¢å¼ºï¼šæ˜¾ç¤ºæ·±åº¦å¥åº·åˆ†æ
                                detailed_analysis = health_analysis.get('detailed_analysis', {})
                                
                                # 1. åœŸé‡åŸ‹é‡‘åˆ†æ
                                if detailed_analysis.get('tu_mai_jin'):
                                    tu_mai_jin = detailed_analysis['tu_mai_jin'][0]
                                    analysis_text += f"\nâ€¢ é‡ç‚¹å…³æ³¨ã€Œ{tu_mai_jin['issue']}ã€ï¼š\n"
                                    analysis_text += f"  - å½±å“ï¼š{tu_mai_jin['impact']}\n"
                                    analysis_text += f"  - ç³»ç»Ÿï¼š{', '.join(tu_mai_jin['systems'])}\n"
                                    analysis_text += f"  - å»ºè®®ï¼š{tu_mai_jin['suggestion']}\n"
                                
                                # 2. æœ¨å¼±ä¸å ªåˆ†æ
                                if detailed_analysis.get('mu_ruo'):
                                    mu_ruo = detailed_analysis['mu_ruo'][0]
                                    analysis_text += f"\nâ€¢ ã€Œ{mu_ruo['issue']}ã€ï¼š\n"
                                    analysis_text += f"  - å½±å“ï¼š{mu_ruo['impact']}\n"
                                    analysis_text += f"  - ç³»ç»Ÿï¼š{', '.join(mu_ruo['systems'])}\n"
                                    analysis_text += f"  - å»ºè®®ï¼š{mu_ruo['suggestion']}\n"
                                
                                # 3. åœŸè¿‡æ—ºåˆ†æï¼ˆè„¾èƒƒç³»ç»Ÿï¼‰
                                if detailed_analysis.get('tu_wang'):
                                    tu_wang = detailed_analysis['tu_wang'][0]
                                    analysis_text += f"\nâ€¢ ã€Œ{tu_wang['issue']}ã€ï¼š\n"
                                    analysis_text += f"  - å½±å“ï¼š{tu_wang['impact']}ï¼Œéœ€æ³¨æ„{', '.join(tu_wang.get('symptoms', []))}\n"
                                    analysis_text += f"  - ç³»ç»Ÿï¼š{', '.join(tu_wang['systems'])}\n"
                                    analysis_text += f"  - å»ºè®®ï¼š{tu_wang['suggestion']}\n"
                                
                                # 3.1 ç«è¿‡æ—ºåˆ†æï¼ˆå¿ƒè¡€ç®¡ç³»ç»Ÿï¼‰
                                if detailed_analysis.get('huo_wang'):
                                    huo_wang = detailed_analysis['huo_wang'][0]
                                    analysis_text += f"\nâ€¢ ã€Œ{huo_wang['issue']}ã€ï¼š\n"
                                    analysis_text += f"  - å½±å“ï¼š{huo_wang['impact']}ï¼Œéœ€æ³¨æ„{', '.join(huo_wang.get('symptoms', []))}\n"
                                    analysis_text += f"  - ç³»ç»Ÿï¼š{', '.join(huo_wang['systems'])}\n"
                                    analysis_text += f"  - å»ºè®®ï¼š{huo_wang['suggestion']}\n"
                                
                                # 3.2 æ°´æå¼±åˆ†æï¼ˆè‚¾è„ç³»ç»Ÿï¼‰
                                if detailed_analysis.get('shui_ruo'):
                                    shui_ruo = detailed_analysis['shui_ruo'][0]
                                    analysis_text += f"\nâ€¢ ã€Œ{shui_ruo['issue']}ã€ï¼š\n"
                                    analysis_text += f"  - å½±å“ï¼š{shui_ruo['impact']}\n"
                                    analysis_text += f"  - ç³»ç»Ÿï¼š{', '.join(shui_ruo['systems'])}\n"
                                    analysis_text += f"  - å»ºè®®ï¼š{shui_ruo['suggestion']}\n"
                                
                                # 3.3 é‡‘æå¼±åˆ†æï¼ˆå‘¼å¸ç³»ç»Ÿï¼‰
                                if detailed_analysis.get('jin_ruo'):
                                    jin_ruo = detailed_analysis['jin_ruo'][0]
                                    analysis_text += f"\nâ€¢ ã€Œ{jin_ruo['issue']}ã€ï¼š\n"
                                    analysis_text += f"  - å½±å“ï¼š{jin_ruo['impact']}\n"
                                    analysis_text += f"  - ç³»ç»Ÿï¼š{', '.join(jin_ruo['systems'])}\n"
                                    analysis_text += f"  - å»ºè®®ï¼š{jin_ruo['suggestion']}\n"
                                
                                # 4. åç¥å¯¹å¥åº·çš„å½±å“åˆ†æï¼ˆæ–°å¢ï¼‰
                                tengod_health = health_analysis.get('tengod_health', [])
                                if tengod_health:
                                    analysis_text += f"\nâ€¢ åç¥å¥åº·å½±å“ï¼š\n"
                                    for tg_health in tengod_health:
                                        analysis_text += f"  - ã€{tg_health['ten_god']}ã€‘{tg_health['impact']}\n"
                                        analysis_text += f"    å™¨å®˜ï¼š{', '.join(tg_health.get('organs', []))}\n"
                                        analysis_text += f"    å»ºè®®ï¼š{tg_health.get('suggestion', '')}\n"
                                
                                # 5. å¥åº·éšæ‚£ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
                                if health_analysis.get('health_risks'):
                                    risks = health_analysis.get('health_risks', [])
                                    if risks:
                                        risk_text = ', '.join(risks) if isinstance(risks, list) else str(risks)
                                        analysis_text += f"\nâ€¢ å¥åº·éšæ‚£ï¼š{risk_text}\n"
                                
                                # 6. éœ€è¦æ³¨æ„çš„å™¨å®˜
                                organs_to_attention = health_analysis.get('organs_to_attention', [])
                                if organs_to_attention:
                                    analysis_text += f"\nâ€¢ éœ€è¦æ³¨æ„çš„å™¨å®˜ï¼š{', '.join(organs_to_attention)}\n"
                                
                                # 7. é¥®é£Ÿå»ºè®®ï¼ˆæ–°å¢è¯¦ç»†å»ºè®®ï¼‰
                                diet_advice = health_analysis.get('diet_advice', [])
                                if diet_advice:
                                    analysis_text += f"\nâ€¢ é¥®é£Ÿå»ºè®®ï¼š\n"
                                    for diet in diet_advice:
                                        analysis_text += f"  - {diet}\n"
                                
                                # 8. è¿åŠ¨å»ºè®®ï¼ˆæ–°å¢ï¼‰
                                exercise_advice = health_analysis.get('exercise_advice', [])
                                if exercise_advice:
                                    analysis_text += f"\nâ€¢ è¿åŠ¨å»ºè®®ï¼š\n"
                                    for exercise in exercise_advice:
                                        analysis_text += f"  - {exercise}\n"
                                
                                # 9. å­£èŠ‚å¥åº·ç®¡ç†ï¼ˆæ–°å¢ï¼‰
                                season_advice = health_analysis.get('season_advice', [])
                                if season_advice:
                                    analysis_text += f"\nâ€¢ å­£èŠ‚å¥åº·ç®¡ç†ï¼š\n"
                                    for season in season_advice:
                                        analysis_text += f"  - {season}\n"
                                
                                # 10. å¹´é¾„é˜¶æ®µå¥åº·å…³æ³¨ç‚¹ï¼ˆæ–°å¢ï¼‰
                                age_focus = health_analysis.get('age_focus', [])
                                if age_focus:
                                    analysis_text += f"\nâ€¢ å¹´é¾„é˜¶æ®µå¥åº·å…³æ³¨ç‚¹ï¼š\n"
                                    for age in age_focus:
                                        analysis_text += f"  - {age}\n"
                                
                                # 11. ç»¼åˆè°ƒç†å»ºè®®
                                detailed_advice = health_analysis.get('detailed_advice', [])
                                if detailed_advice:
                                    analysis_text += f"\nâ€¢ ç»¼åˆè°ƒç†å»ºè®®ï¼š\n"
                                    for adv in detailed_advice:
                                        analysis_text += f"  - {adv}\n"
                                elif health_analysis.get('health_advice'):
                                    advice_list = health_analysis.get('health_advice', [])
                                    if isinstance(advice_list, list):
                                        analysis_text += f"\nâ€¢ ç»¼åˆè°ƒç†å»ºè®®ï¼š{', '.join(advice_list)}\n"
                                    else:
                                        analysis_text += f"\nâ€¢ ç»¼åˆè°ƒç†å»ºè®®ï¼š{advice_list}\n"
                                else:
                                    # å¤‡ç”¨å¥åº·å»ºè®®
                                    care_map = {
                                        'æœ¨': 'å°‘è¾›è¾£ï¼Œå¤šç»¿è‰²è”¬èœï¼Œæ—©ç¡æŠ¤è‚',
                                        'ç«': 'å°‘ç†¬å¤œï¼Œæ§åˆ¶æƒ…ç»ªä¸å¿ƒç‡ï¼Œæ³¨æ„æš‘çƒ­',
                                        'åœŸ': 'é¥®é£Ÿæ¸…æ·¡ï¼Œå°‘ç”œå°‘æ²¹ï¼Œå¥è„¾ä¸ºå…ˆ',
                                        'é‡‘': 'å°‘çƒŸé…’ä¸ç²‰å°˜ï¼Œæ³¨æ„å‘¼å¸é“',
                                        'æ°´': 'æ³¨æ„è…°è‚¾ä¿æš–ï¼Œè§„å¾‹ä½œæ¯ï¼Œå¤šæ¸©çƒ­é£Ÿ'
                                    }
                                    care = care_map.get(day_master_wx, 'è§„å¾‹ä½œæ¯ï¼Œé€‚åº¦è¿åŠ¨')
                                    analysis_text += f"\nâ€¢ ç»¼åˆè°ƒç†å»ºè®®ï¼š{care}\n"
                                analysis_text += "\n"
                                print(f"âœ… å¥åº·åˆ†æå®Œæˆï¼ˆå…­ä¹¦åº“ï¼‰")
                            else:
                                # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                                analysis_text += self.format_analysis_error("å¥åº·åˆ†æ", "æ— æ³•è·å–å¥åº·åˆ†ææ•°æ®", "ã€Šæ¸Šæµ·å­å¹³ã€‹")
                        else:
                            # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                            analysis_text += self.format_analysis_error("å¥åº·åˆ†æ", "å…­ä¹¦åº“ä¸å¯ç”¨", "ã€Šæ¸Šæµ·å­å¹³ã€‹")
                    except Exception as e:
                        print(f"âš ï¸ å¥åº·åˆ†æå¤±è´¥: {e}")
                        import traceback
                        traceback.print_exc()
                        analysis_text += self.format_analysis_error("å¥åº·åˆ†æ", str(e), "ã€Šæ¸Šæµ·å­å¹³ã€‹")

                    # ğŸ”¥ æ–°å¢ï¼šæ–°åŠŸèƒ½æ¨¡å—åˆ†æï¼ˆç¬¬äºŒé˜¶æ®µé›†æˆï¼‰
                    # ============================================================
                    
                    # 7. ä¸‰æ‰åˆ†æï¼ˆåŸºäºã€Šæ»´å¤©é«“ã€‹ï¼‰- æ–°å¢
                    print(f"ğŸ” å¼€å§‹ä¸‰æ‰åˆ†æ...")
                    if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                        try:
                            from chinese_metaphysics_library.ditiansui.sancai_analyzer import SancaiAnalyzer
                            sancai_analyzer = SancaiAnalyzer()
                            sancai_result = sancai_analyzer.analyze(bazi_data_cml)
                            
                            analysis_text += f"ã€ä¸‰æ‰åˆ†æã€‘ï¼ˆåŸºäºã€Šæ»´å¤©é«“ã€‹ï¼‰\n"
                            analysis_text += f"{sancai_result.description}\n"
                            
                            details = sancai_result.details
                            tiandao = details.get('tiandao', {})
                            didao = details.get('didao', {})
                            rendao = details.get('rendao', {})
                            comprehensive = details.get('comprehensive', {})
                            
                            if tiandao:
                                analysis_text += f"\nâ€¢ å¤©é“åˆ†æï¼š\n"
                                analysis_text += f"  - {tiandao.get('summary', '')}\n"
                                if tiandao.get('details'):
                                    for key, value in tiandao['details'].items():
                                        analysis_text += f"  - {value}\n"
                            
                            if didao:
                                analysis_text += f"\nâ€¢ åœ°é“åˆ†æï¼š\n"
                                analysis_text += f"  - {didao.get('summary', '')}\n"
                                if didao.get('details'):
                                    for key, value in didao['details'].items():
                                        analysis_text += f"  - {value}\n"
                            
                            if rendao:
                                analysis_text += f"\nâ€¢ äººé“åˆ†æï¼š\n"
                                analysis_text += f"  - {rendao.get('summary', '')}\n"
                                if rendao.get('details'):
                                    for key, value in rendao['details'].items():
                                        analysis_text += f"  - {value}\n"
                            
                            if comprehensive:
                                assessment = comprehensive.get('assessment', '')
                                if assessment:
                                    analysis_text += f"\nâ€¢ ç»¼åˆè¯„ä¼°ï¼š{assessment}\n"
                            
                            analysis_text += f"\n{sancai_result.advice}\n\n"
                            print(f"âœ… ä¸‰æ‰åˆ†æå®Œæˆ")
                        except Exception as e:
                            print(f"âš ï¸ ä¸‰æ‰åˆ†æå¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()
                            analysis_text += self.format_analysis_error("ä¸‰æ‰åˆ†æ", str(e), "ã€Šæ»´å¤©é«“ã€‹")
                    
                    # 8. åˆå†²åˆ†æï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ï¼‰- æ–°å¢ï¼ˆå†…éƒ¨åˆå†²ï¼‰
                    print(f"ğŸ” å¼€å§‹åˆå†²åˆ†æï¼ˆå†…éƒ¨åˆå†²ï¼‰...")
                    if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                        try:
                            from chinese_metaphysics_library.santonghui.hechong_analyzer import HechongAnalyzer
                            hechong_analyzer = HechongAnalyzer()
                            hechong_result = hechong_analyzer.analyze_single_bazi(bazi_data_cml)
                            
                            analysis_text += f"ã€åˆå†²åˆ†æã€‘ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ã€Šæ¸Šæµ·å­å¹³ã€‹ï¼‰\n"
                            analysis_text += f"{hechong_result.description}\n"
                            
                            details = hechong_result.details
                            gan_hehua = details.get('gan_hehua', {})
                            zhi_liuhe = details.get('zhi_liuhe', {})
                            zhi_liuchong = details.get('zhi_liuchong', {})
                            
                            if gan_hehua.get('pairs'):
                                analysis_text += f"\nâ€¢ å¤©å¹²åˆåŒ–ï¼š\n"
                                for pair in gan_hehua['pairs']:
                                    analysis_text += f"  - {pair.get('description', '')}\n"
                            
                            if zhi_liuhe.get('pairs'):
                                analysis_text += f"\nâ€¢ åœ°æ”¯å…­åˆï¼š\n\n"
                                for pair in zhi_liuhe['pairs']:
                                    analysis_text += f"  - {pair.get('description', '')}\n"
                            
                            if zhi_liuchong.get('pairs'):
                                analysis_text += f"\nâ€¢ åœ°æ”¯å…­å†²ï¼š\n"
                                for pair in zhi_liuchong['pairs']:
                                    analysis_text += f"  - {pair.get('description', '')}\n"
                            
                            analysis_text += f"\n{hechong_result.advice}\n\n"
                            print(f"âœ… åˆå†²åˆ†æå®Œæˆ")
                        except Exception as e:
                            print(f"âš ï¸ åˆå†²åˆ†æå¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()
                            analysis_text += self.format_analysis_error("åˆå†²åˆ†æ", str(e), "ã€Šä¸‰å‘½é€šä¼šã€‹")
                    
                    # 9. è´µäººç‰¹å¾åˆ†æï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ï¼‰- æ–°å¢
                    print(f"ğŸ” å¼€å§‹è´µäººç‰¹å¾åˆ†æ...")
                    if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                        try:
                            from chinese_metaphysics_library.santonghui.guiren_feature_analyzer import GuirenFeatureAnalyzer
                            guiren_analyzer = GuirenFeatureAnalyzer()
                            guiren_result = guiren_analyzer.analyze(bazi_data_cml)
                            
                            # âœ… ä¼˜åŒ–ï¼šæ•´åˆè´µäººä¿¡æ¯ï¼Œç®€æ´ç»Ÿä¸€æ˜¾ç¤º
                            analysis_text += f"ã€è´µäººåˆ†æã€‘ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šÂ·è®ºç¥ç…ã€‹ï¼‰\n"
                            
                            details = guiren_result.details
                            guiren_features = details.get('guiren_features', [])
                            
                            if guiren_features:
                                # ç®€æ´çš„è¡¨æ ¼æ ¼å¼æ˜¾ç¤º
                                position_cn_map = {'year': 'å¹´', 'month': 'æœˆ', 'day': 'æ—¥', 'hour': 'æ—¶'}
                                
                                analysis_text += f"\nå‘½ä¸­è´µäººï¼š{len(guiren_features)}ä¸ª\n"
                                for feature in guiren_features:
                                    name = feature.get('name', '')
                                    position = position_cn_map.get(feature.get('position', ''), '')
                                    gan = feature.get('gan', '')
                                    zhi = feature.get('zhi', '')
                                    direction = feature.get('direction', '')
                                    professions = feature.get('professions', [])
                                    
                                    # ç®€æ´ä¸€è¡Œæ˜¾ç¤ºï¼šè´µäººåç§°(ä½ç½®å¹²æ”¯) - æ–¹ä½ - èŒä¸š
                                    prof_str = ', '.join([p.replace('ï¼ˆåŸºäºåç¥ç†è®ºæ¨å¯¼ï¼Œä»…ä¾›å‚è€ƒï¼‰', '') for p in professions[:2]]) if professions else ''
                                    analysis_text += f"  â€¢ {name}ï¼ˆ{position}æŸ±{gan}{zhi}ï¼‰æ–¹ä½ï¼š{direction}"
                                    if prof_str:
                                        analysis_text += f" | èŒä¸šï¼š{prof_str}"
                                    analysis_text += f"\n"
                                
                                # æµå¹´å¼•åŠ¨å¹´ä»½ï¼ˆé‡ç‚¹ä¿¡æ¯ï¼‰
                                liunian_guiren_years = details.get('liunian_guiren_years', [])
                                if liunian_guiren_years:
                                    # æŒ‰å¹´ä»½åˆ†ç»„å»é‡
                                    years_by_year = {}
                                    for item in liunian_guiren_years:
                                        year = item.get('year', 0)
                                        if year not in years_by_year:
                                            years_by_year[year] = {
                                                'ganzhi': item.get('ganzhi', ''),
                                                'guiren_names': set()
                                            }
                                        years_by_year[year]['guiren_names'].add(item.get('guiren_name', ''))
                                    
                                    # åªæ˜¾ç¤ºæœªæ¥5å¹´ï¼ˆé¿å…è¿‡å¤šä¿¡æ¯ï¼‰
                                    sorted_years = sorted([y for y in years_by_year.keys() if y <= datetime.now().year + 5])[:5]
                                    if sorted_years:
                                        analysis_text += f"\nâœ¨ å…³é”®å¹´ä»½ï¼ˆæ˜“é‡è´µäººï¼‰ï¼š\n"
                                        for year in sorted_years:
                                            year_data = years_by_year[year]
                                            guiren_names = sorted(list(year_data['guiren_names']))
                                            ganzhi = year_data['ganzhi']
                                            analysis_text += f"  {year}å¹´ï¼ˆ{ganzhi}ï¼‰ï¼š{', '.join(guiren_names)}\n"
                                
                                # ç»¼åˆå»ºè®®ï¼ˆç®€åŒ–ï¼‰
                                comprehensive = details.get('comprehensive_assessment', {})
                                main_direction = comprehensive.get('main_direction', '')
                                if main_direction and main_direction != 'æœªç¡®å®š':
                                    analysis_text += f"\nğŸ’¡ å»ºè®®ï¼šè´µäººä¸»è¦åœ¨{main_direction}æ–¹å‘ï¼Œé‡ç‚¹å…³æ³¨ä¸Šè¿°å¹´ä»½æŠŠæ¡è´µäººæœºé‡ã€‚\n"
                            else:
                                analysis_text += f"\næœªå‘ç°æ˜æ˜¾çš„è´µäººæ˜Ÿã€‚\n"
                            
                            analysis_text += f"\n"
                            print(f"âœ… è´µäººç‰¹å¾åˆ†æå®Œæˆ")
                        except Exception as e:
                            print(f"âš ï¸ è´µäººç‰¹å¾åˆ†æå¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()
                            analysis_text += self.format_analysis_error("è´µäººç‰¹å¾åˆ†æ", str(e), "ã€Šä¸‰å‘½é€šä¼šã€‹")
                    
                    # 10. æ€æ°”åˆ†æï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ï¼‰- æ–°å¢
                    print(f"ğŸ” å¼€å§‹æ€æ°”åˆ†æ...")
                    if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                        try:
                            from chinese_metaphysics_library.santonghui.qisha_analyzer import QishaAnalyzer
                            qisha_analyzer = QishaAnalyzer()
                            qisha_result = qisha_analyzer.analyze(bazi_data_cml)
                            
                            analysis_text += f"ã€æ€æ°”åˆ†æã€‘ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šÂ·è®ºä¸ƒæ€ã€‹ï¼‰\n"
                            analysis_text += f"{qisha_result.description}\n"
                            
                            details = qisha_result.details
                            qisha_level = details.get('qisha_level', {})
                            zhihua_analysis = details.get('zhihua_analysis', {})
                            impact_assessment = details.get('impact_assessment', {})
                            
                            if qisha_level:
                                level = qisha_level.get('level', '')
                                level_desc = qisha_level.get('level_desc', '')
                                total_score = qisha_level.get('total_score', 0)
                                analysis_text += f"\nâ€¢ æ€æ°”ç­‰çº§ï¼š{level}ï¼ˆå¾—åˆ†{total_score:.1f}ï¼‰\n"
                                analysis_text += f"  - {level_desc}\n"
                            
                            if zhihua_analysis:
                                status = zhihua_analysis.get('status', '')
                                strength = zhihua_analysis.get('strength', '')
                                analysis_text += f"\nâ€¢ åˆ¶åŒ–æƒ…å†µï¼š{status}ï¼ˆ{strength}ï¼‰\n"
                                if zhihua_analysis.get('shishang_details'):
                                    analysis_text += f"  - é£Ÿä¼¤åˆ¶æ€ï¼š"
                                    for detail in zhihua_analysis['shishang_details']:
                                        analysis_text += f"{detail}\n    "
                                    analysis_text = analysis_text.rstrip('    ') + "\n"
                                if zhihua_analysis.get('yinxing_details'):
                                    analysis_text += f"  - å°æ˜ŸåŒ–æ€ï¼š"
                                    for detail in zhihua_analysis['yinxing_details']:
                                        analysis_text += f"{detail}\n    "
                                    analysis_text = analysis_text.rstrip('    ') + "\n"
                            
                            if impact_assessment:
                                impact_level = impact_assessment.get('impact_level', '')
                                impact_areas = impact_assessment.get('impact_areas', [])
                                if impact_level:
                                    analysis_text += f"\nâ€¢ å½±å“è¯„ä¼°ï¼š{impact_level}\n"
                                if impact_areas:
                                    analysis_text += f"  - å½±å“é¢†åŸŸï¼š{', '.join(impact_areas)}\n"
                            
                            analysis_text += f"\n{qisha_result.advice}\n\n"
                            print(f"âœ… æ€æ°”åˆ†æå®Œæˆ")
                        except Exception as e:
                            print(f"âš ï¸ æ€æ°”åˆ†æå¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()
                            analysis_text += self.format_analysis_error("æ€æ°”åˆ†æ", str(e), "ã€Šä¸‰å‘½é€šä¼šã€‹")
                    
                    # 11. ç¥–ä¸Šåº‡æŠ¤åˆ†æï¼ˆåŸºäºã€Šæ¸Šæµ·å­å¹³ã€‹ï¼‰- æ–°å¢
                    print(f"ğŸ” å¼€å§‹ç¥–ä¸Šåº‡æŠ¤åˆ†æ...")
                    if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                        try:
                            from chinese_metaphysics_library.yuanhaiziping.zushang_analyzer import ZushangAnalyzer
                            zushang_analyzer = ZushangAnalyzer()
                            zushang_result = zushang_analyzer.analyze(bazi_data_cml)
                            
                            analysis_text += f"ã€ç¥–ä¸Šåº‡æŠ¤åˆ†æã€‘ï¼ˆåŸºäºã€Šæ¸Šæµ·å­å¹³Â·å…­äº²ç« ã€‹ï¼‰\n"
                            analysis_text += f"{zushang_result.description}\n"
                            
                            details = zushang_result.details
                            comprehensive = details.get('comprehensive_assessment', {})
                            
                            if comprehensive:
                                level = comprehensive.get('level', '')
                                desc = comprehensive.get('description', '')
                                score = comprehensive.get('score', 0)
                                analysis_text += f"\nâ€¢ åº‡æŠ¤ç­‰çº§ï¼š{level}ï¼ˆå¾—åˆ†{score:.0f}ï¼‰\n"
                                analysis_text += f"  - {desc}\n"
                            
                            analysis_text += f"\n{zushang_result.advice}\n\n"
                            print(f"âœ… ç¥–ä¸Šåº‡æŠ¤åˆ†æå®Œæˆ")
                        except Exception as e:
                            print(f"âš ï¸ ç¥–ä¸Šåº‡æŠ¤åˆ†æå¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()
                            analysis_text += self.format_analysis_error("ç¥–ä¸Šåº‡æŠ¤åˆ†æ", str(e), "ã€Šæ¸Šæµ·å­å¹³ã€‹")
                    
                    # 12. é˜´é˜³æ°”åˆ†æï¼ˆåŸºäºã€Šæ¸Šæµ·å­å¹³ã€‹ï¼‰- æ–°å¢
                    print(f"ğŸ” å¼€å§‹é˜´é˜³æ°”åˆ†æ...")
                    if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                        try:
                            from chinese_metaphysics_library.ditiansui.yinyangqi_analyzer import YinyangqiAnalyzer
                            yinyangqi_analyzer = YinyangqiAnalyzer()
                            yinyangqi_result = yinyangqi_analyzer.analyze(bazi_data_cml)
                            
                            analysis_text += f"ã€é˜´é˜³æ°”åˆ†æã€‘ï¼ˆåŸºäºã€Šæ¸Šæµ·å­å¹³ã€‹ã€Šä¸‰å‘½é€šä¼šã€‹ï¼‰\n"
                            analysis_text += f"{yinyangqi_result.description}\n"
                            
                            details = yinyangqi_result.details
                            
                            # æ˜¾ç¤ºå¤©å¹²é˜´é˜³
                            gan_yinyang = details.get('gan_yinyang', {})
                            if gan_yinyang:
                                gan_yang_count = gan_yinyang.get('yang_count', 0)
                                gan_yin_count = gan_yinyang.get('yin_count', 0)
                                gan_yang_ratio = gan_yinyang.get('yang_ratio', 0)
                                if gan_yang_count > 0 or gan_yin_count > 0:
                                    yang_gans = gan_yinyang.get('yang_gans', [])
                                    yang_gans_str = 'ã€'.join([g['gan'] for g in yang_gans]) if yang_gans else 'æ— '
                                    yin_gans = gan_yinyang.get('yin_gans', [])
                                    yin_gans_str = 'ã€'.join([g['gan'] for g in yin_gans]) if yin_gans else 'æ— '
                                    analysis_text += f"\nâ€¢ å¤©å¹²é˜´é˜³ï¼š\n"
                                    analysis_text += f"  - é˜³å¹²ï¼š{yang_gans_str}ï¼ˆå…±{gan_yang_count}ä¸ªï¼Œå æ¯”{gan_yang_ratio*100:.0f}%ï¼‰\n"
                                    analysis_text += f"  - é˜´å¹²ï¼š{yin_gans_str}ï¼ˆå…±{gan_yin_count}ä¸ªï¼Œå æ¯”{(1-gan_yang_ratio)*100:.0f}%ï¼‰\n"
                            
                            # æ˜¾ç¤ºåœ°æ”¯è—å¹²é˜´é˜³
                            zhi_yinyang = details.get('zhi_yinyang', {})
                            if zhi_yinyang:
                                zhi_yang_count = zhi_yinyang.get('yang_count', 0)
                                zhi_yin_count = zhi_yinyang.get('yin_count', 0)
                                zhi_yang_ratio = zhi_yinyang.get('yang_ratio', 0)
                                if zhi_yang_count > 0 or zhi_yin_count > 0:
                                    yang_details_list = zhi_yinyang.get('yang_details', [])
                                    yang_details_str = 'ã€'.join([f"{d['zhi']}ä¸­{d['canggan']}({d.get('weight', 0):.1f})" for d in yang_details_list[:5]]) if yang_details_list else 'æ— '
                                    if len(yang_details_list) > 5:
                                        yang_details_str += f"ç­‰"
                                    yin_details_list = zhi_yinyang.get('yin_details', [])
                                    yin_details_str = 'ã€'.join([f"{d['zhi']}ä¸­{d['canggan']}({d.get('weight', 0):.1f})" for d in yin_details_list[:5]]) if yin_details_list else 'æ— '
                                    if len(yin_details_list) > 5:
                                        yin_details_str += f"ç­‰"
                                    analysis_text += f"\nâ€¢ åœ°æ”¯è—å¹²é˜´é˜³ï¼ˆæŒ‰æƒé‡è®¡ç®—ï¼‰ï¼š\n"
                                    analysis_text += f"  - é˜³è—å¹²ï¼š{yang_details_str}ï¼ˆæƒé‡æ€»å’Œ{zhi_yang_count:.1f}ï¼Œå æ¯”{zhi_yang_ratio*100:.0f}%ï¼‰\n"
                                    analysis_text += f"  - é˜´è—å¹²ï¼š{yin_details_str}ï¼ˆæƒé‡æ€»å’Œ{zhi_yin_count:.1f}ï¼Œå æ¯”{(1-zhi_yang_ratio)*100:.0f}%ï¼‰\n"
                            
                            # æ˜¾ç¤ºç»¼åˆé˜´é˜³å’Œå¹³è¡¡
                            comprehensive = details.get('comprehensive_yinyang', {})
                            balance = details.get('balance_assessment', {})
                            if comprehensive:
                                yang_count = comprehensive.get('yang_count', 0)
                                yin_count = comprehensive.get('yin_count', 0)
                                yang_ratio = comprehensive.get('yang_ratio', 0)
                                analysis_text += f"\nâ€¢ ç»¼åˆé˜´é˜³ï¼ˆå¤©å¹²è®¡æ•°+åœ°æ”¯è—å¹²æƒé‡ï¼‰ï¼š\n"
                                analysis_text += f"  - é˜³æ°”ï¼š{yang_count:.1f}ï¼ˆå æ¯”{yang_ratio*100:.0f}%ï¼‰\n"
                                analysis_text += f"  - é˜´æ°”ï¼š{yin_count:.1f}ï¼ˆå æ¯”{(1-yang_ratio)*100:.0f}%ï¼‰\n"
                            
                            if balance:
                                balance_desc = balance.get('balance_description', '')
                                if balance_desc:
                                    analysis_text += f"\nâ€¢ é˜´é˜³å¹³è¡¡ï¼š{balance_desc}\n"
                            
                            analysis_text += f"\n{yinyangqi_result.advice}\n\n"
                            print(f"âœ… é˜´é˜³æ°”åˆ†æå®Œæˆ")
                        except Exception as e:
                            print(f"âš ï¸ é˜´é˜³æ°”åˆ†æå¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()
                            analysis_text += self.format_analysis_error("é˜´é˜³æ°”åˆ†æ", str(e), "ã€Šæ¸Šæµ·å­å¹³ã€‹")
                    
                    # 13. äººå“äº¤å‹åˆ†æï¼ˆåŸºäºã€Šæ¸Šæµ·å­å¹³ã€‹ï¼‰- æ–°å¢
                    print(f"ğŸ” å¼€å§‹äººå“äº¤å‹åˆ†æ...")
                    if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                        try:
                            from chinese_metaphysics_library.yuanhaiziping.renpin_analyzer import RenpinAnalyzer
                            renpin_analyzer = RenpinAnalyzer()
                            renpin_result = renpin_analyzer.analyze(bazi_data_cml)
                            
                            analysis_text += f"ã€äººå“äº¤å‹åˆ†æã€‘ï¼ˆåŸºäºã€Šæ¸Šæµ·å­å¹³Â·è®ºæ€§æƒ…ã€‹ï¼‰\n"
                            analysis_text += f"{renpin_result.description}\n"
                            
                            details = renpin_result.details
                            renpin_score = details.get('renpin_score', {})
                            friendship_advice = details.get('friendship_advice', [])
                            
                            if renpin_score:
                                level = renpin_score.get('level', '')
                                desc = renpin_score.get('description', '')
                                total_score = renpin_score.get('total_score', 0)
                                analysis_text += f"\nâ€¢ äººå“ç­‰çº§ï¼š{level}ï¼ˆå¾—åˆ†{total_score:.0f}ï¼‰\n"
                                analysis_text += f"  - {desc}\n"
                            
                            if friendship_advice:
                                analysis_text += f"\nâ€¢ äº¤å‹å»ºè®®ï¼š\n"
                                for advice in friendship_advice:
                                    analysis_text += f"  - {advice}\n"
                            
                            analysis_text += f"\n{renpin_result.advice}\n\n"
                            print(f"âœ… äººå“äº¤å‹åˆ†æå®Œæˆ")
                        except Exception as e:
                            print(f"âš ï¸ äººå“äº¤å‹åˆ†æå¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()
                            analysis_text += self.format_analysis_error("äººå“äº¤å‹åˆ†æ", str(e), "ã€Šæ¸Šæµ·å­å¹³ã€‹")

                    # ============================================================
                    # ğŸ”¥ æ–°å¢ï¼šæ‰©å±•åˆ†æï¼ˆ5ä¸ªæ–°åŠŸèƒ½ï¼‰
                    if CML_UNIFIED_AVAILABLE and bazi_data_cml:
                        try:
                            from chinese_metaphysics_library.santonghui.extended_analyzer import ExtendedAnalyzer
                            extended_analyzer = ExtendedAnalyzer()
                            extended_result = extended_analyzer.analyze(bazi_data_cml)

                            # 1. å…«å­—ç¡¬ä¸ç¡¬ï¼ˆèº«æ—ºèº«å¼±ï¼‰
                            strength_data = extended_result.details.get('strength', {})
                            analysis_text += f"ã€å…«å­—å¼ºå¼±åˆ†æã€‘ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ï¼‰\n"
                            analysis_text += f"èº«æ—ºèº«å¼±ï¼š{strength_data.get('level', 'æœªçŸ¥')}ï¼ˆå¾—åˆ†{strength_data.get('score', 0)}ï¼‰\n"
                            analysis_text += f"{strength_data.get('description', '')}\n\n"

                            analysis_text += f"â€¢ è¯¦ç»†åˆ†æï¼š\n"
                            details = strength_data.get('details', {})
                            for key, value in details.items():
                                analysis_text += f"  - {key}ï¼š{value}\n"
                            analysis_text += f"\n"

                            # 2. çŠ¯ä¸çŠ¯å¤ªå²
                            taisui_data = extended_result.details.get('taisui', {})
                            analysis_text += f"ã€çŠ¯å¤ªå²åˆ†æã€‘ï¼ˆåŸºäºã€Šæ¸Šæµ·å­å¹³ã€‹ï¼‰\n"
                            analysis_text += f"ç»“æœï¼š{taisui_data.get('result', 'æœªçŸ¥')}\n"
                            analysis_text += f"{taisui_data.get('description', '')}\n\n"

                            if taisui_data.get('fan_taisui'):
                                analysis_text += f"â€¢ çŠ¯å¤ªå²ç±»å‹ï¼š{', '.join(taisui_data.get('fan_type', []))}\n"
                            analysis_text += f"â€¢ åŒ–è§£å»ºè®®ï¼š{taisui_data.get('advice', '')}\n\n"

                            # 3. ç‰¢ç‹±ä¹‹ç¾
                            prison_data = extended_result.details.get('prison_risk', {})
                            analysis_text += f"ã€ç‰¢ç‹±ä¹‹ç¾åˆ†æã€‘ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ï¼‰\n"
                            analysis_text += f"é£é™©ç­‰çº§ï¼š{prison_data.get('risk_level', 'æœªçŸ¥')}ï¼ˆå¾—åˆ†{prison_data.get('risk_score', 0)}ï¼‰\n"
                            analysis_text += f"{prison_data.get('description', '')}\n\n"

                            # æ˜¾ç¤ºå…·ä½“çš„åˆ‘å†²ç»„åˆï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                            if prison_data.get('xingchong_combinations'):
                                analysis_text += f"â€¢ åˆ‘å†²ç»„åˆï¼š\n"
                                for combo in prison_data.get('xingchong_combinations', []):
                                    analysis_text += f"  - {combo}\n"
                                analysis_text += "\n"

                            # æ˜¾ç¤ºå…¶ä»–é£é™©å› ç´ ï¼ˆä¸åŒ…æ‹¬å·²åœ¨åˆ‘å†²ç»„åˆä¸­æ˜¾ç¤ºçš„ï¼‰
                            if prison_data.get('risk_factors'):
                                analysis_text += f"â€¢ é£é™©å› ç´ ï¼š\n"
                                for factor in prison_data.get('risk_factors', []):
                                    analysis_text += f"  - {factor}\n"

                            # æ˜¾ç¤ºå…·ä½“çš„é£é™©å¹´ä»½
                            if prison_data.get('specific_years'):
                                analysis_text += f"â€¢ é£é™©å¹´ä»½ï¼š\n"
                                for year_info in prison_data.get('specific_years', []):
                                    analysis_text += f"  - {year_info}\n"

                            analysis_text += f"â€¢ å»ºè®®ï¼š{prison_data.get('advice', '')}\n\n"

                            # 4. ç ´è´¢é¢„æµ‹
                            wealth_loss_data = extended_result.details.get('wealth_loss', {})
                            analysis_text += f"ã€ç ´è´¢é¢„æµ‹ã€‘ï¼ˆåŸºäºã€Šæ¸Šæµ·å­å¹³ã€‹ï¼‰\n"
                            analysis_text += f"é£é™©ç­‰çº§ï¼š{wealth_loss_data.get('risk_level', 'æœªçŸ¥')}ï¼ˆå¾—åˆ†{wealth_loss_data.get('risk_score', 0)}ï¼‰\n"
                            analysis_text += f"{wealth_loss_data.get('description', '')}\n\n"

                            # æ˜¾ç¤ºå…·ä½“çš„åˆ‘å†²ç»„åˆï¼ˆç»Ÿä¸€å‘½åï¼Œå¦‚æœå­˜åœ¨ï¼‰
                            if wealth_loss_data.get('chong_combinations'):
                                analysis_text += f"â€¢ åˆ‘å†²ç»„åˆï¼š\n"
                                for combo in wealth_loss_data.get('chong_combinations', []):
                                    analysis_text += f"  - {combo}\n"
                                analysis_text += "\n"

                            # æ˜¾ç¤ºå…¶ä»–é£é™©å› ç´ ï¼ˆä¸åŒ…æ‹¬å·²åœ¨åˆ‘å†²ç»„åˆä¸­æ˜¾ç¤ºçš„ï¼‰
                            if wealth_loss_data.get('risk_factors'):
                                analysis_text += f"â€¢ é£é™©å› ç´ ï¼š\n"
                                for factor in wealth_loss_data.get('risk_factors', []):
                                    analysis_text += f"  - {factor}\n"

                            # ä¼˜å…ˆæ˜¾ç¤ºå…·ä½“çš„ç ´è´¢å¹´ä»½ï¼Œå¦‚æœæ²¡æœ‰å†æ˜¾ç¤ºä¸€èˆ¬æ€§å»ºè®®
                            if wealth_loss_data.get('specific_years'):
                                analysis_text += f"â€¢ ç ´è´¢å¹´ä»½ï¼š\n"
                                for year_info in wealth_loss_data.get('specific_years', []):
                                    analysis_text += f"  - {year_info}\n"
                            elif wealth_loss_data.get('risk_years'):
                                analysis_text += f"â€¢ éœ€è¦å°å¿ƒçš„æ—¶æœŸï¼š\n"
                                for year in wealth_loss_data.get('risk_years', []):
                                    analysis_text += f"  - {year}\n"

                            analysis_text += f"â€¢ å»ºè®®ï¼š{wealth_loss_data.get('advice', '')}\n\n"

                            # 5. æ„å¤–é¢„æµ‹
                            accident_data = extended_result.details.get('accident_risk', {})
                            analysis_text += f"ã€æ„å¤–ä¼¤ç¾é¢„æµ‹ã€‘ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ï¼‰\n"
                            analysis_text += f"é£é™©ç­‰çº§ï¼š{accident_data.get('risk_level', 'æœªçŸ¥')}ï¼ˆå¾—åˆ†{accident_data.get('risk_score', 0)}ï¼‰\n"
                            analysis_text += f"{accident_data.get('description', '')}\n\n"

                            # æ˜¾ç¤ºå…·ä½“çš„åˆ‘å†²ç»„åˆï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                            if accident_data.get('xingchong_combinations'):
                                analysis_text += f"â€¢ åˆ‘å†²ç»„åˆï¼š\n"
                                for combo in accident_data.get('xingchong_combinations', []):
                                    analysis_text += f"  - {combo}\n"
                                analysis_text += "\n"

                            # æ˜¾ç¤ºå…·ä½“çš„é£é™©ç±»å‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                            if accident_data.get('risk_types'):
                                analysis_text += f"â€¢ é£é™©ç±»å‹ï¼š{'ã€'.join(accident_data.get('risk_types', []))}\n\n"

                            # æ˜¾ç¤ºå…¶ä»–é£é™©å› ç´ ï¼ˆä¸åŒ…æ‹¬å·²åœ¨åˆ‘å†²ç»„åˆä¸­æ˜¾ç¤ºçš„ï¼‰
                            if accident_data.get('risk_factors'):
                                analysis_text += f"â€¢ é£é™©å› ç´ ï¼š\n"
                                for factor in accident_data.get('risk_factors', []):
                                    analysis_text += f"  - {factor}\n"

                            # ä¼˜å…ˆæ˜¾ç¤ºå…·ä½“çš„é£é™©å¹´ä»½ï¼ˆåŒ…å«é£é™©ç±»å‹ï¼‰ï¼Œå¦‚æœæ²¡æœ‰å†æ˜¾ç¤ºä¸€èˆ¬æ€§å»ºè®®
                            if accident_data.get('specific_years'):
                                analysis_text += f"â€¢ é£é™©å¹´ä»½ï¼š\n"
                                for year_info in accident_data.get('specific_years', []):
                                    analysis_text += f"  - {year_info}\n"
                            elif accident_data.get('caution_years'):
                                analysis_text += f"â€¢ éœ€è¦å°å¿ƒçš„æ—¶æœŸï¼š\n"
                                for year in accident_data.get('caution_years', []):
                                    analysis_text += f"  - {year}\n"

                            analysis_text += f"â€¢ å»ºè®®ï¼š{accident_data.get('advice', '')}\n\n"

                            print(f"âœ… æ‰©å±•åˆ†æå®Œæˆï¼ˆ5ä¸ªæ–°åŠŸèƒ½ï¼‰")
                        except Exception as e:
                            print(f"âš ï¸ æ‰©å±•åˆ†æå¤±è´¥: {e}")
                            import traceback
                            traceback.print_exc()
                            analysis_text += self.format_analysis_error("æ‰©å±•åˆ†æ", str(e), "ã€Šä¸‰å‘½é€šä¼šã€‹ã€Šæ¸Šæµ·å­å¹³ã€‹")

                    # ============================================================
                    # ğŸ”¥ æ–°å¢ï¼šæ–°åŠŸèƒ½æ¨¡å—åˆ†æå®Œæˆ
                    
                    # 5. è´¢å¯Œç»“æ„åˆ†æï¼ˆä¼˜å…ˆä½¿ç”¨å…­ä¹¦åº“ï¼‰- ä¸¥æ ¼æ¨¡å¼ï¼šåªä½¿ç”¨å…­ä¹¦åº“
                    try:
                        if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                            if yuanhai_result and yuanhai_result.details.get('wealth_analysis'):
                                wealth_analysis = yuanhai_result.details['wealth_analysis']
                                
                                analysis_text += "ã€è´¢å¯Œç»“æ„åˆ†æã€‘\n"
                                # è´¢æ˜Ÿæ•°é‡
                                total_wealth = wealth_analysis.get('total_wealth_count', 0)
                                # âœ… ä¿®å¤ï¼šæ˜¾ç¤ºè´¢æ˜Ÿæ•°é‡æ—¶ï¼Œå¦‚æœåªæœ‰è—å¹²ä¸­çš„å¾®å¼±è´¢æ˜Ÿï¼ˆ<0.5ï¼‰ï¼Œç»™å‡ºè¯´æ˜
                                if total_wealth < 0.5:
                                    analysis_text += f"â€¢ è´¢æ˜Ÿæ•°é‡ï¼š0ä¸ªï¼ˆè—å¹²æœ‰å¾®å¼±è´¢æ˜Ÿï¼Œæƒé‡{total_wealth:.2f}ï¼‰\n"
                                else:
                                    analysis_text += f"â€¢ è´¢æ˜Ÿæ•°é‡ï¼š{int(round(total_wealth))}ä¸ª\n"
                                # âœ… ä¿®å¤ï¼šæ˜¾ç¤ºå…­ä¹¦åº“è¯†åˆ«çš„é«˜çº§æ ¼å±€ï¼ˆä¼¤å®˜é…å°æ ¼ã€é£Ÿç¥åˆ¶æ€æ ¼ç­‰ï¼‰
                                month_pattern = yuanhai_result.details.get('month_pattern', 'æœªçŸ¥')
                                if month_pattern and month_pattern != 'æœªçŸ¥':
                                    analysis_text += f"â€¢ æ ¼å±€ç±»å‹ï¼š{month_pattern}\n"
                                else:
                                    # å¦‚æœæ²¡æœ‰å…­ä¹¦åº“æ ¼å±€ï¼Œæ‰ä½¿ç”¨æœ¬åœ°è®¡ç®—çš„æ ¼å±€
                                    pattern_type = bazi_snapshot.get('bazi_pattern', {}).get('pattern_type', 'æœªçŸ¥')
                                    analysis_text += f"â€¢ æ ¼å±€ç±»å‹ï¼š{pattern_type}\n"
                                # ä½ç½®ä¼˜åŠ¿
                                # âœ… ä¿®å¤ï¼šè€ƒè™‘ç‰¹æ®Šæ ¼å±€ï¼ˆå¦‚ä¼¤å®˜é…å°æ ¼ï¼‰çš„æƒ…å†µï¼Œå³ä½¿è´¢æ˜Ÿæ•°é‡<0.5ï¼Œå¦‚æœæœ‰æ ¼å±€ä¼˜åŠ¿ä¹Ÿåº”æ˜¾ç¤º
                                wealth_positions_dict = wealth_analysis.get('wealth_positions', {})
                                
                                # âœ… æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ç‰¹æ®Šæ ¼å±€ï¼ˆæ ¼å±€ä¼˜åŠ¿ï¼‰- ä½¿ç”¨å·²è·å–çš„month_pattern
                                pattern_type_for_advantage = month_pattern if month_pattern and month_pattern != 'æœªçŸ¥' else ''
                                has_pattern_advantage = False
                                pattern_advantage_text = ''
                                if pattern_type_for_advantage:
                                    # ç‰¹æ®Šæ ¼å±€å³ä½¿æ— æ˜è´¢ä¹Ÿèƒ½é—´æ¥ç”Ÿè´¢ï¼Œè¿™æ˜¯æ ¼å±€ä¼˜åŠ¿
                                    if 'ä¼¤å®˜é…å°' in pattern_type_for_advantage:
                                        has_pattern_advantage = True
                                        pattern_advantage_text = 'æ ¼å±€ä¼˜åŠ¿ï¼ˆä¼¤å®˜é…å°æ ¼ï¼Œé—´æ¥ç”Ÿè´¢ï¼‰'
                                    elif 'é£Ÿç¥åˆ¶æ€' in pattern_type_for_advantage:
                                        has_pattern_advantage = True
                                        pattern_advantage_text = 'æ ¼å±€ä¼˜åŠ¿ï¼ˆé£Ÿç¥åˆ¶æ€æ ¼ï¼Œé—´æ¥ç”Ÿè´¢ï¼‰'
                                    elif 'å®˜å°ç›¸ç”Ÿ' in pattern_type_for_advantage:
                                        has_pattern_advantage = True
                                        pattern_advantage_text = 'æ ¼å±€ä¼˜åŠ¿ï¼ˆå®˜å°ç›¸ç”Ÿæ ¼ï¼Œé—´æ¥ç”Ÿè´¢ï¼‰'
                                    elif 'ä¼¤å®˜ç”Ÿè´¢' in pattern_type_for_advantage:
                                        has_pattern_advantage = True
                                        pattern_advantage_text = 'æ ¼å±€ä¼˜åŠ¿ï¼ˆä¼¤å®˜ç”Ÿè´¢æ ¼ï¼Œé—´æ¥ç”Ÿè´¢ï¼‰'
                                
                                # âœ… æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è´¢åº“ä¼˜åŠ¿
                                caiku_info = wealth_analysis.get('caiku_info', {})
                                has_caiku_advantage = False
                                caiku_advantage_text = ''
                                if caiku_info and caiku_info.get('zuo_caiku', False):
                                    has_caiku_advantage = True
                                    caiku_advantage_text = 'è´¢åº“ä¼˜åŠ¿ï¼ˆæ—¥åè´¢åº“ï¼‰'
                                
                                # æ˜¾ç¤ºä½ç½®ä¼˜åŠ¿
                                if isinstance(wealth_positions_dict, dict) and total_wealth >= 0.5:
                                    # æå–æœ‰è´¢æ˜Ÿçš„ä½ç½®ï¼ˆéç©ºåˆ—è¡¨çš„é”®ï¼‰
                                    positions_with_wealth = [pos for pos, positions in wealth_positions_dict.items() if positions]
                                    if positions_with_wealth:
                                        position_names = {'year': 'å¹´æŸ±', 'month': 'æœˆæŸ±', 'day': 'æ—¥æŸ±', 'hour': 'æ—¶æŸ±'}
                                        position_display = [position_names.get(pos, pos) for pos in positions_with_wealth]
                                        # âœ… å¢å¼ºï¼šå¦‚æœæœ‰æ ¼å±€ä¼˜åŠ¿æˆ–è´¢åº“ä¼˜åŠ¿ï¼Œä¹Ÿä¸€èµ·æ˜¾ç¤º
                                        advantage_list = [f"è´¢æ˜Ÿåœ¨{'ã€'.join(position_display)}"]
                                        if has_pattern_advantage:
                                            advantage_list.append(pattern_advantage_text)
                                        if has_caiku_advantage:
                                            advantage_list.append(caiku_advantage_text)
                                        analysis_text += f"â€¢ ä½ç½®ä¼˜åŠ¿ï¼š{'ï¼›'.join(advantage_list)}\n"
                                    else:
                                        # æœ‰å¾®å¼±è´¢æ˜Ÿä½†ä½ç½®ä¸ä½³ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ ¼å±€ä¼˜åŠ¿æˆ–è´¢åº“ä¼˜åŠ¿
                                        if has_pattern_advantage or has_caiku_advantage:
                                            advantage_list = []
                                            if has_pattern_advantage:
                                                advantage_list.append(pattern_advantage_text)
                                            if has_caiku_advantage:
                                                advantage_list.append(caiku_advantage_text)
                                            analysis_text += f"â€¢ ä½ç½®ä¼˜åŠ¿ï¼š{'ï¼›'.join(advantage_list)}\n"
                                        else:
                                            analysis_text += f"â€¢ ä½ç½®ä¼˜åŠ¿ï¼šæš‚æ— ä¼˜åŠ¿\n"
                                else:
                                    # è´¢æ˜Ÿæ•°é‡<0.5ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ ¼å±€ä¼˜åŠ¿æˆ–è´¢åº“ä¼˜åŠ¿
                                    if has_pattern_advantage or has_caiku_advantage:
                                        advantage_list = []
                                        if has_pattern_advantage:
                                            advantage_list.append(pattern_advantage_text)
                                        if has_caiku_advantage:
                                            advantage_list.append(caiku_advantage_text)
                                        analysis_text += f"â€¢ ä½ç½®ä¼˜åŠ¿ï¼š{'ï¼›'.join(advantage_list)}\n"
                                    else:
                                        analysis_text += f"â€¢ ä½ç½®ä¼˜åŠ¿ï¼šæš‚æ— ä¼˜åŠ¿\n"
                                # è´¢è¿è¯„ä¼°
                                wealth_level = wealth_analysis.get('wealth_level', 'æœªçŸ¥')
                                wealth_description = wealth_analysis.get('wealth_description', '')
                                analysis_text += f"â€¢ è´¢è¿è¯„ä¼°ï¼š{wealth_level}\n"
                                if wealth_description:
                                    analysis_text += f"â€¢ è¯¦ç»†è¯´æ˜ï¼š{wealth_description}\n"
                                
                                # ğŸ”¥ æ–°å¢ï¼šæ·±åº¦è§£é‡Šï¼ˆçŸ›ç›¾è§£é‡Šã€æ ¼å±€æœºåˆ¶è¯¦è§£ï¼‰
                                deep_explanation = wealth_analysis.get('deep_explanation', '')
                                if deep_explanation:
                                    analysis_text += f"\nâ€¢ æ·±åº¦è§£é‡Šï¼š\n"
                                    # å°†æ·±åº¦è§£é‡Šåˆ†æ®µæ˜¾ç¤ºï¼ˆæŒ‰å¥å·åˆ†å‰²ï¼‰
                                    sentences = deep_explanation.split('ã€‚')
                                    for sentence in sentences:
                                        sentence = sentence.strip()
                                        if sentence:
                                            analysis_text += f"  {sentence}ã€‚\n"
                                
                                # ğŸ”¥ æ–°å¢ï¼šäººç”Ÿç­–ç•¥å»ºè®®ï¼ˆè´¢å¯Œå¯†ç ã€äº‹ä¸šæ–¹å‘ã€å¿ƒæ€§ä¿®ç‚¼ï¼‰
                                life_strategy = wealth_analysis.get('life_strategy', {})
                                if life_strategy and isinstance(life_strategy, dict):
                                    analysis_text += f"\nâ€¢ äººç”Ÿç­–ç•¥å»ºè®®ï¼š\n"
                                    
                                    # è´¢å¯Œå¯†ç 
                                    wealth_password = life_strategy.get('wealth_password', '')
                                    if wealth_password:
                                        analysis_text += f"  - ã€è´¢å¯Œå¯†ç ã€‘{wealth_password}\n"
                                    
                                    # äº‹ä¸šæ–¹å‘
                                    career_direction = life_strategy.get('career_direction', '')
                                    if career_direction:
                                        analysis_text += f"  - ã€äº‹ä¸šæ–¹å‘ã€‘{career_direction}\n"
                                    
                                    # å¿ƒæ€§ä¿®ç‚¼
                                    mindset_cultivation = life_strategy.get('mindset_cultivation', '')
                                    if mindset_cultivation:
                                        analysis_text += f"  - ã€å¿ƒæ€§ä¿®ç‚¼ã€‘{mindset_cultivation}\n"
                                    
                                    # å…³é”®è¦ç‚¹
                                    key_points = life_strategy.get('key_points', [])
                                    if key_points:
                                        analysis_text += f"  - ã€å…³é”®è¦ç‚¹ã€‘\n"
                                        for point in key_points:
                                            analysis_text += f"    â€¢ {point}\n"
                                
                                # âœ… å¢å¼ºï¼šè´¢åº“åˆ†æ
                                caiku_info = wealth_analysis.get('caiku_info', {})
                                if caiku_info:
                                    caiku_exists = caiku_info.get('caiku_exists', False)
                                    caiku_zhi = caiku_info.get('caiku_zhi', '')
                                    zuo_caiku = caiku_info.get('zuo_caiku', False)
                                    caiku_open_timing = caiku_info.get('caiku_open_timing', [])
                                    
                                    # âœ… ä¿®å¤ï¼šä¼˜å…ˆæ£€æŸ¥æ—¥åè´¢åº“ï¼Œå³ä½¿å››æŸ±å…¶ä»–ä½ç½®æ²¡æœ‰è´¢åº“ä¹Ÿè¦æ˜¾ç¤º
                                    if zuo_caiku:
                                        # æ—¥åè´¢åº“æ˜¯éå¸¸åˆ©è´¢çš„ç‰¹æ®Šç»„åˆï¼Œå¿…é¡»æ˜¾ç¤º
                                        analysis_text += f"\nâ€¢ è´¢åº“åˆ†æï¼š\n"
                                        analysis_text += f"  - ã€æ—¥åè´¢åº“ã€‘æ—¥æ”¯å{caiku_zhi}åº“ï¼Œè´¢åº“è´´èº«ï¼Œéå¸¸åˆ©è´¢ï¼ˆä¼ ç»Ÿå‘½ç†ï¼šæ—¥åè´¢åº“ï¼Œæ— äººä¸å¯Œï¼‰\n"
                                    if caiku_exists:
                                        # å››æŸ±å…¶ä»–ä½ç½®ä¹Ÿæœ‰è´¢åº“
                                        analysis_text += f"  - è´¢åº“ä½ç½®ï¼š{caiku_zhi}åº“"
                                        if caiku_info.get('caiku_positions'):
                                            position_names = {'year': 'å¹´æŸ±', 'month': 'æœˆæŸ±', 'day': 'æ—¥æŸ±', 'hour': 'æ—¶æŸ±'}
                                            positions = [position_names.get(p, p) for p in caiku_info['caiku_positions']]
                                            analysis_text += f"ï¼ˆåœ¨{', '.join(positions)}ï¼‰"
                                        analysis_text += "\n"
                                        if caiku_open_timing:
                                            analysis_text += f"  - å¼€åº“æ—¶æœºï¼š\n"
                                            for timing in caiku_open_timing:
                                                analysis_text += f"    â€¢ {timing}\n"
                                    elif caiku_exists:
                                        # æœ‰è´¢åº“ä½†æœªåè´¢åº“
                                        analysis_text += f"\nâ€¢ è´¢åº“åˆ†æï¼š\n"
                                        analysis_text += f"  - è´¢åº“ä½ç½®ï¼š{caiku_zhi}åº“"
                                        if caiku_info.get('caiku_positions'):
                                            position_names = {'year': 'å¹´æŸ±', 'month': 'æœˆæŸ±', 'day': 'æ—¥æŸ±', 'hour': 'æ—¶æŸ±'}
                                            positions = [position_names.get(p, p) for p in caiku_info['caiku_positions']]
                                            analysis_text += f"ï¼ˆåœ¨{', '.join(positions)}ï¼‰"
                                        analysis_text += "\n"
                                        if caiku_open_timing:
                                            analysis_text += f"  - å¼€åº“æ—¶æœºï¼š\n"
                                            for timing in caiku_open_timing:
                                                analysis_text += f"    â€¢ {timing}\n"
                                    elif caiku_zhi:
                                        # æœ‰è´¢åº“åœ°æ”¯ä½†æ²¡æœ‰è´¢åº“
                                        analysis_text += f"\nâ€¢ è´¢åº“åˆ†æï¼šå‘½å±€æ— {caiku_zhi}åº“ï¼ˆè´¢åº“ï¼‰ï¼Œè´¢æ˜Ÿæ— åº“å¯è—\n"
                                
                                print(f"âœ… è´¢å¯Œç»“æ„åˆ†æå®Œæˆï¼ˆå…­ä¹¦åº“ï¼‰")
                            else:
                                # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                                analysis_text += self.format_analysis_error("è´¢å¯Œç»“æ„åˆ†æ", "æ— æ³•è·å–è´¢å¯Œåˆ†ææ•°æ®", "ã€Šæ¸Šæµ·å­å¹³ã€‹")
                            analysis_text += "\n"
                        else:
                            # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                            analysis_text += self.format_analysis_error("è´¢å¯Œç»“æ„åˆ†æ", "å…­ä¹¦åº“ä¸å¯ç”¨", "ã€Šæ¸Šæµ·å­å¹³ã€‹")
                    except Exception as e:
                        print(f"âš ï¸ è´¢å¯Œç»“æ„åˆ†æå¤±è´¥: {e}")
                        import traceback
                        traceback.print_exc()
                        analysis_text += self.format_analysis_error("è´¢å¯Œç»“æ„åˆ†æ", str(e), "ã€Šæ¸Šæµ·å­å¹³ã€‹")

                    # 6. äº‹ä¸šåˆ†æï¼ˆä¼˜å…ˆä½¿ç”¨å…­ä¹¦åº“ï¼‰- ä¸¥æ ¼æ¨¡å¼ï¼šåªä½¿ç”¨å…­ä¹¦åº“
                    try:
                        if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                            if yuanhai_result and yuanhai_result.details.get('career_analysis'):
                                career_analysis = yuanhai_result.details['career_analysis']
                                
                                analysis_text += "ã€äº‹ä¸šåˆ†æã€‘\n"
                                # âœ… å¢å¼ºï¼šäº‹ä¸šæ ¼å±€è¯¦ç»†åˆ†æ
                                career_pattern = career_analysis.get('career_pattern', 'æœªçŸ¥')
                                career_pattern_detail = career_analysis.get('career_pattern_detail', '')
                                career_pattern_reason = career_analysis.get('career_pattern_reason', '')
                                analysis_text += f"â€¢ äº‹ä¸šæ ¼å±€ï¼š{career_pattern}\n"
                                if career_pattern_detail:
                                    analysis_text += f"  - æ ¼å±€è¯´æ˜ï¼š{career_pattern_detail}\n"
                                if career_pattern_reason:
                                    analysis_text += f"  - åˆ¤æ–­ä¾æ®ï¼š{career_pattern_reason}\n"
                                
                                # âœ… å¢å¼ºï¼šå‘½æ ¼è´µè´±åˆ¤æ–­
                                nobility_level = career_analysis.get('nobility_level', '')
                                nobility_reason = career_analysis.get('nobility_reason', '')
                                if nobility_level:
                                    analysis_text += f"â€¢ å‘½æ ¼è´µè´±ï¼š{nobility_level}\n"
                                if nobility_reason:
                                    analysis_text += f"  - è´µè´±ä¾æ®ï¼š{nobility_reason}\n"
                                
                                # å®˜æ˜Ÿæ•°é‡
                                total_official = career_analysis.get('total_official', 0)
                                zhengguan = career_analysis.get('zhengguan_count', 0)
                                qisha = career_analysis.get('qisha_count', 0)
                                # ä¿®å¤ï¼šæ˜¾ç¤ºå®˜æ˜Ÿæ•°é‡æ—¶ï¼Œå¦‚æœåªæœ‰è—å¹²ä¸­çš„å¾®å¼±å®˜æ˜Ÿ(å°äº0.5)ï¼Œç»™å‡ºè¯´æ˜
                                if total_official < 0.5:
                                    analysis_text += f"â€¢ å®˜æ˜Ÿæ•°é‡ï¼š0ä¸ªï¼ˆè—å¹²æœ‰å¾®å¼±å®˜æ˜Ÿï¼Œæƒé‡{total_official:.2f}ï¼‰\n"
                                else:
                                    analysis_text += f"â€¢ å®˜æ˜Ÿæ•°é‡ï¼š{int(round(total_official))}ä¸ªï¼ˆæ­£å®˜{int(round(zhengguan))}ä¸ªï¼Œä¸ƒæ€{int(round(qisha))}ä¸ªï¼‰\n"
                                # âœ… æ–°å¢ï¼šæ˜¾ç¤ºèº«å¼ºèº«å¼±çŠ¶æ€ï¼ˆè®©ç”¨æˆ·çŸ¥é“å®é™…çš„èº«å¼ºèº«å¼±ï¼‰
                                strength = career_analysis.get('strength', 'æœªçŸ¥')
                                if strength and strength != 'æœªçŸ¥':
                                    strength_display = {
                                        'èº«æ—º': 'èº«å¼ºï¼ˆå¾—ä»¤ã€å¾—åœ°ï¼Œå¯èƒœä»»è¦èŒï¼‰',
                                        'èº«å¼º': 'èº«å¼ºï¼ˆå¯èƒœä»»è¦èŒï¼‰',
                                        'èº«å¼±': 'èº«å¼±ï¼ˆéœ€æ‰¶èº«ï¼Œå®œè¾…åŠ©å²—ä½ï¼‰',
                                        'åæ—º': 'èº«åå¼ºï¼ˆåŸºæœ¬å¯èƒœä»»ï¼‰',
                                        'åå¼±': 'èº«åå¼±ï¼ˆéœ€é€‚å½“æ‰¶èº«ï¼‰',
                                        'ä¸­å’Œ': 'èº«ä¸­å’Œï¼ˆå¹³è¡¡çŠ¶æ€ï¼‰'
                                    }.get(strength, f'èº«{strength}')
                                    analysis_text += f"â€¢ èº«å¼ºèº«å¼±ï¼š{strength_display}\n"
                                
                                # äº‹ä¸šæ–¹å‘
                                career_direction = career_analysis.get('career_direction', [])
                                if isinstance(career_direction, list) and career_direction:
                                    analysis_text += f"â€¢ äº‹ä¸šæ–¹å‘ï¼š{' / '.join(career_direction)}\n"
                                # é€‚åˆè¡Œä¸š
                                suitable_industries = career_analysis.get('suitable_career_industries', [])
                                if isinstance(suitable_industries, list) and suitable_industries:
                                    analysis_text += f"â€¢ é€‚åˆè¡Œä¸šï¼š{' / '.join(suitable_industries)}\n"
                                
                                # ğŸ”¥ æ–°å¢ï¼šæ·±åº¦è§£é‡Šï¼ˆçŸ›ç›¾è§£é‡Šã€æ ¼å±€æœºåˆ¶è¯¦è§£ï¼‰
                                deep_explanation = career_analysis.get('deep_explanation', '')
                                if deep_explanation:
                                    analysis_text += f"\nâ€¢ æ·±åº¦è§£é‡Šï¼š\n"
                                    # å°†æ·±åº¦è§£é‡Šåˆ†æ®µæ˜¾ç¤ºï¼ˆæŒ‰å¥å·åˆ†å‰²ï¼‰
                                    sentences = deep_explanation.split('ã€‚')
                                    for sentence in sentences:
                                        sentence = sentence.strip()
                                        if sentence:
                                            analysis_text += f"  {sentence}ã€‚\n"
                                
                                # ğŸ”¥ æ–°å¢ï¼šäººç”Ÿç­–ç•¥å»ºè®®ï¼ˆäº‹ä¸šå¯†ç ã€å‘å±•æ–¹å‘ã€å¿ƒæ€§ä¿®ç‚¼ï¼‰
                                life_strategy = career_analysis.get('life_strategy', {})
                                if life_strategy and isinstance(life_strategy, dict):
                                    analysis_text += f"\nâ€¢ äººç”Ÿç­–ç•¥å»ºè®®ï¼š\n"
                                    
                                    # äº‹ä¸šå¯†ç 
                                    career_password = life_strategy.get('career_password', '')
                                    if career_password:
                                        analysis_text += f"  - ã€äº‹ä¸šå¯†ç ã€‘{career_password}\n"
                                    
                                    # å‘å±•æ–¹å‘
                                    development_direction = life_strategy.get('development_direction', '')
                                    if development_direction:
                                        analysis_text += f"  - ã€å‘å±•æ–¹å‘ã€‘{development_direction}\n"
                                    
                                    # å¿ƒæ€§ä¿®ç‚¼
                                    mindset_cultivation = life_strategy.get('mindset_cultivation', '')
                                    if mindset_cultivation:
                                        analysis_text += f"  - ã€å¿ƒæ€§ä¿®ç‚¼ã€‘{mindset_cultivation}\n"
                                    
                                    # å…³é”®è¦ç‚¹
                                    key_points = life_strategy.get('key_points', [])
                                    if key_points:
                                        analysis_text += f"  - ã€å…³é”®è¦ç‚¹ã€‘\n"
                                        for point in key_points:
                                            analysis_text += f"    â€¢ {point}\n"
                                
                                print(f"âœ… äº‹ä¸šåˆ†æå®Œæˆï¼ˆå…­ä¹¦åº“ï¼‰")
                            else:
                                # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                                analysis_text += self.format_analysis_error("äº‹ä¸šåˆ†æ", "æ— æ³•è·å–äº‹ä¸šåˆ†ææ•°æ®", "ã€Šæ¸Šæµ·å­å¹³ã€‹")
                            analysis_text += "\n"
                        else:
                            # ğŸ”¥ ä¸¥æ ¼æ¨¡å¼ï¼šä¸é™çº§ï¼Œæ˜¾ç¤ºé”™è¯¯
                            analysis_text += self.format_analysis_error("äº‹ä¸šåˆ†æ", "å…­ä¹¦åº“ä¸å¯ç”¨", "ã€Šæ¸Šæµ·å­å¹³ã€‹")
                    except Exception as e:
                        print(f"âš ï¸ äº‹ä¸šåˆ†æå¤±è´¥: {e}")
                        import traceback
                        traceback.print_exc()
                        analysis_text += self.format_analysis_error("äº‹ä¸šåˆ†æ", str(e), "ã€Šæ¸Šæµ·å­å¹³ã€‹")

                    # ğŸ”¥ é˜¶æ®µ2ï¼šæ—¶é—´é¢„æµ‹åˆ†æï¼ˆç‰¢ç‹±ã€ç ´è´¢ã€æ„å¤–ã€å®˜è¿ï¼‰- æ–°å¢åŠŸèƒ½
                    life_event_analysis = {}
                    try:
                        if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                            from chinese_metaphysics_library.santonghui.life_event_time_analyzer import LifeEventTimeAnalyzer
                            
                            # 1. æ”¶é›†å¤§è¿æ•°æ®ï¼ˆæ ¼å¼ï¼š[(å¤©å¹², åœ°æ”¯, èµ·å§‹å¹´é¾„, ç»“æŸå¹´é¾„), ...]ï¼‰
                            dayun_list_for_timing = []
                            if 'dayun_result_cml' in locals() and dayun_result_cml:
                                pillars_list = dayun_result_cml.details.get('dayun_pillars', []) or []
                                qy_age_raw = dayun_result_cml.details.get('qiyun_age', 0) or 0
                                qy_age = float(qy_age_raw)
                                
                                for idx, pillar_data in enumerate(pillars_list[:10]):  # åªå–å‰10æ­¥
                                    if isinstance(pillar_data, dict):
                                        gan = pillar_data.get('gan', '')
                                        zhi = pillar_data.get('zhi', '')
                                        if gan and zhi:
                                            start_age = qy_age + idx * 10
                                            end_age = start_age + 10
                                            dayun_list_for_timing.append((gan, zhi, int(start_age), int(end_age)))
                            
                            # 2. ç”Ÿæˆæµå¹´æ•°æ®ï¼ˆæ ¼å¼ï¼š[(å¤©å¹², åœ°æ”¯, å¹´ä»½), ...]ï¼‰
                            liunian_list_for_timing = []
                            from datetime import datetime
                            current_year = datetime.now().year
                            birth_year = birth_info.get('solar_year') or birth_info.get('year') or current_year
                            
                            # ç”Ÿæˆå½“å‰å¹´åŠæœªæ¥30å¹´çš„æµå¹´æ•°æ®
                            from chinese_metaphysics_library.core.constants import TIANGAN_LIST, DIZHI_LIST
                            for i in range(31):  # å½“å‰å¹´ + æœªæ¥30å¹´
                                year = current_year + i
                                # å¹´ä»½è½¬å¹²æ”¯ï¼ˆåŸºäº1984å¹´ç”²å­å¹´ï¼‰
                                offset = year - 1984
                                gan = TIANGAN_LIST[offset % 10]
                                zhi = DIZHI_LIST[offset % 12]
                                liunian_list_for_timing.append((gan, zhi, year))
                            
                            # 3. è°ƒç”¨æ—¶é—´é¢„æµ‹åˆ†æå™¨
                            if dayun_list_for_timing and liunian_list_for_timing:
                                analyzer = LifeEventTimeAnalyzer()
                                
                                # åˆ†æé‡å¤§ç¾ç¥¸ï¼ˆç‰¢ç‹±ã€æ„å¤–ï¼‰
                                disaster_result = analyzer.analyze_disaster_timing(
                                    bazi_data_cml, dayun_list_for_timing, liunian_list_for_timing
                                )
                                
                                # åˆ†æç ´è´¢æ—¶é—´
                                wealth_result = analyzer.analyze_wealth_timing(
                                    bazi_data_cml, dayun_list_for_timing, liunian_list_for_timing
                                )
                                
                                # åˆ†æå®˜è¿æ—¶é—´
                                official_result = analyzer.analyze_official_timing(
                                    bazi_data_cml, dayun_list_for_timing, liunian_list_for_timing
                                )
                                
                                life_event_analysis = {
                                    'disaster': disaster_result,
                                    'wealth': wealth_result,
                                    'official': official_result
                                }
                                
                                print(f"âœ… æ—¶é—´é¢„æµ‹åˆ†æå®Œæˆ")
                    except Exception as e:
                        print(f"âš ï¸ æ—¶é—´é¢„æµ‹åˆ†æå¤±è´¥: {e}")
                        import traceback
                        traceback.print_exc()
                        life_event_analysis = {}
                    
                    # 7. æœªæ¥æµå¹´æç¤ºï¼ˆ10å¹´è¯¦ç»†åˆ†æï¼‰- âœ… å¢å¼ºï¼šä½¿ç”¨å…­ä¹¦åº“å®Œæ•´æ•°æ®ï¼Œæ˜¾ç¤ºå…·ä½“å¹´ä»½
                    try:
                        if CML_UNIFIED_AVAILABLE and unified_analyzer_cml and bazi_data_cml:
                            # âœ… ä½¿ç”¨å…­ä¹¦åº“çš„æµå¹´åˆ†æå™¨
                            liunian_analyzer = unified_analyzer_cml.analyzers['ä¸‰å‘½é€šä¼š'].liunian_analyzer
                            liunian_result = liunian_analyzer.analyze(bazi_data_cml)
                            
                            analysis_text += "ã€æµå¹´è¯¦ç»†åˆ†æã€‘ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤ªå²ã€‹ï¼‰\n"
                            
                            # å½“å‰å¹´ä»½åˆ†æ
                            from datetime import datetime
                            current_year = datetime.now().year
                            current_analysis = liunian_result.details.get('current_analysis', {})
                            if current_analysis:
                                current_ganzhi = current_analysis.get('ganzhi', '')
                                current_level = current_analysis.get('level', 'ä¸­å¹³')
                                current_reason = current_analysis.get('level_reason', '')
                                current_key_points = current_analysis.get('key_points', [])
                                current_advice = current_analysis.get('advice', '')
                                
                                analysis_text += f"\nâ€¢ {current_year}å¹´ï¼ˆ{current_ganzhi}å¹´ï¼‰ï¼š{current_level}\n"
                                if current_reason:
                                    analysis_text += f"  - åˆ¤æ–­ä¾æ®ï¼š{current_reason}\n"
                                if current_key_points:
                                    analysis_text += f"  - å…³é”®äº‹ä»¶ï¼š{'ï¼›'.join(current_key_points)}\n"
                                if current_advice:
                                    analysis_text += f"  - å»ºè®®ï¼š{current_advice}\n"
                            
                            # æœªæ¥10å¹´è¯¦ç»†åˆ†æ
                            future_years = liunian_result.details.get('future_years_analysis', [])
                            if future_years:
                                analysis_text += f"\nâ€¢ æœªæ¥10å¹´é€å¹´åˆ†æï¼š\n"
                                for year_data in future_years:
                                    year = year_data.get('year', 0)
                                    ganzhi = year_data.get('ganzhi', '')
                                    level = year_data.get('level', 'ä¸­å¹³')
                                    key_points = year_data.get('key_points', [])
                                    advice = year_data.get('advice', '')
                                    
                                    # æ ‡æ³¨å…³é”®å¹´ä»½ï¼ˆå†²åº“å¹´ã€å¤§è¿è½¬æŠ˜å¹´ç­‰ï¼‰
                                    year_mark = ''
                                    # æ£€æŸ¥æ˜¯å¦æ˜¯è´¢åº“å¼€åº“å¹´ä»½
                                    try:
                                        if 'caiku_info' in locals() and caiku_info:
                                            caiku_open_years = caiku_info.get('caiku_open_years', [])
                                            if any(y.get('year') == year for y in caiku_open_years):
                                                year_mark = ' ğŸ”¥ è´¢åº“å†²å¼€å¹´'
                                    except:
                                        pass
                                    
                                    analysis_text += f"  - {year}å¹´ï¼ˆ{ganzhi}å¹´ï¼‰ï¼š{level}{year_mark}\n"
                                    if key_points:
                                        analysis_text += f"    å…³é”®äº‹ä»¶ï¼š{'ï¼›'.join(key_points[:2])}\n"  # åªæ˜¾ç¤ºå‰2ä¸ªå…³é”®ç‚¹
                                    if advice:
                                        analysis_text += f"    å»ºè®®ï¼š{advice.split('ï¼›')[0]}\n"  # åªæ˜¾ç¤ºç¬¬ä¸€æ¡å»ºè®®
                            
                            # æœªæ¥è¶‹åŠ¿å»ºè®®
                            future_trend = liunian_result.details.get('future_trend_advice', '')
                            if future_trend:
                                analysis_text += f"\nâ€¢ æœªæ¥10å¹´æ•´ä½“è¶‹åŠ¿ï¼š{future_trend}\n"
                            
                            analysis_text += "\nç»å…¸ä¾æ®ï¼šã€Šä¸‰å‘½é€šä¼šÂ·è®ºå¤ªå²ã€‹\n\n"
                            print(f"âœ… æµå¹´è¯¦ç»†åˆ†æå®Œæˆï¼ˆå…­ä¹¦åº“ï¼‰- æ˜¾ç¤ºå½“å‰å¹´+æœªæ¥10å¹´")
                        else:
                            # é™çº§åˆ°åŸæœ‰æ–¹æ³•
                            liunian_text = self.analyze_liunian_data(day_master, pillars_for_analyzer, birth_info)
                            analysis_text += "ã€æœªæ¥æµå¹´æç¤ºã€‘\n"
                            analysis_text += (liunian_text if liunian_text else "â€¢ æœªæ¥åå¹´æµå¹´è¯¦ç»†åˆ†æï¼šè®¡ç®—ä¸­...\n")
                            analysis_text += "\n"
                            print(f"âœ… æœªæ¥æµå¹´åˆ†æå®Œæˆï¼ˆé™çº§æ–¹æ³•ï¼‰")
                    except Exception as e:
                        print(f"âš ï¸ æœªæ¥æµå¹´åˆ†æå¤±è´¥: {e}")
                        import traceback
                        traceback.print_exc()
                        # é™çº§åˆ°åŸæœ‰æ–¹æ³•
                        try:
                            liunian_text = self.analyze_liunian_data(day_master, pillars_for_analyzer, birth_info)
                            analysis_text += "ã€æœªæ¥æµå¹´æç¤ºã€‘\n"
                            analysis_text += (liunian_text if liunian_text else "â€¢ æœªæ¥åå¹´æµå¹´è¯¦ç»†åˆ†æï¼šè®¡ç®—ä¸­...\n")
                            analysis_text += "\n"
                        except:
                            analysis_text += "ã€æœªæ¥æµå¹´æç¤ºã€‘\nâ€¢ æœªæ¥åå¹´æµå¹´è¯¦ç»†åˆ†æï¼šåˆ†æè¿‡ç¨‹å‡ºé”™ï¼Œè¯·é‡è¯•\n\n"
                    
                    # ğŸ”¥ ä¿®å¤ï¼šé˜¶æ®µ3æ˜¾ç¤ºï¼ˆç‹¬ç«‹åˆ¤æ–­ï¼Œä¸ä¾èµ–æµå¹´åˆ†æï¼‰- ç¡®ä¿æ—¶é—´é¢„æµ‹ç»“æœå§‹ç»ˆæ˜¾ç¤º
                    if life_event_analysis:
                        analysis_text += "\nã€äººç”Ÿé‡å¤§äº‹ä»¶æ—¶é—´é¢„æµ‹ã€‘ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ã€Šæ¸Šæµ·å­å¹³ã€‹ï¼‰\n"
                        
                        # 1. ç‰¢ç‹±ä¹‹ç¾å’Œæ„å¤–é£é™©
                        if life_event_analysis.get('disaster'):
                            disaster = life_event_analysis['disaster']
                            
                            # ç‰¢ç‹±é£é™©
                            laoyu_risk = disaster.get('laoyu_risk', [])
                            if laoyu_risk:
                                analysis_text += "\nâ€¢ ç‰¢ç‹±é£é™©æ—¶æ®µï¼š\n"
                                for item in laoyu_risk[:5]:  # æœ€å¤šæ˜¾ç¤º5ä¸ª
                                    analysis_text += f"  - {item['period']}ï¼ˆ{item['dayun']}å¤§è¿ï¼‰ï¼š{item['level']}é£é™©\n"
                                    analysis_text += f"    åŸå› ï¼š{item['reason']}\n"
                                    analysis_text += f"    å»ºè®®ï¼š{item['advice']}\n"
                            
                            laoyu_years = disaster.get('laoyu_years', [])
                            if laoyu_years:
                                year_str = 'ã€'.join([str(y['year']) for y in laoyu_years[:5]])
                                analysis_text += f"  - éœ€æ³¨æ„çš„å¹´ä»½ï¼š{year_str}\n"
                            
                            # æ„å¤–é£é™©
                            yiwai_risk = disaster.get('yiwai_risk', [])
                            if yiwai_risk:
                                analysis_text += "\nâ€¢ æ„å¤–é£é™©æ—¶æ®µï¼š\n"
                                for item in yiwai_risk[:5]:  # æœ€å¤šæ˜¾ç¤º5ä¸ª
                                    analysis_text += f"  - {item['period']}ï¼ˆ{item['dayun']}å¤§è¿ï¼‰ï¼š{item['level']}é£é™©\n"
                                    analysis_text += f"    åŸå› ï¼š{item['reason']}\n"
                                    analysis_text += f"    å»ºè®®ï¼š{item['advice']}\n"
                            
                            yiwai_years = disaster.get('yiwai_years', [])
                            if yiwai_years:
                                year_str = 'ã€'.join([str(y['year']) for y in yiwai_years[:5]])
                                analysis_text += f"  - éœ€æ ¼å¤–å°å¿ƒçš„å¹´ä»½ï¼š{year_str}\n"
                            
                            if disaster.get('summary'):
                                analysis_text += f"\n  æ€»ç»“ï¼š{disaster['summary']}\n"
                        
                        # 2. ç ´è´¢æ—¶é—´
                        if life_event_analysis.get('wealth'):
                            wealth = life_event_analysis['wealth']
                            
                            pocai_risk = wealth.get('pocai_risk', [])
                            if pocai_risk:
                                analysis_text += "\nâ€¢ ç ´è´¢é£é™©æ—¶æ®µï¼š\n"
                                for item in pocai_risk[:5]:  # æœ€å¤šæ˜¾ç¤º5ä¸ª
                                    analysis_text += f"  - {item['period']}ï¼ˆ{item['dayun']}å¤§è¿ï¼‰ï¼š{item['level']}é£é™©\n"
                                    analysis_text += f"    åŸå› ï¼š{item['reason']}\n"
                                    analysis_text += f"    å»ºè®®ï¼š{item['advice']}\n"
                            
                            pocai_years = wealth.get('pocai_years', [])
                            if pocai_years:
                                year_str = 'ã€'.join([str(y['year']) for y in pocai_years[:5]])
                                analysis_text += f"  - éœ€æ³¨æ„ç†è´¢çš„å¹´ä»½ï¼š{year_str}\n"
                            
                            if wealth.get('summary'):
                                analysis_text += f"\n  æ€»ç»“ï¼š{wealth['summary']}\n"
                        
                        # 3. å®˜è¿æ—¶é—´
                        if life_event_analysis.get('official'):
                            official = life_event_analysis['official']
                            
                            guanyun_opp = official.get('guanyun_opportunities', [])
                            if guanyun_opp:
                                analysis_text += "\nâ€¢ å®˜è¿æœºä¼šæ—¶æ®µï¼š\n"
                                for item in guanyun_opp[:5]:  # æœ€å¤šæ˜¾ç¤º5ä¸ª
                                    analysis_text += f"  - {item['period']}ï¼ˆ{item['dayun']}å¤§è¿ï¼‰ï¼š{item['level']}æœºä¼š\n"
                                    analysis_text += f"    åŸå› ï¼š{item['reason']}\n"
                                    analysis_text += f"    å»ºè®®ï¼š{item['advice']}\n"
                            
                            shengguan_years = official.get('shengguan_years', [])
                            if shengguan_years:
                                year_str = 'ã€'.join([str(y['year']) for y in shengguan_years[:5]])
                                analysis_text += f"  - æœ‰æœ›å‡å®˜çš„å¹´ä»½ï¼š{year_str}\n"
                            
                            if official.get('summary'):
                                analysis_text += f"\n  æ€»ç»“ï¼š{official['summary']}\n"
                        
                        analysis_text += "\nç»å…¸ä¾æ®ï¼šã€Šä¸‰å‘½é€šä¼šÂ·è®ºä¸‰åˆ‘ã€‹ã€Šä¸‰å‘½é€šä¼šÂ·è®ºå®˜ç¬¦ã€‹ã€Šä¸‰å‘½é€šä¼šÂ·è®ºç¾ç…ã€‹ã€Šæ¸Šæµ·å­å¹³Â·è®ºå¤§è¿ã€‹\n\n"

                    # 8. æœªæ¥åå¹´è½¬æŠ˜ç‚¹åˆ†æ
                    try:
                        turning_points_text = self.analyze_turning_points(pillars_for_analyzer, birth_info, day_master)
                        analysis_text += "ã€æœªæ¥åå¹´è½¬æŠ˜ç‚¹åˆ†æã€‘\n"
                        analysis_text += (turning_points_text if turning_points_text else "â€¢ æœªæ¥åå¹´è½¬æŠ˜ç‚¹åˆ†æï¼šè®¡ç®—ä¸­...\n")
                        analysis_text += "\n"
                        print(f"âœ… è½¬æŠ˜ç‚¹åˆ†æå®Œæˆ")
                    except Exception as e:
                        print(f"âš ï¸ è½¬æŠ˜ç‚¹åˆ†æå¤±è´¥: {e}")
                        import traceback
                        traceback.print_exc()
                        analysis_text += "ã€æœªæ¥åå¹´è½¬æŠ˜ç‚¹åˆ†æã€‘\nâ€¢ è½¬æŠ˜ç‚¹åˆ†æè¿‡ç¨‹å‡ºé”™ï¼Œè¯·é‡è¯•\n\n"

                    # 9. æœˆä»½çº§æ—¶æœºåˆ†æï¼ˆæœªæ¥3å¹´ï¼‰
                    try:
                        from datetime import datetime
                        current_year = datetime.now().year
                        monthly_analysis_text = ""
                        for year_offset in range(3):  # åˆ†ææœªæ¥3å¹´çš„æœˆä»½çº§æ—¶æœº
                            target_year = current_year + year_offset
                            monthly_info = self.analyze_monthly_opportunities(pillars_for_analyzer, target_year, day_master, birth_info)
                            if monthly_info:
                                formatted = self.format_monthly_opportunities(monthly_info, target_year)
                                if formatted:
                                    monthly_analysis_text += formatted

                        analysis_text += "ã€æœˆä»½çº§æ—¶æœºåˆ†æã€‘\n"
                        if monthly_analysis_text:
                            analysis_text += monthly_analysis_text + "\n"
                        else:
                            analysis_text += "â€¢ æœªæ¥3å¹´æœˆä»½çº§æ—¶æœºåˆ†æï¼šè®¡ç®—ä¸­...\n"
                        print(f"âœ… æœˆä»½çº§æ—¶æœºåˆ†æå®Œæˆ")
                    except Exception as e:
                        print(f"âš ï¸ æœˆä»½çº§æ—¶æœºåˆ†æå¤±è´¥: {e}")
                        import traceback
                        traceback.print_exc()
                        analysis_text += "ã€æœˆä»½çº§æ—¶æœºåˆ†æã€‘\nâ€¢ æœˆä»½çº§æ—¶æœºåˆ†æè¿‡ç¨‹å‡ºé”™ï¼Œè¯·é‡è¯•\n"

                    # ğŸ”¥ ä¿®å¤ï¼šæ·»åŠ äº”è¡Œè¡¥æ•‘åˆ†æï¼ˆåŸºäºã€Šç©·é€šå®é‰´ã€‹ã€Šæ»´å¤©é«“ã€‹ï¼‰
                    print(f"ğŸ” å¼€å§‹äº”è¡Œè¡¥æ•‘åˆ†æ...")
                    try:
                        # 1. è·å–äº”è¡Œåˆ†å¸ƒæ•°æ®
                        wuxing_dist = sxtwl_result.get('wuxing_distribution', {}) if sxtwl_result else {}
                        if not wuxing_dist and profile_raw:
                            wuxing_dist = profile_raw.get('distribution', {})
                        
                        # 2. è®¡ç®—äº”è¡Œç™¾åˆ†æ¯”ï¼Œè¯†åˆ«ç¼ºå¤±å’Œåå¼±çš„äº”è¡Œ
                        total_wuxing = sum(wuxing_dist.values()) if wuxing_dist else 1.0
                        missing_wuxing = []
                        weak_wuxing = []
                        strong_wuxing = []
                        
                        for element in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']:
                            count = wuxing_dist.get(element, 0.0)
                            percentage = (count / total_wuxing * 100) if total_wuxing > 0 else 0
                            if count == 0 or (count < 0.1 and percentage < 1.0):
                                missing_wuxing.append(element)
                            elif percentage < 10.0:
                                weak_wuxing.append(element)
                            elif percentage >= 30.0:
                                strong_wuxing.append(element)
                        
                        # 3. è·å–ç”¨ç¥ä¿¡æ¯ï¼ˆä»ä¹‹å‰çš„åˆ†æç»“æœï¼‰
                        yongshen_wuxing = []
                        xishen_wuxing = []
                        jishen_wuxing = []
                        
                        if ziping_result_early:
                            yongshen_info = ziping_result_early.details.get('yongshen_info', {})
                            yongshen_str = yongshen_info.get('yongshen', '')
                            xishen_str = yongshen_info.get('xishen', '')
                            jishen_str = yongshen_info.get('jishen', '')
                            
                            # æå–äº”è¡Œï¼ˆæ”¯æŒå¤©å¹²å’Œç›´æ¥äº”è¡Œå­—ç¬¦ï¼‰
                            def extract_wuxing(s):
                                if not s:
                                    return []
                                wx_list = []
                                # å¤©å¹²åˆ°äº”è¡Œçš„æ˜ å°„
                                tiangan_to_wuxing = {
                                    'ç”²': 'æœ¨', 'ä¹™': 'æœ¨',
                                    'ä¸™': 'ç«', 'ä¸': 'ç«',
                                    'æˆŠ': 'åœŸ', 'å·±': 'åœŸ',
                                    'åºš': 'é‡‘', 'è¾›': 'é‡‘',
                                    'å£¬': 'æ°´', 'ç™¸': 'æ°´'
                                }
                                # 1. å…ˆæå–ç›´æ¥å‡ºç°çš„äº”è¡Œå­—ç¬¦
                                for wx in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']:
                                    if wx in s and wx not in wx_list:
                                        wx_list.append(wx)
                                # 2. æå–å¤©å¹²å¹¶è½¬æ¢ä¸ºäº”è¡Œ
                                for tiangan, wuxing in tiangan_to_wuxing.items():
                                    if tiangan in s and wuxing not in wx_list:
                                        wx_list.append(wuxing)
                                return wx_list
                            
                            yongshen_wuxing = extract_wuxing(yongshen_str)
                            xishen_wuxing = extract_wuxing(xishen_str)
                            jishen_wuxing = extract_wuxing(jishen_str)
                            
                            # è°ƒè¯•ä¿¡æ¯
                            print(f"ğŸ” äº”è¡Œæå–ç»“æœ - ç”¨ç¥:{yongshen_str} -> {yongshen_wuxing}, å–œç¥:{xishen_str} -> {xishen_wuxing}, å¿Œç¥:{jishen_str} -> {jishen_wuxing}")
                        
                        # 4. ç”Ÿæˆäº”è¡Œè¡¥æ•‘å»ºè®®
                        remedy_text = self.analyze_wuxing_remedy_comprehensive(
                            missing_wuxing=missing_wuxing,
                            weak_wuxing=weak_wuxing,
                            strong_wuxing=strong_wuxing,
                            yongshen_wuxing=yongshen_wuxing,
                            xishen_wuxing=xishen_wuxing,
                            jishen_wuxing=jishen_wuxing,
                            pattern_info=bazi_snapshot.get('bazi_pattern', {}),
                            ten_gods_detail=ten_gods_detail,
                            day_master=day_master
                        )
                        
                        if remedy_text:
                            analysis_text += "ã€äº”è¡Œè¡¥æ•‘å»ºè®®ã€‘ï¼ˆåŸºäºã€Šç©·é€šå®é‰´ã€‹ã€Šæ»´å¤©é«“ã€‹ï¼‰\n"
                            analysis_text += remedy_text + "\n\n"
                            print(f"âœ… äº”è¡Œè¡¥æ•‘åˆ†æå®Œæˆ")
                    except Exception as e:
                        print(f"âš ï¸ äº”è¡Œè¡¥æ•‘åˆ†æå¤±è´¥: {e}")
                        import traceback
                        traceback.print_exc()

                    # 7. ç»¼åˆè¯„åˆ†ï¼ˆåŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç†è®ºï¼‰
                    print(f"ğŸ” å¼€å§‹ç»¼åˆå‘½æ ¼è¯„åˆ†...")
                    analysis_results = {
                        'caiyun': caiyun_result,
                        'dayun': dayun_result,
                        'shensha': shensha_result,
                        'geju': geju_result,
                        'yongshen': yongshen_result,
                        'tiaohou': tiaohou_result
                    }
                    # âœ… åˆ é™¤é”™è¯¯çš„"ç»¼åˆå‘½æ ¼æˆè´¥"
                    # ä¸åº”è¯¥æœ‰"æ ¼å±€ç ´è´¥ï¼Œå¤§è¿æœªçŸ¥ï¼Œéœ€ç­‰å¾…è¿åŠ¿ç¿»è½¬ã€‚è´¢è¿æ ¼å±€æˆç«‹ã€‚"è¿™ç§è‡ªç›¸çŸ›ç›¾çš„æè¿°
                    # æ¯ä¸ªåˆ†æé¡¹ç›®ï¼ˆæ ¼å±€ã€ç”¨ç¥ã€è°ƒå€™ã€è´¢è¿ç­‰ï¼‰éƒ½æœ‰è‡ªå·±çš„æˆè´¥åˆ¤æ–­å’Œç»å…¸ä¾æ®

                    print(f"âœ“ ç»å…¸å‘½ç†åˆ†æå®Œæˆ")

                except Exception as e:
                    print(f"âš ï¸ ç»å…¸åˆ†æå™¨åˆ†æå¤±è´¥: {e}")
                    import traceback
                    traceback.print_exc()
                    # ğŸ”¥ ä¿®å¤ï¼šä¸è¦è¦†ç›–å·²æœ‰çš„åˆ†æå†…å®¹ï¼Œè€Œæ˜¯è¿½åŠ é”™è¯¯ä¿¡æ¯
                    analysis_text += f"\nâš ï¸ ç»å…¸åˆ†æå™¨éƒ¨åˆ†åŠŸèƒ½å‡ºé”™: {e}\n"
                    print(f"ğŸ” å½“å‰analysis_texté•¿åº¦: {len(analysis_text)}")
                    print(f"ğŸ” å½“å‰analysis_textå†…å®¹: {analysis_text[:500]}...")
            else:
                print(f"âš ï¸ ç»å…¸åˆ†æå™¨ä¸å¯ç”¨")
                analysis_text += "âš ï¸ ç»å…¸å‘½ç†åˆ†æå™¨æœªåŠ è½½ï¼Œä½¿ç”¨å¤‡ç”¨åˆ†æ\n"

            # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ç»Ÿä¸€åˆ†æå™¨ï¼ˆä»…åœ¨åˆ†ææ–‡æœ¬ä¸ºç©ºæ—¶ä½¿ç”¨ï¼‰
            if (not analysis_text or analysis_text.strip() == "âš ï¸ ç»å…¸å‘½ç†åˆ†æå™¨æœªåŠ è½½ï¼Œä½¿ç”¨å¤‡ç”¨åˆ†æ\n") and LOCAL_ANALYZER_AVAILABLE and self.local_analyzer:
                try:
                    print(f"âœ¨ å¼€å§‹ç»Ÿä¸€ç‰ˆæœ¬åœ°å‘½ç†åˆ†æ...")
                    bazi_result = self.local_analyzer.analyze_bazi(
                        pillars=pillars,
                        gender=gender,
                        birth_info=birth_info
                    )
                    # ğŸ”¥ P1ä¿®å¤ï¼šæ­£ç¡®æå–local_analysis_textï¼ˆä¸æ˜¯å­—å…¸åºåˆ—åŒ–ï¼‰
                    if isinstance(bazi_result, dict) and 'local_analysis_text' in bazi_result:
                        analysis_text += bazi_result['local_analysis_text']
                    else:
                        analysis_text += str(bazi_result)
                    print(f"âœ“ ç»Ÿä¸€ç‰ˆæœ¬åœ°å‘½ç†åˆ†æå®Œæˆ")
                except Exception as e:
                    print(f"âš ï¸ ç»Ÿä¸€ç‰ˆåˆ†æå™¨å‡ºé”™: {e}")
                    analysis_text += f"ç»Ÿä¸€ç‰ˆåˆ†æä¹Ÿå¤±è´¥: {e}\n"

            # æ·»åŠ å£°æ˜
            disclaimer = "\n\n" + "="*60 + "\n"
            disclaimer += "å£°æ˜ï¼šæœ¬æŠ¥å‘Šå®Œå…¨åŸºäºæœ¬åœ°ç®—æ³•ç”Ÿæˆï¼Œæœªä½¿ç”¨ä»»ä½•å¤–éƒ¨API\n"
            disclaimer += "é‡‡ç”¨sxtwlç²¾ç¡®å…«å­—è®¡ç®— + ä¼ ç»Ÿå‘½ç†å­¦è§„åˆ™å¼•æ“\n"
            disclaimer += "ä»…ä¾›å‚è€ƒï¼Œå‘½è¿æŒæ¡åœ¨è‡ªå·±æ‰‹ä¸­ï¼Œåå¤©åŠªåŠ›åŒæ ·é‡è¦\n"
            disclaimer += "="*60

            final_analysis = analysis_text + disclaimer

            # ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿final_analysisæ˜¯UTF-8å­—ç¬¦ä¸²ï¼Œé¿å…ä¹±ç 
            if isinstance(final_analysis, bytes):
                final_analysis = final_analysis.decode('utf-8', errors='replace')
            elif not isinstance(final_analysis, str):
                final_analysis = str(final_analysis)

            # ğŸ”¥ è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥åˆ†ææ–‡æœ¬é•¿åº¦å’Œå®Œæ•´æ€§
            print(f"ğŸ“Š åˆ†ææ–‡æœ¬ç»Ÿè®¡ï¼š")
            print(f"   - åŸºç¡€åˆ†æé•¿åº¦ï¼š{len(analysis_text)} å­—ç¬¦")
            print(f"   - æœ€ç»ˆåˆ†æé•¿åº¦ï¼š{len(final_analysis)} å­—ç¬¦")
            print(f"   - åŒ…å«æ®µè½æ•°ï¼š{final_analysis.count('ã€')} ä¸ª")
            print(f"   - æ–‡æœ¬é¢„è§ˆï¼š{final_analysis[:200]}...")
            print(f"   - æ–‡æœ¬ç»“å°¾ï¼š...{final_analysis[-200:]}")

            # ğŸ”¥ æ£€æŸ¥åˆ†æå®Œæ•´æ€§
            # âœ… ä¿®å¤ï¼šæ›´æ–°æœŸæœ›çš„æ ‡é¢˜åˆ—è¡¨ï¼Œä½¿å…¶ä¸å®é™…ç”Ÿæˆçš„æ ‡é¢˜åŒ¹é…
            expected_sections = [
                "ã€å¤§è¿åˆ†æã€‘",
                "ã€ç¥ç…åˆ†æã€‘", "ã€æ ¼å±€åˆ†æã€‘", "ã€ç”¨ç¥åˆ†æã€‘", "ã€è°ƒå€™åˆ†æã€‘",
                "ã€å…­äº²å©šå§»åˆ†æã€‘", "ã€å¥åº·åˆ†æã€‘",
                "ã€è´¢å¯Œç»“æ„åˆ†æã€‘", "ã€äº‹ä¸šåˆ†æã€‘"
            ]
            # âœ… ä¿®å¤ï¼šæ£€æŸ¥"ã€æœªæ¥æµå¹´æç¤ºã€‘"æˆ–"ã€æµå¹´è¯¦ç»†åˆ†æã€‘"ï¼ˆä¸¤è€…éƒ½å¯èƒ½å‡ºç°ï¼‰
            has_liunian = "ã€æœªæ¥æµå¹´æç¤ºã€‘" in final_analysis or "ã€æµå¹´è¯¦ç»†åˆ†æã€‘" in final_analysis
            # âœ… ä¿®å¤ï¼šæ£€æŸ¥"ã€å…­äº²å®Œæ•´åˆ†æã€‘"ï¼ˆåŒ…å«çˆ¶æ¯å’Œå­å¥³åˆ†æï¼‰
            has_sixqin = "ã€å…­äº²å®Œæ•´åˆ†æã€‘" in final_analysis
            
            missing_sections = [section for section in expected_sections if section not in final_analysis]
            if not has_liunian:
                missing_sections.append("ã€æœªæ¥æµå¹´æç¤ºã€‘æˆ–ã€æµå¹´è¯¦ç»†åˆ†æã€‘")
            if not has_sixqin:
                missing_sections.append("ã€å…­äº²å®Œæ•´åˆ†æã€‘ï¼ˆåŒ…å«çˆ¶æ¯å’Œå­å¥³åˆ†æï¼‰")
            
            if missing_sections:
                print(f"âš ï¸ ç¼ºå¤±çš„åˆ†ææ®µè½ï¼š{missing_sections}")
            else:
                print(f"âœ… æ‰€æœ‰åˆ†ææ®µè½å®Œæ•´")

            # ä¿å­˜åˆ†æç»“æœ
            self.last_analysis_result = final_analysis

            # ğŸ”¥ å…³é”®ä¿®å¤ï¼šè¿”å›å­—å…¸æ ¼å¼ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²
            return self._build_basic_result_dict(pillars, year, month, day, hour_index, gender, name, final_analysis, birth_info)

        except Exception as e:
            error_msg = f"æœ¬åœ°å…«å­—åˆ†æå¤±è´¥ï¼š{str(e)}"
            print(f"âŒ {error_msg}")
            import traceback
            traceback.print_exc()
            return self.get_fallback_bazi_result(year, month, day, hour_index, gender, name)

    def _build_basic_result_dict(self, pillars, year, month, day, hour_index, gender, name, analysis_text, extra_birth_info=None):
        """æ„å»ºåŸºæœ¬çš„ç»“æœå­—å…¸"""
        # ğŸ”¥ ä¿®å¤ï¼šæ ¼å¼åŒ–pillarsæ˜¾ç¤ºï¼ˆå¤„ç†åˆ—è¡¨å’Œå­—ç¬¦ä¸²ä¸¤ç§æ ¼å¼ï¼‰
        def format_pillar(p):
            if isinstance(p, list) and len(p) >= 2:
                return f"{p[0]}{p[1]}"
            elif isinstance(p, str):
                return p
            else:
                return str(p)

        # ç¡®ä¿day_masteræ­£ç¡®æå–
        day_pillar_data = pillars.get('day', ['', ''])
        if isinstance(day_pillar_data, list) and len(day_pillar_data) >= 1:
            day_master = day_pillar_data[0]
        elif isinstance(day_pillar_data, str) and len(day_pillar_data) >= 1:
            day_master = day_pillar_data[0]
        else:
            day_master = ''

        # æ„å»ºpillarså­—å…¸ï¼ˆç»Ÿä¸€å¤„ç†åˆ—è¡¨å’Œå­—ç¬¦ä¸²æ ¼å¼ï¼‰
        def safe_get_pillar_list(p):
            """å®‰å…¨æå–pillaråˆ—è¡¨"""
            if isinstance(p, list) and len(p) >= 2:
                return [p[0], p[1]]
            elif isinstance(p, str) and len(p) >= 2:
                return [p[0], p[1]]
            else:
                return ['', '']

        pillars_dict = {
            'year': safe_get_pillar_list(pillars.get('year', '')),
            'month': safe_get_pillar_list(pillars.get('month', '')),
            'day': safe_get_pillar_list(pillars.get('day', '')),
            'hour': safe_get_pillar_list(pillars.get('hour', ''))
        }

        result = {
            'year_pillar': format_pillar(pillars.get('year', '')),
            'month_pillar': format_pillar(pillars.get('month', '')),
            'day_pillar': format_pillar(pillars.get('day', '')),
            'hour_pillar': format_pillar(pillars.get('hour', '')),
            'day_master': day_master,
            'day_master_element': self.get_wuxing_by_tiangan(day_master),
            'pillars': pillars_dict,
            'wuxing_distribution': self.calculate_wuxing_distribution(pillars_dict),
            'bazi_pattern': {
                'pattern_type': 'æœ¬åœ°å‘½ç†åˆ†æ',
                'pattern_description': 'åŸºäºä¼ ç»Ÿå‘½ç†å­¦è§„åˆ™å¼•æ“çš„å®Œæ•´åˆ†æ'
            },
            'ten_gods': self.calculate_ten_gods_simple(day_master, pillars_dict),
            'birth_info': {
                'year': year,
                'month': month,
                'day': day,
                'hour_index': hour_index,
                'gender': gender,
                'name': name
            },
            # ğŸ”¥ å…³é”®ï¼šå°†åˆ†ææ–‡æœ¬æ”¾åœ¨ç‰¹æ®Šé”®ä¸­
            'local_analysis_text': analysis_text
        }
        if extra_birth_info:
            try:
                result['birth_info'].update({k: v for k, v in extra_birth_info.items() if v is not None})
            except Exception:
                pass
        self.last_birth_info = result['birth_info']
        return result

    def calculate_bazi_with_deepseek(self, year, month, day, hour_index, gender, name="æœªæä¾›"):
        """å…«å­—è®¡ç®—æ–¹æ³• - ç»Ÿä¸€ä½¿ç”¨æ–°çš„ DeepSeekBaziCalculator"""

        # ğŸ”¥ æ¢å¤ï¼šä½¿ç”¨ä¸»ç¨‹åºå†…ç½®çš„ç²¾ç¡®è®¡ç®—ç³»ç»Ÿï¼ˆsxtwl + lunar-pythonï¼‰
        # ä¸å†ä¾èµ–å¤–éƒ¨æ¨¡å—ï¼Œé¿å…"ç‰›å¤´ä¸å¯¹é©¬å˜´"çš„é—®é¢˜

        # å°†hour_indexè½¬æ¢ä¸ºä¼ ç»Ÿæ—¶è¾°è¡¨ç¤º
        shichen_map = {
            0: "å­æ—¶(23:00-1:00)", 1: "ä¸‘æ—¶(1:00-3:00)", 2: "å¯…æ—¶(3:00-5:00)",
            3: "å¯æ—¶(5:00-7:00)", 4: "è¾°æ—¶(7:00-9:00)", 5: "å·³æ—¶(9:00-11:00)",
            6: "åˆæ—¶(11:00-13:00)", 7: "æœªæ—¶(13:00-15:00)", 8: "ç”³æ—¶(15:00-17:00)",
            9: "é…‰æ—¶(17:00-19:00)", 10: "æˆŒæ—¶(19:00-21:00)", 11: "äº¥æ—¶(21:00-23:00)"
        }
        shichen_text = shichen_map.get(hour_index, "åˆæ—¶(11:00-13:00)")

        is_leap = False
        try:
            if hasattr(self, 'analysis_params'):
                is_leap = self.analysis_params.get('is_leap', False)
            elif hasattr(self, 'leap_month'):
                is_leap = self.leap_month.isChecked()
        except Exception:
            is_leap = False

        # å°†æ•°å­—æœˆæ—¥è½¬æ¢ä¸ºä¸­æ–‡è¡¨ç¤º
        chinese_months = ["æ­£æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ",
                         "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"]
        chinese_days = ["åˆä¸€", "åˆäºŒ", "åˆä¸‰", "åˆå››", "åˆäº”", "åˆå…­", "åˆä¸ƒ", "åˆå…«", "åˆä¹", "åˆå",
                       "åä¸€", "åäºŒ", "åä¸‰", "åå››", "åäº”", "åå…­", "åä¸ƒ", "åå…«", "åä¹", "äºŒå",
                       "å»¿ä¸€", "å»¿äºŒ", "å»¿ä¸‰", "å»¿å››", "å»¿äº”", "å»¿å…­", "å»¿ä¸ƒ", "å»¿å…«", "å»¿ä¹", "ä¸‰å"]

        chinese_month = chinese_months[month-1] if 1 <= month <= 12 else f"{month}æœˆ"
        chinese_day = chinese_days[day-1] if 1 <= day <= 30 else f"{day}æ—¥"

        # ç³»ç»Ÿæç¤º
        sys_prompt = """ä½ æ˜¯ä¸€ä½ç²¾é€šä¼ ç»Ÿå‘½ç†å­¦çš„ä¸“ä¸šå…«å­—åˆ†æå¸ˆï¼Œå…·æœ‰æ·±åšçš„ç†è®ºåŸºç¡€å’Œä¸°å¯Œçš„å®æˆ˜ç»éªŒã€‚

ã€é‡è¦ã€‘ç”¨æˆ·å·²ç»ä½¿ç”¨sxtwl+lunar-pythonç²¾ç¡®è®¡ç®—äº†æ‰€æœ‰åŸºç¡€æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š
- ç²¾ç¡®å››æŸ±ï¼ˆåŸºäºçœŸå¤ªé˜³æ—¶å’Œåœ°ç†ä½ç½®æ ¡æ­£ï¼‰
- å‡†ç¡®çš„å†œå†å…¬å†è½¬æ¢
- å®Œæ•´çš„åç¥ã€äº”è¡Œã€è—å¹²ç­‰åŸºç¡€ä¿¡æ¯

ã€ä½ çš„èŒè´£ã€‘è¯·ç›´æ¥ä½¿ç”¨ç”¨æˆ·æä¾›çš„å‡†ç¡®åŸºç¡€æ•°æ®ï¼Œä¸“æ³¨äºæ·±åº¦å‘½ç†è§£è¯»ï¼Œä¸è¦é‡æ–°è®¡ç®—ä»»ä½•åŸºç¡€æ•°æ®ã€‚
ã€ç¦æ­¢è¡Œä¸ºã€‘ä¸è¦é‡æ–°è®¡ç®—å››æŸ±ã€ä¸è¦é‡æ–°è½¬æ¢æ—¥æœŸã€ä¸è¦é‡æ–°è®¡ç®—åç¥äº”è¡Œã€‚

ã€ä¸“æ³¨ä»»åŠ¡ã€‘åŸºäºå‡†ç¡®æ•°æ®è¿›è¡Œä»¥ä¸‹æ·±åº¦åˆ†æï¼Œå¿…é¡»åŒ…å«ç²¾ç¡®çš„æ—¶é—´ç‚¹å’Œå…·ä½“å¹´ä»½æœˆä»½ï¼š

1. ç¥ç…åˆ†æï¼šè¯¦ç»†åˆ†æå‘½ä¸­çš„å‰ç¥å‡¶ç…ï¼ŒåŒ…æ‹¬å¤©ä¹™è´µäººã€æ–‡æ˜Œè´µäººã€æ¡ƒèŠ±ã€åç›–ã€ç©ºäº¡ç­‰
2. è´µäººåˆ†æï¼šåˆ†æå‘½ä¸­è´µäººç±»å‹ã€å‡ºç°æ—¶é—´ã€è´µäººæ–¹ä½ã€å¦‚ä½•é‡åˆ°è´µäºº
3. å‘½æ ¼åˆ†æï¼šè¯¦ç»†åˆ†ææ ¼å±€ç±»å‹ã€æ ¼å±€é«˜ä½ã€æˆæ ¼ç ´æ ¼æ¡ä»¶
4. å…­äº²åˆ†æï¼šçˆ¶æ¯ã€å…„å¼Ÿã€é…å¶ã€å­å¥³çš„å…·ä½“æƒ…å†µå’Œå…³ç³»è´¨é‡
5. äº‹ä¸šåˆ†æï¼šé€‚åˆçš„å…·ä½“è¡Œä¸šã€èŒä½ã€å‘å±•æ–¹å‘ã€æˆåŠŸæ—¶é—´ç‚¹
6. è´¢è¿åˆ†æï¼šè´¢è¿å¼ºå¼±ã€å‘è´¢æ—¶æœºã€æŠ•èµ„å»ºè®®ã€ç ´è´¢é£é™©
7. è´¢å¯Œç­‰çº§ï¼šå…·ä½“èƒ½è¾¾åˆ°ä»€ä¹ˆè´¢å¯Œæ°´å¹³ã€ä»€ä¹ˆæ—¶å€™è¾¾åˆ°ã€é€šè¿‡ä»€ä¹ˆæ–¹å¼
8. å¥åº·é£é™©ï¼šå…·ä½“çš„å¥åº·é—®é¢˜ã€å‘ç—…æ—¶é—´ã€é¢„é˜²æ–¹æ³•ã€è°ƒç†å»ºè®®
9. å¤§è¿æµå¹´ï¼šæ¯æ­¥å¤§è¿çš„å…·ä½“å½±å“ã€å…³é”®å¹´ä»½çš„è¿åŠ¿å˜åŒ–
10. æ³¨æ„äº‹é¡¹ï¼šå…·ä½“çš„ç¦å¿Œã€é£é™©ç‚¹ã€éœ€è¦é¿å…çš„æ—¶é—´å’Œäº‹æƒ…
11. å®ç”¨å»ºè®®ï¼šå…·ä½“çš„è¡ŒåŠ¨å»ºè®®ã€æ—¶é—´å®‰æ’ã€æ–¹ä½é€‰æ‹©ã€é¢œè‰²æ­é…

ã€åˆ†æè¦æ±‚ã€‘
- å¿…é¡»ç»™å‡ºå…·ä½“çš„å¹´ä»½ã€æœˆä»½ã€æ—¶é—´æ®µ
- å¿…é¡»è¯´æ˜å…·ä½“çš„æ•°å€¼ã€ç­‰çº§ã€ç¨‹åº¦
- å¿…é¡»æä¾›å¯æ“ä½œçš„å…·ä½“å»ºè®®
- å¿…é¡»åŸºäºä¼ ç»Ÿå‘½ç†å­¦ç»å…¸ç†è®º
- åˆ†æè¦è¯¦ç»†ã€å‡†ç¡®ã€å®ç”¨"""

        # æ”¶é›†å‡ºç”Ÿåœ°ï¼ˆè‹¥ç•Œé¢å¯è·å¾—ï¼‰
        birth_place = None
        try:
            province = ""
            city = ""

            # è·å–çœä»½
            if hasattr(self, 'birth_province') and self.birth_province.currentText():
                province = self.birth_province.currentText()

            # è·å–åŸå¸‚ï¼ˆæ’é™¤é»˜è®¤æç¤ºæ–‡å­—ï¼‰
            if hasattr(self, 'birth_city') and self.birth_city.currentText():
                city_text = self.birth_city.currentText()
                if city_text != "è¯·é€‰æ‹©åŸå¸‚":
                    city = city_text

            # ç»„åˆå‡ºç”Ÿåœ°
            if province and city:
                birth_place = f"{province}{city}"
            elif province:
                birth_place = province
            elif city:
                birth_place = city

        except Exception:
            birth_place = None

        # è·å–ç•Œé¢ç²¾ç¡®æ—¶é—´
        precise_time = ""
        try:
            if hasattr(self, 'precise_hour') and hasattr(self, 'precise_minute'):
                hour = self.precise_hour.value()
                minute = self.precise_minute.value()
                precise_time = f"({hour}:{minute:02d})"
        except Exception:
            pass

        # æ„å»ºæé—®ï¼šå®Œå…¨æŒ‰ç•Œé¢å¡«å†™çš„ä¿¡æ¯ï¼Œè®©APIè‡ªè¡Œå¤„ç†çœŸå¤ªé˜³æ—¶
        birth_location = f" å‡ºç”Ÿäº{birth_place}" if birth_place else ""

        # ğŸ”¥ æ–°å¢ï¼šä½¿ç”¨ sxtwl æœ¬åœ°è®¡ç®—å››æŸ±ï¼Œç¡®ä¿å‡†ç¡®æ€§
        sxtwl_pillars = None
        sxtwl_info = ""
        if SXTWL_AVAILABLE:
            try:
                # è½¬æ¢ä¸ºå…¬å†è¿›è¡Œè®¡ç®—
                from lunar_python import Lunar, Solar

                # ğŸ”§ ä¿®å¤ï¼šæ­£ç¡®è·å–ç”¨æˆ·è¾“å…¥çš„å…·ä½“æ—¶é—´
                # ä¼˜å…ˆä»ç•Œé¢ç²¾ç¡®æ—¶é—´æ§ä»¶è·å–
                input_hour = 1  # é»˜è®¤å€¼
                input_minute = 30  # é»˜è®¤å€¼

                try:
                    if hasattr(self, 'precise_hour') and hasattr(self, 'precise_minute'):
                        input_hour = self.precise_hour.value()
                        input_minute = self.precise_minute.value()
                        print(f"ä»ç•Œé¢è·å–ç²¾ç¡®æ—¶é—´ï¼š{input_hour}:{input_minute}")
                    else:
                        # å¦‚æœæ²¡æœ‰ç²¾ç¡®æ—¶é—´æ§ä»¶ï¼Œä»æ—¶è¾°ç´¢å¼•æ¨ç®—
                        hour_map = {0: (23, 30), 1: (1, 30), 2: (3, 30), 3: (5, 30), 4: (7, 30), 5: (9, 30),
                                   6: (11, 30), 7: (13, 30), 8: (15, 30), 9: (17, 30), 10: (19, 30), 11: (21, 30)}
                        if 'hour_index' in locals():
                            input_hour, input_minute = hour_map.get(hour_index, (1, 30))
                            print(f"ä»æ—¶è¾°ç´¢å¼•æ¨ç®—æ—¶é—´ï¼š{input_hour}:{input_minute}")
                except Exception as e:
                    print(f"è·å–æ—¶é—´å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼1:30: {e}")
                    input_hour, input_minute = 1, 30

                # å†œå†è½¬å…¬å†
                lunar_month = self._normalize_lunar_month(year, month, is_leap)
                lunar = Lunar.fromYmdHms(year, lunar_month, day, input_hour, input_minute, 0)
                solar = lunar.getSolar()

                # éªŒè¯è½¬æ¢ç»“æœå¹¶è·å–æ­£ç¡®çš„å†œå†æ˜¾ç¤ºä¿¡æ¯
                solar_year = solar.getYear()
                solar_month = solar.getMonth()
                solar_day = solar.getDay()

                # åå‘éªŒè¯ï¼šå…¬å†è½¬å›å†œå†ï¼Œç¡®ä¿æ˜¾ç¤ºæ­£ç¡®çš„å†œå†ä¿¡æ¯
                solar_verify = Solar.fromYmdHms(solar_year, solar_month, solar_day, input_hour, input_minute, 0)
                lunar_verify = solar_verify.getLunar()

                # è·å–æ­£ç¡®çš„å†œå†æ˜¾ç¤ºä¿¡æ¯
                lunar_year_cn = lunar_verify.getYearInChinese()
                lunar_month_cn = lunar_verify.getMonthInChinese()
                lunar_day_cn = lunar_verify.getDayInChinese()

                print(f"å†œå†è½¬æ¢éªŒè¯ï¼š")
                print(f"  è¾“å…¥ï¼šå†œå†{year}å¹´{month}æœˆ{day}æ—¥ {input_hour}:{input_minute}")
                print(f"  è½¬æ¢ï¼šå…¬å†{solar_year}å¹´{solar_month}æœˆ{solar_day}æ—¥")
                print(f"  éªŒè¯ï¼š{lunar_year_cn}å¹´{lunar_month_cn}{lunar_day_cn}")

                # æ£€æŸ¥è½¬æ¢æ˜¯å¦æ­£ç¡®
                if (lunar_verify.getYear() != year or
                    lunar_verify.getMonth() != month or
                    lunar_verify.getDay() != day):
                    print(f"âš ï¸ å†œå†è½¬æ¢å¯èƒ½æœ‰è¯¯å·®ï¼š")
                    print(f"  æœŸæœ›ï¼š{year}-{month}-{day}")
                    print(f"  å®é™…ï¼š{lunar_verify.getYear()}-{lunar_verify.getMonth()}-{lunar_verify.getDay()}")

                # å¯¼å…¥Solarç±»
                from lunar_python import Solar

                # è·å–å‡ºç”Ÿåœ°ç»çº¬åº¦ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                longitude, latitude, _ = self._get_birth_location(province, city)
                # âœ… ä¿®å¤ï¼šå¦‚æœç»çº¬åº¦è·å–å¤±è´¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆï¼ˆä¸ç¬¬8422è¡Œé€»è¾‘ä¸€è‡´ï¼‰
                if longitude is None or latitude is None:
                    if province:
                        clean_province = province.replace("çœ", "").replace("å¸‚", "").replace("è‡ªæ²»åŒº", "").replace("ç‰¹åˆ«è¡Œæ”¿åŒº", "")
                        province_coordinates = {
                            "æ¹–å—": (112.98, 28.2), "æ¹–åŒ—": (114.31, 30.52), "å¹¿ä¸œ": (113.27, 23.13),
                            "æµ™æ±Ÿ": (120.19, 30.26), "æ±Ÿè‹": (118.78, 32.04), "å±±ä¸œ": (117.00, 36.65),
                            "æ²³å—": (113.65, 34.76), "å››å·": (104.06, 30.67), "é™•è¥¿": (108.95, 34.27),
                            "æ²³åŒ—": (114.48, 38.03), "å±±è¥¿": (112.53, 37.87), "è¾½å®": (123.38, 41.80),
                            "å‰æ—": (125.32, 43.88), "é»‘é¾™æ±Ÿ": (126.63, 45.75), "å®‰å¾½": (117.27, 31.86),
                            "ç¦å»º": (119.30, 26.08), "æ±Ÿè¥¿": (115.89, 28.68), "æµ·å—": (110.35, 20.02),
                            "è´µå·": (106.71, 26.57), "äº‘å—": (102.73, 25.04), "ç”˜è‚ƒ": (103.73, 36.03),
                            "é’æµ·": (101.74, 36.56), "å®å¤": (106.27, 38.47), "æ–°ç–†": (87.68, 43.77),
                            "è¥¿è—": (91.11, 29.97), "å†…è’™å¤": (111.65, 40.82), "å¹¿è¥¿": (108.33, 22.84),
                        }
                        if clean_province in province_coordinates:
                            longitude, latitude = province_coordinates[clean_province]
                            print(f"âš ï¸ ç»çº¬åº¦è·å–å¤±è´¥ï¼Œä½¿ç”¨çœä»½é»˜è®¤å€¼ï¼š{clean_province} -> ({longitude}, {latitude})")
                        else:
                            longitude, latitude = 120.0, 35.0
                            print(f"âš ï¸ ç»çº¬åº¦è·å–å¤±è´¥ï¼Œä½¿ç”¨ä¸œå…«åŒºæ ‡å‡†å€¼ï¼š({longitude}, {latitude})")
                    else:
                        longitude, latitude = 120.0, 35.0
                        print(f"âš ï¸ ç»çº¬åº¦è·å–å¤±è´¥ï¼Œä½¿ç”¨ä¸œå…«åŒºæ ‡å‡†å€¼ï¼š({longitude}, {latitude})")
                
                location_obj = Location(lon=longitude, lat=latitude) if longitude is not None and latitude is not None else None

                # ä½¿ç”¨ sxtwl è®¡ç®—å››æŸ±ï¼ˆåŸºäºè½¬æ¢åçš„å…¬å†æ—¥æœŸï¼‰
                sxtwl_result = compute_bazi_json(
                    year=solar_year,
                    month=solar_month,
                    day=solar_day,
                    hour=input_hour,  # ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„å°æ—¶
                    minute=input_minute,  # ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„åˆ†é’Ÿ
                    second=0,
                    tz_offset_hours=8.0,
                    rules=Rules(use_true_solar_time=True),
                    location=location_obj
                )

                sxtwl_pillars = sxtwl_result['pillars']
                boundary_risk = "ï¼ˆä¸´è¿‘èŠ‚æ°”è¾¹ç•Œï¼‰" if sxtwl_result['is_boundary_risky'] else ""

                # åŒ…å«å®Œæ•´çš„è½¬æ¢ä¿¡æ¯
                sxtwl_info = f"""

ã€æœ¬åœ°ç²¾ç¡®è®¡ç®—å››æŸ±ã€‘{boundary_risk}
å†œå†è¾“å…¥ï¼š{year}å¹´{month}æœˆ{day}æ—¥ {input_hour}:{input_minute}
å…¬å†è½¬æ¢ï¼š{solar_year}å¹´{solar_month}æœˆ{solar_day}æ—¥ {input_hour}:{input_minute}
å†œå†éªŒè¯ï¼š{lunar_year_cn}å¹´{lunar_month_cn}{lunar_day_cn}
"""
                # ğŸ”¥ ä¿®å¤ï¼šæ­£ç¡®æ ¼å¼åŒ–pillarsæ˜¾ç¤º
                def format_pillar(p):
                    if isinstance(p, list) and len(p) >= 2:
                        return f"{p[0]}{p[1]}"
                    elif isinstance(p, str):
                        return p
                    else:
                        return str(p)

                year_pillar_str = format_pillar(sxtwl_pillars['year'])
                month_pillar_str = format_pillar(sxtwl_pillars['month'])
                day_pillar_str = format_pillar(sxtwl_pillars['day'])
                hour_pillar_str = format_pillar(sxtwl_pillars['hour'])

                debug_info += f"å››æŸ±ç»“æœï¼šå¹´æŸ±{year_pillar_str} æœˆæŸ±{month_pillar_str} æ—¥æŸ±{day_pillar_str} æ—¶æŸ±{hour_pillar_str}\n"

                # ğŸ”§ ä¿®å¤ï¼šä¿å­˜ sxtwl ç»“æœåˆ°å¤šä¸ªä½ç½®ç¡®ä¿ä¸ä¸¢å¤±
                # æ·»åŠ äº”è¡Œåˆ†å¸ƒè®¡ç®—åˆ°sxtwl_resultä¸­
                try:
                    if CLASSIC_ANALYZER_AVAILABLE:
                        # ä½¿ç”¨ç»å…¸åˆ†æå™¨çš„äº”è¡Œåˆ†å¸ƒè®¡ç®—
                        from classic_analyzer.common import compute_wuxing_distribution
                        pillars_for_wuxing = {
                            'year': (sxtwl_pillars['year'][0], sxtwl_pillars['year'][1]),
                            'month': (sxtwl_pillars['month'][0], sxtwl_pillars['month'][1]),
                            'day': (sxtwl_pillars['day'][0], sxtwl_pillars['day'][1]),
                            'hour': (sxtwl_pillars['hour'][0], sxtwl_pillars['hour'][1])
                        }
                        wuxing_dist = compute_wuxing_distribution(pillars_for_wuxing)
                        sxtwl_result['wuxing_distribution'] = wuxing_dist
                    else:
                        # ä½¿ç”¨æœ¬åœ°è®¡ç®—
                        pillars_dict = {
                            'year': [sxtwl_pillars['year'][0], sxtwl_pillars['year'][1]],
                            'month': [sxtwl_pillars['month'][0], sxtwl_pillars['month'][1]],
                            'day': [sxtwl_pillars['day'][0], sxtwl_pillars['day'][1]],
                            'hour': [sxtwl_pillars['hour'][0], sxtwl_pillars['hour'][1]]
                        }
                        wuxing_dist = self.calculate_wuxing_distribution(pillars_dict)
                        sxtwl_result['wuxing_distribution'] = wuxing_dist
                except Exception as e:
                    print(f"âš ï¸ äº”è¡Œåˆ†å¸ƒè®¡ç®—å¤±è´¥: {e}")
                    # è®¾ç½®é»˜è®¤å€¼é¿å…æ˜¾ç¤ºé”™è¯¯
                    sxtwl_result['wuxing_distribution'] = {'æœ¨': 0, 'ç«': 0, 'åœŸ': 0, 'é‡‘': 0, 'æ°´': 0}

                self.current_sxtwl_result = sxtwl_result
                self.last_sxtwl_result = sxtwl_result  # å¤‡ä»½ä¿å­˜

                # ğŸ”§ æ–°å¢ï¼šä½¿ç”¨lunar-pythonè®¡ç®—å®Œæ•´çš„åŸºç¡€æ•°æ®
                try:
                    # è®¡ç®—åç¥å…³ç³»
                    tiangan_wuxing = self.get_tiangan_wuxing_info()
                    dizhi_info = self.get_dizhi_info()

                    # æå–å››æŸ±çš„å¤©å¹²åœ°æ”¯
                    pillars_dict = {
                        'year': [sxtwl_pillars['year'][0], sxtwl_pillars['year'][1]],
                        'month': [sxtwl_pillars['month'][0], sxtwl_pillars['month'][1]],
                        'day': [sxtwl_pillars['day'][0], sxtwl_pillars['day'][1]],
                        'hour': [sxtwl_pillars['hour'][0], sxtwl_pillars['hour'][1]]
                    }

                    # è®¡ç®—åç¥å…³ç³»
                    day_master = pillars_dict['day'][0]  # æ—¥ä¸»
                    ten_gods = {}
                    for position, (tg, dz) in pillars_dict.items():
                        if position != 'day':  # æ—¥ä¸»ä¸è®¡ç®—åç¥
                            ten_god = self.get_ten_god_relation(tg, day_master, tiangan_wuxing)
                            ten_gods[position] = {'ten_god': ten_god, 'tiangan': tg, 'dizhi': dz}

                    # è®¡ç®—äº”è¡Œåˆ†å¸ƒ
                    wuxing_distribution = self.calculate_wuxing_distribution(pillars_dict)

                    # æ·»åŠ åŸºç¡€æ•°æ®åˆ°sxtwl_info
                    # P0ä¿®å¤ï¼šè®¡ç®—æ­£ç¡®çš„åç¥åç§°ï¼Œä¸æ˜¯å¤©å¹²å­—ç¬¦
                    from classic_analyzer.core import BaziAnalysisCore
                    ten_god_calc = BaziAnalysisCore()
                    # P0ä¿®å¤ï¼šæ­£ç¡®è®¡ç®—åç¥åç§°ï¼ˆä¸æ˜¯å¤©å¹²å­—ç¬¦ï¼‰
                    from classic_analyzer.common import get_ten_god
                    try:
                        # ä¼˜å…ˆä»ten_godsè·å–ï¼Œå¦åˆ™ä»pillars_dictæå–ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„è¾…åŠ©å‡½æ•°ï¼‰
                        year_gan_from_dict, _ = self.extract_gan_zhi(pillars_dict.get('year', ''))
                        month_gan_from_dict, _ = self.extract_gan_zhi(pillars_dict.get('month', ''))
                        hour_gan_from_dict, _ = self.extract_gan_zhi(pillars_dict.get('hour', ''))

                        year_gan = ten_gods.get('year', {}).get('tiangan') or year_gan_from_dict
                        month_gan = ten_gods.get('month', {}).get('tiangan') or month_gan_from_dict
                        hour_gan = ten_gods.get('hour', {}).get('tiangan') or hour_gan_from_dict

                        # ğŸ”¥ ç¡®ä¿å¤©å¹²å­˜åœ¨
                        if year_gan and month_gan and hour_gan and day_master:
                            year_ten = get_ten_god(day_master, year_gan)
                            month_ten = get_ten_god(day_master, month_gan)
                            hour_ten = get_ten_god(day_master, hour_gan)
                        else:
                            # å¦‚æœå¤©å¹²è·å–å¤±è´¥ï¼Œä½¿ç”¨ten_godsä¸­çš„ten_god
                            year_ten = ten_gods.get('year', {}).get('ten_god', 'æœªçŸ¥')
                            month_ten = ten_gods.get('month', {}).get('ten_god', 'æœªçŸ¥')
                            hour_ten = ten_gods.get('hour', {}).get('ten_god', 'æœªçŸ¥')
                    except Exception as e:
                        print(f"âš ï¸ åç¥è®¡ç®—å¤±è´¥: {e}")
                        import traceback
                        traceback.print_exc()
                        # é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ten_godsä¸­çš„ten_god
                        year_ten = ten_gods.get('year', {}).get('ten_god', 'æœªçŸ¥')
                        month_ten = ten_gods.get('month', {}).get('ten_god', 'æœªçŸ¥')
                        hour_ten = ten_gods.get('hour', {}).get('ten_god', 'æœªçŸ¥')
                    sxtwl_info += f"åç¥ï¼šå¹´å¹²{year_ten} æœˆå¹²{month_ten} æ—¶å¹²{hour_ten}\n"

                    print("âœ“ lunar-pythonåŸºç¡€æ•°æ®è®¡ç®—å®Œæˆ")

                except Exception as e:
                    print(f"lunar-pythonåŸºç¡€æ•°æ®è®¡ç®—å¤±è´¥: {e}")
                    sxtwl_info += f"\nâš ï¸ åŸºç¡€æ•°æ®è®¡ç®—å¤±è´¥: {e}\n"

            except Exception as e:
                print(f"sxtwl è®¡ç®—å¤±è´¥: {e}")
                sxtwl_info = "\n\nã€æ³¨æ„ã€‘æœ¬åœ°å››æŸ±è®¡ç®—å¤±è´¥ï¼Œè¯·ä»¥ä¸‹æ–¹åˆ†æä¸ºå‡†ã€‚\n"
                self.current_sxtwl_result = None

        # ğŸ”§ ä¿®å¤ï¼šç¡®ä¿æ€»æ˜¯æœ‰å›ºå®šå››æŸ±ï¼Œé¿å…DEEPSEEKé‡æ–°è®¡ç®—
        pillar_instruction = ""

        if sxtwl_pillars:
            # ä½¿ç”¨sxtwlè®¡ç®—çš„ç²¾ç¡®å››æŸ±
            # ğŸ”¥ ä¿®å¤ï¼šæ­£ç¡®æ ¼å¼åŒ–pillarsæ˜¾ç¤º
            def format_pillar(p):
                if isinstance(p, list) and len(p) >= 2:
                    return f"{p[0]}{p[1]}"
                elif isinstance(p, str):
                    return p
                else:
                    return str(p)

            year_pillar_str = format_pillar(sxtwl_pillars['year'])
            month_pillar_str = format_pillar(sxtwl_pillars['month'])
            day_pillar_str = format_pillar(sxtwl_pillars['day'])
            hour_pillar_str = format_pillar(sxtwl_pillars['hour'])

            pillar_instruction = f"""

ã€é‡è¦ã€‘è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æœ¬åœ°ç²¾ç¡®è®¡ç®—çš„å››æŸ±è¿›è¡Œè§£è¯»åˆ†æï¼Œä¸è¦é‡æ–°è®¡ç®—å››æŸ±ï¼š
å¹´æŸ±ï¼š{year_pillar_str}  æœˆæŸ±ï¼š{month_pillar_str}  æ—¥æŸ±ï¼š{day_pillar_str}  æ—¶æŸ±ï¼š{hour_pillar_str}

è¯·ä»…åŸºäºä¸Šè¿°å››æŸ±è¿›è¡Œå‘½ç†è§£è¯»ï¼Œä¸è¦è‡ªè¡Œé‡ç®—æˆ–æ›´æ”¹å››æŸ±ã€‚"""
        else:
            # å›é€€ï¼šä½¿ç”¨lunar-pythonè®¡ç®—åŸºç¡€å››æŸ±
            try:
                from lunar_python import Lunar
                lunar_month = self._normalize_lunar_month(year, month, is_leap)
                lunar = Lunar.fromYmdHms(year, lunar_month, day, 1, 30, 0)

                # ç®€å•çš„å››æŸ±è®¡ç®—ï¼ˆä¸å¦‚sxtwlç²¾ç¡®ï¼Œä½†èƒ½æä¾›å›ºå®šåŸºå‡†ï¼‰
                year_gan_zhi = lunar.getYearInGanZhi()
                month_gan_zhi = lunar.getMonthInGanZhi()
                day_gan_zhi = lunar.getDayInGanZhi()
                hour_gan_zhi = lunar.getTimeInGanZhi()

                pillar_instruction = f"""

ã€é‡è¦ã€‘è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹å››æŸ±è¿›è¡Œè§£è¯»åˆ†æï¼Œä¸è¦é‡æ–°è®¡ç®—å››æŸ±ï¼š
å¹´æŸ±ï¼š{year_gan_zhi}  æœˆæŸ±ï¼š{month_gan_zhi}  æ—¥æŸ±ï¼š{day_gan_zhi}  æ—¶æŸ±ï¼š{hour_gan_zhi}
ï¼ˆæ³¨ï¼šä½¿ç”¨lunar-pythonåŸºç¡€è®¡ç®—ï¼Œå¦‚éœ€æ›´ç²¾ç¡®è¯·æ£€æŸ¥sxtwlæ¨¡å—ï¼‰

è¯·ä»…åŸºäºä¸Šè¿°å››æŸ±è¿›è¡Œå‘½ç†è§£è¯»ï¼Œä¸è¦è‡ªè¡Œé‡ç®—æˆ–æ›´æ”¹å››æŸ±ã€‚"""
                print(f"âœ“ ä½¿ç”¨lunar-pythonå›é€€å››æŸ±: {year_gan_zhi} {month_gan_zhi} {day_gan_zhi} {hour_gan_zhi}")
            except Exception as e:
                print(f"âœ— å›é€€å››æŸ±è®¡ç®—å¤±è´¥: {e}")
                pillar_instruction = """

ã€é‡è¦ã€‘è¯·åŸºäºä¼ ç»Ÿå‘½ç†ç†è®ºè¿›è¡Œåˆ†æï¼Œé‡ç‚¹å…³æ³¨äº”è¡Œå¹³è¡¡å’Œæ—ºè¡°å…³ç³»ï¼Œä¸è¦ç¼–é€ å…·ä½“çš„ç™¾åˆ†æ¯”æ•°å€¼ã€‚"""



        prompt = f"""è¯·æ ¹æ®ä»¥ä¸‹å››æŸ±ä¿¡æ¯è¿›è¡Œä¼ ç»Ÿå…«å­—å‘½ç†åˆ†æï¼š

æ€§åˆ«ï¼š{gender} å†œå†ï¼š{year}å¹´{chinese_month}{chinese_day}{shichen_text}{precise_time}{birth_location}ã€‚{sxtwl_info}{pillar_instruction}

ã€åŸºç¡€æ•°æ®ã€‘æˆ‘ä»¬å·²ç»è®¡ç®—äº†ä»¥ä¸‹åŸºç¡€æ•°æ®ï¼Œè¯·ç›´æ¥ä½¿ç”¨ï¼š
âœ… ç²¾ç¡®å››æŸ±ï¼šåŸºäºçœŸå¤ªé˜³æ—¶å’Œåœ°ç†ä½ç½®æ ¡æ­£
âœ… åç¥å…³ç³»ï¼šåŸºäºæ—¥å¹²çš„æ ‡å‡†åç¥å…³ç³»
âœ… äº”è¡Œåˆ†å¸ƒï¼šåŸºäºå¤©å¹²åœ°æ”¯çš„äº”è¡Œåˆ†å¸ƒ
âœ… åœ°æ”¯è—å¹²ï¼šåŸºäºä¼ ç»Ÿåœ°æ”¯è—å¹²é…ç½®

ã€åˆ†æè¦æ±‚ã€‘è¯·æä¾›è¯¦ç»†ã€ç²¾ç¡®ã€å…·ä½“çš„åˆ†æï¼Œå¿…é¡»åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¿›è¡Œè¯¦ç»†åˆ†æï¼š

ä¸€ã€åŸºç¡€ä¿¡æ¯ç¡®è®¤
- æ€§åˆ«ã€å‡ºç”Ÿæ—¶é—´ã€å‡ºç”Ÿåœ°ã€å…«å­—å››æŸ±
- æ—¥ä¸»å¼ºå¼±åˆ¤æ–­ï¼ˆå…·ä½“å¼ºå¼±ç¨‹åº¦ï¼Œå¦‚ï¼šåå¼ºã€ä¸­å’Œã€åå¼±ç­‰ï¼‰
- ç”¨ç¥å¿Œç¥æ˜ç¡®æŒ‡å‡º

äºŒã€åœ°æ”¯è—å¹²ä¸äº”è¡Œåˆ†æ
- è¯¦ç»†åˆ†æå„åœ°æ”¯çš„è—å¹²é…ç½®å’Œäº”è¡Œå±æ€§
- äº”è¡Œæ—ºè¡°å…·ä½“ç¨‹åº¦ï¼ˆå¦‚ï¼šæœ¨3åˆ†ã€ç«1åˆ†ã€åœŸ5åˆ†ç­‰ï¼‰
- äº”è¡Œç¼ºå¤±æˆ–è¿‡æ—ºçš„å…·ä½“å½±å“

ä¸‰ã€åç¥ä¸ç¥ç…è¯¦ç»†åˆ†æ
- åç¥é…ç½®çš„å…·ä½“å«ä¹‰å’Œå½±å“
- æ ¹æ®å®é™…å…«å­—æŸ¥æ‰¾å‘½ä¸­çš„ç¥ç…ï¼Œä¸è¦åˆ—ä¸¾ä¸å­˜åœ¨çš„ç¥ç…
- æ¯ä¸ªå®é™…å­˜åœ¨ç¥ç…çš„å…·ä½“ä½œç”¨æ—¶é—´å’Œå½±å“èŒƒå›´

å››ã€è´µäººåˆ†æï¼ˆé‡ç‚¹ï¼‰
- æ ¹æ®å®é™…å…«å­—æŸ¥æ‰¾å‘½ä¸­çš„è´µäººç¥ç…ï¼ˆå¦‚æœ‰å¤©ä¹™è´µäººã€æ–‡æ˜Œè´µäººç­‰æ‰åˆ†æï¼‰
- å®é™…å­˜åœ¨è´µäººçš„å‡ºç°æ—¶é—´æ®µå’Œå½±å“
- æ ¹æ®è´µäººç¥ç…æ¨ç®—çš„èŒä¸šç‰¹å¾
- åŸºäºå…«å­—é…ç½®çš„è´µäººæœºä¼šåˆ†æ

äº”ã€å‘½æ ¼ä¸æ ¼å±€åˆ†æ
- æ ¹æ®å®é™…å…«å­—åˆ¤æ–­çš„æ ¼å±€ç±»å‹ï¼ˆä¸è¦å¥—ç”¨å›ºå®šæ¨¡æ¿ï¼‰
- åŸºäºå…«å­—å¼ºå¼±å’Œé…ç½®çš„æ ¼å±€æˆè´¥åˆ†æ
- æ ¼å±€å¯¹æ­¤äººå…·ä½“äººç”Ÿçš„å½±å“

å…­ã€å…­äº²å©šå§»è¯¦ç»†åˆ†æ
- çˆ¶æ¯å…³ç³»è´¨é‡å’Œå…·ä½“å½±å“
- å…„å¼Ÿå§å¦¹æƒ…å†µå’Œå¸®åŠ©ç¨‹åº¦
- æ ¹æ®é…å¶æ˜Ÿåˆ†æé…å¶ç‰¹å¾å’Œå©šå§»è´¨é‡
- æ ¹æ®å­å¥³æ˜Ÿå’Œæ—¶æŸ±åˆ†æå­å¥³æƒ…å†µ

ä¸ƒã€äº‹ä¸šå‘å±•åˆ†æï¼ˆé‡ç‚¹ï¼‰
- é€‚åˆçš„å…·ä½“è¡Œä¸šå’ŒèŒä½ï¼ˆä¸è¦æ³›æ³›è€Œè°ˆï¼‰
- äº‹ä¸šå‘å±•çš„å…³é”®æ—¶é—´èŠ‚ç‚¹ï¼ˆå…·ä½“å¹´ä»½ï¼‰
- å‡èŒåŠ è–ªçš„æ—¶é—´é¢„æµ‹
- åˆ›ä¸šæˆåŠŸçš„å¯èƒ½æ€§å’Œæœ€ä½³æ—¶æœº
- èŒåœºè´µäººå’Œåˆä½œä¼™ä¼´ç‰¹å¾

å…«ã€è´¢è¿ä¸è´¢å¯Œç­‰çº§åˆ†æï¼ˆé‡ç‚¹ï¼‰
- è´¢è¿å¼ºå¼±çš„å…·ä½“ç­‰çº§ï¼ˆæ ¹æ®è´¢æ˜Ÿé…ç½®å’Œå¤§è¿åˆ†æï¼‰
- å‘è´¢çš„å…·ä½“æ—¶é—´æ®µï¼ˆæ ¹æ®å¤§è¿æ¨ç®—ï¼Œå¦‚ï¼šæŸæŸå¤§è¿æœŸé—´ï¼‰
- èƒ½è¾¾åˆ°çš„å…·ä½“è´¢å¯Œæ°´å¹³ï¼ˆæ ¹æ®è´¢æ˜Ÿå¼ºå¼±å’Œå¤§è¿æ¨ç®—ï¼‰
- ä¸»è¦è´¢å¯Œæ¥æºï¼ˆæ ¹æ®è´¢æ˜Ÿé…ç½®å’Œåç¥ç»„åˆæ¨ç®—ï¼‰
- ç ´è´¢é£é™©çš„å…·ä½“å¹´ä»½å’ŒåŸå› 
- æŠ•èµ„ç†è´¢çš„å…·ä½“å»ºè®®å’Œç¦å¿Œ

ä¹ã€å¥åº·é£é™©ä¸è°ƒç†ï¼ˆé‡ç‚¹ï¼‰
- æ ¹æ®äº”è¡Œå¼ºå¼±åˆ†æå®¹æ˜“å‡ºç°çš„å¥åº·é—®é¢˜
- ç–¾ç—…é«˜å‘çš„å¹´é¾„æ®µå’Œæ—¶é—´
- èº«ä½“å„ç³»ç»Ÿçš„å¥åº·çŠ¶å†µè¯„ä¼°
- æ ¹æ®ç”¨ç¥å¿Œç¥æ¨ç®—çš„å…»ç”Ÿè°ƒç†æ–¹æ³•
- éœ€è¦ç‰¹åˆ«æ³¨æ„çš„å¥åº·é£é™©æœŸ

åã€å¤§è¿æµå¹´ç²¾ç¡®åˆ†æï¼ˆé‡ç‚¹ï¼‰
- æ¯æ­¥å¤§è¿çš„èµ·æ­¢å¹´ä»½å’Œå…·ä½“å½±å“
- æœªæ¥10å¹´æ¯å¹´çš„è¿åŠ¿å˜åŒ–
- å…³é”®è½¬æŠ˜å¹´ä»½çš„è¯¦ç»†åˆ†æ
- å¤§è¿ä¸æµå¹´çš„ç›¸äº’ä½œç”¨
- æ¯ä¸ªé˜¶æ®µçš„å…·ä½“å»ºè®®å’Œæ³¨æ„äº‹é¡¹

åä¸€ã€é‡è¦æ³¨æ„äº‹é¡¹
- äººç”Ÿä¸­çš„é‡å¤§é£é™©ç‚¹å’Œæ—¶é—´
- éœ€è¦ç‰¹åˆ«è°¨æ…çš„å¹´ä»½å’Œäº‹é¡¹
- å¯èƒ½çš„æ„å¤–å’Œç¾ç¥¸é¢„è­¦
- åŒ–è§£æ–¹æ³•å’Œé¢„é˜²æªæ–½

åäºŒã€å®ç”¨å»ºè®®ä¸æŒ‡å¯¼
- åŸºäºæ­¤äººå…«å­—ç‰¹ç‚¹çš„ä¸ªæ€§åŒ–ç”Ÿæ´»å»ºè®®
- æ ¹æ®ç”¨ç¥å¿Œç¥æ¨ç®—çš„æœ‰åˆ©æ–¹ä½ã€é¢œè‰²ã€æ•°å­—
- æœ€ä½³çš„å†³ç­–æ—¶æœºå’Œè¡ŒåŠ¨æ—¶é—´
- äººé™…å…³ç³»çš„å¤„ç†å»ºè®®
- æ ¹æ®å…«å­—äº”è¡Œé…ç½®çš„å®¶å±…é£æ°´è°ƒæ•´å»ºè®®

ä¹ã€å‘½ç†æ€»ç»“ä¸äººç”Ÿå»ºè®®
- å‘½ç†ç‰¹ç‚¹æ€»ç»“
- äººç”Ÿå‘å±•å»ºè®®
- é‡è¦æ—¶é—´èŠ‚ç‚¹æé†’

ã€åˆ†æè¦æ±‚ã€‘å¿…é¡»åšåˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š
1) æ‰€æœ‰åˆ†æå¿…é¡»åŸºäºä¼ ç»Ÿå‘½ç†å­¦ç†è®ºï¼Œå¼•ç”¨å…·ä½“ç»å…¸ï¼ˆå¦‚ã€Šæ¸Šæµ·å­å¹³ã€‹ã€Šä¸‰å‘½é€šä¼šã€‹ç­‰ï¼‰
2) å¿…é¡»ç»™å‡ºå…·ä½“çš„æ—¶é—´ç‚¹ï¼š
   - å¤§è¿çš„èµ·æ­¢å¹´ä»½ï¼ˆå¦‚ï¼šXX-XXå²èµ°æŸæŸå¤§è¿ï¼Œæˆ–æ ¹æ®å‡ºç”Ÿå¹´æ¨ç®—çš„å…·ä½“å¤§è¿å‘¨æœŸï¼‰
   - å…³é”®å¹´ä»½çš„å…·ä½“é¢„æµ‹ï¼ˆåŸºäºå¤§è¿æµå¹´æ¨ç®—ï¼Œå¦‚ï¼šæŸæŸå¤§è¿çš„ç¬¬Xå¹´ç­‰ï¼‰
   - æœˆä»½çº§åˆ«çš„é‡è¦æ—¶æœºï¼ˆå¦‚ï¼šå†œå†ä¸‰æœˆã€å…«æœˆç­‰ï¼‰
3) å¿…é¡»ç»™å‡ºå…·ä½“çš„æ•°å€¼å’Œç­‰çº§ï¼š
   - è´¢å¯Œç­‰çº§ï¼ˆæ ¹æ®è´¢æ˜Ÿå¼ºå¼±å’Œå¤§è¿æ¨ç®—å®é™…ç­‰çº§ï¼‰
   - å¥åº·é£é™©ç­‰çº§ï¼ˆæ ¹æ®äº”è¡Œé…ç½®å’Œèº«ä½“çŠ¶å†µæ¨ç®—ï¼‰
   - äº‹ä¸šæˆå°±ç­‰çº§ï¼ˆæ ¹æ®å®˜æ˜Ÿé…ç½®å’Œæ ¼å±€é«˜ä½æ¨ç®—ï¼‰
4) å¿…é¡»æä¾›å¯æ“ä½œçš„å…·ä½“å»ºè®®ï¼š
   - å…·ä½“çš„è¡Œä¸šå’ŒèŒä½æ¨è
   - å…·ä½“çš„æŠ•èµ„ç†è´¢å»ºè®®
   - å…·ä½“çš„å¥åº·è°ƒç†æ–¹æ³•
   - å…·ä½“çš„é£æ°´å¸ƒå±€å»ºè®®
5) æ—¶é—´é¢„æµ‹è¦ç²¾ç¡®ï¼š
   - å©šå§»æ—¶é—´ï¼šæ ¹æ®å¤§è¿æµå¹´æ¨ç®—ï¼ˆå¦‚ï¼šæŸæŸå¤§è¿æœŸé—´ï¼Œæˆ–XX-XXå²ä¹‹é—´ï¼‰
   - å‘è´¢æ—¶æœºï¼šæ ¹æ®è´¢æ˜Ÿå¤§è¿æ¨ç®—ï¼ˆå¦‚ï¼šæŸæŸå¤§è¿æœŸé—´è´¢è¿æœ€ä½³ï¼‰
   - å¥åº·é£é™©æœŸï¼šæ ¹æ®å¤§è¿æ¨ç®—ï¼ˆå¦‚ï¼šæŸæŸå¤§è¿æœŸé—´éœ€ç‰¹åˆ«æ³¨æ„ï¼‰
   - äº‹ä¸šé«˜å³°æœŸï¼šæ ¹æ®å®˜æ˜Ÿå¤§è¿æ¨ç®—ï¼ˆå¦‚ï¼šæŸæŸå¤§è¿ä¸ºäº‹ä¸šé»„é‡‘æœŸï¼‰
6) å¿…é¡»åˆ†æå¤§è¿æµå¹´çš„å…·ä½“å½±å“ï¼š
   - å½“å‰å¤§è¿çš„å…·ä½“å½±å“å’Œå»ºè®®
   - ä¸‹ä¸€æ­¥å¤§è¿çš„å˜åŒ–å’Œå‡†å¤‡
   - æœªæ¥10å¹´æ¯å¹´çš„é‡ç‚¹å…³æ³¨äº‹é¡¹
7) å¿…é¡»æä¾›é£é™©é¢„è­¦ï¼š
   - å…·ä½“çš„ç ´è´¢å¹´ä»½å’ŒåŸå› 
   - å¥åº·å±æœºçš„æ—¶é—´å’Œé¢„é˜²
   - æ„Ÿæƒ…å±æœºçš„å¯èƒ½æ—¶æœŸ
   - äº‹ä¸šä½è°·çš„åº”å¯¹ç­–ç•¥

ã€è¾“å‡ºæ ‡å‡†ã€‘
- æ¯ä¸ªåˆ†æç‚¹éƒ½è¦æœ‰å…·ä½“çš„æ—¶é—´ã€æ•°å€¼ã€ç­‰çº§
- é¿å…æ¨¡ç³Šè¡¨è¿°ï¼Œè¦ç»™å‡ºæ˜ç¡®çš„åˆ¤æ–­
- æä¾›çš„å»ºè®®è¦å…·ä½“å¯è¡Œï¼Œä¸è¦ç©ºæ³›çš„å»ºè®®
- é‡ç‚¹çªå‡ºå…³é”®ä¿¡æ¯ï¼Œç”¨â˜…æ ‡è®°é‡è¦å†…å®¹
"""

        # æ£€æŸ¥OpenAI SDK æ˜¯å¦å¯ç”¨
        try:
            from openai import OpenAI
        except ImportError:
            raise RuntimeError("æœªå®‰è£… openai åº“ï¼Œè¯·å…ˆæ‰§è¡Œ: pip install openai")

        # DeepSeek APIé…ç½® - éœ€è¦ç”¨æˆ·æä¾›APIå¯†é’¥
        api_key = self.get_deepseek_api_key()
        if not api_key:
            raise ValueError("æœªé…ç½®DeepSeek APIå¯†é’¥")

        # ğŸ”¥ æ–°å¢ï¼šå¤šAIååŒåˆ†æ
        ai_configs = self.get_ai_configs()
        ai_results = {}

        # 1. DeepSeek (ä¸»åŠ›AI)
        print(f"ğŸš€ å¼€å§‹è°ƒç”¨DeepSeek API...")
        print(f"ğŸ“ ç³»ç»Ÿæç¤ºè¯é•¿åº¦: {len(sys_prompt)}")
        print(f"ğŸ“ ç”¨æˆ·æç¤ºè¯é•¿åº¦: {len(prompt)}")

        try:
            print(f"ğŸ”§ åˆ›å»ºDeepSeekå®¢æˆ·ç«¯...")

            # ğŸ”¥ ç´§æ€¥ä¿®å¤ï¼šä½¿ç”¨requestsè€Œä¸æ˜¯OpenAIå®¢æˆ·ç«¯ï¼Œé¿å…å¡æ­»
            headers = {
                'Authorization': f'Bearer {api_key}',
                'Content-Type': 'application/json'
            }

            data = {
                "model": "deepseek-chat",
                "messages": [
                    {"role": "system", "content": sys_prompt},
                    {"role": "user", "content": prompt}
                ],
                "temperature": 0.01,
                "max_tokens": 8000,
                "stream": False
            }

            print(f"ğŸ“¡ å‘é€è¯·æ±‚åˆ°DeepSeek...")
            import time
            start_time = time.time()

            # ç¦ç”¨ä»£ç†é¿å…è¿æ¥é—®é¢˜
            proxies = {'http': None, 'https': None}
            response = requests.post(
                'https://api.deepseek.com/chat/completions',
                headers=headers,
                json=data,
                timeout=120,  # æ¢å¤åŸå§‹è¶…æ—¶æ—¶é—´
                proxies=proxies
            )

            if response.status_code == 200:
                result = response.json()
                content = result['choices'][0]['message']['content']
            else:
                raise Exception(f"DeepSeek APIè¿”å›é”™è¯¯: {response.status_code} - {response.text}")

            end_time = time.time()
            print(f"âœ… DeepSeek APIè°ƒç”¨æˆåŠŸï¼Œè€—æ—¶: {end_time - start_time:.2f}ç§’")
            print(f"ğŸ“ DeepSeekå“åº”é•¿åº¦: {len(content)}")

            ai_results['deepseek'] = {
                'content': content,
                'weight': ai_configs.get('deepseek', {}).get('weight', 0.6),
                'status': 'success'
            }

        except Exception as e:
            print(f"âŒ DeepSeek APIè°ƒç”¨å¤±è´¥: {str(e)}")
            ai_results['deepseek'] = {'content': '', 'weight': 0, 'status': 'failed'}

        # 2. åƒå¸†æ–‡å¿ƒä¸€è¨€ (ä¼ ç»Ÿæ–‡åŒ–ä¸“å®¶)
        wenxin_config = ai_configs.get('wenxin', {})
        print(f"ğŸ” æ–‡å¿ƒä¸€è¨€é…ç½®: enabled={wenxin_config.get('enabled', False)}")
        if wenxin_config.get('enabled', False):
            try:
                print("ğŸš€ å¼€å§‹è°ƒç”¨æ–‡å¿ƒä¸€è¨€API...")
                # ğŸ”¥ æ–‡å¿ƒä¸€è¨€ä½¿ç”¨ä¸DeepSeekå®Œå…¨ç›¸åŒçš„æç¤ºè¯
                wenxin_prompt = prompt  # ä½¿ç”¨ä¸DeepSeekå®Œå…¨ç›¸åŒçš„æé—®å†…å®¹

                import time
                wenxin_start_time = time.time()
                wenxin_result = self.call_wenxin_api(wenxin_prompt, wenxin_config, sys_prompt)
                wenxin_end_time = time.time()
                wenxin_duration = wenxin_end_time - wenxin_start_time
                print(f"âœ… æ–‡å¿ƒä¸€è¨€APIè°ƒç”¨æˆåŠŸï¼Œè€—æ—¶: {wenxin_duration:.2f}ç§’ï¼Œç»“æœé•¿åº¦: {len(wenxin_result) if wenxin_result else 0}")
                ai_results['wenxin'] = {
                    'content': wenxin_result,
                    'weight': wenxin_config.get('weight', 0.35),
                    'status': 'success'
                }


            except Exception as e:
                error_msg = f"æ–‡å¿ƒä¸€è¨€APIè°ƒç”¨å¤±è´¥: {str(e)}"
                print(f"âŒ {error_msg}")
                ai_results['wenxin'] = {
                    'content': f"âŒ æ–‡å¿ƒä¸€è¨€åˆ†æå¤±è´¥\né”™è¯¯ä¿¡æ¯ï¼š{str(e)}\n\nè¯·æ£€æŸ¥APIé…ç½®æˆ–ç½‘ç»œè¿æ¥ã€‚",
                    'weight': 0,
                    'status': 'failed_but_show'  # æ–°çŠ¶æ€ï¼šå¤±è´¥ä½†è¦æ˜¾ç¤º
                }
        else:
            print("âš ï¸ æ–‡å¿ƒä¸€è¨€æœªå¯ç”¨")
            ai_results['wenxin'] = {
                'content': "âš ï¸ æ–‡å¿ƒä¸€è¨€æœªå¯ç”¨\n\nå¦‚éœ€å¯ç”¨ï¼Œè¯·åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® enabled: true",
                'weight': 0,
                'status': 'disabled_but_show'
            }

        # 3. é€šä¹‰åƒé—® (é€»è¾‘æ¨ç†ä¸“å®¶)
        tongyi_config = ai_configs.get('tongyi', {})
        print(f"ğŸ” é€šä¹‰åƒé—®é…ç½®: enabled={tongyi_config.get('enabled', False)}")
        if tongyi_config.get('enabled', False):
            try:
                print("ğŸš€ å¼€å§‹è°ƒç”¨é€šä¹‰åƒé—®API...")
                # ğŸ”¥ é€šä¹‰åƒé—®ä½¿ç”¨ä¸DeepSeekå®Œå…¨ç›¸åŒçš„æç¤ºè¯
                tongyi_prompt = prompt  # ä½¿ç”¨ä¸DeepSeekå®Œå…¨ç›¸åŒçš„æé—®å†…å®¹

                import time
                tongyi_start_time = time.time()
                tongyi_result = self.call_tongyi_api(tongyi_prompt, tongyi_config, sys_prompt)
                tongyi_end_time = time.time()
                tongyi_duration = tongyi_end_time - tongyi_start_time
                print(f"âœ… é€šä¹‰åƒé—®APIè°ƒç”¨æˆåŠŸï¼Œè€—æ—¶: {tongyi_duration:.2f}ç§’ï¼Œç»“æœé•¿åº¦: {len(tongyi_result) if tongyi_result else 0}")
                ai_results['tongyi'] = {
                    'content': tongyi_result,
                    'weight': tongyi_config.get('weight', 0.25),
                    'status': 'success'
                }


            except Exception as e:
                error_msg = f"é€šä¹‰åƒé—®APIè°ƒç”¨å¤±è´¥: {str(e)}"
                print(f"âŒ {error_msg}")

                # ğŸ”¥ åŒºåˆ†è¶…æ—¶å’Œå…¶ä»–é”™è¯¯
                if "è¶…æ—¶" in str(e) or "timeout" in str(e).lower():
                    ai_results['tongyi'] = {
                        'content': f"â° é€šä¹‰åƒé—®å“åº”è¶…æ—¶ï¼ˆ200ç§’ï¼‰ï¼Œå·²è‡ªåŠ¨è·³è¿‡",
                        'weight': 0,
                        'status': 'timeout_skipped'  # è¶…æ—¶è·³è¿‡çŠ¶æ€
                    }
                else:
                    ai_results['tongyi'] = {
                        'content': f"âŒ é€šä¹‰åƒé—®åˆ†æå¤±è´¥\né”™è¯¯ä¿¡æ¯ï¼š{str(e)}\n\nè¯·æ£€æŸ¥APIé…ç½®æˆ–ç½‘ç»œè¿æ¥ã€‚",
                        'weight': 0,
                        'status': 'failed_but_show'  # æ–°çŠ¶æ€ï¼šå¤±è´¥ä½†è¦æ˜¾ç¤º
                    }
        else:
            print("âš ï¸ é€šä¹‰åƒé—®æœªå¯ç”¨")
            ai_results['tongyi'] = {
                'content': "âš ï¸ é€šä¹‰åƒé—®æœªå¯ç”¨\n\nå¦‚éœ€å¯ç”¨ï¼Œè¯·åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® enabled: true",
                'weight': 0,
                'status': 'disabled_but_show'
            }

        # ğŸ”¥ ä½¿ç”¨æ–°çš„ä¸‰AIç›¸äº’éªŒè¯èåˆå™¨
        successful_results = {k: v for k, v in ai_results.items() if v['status'] == 'success' and v['content']}
        content = self.create_clean_fusion_report(successful_results)
        # è®°å½•åˆ†æç»“æœ
        try:
            self.last_prompt_text = prompt
            self.last_response_full = content
        except Exception:
            pass


        # ä»ä¿å­˜çš„sxtwlç»“æœä¸­æå–å®é™…æ•°æ®
        actual_pillars = {'year': ['?', '?'], 'month': ['?', '?'], 'day': ['?', '?'], 'hour': ['?', '?']}
        actual_day_master = '?'
        actual_day_master_element = '?'
        actual_wuxing_distribution = {'æœ¨': 0, 'ç«': 0, 'åœŸ': 0, 'é‡‘': 0, 'æ°´': 0}

        if hasattr(self, 'current_sxtwl_result') and self.current_sxtwl_result:
            sxtwl_result = self.current_sxtwl_result
            if sxtwl_result.get('pillars'):
                sxtwl_pillars = sxtwl_result['pillars']
                actual_pillars = {
                    'year': [sxtwl_pillars['year'][0], sxtwl_pillars['year'][1]],
                    'month': [sxtwl_pillars['month'][0], sxtwl_pillars['month'][1]],
                    'day': [sxtwl_pillars['day'][0], sxtwl_pillars['day'][1]],
                    'hour': [sxtwl_pillars['hour'][0], sxtwl_pillars['hour'][1]]
                }
                actual_day_master = sxtwl_pillars['day'][0]
                # è·å–æ—¥ä¸»äº”è¡Œ
                tiangan_wuxing = self.get_tiangan_wuxing_info()
                if actual_day_master in tiangan_wuxing:
                    actual_day_master_element = tiangan_wuxing[actual_day_master]['element']
                # è®¡ç®—äº”è¡Œåˆ†å¸ƒ
                try:
                    actual_wuxing_distribution = self.calculate_wuxing_distribution(actual_pillars)
                except:
                    pass

        # ç›´æ¥è¿”å›DeepSeekçš„å®Œæ•´å†…å®¹ï¼Œä¸åšä»»ä½•è¿‡æ»¤
        result = {
            'raw_analysis': content,  # åŸå§‹å†…å®¹
            'comprehensive_analysis': content,  # å®Œæ•´å†…å®¹ï¼ˆä¸è¿‡æ»¤ï¼‰
            'pillars': actual_pillars,
            'day_master': actual_day_master,
            'day_master_element': actual_day_master_element,
            'bazi_pattern': {'pattern_type': 'å¾…åˆ†æ'},
            'ten_gods': {},
            'wuxing_distribution': actual_wuxing_distribution,
            'birth_info': getattr(self, 'last_birth_info', {}).copy() if isinstance(getattr(self, 'last_birth_info', {}), dict) else {}
        }
        return result

    def clean_deepseek_result(self, raw_analysis):
        """æ¸…ç† DeepSeek è¿”å›çš„ç»“æœï¼Œåˆ é™¤ä¸éœ€è¦çš„å†…å®¹"""
        if not raw_analysis:
            return raw_analysis

        # åˆ é™¤åˆ†ææ ‡è¯†å’Œå¼•ç”¨æ ‡æ³¨
        lines = raw_analysis.split('\n')
        cleaned_lines = []

        for line in lines:
            # è·³è¿‡åˆ†ææ ‡è¯†è¡Œ
            if 'ã€åˆ†ææ ‡è¯†ã€‘' in line and 'ç¡®è®¤æ”¶åˆ°' in line:
                continue
            # è·³è¿‡å¼•ç”¨æ ‡æ³¨è¡Œ
            if line.strip().startswith('ï¼ˆä¸¥æ ¼éµå¾ªã€Š') and line.strip().endswith('ã€‹ï¼‰'):
                continue
            if line.strip().startswith('ï¼ˆã€Š') and 'ã€‹' in line and line.strip().endswith('ï¼‰'):
                continue
            # è·³è¿‡å•ç‹¬çš„ä¹¦åå¼•ç”¨è¡Œ
            if line.strip() in ['ã€Šæ¸Šæµ·å­å¹³ã€‹ç¥ç…ç« ï¼‰', 'ï¼ˆã€Šå­å¹³çœŸè¯ ã€‹æ ¼å±€ç¯‡ï¼‰', 'ã€Šä¸‰å‘½é€šä¼šÂ·è—å¹²ç¯‡ã€‹æƒé‡æ³•åˆ™ï¼‰']:
                continue
            # è·³è¿‡å…«å­—å‘½ç†ç»ˆæå¤æ ¸æ ‡é¢˜è¡Œ
            if 'å…«å­—å‘½ç†ç»ˆæå¤æ ¸' in line and 'ä¸¥æ ¼éµå¾ª' in line:
                continue
            # è·³è¿‡å•ç‹¬çš„ç»å…¸ä¹¦åè¡Œ
            if line.strip().startswith('ã€Š') and line.strip().endswith('ã€‹') and len(line.strip()) < 20:
                continue
            # è·³è¿‡ç»“å°¾çš„æ³¨é‡Šè¡Œ
            if line.strip().startswith('**æ³¨**ï¼š') and 'ä¸¥æ ¼åŸºäºæä¾›å››æŸ±' in line:
                continue
            if 'ä»¥ä¸Šåˆ†æä¸¥æ ¼åŸºäºæä¾›å››æŸ±' in line and 'æœªé‡æ–°è®¡ç®—åŸºç¡€æ•°æ®' in line:
                continue

            cleaned_lines.append(line)

        # åˆ é™¤å¼€å¤´å’Œç»“å°¾çš„ç©ºè¡Œ
        while cleaned_lines and not cleaned_lines[0].strip():
            cleaned_lines.pop(0)
        while cleaned_lines and not cleaned_lines[-1].strip():
            cleaned_lines.pop()

        return '\n'.join(cleaned_lines)

    def create_popular_explanation(self, deepseek_analysis, name, gender):
        """åˆ›å»ºé€šä¿—æ˜“æ‡‚çš„è§£é‡Š"""
        if not deepseek_analysis:
            return ""

        # æ„å»ºé€šä¿—è§£é‡Šçš„æç¤ºè¯
        explanation_prompt = f"""è¯·å°†ä»¥ä¸‹å…«å­—å‘½ç†åˆ†æè½¬æ¢ä¸ºè¯¦ç»†çš„é€šä¿—æ˜“æ‡‚çš„ç™½è¯è§£é‡Šï¼Œè®©æ™®é€šäººä¹Ÿèƒ½ç†è§£ï¼š

åˆ†æå¯¹è±¡ï¼š{name}ï¼ˆ{gender}ï¼‰
åŸå§‹åˆ†æå†…å®¹ï¼š
{deepseek_analysis}

è¯·é€ä¸€è§£é‡Šä¸Šè¿°åˆ†æä¸­çš„æ¯ä¸€ä¸ªéƒ¨åˆ†ï¼Œä¸è¦é—æ¼ä»»ä½•å†…å®¹ï¼ŒåŒ…æ‹¬ï¼š

ä¸€ã€åŸºæœ¬ä¿¡æ¯è§£é‡Š
ç”¨ç™½è¯è§£é‡ŠåŸºæœ¬ä¿¡æ¯çš„å«ä¹‰

äºŒã€åœ°æ”¯è—å¹²è§£é‡Š
ç”¨ç™½è¯è§£é‡Šåœ°æ”¯è—å¹²æ˜¯ä»€ä¹ˆæ„æ€ï¼Œå¯¹è¿™ä¸ªäººæœ‰ä»€ä¹ˆå½±å“

ä¸‰ã€åç¥ä¸ç¥ç…è§£é‡Š
ç”¨ç™½è¯è§£é‡Šåç¥ï¼ˆå¦‚æ­£å°ã€ä¼¤å®˜ç­‰ï¼‰æ˜¯ä»€ä¹ˆæ„æ€ï¼Œç¥ç…æœ‰ä»€ä¹ˆä½œç”¨

å››ã€å‘½æ ¼è§£é‡Š
ç”¨ç™½è¯è§£é‡Šå‘½æ ¼ç±»å‹ï¼Œç”¨ç¥æ˜¯ä»€ä¹ˆæ„æ€ï¼Œå¯¹äººç”Ÿæœ‰ä»€ä¹ˆå½±å“

äº”ã€å…­äº²å…³ç³»è§£é‡Š
ç”¨ç™½è¯è§£é‡Šçˆ¶æ¯ã€å…„å¼Ÿå§å¦¹ã€é…å¶ã€å­å¥³çš„å…³ç³»å’Œæƒ…å†µ

å…­ã€äº‹ä¸šè´¢è¿è§£é‡Š
ç”¨ç™½è¯è§£é‡Šäº‹ä¸šå’Œè´¢è¿çš„å…·ä½“æƒ…å†µï¼ŒåŒ…æ‹¬é€‚åˆçš„å·¥ä½œå’Œè´¢è¿æ—¶æœŸ

ä¸ƒã€å¥åº·çŠ¶å†µè§£é‡Š
ç”¨ç™½è¯è§£é‡Šå¥åº·æ–¹é¢éœ€è¦æ³¨æ„ä»€ä¹ˆï¼Œå®¹æ˜“å¾—ä»€ä¹ˆç—…ï¼Œæ€ä¹ˆé¢„é˜²

å…«ã€å¤§è¿æµå¹´è§£é‡Š
ç”¨ç™½è¯è§£é‡Šå¤§è¿å’Œæµå¹´æ˜¯ä»€ä¹ˆæ„æ€ï¼Œå¯¹äººç”Ÿæœ‰ä»€ä¹ˆå½±å“

ä¹ã€äº”è¡Œè¡¥æ•‘è§£é‡Š
å¦‚æœæœ‰äº”è¡Œç¼ºå¤±æˆ–è¿‡æ—ºï¼Œç”¨ç™½è¯è§£é‡Šæ€ä¹ˆè¡¥æ•‘ï¼ˆé¢œè‰²ã€æ–¹ä½ã€é¥®é£Ÿç­‰ï¼‰

åã€å…·ä½“å»ºè®®
æ ¹æ®ä¸Šè¿°æ‰€æœ‰åˆ†æï¼Œç»™å‡ºå…·ä½“çš„äººç”Ÿå»ºè®®å’Œæ³¨æ„äº‹é¡¹

ã€é‡è¦è¦æ±‚ã€‘
1) å¿…é¡»è§£é‡ŠåŸå§‹åˆ†æä¸­æåˆ°çš„æ¯ä¸€ä¸ªå†…å®¹ï¼Œä¸èƒ½é—æ¼
2) ç‰¹åˆ«è¦è§£é‡Šçˆ¶æ¯ã€é…å¶ã€å­å¥³ç­‰å…­äº²å…³ç³»
3) å¦‚æœæåˆ°äº”è¡Œç¼ºå¤±æˆ–è¿‡æ—ºï¼Œå¿…é¡»è¯¦ç»†è§£é‡Šå½±å“å’Œè¡¥æ•‘æ–¹æ³•
4) å¦‚æœæåˆ°å¤§è¿ã€æµå¹´ï¼Œå¿…é¡»è§£é‡Šå…·ä½“çš„æ—¶é—´å’Œå½±å“
5) ä½¿ç”¨é€šä¿—æ˜“æ‡‚çš„ç™½è¯ï¼ŒæŠŠä¸“ä¸šæœ¯è¯­éƒ½ç¿»è¯‘æˆæ™®é€šè¯
6) ç»™å‡ºå…·ä½“å¯æ“ä½œçš„å»ºè®®ï¼Œä¸è¦ç©ºæ³›çš„è¯
7) è¯­è¨€è¦äº²åˆ‡è‡ªç„¶ï¼Œåƒæœ‹å‹åœ¨è§£é‡Šä¸€æ ·
8) å†…å®¹è¦å…¨é¢è¯¦ç»†ï¼Œä¸è¦ç®€ç•¥å¸¦è¿‡ä»»ä½•éƒ¨åˆ†
"""

        return explanation_prompt

    def get_popular_explanation(self, deepseek_analysis, name, gender):
        """è·å–é€šä¿—æ˜“æ‡‚çš„è§£é‡Š - å®Œå…¨ä¾èµ–AIç”Ÿæˆï¼Œç¡®ä¿å®Œæ•´å¯ä¿¡"""
        try:
            # åˆ›å»ºè§£é‡Šæç¤ºè¯
            explanation_prompt = self.create_popular_explanation(deepseek_analysis, name, gender)

            # è°ƒç”¨ DeepSeek API è·å–é€šä¿—è§£é‡Š
            from openai import OpenAI

            # è·å– API å¯†é’¥
            api_key = self.get_deepseek_api_key()
            if not api_key:
                return "é€šä¿—è§£é‡Šç”Ÿæˆå¤±è´¥ï¼šæœªé…ç½®APIå¯†é’¥"

            # ä¼˜åŒ–çš„ç³»ç»Ÿæç¤ºï¼Œç¡®ä¿ç”Ÿæˆå®Œæ•´å¯ä¿¡çš„è§£é‡Š
            sys_prompt = """ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„å‘½ç†ä¸“å®¶ï¼Œæ“…é•¿ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è§£é‡Šå…«å­—å‘½ç†ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ç”¨æˆ·è¦æ±‚ï¼Œå°†ä¸“ä¸šçš„å…«å­—åˆ†æè½¬æ¢ä¸ºè¯¦ç»†ã€å®Œæ•´ã€å‡†ç¡®çš„ç™½è¯è§£é‡Šã€‚

è¦æ±‚ï¼š
1. å¿…é¡»é€ä¸€è§£é‡ŠåŸå§‹åˆ†æä¸­çš„æ¯ä¸ªéƒ¨åˆ†ï¼Œä¸èƒ½é—æ¼ä»»ä½•å†…å®¹
2. ä½¿ç”¨é€šä¿—æ˜“æ‡‚çš„ç™½è¯ï¼Œé¿å…ä¸“ä¸šæœ¯è¯­
3. ç»™å‡ºå…·ä½“å¯æ“ä½œçš„å»ºè®®ï¼Œä¸è¦ç©ºæ³›çš„è¯
4. å†…å®¹è¦å…¨é¢è¯¦ç»†ï¼Œç¡®ä¿è§£é‡Šçš„å®Œæ•´æ€§
5. è¯­è¨€è¦äº²åˆ‡è‡ªç„¶ï¼Œåƒæœ‹å‹åœ¨è§£é‡Šä¸€æ ·
6. ç¡®ä¿æ‰€æœ‰å»ºè®®éƒ½åŸºäºåŸå§‹åˆ†æå†…å®¹ï¼Œä¸è¦æ·»åŠ æ— å…³ä¿¡æ¯"""

            print(f"ğŸš€ å¼€å§‹è°ƒç”¨DeepSeekç”Ÿæˆå®Œæ•´é€šä¿—è§£é‡Š...")

            # ğŸ”¥ ä¿®å¤ï¼šæ”¹ç”¨requestsæ–¹å¼ï¼Œä¸ä¸»åˆ†æä¿æŒä¸€è‡´ï¼Œé¿å…ç½‘ç»œé—®é¢˜
            import requests
            import time

            headers = {
                'Authorization': f'Bearer {api_key}',
                'Content-Type': 'application/json'
            }

            data = {
                "model": "deepseek-chat",
                "messages": [
                    {"role": "system", "content": sys_prompt},
                    {"role": "user", "content": explanation_prompt}
                ],
                "temperature": 0.2,
                "max_tokens": 8000,
                "top_p": 0.9,
                "stream": False
            }

            start_time = time.time()

            # ç¦ç”¨ä»£ç†é¿å…è¿æ¥é—®é¢˜ï¼Œä¸ä¸»åˆ†æä¿æŒä¸€è‡´
            proxies = {'http': None, 'https': None}
            response = requests.post(
                'https://api.deepseek.com/chat/completions',
                headers=headers,
                json=data,
                timeout=360,  # ä¿æŒåŸå§‹è¶…æ—¶æ—¶é—´
                proxies=proxies
            )

            end_time = time.time()
            print(f"âœ… é€šä¿—è§£é‡ŠAPIè°ƒç”¨æˆåŠŸï¼Œè€—æ—¶: {end_time - start_time:.2f}ç§’")

            if response.status_code == 200:
                result = response.json()
                explanation_text = result['choices'][0]['message']['content']
            else:
                raise Exception(f"DeepSeek APIè¿”å›é”™è¯¯: {response.status_code} - {response.text}")

            # éªŒè¯ç”Ÿæˆå†…å®¹çš„å®Œæ•´æ€§
            if not explanation_text or len(explanation_text.strip()) < 100:
                print("âš ï¸ ç”Ÿæˆçš„è§£é‡Šå†…å®¹è¿‡çŸ­ï¼Œå¯èƒ½ä¸å®Œæ•´")
                return "é€šä¿—è§£é‡Šç”Ÿæˆå¤±è´¥ï¼šç”Ÿæˆå†…å®¹ä¸å®Œæ•´ï¼Œè¯·é‡è¯•"

            # æ¸…ç†è§£é‡Šç»“æœ
            explanation_text = self.clean_popular_explanation(explanation_text)

            # å†æ¬¡éªŒè¯æ¸…ç†åçš„å†…å®¹
            if not explanation_text or len(explanation_text.strip()) < 50:
                print("âš ï¸ æ¸…ç†åçš„è§£é‡Šå†…å®¹è¿‡çŸ­")
                return "é€šä¿—è§£é‡Šç”Ÿæˆå¤±è´¥ï¼šå†…å®¹å¤„ç†å¼‚å¸¸ï¼Œè¯·é‡è¯•"

            print(f"âœ… é€šä¿—è§£é‡Šç”Ÿæˆå®Œæˆï¼Œå†…å®¹é•¿åº¦: {len(explanation_text)}å­—ç¬¦")
            return explanation_text

        except Exception as e:
            # è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•
            error_msg = str(e)
            print(f"âŒ é€šä¿—è§£é‡Šç”Ÿæˆå¤±è´¥: {error_msg}")

            # æ ¹æ®ä¸åŒé”™è¯¯ç±»å‹æä¾›æ›´å‡†ç¡®çš„é”™è¯¯ä¿¡æ¯
            if "timeout" in error_msg.lower():
                print("â° é€šä¿—è§£é‡Šè¶…æ—¶ï¼Œå†…å®¹ç”Ÿæˆéœ€è¦æ›´é•¿æ—¶é—´")
                return "é€šä¿—è§£é‡Šç”Ÿæˆå¤±è´¥ï¼šAPIå“åº”è¶…æ—¶ï¼Œè¯·é‡è¯•"
            elif "ssl" in error_msg.lower() or "decryption" in error_msg.lower():
                print("ğŸ” SSLè¿æ¥é—®é¢˜")
                return "é€šä¿—è§£é‡Šç”Ÿæˆå¤±è´¥ï¼šç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œè¯·é‡è¯•"
            elif "proxy" in error_msg.lower():
                print("ğŸŒ ä»£ç†è¿æ¥é—®é¢˜")
                return "é€šä¿—è§£é‡Šç”Ÿæˆå¤±è´¥ï¼šä»£ç†è¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®"
            elif "rate_limit" in error_msg.lower():
                print("ğŸš¦ APIè°ƒç”¨é¢‘ç‡é™åˆ¶")
                return "é€šä¿—è§£é‡Šç”Ÿæˆå¤±è´¥ï¼šAPIè°ƒç”¨è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•"
            elif "quota" in error_msg.lower():
                print("ğŸ’³ APIé¢åº¦ä¸è¶³")
                return "é€šä¿—è§£é‡Šç”Ÿæˆå¤±è´¥ï¼šAPIé¢åº¦ä¸è¶³ï¼Œè¯·æ£€æŸ¥è´¦æˆ·"
            elif "invalid_request_error" in error_msg.lower():
                print("ğŸ“ è¯·æ±‚å‚æ•°é”™è¯¯")
                return "é€šä¿—è§£é‡Šç”Ÿæˆå¤±è´¥ï¼šè¯·æ±‚å‚æ•°æœ‰è¯¯ï¼Œè¯·è”ç³»å¼€å‘è€…"
            elif "key" in error_msg.lower() or "auth" in error_msg.lower():
                print("ğŸ”‘ APIå¯†é’¥é—®é¢˜")
                return "é€šä¿—è§£é‡Šç”Ÿæˆå¤±è´¥ï¼šAPIå¯†é’¥æ— æ•ˆæˆ–è¿‡æœŸ"
            elif "network" in error_msg.lower() or "connection" in error_msg.lower():
                print("ğŸŒ ç½‘ç»œè¿æ¥é—®é¢˜")
                return "é€šä¿—è§£é‡Šç”Ÿæˆå¤±è´¥ï¼šç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"
            else:
                print(f"â“ æœªçŸ¥é”™è¯¯: {error_msg}")
                return f"é€šä¿—è§£é‡Šç”Ÿæˆå¤±è´¥ï¼š{error_msg}"

    def clean_popular_explanation(self, raw_explanation):
        """æ¸…ç†é€šä¿—è§£é‡Šç»“æœ"""
        if not raw_explanation:
            return raw_explanation

        # åˆ é™¤ä¸éœ€è¦çš„æ ‡é¢˜å’Œæ ‡æ³¨
        lines = raw_explanation.split('\n')
        cleaned_lines = []

        for line in lines:
            # è·³è¿‡ã€é€šä¿—è§£é‡Šã€‘æ ‡é¢˜ï¼ˆå¦‚æœDeepSeekè‡ªå·±åŠ äº†ï¼‰
            if line.strip() == 'ã€é€šä¿—è§£é‡Šã€‘':
                continue
            # è·³è¿‡å…¶ä»–ä¸éœ€è¦çš„æ ‡æ³¨
            if 'ã€è¦æ±‚ã€‘' in line:
                break  # åœæ­¢å¤„ç†ï¼Œåé¢çš„éƒ½æ˜¯è¦æ±‚è¯´æ˜

            cleaned_lines.append(line)

        # åˆ é™¤å¼€å¤´å’Œç»“å°¾çš„ç©ºè¡Œ
        while cleaned_lines and not cleaned_lines[0].strip():
            cleaned_lines.pop(0)
        while cleaned_lines and not cleaned_lines[-1].strip():
            cleaned_lines.pop()

        return '\n'.join(cleaned_lines)

    def _custom_location_file(self) -> str:
        """è¿”å›è‡ªå®šä¹‰åŸå¸‚åæ ‡æ–‡ä»¶è·¯å¾„ã€‚"""
        return os.path.join(os.getcwd(), "custom_locations.json")

    def _load_custom_city_coordinates(self) -> dict:
        """åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰çš„åŸå¸‚ç»çº¬åº¦è¡¨ã€‚"""
        # ç¡®ä¿å±æ€§å·²åˆå§‹åŒ–
        if not hasattr(self, '_custom_city_coords'):
            self._custom_city_coords = None
        if self._custom_city_coords is not None:
            return self._custom_city_coords
        custom_path = self._custom_location_file()
        coords = {}
        try:
            if os.path.exists(custom_path):
                with open(custom_path, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    for key, value in data.items():
                        if isinstance(value, (list, tuple)) and len(value) >= 2:
                            coords[key] = (float(value[0]), float(value[1]))
        except Exception as e:
            print(f"âš ï¸ è¯»å–è‡ªå®šä¹‰åŸå¸‚åæ ‡å¤±è´¥ï¼š{e}")
            coords = {}
        self._custom_city_coords = coords
        return coords

    def _save_custom_city_coordinate(self, key: str, lon: float, lat: float):
        """å°†æ–°åŸå¸‚ç»çº¬åº¦å†™å…¥è‡ªå®šä¹‰é…ç½®ã€‚"""
        coords = self._load_custom_city_coordinates()
        coords[key] = (lon, lat)
        try:
            custom_path = self._custom_location_file()
            with open(custom_path, 'w', encoding='utf-8') as f:
                json.dump({k: [v[0], v[1]] for k, v in coords.items()}, f, ensure_ascii=False, indent=2)
        except Exception as e:
            print(f"âš ï¸ ä¿å­˜è‡ªå®šä¹‰åŸå¸‚åæ ‡å¤±è´¥ï¼š{e}")

    def _geocode_city(self, province: str, city: str) -> Optional[Tuple[float, float, str]]:
        """ä½¿ç”¨å¼€æ”¾åœ°ç†æœåŠ¡å°è¯•è§£æç»çº¬åº¦ã€‚"""
        try:
            query_parts = [text for text in [city, province, "China"] if text]
            if not query_parts:
                return None
            response = requests.get(
                "https://nominatim.openstreetmap.org/search",
                params={"q": ", ".join(query_parts), "format": "json", "limit": 1},
                headers={"User-Agent": "bagua-clock/2.0.0"},
                timeout=5,
            )
            if response.status_code == 200:
                data = response.json()
                if data:
                    lat = float(data[0]['lat'])
                    lon = float(data[0]['lon'])
                    display_name = data[0].get('display_name', query_parts[0])
                    return lon, lat, display_name
        except Exception as e:
            print(f"âš ï¸ åœ¨çº¿åœ°ç†ç¼–ç å¤±è´¥ï¼š{e}")
        return None

    def _prompt_for_manual_location(self, place_text: str) -> Optional[Tuple[float, float]]:
        """æç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ç»çº¬åº¦ã€‚"""
        try:
            if QApplication.instance() is None:
                return None
            prompt = (
                f"æœªæ‰¾åˆ°â€œ{place_text}â€çš„ç»çº¬åº¦ã€‚\n"
                "è¯·è¾“å…¥ç»åº¦å’Œçº¬åº¦ï¼Œä¾‹å¦‚ï¼š120.15,30.28"
            )
            text, ok = QInputDialog.getText(self, "å¡«å†™ç»çº¬åº¦", prompt)
            if not ok or not text:
                return None
            parts = text.replace('ï¼Œ', ',').replace(' ', ',').split(',')
            if len(parts) < 2:
                QMessageBox.warning(self, "æ ¼å¼é”™è¯¯", "è¯·è¾“å…¥â€œç»åº¦,çº¬åº¦â€çš„æ ¼å¼ã€‚")
                return None
            lon = float(parts[0].strip())
            lat = float(parts[1].strip())
            return lon, lat
        except Exception as e:
            print(f"âš ï¸ æ‰‹åŠ¨è¾“å…¥ç»çº¬åº¦è§£æå¤±è´¥ï¼š{e}")
        return None

    def _get_birth_location(self, province=None, city=None):
        """è·å–å‡ºç”Ÿåœ°ç»çº¬åº¦ï¼ˆå¸¦å®¹é”™å¤„ç†ï¼‰"""
        city_coordinates = {
            "åŒ—äº¬": (116.38, 39.90), "ä¸Šæµ·": (121.47, 31.23), "å¹¿å·": (113.27, 23.13),
            "æ·±åœ³": (114.07, 22.62), "æ­å·": (120.19, 30.26), "å—äº¬": (118.78, 32.04),
            "æ­¦æ±‰": (114.31, 30.52), "æˆéƒ½": (104.06, 30.67), "è¥¿å®‰": (108.95, 34.27),
            "é•¿æ²™": (112.98, 28.2), "é‡åº†": (106.54, 29.59), "å¤©æ´¥": (117.20, 39.13),
            "æ²ˆé˜³": (123.38, 41.80), "å¤§è¿": (121.62, 38.92), "é’å²›": (120.33, 36.07),
            "å¦é—¨": (118.11, 24.46), "æ˜†æ˜": (102.73, 25.04), "ä¹Œé²æœ¨é½": (87.68, 43.77),
            "æ‹‰è¨": (91.11, 29.97), "å“ˆå°”æ»¨": (126.63, 45.75), "æµå—": (117.00, 36.65),
            "éƒ‘å·": (113.65, 34.76), "çŸ³å®¶åº„": (114.48, 38.03), "å¤ªåŸ": (112.53, 37.87),
            "å‘¼å’Œæµ©ç‰¹": (111.65, 40.82), "å…°å·": (103.73, 36.03), "é“¶å·": (106.27, 38.47),
            "è¥¿å®": (101.74, 36.56), "æµ·å£": (110.35, 20.02), "ä¸‰äºš": (109.51, 18.25),
            "å—å®": (108.33, 22.84), "æ¡‚æ—": (110.28, 25.29), "è´µé˜³": (106.71, 26.57),
            "ç¦å·": (119.30, 26.08), "åˆè‚¥": (117.27, 31.86), "å—æ˜Œ": (115.89, 28.68),
            "è‹å·": (120.62, 31.32), "æ— é”¡": (120.29, 31.57), "å®æ³¢": (121.55, 29.88),
            "æ¸©å·": (120.70, 28.00), "ä½›å±±": (113.12, 23.02), "ä¸œè": (113.75, 23.04),
            "ç æµ·": (113.55, 22.27), "æ³‰å·": (118.67, 24.88), "çƒŸå°": (121.39, 37.52),
            "æ½åŠ": (119.15, 36.71), "æ´›é˜³": (112.44, 34.70), "åŒ…å¤´": (109.84, 40.66),
            "å¤§åº†": (125.03, 46.58), "å¾å·": (117.19, 34.26), "å¸¸å·": (119.95, 31.79),
            "å˜‰å…´": (120.76, 30.75), "ç»å…´": (120.58, 30.01), "å°å·": (121.43, 28.68)
        }

        try:
            selected_province = province or ""
            selected_city = city or ""

            def _clean_text(value):
                if not value:
                    return ""
                return value.replace("çœ", "").replace("å¸‚", "").replace("è‡ªæ²»åŒº", "").replace("ç‰¹åˆ«è¡Œæ”¿åŒº", "").replace(" ", "")

            # é¦–é€‰åˆ†æå‚æ•°ä¸­ç¼“å­˜çš„ä¿¡æ¯
            if hasattr(self, 'analysis_params'):
                selected_province = selected_province or self.analysis_params.get('province', "")
                selected_city = selected_city or self.analysis_params.get('city', "")

            # å°è¯•ä»ä¸»è¦ç•Œé¢æ§ä»¶è·å–
            if hasattr(self, 'birth_province') and hasattr(self, 'birth_city'):
                if not selected_province:
                    selected_province = self.birth_province.currentText()
                if not selected_city or selected_city == "è¯·é€‰æ‹©åŸå¸‚":
                    city_from_ui = self.birth_city.currentText()
                    # ğŸ”¥ ä¿®å¤ï¼šè¿‡æ»¤æ‰"è¯·é€‰æ‹©åŸå¸‚"è¿™ä¸ªå ä½ç¬¦
                    if city_from_ui and city_from_ui != "è¯·é€‰æ‹©åŸå¸‚":
                        selected_city = city_from_ui

            if hasattr(self, 'naming_province') and hasattr(self, 'naming_city'):
                if not selected_province:
                    selected_province = self.naming_province.currentText()
                if not selected_city or selected_city == "è¯·é€‰æ‹©åŸå¸‚":
                    city_from_ui = self.naming_city.currentText()
                    # ğŸ”¥ ä¿®å¤ï¼šè¿‡æ»¤æ‰"è¯·é€‰æ‹©åŸå¸‚"è¿™ä¸ªå ä½ç¬¦
                    if city_from_ui and city_from_ui != "è¯·é€‰æ‹©åŸå¸‚":
                        selected_city = city_from_ui

            if hasattr(self, 'naming_person_info') and isinstance(self.naming_person_info, dict):
                selected_province = selected_province or self.naming_person_info.get('province', "")
                city_from_info = self.naming_person_info.get('city', "")
                # ğŸ”¥ ä¿®å¤ï¼šè¿‡æ»¤æ‰"è¯·é€‰æ‹©åŸå¸‚"è¿™ä¸ªå ä½ç¬¦
                if city_from_info and city_from_info != "è¯·é€‰æ‹©åŸå¸‚":
                    selected_city = selected_city or city_from_info

            selected_province = _clean_text(selected_province)
            selected_city = _clean_text(selected_city)

            # ğŸ”¥ ä¿®å¤ï¼šå†æ¬¡ç¡®è®¤è¿‡æ»¤æ‰"è¯·é€‰æ‹©åŸå¸‚"å’Œç©ºå€¼
            if selected_city in ["è¯·é€‰æ‹©åŸå¸‚", "è¯·é€‰æ‹©åŸ", ""]:
                selected_city = ""

            # ğŸ”¥ ä¿®å¤ï¼šå¦‚æœåªæœ‰çœä»½æ²¡æœ‰åŸå¸‚ï¼Œå°è¯•ä½¿ç”¨çœä»½çš„çœä¼šåŸå¸‚
            if selected_province and not selected_city:
                # çœä»½çœä¼šåŸå¸‚æ˜ å°„
                province_capitals = {
                    "æ¹–å—": "é•¿æ²™", "æ¹–åŒ—": "æ­¦æ±‰", "å¹¿ä¸œ": "å¹¿å·", "æµ™æ±Ÿ": "æ­å·",
                    "æ±Ÿè‹": "å—äº¬", "å±±ä¸œ": "æµå—", "æ²³å—": "éƒ‘å·", "å››å·": "æˆéƒ½",
                    "é™•è¥¿": "è¥¿å®‰", "æ²³åŒ—": "çŸ³å®¶åº„", "å±±è¥¿": "å¤ªåŸ", "è¾½å®": "æ²ˆé˜³",
                    "å‰æ—": "é•¿æ˜¥", "é»‘é¾™æ±Ÿ": "å“ˆå°”æ»¨", "å®‰å¾½": "åˆè‚¥", "ç¦å»º": "ç¦å·",
                    "æ±Ÿè¥¿": "å—æ˜Œ", "æµ·å—": "æµ·å£", "è´µå·": "è´µé˜³", "äº‘å—": "æ˜†æ˜",
                    "ç”˜è‚ƒ": "å…°å·", "é’æµ·": "è¥¿å®", "å®å¤": "é“¶å·", "æ–°ç–†": "ä¹Œé²æœ¨é½",
                    "è¥¿è—": "æ‹‰è¨", "å†…è’™å¤": "å‘¼å’Œæµ©ç‰¹", "å¹¿è¥¿": "å—å®"
                }
                capital_city = province_capitals.get(selected_province)
                if capital_city and capital_city in city_coordinates:
                    selected_city = capital_city
                    print(f"ğŸ”§ æœªé€‰æ‹©åŸå¸‚ï¼Œä½¿ç”¨çœä»½çœä¼š: {selected_province} -> {capital_city}")

            place_text = _clean_text(f"{selected_province}{selected_city}" if selected_city else selected_province)

            combined_coordinates = dict(city_coordinates)
            combined_coordinates.update(self._load_custom_city_coordinates())

            # å€™é€‰é”®é›†åˆï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼Œè¿‡æ»¤æ‰å ä½ç¬¦ï¼‰
            candidate_keys = []
            if selected_city:
                candidate_keys.append(selected_city)  # ä¼˜å…ˆä½¿ç”¨åŸå¸‚å
            if place_text and place_text != selected_city:
                candidate_keys.append(place_text)  # å…¶æ¬¡ä½¿ç”¨"çœä»½+åŸå¸‚"
            if selected_province and not selected_city:
                candidate_keys.append(selected_province)  # å¦‚æœåªæœ‰çœä»½ï¼Œä¹Ÿå°è¯•åŒ¹é…çœä»½å
            candidate_keys = [key for key in candidate_keys if key and key not in ["è¯·é€‰æ‹©åŸå¸‚", "è¯·é€‰æ‹©åŸ"]]

            # ç›´æ¥åŒ¹é…
            for key in candidate_keys:
                if key in combined_coordinates:
                    lon, lat = combined_coordinates[key]
                    return lon, lat, key

            # å­ä¸²åŒ¹é…ï¼ˆå¤„ç†â€œçœå¸‚â€ç»„åˆï¼‰
            for candidate in candidate_keys:
                for name, (lon, lat) in combined_coordinates.items():
                    if not name:
                        continue
                    if name in candidate or candidate in name:
                        return lon, lat, name

            # å°è¯•åœ¨çº¿åœ°ç†ç¼–ç 
            geocode_result = self._geocode_city(selected_province, selected_city or place_text)
            if geocode_result:
                lon, lat, display_name = geocode_result
                save_keys = {place_text, selected_city, display_name}
                for key in save_keys:
                    key_clean = _clean_text(key)
                    if key_clean:
                        self._save_custom_city_coordinate(key_clean, lon, lat)
                return lon, lat, display_name

            # æç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
            manual_coords = self._prompt_for_manual_location(place_text or selected_city or "æœªçŸ¥åœ°ç‚¹")
            if manual_coords:
                lon, lat = manual_coords
                save_key = place_text or selected_city or "è‡ªå®šä¹‰åœ°ç‚¹"
                save_key = _clean_text(save_key)
                self._save_custom_city_coordinate(save_key or "è‡ªå®šä¹‰åœ°ç‚¹", lon, lat)
                return lon, lat, save_key or "è‡ªå®šä¹‰åœ°ç‚¹"

            if not self._missing_location_warned:
                QMessageBox.warning(
                    self,
                    "ç¼ºå°‘åœ°ç†ä¿¡æ¯",
                    "æœªæ‰¾åˆ°è¯¥åŸå¸‚çš„ç»çº¬åº¦ï¼ŒçœŸå¤ªé˜³æ—¶æ ¡æ­£å°†è¢«è·³è¿‡ã€‚\n"
                    "è¯·åœ¨è®¾ç½®ä¸­è‡ªå®šä¹‰ç»çº¬åº¦æˆ–ç¨åé‡è¯•ã€‚"
                )
                self._missing_location_warned = True
            return None, None, "æœªçŸ¥"

        except Exception as e:
            print(f"è·å–å‡ºç”Ÿåœ°å¤±è´¥: {e}")
            return None, None, "æœªçŸ¥"

    def _normalize_lunar_month(self, year, month, is_leap):
        """æ ¹æ®é—°æœˆæ ‡è®°è°ƒæ•´å†œå†æœˆä»½ç¬¦å·"""
        if not is_leap:
            return month
        try:
            leap_month = LunarYear.fromYear(year).getLeapMonth()
            if leap_month == month:
                return -month
            print(f"æ³¨æ„ï¼š{year}å¹´æ²¡æœ‰é—°{month}æœˆï¼Œå·²æŒ‰å¹³æœˆå¤„ç†")
        except Exception as e:
            print(f"è·å–é—°æœˆä¿¡æ¯å¤±è´¥: {e}")
        return month

    # ğŸ”§ æ¢å¤ï¼šæœ¬åœ°å‘½ç†æ•°æ®è®¡ç®—ï¼ˆç”¨äºæä¾›ç»™DEEPSEEKçš„åŸºç¡€æ•°æ®ï¼‰
    def get_tiangan_wuxing_info(self):
        """è·å–å¤©å¹²äº”è¡Œä¿¡æ¯"""
        return {
            'ç”²': {'element': 'æœ¨', 'yin_yang': 'é˜³'},
            'ä¹™': {'element': 'æœ¨', 'yin_yang': 'é˜´'},
            'ä¸™': {'element': 'ç«', 'yin_yang': 'é˜³'},
            'ä¸': {'element': 'ç«', 'yin_yang': 'é˜´'},
            'æˆŠ': {'element': 'åœŸ', 'yin_yang': 'é˜³'},
            'å·±': {'element': 'åœŸ', 'yin_yang': 'é˜´'},
            'åºš': {'element': 'é‡‘', 'yin_yang': 'é˜³'},
            'è¾›': {'element': 'é‡‘', 'yin_yang': 'é˜´'},
            'å£¬': {'element': 'æ°´', 'yin_yang': 'é˜³'},
            'ç™¸': {'element': 'æ°´', 'yin_yang': 'é˜´'}
        }

    def get_dizhi_info(self):
        """è·å–åœ°æ”¯ä¿¡æ¯"""
        return {
            'å­': {'element': 'æ°´', 'canggan': ['ç™¸']},
            'ä¸‘': {'element': 'åœŸ', 'canggan': ['å·±', 'ç™¸', 'è¾›']},
            'å¯…': {'element': 'æœ¨', 'canggan': ['ç”²', 'ä¸™', 'æˆŠ']},
            'å¯': {'element': 'æœ¨', 'canggan': ['ä¹™']},
            'è¾°': {'element': 'åœŸ', 'canggan': ['æˆŠ', 'ä¹™', 'ç™¸']},
            'å·³': {'element': 'ç«', 'canggan': ['ä¸™', 'æˆŠ', 'åºš']},
            'åˆ': {'element': 'ç«', 'canggan': ['ä¸', 'å·±']},
            'æœª': {'element': 'åœŸ', 'canggan': ['å·±', 'ä¸', 'ä¹™']},
            'ç”³': {'element': 'é‡‘', 'canggan': ['åºš', 'å£¬', 'æˆŠ']},
            'é…‰': {'element': 'é‡‘', 'canggan': ['è¾›']},
            'æˆŒ': {'element': 'åœŸ', 'canggan': ['æˆŠ', 'è¾›', 'ä¸']},
            'äº¥': {'element': 'æ°´', 'canggan': ['å£¬', 'ç”²']}
        }

    def calculate_wuxing_distribution(self, pillars):
        """è®¡ç®—äº”è¡Œåˆ†å¸ƒ"""
        return self.calculate_wuxing_distribution_core(pillars, self.get_tiangan_wuxing_info(), self.get_dizhi_info())



    def calculate_bazi_with_lunar_lib(self, year, month, day, hour_index, gender):
        """æœ¬åœ°è®¡ç®—å·²ç¦ç”¨ï¼šç»Ÿä¸€ä½¿ç”¨DeepSeek API"""
        raise RuntimeError("æœ¬åœ°è®¡ç®—å·²ç¦ç”¨ï¼šè¯·ä½¿ç”¨DeepSeekè¿”å›çš„æ•°æ®")


    def is_leap_year(self, year):
        """åˆ¤æ–­æ˜¯å¦ä¸ºé—°å¹´"""
        return year % 4 == 0 and (year % 100 != 0 or year % 400 == 0)


    def get_ten_god_relation(self, other_gan, day_master, tiangan_wuxing):
        """è®¡ç®—å¤©å¹²ä¸æ—¥ä¸»çš„åç¥å…³ç³»"""
        day_element = tiangan_wuxing[day_master]['element']
        day_yin_yang = tiangan_wuxing[day_master]['yin_yang']
        other_element = tiangan_wuxing[other_gan]['element']
        other_yin_yang = tiangan_wuxing[other_gan]['yin_yang']
        # åç¥å…³ç³»è¡¨ï¼ˆä¿®æ­£ç‰ˆ - éµå¾ªã€Šæ¸Šæµ·å­å¹³ã€‹æ ‡å‡†ï¼‰
        # å…³ç³»è¯´æ˜ï¼š(æ—¥å¹²äº”è¡Œ, ä»–å¹²äº”è¡Œ) -> åç¥å…³ç³»
        # ç”Ÿå…‹å…³ç³»ï¼šæˆ‘ç”Ÿè€…ä¸ºé£Ÿä¼¤ï¼Œç”Ÿæˆ‘è€…ä¸ºå°ï¼Œæˆ‘å…‹è€…ä¸ºè´¢ï¼Œå…‹æˆ‘è€…ä¸ºå®˜æ€ï¼ŒåŒæˆ‘è€…ä¸ºæ¯”åŠ«
        ten_gods_map = {
            # æ—¥å¹²ä¸ºæœ¨æ—¶
            ('æœ¨', 'æœ¨'): {'same': 'æ¯”è‚©', 'diff': 'åŠ«è´¢'},  # åŒç±»
            ('æœ¨', 'ç«'): {'same': 'é£Ÿç¥', 'diff': 'ä¼¤å®˜'},  # æœ¨ç”Ÿç«
            ('æœ¨', 'åœŸ'): {'same': 'åè´¢', 'diff': 'æ­£è´¢'},  # æœ¨å…‹åœŸ
            ('æœ¨', 'é‡‘'): {'same': 'ä¸ƒæ€', 'diff': 'æ­£å®˜'},  # é‡‘å…‹æœ¨
            ('æœ¨', 'æ°´'): {'same': 'åå°', 'diff': 'æ­£å°'},  # æ°´ç”Ÿæœ¨
            # æ—¥å¹²ä¸ºç«æ—¶
            ('ç«', 'ç«'): {'same': 'æ¯”è‚©', 'diff': 'åŠ«è´¢'},  # åŒç±»
            ('ç«', 'åœŸ'): {'same': 'é£Ÿç¥', 'diff': 'ä¼¤å®˜'},  # ç«ç”ŸåœŸ
            ('ç«', 'é‡‘'): {'same': 'åè´¢', 'diff': 'æ­£è´¢'},  # ç«å…‹é‡‘
            ('ç«', 'æ°´'): {'same': 'ä¸ƒæ€', 'diff': 'æ­£å®˜'},  # æ°´å…‹ç«
            ('ç«', 'æœ¨'): {'same': 'åå°', 'diff': 'æ­£å°'},  # æœ¨ç”Ÿç«
            # æ—¥å¹²ä¸ºåœŸæ—¶
            ('åœŸ', 'åœŸ'): {'same': 'æ¯”è‚©', 'diff': 'åŠ«è´¢'},  # åŒç±»
            ('åœŸ', 'é‡‘'): {'same': 'é£Ÿç¥', 'diff': 'ä¼¤å®˜'},  # åœŸç”Ÿé‡‘
            ('åœŸ', 'æ°´'): {'same': 'åè´¢', 'diff': 'æ­£è´¢'},  # åœŸå…‹æ°´
            ('åœŸ', 'æœ¨'): {'same': 'ä¸ƒæ€', 'diff': 'æ­£å®˜'},  # æœ¨å…‹åœŸ
            ('åœŸ', 'ç«'): {'same': 'åå°', 'diff': 'æ­£å°'},  # ç«ç”ŸåœŸ
            # æ—¥å¹²ä¸ºé‡‘æ—¶
            ('é‡‘', 'é‡‘'): {'same': 'æ¯”è‚©', 'diff': 'åŠ«è´¢'},  # åŒç±»
            ('é‡‘', 'æ°´'): {'same': 'é£Ÿç¥', 'diff': 'ä¼¤å®˜'},  # é‡‘ç”Ÿæ°´
            ('é‡‘', 'æœ¨'): {'same': 'åè´¢', 'diff': 'æ­£è´¢'},  # é‡‘å…‹æœ¨
            ('é‡‘', 'ç«'): {'same': 'ä¸ƒæ€', 'diff': 'æ­£å®˜'},  # ç«å…‹é‡‘
            ('é‡‘', 'åœŸ'): {'same': 'åå°', 'diff': 'æ­£å°'},  # åœŸç”Ÿé‡‘ï¼ˆå·²ä¿®å¤ï¼šdiff=æ­£å°è¡¨ç¤ºé˜´é˜³ä¸åŒï¼‰
            # æ—¥å¹²ä¸ºæ°´æ—¶
            ('æ°´', 'æ°´'): {'same': 'æ¯”è‚©', 'diff': 'åŠ«è´¢'},  # åŒç±»
            ('æ°´', 'æœ¨'): {'same': 'é£Ÿç¥', 'diff': 'ä¼¤å®˜'},  # æ°´ç”Ÿæœ¨
            ('æ°´', 'ç«'): {'same': 'åè´¢', 'diff': 'æ­£è´¢'},  # æ°´å…‹ç«
            ('æ°´', 'åœŸ'): {'same': 'ä¸ƒæ€', 'diff': 'æ­£å®˜'},  # åœŸå…‹æ°´
            ('æ°´', 'é‡‘'): {'same': 'åå°', 'diff': 'æ­£å°'}   # é‡‘ç”Ÿæ°´
        }
        relation_key = (day_element, other_element)
        if relation_key in ten_gods_map:
            if day_yin_yang == other_yin_yang:
                return ten_gods_map[relation_key]['same']
            else:
                return ten_gods_map[relation_key]['diff']
        return "æœªçŸ¥"


    def calculate_wuxing_distribution_core(self, pillars, tiangan_wuxing, dizhi_info):
        """è®¡ç®—äº”è¡Œåˆ†å¸ƒ - æ ¸å¿ƒç‰ˆæœ¬ï¼ˆä¸ä¾èµ–bazi_resultï¼‰"""
        wuxing_count = {'æœ¨': 0, 'ç«': 0, 'åœŸ': 0, 'é‡‘': 0, 'æ°´': 0}

        # ç»Ÿè®¡å¤©å¹²äº”è¡Œï¼ˆæ¯ä¸ªå¤©å¹²è®¡1åˆ†ï¼‰
        for _, (tg, dz) in pillars.items():
            tg_element = tiangan_wuxing[tg]['element']
            wuxing_count[tg_element] += 1

            # ç»Ÿè®¡åœ°æ”¯äº”è¡Œï¼ˆæ¯ä¸ªåœ°æ”¯è®¡1åˆ†ï¼‰
            dz_element = dizhi_info[dz]['element']
            wuxing_count[dz_element] += 1

        return wuxing_count

    def get_wuxing_by_tiangan(self, tiangan):
        """æ ¹æ®å¤©å¹²è·å–äº”è¡Œ"""
        wuxing_map = {'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«', 'æˆŠ': 'åœŸ',
                      'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘', 'å£¬': 'æ°´', 'ç™¸': 'æ°´'}
        return wuxing_map.get(tiangan, 'æœªçŸ¥')

    def extract_gan_zhi(self, pillar_data):
        """
        ç»Ÿä¸€æå–å¤©å¹²åœ°æ”¯çš„è¾…åŠ©å‡½æ•°
        å…¼å®¹å­—ç¬¦ä¸²æ ¼å¼ï¼ˆå¦‚"æˆŠåˆ"ï¼‰å’Œåˆ—è¡¨/å…ƒç»„æ ¼å¼ï¼ˆå¦‚['æˆŠ', 'åˆ']ï¼‰

        Args:
            pillar_data: æŸ±æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–åˆ—è¡¨/å…ƒç»„

        Returns:
            tuple: (å¤©å¹², åœ°æ”¯)ï¼Œå¦‚æœæå–å¤±è´¥è¿”å›('', '')
        """
        try:
            if isinstance(pillar_data, str):
                if len(pillar_data) >= 2:
                    return (pillar_data[0], pillar_data[1])
                else:
                    return ('', '')
            elif isinstance(pillar_data, (list, tuple)):
                if len(pillar_data) >= 2:
                    return (pillar_data[0], pillar_data[1])
                else:
                    return ('', '')
            else:
                return ('', '')
        except Exception as e:
            print(f"âš ï¸ æå–å¤©å¹²åœ°æ”¯å¤±è´¥: {e}, pillar_data={pillar_data}")
            return ('', '')



    def mousePressEvent(self, event):
        """é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ - æ”¯æŒçª—å£æ‹–åŠ¨"""
        if event.button() == Qt.LeftButton:
            self.drag_position = event.globalPos() - self.frameGeometry().topLeft()
            event.accept()

    def mouseMoveEvent(self, event):
        """é¼ æ ‡ç§»åŠ¨äº‹ä»¶ - æ‰§è¡Œçª—å£æ‹–åŠ¨"""
        if event.buttons() == Qt.LeftButton and hasattr(self, 'drag_position'):
            self.move(event.globalPos() - self.drag_position)
            event.accept()


    def calculate_kongwang(self, day_stem, day_branch):
        """è®¡ç®—ç©ºäº¡ - åŸºäºä¼ ç»Ÿå…­ç”²ç©ºäº¡æ³•ï¼ˆä¿®å¤ç‰ˆï¼‰"""
        # ğŸ”§ ä¿®å¤ï¼šä¼ ç»Ÿç©ºäº¡å¯¹ç…§è¡¨ï¼ˆåŸºäºæ—¥æŸ±çš„å®Œæ•´å…­ç”²ç©ºäº¡æ³•ï¼‰
        # å…­ç”²ç©ºäº¡ï¼šç”²å­æ—¬æˆŒäº¥ç©ºï¼Œç”²æˆŒæ—¬ç”³é…‰ç©ºï¼Œç”²ç”³æ—¬åˆæœªç©ºï¼Œç”²åˆæ—¬è¾°å·³ç©ºï¼Œç”²è¾°æ—¬å¯…å¯ç©ºï¼Œç”²å¯…æ—¬å­ä¸‘ç©º
        kongwang_map = {
            # ç”²å­æ—¬ï¼ˆç”²å­ã€ä¹™ä¸‘ã€ä¸™å¯…ã€ä¸å¯ã€æˆŠè¾°ã€å·±å·³ã€åºšåˆã€è¾›æœªã€å£¬ç”³ã€ç™¸é…‰ï¼‰
            'ç”²å­': ['æˆŒ', 'äº¥'], 'ä¹™ä¸‘': ['æˆŒ', 'äº¥'], 'ä¸™å¯…': ['æˆŒ', 'äº¥'], 'ä¸å¯': ['æˆŒ', 'äº¥'],
            'æˆŠè¾°': ['æˆŒ', 'äº¥'], 'å·±å·³': ['æˆŒ', 'äº¥'], 'åºšåˆ': ['æˆŒ', 'äº¥'], 'è¾›æœª': ['æˆŒ', 'äº¥'],
            'å£¬ç”³': ['æˆŒ', 'äº¥'], 'ç™¸é…‰': ['æˆŒ', 'äº¥'],

            # ç”²æˆŒæ—¬ï¼ˆç”²æˆŒã€ä¹™äº¥ã€ä¸™å­ã€ä¸ä¸‘ã€æˆŠå¯…ã€å·±å¯ã€åºšè¾°ã€è¾›å·³ã€å£¬åˆã€ç™¸æœªï¼‰
            'ç”²æˆŒ': ['ç”³', 'é…‰'], 'ä¹™äº¥': ['ç”³', 'é…‰'], 'ä¸™å­': ['ç”³', 'é…‰'], 'ä¸ä¸‘': ['ç”³', 'é…‰'],
            'æˆŠå¯…': ['ç”³', 'é…‰'], 'å·±å¯': ['ç”³', 'é…‰'], 'åºšè¾°': ['ç”³', 'é…‰'], 'è¾›å·³': ['ç”³', 'é…‰'],
            'å£¬åˆ': ['ç”³', 'é…‰'], 'ç™¸æœª': ['ç”³', 'é…‰'],

            # ç”²ç”³æ—¬ï¼ˆç”²ç”³ã€ä¹™é…‰ã€ä¸™æˆŒã€ä¸äº¥ã€æˆŠå­ã€å·±ä¸‘ã€åºšå¯…ã€è¾›å¯ã€å£¬è¾°ã€ç™¸å·³ï¼‰
            'ç”²ç”³': ['åˆ', 'æœª'], 'ä¹™é…‰': ['åˆ', 'æœª'], 'ä¸™æˆŒ': ['åˆ', 'æœª'], 'ä¸äº¥': ['åˆ', 'æœª'],
            'æˆŠå­': ['åˆ', 'æœª'], 'å·±ä¸‘': ['åˆ', 'æœª'], 'åºšå¯…': ['åˆ', 'æœª'], 'è¾›å¯': ['åˆ', 'æœª'],
            'å£¬è¾°': ['åˆ', 'æœª'], 'ç™¸å·³': ['åˆ', 'æœª'],

            # ç”²åˆæ—¬ï¼ˆç”²åˆã€ä¹™æœªã€ä¸™ç”³ã€ä¸é…‰ã€æˆŠæˆŒã€å·±äº¥ã€åºšå­ã€è¾›ä¸‘ã€å£¬å¯…ã€ç™¸å¯ï¼‰
            'ç”²åˆ': ['è¾°', 'å·³'], 'ä¹™æœª': ['è¾°', 'å·³'], 'ä¸™ç”³': ['è¾°', 'å·³'], 'ä¸é…‰': ['è¾°', 'å·³'],
            'æˆŠæˆŒ': ['è¾°', 'å·³'], 'å·±äº¥': ['è¾°', 'å·³'], 'åºšå­': ['è¾°', 'å·³'], 'è¾›ä¸‘': ['è¾°', 'å·³'],
            'å£¬å¯…': ['è¾°', 'å·³'], 'ç™¸å¯': ['è¾°', 'å·³'],

            # ç”²è¾°æ—¬ï¼ˆç”²è¾°ã€ä¹™å·³ã€ä¸™åˆã€ä¸æœªã€æˆŠç”³ã€å·±é…‰ã€åºšæˆŒã€è¾›äº¥ã€å£¬å­ã€ç™¸ä¸‘ï¼‰
            'ç”²è¾°': ['å¯…', 'å¯'], 'ä¹™å·³': ['å¯…', 'å¯'], 'ä¸™åˆ': ['å¯…', 'å¯'], 'ä¸æœª': ['å¯…', 'å¯'],
            'æˆŠç”³': ['å¯…', 'å¯'], 'å·±é…‰': ['å¯…', 'å¯'], 'åºšæˆŒ': ['å¯…', 'å¯'], 'è¾›äº¥': ['å¯…', 'å¯'],
            'å£¬å­': ['å¯…', 'å¯'], 'ç™¸ä¸‘': ['å¯…', 'å¯'],

            # ç”²å¯…æ—¬ï¼ˆç”²å¯…ã€ä¹™å¯ã€ä¸™è¾°ã€ä¸å·³ã€æˆŠåˆã€å·±æœªã€åºšç”³ã€è¾›é…‰ã€å£¬æˆŒã€ç™¸äº¥ï¼‰
            'ç”²å¯…': ['å­', 'ä¸‘'], 'ä¹™å¯': ['å­', 'ä¸‘'], 'ä¸™è¾°': ['å­', 'ä¸‘'], 'ä¸å·³': ['å­', 'ä¸‘'],
            'æˆŠåˆ': ['å­', 'ä¸‘'], 'å·±æœª': ['å­', 'ä¸‘'], 'åºšç”³': ['å­', 'ä¸‘'], 'è¾›é…‰': ['å­', 'ä¸‘'],
            'å£¬æˆŒ': ['å­', 'ä¸‘'], 'ç™¸äº¥': ['å­', 'ä¸‘']
        }
        day_pillar = day_stem + day_branch
        return kongwang_map.get(day_pillar, [])
    def calculate_dayun(self, birth_year, birth_month, birth_day, gender, pillars):
        """æœ¬åœ°å¤§è¿è®¡ç®—å·²ç¦ç”¨ï¼šç»Ÿä¸€ä½¿ç”¨DeepSeek API"""
        raise RuntimeError("æœ¬åœ°è®¡ç®—å·²ç¦ç”¨ï¼šè¯·ä½¿ç”¨DeepSeekè¿”å›çš„æ•°æ®")
    def display_bazi_result(self, name, gender, year, month, day, hour_text, bazi_result):
        """æ˜¾ç¤ºå…«å­—åˆ†æç»“æœ - ä¼˜å…ˆæ˜¾ç¤ºæœ¬åœ°å®Œæ•´æŠ¥å‘Š"""
        try:
            # ğŸ”¥ å…³é”®ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°åˆ†æçš„å®Œæ•´æŠ¥å‘Šï¼ˆåŒ…å«14ä¸ªéƒ¨åˆ†ï¼‰
            if isinstance(bazi_result, dict) and 'local_analysis_text' in bazi_result and bazi_result['local_analysis_text']:
                # ä¼˜å…ˆæ˜¾ç¤ºæœ¬åœ°å®Œæ•´æŠ¥å‘Šï¼Œä½†å‰ç½®åŸºç¡€ä¿¡æ¯ï¼Œä¿æŒåŸæœ‰ä½“éªŒ
                complete_report = bazi_result['local_analysis_text']
                basic_info = self.format_our_basic_data(name, gender, year, month, day, hour_text)

                merged_text = f"""{basic_info}

{complete_report}"""

                # ğŸ”¥ è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥UIæ˜¾ç¤ºæ–‡æœ¬
                print(f"ğŸ–¥ï¸ UIæ˜¾ç¤ºæ–‡æœ¬ç»Ÿè®¡ï¼š")
                print(f"   - æ–‡æœ¬é•¿åº¦ï¼š{len(merged_text)} å­—ç¬¦")
                print(f"   - åŒ…å«æ®µè½æ•°ï¼š{merged_text.count('ã€')} ä¸ª")
                print(f"   - æ–‡æœ¬é¢„è§ˆå¤´éƒ¨ï¼š{merged_text[:200]}")
                print(f"   - æ–‡æœ¬é¢„è§ˆå°¾éƒ¨ï¼š...{merged_text[-200:]}")

                # ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿æ–‡æœ¬ç¼–ç æ­£ç¡®ï¼Œé¿å…ä¹±ç 
                if isinstance(merged_text, bytes):
                    merged_text = merged_text.decode('utf-8', errors='replace')
                elif not isinstance(merged_text, str):
                    merged_text = str(merged_text)

                # è®¾ç½®æ–‡æœ¬åˆ°QTextEditï¼ˆQTextEditè‡ªåŠ¨å¤„ç†UTF-8ï¼‰
                self.bazi_result.setPlainText(merged_text)  # ä½¿ç”¨setPlainTextè€Œä¸æ˜¯setTextï¼Œé¿å…HTMLæ ¼å¼é—®é¢˜
                print("âœ… æœ¬åœ°å®Œæ•´åˆ†ææŠ¥å‘Šæ˜¾ç¤ºæˆåŠŸï¼ˆå«åŸºç¡€ä¿¡æ¯+å®Œæ•´åˆ†æï¼‰")
                return

            # ğŸ”¥ ç¬¬äºŒé“é˜²çº¿ï¼šå¦‚æœä¸Šé¢æ²¡æœ‰è¿”å›ï¼Œè¯´æ˜local_analysis_textä¸ºç©ºï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
            basic_info = self.format_our_basic_data(name, gender, year, month, day, hour_text)

            # å¦‚æœbazi_resultæ˜¯å­—å…¸ä¸”æœ‰å…¶ä»–åˆ†æå†…å®¹ï¼Œä¼˜å…ˆä½¿ç”¨
            if isinstance(bazi_result, dict):
                # å°è¯•ä»å…¶ä»–é”®è·å–åˆ†æå†…å®¹ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
                analysis_content = ""
                for key in ['comprehensive_analysis', 'analysis_text', 'full_text', 'raw_analysis', 'comprehensive_text', 'report']:
                    val = bazi_result.get(key)
                    if isinstance(val, str) and val.strip():
                        analysis_content = val
                        break

                # å¦‚æœä»ç„¶æ²¡æœ‰æ‰¾åˆ°åˆ†æå†…å®¹ï¼Œåºåˆ—åŒ–æ•´ä¸ªå­—å…¸
                if not analysis_content:
                    import json
                    try:
                        analysis_content = json.dumps(bazi_result, ensure_ascii=False, indent=2)
                    except Exception:
                        analysis_content = str(bazi_result)
            else:
                # å¦‚æœä¸æ˜¯å­—å…¸ï¼Œç›´æ¥è½¬æ¢ä¸ºå­—ç¬¦ä¸²
                analysis_content = str(bazi_result)

            # æ¸…ç†èåˆåçš„åˆ†æç»“æœ
            if analysis_content and isinstance(analysis_content, str):
                analysis_content = self.clean_deepseek_result(analysis_content)

            # ç›´æ¥æ˜¾ç¤ºåŸºç¡€ä¿¡æ¯+å¤‡ç”¨åˆ†æå†…å®¹
            final_result = f"""{basic_info}

{analysis_content}"""

            # ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿æ–‡æœ¬ç¼–ç æ­£ç¡®ï¼Œé¿å…ä¹±ç 
            if isinstance(final_result, bytes):
                final_result = final_result.decode('utf-8', errors='replace')
            elif not isinstance(final_result, str):
                final_result = str(final_result)

            self.bazi_result.setPlainText(final_result)  # ä½¿ç”¨setPlainTexté¿å…HTMLæ ¼å¼é—®é¢˜
            print("âœ… å¤‡ç”¨åˆ†æç»“æœæ˜¾ç¤ºå®Œæˆ")
            return



        except Exception as e:
            print(f"âŒ æ˜¾ç¤ºåˆ†æç»“æœå¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            error_msg = f"æ˜¾ç¤ºåˆ†æç»“æœå¤±è´¥ï¼š{str(e)}\n\nè¯·æ£€æŸ¥æ—¥å¿—ä¿¡æ¯ã€‚"
            # ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿é”™è¯¯ä¿¡æ¯ä¹Ÿæ­£ç¡®ç¼–ç 
            if isinstance(error_msg, bytes):
                error_msg = error_msg.decode('utf-8', errors='replace')
            self.bazi_result.setPlainText(error_msg)

    def final_cleanup_after_explanation(self):
        """é€šä¿—è§£é‡Šå®Œæˆåçš„æœ€ç»ˆæ¸…ç†"""
        try:
            print("ğŸ§¹ å¼€å§‹é€šä¿—è§£é‡Šå®Œæˆåçš„æœ€ç»ˆæ¸…ç†...")

            # æ¸…ç†åˆ†æå‚æ•°
            if hasattr(self, 'analysis_params'):
                self.analysis_params = None

            # é‡ç½®åˆ†æçŠ¶æ€
            self.remaining_time = 480  # ğŸ”¥ é‡ç½®å€’è®¡æ—¶ä¸º8åˆ†é’Ÿ

            print("âœ… é€šä¿—è§£é‡Šå®Œæˆï¼Œæœ€ç»ˆæ¸…ç†å®Œæˆ")

        except Exception as e:
            print(f"âš ï¸ æœ€ç»ˆæ¸…ç†å¼‚å¸¸: {e}")

    def format_our_basic_data(self, name, gender, year, month, day, hour_text):
        """æ ¼å¼åŒ–æˆ‘ä»¬è®¡ç®—çš„åŸºç¡€æ•°æ® - ä¼˜åŒ–æ€§èƒ½ï¼Œé¿å…UIå¡é¡¿"""
        try:
            # ğŸ”¥ æ€§èƒ½ä¼˜åŒ–ï¼šæ·»åŠ è¶…æ—¶ä¿æŠ¤ï¼Œé¿å…UIå¡æ­»
            import time
            start_time = time.time()
            basic_info = f"""ã€ç²¾ç¡®åŸºç¡€æ•°æ®ã€‘

ã€åŸºæœ¬ä¿¡æ¯ã€‘
å§“åï¼š{name if name else 'æ±‚æµ‹è€…'}
æ€§åˆ«ï¼š{gender}
å‡ºç”Ÿæ—¶é—´ï¼šå†œå†{year}å¹´{month}æœˆ{day}æ—¥ {hour_text}
"""

            # ğŸ”§ ä¿®å¤ï¼šç¡®ä¿èƒ½è·å–åˆ°sxtwlç»“æœ
            sxtwl_result = None
            pillars = None

            # ä¼˜å…ˆä»å®ä¾‹å±æ€§è·å–ï¼ˆé™é»˜è·å–ï¼Œé¿å…UIå¡é¡¿ï¼‰
            if hasattr(self, 'current_sxtwl_result') and self.current_sxtwl_result:
                sxtwl_result = self.current_sxtwl_result
            elif hasattr(self, 'last_sxtwl_result') and self.last_sxtwl_result:
                sxtwl_result = self.last_sxtwl_result

            # ğŸ”¥ ä¿®å¤UIæœªå“åº”ï¼šä¸åœ¨ä¸»çº¿ç¨‹ä¸­é‡æ–°è®¡ç®—ï¼Œé¿å…å¡æ­»
            if not sxtwl_result:
                # é™é»˜å¤„ç†ï¼Œä¸æ‰“å°ï¼Œé¿å…UIå¡é¡¿
                pass

            if sxtwl_result and sxtwl_result.get('pillars'):
                pillars = sxtwl_result['pillars']
                # ğŸ”¥ ä¿®å¤ï¼šæ­£ç¡®æ ¼å¼åŒ–pillarsæ˜¾ç¤ºï¼ˆå¤„ç†åˆ—è¡¨å’Œå­—ç¬¦ä¸²ä¸¤ç§æ ¼å¼ï¼‰
                def format_pillar(p):
                    if isinstance(p, list) and len(p) >= 2:
                        return f"{p[0]}{p[1]}"
                    elif isinstance(p, str):
                        return p
                    else:
                        return str(p)

                year_pillar = format_pillar(pillars['year'])
                month_pillar = format_pillar(pillars['month'])
                day_pillar = format_pillar(pillars['day'])
                hour_pillar = format_pillar(pillars['hour'])

                basic_info += f"""
ã€ç²¾ç¡®å››æŸ±ã€‘
å¹´æŸ±ï¼š{year_pillar} æœˆæŸ±ï¼š{month_pillar} æ—¥æŸ±ï¼š{day_pillar} æ—¶æŸ±ï¼š{hour_pillar}
"""

                # ğŸ”¥ ç®€åŒ–åŸºç¡€åˆ†æï¼Œé¿å…å¤æ‚è®¡ç®—å¯¼è‡´UIå¡é¡¿
                try:
                    day_master = pillars['day'][0]
                    basic_info += f"\nã€åŸºç¡€åˆ†æã€‘\n"
                    # ğŸ”¥ ä¿®å¤ï¼šæ—¥ä¸»æ˜¾ç¤ºåº”è¯¥åŒ…å«äº”è¡Œï¼Œå¦‚"è¾›é‡‘"è€Œä¸æ˜¯"è¾›"
                    day_master_element = self.get_wuxing_by_tiangan(day_master) if day_master else ''
                    basic_info += f"æ—¥ä¸»ï¼š{day_master}{day_master_element if day_master_element else ''}\n"

                    # ğŸ”¥ ä¿®å¤ï¼šç»Ÿä¸€ä½¿ç”¨classic_analyzer.commonä¸­çš„get_ten_godå‡½æ•°ï¼ˆå·²ä¿®å¤æ­£å°/åå°é€»è¾‘ï¼‰
                    from classic_analyzer.common import get_ten_god
                    # å®‰å…¨æå–å¤©å¹²ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„è¾…åŠ©å‡½æ•°ï¼‰
                    try:
                        # ä½¿ç”¨ç»Ÿä¸€çš„extract_gan_zhiå‡½æ•°æå–å¤©å¹²åœ°æ”¯
                        year_gan, _ = self.extract_gan_zhi(pillars.get('year', ''))
                        month_gan, _ = self.extract_gan_zhi(pillars.get('month', ''))
                        hour_gan, _ = self.extract_gan_zhi(pillars.get('hour', ''))

                        # ğŸ”¥ è°ƒè¯•ï¼šæ‰“å°æå–çš„å¤©å¹²
                        print(f"ğŸ” è°ƒè¯•ï¼šæå–å¤©å¹² - å¹´å¹²:{year_gan}, æœˆå¹²:{month_gan}, æ—¶å¹²:{hour_gan}, æ—¥ä¸»:{day_master}")

                        # ç¡®ä¿å¤©å¹²å’Œæ—¥ä¸»éƒ½å­˜åœ¨æ‰è®¡ç®—åç¥
                        if day_master and year_gan and month_gan and hour_gan:
                            year_ten_god = get_ten_god(day_master, year_gan)
                            month_ten_god = get_ten_god(day_master, month_gan)
                            hour_ten_god = get_ten_god(day_master, hour_gan)
                            print(f"ğŸ” è°ƒè¯•ï¼šè®¡ç®—åç¥ - å¹´å¹²{year_ten_god}, æœˆå¹²{month_ten_god}, æ—¶å¹²{hour_ten_god}")
                        else:
                            print(f"âš ï¸ è­¦å‘Šï¼šå¤©å¹²æˆ–æ—¥ä¸»ç¼ºå¤±ï¼Œæ— æ³•è®¡ç®—åç¥")
                            year_ten_god = 'æœªçŸ¥' if not year_gan else get_ten_god(day_master, year_gan) if day_master and year_gan else 'æœªçŸ¥'
                            month_ten_god = 'æœªçŸ¥' if not month_gan else get_ten_god(day_master, month_gan) if day_master and month_gan else 'æœªçŸ¥'
                            hour_ten_god = 'æœªçŸ¥' if not hour_gan else get_ten_god(day_master, hour_gan) if day_master and hour_gan else 'æœªçŸ¥'
                    except Exception as e:
                        print(f"âš ï¸ åç¥è®¡ç®—å¤±è´¥: {e}")
                        import traceback
                        traceback.print_exc()
                        year_ten_god = 'æœªçŸ¥'
                        month_ten_god = 'æœªçŸ¥'
                        hour_ten_god = 'æœªçŸ¥'

                    # ğŸ”¥ ä¿®å¤ï¼šåç¥æ˜¾ç¤ºæ ¼å¼åº”è¯¥ä¸æ ‡å‡†ç­”æ¡ˆä¸€è‡´ï¼šå¹´å¹²æ­£å° / æœˆå¹²ä¼¤å®˜ / æ—¶å¹²åå°
                    basic_info += f"åç¥ï¼šå¹´å¹²{year_ten_god} / æœˆå¹²{month_ten_god} / æ—¶å¹²{hour_ten_god}\n"

                    # ğŸ”¥ ä¿®å¤ï¼šæ·»åŠ æ ¼å±€ä¿¡æ¯æ˜¾ç¤ºï¼Œç¡®ä¿ç¼–ç æ­£ç¡®
                    try:
                        if 'bazi_pattern' in sxtwl_result and sxtwl_result['bazi_pattern']:
                            pattern_info = sxtwl_result['bazi_pattern']
                            pattern_type = pattern_info.get('pattern_type', 'æœªçŸ¥')
                            pattern_desc = pattern_info.get('pattern_description', '')

                            # ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿å­—ç¬¦ä¸²ç¼–ç æ­£ç¡®ï¼Œé¿å…ä¹±ç 
                            # è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶å¤„ç†ç¼–ç 
                            if isinstance(pattern_type, bytes):
                                pattern_type = pattern_type.decode('utf-8', errors='replace')
                            elif not isinstance(pattern_type, str):
                                pattern_type = str(pattern_type)

                            if isinstance(pattern_desc, bytes):
                                pattern_desc = pattern_desc.decode('utf-8', errors='replace')
                            elif not isinstance(pattern_desc, str):
                                pattern_desc = str(pattern_desc) if pattern_desc else ''

                            basic_info += f"\nã€æ ¼å±€åˆ†æã€‘\n"
                            basic_info += f"æ ¼å±€ç±»å‹ï¼š{pattern_type}\n"
                            if pattern_desc and pattern_desc.strip():
                                basic_info += f"æ ¼å±€è¯´æ˜ï¼š{pattern_desc}\n"
                    except Exception as e:
                        basic_info += f"\nã€æ ¼å±€åˆ†æã€‘\næ ¼å±€ä¿¡æ¯ï¼šæ˜¾ç¤ºå¤±è´¥ï¼ˆ{str(e)}ï¼‰\n"

                    # äº”è¡Œåˆ†å¸ƒæ˜¾ç¤º
                    try:
                        if 'wuxing_distribution' in sxtwl_result:
                            wuxing_dist = sxtwl_result['wuxing_distribution']
                            basic_info += f"\nã€äº”è¡Œåˆ†å¸ƒã€‘\n"
                            total_wuxing = sum(wuxing_dist.values()) if wuxing_dist else 1

                            # è¯¦ç»†äº”è¡Œåˆ†æ
                            for element, count in wuxing_dist.items():
                                percentage = (count / total_wuxing * 100) if total_wuxing > 0 else 0
                                if percentage >= 30:
                                    strength = "åæ—º"
                                elif percentage <= 10:
                                    strength = "åå¼±"
                                else:
                                    strength = "é€‚ä¸­"
                                basic_info += f"{element}ï¼š{count:.1f}ä¸ªï¼ˆ{percentage:.1f}%ï¼‰- {strength}\n"

                            # äº”è¡Œç¼ºå¤±åˆ†æ
                            missing = [k for k, v in wuxing_dist.items() if v == 0]
                            if missing:
                                basic_info += f"\nã€äº”è¡Œç¼ºå¤±ã€‘\n"
                                basic_info += f"ç¼ºå¤±ï¼š{', '.join(missing)}\n"
                                # è¡¥æ•‘å»ºè®®
                                basic_info += f"è¡¥æ•‘å»ºè®®ï¼š\n"
                                for element in missing:
                                    remedy = self.get_wuxing_remedy(element)
                                    basic_info += f"  {element}ï¼š{remedy}\n"

                            # äº”è¡Œå¼ºå¼±åˆ†æ
                            strong_elements = [k for k, v in wuxing_dist.items() if (v / total_wuxing * 100) >= 30]
                            weak_elements = [k for k, v in wuxing_dist.items() if 0 < (v / total_wuxing * 100) <= 10]

                            if strong_elements or weak_elements:
                                basic_info += f"\nã€äº”è¡Œå¹³è¡¡ã€‘\n"
                                if strong_elements:
                                    basic_info += f"åæ—ºï¼š{', '.join(strong_elements)} - éœ€è¦æ³„è€—\n"
                                if weak_elements:
                                    basic_info += f"åå¼±ï¼š{', '.join(weak_elements)} - éœ€è¦ç”Ÿæ‰¶\n"
                        else:
                            basic_info += f"äº”è¡Œï¼šå·²è®¡ç®—\n"
                    except Exception as e:
                        basic_info += f"äº”è¡Œåˆ†æï¼š{e}\n"

                except Exception as e:
                    basic_info += f"åŸºç¡€åˆ†æï¼š{e}\n"
            else:
                basic_info += "\nâš ï¸ æœªæ‰¾åˆ°sxtwlè®¡ç®—ç»“æœ\n"

            # ğŸ”¥ æ€§èƒ½æ£€æŸ¥ï¼šå¦‚æœå¤„ç†æ—¶é—´è¿‡é•¿ï¼Œè®°å½•è­¦å‘Š
            end_time = time.time()
            processing_time = end_time - start_time
            if processing_time > 1.0:  # è¶…è¿‡1ç§’è®°å½•è­¦å‘Š
                print(f"âš ï¸ format_our_basic_data å¤„ç†æ—¶é—´è¿‡é•¿: {processing_time:.2f}ç§’")

            return basic_info

        except Exception as e:
            return f"åŸºç¡€æ•°æ®æ ¼å¼åŒ–å¤±è´¥ï¼š{e}"

    def export_full_report(self):
        """
        ä¸€é”®å¯¼å‡ºå®Œæ•´æŠ¥å‘Š
        ğŸ”¥ P0ä¿®å¤ï¼šæ–°å¢å¯¼å‡ºæŠ¥å‘ŠåŠŸèƒ½
        """
        try:
            # æ£€æŸ¥æ˜¯å¦æœ‰åˆ†æç»“æœ
            if not hasattr(self, 'bazi_result') or not self.bazi_result.toPlainText().strip():
                QMessageBox.warning(self, "æç¤º", "è¯·å…ˆè¿›è¡Œå…«å­—åˆ†æï¼Œç„¶åå†å¯¼å‡ºæŠ¥å‘Š")
                return

            # è·å–å½“å‰åˆ†æç»“æœ
            report_text = self.bazi_result.toPlainText()

            # è·å–å§“åï¼ˆå¦‚æœæœ‰ï¼‰
            name = "æ±‚æµ‹è€…"
            if hasattr(self, 'name_input') and self.name_input:
                name_text = self.name_input.text().strip()
                if name_text:
                    name = name_text

            # ç”Ÿæˆæ–‡ä»¶å
            from datetime import datetime
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            default_filename = f"{name}_å…«å­—æŠ¥å‘Š_{timestamp}.txt"

            # æ‰“å¼€æ–‡ä»¶ä¿å­˜å¯¹è¯æ¡†
            file_path, _ = QFileDialog.getSaveFileName(
                self,
                "ä¿å­˜æŠ¥å‘Š",
                default_filename,
                "æ–‡æœ¬æ–‡ä»¶ (*.txt);;æ‰€æœ‰æ–‡ä»¶ (*.*)"
            )

            if file_path:
                # æ·»åŠ æŠ¥å‘Šå¤´éƒ¨ä¿¡æ¯
                full_report = "=" * 80 + "\n"
                full_report += f"å…«å­—å‘½ç†åˆ†ææŠ¥å‘Š\n"
                full_report += f"ç”Ÿæˆæ—¶é—´ï¼š{datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')}\n"
                full_report += "=" * 80 + "\n\n"
                full_report += report_text
                full_report += "\n\n" + "=" * 80 + "\n"
                full_report += "æŠ¥å‘Šç»“æŸ\n"
                full_report += "=" * 80 + "\n"

                # ä¿å­˜æ–‡ä»¶
                with open(file_path, 'w', encoding='utf-8') as f:
                    f.write(full_report)

                QMessageBox.information(self, "æˆåŠŸ", f"æŠ¥å‘Šå·²æˆåŠŸä¿å­˜åˆ°ï¼š\n{file_path}")
                print(f"âœ… æŠ¥å‘Šå·²å¯¼å‡ºï¼š{file_path}")

        except Exception as e:
            error_msg = f"å¯¼å‡ºæŠ¥å‘Šå¤±è´¥ï¼š{str(e)}"
            print(f"âŒ {error_msg}")
            import traceback
            traceback.print_exc()
            QMessageBox.critical(self, "é”™è¯¯", error_msg)



    def get_wuxing_by_tiangan(self, tiangan):
        """æ ¹æ®å¤©å¹²è·å–äº”è¡Œ"""
        wuxing_map = {'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«', 'æˆŠ': 'åœŸ',
                      'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘', 'å£¬': 'æ°´', 'ç™¸': 'æ°´'}
        return wuxing_map.get(tiangan, 'æœªçŸ¥')

    def get_wuxing_remedy(self, element):
        """è·å–äº”è¡Œè¡¥æ•‘å»ºè®®"""
        remedies = {
            'æœ¨': 'å¤šæ¥è§¦ç»¿è‰²æ¤ç‰©ï¼Œä½©æˆ´æœ¨è´¨é¥°å“ï¼Œå±…ä½æœä¸œæˆ¿å±‹ï¼Œå¤šåƒç»¿è‰²è”¬èœ',
            'ç«': 'å¤šæ¥è§¦é˜³å…‰ï¼Œä½©æˆ´çº¢è‰²é¥°å“ï¼Œå±…ä½æœå—æˆ¿å±‹ï¼Œå¤šåƒçº¢è‰²é£Ÿç‰©',
            'åœŸ': 'å¤šæ¥è§¦å¤§åœ°ï¼Œä½©æˆ´é»„è‰²é¥°å“ï¼Œå±…ä½ä¸­å¤®ä½ç½®ï¼Œå¤šåƒé»„è‰²é£Ÿç‰©',
            'é‡‘': 'å¤šæ¥è§¦é‡‘å±ï¼Œä½©æˆ´é‡‘å±é¥°å“ï¼Œå±…ä½æœè¥¿æˆ¿å±‹ï¼Œå¤šåƒç™½è‰²é£Ÿç‰©',
            'æ°´': 'å¤šæ¥è§¦æ°´æºï¼Œä½©æˆ´è“è‰²é¥°å“ï¼Œå±…ä½æœåŒ—æˆ¿å±‹ï¼Œå¤šåƒé»‘è‰²é£Ÿç‰©'
        }
        return remedies.get(element, 'è¯·å’¨è¯¢ä¸“ä¸šå‘½ç†å¸ˆ')
    
    def analyze_wuxing_remedy_comprehensive(self, missing_wuxing=None, weak_wuxing=None, strong_wuxing=None,
                                             yongshen_wuxing=None, xishen_wuxing=None, jishen_wuxing=None,
                                             pattern_info=None, ten_gods_detail=None, day_master=None):
        """
        äº”è¡Œè¡¥æ•‘ç»¼åˆåˆ†æ - åŸºäºã€Šç©·é€šå®é‰´ã€‹ã€Šæ»´å¤©é«“ã€‹ã€Šå­å¹³çœŸè¯ ã€‹
        æ ¹æ®å…«å­—åç¥å‘½æ ¼æä¾›å…¨é¢çš„äº”è¡Œè¡¥æ•‘å»ºè®®
        
        å‚æ•°:
            missing_wuxing: ç¼ºå¤±çš„äº”è¡Œåˆ—è¡¨
            weak_wuxing: åå¼±çš„äº”è¡Œåˆ—è¡¨
            strong_wuxing: åæ—ºçš„äº”è¡Œåˆ—è¡¨
            yongshen_wuxing: ç”¨ç¥äº”è¡Œåˆ—è¡¨
            xishen_wuxing: å–œç¥äº”è¡Œåˆ—è¡¨
            jishen_wuxing: å¿Œç¥äº”è¡Œåˆ—è¡¨
            pattern_info: æ ¼å±€ä¿¡æ¯
            ten_gods_detail: åç¥è¯¦æƒ…
        
        è¿”å›:
            äº”è¡Œè¡¥æ•‘å»ºè®®æ–‡æœ¬
        """
        missing_wuxing = missing_wuxing or []
        weak_wuxing = weak_wuxing or []
        strong_wuxing = strong_wuxing or []
        yongshen_wuxing = yongshen_wuxing or []
        xishen_wuxing = xishen_wuxing or []
        jishen_wuxing = jishen_wuxing or []
        
        # äº”è¡Œè¡¥æ•‘ä¿¡æ¯æ˜ å°„ï¼ˆåŸºäºã€Šç©·é€šå®é‰´ã€‹ã€Šäº”è¡Œå¤§ä¹‰ã€‹ï¼‰
        wuxing_remedy_map = {
            'æœ¨': {
                'colors': ['ç»¿è‰²', 'é’è‰²', 'ç¿ è‰²'],
                'positions': ['ä¸œæ–¹', 'ä¸œåŒ—æ–¹'],
                'foods': ['ç»¿å¶è”¬èœ', 'é’ç¬‹', 'è‰è“', 'çŒ•çŒ´æ¡ƒ', 'ç»¿è±†', 'ç»¿èŒ¶'],
                'accessories': ['ç‰ä½©', 'æœ¨è´¨é¥°å“', 'ç»¿ç¢§çº', 'ç»¿å¹½çµ', 'ç¿¡ç¿ '],
                'professions': ['æ—ä¸š', 'å›­è‰º', 'åŒ»å­¦', 'æ•™è‚²', 'æ–‡åŒ–', 'å‡ºç‰ˆ'],
                'activities': ['å¤šæ¥è§¦è‡ªç„¶', 'ç§æ¤èŠ±è‰', 'è¯»ä¹¦å­¦ä¹ ', 'é™åå†¥æƒ³']
            },
            'ç«': {
                'colors': ['çº¢è‰²', 'ç´«è‰²', 'æ©™è‰²', 'ç²‰è‰²'],
                'positions': ['å—æ–¹', 'ä¸œå—æ–¹'],
                'foods': ['çº¢æ£', 'å±±æ¥‚', 'è‹¹æœ', 'èƒ¡èåœ', 'ç•ªèŒ„', 'è¾£æ¤’'],
                'accessories': ['çº¢ç›ç‘™', 'çº¢å®çŸ³', 'çº¢çŠç‘š', 'ç«æ™¶', 'ç´«æ°´æ™¶'],
                'professions': ['é¤é¥®', 'å¨±ä¹', 'ç”µåŠ›', 'ä¼ åª’', 'è‰ºæœ¯', 'é”€å”®'],
                'activities': ['å¤šæ™’å¤ªé˜³', 'è¿åŠ¨é”»ç‚¼', 'ç¤¾äº¤æ´»åŠ¨', 'åˆ›ä½œè¡¨è¾¾']
            },
            'åœŸ': {
                'colors': ['é»„è‰²', 'è¤è‰²', 'ç±³è‰²', 'å’–å•¡è‰²'],
                'positions': ['ä¸­å¤®', 'è¥¿å—æ–¹', 'ä¸œåŒ—æ–¹'],
                'foods': ['é»„è±†', 'ç‰ç±³', 'åœ°ç“œ', 'èœ‚èœœ', 'å°ç±³', 'å—ç“œ'],
                'accessories': ['é»„æ°´æ™¶', 'é™¶ç“·', 'ç¥ç€', 'é»„ç‰', 'èœœèœ¡'],
                'professions': ['æˆ¿åœ°äº§', 'å†œä¸š', 'çŸ¿ä¸š', 'å»ºç­‘', 'é‡‘è', 'å’¨è¯¢'],
                'activities': ['æ¥è§¦å¤§åœ°', 'å›­è‰ºç§æ¤', 'ç¨³å®šä½œæ¯', 'ç§¯ç´¯èµ„æº']
            },
            'é‡‘': {
                'colors': ['ç™½è‰²', 'é“¶è‰²', 'é‡‘è‰²', 'æµ…ç°è‰²'],
                'positions': ['è¥¿æ–¹', 'è¥¿åŒ—æ–¹'],
                'foods': ['é“¶è€³', 'ç™½èåœ', 'è±†è…', 'ç‰›å¥¶', 'æ¢¨', 'ç™¾åˆ'],
                'accessories': ['ç™½æ°´æ™¶', 'é‡‘é¥°', 'é“¶é¥°', 'é‡‘å±é¥°å“', 'çç '],
                'professions': ['é‡‘è', 'æœºæ¢°', 'ç²¾å¯†', 'æ‰‹æœ¯', 'æ³•å¾‹', 'ç®¡ç†'],
                'activities': ['ä¿æŒæ•´æ´', 'è§„å¾‹ä½œæ¯', 'ä¸“æ³¨å­¦ä¹ ', 'é”»ç‚¼èº«ä½“']
            },
            'æ°´': {
                'colors': ['é»‘è‰²', 'è“è‰²', 'æ·±è“è‰²', 'ç°è‰²'],
                'positions': ['åŒ—æ–¹', 'è¥¿åŒ—æ–¹'],
                'foods': ['é»‘èŠéº»', 'é»‘æœ¨è€³', 'æµ·å¸¦', 'é±¼ç±»', 'ç´«èœ', 'é»‘è±†'],
                'accessories': ['é»‘æ›œçŸ³', 'è“å®çŸ³', 'é»‘ç›ç‘™', 'é’é‡‘çŸ³', 'æµ·è“å®'],
                'professions': ['èˆªæµ·', 'è´¸æ˜“', 'æ—…æ¸¸', 'è¿è¾“', 'æ°´åˆ©', 'ç‰©æµ'],
                'activities': ['å¤šå–æ°´', 'æ¸¸æ³³', 'é™å¿ƒæ€è€ƒ', 'ä¿æŒæµåŠ¨']
            }
        }
        
        remedy_lines = []
        
        # 1. ç¼ºå¤±äº”è¡Œè¡¥æ•‘ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
        if missing_wuxing:
            remedy_lines.append("ã€ç¼ºå¤±äº”è¡Œè¡¥æ•‘ã€‘ï¼ˆéœ€é‡ç‚¹è¡¥å……ï¼‰")
            for wx in missing_wuxing:
                if wx in wuxing_remedy_map:
                    info = wuxing_remedy_map[wx]
                    remedy_lines.append(f"  â€¢ {wx}ç¼ºå¤±ï¼š")
                    sep = 'ã€'
                    remedy_lines.append(f"    é¢œè‰²è¡¥æ•‘ï¼šæ—¥å¸¸ç©¿ç€ä»¥{sep.join(info['colors'])}ä¸ºä¸»")
                    remedy_lines.append(f"    æ–¹ä½è¡¥æ•‘ï¼šä½å®¶æˆ–åŠå…¬å®¤æœå‘{sep.join(info['positions'])}")
                    remedy_lines.append(f"    é£Ÿç–—è¡¥æ•‘ï¼šå¸¸é£Ÿ{sep.join(info['foods'])}")
                    remedy_lines.append(f"    é…é¥°è¡¥æ•‘ï¼šä½©æˆ´{sep.join(info['accessories'])}")
                    remedy_lines.append(f"    èŒä¸šå»ºè®®ï¼šé€‚åˆä»äº‹{sep.join(info['professions'])}ç­‰è¡Œä¸š")
                    remedy_lines.append(f"    ç”Ÿæ´»å»ºè®®ï¼š{sep.join(info['activities'])}")
        
        # 2. åå¼±äº”è¡Œè¡¥å¼º
        if weak_wuxing:
            remedy_lines.append("\nã€åå¼±äº”è¡Œè¡¥å¼ºã€‘ï¼ˆéœ€è¦åŠ å¼ºï¼‰")
            for wx in weak_wuxing:
                if wx in wuxing_remedy_map:
                    info = wuxing_remedy_map[wx]
                    colors = 'ã€'.join(info['colors'])
                    foods = 'ã€'.join(info['foods'])
                    accessories = 'ã€'.join(info['accessories'][:2])
                    remedy_lines.append(f"  â€¢ {wx}åå¼±ï¼šå¤šæ¥è§¦{colors}ç¯å¢ƒï¼Œå¢åŠ é£Ÿç”¨{foods}ï¼Œå¯ä½©æˆ´{accessories}")
        
        # 3. ç”¨ç¥è¡¥å¼ºï¼ˆé‡ç‚¹ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼‰
        if yongshen_wuxing:
            remedy_lines.append("\nã€ç”¨ç¥è¡¥å¼ºã€‘ï¼ˆé‡ç‚¹ï¼Œç›´æ¥å½±å“è¿åŠ¿ï¼‰")
            for wx in yongshen_wuxing:
                if wx in wuxing_remedy_map:
                    info = wuxing_remedy_map[wx]
                    remedy_lines.append(f"  â€¢ ç”¨ç¥ä¸º{wx}ï¼Œå»ºè®®ï¼š")
                    sep = 'ã€'
                    remedy_lines.append(f"    1. é¢œè‰²è°ƒæ•´ï¼šæ—¥å¸¸ç©¿ç€ä»¥{sep.join(info['colors'])}ä¸ºä¸»ï¼Œå¢å¼ºè¿åŠ¿")
                    remedy_lines.append(f"    2. æ–¹ä½è°ƒæ•´ï¼šå§å®¤ã€åŠå…¬å®¤æœå‘{sep.join(info['positions'])}ï¼Œæœ‰åŠ©äºå‘æŒ¥æ‰èƒ½")
                    remedy_lines.append(f"    3. é…é¥°å»ºè®®ï¼šä½©æˆ´{sep.join(info['accessories'][:3])}ï¼Œå¢å¼ºç”¨ç¥åŠ›é‡")
                    remedy_lines.append(f"    4. èŒä¸šé€‰æ‹©ï¼šå®œä»äº‹{sep.join(info['professions'])}ç­‰è¡Œä¸šï¼Œå‘æŒ¥ä¼˜åŠ¿")
                    remedy_lines.append(f"    5. ç”Ÿæ´»ä¹ æƒ¯ï¼š{sep.join(info['activities'])}ï¼Œæœ‰åŠ©äºå¹³è¡¡äº”è¡Œ")
        
        # 4. å–œç¥è¡¥å¼ºï¼ˆæ¬¡é‡ç‚¹ï¼‰
        if xishen_wuxing:
            # é¿å…ä¸ç”¨ç¥é‡å¤
            xishen_filtered = [wx for wx in xishen_wuxing if wx not in yongshen_wuxing]
            if xishen_filtered:
                remedy_lines.append("\nã€å–œç¥è¡¥å¼ºã€‘ï¼ˆæ¬¡é‡ç‚¹ï¼Œè¾…åŠ©ç”¨ç¥ï¼‰")
                for wx in xishen_filtered:
                    if wx in wuxing_remedy_map:
                        info = wuxing_remedy_map[wx]
                        colors = 'ã€'.join(info['colors'])
                        positions = 'ã€'.join(info['positions'])
                        remedy_lines.append(f"  â€¢ å–œç¥ä¸º{wx}ï¼šå¯é€‚å½“ä½¿ç”¨{colors}è‰²ç³»ï¼Œé€‰æ‹©{positions}æ–¹ä½ï¼Œæœ‰åŠ©äºæå‡è¿åŠ¿")
        
        # 5. æ ¹æ®æ ¼å±€å’Œåç¥æä¾›ç‰¹æ®Šå»ºè®®ï¼ˆâœ… ä¿®å¤ï¼šåŠ¨æ€ç”Ÿæˆï¼Œé¿å…ç¡¬ç¼–ç ï¼‰
        if pattern_info:
            pattern_type = pattern_info.get('pattern_type', '')
            if 'ä¼¤å®˜é…å°' in pattern_type or 'ä¼¤å®˜æ ¼' in pattern_type:
                # ä¼¤å®˜é…å°æ ¼ï¼šæ ¹æ®å®é™…ç”¨ç¥åŠ¨æ€ç”Ÿæˆå»ºè®®
                if yongshen_wuxing:
                    remedy_lines.append("\nã€æ ¼å±€ç‰¹æ®Šå»ºè®®ã€‘")
                    yongshen_str = ''.join(yongshen_wuxing)
                    remedy_lines.append(f"  â€¢ ä¼¤å®˜é…å°æ ¼ï¼šéœ€è¦{yongshen_str}è°ƒå€™")

                    # æ ¹æ®ç”¨ç¥åŠ¨æ€ç”Ÿæˆå»ºè®®
                    yongshen_elements = []
                    for wx in yongshen_wuxing:
                        if wx in wuxing_remedy_map:
                            colors = wuxing_remedy_map[wx]['colors']
                            yongshen_elements.append(f"{wx}ï¼ˆ{colors[0]}ï¼‰")

                    if yongshen_elements:
                        elements_str = 'ã€'.join(yongshen_elements)
                        remedy_lines.append(f"  â€¢ å»ºè®®ï¼šå¤šæ¥è§¦{elements_str}å…ƒç´ ï¼Œé¿å…å¿Œç¥å…ƒç´ è¿‡é‡")

                    remedy_lines.append("  â€¢ å¯é€šè¿‡é˜…è¯»ã€å­¦ä¹ ã€è‰ºæœ¯åˆ›ä½œç­‰æ–¹å¼å‘æŒ¥ä¼¤å®˜æ‰å")
            elif 'å°é‡' in str(pattern_info) or 'åœŸé‡' in str(pattern_info):
                # å°é‡æˆ–åœŸé‡ï¼šæ ¹æ®å®é™…ç”¨ç¥åŠ¨æ€ç”Ÿæˆå»ºè®®
                if yongshen_wuxing:
                    remedy_lines.append("\nã€æ ¼å±€ç‰¹æ®Šå»ºè®®ã€‘")
                    yongshen_str = ''.join(yongshen_wuxing)
                    remedy_lines.append(f"  â€¢ å°æ˜Ÿè¿‡é‡ï¼šéœ€è¦{yongshen_str}æ¥è°ƒç†")
                    remedy_lines.append(f"  â€¢ å»ºè®®ï¼šé‡ç‚¹è¡¥å……{yongshen_str}å…ƒç´ ï¼Œé¿å…åœŸå…ƒç´ ç»§ç»­åŠ é‡")

                    # æ ¹æ®ç”¨ç¥åŠ¨æ€ç”Ÿæˆå…·ä½“å»ºè®®
                    suggestions = []
                    for wx in yongshen_wuxing:
                        if wx == 'æœ¨':
                            suggestions.append("ç»¿è‰²æ¤ç‰©")
                        elif wx == 'æ°´':
                            suggestions.append("æ°´æ™¯")
                        elif wx == 'ç«':
                            suggestions.append("çº¢è‰²è£…é¥°")
                        elif wx == 'é‡‘':
                            suggestions.append("é‡‘å±é¥°å“")

                    if suggestions:
                        remedy_lines.append(f"  â€¢ å¯é€šè¿‡{' '.join(suggestions)}ç­‰æ–¹å¼è°ƒç†")
        
        # 6. æ ¹æ®åç¥ç»“æ„æä¾›å»ºè®®ï¼ˆâœ… ä¿®å¤ï¼šåŠ¨æ€è®¡ç®—è´¢æ˜Ÿå’Œå°æ˜Ÿäº”è¡Œï¼Œé¿å…ç¡¬ç¼–ç ï¼‰
        if ten_gods_detail and day_master:
            from chinese_metaphysics_library.core.constants import TIANGAN_WUXING, WUXING_KE_MAP

            # è·å–æ—¥ä¸»äº”è¡Œ
            day_master_wx = TIANGAN_WUXING.get(day_master, '')

            # è®¡ç®—è´¢æ˜Ÿäº”è¡Œï¼ˆæˆ‘å…‹è€…ä¸ºè´¢ï¼‰
            caixing_wx = WUXING_KE_MAP.get(day_master_wx, '')

            # è®¡ç®—å°æ˜Ÿäº”è¡Œï¼ˆç”Ÿæˆ‘è€…ä¸ºå°ï¼‰
            # äº”è¡Œç›¸ç”Ÿå…³ç³»ï¼šæœ¨ç”Ÿç«ã€ç«ç”ŸåœŸã€åœŸç”Ÿé‡‘ã€é‡‘ç”Ÿæ°´ã€æ°´ç”Ÿæœ¨
            sheng_wo_map = {'æœ¨': 'æ°´', 'ç«': 'æœ¨', 'åœŸ': 'ç«', 'é‡‘': 'åœŸ', 'æ°´': 'é‡‘'}
            yinxing_wx = sheng_wo_map.get(day_master_wx, '')

            shishen_count = {}
            for pos in ['year', 'month', 'hour']:
                if pos in ten_gods_detail:
                    shishen = ten_gods_detail[pos].get('shishen', '')
                    if shishen:
                        shishen_count[shishen] = shishen_count.get(shishen, 0) + 1

            # å¦‚æœå°æ˜Ÿå¤šï¼Œéœ€è¦è´¢æ˜Ÿæ¥ç ´å°
            yin_count = shishen_count.get('æ­£å°', 0) + shishen_count.get('åå°', 0)
            if yin_count >= 2 and caixing_wx:
                if caixing_wx not in jishen_wuxing:  # è´¢æ˜Ÿä¸æ˜¯å¿Œç¥
                    remedy_lines.append("\nã€åç¥ç‰¹æ®Šå»ºè®®ã€‘")
                    remedy_lines.append(f"  â€¢ å°æ˜Ÿè¾ƒå¤šï¼šå¯ç”¨è´¢æ˜Ÿï¼ˆ{caixing_wx}ï¼‰æ¥ç ´å°ï¼Œå¹³è¡¡æ ¼å±€")
                    remedy_lines.append(f"  â€¢ å»ºè®®ï¼šé€‚å½“è¡¥å……{caixing_wx}å…ƒç´ ï¼Œé€šè¿‡è´¢æ˜Ÿç ´å°ï¼Œæ¿€å‘æ´»åŠ›")

            # å¦‚æœä¼¤å®˜å¤šï¼Œéœ€è¦å°æ˜Ÿæ¥åˆ¶ä¼¤å®˜
            shangguan_count = shishen_count.get('ä¼¤å®˜', 0)
            if shangguan_count >= 1 and yinxing_wx:
                if yinxing_wx not in jishen_wuxing and yin_count < 2:  # å°æ˜Ÿä¸æ˜¯å¿Œç¥ï¼Œä¸”å°æ˜Ÿä¸è¿‡é‡
                    remedy_lines.append("\nã€åç¥ç‰¹æ®Šå»ºè®®ã€‘")
                    remedy_lines.append(f"  â€¢ ä¼¤å®˜é€å‡ºï¼šå¯ç”¨å°æ˜Ÿï¼ˆ{yinxing_wx}ï¼‰æ¥åˆ¶ä¼¤å®˜ï¼Œå¹³è¡¡æ ¼å±€")
                    remedy_lines.append(f"  â€¢ æ³¨æ„ï¼šå¦‚æœå°æ˜Ÿå·²ç»è¿‡é‡ï¼Œåˆ™ä¸å®œå†è¡¥{yinxing_wx}")
        
        # 7. å¦‚æœæ²¡æœ‰ä»»ä½•éœ€è¦è¡¥æ•‘çš„ï¼Œè¯´æ˜äº”è¡Œå¹³è¡¡
        if not remedy_lines:
            remedy_lines.append("äº”è¡Œå¹³è¡¡ï¼Œæ— éœ€ç‰¹åˆ«è¡¥æ•‘")
            remedy_lines.append("å‘½å±€äº”è¡Œåˆ†å¸ƒè¾ƒä¸ºå‡è¡¡ï¼Œå¯é€šè¿‡æ—¥å¸¸è°ƒå…»ä¿æŒå¹³è¡¡çŠ¶æ€")
        
        # æ·»åŠ ç»å…¸ä¾æ®
        if remedy_lines and "äº”è¡Œå¹³è¡¡" not in remedy_lines[0]:
            remedy_lines.append("\nç»å…¸ä¾æ®ï¼šã€Šç©·é€šå®é‰´ã€‹äº”è¡Œè°ƒå€™ã€ã€Šæ»´å¤©é«“ã€‹äº”è¡Œå¹³è¡¡ã€ã€Šå­å¹³çœŸè¯ ã€‹ç”¨ç¥è¡¥å¼º")
        
        return "\n".join(remedy_lines)


    def calculate_wuxing_distribution_core(self, pillars, tiangan_wuxing, dizhi_info):
        """è®¡ç®—äº”è¡Œåˆ†å¸ƒ - æ ¸å¿ƒç‰ˆæœ¬ï¼ˆä¸ä¾èµ–bazi_resultï¼‰"""
        if CLASSIC_ANALYZER_AVAILABLE:
            try:
                distribution = compute_wuxing_distribution(pillars)
                return {k: round(v, 2) for k, v in distribution.items()}
            except Exception as e:
                print(f"âš ï¸ ç»å…¸äº”è¡Œåˆ†å¸ƒè®¡ç®—å¤±è´¥ï¼Œä½¿ç”¨å¤‡é€‰ç®—æ³•ï¼š{e}")

        # å…œåº•ï¼šæ—§é€»è¾‘ï¼ˆä¸åŒºåˆ†è—å¹²æƒé‡ï¼Œä»…åšå¤‡æ´ï¼‰
        wuxing_count = {'æœ¨': 0.0, 'ç«': 0.0, 'åœŸ': 0.0, 'é‡‘': 0.0, 'æ°´': 0.0}

        for _, (tg, dz) in pillars.items():
            tg_element = tiangan_wuxing[tg]['element']
            wuxing_count[tg_element] += 1.0
            for canggan in dizhi_info[dz]['canggan']:
                canggan_element = tiangan_wuxing[canggan]['element']
                wuxing_count[canggan_element] += 1.0

        return {k: round(v, 2) for k, v in wuxing_count.items()}
    def analyze_personality(self, day_master, wuxing, gender):
        """åˆ†ææ€§æ ¼ç‰¹å¾"""
        wuxing_type = self.get_wuxing_by_tiangan(day_master)
        personality_traits = {
            'æœ¨': "æ€§æ ¼ç‰¹ç‚¹ï¼šä»æ…ˆå–„è‰¯ï¼Œå¯Œæœ‰åŒæƒ…å¿ƒï¼Œå…·æœ‰å‘ä¸Šå‘å±•çš„ç²¾ç¥ã€‚\nä¼˜ç‚¹ï¼šæ­£ç›´è¯šå®ï¼Œæœ‰è´£ä»»æ„Ÿï¼Œå–„äºåˆä½œã€‚\nç¼ºç‚¹ï¼šæœ‰æ—¶è¿‡äºç†æƒ³åŒ–ï¼Œå®¹æ˜“å—ä»–äººå½±å“ã€‚",
            'ç«': "æ€§æ ¼ç‰¹ç‚¹ï¼šçƒ­æƒ…å¼€æœ—ï¼Œç§¯æä¸»åŠ¨ï¼Œå¯Œæœ‰åˆ›é€ åŠ›å’Œè¡¨ç°æ¬²ã€‚\nä¼˜ç‚¹ï¼šèªæ˜æœºæ™ºï¼Œå–„äºäº¤é™…ï¼Œæœ‰é¢†å¯¼æ‰èƒ½ã€‚\nç¼ºç‚¹ï¼šå®¹æ˜“æ€¥èºï¼Œç¼ºä¹è€å¿ƒï¼Œæœ‰æ—¶è¿‡äºå†²åŠ¨ã€‚",
            'åœŸ': "æ€§æ ¼ç‰¹ç‚¹ï¼šç¨³é‡è¸å®ï¼Œè¯šå®å®ˆä¿¡ï¼Œå…·æœ‰åŒ…å®¹å¿ƒå’Œè´£ä»»æ„Ÿã€‚\nä¼˜ç‚¹ï¼šå‹¤åŠ³åŠ¡å®ï¼Œå€¼å¾—ä¿¡èµ–ï¼Œå–„äºç†è´¢ã€‚\nç¼ºç‚¹ï¼šæœ‰æ—¶è¿‡äºä¿å®ˆï¼Œç¼ºä¹å˜é€šèƒ½åŠ›ã€‚",
            'é‡‘': "æ€§æ ¼ç‰¹ç‚¹ï¼šæ„å¿—åšå¼ºï¼Œæœæ–­å†³ç»ï¼Œå…·æœ‰æ­£ä¹‰æ„Ÿå’ŒåŸåˆ™æ€§ã€‚\nä¼˜ç‚¹ï¼šç»„ç»‡èƒ½åŠ›å¼ºï¼Œåšäº‹æœ‰æ¡ç†ï¼Œè¿½æ±‚å®Œç¾ã€‚\nç¼ºç‚¹ï¼šæœ‰æ—¶è¿‡äºä¸¥å‰ï¼Œä¸å¤Ÿçµæ´»å˜é€šã€‚",
            'æ°´': "æ€§æ ¼ç‰¹ç‚¹ï¼šèªæ˜æ™ºæ…§ï¼Œå–„äºæ€è€ƒï¼Œå…·æœ‰å¾ˆå¼ºçš„é€‚åº”èƒ½åŠ›ã€‚\nä¼˜ç‚¹ï¼šæœºæ™ºçµæ´»ï¼Œå–„äºå­¦ä¹ ï¼Œæœ‰å¾ˆå¥½çš„ç›´è§‰ã€‚\nç¼ºç‚¹ï¼šæœ‰æ—¶è¿‡äºå¤šå˜ï¼Œç¼ºä¹æŒç»­æ€§ã€‚"
        }
        base_trait = personality_traits.get(wuxing_type, "æ€§æ ¼ç‰¹å¾åˆ†æä¸­...")
        # æ ¹æ®äº”è¡Œå¼ºå¼±è°ƒæ•´
        total_count = sum(wuxing.values())
        if total_count > 0:
            dominant_element = max(wuxing, key=wuxing.get)
            if wuxing[dominant_element] >= 3:
                base_trait += f"\n\näº”è¡Œåæ—ºï¼š{dominant_element}æ—ºï¼Œéœ€è¦é€‚å½“å…‹åˆ¶ï¼Œé¿å…è¿‡åº¦å‘å±•ç›¸å…³ç‰¹è´¨ã€‚"
            weak_elements = [k for k, v in wuxing.items() if v == 0]
            if weak_elements:
                base_trait += f"\näº”è¡Œåå¼±ï¼š{', '.join(weak_elements)}å¼±ï¼Œå»ºè®®é€šè¿‡é¢œè‰²ã€æ–¹ä½ç­‰æ–¹å¼è¡¥å……ã€‚"
        # æ·»åŠ æ€§åˆ«ç‰¹å®šçš„æ€§æ ¼ç‰¹å¾
        gender_specific = {
            'æœ¨': {
                'ç”·': "\nç”·æ€§ç‰¹è´¨ï¼šå…·æœ‰é¢†å¯¼æ½œè´¨ï¼Œå–„äºå›¢é˜Ÿåˆä½œï¼Œæœ‰å¼ºçƒˆçš„è´£ä»»æ„Ÿã€‚",
                'å¥³': "\nå¥³æ€§ç‰¹è´¨ï¼šæ¸©æŸ”ä½“è´´ï¼Œå–„è§£äººæ„ï¼Œæœ‰è‰ºæœ¯å¤©èµ‹ï¼Œæ³¨é‡å®¶åº­å’Œè°ã€‚"
            },
            'ç«': {
                'ç”·': "\nç”·æ€§ç‰¹è´¨ï¼šæœæ–­å‹‡æ•¢ï¼Œæœ‰é­„åŠ›ï¼Œå–„äºè¡¨è¾¾ï¼Œå…·æœ‰æ„ŸæŸ“åŠ›ã€‚",
                'å¥³': "\nå¥³æ€§ç‰¹è´¨ï¼šæ´»æ³¼å¯çˆ±ï¼Œå–„äºäº¤é™…ï¼Œæœ‰äº²å’ŒåŠ›ï¼Œå¯Œæœ‰åˆ›é€ åŠ›ã€‚"
            },
            'åœŸ': {
                'ç”·': "\nç”·æ€§ç‰¹è´¨ï¼šç¨³é‡å¯é ï¼Œæœ‰è€å¿ƒï¼Œå–„äºç§¯ç´¯ï¼Œå€¼å¾—ä¿¡èµ–ã€‚",
                'å¥³': "\nå¥³æ€§ç‰¹è´¨ï¼šè´¤æƒ æŒå®¶ï¼Œå–„äºç†è´¢ï¼Œæœ‰åŒ…å®¹å¿ƒï¼Œå®¶åº­è§‚å¿µå¼ºã€‚"
            },
            'é‡‘': {
                'ç”·': "\nç”·æ€§ç‰¹è´¨ï¼šæ„å¿—åšå¼ºï¼Œæ‰§è¡ŒåŠ›å¼ºï¼Œæœ‰é¢†å¯¼æ‰èƒ½ï¼ŒåŸåˆ™æ€§å¼ºã€‚",
                'å¥³': "\nå¥³æ€§ç‰¹è´¨ï¼šç‹¬ç«‹è‡ªå¼ºï¼Œæœ‰ä¸»è§ï¼Œåšäº‹è®¤çœŸï¼Œè¿½æ±‚å®Œç¾ã€‚"
            },
            'æ°´': {
                'ç”·': "\nç”·æ€§ç‰¹è´¨ï¼šå–„äºå˜é€šï¼Œæœ‰æ™ºæ…§ï¼Œäººé™…å…³ç³»å¥½ï¼Œé€‚åº”èƒ½åŠ›å¼ºã€‚",
                'å¥³': "\nå¥³æ€§ç‰¹è´¨ï¼šèªæ…§çµåŠ¨ï¼Œå–„è§£äººæ„ï¼Œæœ‰åŒ…å®¹å¿ƒï¼Œæƒ…å•†è¾ƒé«˜ã€‚"
            }
        }
        if wuxing_type in gender_specific and gender in gender_specific[wuxing_type]:
            base_trait += gender_specific[wuxing_type][gender]
        return base_trait
    def analyze_fortune(self, day_master, wuxing, gender):
        """åˆ†æè¿åŠ¿"""
        wuxing_type = self.get_wuxing_by_tiangan(day_master)
        # è¯¦ç»†çš„äº”è¡Œè¿åŠ¿åˆ†æ
        wuxing_details = {
            'æœ¨': {
                'career': "æ•™è‚²åŸ¹è®­ã€æ–‡åŒ–è‰ºæœ¯ã€åŒ»ç–—ä¿å¥ã€å›­æ—ç»¿åŒ–ã€ç¯ä¿äº‹ä¸šã€å‡ºç‰ˆä¼ åª’",
                'wealth': "è´¢è¿å¹³ç¨³ä¸Šå‡ï¼Œé€‚åˆé•¿æœŸæŠ•èµ„ï¼Œæˆ¿äº§ã€è‚¡ç¥¨å‡å¯è€ƒè™‘ï¼Œå¿Œæ€¥åŠŸè¿‘åˆ©",
                'health': "æ³¨æ„è‚èƒ†ä¿å…»ï¼Œå¤šæ¥è§¦å¤§è‡ªç„¶ï¼Œä¿æŒå¿ƒæƒ…èˆ’ç•…ï¼Œé€‚å½“è¿åŠ¨",
                'love': "äººé™…å…³ç³»å’Œè°ï¼Œå®¹æ˜“å¾—åˆ°è´µäººç›¸åŠ©ï¼Œå©šå§»ç¾æ»¡ï¼Œå­å¥³å­é¡º",
                'lucky_color': "ç»¿è‰²ã€é’è‰²",
                'lucky_direction': "ä¸œæ–¹ã€ä¸œå—æ–¹",
                'lucky_number': "3ã€8"
            },
            'ç«': {
                'career': "é”€å”®è¥é”€ã€å¨±ä¹ä¼ åª’ã€è‰ºæœ¯åˆ›ä½œã€é¤é¥®æœåŠ¡ã€èƒ½æºç”µåŠ›ã€åŒ–å·¥è¡Œä¸š",
                'wealth': "è´¢è¿æ³¢åŠ¨è¾ƒå¤§ï¼ŒæŠ•èµ„éœ€è°¨æ…ï¼Œé€‚åˆçŸ­æœŸçµæ´»æ“ä½œï¼Œå¿Œç›²ç›®è·Ÿé£",
                'health': "æ³¨æ„å¿ƒè„è¡€ç®¡ï¼Œé¿å…è¿‡åº¦å…´å¥‹ï¼Œä¿æŒä½œæ¯è§„å¾‹ï¼Œå°‘é£Ÿè¾›è¾£",
                'love': "é­…åŠ›åè¶³ï¼Œå¼‚æ€§ç¼˜ä½³ï¼Œä½†éœ€é˜²æ¡ƒèŠ±åŠ«ï¼Œæ„Ÿæƒ…å®œä¸“ä¸€",
                'lucky_color': "çº¢è‰²ã€ç´«è‰²",
                'lucky_direction': "å—æ–¹",
                'lucky_number': "2ã€7"
            },
            'åœŸ': {
                'career': "ç®¡ç†è¡Œæ”¿ã€æˆ¿åœ°äº§ã€å»ºç­‘å·¥ç¨‹ã€å†œä¸šç§æ¤ã€é‡‘èä¿é™©ã€é™¶ç“·åˆ¶å“",
                'wealth': "è´¢è¿ç¨³å¥ï¼Œé€‚åˆç¨³å¦¥æŠ•èµ„ï¼Œæˆ¿äº§æŠ•èµ„å°¤ä½³ï¼Œå‚¨è“„ç†è´¢ä¸ºä¸»",
                'health': "æ³¨æ„è„¾èƒƒæ¶ˆåŒ–ï¼Œé¥®é£Ÿè§„å¾‹ï¼Œé€‚é‡è¿åŠ¨å¼ºèº«ï¼Œé¿å…è¿‡åº¦åŠ³ç´¯",
                'love': "æ„Ÿæƒ…ä¸“ä¸€ï¼Œå®¶åº­è§‚å¿µé‡ï¼Œæ˜¯å¯é çš„ä¼´ä¾£ï¼Œå©šå§»ç¨³å®š",
                'lucky_color': "é»„è‰²ã€æ£•è‰²",
                'lucky_direction': "ä¸­å¤®ã€è¥¿å—ã€ä¸œåŒ—",
                'lucky_number': "5ã€10"
            },
            'é‡‘': {
                'career': "é‡‘èæŠ•èµ„ã€æœºæ¢°åˆ¶é€ ã€å†›è­¦å¸æ³•ã€ç å®é¦–é¥°ã€é‡‘å±åŠ å·¥ã€æ±½è½¦è¡Œä¸š",
                'wealth': "è´¢è¿è¾ƒæ—ºï¼ŒæŠ•èµ„çœ¼å…‰ç‹¬åˆ°ï¼Œä½†éœ€é˜²è¿‡äºå†’é™©ï¼Œé€‚åˆè´µé‡‘å±æŠ•èµ„",
                'health': "æ³¨æ„è‚ºéƒ¨å‘¼å¸ç³»ç»Ÿï¼Œé¿å…è¿‡åº¦åŠ³ç´¯ï¼Œé€‚å½“æ”¾æ¾ï¼Œæˆ’çƒŸé™é…’",
                'love': "æ€§æ ¼ç›´çˆ½ï¼Œä½†æœ‰æ—¶è¿‡äºä¸¥å‰ï¼Œéœ€è¦åŒ…å®¹ç†è§£ï¼Œæ™šå©šè¾ƒä½³",
                'lucky_color': "ç™½è‰²ã€é‡‘è‰²",
                'lucky_direction': "è¥¿æ–¹ã€è¥¿åŒ—æ–¹",
                'lucky_number': "4ã€9"
            },
            'æ°´': {
                'career': "ç§‘æŠ€ç ”å‘ã€è´¸æ˜“ç‰©æµã€ä¿¡æ¯ä¼ åª’ã€æ—…æ¸¸æœåŠ¡ã€æ°´åˆ©å·¥ç¨‹ã€æ¸”ä¸šå…»æ®–",
                'wealth': "è´¢è¿çµæ´»å¤šå˜ï¼Œé€‚åˆå¤šå…ƒåŒ–æŠ•èµ„ï¼Œå¿Œå­¤æ³¨ä¸€æ·ï¼ŒæµåŠ¨èµ„é‡‘ä¸ºä¸»",
                'health': "æ³¨æ„è‚¾è„æ³Œå°¿ç³»ç»Ÿï¼Œå¤šå–æ°´ï¼Œé¿å…ç†¬å¤œï¼Œä¿æŒå……è¶³ç¡çœ ",
                'love': "æ„Ÿæƒ…ä¸°å¯Œï¼Œä½†æœ‰æ—¶æ‘‡æ‘†ä¸å®šï¼Œéœ€è¦åšå®šä¿¡å¿µï¼Œå¼‚åœ°æ‹è¾ƒå¤š",
                'lucky_color': "é»‘è‰²ã€è“è‰²",
                'lucky_direction': "åŒ—æ–¹",
                'lucky_number': "1ã€6"
            }
        }
        details = wuxing_details.get(wuxing_type, {
            'career': "å»ºè®®å’¨è¯¢ä¸“ä¸šå‘½ç†å¸ˆè¿›è¡Œè¯¦ç»†åˆ†æ",
            'wealth': "å› äººè€Œå¼‚ï¼Œéœ€å…·ä½“åˆ†æå…«å­—ç»„åˆ",
            'health': "ä¿æŒè‰¯å¥½ç”Ÿæ´»ä¹ æƒ¯ï¼Œå®šæœŸä½“æ£€",
            'love': "çœŸè¯šå¾…äººï¼Œè‡ªç„¶æœ‰å¥½è¿",
            'lucky_color': "æ ¹æ®ä¸ªäººå–œç”¨ç¥ç¡®å®š",
            'lucky_direction': "éœ€è¦ä¸“ä¸šåˆ†æ",
            'lucky_number': "å› äººè€Œå¼‚"
        })
        fortune_analysis = f"""ã€äº‹ä¸šè¿åŠ¿ã€‘â˜…â˜…â˜…â˜…â˜†
é€‚åˆè¡Œä¸šï¼š{details['career']}
å‘å±•å»ºè®®ï¼šå‘æŒ¥{wuxing_type}çš„ç‰¹è´¨ä¼˜åŠ¿ï¼Œé€‰æ‹©ç›¸åº”é¢†åŸŸæ·±è€•ç»†ä½œ
ã€è´¢å¯Œè¿åŠ¿ã€‘â˜…â˜…â˜…â˜†â˜†
{details['wealth']}

ã€å¥åº·è¿åŠ¿ã€‘â˜…â˜…â˜…â˜†â˜†
{details['health']}
å…»ç”Ÿè¦ç‚¹ï¼š{wuxing_type}å‘½äººéœ€ç‰¹åˆ«æ³¨æ„ç›¸å…³è„è…‘çš„ä¿å…»
ã€æ„Ÿæƒ…è¿åŠ¿ã€‘â˜…â˜…â˜…â˜…â˜†
{details['love']}
å©šæ‹å»ºè®®ï¼šçœŸè¯šç›¸å¾…ï¼Œç›¸äº’åŒ…å®¹ï¼Œå…±åŒæˆé•¿
ã€å¼€è¿æŒ‡å—ã€‘
å¹¸è¿é¢œè‰²ï¼š{details['lucky_color']}
å‰åˆ©æ–¹ä½ï¼š{details['lucky_direction']}
å¹¸è¿æ•°å­—ï¼š{details['lucky_number']}"""

        # æ ¹æ®äº”è¡Œå¼ºå¼±è°ƒæ•´è¿åŠ¿åˆ†æ
        total_count = sum(wuxing.values()) if wuxing else 8
        if total_count > 0 and wuxing:
            dominant_element = max(wuxing, key=wuxing.get)
            if wuxing[dominant_element] >= 4:
                fortune_analysis += f"\n\nã€äº”è¡Œåæ—ºæé†’ã€‘\n{dominant_element}è¿‡æ—ºï¼Œéœ€è¦é€‚å½“å¹³è¡¡ï¼Œé¿å…è¿‡åº¦å‘å±•ç›¸å…³ç‰¹è´¨ã€‚"
            weak_elements = [k for k, v in wuxing.items() if v == 0]
            if weak_elements:
                fortune_analysis += f"\n\nã€äº”è¡Œè¡¥å……å»ºè®®ã€‘\nç¼º{', '.join(weak_elements)}ï¼Œå»ºè®®é€šè¿‡é¢œè‰²ã€æ–¹ä½ã€é¥®é£Ÿç­‰æ–¹å¼è¡¥å……ã€‚"

        # æ ¹æ®æ€§åˆ«æ·»åŠ ä¸“å±å»ºè®®
        if gender == "ç”·":
            fortune_analysis += f"""
ã€ç”·æ€§ä¸“å±å»ºè®®ã€‘
â€¢ äº‹ä¸šå‘å±•ï¼šä¸»åŠ¨å‡ºå‡»ï¼ŒæŠŠæ¡æœºé‡ï¼Œå»ºç«‹å¹¿æ³›äººè„‰ç½‘ç»œ
â€¢ è´¢å¯Œç®¡ç†ï¼šç†æ€§æŠ•èµ„ï¼Œåˆ†æ•£é£é™©ï¼Œä¸ºå®¶åº­æœªæ¥åšå¥½è§„åˆ’
â€¢ å¥åº·å…»ç”Ÿï¼šæ³¨æ„å·¥ä½œå‹åŠ›ï¼Œé€‚å½“è¿åŠ¨ï¼Œæˆ’çƒŸé™é…’å…»ç”Ÿ
â€¢ æ„Ÿæƒ…å©šå§»ï¼šæ‰¿æ‹…å®¶åº­è´£ä»»ï¼Œå…³çˆ±å¦»å„¿ï¼Œåšå¥½å®¶åº­æ”¯æŸ±"""
        else:
            fortune_analysis += f"""
ã€å¥³æ€§ä¸“å±å»ºè®®ã€‘
â€¢ äº‹ä¸šå‘å±•ï¼šå‘æŒ¥ç»†è‡´ä¼˜åŠ¿ï¼Œæ³¨é‡å›¢é˜Ÿåˆä½œï¼Œå¹³è¡¡å®¶åº­äº‹ä¸š
â€¢ è´¢å¯Œç®¡ç†ï¼šç¨³å¥ç†è´¢ï¼Œæ³¨é‡ä¿éšœï¼Œé€‚å½“å‚¨è“„å’ŒæŠ•èµ„ç†è´¢
â€¢ å¥åº·å…»ç”Ÿï¼šå…³æ³¨å†…åˆ†æ³Œå¥åº·ï¼Œå®šæœŸä½“æ£€ï¼Œä¿æŒå¿ƒæƒ…æ„‰æ‚¦
â€¢ æ„Ÿæƒ…å©šå§»ï¼šæ¸©æŸ”è´¤æƒ ï¼Œç›¸å¤«æ•™å­ï¼Œè¥é€ å’Œè°å®¶åº­æ°›å›´"""
        return fortune_analysis

    def get_improvement_suggestions(self, wuxing, missing_elements=None, weak_elements=None):
        """è·å–æ”¹è¿å»ºè®® - åŸºäºã€Šå‘½ç†å­¦ç²¾è¦ã€‹ç†è®º"""
        suggestions = []
        if missing_elements is None:
            missing_elements = []
        if weak_elements is None:
            weak_elements = []
        # è¯¦ç»†çš„äº”è¡Œè¡¥å……å»ºè®®
        element_suggestions = {
            'æœ¨': {
                'colors': "ç»¿è‰²ã€é’è‰²ã€è“è‰²",
                'directions': "ä¸œæ–¹ã€ä¸œå—æ–¹",
                'materials': "æœ¨è´¨é¥°å“ã€ç¿¡ç¿ ã€ç»¿æ¾çŸ³",
                'activities': "å¤šæ¥è§¦å¤§è‡ªç„¶ã€ç§æ¤èŠ±è‰ã€æ™¨ç»ƒ",
                'foods': "ç»¿è‰²è”¬èœã€é…¸å‘³é£Ÿç‰©ã€è‚è„ç±»",
                'career': "æ•™è‚²ã€æ–‡åŒ–ã€åŒ»ç–—ã€ç¯ä¿è¡Œä¸š",
                'numbers': "3ã€8åŠå…¶ç»„åˆ"
            },
            'ç«': {
                'colors': "çº¢è‰²ã€ç´«è‰²ã€ç²‰è‰²",
                'directions': "å—æ–¹",
                'materials': "çº¢å®çŸ³ã€ç›ç‘™ã€çŠç‘š",
                'activities': "å¤šæ™’å¤ªé˜³ã€è¿åŠ¨ã€ç¤¾äº¤æ´»åŠ¨",
                'foods': "çº¢è‰²é£Ÿç‰©ã€è‹¦å‘³é£Ÿç‰©ã€å¿ƒè„ç±»",
                'career': "é”€å”®ã€å¨±ä¹ã€èƒ½æºã€é¤é¥®è¡Œä¸š",
                'numbers': "2ã€7åŠå…¶ç»„åˆ"
            },
            'åœŸ': {
                'colors': "é»„è‰²ã€æ£•è‰²ã€æ©™è‰²",
                'directions': "ä¸­å¤®ã€è¥¿å—ã€ä¸œåŒ—",
                'materials': "é»„æ°´æ™¶ã€ç¥ç€ã€é™¶ç“·åˆ¶å“",
                'activities': "ç™»å±±ã€å›­è‰ºã€ç¨³å®šè§„å¾‹çš„ç”Ÿæ´»",
                'foods': "é»„è‰²é£Ÿç‰©ã€ç”œå‘³é£Ÿç‰©ã€è„¾èƒƒç±»",
                'career': "æˆ¿åœ°äº§ã€å»ºç­‘ã€å†œä¸šã€ç®¡ç†",
                'numbers': "5ã€10åŠå…¶ç»„åˆ"
            },
            'é‡‘': {
                'colors': "ç™½è‰²ã€é‡‘è‰²ã€é“¶è‰²",
                'directions': "è¥¿æ–¹ã€è¥¿åŒ—æ–¹",
                'materials': "é‡‘é“¶é¥°å“ã€ç™½æ°´æ™¶ã€é’»çŸ³",
                'activities': "é‡‘å±å·¥è‰ºã€æ”¶è—ã€ç†è´¢",
                'foods': "ç™½è‰²é£Ÿç‰©ã€è¾›è¾£é£Ÿç‰©ã€è‚ºè„ç±»",
                'career': "é‡‘èã€æœºæ¢°ã€ç å®ã€æ±½è½¦",
                'numbers': "4ã€9åŠå…¶ç»„åˆ"
            },
            'æ°´': {
                'colors': "é»‘è‰²ã€è“è‰²ã€ç°è‰²",
                'directions': "åŒ—æ–¹",
                'materials': "é»‘æ›œçŸ³ã€è“å®çŸ³ã€çç ",
                'activities': "æ¸¸æ³³ã€æ—…è¡Œã€å­¦ä¹ æ–°çŸ¥è¯†",
                'foods': "é»‘è‰²é£Ÿç‰©ã€å’¸å‘³é£Ÿç‰©ã€è‚¾è„ç±»",
                'career': "ç§‘æŠ€ã€è´¸æ˜“ã€è¿è¾“ã€æ°´åˆ©",
                'numbers': "1ã€6åŠå…¶ç»„åˆ"
            }
        }
        # å¤„ç†ç¼ºå¤±çš„äº”è¡Œ
        if missing_elements:
            suggestions.append("ğŸš¨ äº”è¡Œç¼ºå¤±è¡¥æ•‘æ–¹æ¡ˆï¼š")
            for element in missing_elements:
                if element in element_suggestions:
                    info = element_suggestions[element]
                    suggestions.append(f"\nã€è¡¥{element}æ–¹æ¡ˆã€‘")
                    suggestions.append(f"â€¢ é¢œè‰²ï¼š{info['colors']}")
                    suggestions.append(f"â€¢ æ–¹ä½ï¼š{info['directions']}")
                    suggestions.append(f"â€¢ é¥°å“ï¼š{info['materials']}")
                    suggestions.append(f"â€¢ æ´»åŠ¨ï¼š{info['activities']}")
                    suggestions.append(f"â€¢ é£Ÿç‰©ï¼š{info['foods']}")
                    suggestions.append(f"â€¢ äº‹ä¸šï¼š{info['career']}")
                    suggestions.append(f"â€¢ æ•°å­—ï¼š{info['numbers']}")
        # å¤„ç†åå¼±çš„äº”è¡Œ
        if weak_elements:
            suggestions.append("\nâš ï¸ äº”è¡Œåå¼±è°ƒç†æ–¹æ¡ˆï¼š")
            for element in weak_elements:
                if element in element_suggestions:
                    info = element_suggestions[element]
                    suggestions.append(f"\nã€å¼ºåŒ–{element}æ–¹æ¡ˆã€‘")
                    suggestions.append(f"â€¢ é€‚å½“å¢åŠ {info['colors']}å…ƒç´ ")
                    suggestions.append(f"â€¢ é€‰æ‹©{info['directions']}çš„æˆ¿é—´å±…ä½æˆ–åŠå…¬")
                    suggestions.append(f"â€¢ ä½©æˆ´{info['materials']}")
        # é€šç”¨å»ºè®®
        suggestions.append("\nğŸ“‹ é€šç”¨å¼€è¿å»ºè®®ï¼š")
        suggestions.append("â€¢ ä¿æŒäº”è¡Œå¹³è¡¡ï¼Œä¸å¯è¿‡åº¦è¡¥å……å•ä¸€å…ƒç´ ")
        suggestions.append("â€¢ æ ¹æ®æµå¹´å¤§è¿è°ƒæ•´è¡¥å……é‡ç‚¹")
        suggestions.append("â€¢ é€‰æ‹©ä¸è‡ªèº«äº”è¡Œç›¸é…çš„å±…ä½ç¯å¢ƒ")
        suggestions.append("â€¢ ä»äº‹ç¬¦åˆå‘½ç†çš„èŒä¸šæ›´æ˜“æˆåŠŸ")
        suggestions.append("â€¢ å®šæœŸè°ƒæ•´é£æ°´å¸ƒå±€ï¼Œé¡ºåº”å¤©æ—¶")
        suggestions.append("\nğŸ’¡ æ³¨æ„äº‹é¡¹ï¼š")
        suggestions.append("â€¢ ä»¥ä¸Šå»ºè®®åŸºäºä¼ ç»Ÿå‘½ç†å­¦ç†è®º")
        suggestions.append("â€¢ å…·ä½“åº”ç”¨éœ€ç»“åˆä¸ªäººå®é™…æƒ…å†µ")
        suggestions.append("â€¢ å»ºè®®å’¨è¯¢ä¸“ä¸šå‘½ç†å¸ˆè¿›è¡Œè¯¦ç»†æŒ‡å¯¼")
        return "\n".join(suggestions)
    def analyze_noble_people(self, pillars, day_master):
        """åˆ†æå‘½ä¸­è´µäºº - ä¿®å¤ç‰ˆï¼Œä¸ç¥ç…åˆ†æå®Œå…¨åŒæ­¥"""
        noble_analysis = []
        all_branches = [pillars['year'][1], pillars['month'][1], pillars['day'][1], pillars['hour'][1]]
        all_stems = [pillars['year'][0], pillars['month'][0], pillars['day'][0], pillars['hour'][0]]
        found_nobles = []

        # ğŸ”§ ä¿®å¤ï¼šæ·»åŠ å¤©å¾·è´µäººï¼ˆä¸ç¥ç…åˆ†æå®Œå…¨ä¸€è‡´ï¼‰
        tiande_map = {
            'å­': 'ä¸', 'ä¸‘': 'ä¸', 'å¯…': 'ä¸™', 'å¯': 'ç”²', 'è¾°': 'ç”²',
            'å·³': 'ç™¸', 'åˆ': 'ç™¸', 'æœª': 'å£¬', 'ç”³': 'å£¬', 'é…‰': 'è¾›',
            'æˆŒ': 'è¾›', 'äº¥': 'åºš'
        }
        month_branch = all_branches[1]  # æœˆæ”¯
        if month_branch in tiande_map and tiande_map[month_branch] in all_stems:
            stem = tiande_map[month_branch]
            position = self.get_stem_position(stem, pillars)
            found_nobles.append(f"âœ¨ å¤©å¾·è´µäººåœ¨{position}({stem})")

        # ğŸ”§ ä¿®å¤ï¼šæ·»åŠ æœˆå¾·è´µäººï¼ˆä¸ç¥ç…åˆ†æå®Œå…¨ä¸€è‡´ï¼‰
        yuede_map = {
            'å¯…': 'ä¸™', 'å¯': 'ç”²', 'è¾°': 'ç”²', 'å·³': 'ç™¸', 'åˆ': 'ç™¸',
            'æœª': 'å£¬', 'ç”³': 'å£¬', 'é…‰': 'è¾›', 'æˆŒ': 'è¾›', 'äº¥': 'åºš',
            'å­': 'ä¸', 'ä¸‘': 'ä¸'
        }
        if month_branch in yuede_map and yuede_map[month_branch] in all_stems:
            stem = yuede_map[month_branch]
            position = self.get_stem_position(stem, pillars)
            found_nobles.append(f"âœ¨ æœˆå¾·è´µäººåœ¨{position}({stem})")

        # ğŸ”§ ä¿®å¤ï¼šæ·»åŠ ç¦„ç¥ï¼ˆä¸ç¥ç…åˆ†æå®Œå…¨ä¸€è‡´ï¼‰
        lushen_map = {
            'ç”²': 'å¯…', 'ä¹™': 'å¯', 'ä¸™': 'å·³', 'ä¸': 'åˆ', 'æˆŠ': 'å·³',
            'å·±': 'åˆ', 'åºš': 'ç”³', 'è¾›': 'é…‰', 'å£¬': 'äº¥', 'ç™¸': 'å­'
        }
        if day_master in lushen_map and lushen_map[day_master] in all_branches:
            branch = lushen_map[day_master]
            position = self.get_branch_position(branch, pillars)
            found_nobles.append(f"âœ¨ ç¦„ç¥åœ¨{position}({branch})")

        # å¤©ä¹™è´µäººï¼ˆä¸ç¥ç…åˆ†æå®Œå…¨ä¸€è‡´ï¼‰
        tianyi_map = {
            'ç”²': ['ä¸‘', 'æœª'], 'ä¹™': ['å­', 'ç”³'], 'ä¸™': ['äº¥', 'é…‰'], 'ä¸': ['äº¥', 'é…‰'],
            'æˆŠ': ['ä¸‘', 'æœª'], 'å·±': ['å­', 'ç”³'], 'åºš': ['ä¸‘', 'æœª'], 'è¾›': ['å¯…', 'åˆ'],
            'å£¬': ['å¯', 'å·³'], 'ç™¸': ['å¯', 'å·³']
        }
        if day_master in tianyi_map:
            for branch in tianyi_map[day_master]:
                if branch in all_branches:
                    position = self.get_branch_position(branch, pillars)
                    found_nobles.append(f"âœ¨ å¤©ä¹™è´µäººåœ¨{position}({branch})")

        # ğŸ”§ åˆ é™¤ï¼šæ–‡æ˜Œè´µäººã€å­¦å ‚ã€å¤©ä¹™è´µäººç­‰ä¸åœ¨ç¥ç…åˆ†æä¸­æ˜¾ç¤ºçš„è´µäºº
        # åªä¿ç•™ä¸ç¥ç…åˆ†æå®Œå…¨ä¸€è‡´çš„è´µäººï¼šå¤©å¾·è´µäººã€æœˆå¾·è´µäººã€ç¦„ç¥

        if found_nobles:
            noble_analysis.append("ğŸ¯ å‘½ä¸­è´µäººï¼š")
            noble_analysis.extend(found_nobles)
            noble_analysis.append("")
            # ğŸ”§ ä¿®å¤ï¼šè´µäººä½œç”¨è¯´æ˜ - åªæ˜¾ç¤ºå®é™…å­˜åœ¨çš„è´µäºº
            noble_analysis.append("ğŸ“‹ è´µäººä½œç”¨ï¼š")
            if any("å¤©å¾·è´µäºº" in noble for noble in found_nobles):
                noble_analysis.append("â€¢ å¤©å¾·è´µäººï¼šå¤©å¾·æŠ¤ä½‘ï¼Œé€¢å‡¶åŒ–å‰ï¼Œç¦å¯¿ç»µé•¿")
            if any("æœˆå¾·è´µäºº" in noble for noble in found_nobles):
                noble_analysis.append("â€¢ æœˆå¾·è´µäººï¼šæœˆå¾·ç…§ä¸´ï¼Œå“è¡Œç«¯æ­£ï¼Œç¦ç¦„åŒå…¨")
            if any("ç¦„ç¥" in noble for noble in found_nobles):
                noble_analysis.append("â€¢ ç¦„ç¥ï¼šè¡£é£Ÿæ— å¿§ï¼Œè´¢ç¦„ä¸°åšï¼Œäº‹ä¸šæœ‰æˆ")
            noble_analysis.append("")
            noble_analysis.append("ğŸ¤ è´µäººæ–¹ä½ï¼š")
            noble_analysis.append("â€¢ å¯»æ‰¾è´µäººæ—¶å¯å¤šå¾€ç›¸åº”æ–¹ä½å‘å±•")
            noble_analysis.append("â€¢ ä¸å±ç›¸å¯¹åº”çš„äººå¤šäº¤å¾€")
        else:
            noble_analysis.append("âš ï¸ å‘½ä¸­è´µäººè¾ƒå°‘ï¼Œéœ€è¦ï¼š")
            noble_analysis.append("â€¢ å¤šè¡Œå–„äº‹ï¼Œå¹¿ç»“å–„ç¼˜")
            noble_analysis.append("â€¢ æå‡è‡ªèº«èƒ½åŠ›ï¼Œæˆä¸ºä»–äººè´µäºº")
            noble_analysis.append("â€¢ é€šè¿‡é£æ°´å¸ƒå±€å¢å¼ºè´µäººè¿")
        return "\n".join(noble_analysis)

    def get_branch_position(self, branch, pillars):
        """è·å–åœ°æ”¯åœ¨å››æŸ±ä¸­çš„ä½ç½®"""
        if branch == pillars['year'][1]:
            return "å¹´æŸ±"
        elif branch == pillars['month'][1]:
            return "æœˆæŸ±"
        elif branch == pillars['day'][1]:
            return "æ—¥æŸ±"
        elif branch == pillars['hour'][1]:
            return "æ—¶æŸ±"
        return "æœªçŸ¥"

    def get_stem_position(self, stem, pillars):
        """è·å–å¤©å¹²åœ¨å››æŸ±ä¸­çš„ä½ç½®"""
        if stem == pillars['year'][0]:
            return "å¹´æŸ±"
        elif stem == pillars['month'][0]:
            return "æœˆæŸ±"
        elif stem == pillars['day'][0]:
            return "æ—¥æŸ±"
        elif stem == pillars['hour'][0]:
            return "æ—¶æŸ±"
        return "æœªçŸ¥"
    def get_accessories_suggestions(self, wuxing, day_master):
        """è·å–å¼€è¿é¥°ç‰©å»ºè®®"""
        day_element = self.get_wuxing_by_tiangan(day_master)
        # æ‰¾å‡ºæœ€éœ€è¦è¡¥å……çš„äº”è¡Œ
        min_count = min(wuxing.values())
        weak_elements = [k for k, v in wuxing.items() if v == min_count]
        suggestions = []
        suggestions.append(f"ğŸ¨ æ ¹æ®æ‚¨çš„å…«å­—åˆ†æï¼Œæ—¥ä¸»ä¸º{day_master}({day_element})ï¼š")
        suggestions.append("")
        # ä¸»è¦è¡¥å……å…ƒç´ 
        if weak_elements:
            main_element = weak_elements[0]
            accessories = self.accessories_suggestions.get(main_element, {})
            suggestions.append(f"ğŸ”® ä¸»è¦è¡¥å……{main_element}å…ƒç´ ï¼š")
            suggestions.append(f"â€¢ å¹¸è¿é¢œè‰²ï¼š{', '.join(accessories.get('é¢œè‰²', []))}")
            suggestions.append(f"â€¢ æ¨èæè´¨ï¼š{', '.join(accessories.get('æè´¨', []))}")
            suggestions.append(f"â€¢ å¼€è¿å®çŸ³ï¼š{', '.join(accessories.get('å®çŸ³', []))}")
            suggestions.append(f"â€¢ å‰ç¥¥å½¢çŠ¶ï¼š{', '.join(accessories.get('å½¢çŠ¶', []))}")
            suggestions.append(f"â€¢ å¹¸è¿æ•°å­—ï¼š{', '.join(map(str, accessories.get('æ•°å­—', [])))}")
            suggestions.append("")
        # æ—¥ä¸»æœ¬èº«çš„å¢å¼º
        day_accessories = self.accessories_suggestions.get(day_element, {})
        suggestions.append(f"ğŸ’ å¢å¼º{day_element}å…ƒç´ ï¼ˆæœ¬å‘½ï¼‰ï¼š")
        suggestions.append(f"â€¢ æœ¬å‘½é¢œè‰²ï¼š{', '.join(day_accessories.get('é¢œè‰²', []))}")
        suggestions.append(f"â€¢ æœ¬å‘½å®çŸ³ï¼š{', '.join(day_accessories.get('å®çŸ³', []))}")
        suggestions.append("")
        # å…·ä½“ä½©æˆ´å»ºè®®
        suggestions.append("ğŸ“¿ å…·ä½“ä½©æˆ´å»ºè®®ï¼š")
        suggestions.append("â€¢ æ‰‹é“¾/æ‰‹ä¸²ï¼šå·¦æ‰‹ä½©æˆ´å¸æ”¶æ­£èƒ½é‡")
        suggestions.append("â€¢ é¡¹é“¾/åŠå ï¼šè´´è¿‘å¿ƒè„ï¼Œå¢å¼ºæ°”åœº")
        suggestions.append("â€¢ æˆ’æŒ‡ï¼šæ— åæŒ‡å¢å¼ºæ„Ÿæƒ…ï¼Œé£ŸæŒ‡å¢å¼ºäº‹ä¸š")
        suggestions.append("â€¢ è€³ç¯ï¼šå¥³æ€§ä½©æˆ´å¯å¢å¼ºé­…åŠ›")
        suggestions.append("")
        suggestions.append("âš ï¸ æ³¨æ„äº‹é¡¹ï¼š")
        suggestions.append("â€¢ å¤©ç„¶æè´¨æ•ˆæœæ›´ä½³")
        suggestions.append("â€¢ å®šæœŸå‡€åŒ–ä¿å…»")
        suggestions.append("â€¢ æ ¹æ®å­£èŠ‚å’Œå¿ƒæƒ…è°ƒæ•´")
        return "\n".join(suggestions)
    def get_detailed_fortune(self, pillars, wuxing, _gender):
        """è·å–è¯¦ç»†è¿åŠ¿åˆ†æ"""
        from datetime import datetime
        current_date = datetime.now()
        current_year = current_date.year
        current_month = current_date.month
        current_day = current_date.day
        fortune_text = []
        # å½“å¹´è¿åŠ¿
        year_fortune = self.analyze_year_fortune(current_year, pillars, wuxing)
        fortune_text.append(f"ğŸ“… {current_year}å¹´è¿åŠ¿ï¼š")
        fortune_text.append(year_fortune)
        fortune_text.append("")
        # å½“æœˆè¿åŠ¿
        month_fortune = self.analyze_month_fortune(current_month, pillars, wuxing)
        fortune_text.append(f"ğŸ—“ï¸ {current_month}æœˆè¿åŠ¿ï¼š")
        fortune_text.append(month_fortune)
        fortune_text.append("")
        # å½“æ—¥è¿åŠ¿
        day_fortune = self.analyze_day_fortune(current_day, pillars, wuxing)
        fortune_text.append(f"ğŸ“† ä»Šæ—¥è¿åŠ¿({current_month}æœˆ{current_day}æ—¥)ï¼š")
        fortune_text.append(day_fortune)
        return "\n".join(fortune_text)
    def analyze_year_fortune(self, year, pillars, wuxing):
        """åŸºäºå…«å­—æ•°æ®çš„ä¸ªæ€§åŒ–å¹´è¿åŠ¿åˆ†æ - å¢å¼ºç‰ˆ"""
        try:
            # è®¡ç®—æµå¹´å¹²æ”¯
            year_tg = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'][(year - 4) % 10]
            year_dz = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'][(year - 4) % 12]

            # è·å–å®Œæ•´å…«å­—ä¿¡æ¯
            day_master = pillars['day'][0]
            day_element = self.get_wuxing_by_tiangan(day_master)
            year_element = self.get_wuxing_by_tiangan(year_tg)

            # è·å–å…«å­—æ ¼å±€ä¿¡æ¯
            bazi_pattern = self.analyze_bazi_pattern(pillars, wuxing)

            analysis = f"ã€{year}å¹´ä¸ªæ€§åŒ–è¿åŠ¿åˆ†æã€‘\n"
            analysis += f"æœ¬å‘½å…«å­—ï¼š{pillars['year'][0]}{pillars['year'][1]} {pillars['month'][0]}{pillars['month'][1]} {pillars['day'][0]}{pillars['day'][1]} {pillars['hour'][0]}{pillars['hour'][1]}\n"
            analysis += f"æµå¹´å¹²æ”¯ï¼š{year_tg}{year_dz}\n"
            analysis += f"æ—¥ä¸»ï¼š{day_master}ï¼ˆ{day_element}ï¼‰\n"
            analysis += f"å‘½æ ¼ï¼š{bazi_pattern}\n\n"

            # 1. æ·±åº¦å¤ªå²å…³ç³»åˆ†æ
            year_branch = year_dz
            day_branch = pillars['day'][1]
            taisui_analysis = self.analyze_taisui_comprehensive(year_branch, pillars)
            analysis += f"ã€å¤ªå²å…³ç³»æ·±åº¦åˆ†æã€‘\n{taisui_analysis}\n\n"

            # 2. æµå¹´ä¸æ•´ä¸ªå…«å­—çš„ç»¼åˆä½œç”¨
            comprehensive_relation = self.analyze_year_comprehensive_relation(year_tg, year_dz, pillars, wuxing)
            analysis += f"ã€æµå¹´ç»¼åˆä½œç”¨ã€‘\n{comprehensive_relation}\n\n"

            # 3. ä¸ªæ€§åŒ–äº”è¡Œæ—ºè¡°åˆ†æ
            personalized_wuxing = self.analyze_personalized_wuxing_year(year_tg, year_dz, pillars, wuxing)
            analysis += f"ã€ä¸ªæ€§åŒ–äº”è¡Œåˆ†æã€‘\n{personalized_wuxing}\n\n"

            # 4. åŸºäºå…«å­—æ ¼å±€çš„è¿åŠ¿è¯„çº§
            fortune_level = self.calculate_personalized_fortune_level(year_tg, year_dz, pillars, wuxing, bazi_pattern)
            analysis += f"ã€è¿åŠ¿è¯„çº§ã€‘{fortune_level}\n\n"

            # 5. ä¸ªæ€§åŒ–è¡Œäº‹å»ºè®®
            personalized_advice = self.get_personalized_year_advice(year_tg, year_dz, pillars, wuxing, bazi_pattern)
            analysis += f"ã€ä¸ªæ€§åŒ–å»ºè®®ã€‘\n{personalized_advice}\n\n"

            # 6. é‡è¦æ—¶é—´èŠ‚ç‚¹æé†’
            important_periods = self.get_year_important_periods(year, year_tg, year_dz, pillars)
            analysis += f"ã€é‡è¦æ—¶é—´èŠ‚ç‚¹ã€‘\n{important_periods}\n"

            return analysis

        except Exception as e:
            return f"ã€{year}å¹´è¿åŠ¿ã€‘\nâš ï¸ åˆ†æå‡ºé”™ï¼š{str(e)}"

    def analyze_bazi_pattern(self, pillars, wuxing):
        """åˆ†æå…«å­—æ ¼å±€"""
        try:
            day_master = pillars['day'][0]
            day_element = self.get_wuxing_by_tiangan(day_master)

            # ç®€åŒ–çš„æ ¼å±€åˆ¤æ–­
            total_count = sum(wuxing.values())
            if total_count == 0:
                return "æ ¼å±€å¾…å®š"

            # åˆ¤æ–­æ—¥ä¸»å¼ºå¼±
            day_element_count = wuxing.get(day_element, 0)
            if day_element_count >= 3:
                strength = "åå¼º"
            elif day_element_count >= 2:
                strength = "ä¸­å’Œ"
            else:
                strength = "åå¼±"

            # æ‰¾å‡ºæœ€æ—ºçš„äº”è¡Œ
            dominant_element = max(wuxing, key=wuxing.get) if wuxing else day_element

            return f"{day_element}æ—¥ä¸»{strength}ï¼Œ{dominant_element}æ°”è¾ƒæ—º"
        except:
            return "æ™®é€šæ ¼å±€"

    def analyze_taisui_comprehensive(self, year_branch, pillars):
        """ç»¼åˆå¤ªå²å…³ç³»åˆ†æ"""
        try:
            analysis = []

            # ä¸å„æŸ±åœ°æ”¯çš„å…³ç³»
            for position, (tg, dz) in pillars.items():
                if year_branch == dz:
                    analysis.append(f"âœ… å¤ªå²{year_branch}ä¸{position}æ”¯ç›¸åŒï¼Œ{position}å®«å¾—åŠ›")
                elif self.is_chong_relation(year_branch, dz):
                    analysis.append(f"âš ï¸ å¤ªå²{year_branch}å†²{position}æ”¯{dz}ï¼Œ{position}å®«æœ‰å˜åŠ¨")
                elif self.is_he_relation(year_branch, dz):
                    analysis.append(f"âœ… å¤ªå²{year_branch}åˆ{position}æ”¯{dz}ï¼Œ{position}å®«å’Œè°")

            if not analysis:
                analysis.append(f"å¤ªå²{year_branch}ä¸å…«å­—åœ°æ”¯å…³ç³»å¹³å’Œ")

            return "\n".join(analysis)
        except:
            return "å¤ªå²å…³ç³»åˆ†æå‡ºé”™"

    def analyze_year_comprehensive_relation(self, year_tg, year_dz, pillars, wuxing):
        """æµå¹´ä¸å…«å­—çš„ç»¼åˆä½œç”¨åˆ†æ"""
        try:
            analysis = []
            day_master = pillars['day'][0]

            # æµå¹´å¤©å¹²ä¸æ—¥ä¸»å…³ç³»
            ten_god = self.get_ten_god_relation(year_tg, day_master, self.get_tiangan_wuxing_info())
            analysis.append(f"æµå¹´å¤©å¹²{year_tg}ä¸ºæ—¥ä¸»{day_master}çš„{ten_god}")

            # æµå¹´åœ°æ”¯ä¸æ—¥æ”¯å…³ç³»
            day_branch = pillars['day'][1]
            if year_dz == day_branch:
                analysis.append(f"æµå¹´åœ°æ”¯{year_dz}ä¸æ—¥æ”¯ç›¸åŒï¼Œæœ¬å¹´è‡ªæˆ‘æ„è¯†å¼º")
            elif self.is_chong_relation(year_dz, day_branch):
                analysis.append(f"æµå¹´åœ°æ”¯{year_dz}å†²æ—¥æ”¯{day_branch}ï¼Œæœ¬å¹´å˜åŠ¨è¾ƒå¤§")
            else:
                analysis.append(f"æµå¹´åœ°æ”¯{year_dz}ä¸æ—¥æ”¯{day_branch}å…³ç³»å¹³å’Œ")

            return "\n".join(analysis)
        except:
            return "ç»¼åˆå…³ç³»åˆ†æå‡ºé”™"

    def analyze_personalized_wuxing_year(self, year_tg, year_dz, pillars, wuxing):
        """ä¸ªæ€§åŒ–äº”è¡Œåˆ†æ"""
        try:
            analysis = []
            day_master = pillars['day'][0]
            day_element = self.get_wuxing_by_tiangan(day_master)

            # åˆ†ææœ¬å‘½äº”è¡Œå¼ºå¼±
            total = sum(wuxing.values()) if wuxing else 8
            analysis.append("æœ¬å‘½äº”è¡Œåˆ†å¸ƒï¼š")
            for element, count in wuxing.items():
                percentage = (count / total) * 100 if total > 0 else 0
                if percentage >= 30:
                    analysis.append(f"  {element}ï¼š{count}ä¸ª({percentage:.0f}%) - åæ—º")
                elif percentage <= 10:
                    analysis.append(f"  {element}ï¼š{count}ä¸ª({percentage:.0f}%) - åå¼±")
                else:
                    analysis.append(f"  {element}ï¼š{count}ä¸ª({percentage:.0f}%) - é€‚ä¸­")

            # æµå¹´è¡¥ç›Šåˆ†æ
            year_tg_element = self.get_wuxing_by_tiangan(year_tg)
            year_dz_element = self.get_dizhi_wuxing(year_dz)

            weak_elements = [k for k, v in wuxing.items() if v == 0]
            if year_tg_element in weak_elements or year_dz_element in weak_elements:
                analysis.append(f"âœ… æµå¹´è¡¥å……äº†ç¼ºå¤±çš„{year_tg_element}æˆ–{year_dz_element}ï¼Œæœ‰åˆ©å‘å±•")

            return "\n".join(analysis)
        except:
            return "äº”è¡Œåˆ†æå‡ºé”™"

    def calculate_personalized_fortune_level(self, year_tg, year_dz, pillars, wuxing, bazi_pattern):
        """è®¡ç®—ä¸ªæ€§åŒ–è¿åŠ¿ç­‰çº§"""
        try:
            score = 3  # åŸºç¡€3æ˜Ÿ

            day_master = pillars['day'][0]
            day_element = self.get_wuxing_by_tiangan(day_master)
            year_element = self.get_wuxing_by_tiangan(year_tg)

            # æ ¹æ®äº”è¡Œå…³ç³»è°ƒæ•´
            relation = self.get_wuxing_relation(year_element, day_element)
            if relation == "ç›¸ç”Ÿ":
                score += 1
            elif relation == "ç›¸å…‹":
                score -= 1
            elif relation == "è¢«å…‹":
                score += 0.5

            # æ ¹æ®æ ¼å±€è°ƒæ•´
            if "åå¼º" in bazi_pattern and relation == "ç›¸å…‹":
                score += 0.5  # å¼ºå‘½å–œå…‹
            elif "åå¼±" in bazi_pattern and relation == "ç›¸ç”Ÿ":
                score += 0.5  # å¼±å‘½å–œç”Ÿ

            # è½¬æ¢ä¸ºæ˜Ÿçº§
            score = max(1, min(5, score))
            return "â˜…" * int(score) + "â˜†" * (5 - int(score))
        except:
            return "â˜…â˜…â˜…â˜†â˜†"

    def get_personalized_year_advice(self, year_tg, year_dz, pillars, wuxing, bazi_pattern):
        """è·å–ä¸ªæ€§åŒ–å¹´åº¦å»ºè®®"""
        try:
            advice = []
            day_master = pillars['day'][0]
            day_element = self.get_wuxing_by_tiangan(day_master)
            year_element = self.get_wuxing_by_tiangan(year_tg)

            # åŸºäºæ—¥ä¸»ç‰¹ç‚¹çš„å»ºè®®
            day_advice = {
                'ç”²': "å‘æŒ¥å¼€åˆ›ç²¾ç¥ï¼Œé€‚åˆæ–°é¡¹ç›®å¯åŠ¨",
                'ä¹™': "ä»¥æŸ”å…‹åˆšï¼Œé€‚åˆåè°ƒåˆä½œ",
                'ä¸™': "å±•ç°çƒ­æƒ…æ´»åŠ›ï¼Œé€‚åˆå…¬å…³è¥é”€",
                'ä¸': "æ³¨é‡ç»†èŠ‚å“è´¨ï¼Œé€‚åˆç²¾å·¥ç»†ä½œ",
                'æˆŠ': "æ‰¿æ‹…è´£ä»»ï¼Œé€‚åˆç®¡ç†å†³ç­–",
                'å·±': "åŒ…å®¹åè°ƒï¼Œé€‚åˆæœåŠ¡è¡Œä¸š",
                'åºš': "æœæ–­å†³ç­–ï¼Œé€‚åˆå¼€æ‹“è¿›å–",
                'è¾›': "è¿½æ±‚å®Œç¾ï¼Œé€‚åˆåˆ›æ„è®¾è®¡",
                'å£¬': "çµæ´»å˜é€šï¼Œé€‚åˆå­¦ä¹ äº¤æµ",
                'ç™¸': "æ·±æ€ç†Ÿè™‘ï¼Œé€‚åˆç ”ç©¶åˆ†æ"
            }

            advice.append(f"ã€æ—¥ä¸»ç‰¹è´¨ã€‘{day_advice.get(day_master, 'å‘æŒ¥ä¸ªäººä¼˜åŠ¿')}")

            # åŸºäºäº”è¡Œå…³ç³»çš„å»ºè®®
            relation = self.get_wuxing_relation(year_element, day_element)
            if relation == "ç›¸ç”Ÿ":
                advice.append("ã€å‘å±•ç­–ç•¥ã€‘ä¸»åŠ¨å‡ºå‡»ï¼ŒæŠŠæ¡æœºé‡ï¼Œé€‚åˆæŠ•èµ„åˆ›ä¸š")
            elif relation == "ç›¸å…‹":
                advice.append("ã€å‘å±•ç­–ç•¥ã€‘ç¨³å¥ä¿å®ˆï¼Œé¿å…å†’é™©ï¼Œé‡è§†å¥åº·å…»ç”Ÿ")
            else:
                advice.append("ã€å‘å±•ç­–ç•¥ã€‘ç¨³æ­¥å‘å±•ï¼Œå›¢é˜Ÿåˆä½œï¼Œç»´æŠ¤äººé™…å…³ç³»")

            # åŸºäºæ ¼å±€çš„å»ºè®®
            if "åå¼º" in bazi_pattern:
                advice.append("ã€æ ¼å±€å»ºè®®ã€‘å‘½æ ¼åå¼ºï¼Œå®œæ³„ç§€å‘æŒ¥ï¼Œå±•ç°æ‰å")
            elif "åå¼±" in bazi_pattern:
                advice.append("ã€æ ¼å±€å»ºè®®ã€‘å‘½æ ¼åå¼±ï¼Œå®œå¾—åŠ©æ‰¶æŒï¼Œå¯»æ±‚åˆä½œ")
            else:
                advice.append("ã€æ ¼å±€å»ºè®®ã€‘å‘½æ ¼ä¸­å’Œï¼Œå®œå¹³è¡¡å‘å±•ï¼Œç¨³ä¸­æ±‚è¿›")

            return "\n".join(advice)
        except:
            return "ä¸ªæ€§åŒ–å»ºè®®ç”Ÿæˆå‡ºé”™"

    def get_year_important_periods(self, year, year_tg, year_dz, pillars):
        """è·å–å¹´åº¦é‡è¦æ—¶é—´èŠ‚ç‚¹"""
        try:
            periods = []
            day_master = pillars['day'][0]

            # åŸºäºæµå¹´å¹²æ”¯çš„é‡è¦æœˆä»½
            important_months = []

            # æµå¹´å¤©å¹²å¯¹åº”çš„æœˆä»½
            tg_months = {
                'ç”²': [2, 8], 'ä¹™': [3, 9], 'ä¸™': [4, 10], 'ä¸': [5, 11],
                'æˆŠ': [6, 12], 'å·±': [1, 7], 'åºš': [2, 8], 'è¾›': [3, 9],
                'å£¬': [4, 10], 'ç™¸': [5, 11]
            }

            if year_tg in tg_months:
                for month in tg_months[year_tg]:
                    periods.append(f"å†œå†{month}æœˆï¼šæµå¹´å¤©å¹²{year_tg}å½“ä»¤ï¼Œé‡è¦å‘å±•æœŸ")

            # åœ°æ”¯å¯¹åº”çš„æœˆä»½
            dz_months = {
                'å­': 11, 'ä¸‘': 12, 'å¯…': 1, 'å¯': 2, 'è¾°': 3, 'å·³': 4,
                'åˆ': 5, 'æœª': 6, 'ç”³': 7, 'é…‰': 8, 'æˆŒ': 9, 'äº¥': 10
            }

            if year_dz in dz_months:
                month = dz_months[year_dz]
                periods.append(f"å†œå†{month}æœˆï¼šæµå¹´åœ°æ”¯{year_dz}å½“ä»¤ï¼Œå…³é”®è½¬æŠ˜æœŸ")

            if not periods:
                periods.append("å…¨å¹´å¹³ç¨³å‘å±•ï¼Œæ— ç‰¹åˆ«çªå‡ºçš„å…³é”®æ—¶æœŸ")

            return "\n".join(periods)
        except:
            return "é‡è¦æ—¶æœŸåˆ†æå‡ºé”™"

    def is_chong_relation(self, branch1, branch2):
        """åˆ¤æ–­åœ°æ”¯ç›¸å†²å…³ç³»"""
        chong_pairs = {
            'å­': 'åˆ', 'åˆ': 'å­', 'ä¸‘': 'æœª', 'æœª': 'ä¸‘',
            'å¯…': 'ç”³', 'ç”³': 'å¯…', 'å¯': 'é…‰', 'é…‰': 'å¯',
            'è¾°': 'æˆŒ', 'æˆŒ': 'è¾°', 'å·³': 'äº¥', 'äº¥': 'å·³'
        }
        return chong_pairs.get(branch1) == branch2

    def is_he_relation(self, branch1, branch2):
        """åˆ¤æ–­åœ°æ”¯ç›¸åˆå…³ç³»"""
        he_pairs = {
            'å­': 'ä¸‘', 'ä¸‘': 'å­', 'å¯…': 'äº¥', 'äº¥': 'å¯…',
            'å¯': 'æˆŒ', 'æˆŒ': 'å¯', 'è¾°': 'é…‰', 'é…‰': 'è¾°',
            'å·³': 'ç”³', 'ç”³': 'å·³', 'åˆ': 'æœª', 'æœª': 'åˆ'
        }
        return he_pairs.get(branch1) == branch2

    def get_dizhi_wuxing(self, dizhi):
        """è·å–åœ°æ”¯äº”è¡Œ"""
        dizhi_wuxing = {
            'å­': 'æ°´', 'äº¥': 'æ°´',
            'å¯…': 'æœ¨', 'å¯': 'æœ¨',
            'å·³': 'ç«', 'åˆ': 'ç«',
            'ç”³': 'é‡‘', 'é…‰': 'é‡‘',
            'è¾°': 'åœŸ', 'æˆŒ': 'åœŸ', 'ä¸‘': 'åœŸ', 'æœª': 'åœŸ'
        }
        return dizhi_wuxing.get(dizhi, 'åœŸ')

    def analyze_taisui_simple(self, year_branch, day_branch):
        """ç®€å•çš„å¤ªå²å…³ç³»åˆ†æ"""
        # åœ°æ”¯ç›¸å†²å…³ç³»
        chong_pairs = {
            'å­': 'åˆ', 'åˆ': 'å­', 'ä¸‘': 'æœª', 'æœª': 'ä¸‘',
            'å¯…': 'ç”³', 'ç”³': 'å¯…', 'å¯': 'é…‰', 'é…‰': 'å¯',
            'è¾°': 'æˆŒ', 'æˆŒ': 'è¾°', 'å·³': 'äº¥', 'äº¥': 'å·³'
        }

        # åœ°æ”¯ç›¸åˆ‘å…³ç³»
        xing_groups = [
            ['å¯…', 'å·³', 'ç”³'],  # æ— æ©ä¹‹åˆ‘
            ['ä¸‘', 'æœª', 'æˆŒ'],  # æƒåŠ¿ä¹‹åˆ‘
            ['å­', 'å¯'],        # æ— ç¤¼ä¹‹åˆ‘
            ['è¾°', 'åˆ', 'é…‰', 'äº¥']  # è‡ªåˆ‘
        ]

        if year_branch == day_branch:
            return f"å¤ªå²{year_branch}ä¸æ—¥æ”¯ç›¸åŒï¼Œå€¼å¤ªå²ï¼Œè¿åŠ¿å˜åŒ–è¾ƒå¤§"
        elif chong_pairs.get(year_branch) == day_branch:
            return f"å¤ªå²{year_branch}å†²æ—¥æ”¯{day_branch}ï¼ŒçŠ¯å¤ªå²ï¼Œéœ€è¦åŒ–è§£"
        else:
            # æ£€æŸ¥ç›¸åˆ‘
            for group in xing_groups:
                if year_branch in group and day_branch in group:
                    return f"å¤ªå²{year_branch}åˆ‘æ—¥æ”¯{day_branch}ï¼Œéœ€è¦æ³¨æ„"

            return f"å¤ªå²{year_branch}ä¸æ—¥æ”¯{day_branch}å…³ç³»å¹³å’Œ"


    def analyze_taisui_relation(self, year_dz, pillars):
        """åˆ†æå¤ªå²å…³ç³»"""
        taisui_analysis = []
        # è·å–å…«å­—ä¸­çš„åœ°æ”¯
        year_branch = pillars['year'][1]
        month_branch = pillars['month'][1]
        day_branch = pillars['day'][1]
        hour_branch = pillars['hour'][1]
        # å¤ªå²å†²å…‹åˆ†æ
        dizhi_list = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥']
        year_dz_index = dizhi_list.index(year_dz)
        # æ£€æŸ¥å†²
        chong_index = (year_dz_index + 6) % 12
        chong_branch = dizhi_list[chong_index]
        if chong_branch in [year_branch, month_branch, day_branch, hour_branch]:
            taisui_analysis.append(f"âš ï¸ çŠ¯å¤ªå²ï¼ˆå†²ï¼‰ï¼šæµå¹´{year_dz}å†²å…«å­—{chong_branch}")
            taisui_analysis.append("å½±å“ï¼šå˜åŠ¨è¾ƒå¤§ï¼Œéœ€è¦è°¨æ…åº”å¯¹å˜åŒ–")
            taisui_analysis.append("åŒ–è§£ï¼šå¯ä½©æˆ´ç›¸åº”æŠ¤èº«ç¬¦ï¼Œå¤šè¡Œå–„äº‹")
        # æ£€æŸ¥åˆ‘
        xing_relations = {
            'å­': ['å¯'], 'å¯': ['å­'],
            'å¯…': ['å·³', 'ç”³'], 'å·³': ['å¯…', 'ç”³'], 'ç”³': ['å¯…', 'å·³'],
            'ä¸‘': ['æˆŒ', 'æœª'], 'æˆŒ': ['ä¸‘', 'æœª'], 'æœª': ['ä¸‘', 'æˆŒ'],
            'è¾°': ['è¾°'], 'åˆ': ['åˆ'], 'é…‰': ['é…‰'], 'äº¥': ['äº¥']
        }
        if year_dz in xing_relations:
            for xing_branch in xing_relations[year_dz]:
                if xing_branch in [year_branch, month_branch, day_branch, hour_branch]:
                    taisui_analysis.append(f"âš ï¸ çŠ¯å¤ªå²ï¼ˆåˆ‘ï¼‰ï¼šæµå¹´{year_dz}åˆ‘å…«å­—{xing_branch}")
                    taisui_analysis.append("å½±å“ï¼šå®¹æ˜“æœ‰æ˜¯éçº çº·ï¼Œäººé™…å…³ç³»ç´§å¼ ")
                    taisui_analysis.append("åŒ–è§£ï¼šä¿æŒä½è°ƒï¼Œé¿å…ä¸äººäº‰æ‰§")
        # æ£€æŸ¥å®³
        hai_relations = {
            'å­': 'æœª', 'ä¸‘': 'åˆ', 'å¯…': 'å·³', 'å¯': 'è¾°',
            'è¾°': 'å¯', 'å·³': 'å¯…', 'åˆ': 'ä¸‘', 'æœª': 'å­',
            'ç”³': 'äº¥', 'é…‰': 'æˆŒ', 'æˆŒ': 'é…‰', 'äº¥': 'ç”³'
        }
        if year_dz in hai_relations:
            hai_branch = hai_relations[year_dz]
            if hai_branch in [year_branch, month_branch, day_branch, hour_branch]:
                taisui_analysis.append(f"âš ï¸ çŠ¯å¤ªå²ï¼ˆå®³ï¼‰ï¼šæµå¹´{year_dz}å®³å…«å­—{hai_branch}")
                taisui_analysis.append("å½±å“ï¼šå®¹æ˜“é‡åˆ°å°äººï¼Œæš—ä¸­é˜»ç¢")
                taisui_analysis.append("åŒ–è§£ï¼šæé«˜è­¦æƒ•ï¼Œè°¨æ…äº¤å‹")
        # å¦‚æœæ²¡æœ‰çŠ¯å¤ªå²
        if not taisui_analysis:
            # æ£€æŸ¥æ˜¯å¦æœ‰åˆ
            he_relations = {
                'å­': 'ä¸‘', 'ä¸‘': 'å­', 'å¯…': 'äº¥', 'äº¥': 'å¯…',
                'å¯': 'æˆŒ', 'æˆŒ': 'å¯', 'è¾°': 'é…‰', 'é…‰': 'è¾°',
                'å·³': 'ç”³', 'ç”³': 'å·³', 'åˆ': 'æœª', 'æœª': 'åˆ'
            }
            if year_dz in he_relations:
                he_branch = he_relations[year_dz]
                if he_branch in [year_branch, month_branch, day_branch, hour_branch]:
                    taisui_analysis.append(f"âœ… å¤ªå²ç›¸åˆï¼šæµå¹´{year_dz}åˆå…«å­—{he_branch}")
                    taisui_analysis.append("å½±å“ï¼šè¿åŠ¿è¾ƒå¥½ï¼Œå®¹æ˜“å¾—åˆ°å¸®åŠ©")
                    taisui_analysis.append("å»ºè®®ï¼šæŠŠæ¡æœºä¼šï¼Œç§¯æå‘å±•")
            if not taisui_analysis:
                taisui_analysis.append(f"âœ… å¤ªå²å¹³å’Œï¼šæµå¹´{year_dz}ä¸å…«å­—æ— ç‰¹æ®Šå…³ç³»")
                taisui_analysis.append("å½±å“ï¼šè¿åŠ¿å¹³ç¨³ï¼ŒæŒ‰éƒ¨å°±ç­")
                taisui_analysis.append("å»ºè®®ï¼šç¨³æ­¥å‘å±•ï¼Œä¸å®œå†’è¿›")
        return "\n".join(taisui_analysis)
    def analyze_complex_dizhi_relations(self, year_dz, pillars):
        """åˆ†æåœ°æ”¯å¤æ‚å…³ç³» - åŸºäºã€Šä¸‰å‘½é€šä¼šã€‹ç†è®º"""
        relations = []
        # è·å–å…«å­—ä¸­çš„æ‰€æœ‰åœ°æ”¯
        bazi_dizhi = [pillars[pos][1] for pos in ['year', 'month', 'day', 'hour']]
        all_dizhi = bazi_dizhi + [year_dz]
        # ä¸‰åˆå±€åˆ†æï¼ˆã€Šä¸‰å‘½é€šä¼šã€‹ç†è®ºï¼‰
        sanhui_relations = self.check_sanhui_relations(all_dizhi)
        if sanhui_relations:
            relations.append("ã€ä¸‰ä¼šå±€ã€‘")
            for relation in sanhui_relations:
                relations.append(f"â€¢ {relation}")
        # ä¸‰åˆå±€åˆ†æ
        sanhe_relations = self.check_sanhe_relations(all_dizhi)
        if sanhe_relations:
            relations.append("ã€ä¸‰åˆå±€ã€‘")
            for relation in sanhe_relations:
                relations.append(f"â€¢ {relation}")
        # å…­åˆåˆ†æ
        liuhe_relations = self.check_liuhe_relations(all_dizhi)
        if liuhe_relations:
            relations.append("ã€å…­åˆã€‘")
            for relation in liuhe_relations:
                relations.append(f"â€¢ {relation}")
        # ç›¸å†²åˆ†æ
        chong_relations = self.check_chong_relations(all_dizhi)
        if chong_relations:
            relations.append("ã€ç›¸å†²ã€‘")
            for relation in chong_relations:
                relations.append(f"â€¢ {relation}")
        # ç›¸åˆ‘åˆ†æ
        xing_relations = self.check_xing_relations(all_dizhi)
        if xing_relations:
            relations.append("ã€ç›¸åˆ‘ã€‘")
            for relation in xing_relations:
                relations.append(f"â€¢ {relation}")
        # ç›¸å®³åˆ†æ
        hai_relations = self.check_hai_relations(all_dizhi)
        if hai_relations:
            relations.append("ã€ç›¸å®³ã€‘")
            for relation in hai_relations:
                relations.append(f"â€¢ {relation}")
        if not relations:
            relations.append("åœ°æ”¯å…³ç³»å¹³å’Œï¼Œæ— ç‰¹æ®Šå†²åˆå…³ç³»")
        return "\n".join(relations)
    def check_sanhui_relations(self, dizhi_list):
        """æ£€æŸ¥ä¸‰ä¼šå±€å…³ç³»"""
        sanhui_patterns = {
            ('å¯…', 'å¯', 'è¾°'): "å¯…å¯è¾°ä¸‰ä¼šä¸œæ–¹æœ¨å±€ï¼šç”Ÿå‘ä¹‹åŠ›å¼ºï¼Œåˆ©äº‹ä¸šå‘å±•ï¼Œå®œå‘ä¸œæ–¹æ±‚è´¢",
            ('å·³', 'åˆ', 'æœª'): "å·³åˆæœªä¸‰ä¼šå—æ–¹ç«å±€ï¼šçƒ­æƒ…æ´‹æº¢ï¼Œåˆ©åå£°åœ°ä½ï¼Œå®œæ–‡åŒ–äº‹ä¸š",
            ('ç”³', 'é…‰', 'æˆŒ'): "ç”³é…‰æˆŒä¸‰ä¼šè¥¿æ–¹é‡‘å±€ï¼šæ”¶è·ä¸°åšï¼Œåˆ©é‡‘èæŠ•èµ„ï¼Œå®œç†è´¢è§„åˆ’",
            ('äº¥', 'å­', 'ä¸‘'): "äº¥å­ä¸‘ä¸‰ä¼šåŒ—æ–¹æ°´å±€ï¼šæ™ºæ…§æµåŠ¨ï¼Œåˆ©å­¦æœ¯ç ”ç©¶ï¼Œå®œæ•™è‚²åŸ¹è®­"
        }
        relations = []
        for pattern, description in sanhui_patterns.items():
            if all(dz in dizhi_list for dz in pattern):
                relations.append(description)
        return relations
    def check_sanhe_relations(self, dizhi_list):
        """æ£€æŸ¥ä¸‰åˆå±€å…³ç³»"""
        sanhe_patterns = {
            ('ç”³', 'å­', 'è¾°'): "ç”³å­è¾°ä¸‰åˆæ°´å±€ï¼šæ™ºæ…§èšé›†ï¼Œåˆ©å­¦æœ¯äº‹ä¸šï¼Œè´¢æºå¹¿è¿›",
            ('äº¥', 'å¯', 'æœª'): "äº¥å¯æœªä¸‰åˆæœ¨å±€ï¼šç”Ÿæœºå‹ƒå‹ƒï¼Œåˆ©åˆ›ä¸šå‘å±•ï¼Œè´µäººç›¸åŠ©",
            ('å¯…', 'åˆ', 'æˆŒ'): "å¯…åˆæˆŒä¸‰åˆç«å±€ï¼šåå£°æ˜¾è¾¾ï¼Œåˆ©æ–‡åŒ–ä¼ åª’ï¼Œäº‹ä¸šå…´æ—º",
            ('å·³', 'é…‰', 'ä¸‘'): "å·³é…‰ä¸‘ä¸‰åˆé‡‘å±€ï¼šæ”¶è·ä¸°åšï¼Œåˆ©é‡‘èè´¸æ˜“ï¼Œè´¢è¿äº¨é€š"
        }
        relations = []
        for pattern, description in sanhe_patterns.items():
            if all(dz in dizhi_list for dz in pattern):
                relations.append(description)
        return relations
    def check_liuhe_relations(self, dizhi_list):
        """æ£€æŸ¥å…­åˆå…³ç³»"""
        liuhe_patterns = {
            ('å­', 'ä¸‘'): "å­ä¸‘åˆåœŸï¼šç¨³é‡è¸å®ï¼Œåˆ©ä¸åŠ¨äº§æŠ•èµ„",
            ('å¯…', 'äº¥'): "å¯…äº¥åˆæœ¨ï¼šè´µäººç›¸åŠ©ï¼Œåˆ©äººé™…å…³ç³»",
            ('å¯', 'æˆŒ'): "å¯æˆŒåˆç«ï¼šçƒ­æƒ…å¼€æœ—ï¼Œåˆ©ç¤¾äº¤æ´»åŠ¨",
            ('è¾°', 'é…‰'): "è¾°é…‰åˆé‡‘ï¼šç²¾æ˜èƒ½å¹²ï¼Œåˆ©å•†ä¸šç»è¥",
            ('å·³', 'ç”³'): "å·³ç”³åˆæ°´ï¼šæ™ºæ…§çµæ´»ï¼Œåˆ©æŠ€æœ¯åˆ›æ–°",
            ('åˆ', 'æœª'): "åˆæœªåˆåœŸï¼šå’Œè°ç¨³å®šï¼Œåˆ©å›¢é˜Ÿåˆä½œ"
        }
        relations = []
        for (dz1, dz2), description in liuhe_patterns.items():
            if dz1 in dizhi_list and dz2 in dizhi_list:
                relations.append(description)
        return relations
    def check_chong_relations(self, dizhi_list):
        """æ£€æŸ¥ç›¸å†²å…³ç³»"""
        chong_patterns = {
            ('å­', 'åˆ'): "å­åˆç›¸å†²ï¼šå¿ƒè‚¾ä¸äº¤ï¼Œæ³¨æ„å¥åº·ï¼Œé¿å…å†²åŠ¨å†³ç­–",
            ('ä¸‘', 'æœª'): "ä¸‘æœªç›¸å†²ï¼šåœŸåœŸç›¸å†²ï¼Œè„¾èƒƒä¸å’Œï¼Œå®œè°ƒç†é¥®é£Ÿ",
            ('å¯…', 'ç”³'): "å¯…ç”³ç›¸å†²ï¼šé©¿é©¬å†²åŠ¨ï¼Œå¤šæœ‰å˜åŠ¨ï¼Œå®œè°¨æ…å‡ºè¡Œ",
            ('å¯', 'é…‰'): "å¯é…‰ç›¸å†²ï¼šé—¨æˆ·ç›¸å†²ï¼Œæ³¨æ„å®¶å®…å®‰å…¨ï¼Œé˜²å°äºº",
            ('è¾°', 'æˆŒ'): "è¾°æˆŒç›¸å†²ï¼šåç›–ç›¸å†²ï¼Œæ€æƒ³å†²çªï¼Œå®œä¿®èº«å…»æ€§",
            ('å·³', 'äº¥'): "å·³äº¥ç›¸å†²ï¼šé©¿é©¬ç›¸å†²ï¼Œè¿œè¡Œä¸åˆ©ï¼Œé˜²æ„å¤–ä¼¤å®³"
        }
        relations = []
        for (dz1, dz2), description in chong_patterns.items():
            if dz1 in dizhi_list and dz2 in dizhi_list:
                relations.append(description)
        return relations
    def check_xing_relations(self, dizhi_list):
        """æ£€æŸ¥ç›¸åˆ‘å…³ç³»"""
        xing_patterns = {
            ('å¯…', 'å·³', 'ç”³'): "å¯…å·³ç”³ä¸‰åˆ‘ï¼šæ— æ©ä¹‹åˆ‘ï¼Œäººé™…å…³ç³»ç´§å¼ ï¼Œå®œä¿®å¾·è¡Œå–„",
            ('ä¸‘', 'æˆŒ', 'æœª'): "ä¸‘æˆŒæœªä¸‰åˆ‘ï¼šæƒåŠ¿ä¹‹åˆ‘ï¼Œé¿å…æƒå¼ºå‡Œå¼±ï¼Œå®œè°¦é€Šå¾…äºº",
            ('å­', 'å¯'): "å­å¯ç›¸åˆ‘ï¼šæ— ç¤¼ä¹‹åˆ‘ï¼Œæ³¨æ„è¨€è¡Œä¸¾æ­¢ï¼Œé˜²å£èˆŒæ˜¯é",
            ('è¾°', 'è¾°'): "è¾°è¾°è‡ªåˆ‘ï¼šè‡ªæˆ‘åˆ‘å…‹ï¼Œå†…å¿ƒçŸ›ç›¾ï¼Œå®œè°ƒæ•´å¿ƒæ€",
            ('åˆ', 'åˆ'): "åˆåˆè‡ªåˆ‘ï¼šè‡ªæˆ‘åˆ‘å…‹ï¼Œæƒ…ç»ªæ³¢åŠ¨ï¼Œå®œæ§åˆ¶è„¾æ°”",
            ('é…‰', 'é…‰'): "é…‰é…‰è‡ªåˆ‘ï¼šè‡ªæˆ‘åˆ‘å…‹ï¼Œè¿‡äºæŒ‘å‰”ï¼Œå®œå®½å®¹å¾…äºº",
            ('äº¥', 'äº¥'): "äº¥äº¥è‡ªåˆ‘ï¼šè‡ªæˆ‘åˆ‘å…‹ï¼Œæ€è™‘è¿‡åº¦ï¼Œå®œæ”¾æ¾å¿ƒæƒ…"
        }
        relations = []
        for pattern, description in xing_patterns.items():
            if len(pattern) == 3:
                if all(dz in dizhi_list for dz in pattern):
                    relations.append(description)
            else:
                if pattern[0] in dizhi_list and pattern[1] in dizhi_list:
                    relations.append(description)
        return relations
    def check_hai_relations(self, dizhi_list):
        """æ£€æŸ¥ç›¸å®³å…³ç³»"""
        hai_patterns = {
            ('å­', 'æœª'): "å­æœªç›¸å®³ï¼šå°äººæš—å®³ï¼Œé˜²è¢«äººé™·å®³ï¼Œå®œè°¨æ…äº¤å‹",
            ('ä¸‘', 'åˆ'): "ä¸‘åˆç›¸å®³ï¼šæ˜æªæš—ç®­ï¼Œæ³¨æ„ç«äº‰å¯¹æ‰‹ï¼Œé˜²æš—ä¸­ä½¿å",
            ('å¯…', 'å·³'): "å¯…å·³ç›¸å®³ï¼šæ©ä¸­æ‹›æ€¨ï¼Œå¥½å¿ƒåŠåäº‹ï¼Œå®œä¸‰æ€è€Œè¡Œ",
            ('å¯', 'è¾°'): "å¯è¾°ç›¸å®³ï¼šå…„å¼Ÿä¸å’Œï¼Œå®¶åº­çŸ›ç›¾ï¼Œå®œåŒ–è§£çº çº·",
            ('ç”³', 'äº¥'): "ç”³äº¥ç›¸å®³ï¼šè´µäººå˜ä»‡äººï¼Œåˆä½œéœ€è°¨æ…ï¼Œé˜²èƒŒå›",
            ('é…‰', 'æˆŒ'): "é…‰æˆŒç›¸å®³ï¼šé‡‘æˆŒç›¸å®³ï¼ŒæŠ•èµ„éœ€è°¨æ…ï¼Œé˜²è´¢åŠ¡æŸå¤±"
        }
        relations = []
        for (dz1, dz2), description in hai_patterns.items():
            if dz1 in dizhi_list and dz2 in dizhi_list:
                relations.append(description)
        return relations
    def analyze_month_fortune(self, month, pillars, wuxing):
        """åŸºäºå…«å­—æ•°æ®çš„ä¸ªæ€§åŒ–æœˆè¿åŠ¿åˆ†æ - å¢å¼ºç‰ˆ"""
        try:
            day_master = pillars['day'][0]
            day_element = self.get_wuxing_by_tiangan(day_master)

            # è·å–æœˆæŸ±ä¿¡æ¯è¿›è¡Œå¯¹æ¯”
            birth_month_tg = pillars['month'][0]
            birth_month_dz = pillars['month'][1]

            analysis = f"ã€{month}æœˆä¸ªæ€§åŒ–è¿åŠ¿åˆ†æã€‘\n"
            analysis += f"æœ¬å‘½å…«å­—ï¼š{pillars['year'][0]}{pillars['year'][1]} {pillars['month'][0]}{pillars['month'][1]} {pillars['day'][0]}{pillars['day'][1]} {pillars['hour'][0]}{pillars['hour'][1]}\n"
            analysis += f"æ—¥ä¸»ï¼š{day_master}ï¼ˆ{day_element}ï¼‰\n"
            analysis += f"å‡ºç”ŸæœˆæŸ±ï¼š{birth_month_tg}{birth_month_dz}\n\n"

            # è®¡ç®—å½“å‰æœˆçš„å¹²æ”¯ï¼ˆç®€åŒ–è®¡ç®—ï¼‰
            current_month_dz = ['å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥', 'å­', 'ä¸‘'][month-1]
            current_month_element = self.get_dizhi_wuxing(current_month_dz)

            # ä¸ªæ€§åŒ–æœˆä»½åˆ†æ
            analysis += f"ã€å½“æœˆç‰¹å¾ã€‘å†œå†{month}æœˆï¼Œåœ°æ”¯{current_month_dz}ï¼Œäº”è¡Œ{current_month_element}\n"

            # ä¸å‡ºç”Ÿæœˆçš„å…³ç³»
            if current_month_dz == birth_month_dz:
                analysis += f"âœ… å½“æœˆåœ°æ”¯ä¸å‡ºç”Ÿæœˆç›¸åŒï¼Œå›å½’æœ¬æ€§ï¼Œé€‚åˆå‘æŒ¥å¤©èµ‹\n"
            elif self.is_chong_relation(current_month_dz, birth_month_dz):
                analysis += f"âš ï¸ å½“æœˆåœ°æ”¯å†²å‡ºç”Ÿæœˆï¼Œæƒ…ç»ªæ³¢åŠ¨ï¼Œéœ€è¦è°ƒæ•´å¿ƒæ€\n"
            elif self.is_he_relation(current_month_dz, birth_month_dz):
                analysis += f"âœ… å½“æœˆåœ°æ”¯åˆå‡ºç”Ÿæœˆï¼Œå’Œè°é¡ºåˆ©ï¼Œäººé™…å…³ç³»è‰¯å¥½\n"
            else:
                analysis += f"å½“æœˆåœ°æ”¯ä¸å‡ºç”Ÿæœˆå…³ç³»å¹³å’Œï¼ŒæŒ‰éƒ¨å°±ç­å‘å±•\n"

            analysis += "\n"

            # æ·±åº¦äº”è¡Œåˆ†æ
            relation = self.get_wuxing_relation(current_month_element, day_element)
            personal_advice = self.get_personalized_month_advice(month, current_month_dz, pillars, wuxing)

            analysis += f"ã€äº”è¡Œä½œç”¨ã€‘å½“æœˆ{current_month_element}ä¸æ—¥ä¸»{day_element}çš„å…³ç³»ï¼š{relation}\n"

            # ä¸ªæ€§åŒ–è¿åŠ¿è¯„çº§
            fortune_level = self.calculate_month_fortune_level(month, current_month_dz, pillars, wuxing)
            analysis += f"ã€è¿åŠ¿è¯„çº§ã€‘{fortune_level}\n\n"

            # ä¸ªæ€§åŒ–å»ºè®®
            analysis += f"ã€ä¸ªæ€§åŒ–å»ºè®®ã€‘\n{personal_advice}\n\n"

            # æœ¬æœˆé‡ç‚¹å…³æ³¨
            focus_areas = self.get_month_focus_areas(month, current_month_dz, pillars, wuxing)
            analysis += f"ã€æœ¬æœˆé‡ç‚¹ã€‘\n{focus_areas}\n"

            return analysis

        except Exception as e:
            return f"ã€{month}æœˆè¿åŠ¿ã€‘\nâš ï¸ åˆ†æå‡ºé”™ï¼š{str(e)}"

    def get_personalized_month_advice(self, month, month_dz, pillars, wuxing):
        """è·å–ä¸ªæ€§åŒ–æœˆåº¦å»ºè®®"""
        try:
            advice = []
            day_master = pillars['day'][0]
            day_element = self.get_wuxing_by_tiangan(day_master)
            month_element = self.get_dizhi_wuxing(month_dz)

            # åŸºäºæ—¥ä¸»çš„æœˆåº¦ç‰¹è´¨
            day_month_advice = {
                'ç”²': f"{month}æœˆæœ¨æ°”{'æ—ºç››' if month in [2,3] else 'å¹³å’Œ'}ï¼Œé€‚åˆ{'å¼€åˆ›æ–°é¡¹ç›®' if month in [2,3] else 'ç¨³æ­¥å‘å±•'}",
                'ä¹™': f"{month}æœˆé€‚åˆ{'å±•ç°æŸ”éŸ§ç‰¹è´¨' if month in [2,3] else 'å†…æ•›ä¿®å…»'}ï¼Œé‡è§†äººé™…åè°ƒ",
                'ä¸™': f"{month}æœˆç«æ°”{'æ—ºç››' if month in [4,5,6] else 'éœ€è¦è¡¥å……'}ï¼Œ{'ç§¯æè¡¨ç°' if month in [4,5,6] else 'è“„åŠ¿å¾…å‘'}",
                'ä¸': f"{month}æœˆé€‚åˆ{'ç²¾å·¥ç»†ä½œ' if month in [4,5,6] else 'å­¦ä¹ å……ç”µ'}ï¼Œæ³¨é‡å“è´¨æå‡",
                'æˆŠ': f"{month}æœˆåœŸæ°”{'å½“ä»¤' if month in [3,6,9,12] else 'å¹³ç¨³'}ï¼Œé€‚åˆ{'æ‰¿æ‹…é‡ä»»' if month in [3,6,9,12] else 'ç¨³å¥å‘å±•'}",
                'å·±': f"{month}æœˆé€‚åˆ{'åŒ…å®¹åè°ƒ' if month in [3,6,9,12] else 'æœåŠ¡ä»–äºº'}ï¼Œå‘æŒ¥äº²å’ŒåŠ›",
                'åºš': f"{month}æœˆé‡‘æ°”{'æ—ºç››' if month in [7,8,9] else 'éœ€è¦ç§¯ç´¯'}ï¼Œ{'æœæ–­å†³ç­–' if month in [7,8,9] else 'éŸ¬å…‰å…»æ™¦'}",
                'è¾›': f"{month}æœˆé€‚åˆ{'è¿½æ±‚å®Œç¾' if month in [7,8,9] else 'åˆ›æ„è®¾è®¡'}ï¼Œæ³¨é‡ç»†èŠ‚å“è´¨",
                'å£¬': f"{month}æœˆæ°´æ°”{'æ—ºç››' if month in [10,11,12,1] else 'éœ€è¦è¡¥å……'}ï¼Œ{'çµæ´»åº”å˜' if month in [10,11,12,1] else 'å­¦ä¹ äº¤æµ'}",
                'ç™¸': f"{month}æœˆé€‚åˆ{'æ·±åº¦æ€è€ƒ' if month in [10,11,12,1] else 'ç ”ç©¶åˆ†æ'}ï¼Œé‡è§†å†…åœ¨ä¿®å…»"
            }

            advice.append(day_month_advice.get(day_master, f"{month}æœˆé€‚åˆå‘æŒ¥ä¸ªäººç‰¹é•¿"))

            # åŸºäºäº”è¡Œå…³ç³»çš„å»ºè®®
            relation = self.get_wuxing_relation(month_element, day_element)
            if relation == "ç›¸ç”Ÿ":
                advice.append("æœˆä»¤ç”ŸåŠ©æ—¥ä¸»ï¼Œè¿åŠ¿ä¸Šå‡ï¼Œé€‚åˆä¸»åŠ¨å‡ºå‡»ï¼ŒæŠŠæ¡æœºé‡")
            elif relation == "ç›¸å…‹":
                advice.append("æœˆä»¤å…‹åˆ¶æ—¥ä¸»ï¼Œéœ€è¦è°¨æ…è¡Œäº‹ï¼Œé‡è§†å¥åº·ï¼Œé¿å…å†²çª")
            elif relation == "è¢«ç”Ÿ":
                advice.append("æ—¥ä¸»ç”ŸåŠ©æœˆä»¤ï¼Œä»˜å‡ºè¾ƒå¤šï¼Œé€‚åˆå±•ç°æ‰åï¼Œå¸®åŠ©ä»–äºº")
            elif relation == "è¢«å…‹":
                advice.append("æ—¥ä¸»å…‹åˆ¶æœˆä»¤ï¼Œæœ‰æ§åˆ¶åŠ›ï¼Œé€‚åˆç®¡ç†å†³ç­–ï¼Œå¼€æ‹“è¿›å–")
            else:
                advice.append("æ—¥ä¸»ä¸æœˆä»¤åŒæ°”ï¼Œè¿åŠ¿å¹³ç¨³ï¼Œé€‚åˆå›¢é˜Ÿåˆä½œï¼Œç¨³æ­¥å‘å±•")

            return "\n".join(advice)
        except:
            return "ä¸ªæ€§åŒ–å»ºè®®ç”Ÿæˆå‡ºé”™"

    def calculate_month_fortune_level(self, month, month_dz, pillars, wuxing):
        """è®¡ç®—æœˆè¿åŠ¿ç­‰çº§"""
        try:
            score = 3  # åŸºç¡€3æ˜Ÿ

            day_master = pillars['day'][0]
            day_element = self.get_wuxing_by_tiangan(day_master)
            month_element = self.get_dizhi_wuxing(month_dz)
            birth_month_dz = pillars['month'][1]

            # æ ¹æ®äº”è¡Œå…³ç³»è°ƒæ•´
            relation = self.get_wuxing_relation(month_element, day_element)
            if relation == "ç›¸ç”Ÿ":
                score += 1
            elif relation == "ç›¸å…‹":
                score -= 1

            # æ ¹æ®ä¸å‡ºç”Ÿæœˆçš„å…³ç³»è°ƒæ•´
            if month_dz == birth_month_dz:
                score += 0.5  # æœ¬å‘½æœˆä»½
            elif self.is_he_relation(month_dz, birth_month_dz):
                score += 0.3  # ç›¸åˆæœˆä»½
            elif self.is_chong_relation(month_dz, birth_month_dz):
                score -= 0.5  # ç›¸å†²æœˆä»½

            # è½¬æ¢ä¸ºæ˜Ÿçº§
            score = max(1, min(5, score))
            return "â˜…" * int(score) + "â˜†" * (5 - int(score))
        except:
            return "â˜…â˜…â˜…â˜†â˜†"

    def get_month_focus_areas(self, month, month_dz, pillars, wuxing):
        """è·å–æœˆåº¦é‡ç‚¹å…³æ³¨é¢†åŸŸ"""
        try:
            focus = []
            day_master = pillars['day'][0]
            month_element = self.get_dizhi_wuxing(month_dz)

            # åŸºäºæœˆä»½åœ°æ”¯çš„é‡ç‚¹é¢†åŸŸ
            dz_focus = {
                'å¯…': "äº‹ä¸šå¼€åˆ›ã€å¥åº·å…»ç”Ÿã€å®¶åº­å’Œç¦",
                'å¯': "äººé™…å…³ç³»ã€åˆ›æ„è¡¨è¾¾ã€å­¦ä¹ è¿›ä¿®",
                'è¾°': "è´¢åŠ¡ç®¡ç†ã€æŠ•èµ„ç†è´¢ã€åœŸåœ°æˆ¿äº§",
                'å·³': "åå£°åœ°ä½ã€æ–‡åŒ–è‰ºæœ¯ã€å¿ƒè¡€ç®¡å¥åº·",
                'åˆ': "äº‹ä¸šé«˜å³°ã€ç¤¾äº¤æ´»åŠ¨ã€å¿ƒè„ä¿å…»",
                'æœª': "å›¢é˜Ÿåˆä½œã€æœåŠ¡ä»–äººã€è„¾èƒƒè°ƒç†",
                'ç”³': "æŠ€èƒ½æå‡ã€é‡‘èæŠ•èµ„ã€å‘¼å¸ç³»ç»Ÿ",
                'é…‰': "æ”¶è·æˆæœã€å“è´¨æå‡ã€è‚ºéƒ¨ä¿å…»",
                'æˆŒ': "äººè„‰ç§¯ç´¯ã€æ…ˆå–„å…¬ç›Šã€èƒƒéƒ¨å¥åº·",
                'äº¥': "å­¦ä¹ å……ç”µã€ç²¾ç¥ä¿®å…»ã€è‚¾è„ä¿å…»",
                'å­': "æ™ºæ…§å¼€å‘ã€æµåŠ¨æ€§æŠ•èµ„ã€ç”Ÿæ®–ç³»ç»Ÿ",
                'ä¸‘': "åŸºç¡€å»ºè®¾ã€å‚¨è“„ç†è´¢ã€è„¾èƒƒè°ƒå…»"
            }

            focus.append(f"ã€{month_dz}æœˆé‡ç‚¹ã€‘{dz_focus.get(month_dz, 'å…¨é¢å‘å±•')}")

            # åŸºäºä¸ªäººäº”è¡Œç¼ºå¤±çš„è¡¥å……é‡ç‚¹
            weak_elements = [k for k, v in wuxing.items() if v == 0]
            if month_element in weak_elements:
                focus.append(f"ã€äº”è¡Œè¡¥å……ã€‘æœ¬æœˆ{month_element}å½“ä»¤ï¼Œæ­£å¥½è¡¥å……å‘½ä¸­ä¸è¶³")

            return "\n".join(focus)
        except:
            return "é‡ç‚¹é¢†åŸŸåˆ†æå‡ºé”™"


    def analyze_day_fortune(self, day, pillars, wuxing):
        """åŸºäºå…«å­—æ•°æ®çš„ä¸ªæ€§åŒ–æ—¥è¿åŠ¿åˆ†æ - å¢å¼ºç‰ˆ"""
        try:
            day_master = pillars['day'][0]
            day_branch = pillars['day'][1]
            day_element = self.get_wuxing_by_tiangan(day_master)

            analysis = f"ã€ä»Šæ—¥ä¸ªæ€§åŒ–è¿åŠ¿åˆ†æã€‘\n"
            analysis += f"æœ¬å‘½å…«å­—ï¼š{pillars['year'][0]}{pillars['year'][1]} {pillars['month'][0]}{pillars['month'][1]} {pillars['day'][0]}{pillars['day'][1]} {pillars['hour'][0]}{pillars['hour'][1]}\n"
            analysis += f"æ—¥ä¸»ï¼š{day_master}ï¼ˆ{day_element}ï¼‰\n"
            analysis += f"æ—¥æ”¯ï¼š{day_branch}\n\n"

            # åŸºäºçœŸæ­£çš„æ—¥æŸ±åˆ†æï¼Œè€Œéç®€å•çš„æ—¥æœŸæ•°å­—
            day_pillar_analysis = self.analyze_day_pillar_characteristics(day_master, day_branch, pillars, wuxing)
            analysis += f"ã€æ—¥æŸ±ç‰¹å¾ã€‘\n{day_pillar_analysis}\n\n"

            # æ—¥ä¸»ä¸å…¶ä»–æŸ±çš„ä½œç”¨å…³ç³»
            daily_interactions = self.analyze_daily_interactions(day_master, day_branch, pillars)
            analysis += f"ã€ä»Šæ—¥ä½œç”¨å…³ç³»ã€‘\n{daily_interactions}\n\n"

            # ä¸ªæ€§åŒ–è¿åŠ¿è¯„çº§
            fortune_level = self.calculate_daily_fortune_level(day, day_master, day_branch, pillars, wuxing)
            analysis += f"ã€è¿åŠ¿è¯„çº§ã€‘{fortune_level}\n\n"

            # åŸºäºæ—¥ä¸»ç‰¹è´¨çš„ä»Šæ—¥å»ºè®®
            daily_advice = self.get_personalized_daily_advice(day, day_master, day_branch, pillars, wuxing)
            analysis += f"ã€ä¸ªæ€§åŒ–å»ºè®®ã€‘\n{daily_advice}\n\n"

            # ä»Šæ—¥é‡ç‚¹å…³æ³¨
            daily_focus = self.get_daily_focus_areas(day, day_master, day_branch, pillars, wuxing)
            analysis += f"ã€ä»Šæ—¥é‡ç‚¹ã€‘\n{daily_focus}\n"

            return analysis

        except Exception as e:
            return f"ã€ä»Šæ—¥è¿åŠ¿ã€‘\nâš ï¸ åˆ†æå‡ºé”™ï¼š{str(e)}"

    def analyze_day_pillar_characteristics(self, day_master, day_branch, pillars, wuxing):
        """åˆ†ææ—¥æŸ±ç‰¹å¾"""
        try:
            analysis = []
            day_element = self.get_wuxing_by_tiangan(day_master)
            branch_element = self.get_dizhi_wuxing(day_branch)

            # æ—¥å¹²ç‰¹è´¨åˆ†æ
            day_master_traits = {
                'ç”²': "ç”²æœ¨æ—¥ä¸»ï¼Œæ€§æ ¼ç›´çˆ½ï¼Œå…·æœ‰å¼€åˆ›ç²¾ç¥ï¼Œä»Šæ—¥é€‚åˆä¸»åŠ¨å‡ºå‡»",
                'ä¹™': "ä¹™æœ¨æ—¥ä¸»ï¼Œæ€§æ ¼æŸ”éŸ§ï¼Œå–„äºåè°ƒï¼Œä»Šæ—¥é€‚åˆäººé™…äº¤å¾€",
                'ä¸™': "ä¸™ç«æ—¥ä¸»ï¼Œæ€§æ ¼çƒ­æƒ…ï¼Œå¯Œæœ‰è¡¨ç°åŠ›ï¼Œä»Šæ—¥é€‚åˆå±•ç¤ºæ‰å",
                'ä¸': "ä¸ç«æ—¥ä¸»ï¼Œæ€§æ ¼ç»†è…»ï¼Œæ³¨é‡å“è´¨ï¼Œä»Šæ—¥é€‚åˆç²¾å·¥ç»†ä½œ",
                'æˆŠ': "æˆŠåœŸæ—¥ä¸»ï¼Œæ€§æ ¼åšé‡ï¼Œè´£ä»»å¿ƒå¼ºï¼Œä»Šæ—¥é€‚åˆæ‰¿æ‹…é‡ä»»",
                'å·±': "å·±åœŸæ—¥ä¸»ï¼Œæ€§æ ¼æ¸©å’Œï¼Œå–„äºåŒ…å®¹ï¼Œä»Šæ—¥é€‚åˆæœåŠ¡ä»–äºº",
                'åºš': "åºšé‡‘æ—¥ä¸»ï¼Œæ€§æ ¼åˆšæ¯…ï¼Œå†³æ–­åŠ›å¼ºï¼Œä»Šæ—¥é€‚åˆé‡è¦å†³ç­–",
                'è¾›': "è¾›é‡‘æ—¥ä¸»ï¼Œæ€§æ ¼ç²¾è‡´ï¼Œè¿½æ±‚å®Œç¾ï¼Œä»Šæ—¥é€‚åˆåˆ›æ„å·¥ä½œ",
                'å£¬': "å£¬æ°´æ—¥ä¸»ï¼Œæ€§æ ¼çµæ´»ï¼Œæ™ºæ…§è¿‡äººï¼Œä»Šæ—¥é€‚åˆå­¦ä¹ äº¤æµ",
                'ç™¸': "ç™¸æ°´æ—¥ä¸»ï¼Œæ€§æ ¼æ·±æ²‰ï¼Œå–„äºæ€è€ƒï¼Œä»Šæ—¥é€‚åˆç ”ç©¶åˆ†æ"
            }

            analysis.append(day_master_traits.get(day_master, "æ—¥ä¸»ç‰¹è´¨å¾…åˆ†æ"))

            # æ—¥æ”¯ç‰¹è´¨åˆ†æ
            branch_traits = {
                'å­': "å­æ°´æ—¥æ”¯ï¼Œèªæ˜æœºæ™ºï¼Œä»Šæ—¥æ€ç»´æ´»è·ƒï¼Œé€‚åˆç­–åˆ’å†³ç­–",
                'ä¸‘': "ä¸‘åœŸæ—¥æ”¯ï¼Œè¸å®ç¨³é‡ï¼Œä»Šæ—¥é€‚åˆåŸºç¡€å·¥ä½œï¼Œç§¯ç´¯èµ„æº",
                'å¯…': "å¯…æœ¨æ—¥æ”¯ï¼Œç”Ÿæœºå‹ƒå‹ƒï¼Œä»Šæ—¥é€‚åˆå¼€åˆ›æ–°äº‹ä¸šï¼Œå±•ç°æ´»åŠ›",
                'å¯': "å¯æœ¨æ—¥æ”¯ï¼Œæ¸©å’Œæœ‰ç¤¼ï¼Œä»Šæ—¥é€‚åˆç¤¾äº¤åˆä½œï¼Œäººé™…å’Œè°",
                'è¾°': "è¾°åœŸæ—¥æ”¯ï¼ŒåŒ…å®¹åšå¾·ï¼Œä»Šæ—¥é€‚åˆå›¢é˜Ÿåä½œï¼Œæ‰¿æ‹…è´£ä»»",
                'å·³': "å·³ç«æ—¥æ”¯ï¼Œèªæ˜ä¼¶ä¿ï¼Œä»Šæ—¥é€‚åˆæ–‡åŒ–è‰ºæœ¯ï¼Œå±•ç°æ‰å",
                'åˆ': "åˆç«æ—¥æ”¯ï¼Œçƒ­æƒ…å¥”æ”¾ï¼Œä»Šæ—¥é€‚åˆç¤¾äº¤æ´»åŠ¨ï¼Œç§¯æè¡¨ç°",
                'æœª': "æœªåœŸæ—¥æ”¯ï¼Œæ¸©å’Œå–„è‰¯ï¼Œä»Šæ—¥é€‚åˆæœåŠ¡ä»–äººï¼Œæ…ˆå–„å…¬ç›Š",
                'ç”³': "ç”³é‡‘æ—¥æ”¯ï¼Œæœºæ•æœæ–­ï¼Œä»Šæ—¥é€‚åˆå•†åŠ¡è°ˆåˆ¤ï¼ŒæŠ€èƒ½å±•ç¤º",
                'é…‰': "é…‰é‡‘æ—¥æ”¯ï¼Œç²¾æ˜èƒ½å¹²ï¼Œä»Šæ—¥é€‚åˆæ”¶è·æˆæœï¼Œå“è´¨æå‡",
                'æˆŒ': "æˆŒåœŸæ—¥æ”¯ï¼Œå¿ è¯šå¯é ï¼Œä»Šæ—¥é€‚åˆäººè„‰ç§¯ç´¯ï¼Œç¨³å›ºåŸºç¡€",
                'äº¥': "äº¥æ°´æ—¥æ”¯ï¼Œæ™ºæ…§æ·±æ²‰ï¼Œä»Šæ—¥é€‚åˆå­¦ä¹ å……ç”µï¼Œç²¾ç¥ä¿®å…»"
            }

            analysis.append(branch_traits.get(day_branch, "æ—¥æ”¯ç‰¹è´¨å¾…åˆ†æ"))

            # å¹²æ”¯é…åˆåˆ†æ
            gan_zhi_relation = self.get_wuxing_relation(day_element, branch_element)
            if gan_zhi_relation == "ç›¸ç”Ÿ":
                analysis.append("æ—¥å¹²æ—¥æ”¯ç›¸ç”Ÿï¼Œå†…å¤–å’Œè°ï¼Œä»Šæ—¥èº«å¿ƒçŠ¶æ€è‰¯å¥½")
            elif gan_zhi_relation == "ç›¸å…‹":
                analysis.append("æ—¥å¹²æ—¥æ”¯ç›¸å…‹ï¼Œå†…å¿ƒçŸ›ç›¾ï¼Œä»Šæ—¥éœ€è¦è°ƒèŠ‚å¿ƒæ€")
            else:
                analysis.append("æ—¥å¹²æ—¥æ”¯å…³ç³»å¹³å’Œï¼Œä»Šæ—¥å¿ƒå¢ƒå¹³ç¨³")

            return "\n".join(analysis)
        except:
            return "æ—¥æŸ±ç‰¹å¾åˆ†æå‡ºé”™"

    def analyze_daily_interactions(self, day_master, day_branch, pillars):
        """åˆ†ææ—¥æŸ±ä¸å…¶ä»–æŸ±çš„ä½œç”¨å…³ç³»"""
        try:
            interactions = []

            # ä¸å¹´æŸ±çš„å…³ç³»
            year_tg, year_dz = pillars['year']
            year_relation = self.get_ten_god_relation(year_tg, day_master, self.get_tiangan_wuxing_info())
            interactions.append(f"ä¸å¹´æŸ±å…³ç³»ï¼šå¹´å¹²{year_tg}ä¸º{year_relation}ï¼Œå½±å“é•¿è¾ˆå…³ç³»å’Œäº‹ä¸šæ ¹åŸº")

            # ä¸æœˆæŸ±çš„å…³ç³»
            month_tg, month_dz = pillars['month']
            month_relation = self.get_ten_god_relation(month_tg, day_master, self.get_tiangan_wuxing_info())
            interactions.append(f"ä¸æœˆæŸ±å…³ç³»ï¼šæœˆå¹²{month_tg}ä¸º{month_relation}ï¼Œå½±å“å·¥ä½œç¯å¢ƒå’ŒåŒäº‹å…³ç³»")

            # ä¸æ—¶æŸ±çš„å…³ç³»
            hour_tg, hour_dz = pillars['hour']
            hour_relation = self.get_ten_god_relation(hour_tg, day_master, self.get_tiangan_wuxing_info())
            interactions.append(f"ä¸æ—¶æŸ±å…³ç³»ï¼šæ—¶å¹²{hour_tg}ä¸º{hour_relation}ï¼Œå½±å“ä¸‹å±å…³ç³»å’Œæœªæ¥å‘å±•")

            # åœ°æ”¯å…³ç³»åˆ†æ
            month_dz = pillars['month'][1]
            if self.is_chong_relation(day_branch, month_dz):
                interactions.append("âš ï¸ æ—¥æ”¯å†²æœˆæ”¯ï¼Œä»Šæ—¥æƒ…ç»ªæ³¢åŠ¨ï¼Œéœ€è¦è°ƒèŠ‚å¿ƒæ€")
            elif self.is_he_relation(day_branch, month_dz):
                interactions.append("âœ… æ—¥æ”¯åˆæœˆæ”¯ï¼Œä»Šæ—¥äººé™…å’Œè°ï¼Œé€‚åˆåˆä½œ")

            return "\n".join(interactions)
        except:
            return "ä½œç”¨å…³ç³»åˆ†æå‡ºé”™"

    def calculate_daily_fortune_level(self, day, day_master, day_branch, pillars, wuxing):
        """è®¡ç®—æ—¥è¿åŠ¿ç­‰çº§"""
        try:
            score = 3  # åŸºç¡€3æ˜Ÿ

            day_element = self.get_wuxing_by_tiangan(day_master)

            # æ ¹æ®æ—¥ä¸»åœ¨å…«å­—ä¸­çš„å¼ºå¼±è°ƒæ•´
            day_element_count = wuxing.get(day_element, 0)
            total_count = sum(wuxing.values()) if wuxing else 8

            if total_count > 0:
                day_strength = day_element_count / total_count
                if day_strength >= 0.4:  # æ—¥ä¸»åå¼º
                    score += 0.5
                elif day_strength <= 0.2:  # æ—¥ä¸»åå¼±
                    score -= 0.5

            # æ ¹æ®æ—¥æœŸè°ƒæ•´ï¼ˆä¿ç•™éƒ¨åˆ†ä¼ ç»Ÿæ–¹æ³•ï¼‰
            if 1 <= day <= 15:  # ä¸ŠåŠæœˆ
                score += 0.3
            else:  # ä¸‹åŠæœˆ
                score -= 0.1

            # æ ¹æ®åœ°æ”¯å…³ç³»è°ƒæ•´
            month_dz = pillars['month'][1]
            if self.is_he_relation(day_branch, month_dz):
                score += 0.5
            elif self.is_chong_relation(day_branch, month_dz):
                score -= 0.5

            # è½¬æ¢ä¸ºæ˜Ÿçº§
            score = max(1, min(5, score))
            return "â˜…" * int(score) + "â˜†" * (5 - int(score))
        except:
            return "â˜…â˜…â˜…â˜†â˜†"

    def get_personalized_daily_advice(self, day, day_master, day_branch, pillars, wuxing):
        """è·å–ä¸ªæ€§åŒ–æ—¥åº¦å»ºè®®"""
        try:
            advice = []
            day_element = self.get_wuxing_by_tiangan(day_master)

            # åŸºäºæ—¥ä¸»çš„ä»Šæ—¥å»ºè®®
            daily_master_advice = {
                'ç”²': "å‘æŒ¥å¼€åˆ›ç²¾ç¥ï¼Œä»Šæ—¥é€‚åˆå¯åŠ¨æ–°è®¡åˆ’ï¼Œä¸»åŠ¨å‡ºå‡»",
                'ä¹™': "å±•ç°æŸ”éŸ§ç‰¹è´¨ï¼Œä»Šæ—¥é€‚åˆåè°ƒæ²Ÿé€šï¼ŒåŒ–è§£çŸ›ç›¾",
                'ä¸™': "å‘æŒ¥çƒ­æƒ…æ´»åŠ›ï¼Œä»Šæ—¥é€‚åˆå…¬å…³è¥é”€ï¼Œå±•ç¤ºæ‰å",
                'ä¸': "æ³¨é‡ç»†èŠ‚å“è´¨ï¼Œä»Šæ—¥é€‚åˆç²¾å·¥ç»†ä½œï¼Œè¿½æ±‚å®Œç¾",
                'æˆŠ': "æ‰¿æ‹…æ›´å¤šè´£ä»»ï¼Œä»Šæ—¥é€‚åˆç®¡ç†å†³ç­–ï¼Œç¨³å›ºåŸºç¡€",
                'å·±': "å‘æŒ¥åŒ…å®¹ç‰¹è´¨ï¼Œä»Šæ—¥é€‚åˆæœåŠ¡ä»–äººï¼Œå›¢é˜Ÿåä½œ",
                'åºš': "å±•ç°æœæ–­å†³ç­–ï¼Œä»Šæ—¥é€‚åˆé‡è¦é€‰æ‹©ï¼Œå¼€æ‹“è¿›å–",
                'è¾›': "è¿½æ±‚ç²¾è‡´å®Œç¾ï¼Œä»Šæ—¥é€‚åˆåˆ›æ„è®¾è®¡ï¼Œå“è´¨æå‡",
                'å£¬': "å‘æŒ¥çµæ´»æ™ºæ…§ï¼Œä»Šæ—¥é€‚åˆå­¦ä¹ äº¤æµï¼Œä¿¡æ¯æ”¶é›†",
                'ç™¸': "æ·±åº¦æ€è€ƒåˆ†æï¼Œä»Šæ—¥é€‚åˆç ”ç©¶è§„åˆ’ï¼Œå†…åœ¨ä¿®å…»"
            }

            advice.append(daily_master_advice.get(day_master, "å‘æŒ¥ä¸ªäººç‰¹é•¿"))

            # åŸºäºäº”è¡Œå¼ºå¼±çš„å»ºè®®
            weak_elements = [k for k, v in wuxing.items() if v == 0]
            strong_elements = [k for k, v in wuxing.items() if v >= 3]

            if day_element in weak_elements:
                advice.append(f"æ—¥ä¸»{day_element}åå¼±ï¼Œä»Šæ—¥å®œå¯»æ±‚å¸®åŠ©ï¼Œé¿å…ç‹¬è‡ªæ‰¿æ‹…é‡ä»»")
            elif day_element in strong_elements:
                advice.append(f"æ—¥ä¸»{day_element}åå¼ºï¼Œä»Šæ—¥å®œä¸»åŠ¨å‡ºå‡»ï¼Œå‘æŒ¥é¢†å¯¼ä½œç”¨")
            else:
                advice.append("æ—¥ä¸»å¼ºå¼±é€‚ä¸­ï¼Œä»Šæ—¥å®œå¹³è¡¡å‘å±•ï¼Œç¨³æ­¥å‰è¿›")

            return "\n".join(advice)
        except:
            return "ä¸ªæ€§åŒ–å»ºè®®ç”Ÿæˆå‡ºé”™"

    def get_daily_focus_areas(self, day, day_master, day_branch, pillars, wuxing):
        """è·å–ä»Šæ—¥é‡ç‚¹å…³æ³¨é¢†åŸŸ"""
        try:
            focus = []

            # åŸºäºæ—¥æ”¯çš„é‡ç‚¹å…³æ³¨
            branch_focus = {
                'å­': "æ™ºæ…§å¼€å‘ã€ä¿¡æ¯æ”¶é›†ã€æ°´åˆ©ç›¸å…³",
                'ä¸‘': "åŸºç¡€å»ºè®¾ã€å‚¨è“„ç†è´¢ã€å†œä¸šåœŸåœ°",
                'å¯…': "äº‹ä¸šå¼€åˆ›ã€å¥åº·å…»ç”Ÿã€æœ¨æå›­æ—",
                'å¯': "äººé™…å…³ç³»ã€æ–‡åŒ–è‰ºæœ¯ã€èŠ±è‰æ¤ç‰©",
                'è¾°': "å›¢é˜Ÿåˆä½œã€åœŸåœ°æˆ¿äº§ã€æ°´åº“å»ºè®¾",
                'å·³': "æ–‡åŒ–æ•™è‚²ã€å¿ƒè¡€ç®¡å¥åº·ã€ç«ç”µèƒ½æº",
                'åˆ': "ç¤¾äº¤æ´»åŠ¨ã€å¿ƒè„ä¿å…»ã€å…‰ç”µç§‘æŠ€",
                'æœª': "æœåŠ¡è¡Œä¸šã€è„¾èƒƒè°ƒç†ã€å†œç‰§ä¸š",
                'ç”³': "æŠ€èƒ½æå‡ã€å‘¼å¸ç³»ç»Ÿã€é‡‘å±åŠ å·¥",
                'é…‰': "æ”¶è·æˆæœã€è‚ºéƒ¨ä¿å…»ã€ç å®é¦–é¥°",
                'æˆŒ': "äººè„‰ç§¯ç´¯ã€èƒƒéƒ¨å¥åº·ã€å»ºç­‘å·¥ç¨‹",
                'äº¥': "å­¦ä¹ å……ç”µã€è‚¾è„ä¿å…»ã€æ°´äº§å…»æ®–"
            }

            focus.append(f"ã€æ—¥æ”¯é‡ç‚¹ã€‘{branch_focus.get(day_branch, 'å…¨é¢å‘å±•')}")

            # åŸºäºæ—¥æœŸçš„æ—¶é—´èŠ‚å¾‹
            if day <= 10:
                focus.append("ã€æ—¶é—´èŠ‚å¾‹ã€‘æœˆåˆæ–°æ°”è±¡ï¼Œé€‚åˆåˆ¶å®šè®¡åˆ’ï¼Œå¼€å§‹æ–°é¡¹ç›®")
            elif day <= 20:
                focus.append("ã€æ—¶é—´èŠ‚å¾‹ã€‘æœˆä¸­ç²¾åŠ›æ—ºï¼Œé€‚åˆå…¨åŠ›å†²åˆºï¼Œé‡è¦å†³ç­–")
            else:
                focus.append("ã€æ—¶é—´èŠ‚å¾‹ã€‘æœˆæœ«å®œæ”¶æ•›ï¼Œé€‚åˆæ€»ç»“åæ€ï¼Œå‡†å¤‡ä¸‹æœˆ")

            return "\n".join(focus)
        except:
            return "é‡ç‚¹é¢†åŸŸåˆ†æå‡ºé”™"

    def get_wuxing_relation(self, element1, element2):
        """è·å–äº”è¡Œå…³ç³»"""
        sheng_relations = {
            'æœ¨': 'ç«', 'ç«': 'åœŸ', 'åœŸ': 'é‡‘', 'é‡‘': 'æ°´', 'æ°´': 'æœ¨'
        }
        ke_relations = {
            'æœ¨': 'åœŸ', 'ç«': 'é‡‘', 'åœŸ': 'æ°´', 'é‡‘': 'æœ¨', 'æ°´': 'ç«'
        }
        if sheng_relations.get(element1) == element2:
            return "ç›¸ç”Ÿ"
        elif ke_relations.get(element1) == element2:
            return "ç›¸å…‹"
        elif sheng_relations.get(element2) == element1:
            return "è¢«ç”Ÿ"
        elif ke_relations.get(element2) == element1:
            return "è¢«å…‹"
        else:
            return "å¹³å’Œ"
    def show_daily_fortune_reminder(self):
        """æ˜¾ç¤ºå½“æ—¥è¿åŠ¿æé†’"""
        if not self.current_user_info:
            return
        from datetime import datetime
        current_date = datetime.now()
        # åˆ›å»ºæé†’å¯¹è¯æ¡†
        reminder_dialog = QDialog(None)  # åˆ›å»ºç‹¬ç«‹å¯¹è¯æ¡†
        reminder_dialog.setWindowTitle("ğŸ”® ä»Šæ—¥è¿åŠ¿æé†’")
        reminder_dialog.setFixedSize(400, 300)
        reminder_dialog.setWindowFlags(Qt.Dialog | Qt.WindowStaysOnTopHint)
        layout = QVBoxLayout(reminder_dialog)
        # æ ‡é¢˜
        title_label = QLabel(f"ğŸ“… {current_date.strftime('%Yå¹´%mæœˆ%dæ—¥')} è¿åŠ¿æé†’")
        title_label.setAlignment(Qt.AlignCenter)
        title_label.setStyleSheet("font-size: 16px; font-weight: bold; color: #FFD700; margin: 10px;")
        layout.addWidget(title_label)
        # ç”¨æˆ·ä¿¡æ¯
        user_label = QLabel(f"ğŸ‘¤ {self.current_user_info['name']} ({self.current_user_info['gender']})")
        user_label.setAlignment(Qt.AlignCenter)
        user_label.setStyleSheet("color: #FFD700; margin: 5px;")
        layout.addWidget(user_label)
        # ä»Šæ—¥è¿åŠ¿
        day_fortune = self.analyze_day_fortune(current_date.day, self.current_user_info['pillars'], self.current_user_info['wuxing'])
        fortune_text = QTextEdit()
        fortune_text.setReadOnly(True)
        fortune_text.setText(day_fortune)
        fortune_text.setMaximumHeight(120)
        layout.addWidget(fortune_text)
        # ä»Šæ—¥å»ºè®®
        suggestions = self.get_daily_suggestions(current_date, self.current_user_info)
        suggestion_label = QLabel("ğŸ’¡ ä»Šæ—¥å»ºè®®ï¼š")
        suggestion_label.setStyleSheet("color: #FFD700; font-weight: bold;")
        layout.addWidget(suggestion_label)
        suggestion_text = QLabel(suggestions)
        suggestion_text.setWordWrap(True)
        suggestion_text.setStyleSheet("color: #FFFFFF; margin: 5px;")
        layout.addWidget(suggestion_text)
        # æŒ‰é’®
        button_layout = QHBoxLayout()
        # ä¸å†æé†’ä»Šæ—¥
        no_remind_btn = QPushButton("ä»Šæ—¥ä¸å†æé†’")
        no_remind_btn.clicked.connect(reminder_dialog.accept)
        button_layout.addWidget(no_remind_btn)
        # å…³é—­æŒ‰é’®
        close_btn = QPushButton("çŸ¥é“äº†")
        close_btn.clicked.connect(reminder_dialog.accept)
        button_layout.addWidget(close_btn)
        layout.addLayout(button_layout)
        # åº”ç”¨æ ·å¼
        reminder_dialog.setStyleSheet("""
            QDialog {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
                color: #FFD700;
                font-family: "Microsoft YaHei";
            }
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 5px;
                color: #FFD700;
                font-weight: bold;
                padding: 5px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
            }
            QTextEdit {
                background: #2A2A2A;
                border: 1px solid #666666;
                border-radius: 3px;
                color: #FFD700;
            }
        """)
        # å»¶è¿Ÿæ˜¾ç¤ºï¼Œé¿å…é˜»å¡ä¸»ç•Œé¢
        QTimer.singleShot(1000, reminder_dialog.show)
    def get_daily_suggestions(self, date, user_info):
        """è·å–æ¯æ—¥å»ºè®®"""
        day_element = self.get_wuxing_by_tiangan(user_info['pillars']['day'][0])
        suggestions = []
        # æ ¹æ®æ˜ŸæœŸç»™å‡ºå»ºè®®
        weekday = date.weekday()
        weekday_suggestions = {
            0: "å‘¨ä¸€æ–°å¼€å§‹ï¼Œé€‚åˆåˆ¶å®šè®¡åˆ’",
            1: "å‘¨äºŒå®œè¡ŒåŠ¨ï¼ŒæŠŠæ¡æœºä¼š",
            2: "å‘¨ä¸‰éœ€å¹³è¡¡ï¼Œæ³¨æ„åè°ƒ",
            3: "å‘¨å››é‡æ²Ÿé€šï¼Œå¤šä¸äººäº¤æµ",
            4: "å‘¨äº”è¦æ€»ç»“ï¼Œå‡†å¤‡ä¼‘æ¯",
            5: "å‘¨å…­å®œæ”¾æ¾ï¼Œäº«å—ç”Ÿæ´»",
            6: "å‘¨æ—¥è¦å……ç”µï¼Œå‡†å¤‡æ–°å‘¨"
        }
        suggestions.append(weekday_suggestions.get(weekday, ""))
        # æ ¹æ®äº”è¡Œç»™å‡ºå»ºè®®
        element_suggestions = {
            'æœ¨': "å¤šæ¥è§¦ç»¿è‰²ï¼Œåˆ°å…¬å›­èµ°èµ°",
            'ç«': "ä¿æŒçƒ­æƒ…ï¼Œä½†é¿å…æ€¥èº",
            'åœŸ': "è„šè¸å®åœ°ï¼Œç¨³æ­¥å‰è¿›",
            'é‡‘': "æ³¨é‡ç»†èŠ‚ï¼Œè¿½æ±‚å®Œç¾",
            'æ°´': "ä¿æŒçµæ´»ï¼Œé¡ºåŠ¿è€Œä¸º"
        }
        suggestions.append(element_suggestions.get(day_element, ""))
        return " â€¢ ".join(filter(None, suggestions))
    def check_daily_reminders(self):
        """æ£€æŸ¥æ¯æ—¥æé†’"""
        if not self.current_user_info:
            return
        from datetime import datetime
        current_time = datetime.now()
        # æ¯å¤©æ—©ä¸Š8ç‚¹æé†’
        if current_time.hour == 8 and current_time.minute < 5:
            self.show_daily_fortune_reminder()
        # é‡è¦æ—¶é—´ç‚¹æé†’
        if current_time.hour in [12, 18] and current_time.minute < 5:
            self.show_time_reminder(current_time.hour)
    def show_time_reminder(self, hour):
        """æ˜¾ç¤ºæ—¶é—´ç‚¹æé†’"""
        if not self.current_user_info:
            return
        reminder_messages = {
            12: "ğŸŒ åˆæ—¶å·²åˆ°ï¼Œé€‚åˆä¼‘æ¯è°ƒæ•´ï¼Œè¡¥å……èƒ½é‡",
            18: "ğŸŒ… é…‰æ—¶å·²åˆ°ï¼Œé€‚åˆæ€»ç»“ä¸€å¤©ï¼Œå‡†å¤‡æ™šé¤"
        }
        message = reminder_messages.get(hour, "")
        if message:
            # åˆ›å»ºç®€å•çš„æé†’æ°”æ³¡
            QMessageBox.information(self, "â° æ—¶è¾°æé†’", message)
    def show_fortune_detail(self):
        """æ˜¾ç¤ºè¯¦ç»†è¿åŠ¿çª—å£"""
        if not self.current_user_info:
            QMessageBox.warning(None, "æç¤º", "è¯·å…ˆè¿›è¡Œå…«å­—æ’ç›˜")
            return
        # åˆ›å»ºè¿åŠ¿è¯¦æƒ…çª—å£
        fortune_dialog = QDialog(None)  # åˆ›å»ºç‹¬ç«‹å¯¹è¯æ¡†
        fortune_dialog.setWindowTitle("ğŸ“Š è¯¦ç»†è¿åŠ¿åˆ†æ")
        fortune_dialog.setFixedSize(1000, 800)  # å¢å¤§çª—å£å°ºå¯¸
        fortune_dialog.setWindowFlags(Qt.Dialog | Qt.WindowStaysOnTopHint)
        layout = QVBoxLayout(fortune_dialog)
        # æ ‡é¢˜
        title_label = QLabel(f"ğŸ“Š {self.current_user_info['name']} çš„è¯¦ç»†è¿åŠ¿åˆ†æ")
        title_label.setAlignment(Qt.AlignCenter)
        title_label.setStyleSheet("font-size: 18px; font-weight: bold; color: #FFD700; margin: 10px;")
        layout.addWidget(title_label)
        # åˆ›å»ºé€‰é¡¹å¡ - å»¶è¿ŸåŠ è½½é¿å…ç•Œé¢å¡é¡¿
        tab_widget = QTabWidget()

        # åˆ›å»ºç©ºçš„é€‰é¡¹å¡ï¼Œç‚¹å‡»æ—¶æ‰åŠ è½½å†…å®¹
        year_tab = QWidget()
        year_layout = QVBoxLayout(year_tab)
        year_text = QTextEdit()
        year_text.setReadOnly(True)
        year_text.setText("ğŸ“… æ­£åœ¨åŠ è½½å¹´è¿åŠ¿åˆ†æï¼Œè¯·ç¨å€™...")
        year_text.setStyleSheet("""
            QTextEdit {
                background: #1A1A1A;
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFD700;
                font-size: 18px;
                font-family: "Microsoft YaHei";
                padding: 20px;
                line-height: 1.8;
            }
        """)
        year_layout.addWidget(year_text)
        tab_widget.addTab(year_tab, "å¹´è¿åŠ¿")

        # æœˆè¿åŠ¿é€‰é¡¹å¡
        month_tab = QWidget()
        month_layout = QVBoxLayout(month_tab)
        month_text = QTextEdit()
        month_text.setReadOnly(True)
        month_text.setText("ğŸ—“ï¸ æ­£åœ¨åŠ è½½æœˆè¿åŠ¿åˆ†æï¼Œè¯·ç¨å€™...")
        month_text.setStyleSheet("""
            QTextEdit {
                background: #1A1A1A;
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFD700;
                font-size: 18px;
                font-family: "Microsoft YaHei";
                padding: 20px;
                line-height: 1.8;
            }
        """)
        month_layout.addWidget(month_text)
        tab_widget.addTab(month_tab, "æœˆè¿åŠ¿")

        # æ—¥è¿åŠ¿é€‰é¡¹å¡
        day_tab = QWidget()
        day_layout = QVBoxLayout(day_tab)
        day_text = QTextEdit()
        day_text.setReadOnly(True)
        day_text.setText("ğŸ“† æ­£åœ¨åŠ è½½æ—¥è¿åŠ¿åˆ†æï¼Œè¯·ç¨å€™...")
        day_text.setStyleSheet("""
            QTextEdit {
                background: #1A1A1A;
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFD700;
                font-size: 18px;
                font-family: "Microsoft YaHei";
                padding: 20px;
                line-height: 1.8;
            }
        """)
        day_layout.addWidget(day_text)
        tab_widget.addTab(day_tab, "æ—¥è¿åŠ¿")

        # è´µäººè¿é€‰é¡¹å¡
        noble_tab = QWidget()
        noble_layout = QVBoxLayout(noble_tab)
        noble_text = QTextEdit()
        noble_text.setReadOnly(True)
        noble_text.setText("ğŸ¯ æ­£åœ¨åŠ è½½è´µäººè¿åˆ†æï¼Œè¯·ç¨å€™...")
        noble_text.setStyleSheet("""
            QTextEdit {
                background: #1A1A1A;
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFD700;
                font-size: 22px;
                font-family: "Microsoft YaHei";
                padding: 20px;
                line-height: 2.0;
            }
        """)
        noble_layout.addWidget(noble_text)
        tab_widget.addTab(noble_tab, "è´µäººè¿")

        # ç›´æ¥åŠ è½½æ‰€æœ‰è¿åŠ¿å†…å®¹ï¼ˆä¼ ç»Ÿæœ¬åœ°è®¡ç®—ï¼Œé€Ÿåº¦å¿«ï¼‰
        from datetime import datetime
        current_date = datetime.now()
        current_year = current_date.year

        # å¹´è¿åŠ¿
        year_fortune = self.analyze_year_fortune(current_year, self.current_user_info['pillars'], self.current_user_info['wuxing'])
        year_text.setText(f"ğŸ“… {current_year}å¹´è¯¦ç»†è¿åŠ¿åˆ†æ\n\n{year_fortune}")

        # æœˆè¿åŠ¿
        month_fortune = self.analyze_month_fortune(current_date.month, self.current_user_info['pillars'], self.current_user_info['wuxing'])
        month_text.setText(f"ğŸ—“ï¸ {current_date.month}æœˆè¯¦ç»†è¿åŠ¿åˆ†æ\n\n{month_fortune}")

        # æ—¥è¿åŠ¿
        day_fortune = self.analyze_day_fortune(current_date.day, self.current_user_info['pillars'], self.current_user_info['wuxing'])
        day_text.setText(f"ğŸ“† ä»Šæ—¥è¿åŠ¿åˆ†æ\n\n{day_fortune}")

        # è´µäººè¿
        noble_fortune = self.analyze_noble_fortune_ai(
            self.current_user_info['pillars'],
            self.current_user_info['day_master'],
            self.current_user_info['wuxing']
        )
        noble_text.setText(noble_fortune)
        layout.addWidget(tab_widget)
        # å…³é—­æŒ‰é’®
        close_btn = QPushButton("å…³é—­")
        close_btn.clicked.connect(fortune_dialog.accept)
        layout.addWidget(close_btn)
        # åº”ç”¨æ ·å¼
        fortune_dialog.setStyleSheet("""
            QDialog {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #2A2A2A, stop:1 #1A1A1A);
                color: #FFD700;
                font-family: "Microsoft YaHei";
            }
            QTabWidget::pane {
                border: 2px solid #FFD700;
                border-radius: 5px;
            }
            QTabBar::tab {
                background: #3A3A3A;
                color: #FFD700;
                padding: 8px 16px;
                margin-right: 2px;
                border-top-left-radius: 5px;
                border-top-right-radius: 5px;
            }
            QTabBar::tab:selected {
                background: #FFD700;
                color: #000000;
            }
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #4A4A4A, stop:1 #2A2A2A);
                border: 2px solid #FFD700;
                border-radius: 5px;
                color: #FFD700;
                font-weight: bold;
                padding: 8px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #6A6A6A, stop:1 #4A4A4A);
            }
            QTextEdit {
                background: #1A1A1A;
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFD700;
                font-size: 18px;
                font-family: "Microsoft YaHei";
                padding: 20px;
                line-height: 2.0;
            }
            QSpinBox {
                background: #2A2A2A;
                border: 2px solid #FFD700;
                border-radius: 5px;
                color: #FFD700;
                font-size: 14px;
                font-weight: bold;
                padding: 8px;
                min-width: 80px;
            }
        """)
        # ä½¿ç”¨exec_()ç¡®ä¿çª—å£ä¿æŒæ˜¾ç¤ºï¼Œç›´åˆ°ç”¨æˆ·å…³é—­
        fortune_dialog.exec_()
    def create_year_fortune_tab(self):
        """åˆ›å»ºå¹´è¿åŠ¿é€‰é¡¹å¡"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        from datetime import datetime
        current_year = datetime.now().year
        # å¹´ä»½é€‰æ‹©
        year_layout = QHBoxLayout()
        year_layout.addWidget(QLabel("æŸ¥çœ‹å¹´ä»½:"))
        year_spin = QSpinBox()
        year_spin.setRange(current_year - 5, current_year + 5)
        year_spin.setValue(current_year)
        year_layout.addWidget(year_spin)
        year_layout.addStretch()
        layout.addLayout(year_layout)
        # è¿åŠ¿æ˜¾ç¤º
        year_text = QTextEdit()
        year_text.setReadOnly(True)

        # è®¾ç½®å¹´è¿åŠ¿ä¸“ç”¨æ ·å¼ï¼ˆç¡®ä¿å­—ä½“å¤§å°å’Œé¢œè‰²æ­£ç¡®ï¼‰
        year_text.setStyleSheet("""
            QTextEdit {
                background: #1A1A1A;
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFD700;
                font-size: 22px;
                font-family: "Microsoft YaHei";
                padding: 20px;
                line-height: 2.0;
            }
        """)
        # è·å–å¹´è¿åŠ¿ - ä¿®å¤ï¼šç¡®ä¿ä½¿ç”¨å½“å‰æ­£ç¡®çš„å…«å­—æ•°æ®
        if hasattr(self, 'current_user_info') and self.current_user_info:
            try:
                year_fortune = self.analyze_year_fortune(current_year, self.current_user_info['pillars'], self.current_user_info['wuxing'])
                year_text.setText(f"ğŸ“… {current_year}å¹´è¯¦ç»†è¿åŠ¿åˆ†æ\n\n{year_fortune}")
            except Exception as e:
                year_text.setText(f"âš ï¸ å¹´è¿åŠ¿åˆ†æå‡ºé”™ï¼š{str(e)}\nè¯·é‡æ–°è®¡ç®—å…«å­—åå†è¯•")
        else:
            year_text.setText("âš ï¸ è¯·å…ˆåœ¨å…«å­—ç®—å‘½é€‰é¡¹å¡ä¸­è®¡ç®—å…«å­—ï¼Œç„¶åå†æŸ¥çœ‹å¹´è¿åŠ¿")
        layout.addWidget(year_text)
        # å¹´ä»½æ”¹å˜æ—¶æ›´æ–°å†…å®¹
        def update_year_fortune():
            if hasattr(self, 'current_user_info') and self.current_user_info:
                try:
                    selected_year = year_spin.value()
                    fortune = self.analyze_year_fortune(selected_year, self.current_user_info['pillars'], self.current_user_info['wuxing'])
                    year_text.setText(f"ğŸ“… {selected_year}å¹´è¯¦ç»†è¿åŠ¿åˆ†æ\n\n{fortune}")
                except Exception as e:
                    year_text.setText(f"âš ï¸ å¹´è¿åŠ¿åˆ†æå‡ºé”™ï¼š{str(e)}")
            else:
                year_text.setText("âš ï¸ è¯·å…ˆè®¡ç®—å…«å­—")
        year_spin.valueChanged.connect(update_year_fortune)
        return widget

    def create_month_fortune_tab(self):
        """åˆ›å»ºæœˆè¿åŠ¿é€‰é¡¹å¡"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        from datetime import datetime
        current_date = datetime.now()
        # æœˆä»½é€‰æ‹©
        month_layout = QHBoxLayout()
        month_layout.addWidget(QLabel("æŸ¥çœ‹æœˆä»½:"))
        month_spin = QSpinBox()
        month_spin.setRange(1, 12)
        month_spin.setValue(current_date.month)
        month_layout.addWidget(month_spin)
        month_layout.addStretch()
        layout.addLayout(month_layout)
        # è¿åŠ¿æ˜¾ç¤º
        month_text = QTextEdit()
        month_text.setReadOnly(True)

        # è®¾ç½®æœˆè¿åŠ¿ä¸“ç”¨æ ·å¼ï¼ˆç¡®ä¿å­—ä½“å¤§å°å’Œé¢œè‰²æ­£ç¡®ï¼‰
        month_text.setStyleSheet("""
            QTextEdit {
                background: #1A1A1A;
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFD700;
                font-size: 22px;
                font-family: "Microsoft YaHei";
                padding: 20px;
                line-height: 2.0;
            }
        """)
        # è·å–æœˆè¿åŠ¿ - ä¿®å¤ï¼šç¡®ä¿ä½¿ç”¨å½“å‰æ­£ç¡®çš„å…«å­—æ•°æ®
        if hasattr(self, 'current_user_info') and self.current_user_info:
            try:
                month_fortune = self.analyze_month_fortune(current_date.month, self.current_user_info['pillars'], self.current_user_info['wuxing'])
                month_text.setText(f"ğŸ—“ï¸ {current_date.month}æœˆè¯¦ç»†è¿åŠ¿åˆ†æ\n\n{month_fortune}")
            except Exception as e:
                month_text.setText(f"âš ï¸ æœˆè¿åŠ¿åˆ†æå‡ºé”™ï¼š{str(e)}\nè¯·é‡æ–°è®¡ç®—å…«å­—åå†è¯•")
        else:
            month_text.setText("âš ï¸ è¯·å…ˆåœ¨å…«å­—ç®—å‘½é€‰é¡¹å¡ä¸­è®¡ç®—å…«å­—ï¼Œç„¶åå†æŸ¥çœ‹æœˆè¿åŠ¿")
        layout.addWidget(month_text)
        # æœˆä»½æ”¹å˜æ—¶æ›´æ–°å†…å®¹
        def update_month_fortune():
            if hasattr(self, 'current_user_info') and self.current_user_info:
                try:
                    selected_month = month_spin.value()
                    fortune = self.analyze_month_fortune(selected_month, self.current_user_info['pillars'], self.current_user_info['wuxing'])
                    month_text.setText(f"ğŸ—“ï¸ {selected_month}æœˆè¯¦ç»†è¿åŠ¿åˆ†æ\n\n{fortune}")
                except Exception as e:
                    month_text.setText(f"âš ï¸ æœˆè¿åŠ¿åˆ†æå‡ºé”™ï¼š{str(e)}")
            else:
                month_text.setText("âš ï¸ è¯·å…ˆè®¡ç®—å…«å­—")
        month_spin.valueChanged.connect(update_month_fortune)
        return widget

    def create_day_fortune_tab(self):
        """åˆ›å»ºæ—¥è¿åŠ¿é€‰é¡¹å¡"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        from datetime import datetime
        current_date = datetime.now()
        # æ—¥æœŸé€‰æ‹©
        date_layout = QHBoxLayout()
        date_layout.addWidget(QLabel("æŸ¥çœ‹æ—¥æœŸ:"))
        date_edit = QDateEdit()
        date_edit.setDate(QDate.currentDate())
        date_edit.setCalendarPopup(True)
        date_layout.addWidget(date_edit)
        date_layout.addStretch()
        layout.addLayout(date_layout)
        # è¿åŠ¿æ˜¾ç¤º
        day_text = QTextEdit()
        day_text.setReadOnly(True)

        # è®¾ç½®æ—¥è¿åŠ¿ä¸“ç”¨æ ·å¼ï¼ˆç¡®ä¿å­—ä½“å¤§å°å’Œé¢œè‰²æ­£ç¡®ï¼‰
        day_text.setStyleSheet("""
            QTextEdit {
                background: #1A1A1A;
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFD700;
                font-size: 22px;
                font-family: "Microsoft YaHei";
                padding: 20px;
                line-height: 2.0;
            }
        """)
        # è·å–æ—¥è¿åŠ¿
        try:
            day_fortune = self.analyze_day_fortune(current_date.day, self.current_user_info['pillars'], self.current_user_info['wuxing'])
            day_text.setText(f"ğŸ“† ä»Šæ—¥è¿åŠ¿åˆ†æ\n\n{day_fortune}")
        except Exception as e:
            day_text.setText(f"âš ï¸ æ—¥è¿åŠ¿åˆ†æå‡ºé”™ï¼š{str(e)}")
        layout.addWidget(day_text)
        # æ—¥æœŸæ”¹å˜æ—¶æ›´æ–°å†…å®¹
        def update_day_fortune():
            try:
                selected_date = date_edit.date().toPyDate()
                fortune = self.analyze_day_fortune(selected_date.day, self.current_user_info['pillars'], self.current_user_info['wuxing'])
                day_text.setText(f"ğŸ“† {selected_date.strftime('%Yå¹´%mæœˆ%dæ—¥')} è¿åŠ¿åˆ†æ\n\n{fortune}")
            except Exception as e:
                day_text.setText(f"âš ï¸ æ—¥è¿åŠ¿åˆ†æå‡ºé”™ï¼š{str(e)}")
        date_edit.dateChanged.connect(update_day_fortune)
        return widget

    def create_noble_fortune_tab(self):
        """åˆ›å»ºè´µäººè¿é€‰é¡¹å¡"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        # è´µäººåˆ†ææ˜¾ç¤º
        noble_text = QTextEdit()
        noble_text.setReadOnly(True)

        # è®¾ç½®è´µäººè¿åŠ¿ä¸“ç”¨æ ·å¼ï¼ˆç¡®ä¿å­—ä½“å¤§å°å’Œé¢œè‰²æ­£ç¡®ï¼‰
        noble_text.setStyleSheet("""
            QTextEdit {
                background: #1A1A1A;
                border: 2px solid #FFD700;
                border-radius: 8px;
                color: #FFD700;
                font-size: 22px;
                font-family: "Microsoft YaHei";
                padding: 20px;
                line-height: 2.0;
            }
        """)
        # è·å–åŸºäºAIçš„ä¸ªæ€§åŒ–è´µäººè¿åˆ†æ
        if hasattr(self, 'current_user_info') and self.current_user_info and 'day_master' in self.current_user_info:
            content = self.analyze_noble_fortune_ai(
                self.current_user_info['pillars'],
                self.current_user_info['day_master'],
                self.current_user_info['wuxing']
            )
        else:
            content = "âš ï¸ è¯·å…ˆåœ¨å…«å­—ç®—å‘½é€‰é¡¹å¡ä¸­è®¡ç®—å…«å­—ï¼Œç„¶åå†æŸ¥çœ‹è´µäººè¿åŠ¿"

        # è®¾ç½®å†…å®¹å¹¶è¿”å›ç»„ä»¶
        noble_text.setText(content)
        layout.addWidget(noble_text)
        return widget

    def analyze_noble_fortune_ai(self, pillars, day_master, wuxing):
        """åŸºäºå…«å­—æ•°æ®çš„ä¼ ç»Ÿè´µäººè¿åˆ†æ"""
        try:
            # æ„å»ºå…«å­—ä¿¡æ¯
            bazi_info = f"å…«å­—ï¼š{pillars['year'][0]}{pillars['year'][1]} {pillars['month'][0]}{pillars['month'][1]} {pillars['day'][0]}{pillars['day'][1]} {pillars['hour'][0]}{pillars['hour'][1]}"
            day_element = self.get_wuxing_by_tiangan(day_master)

            analysis = f"ğŸ¯ è´µäººè¿åŠ¿åˆ†æ\n\n"
            analysis += f"{bazi_info}\n"
            analysis += f"æ—¥ä¸»ï¼š{day_master}ï¼ˆ{day_element}ï¼‰\n\n"

            # è®¡ç®—å‘½ä¸­çš„è´µäºº
            noble_people = self.analyze_noble_people(pillars, day_master)

            # åˆ†æè´µäººè¿åŠ¿å¼ºå¼±
            noble_count = noble_people.count('âœ¨')
            if noble_count >= 3:
                fortune_level = "â˜…â˜…â˜…â˜…â˜…"
                analysis += "ã€è´µäººè¿åŠ¿ã€‘â˜…â˜…â˜…â˜…â˜… æå¼º\n"
                analysis += "æ‚¨å‘½ä¸­è´µäººæ˜Ÿä¼—å¤šï¼Œè´µäººè¿åŠ¿æå¼ºï¼Œä¸€ç”Ÿå¤šå¾—è´µäººç›¸åŠ©ã€‚\n\n"
            elif noble_count >= 2:
                fortune_level = "â˜…â˜…â˜…â˜…â˜†"
                analysis += "ã€è´µäººè¿åŠ¿ã€‘â˜…â˜…â˜…â˜…â˜† è¾ƒå¼º\n"
                analysis += "æ‚¨å‘½ä¸­æœ‰è´µäººæ˜Ÿï¼Œè´µäººè¿åŠ¿è¾ƒå¼ºï¼Œå…³é”®æ—¶åˆ»å¤šæœ‰è´µäººå¸®åŠ©ã€‚\n\n"
            elif noble_count >= 1:
                fortune_level = "â˜…â˜…â˜…â˜†â˜†"
                analysis += "ã€è´µäººè¿åŠ¿ã€‘â˜…â˜…â˜…â˜†â˜† ä¸­ç­‰\n"
                analysis += "æ‚¨å‘½ä¸­æœ‰è´µäººæ˜Ÿï¼Œè´µäººè¿åŠ¿ä¸­ç­‰ï¼Œéœ€è¦ä¸»åŠ¨åŸ¹å…»äººé™…å…³ç³»ã€‚\n\n"
            else:
                fortune_level = "â˜…â˜…â˜†â˜†â˜†"
                analysis += "ã€è´µäººè¿åŠ¿ã€‘â˜…â˜…â˜†â˜†â˜† è¾ƒå¼±\n"
                analysis += "æ‚¨å‘½ä¸­è´µäººæ˜Ÿè¾ƒå°‘ï¼Œéœ€è¦ä¸»åŠ¨åŸ¹å…»è´µäººè¿ï¼Œå¹¿ç»“å–„ç¼˜ã€‚\n\n"

            # æ˜¾ç¤ºå…·ä½“è´µäººä¿¡æ¯
            analysis += "ã€å‘½ä¸­è´µäººã€‘\n"
            noble_lines = noble_people.split('\n')
            for line in noble_lines:
                if "âœ¨" in line:
                    analysis += f"{line}\n"

            # æ ¹æ®æ—¥ä¸»äº”è¡Œåˆ†æè´µäººç±»å‹
            analysis += f"\nã€è´µäººç‰¹å¾ã€‘\n"
            if day_element == "é‡‘":
                analysis += "â€¢ åœŸæ€§äººï¼šç¨³é‡è¸å®ï¼Œä»äº‹åœ°äº§ã€å»ºç­‘ã€å†œä¸šçš„äºº\n"
                analysis += "â€¢ é‡‘æ€§äººï¼šæœæ–­åšæ¯…ï¼Œä»äº‹é‡‘èã€ç å®ã€æœºæ¢°çš„äºº\n"
            elif day_element == "æœ¨":
                analysis += "â€¢ æ°´æ€§äººï¼šæ™ºæ…§çµæ´»ï¼Œä»äº‹æ–‡åŒ–ã€æ•™è‚²ã€æ°´åˆ©çš„äºº\n"
                analysis += "â€¢ æœ¨æ€§äººï¼šä»æ…ˆæ­£ç›´ï¼Œä»äº‹æ—ä¸šã€æ–‡æ•™ã€åŒ»è¯çš„äºº\n"
            elif day_element == "æ°´":
                analysis += "â€¢ é‡‘æ€§äººï¼šæœæ–­ç†æ€§ï¼Œä»äº‹é‡‘èã€ç§‘æŠ€ã€åˆ¶é€ çš„äºº\n"
                analysis += "â€¢ æ°´æ€§äººï¼šæ™ºæ…§å˜é€šï¼Œä»äº‹è´¸æ˜“ã€è¿è¾“ã€ä¿¡æ¯çš„äºº\n"
            elif day_element == "ç«":
                analysis += "â€¢ æœ¨æ€§äººï¼šç§¯æå‘ä¸Šï¼Œä»äº‹æ–‡åŒ–ã€æ•™è‚²ã€åˆ›æ„çš„äºº\n"
                analysis += "â€¢ ç«æ€§äººï¼šçƒ­æƒ…å¼€æœ—ï¼Œä»äº‹å¨±ä¹ã€é¤é¥®ã€èƒ½æºçš„äºº\n"
            else:  # åœŸ
                analysis += "â€¢ ç«æ€§äººï¼šçƒ­æƒ…ç§¯æï¼Œä»äº‹èƒ½æºã€åŒ–å·¥ã€é¤é¥®çš„äºº\n"
                analysis += "â€¢ åœŸæ€§äººï¼šå¿ åšå¯é ï¼Œä»äº‹åœ°äº§ã€å†œä¸šã€æœåŠ¡çš„äºº\n"

            # æå‡è´µäººè¿çš„æ–¹æ³•
            analysis += f"\nã€æå‡è´µäººè¿ã€‘\n"
            if noble_count >= 2:
                analysis += "â€¢ å‘æŒ¥ç°æœ‰è´µäººä¼˜åŠ¿ï¼Œç»´æŠ¤è‰¯å¥½å…³ç³»\n"
                analysis += "â€¢ ä¸»åŠ¨å¸®åŠ©ä»–äººï¼Œæ‰©å¤§è´µäººç½‘ç»œ\n"
                analysis += "â€¢ æå‡ä¸ªäººèƒ½åŠ›ï¼Œæˆä¸ºä»–äººçš„è´µäºº\n"
            else:
                analysis += "â€¢ å¤šå‚ä¸ç¤¾äº¤æ´»åŠ¨ï¼Œæ‰©å¤§äººè„‰åœˆ\n"
                analysis += "â€¢ ä¸»åŠ¨è¡Œå–„ç§¯å¾·ï¼Œå¹¿ç»“å–„ç¼˜\n"
                analysis += "â€¢ æå‡è‡ªèº«å“å¾·ä¿®å…»å’Œä¸“ä¸šèƒ½åŠ›\n"
                analysis += "â€¢ å‚ä¸å…¬ç›Šæ´»åŠ¨ï¼Œå»ºç«‹è‰¯å¥½å£ç¢‘\n"

            # äº”è¡Œè¡¥å……å»ºè®®
            weak_elements = [k for k, v in wuxing.items() if v == 0]
            if weak_elements:
                analysis += f"\nã€äº”è¡Œå»ºè®®ã€‘ç¼º{','.join(weak_elements)}ï¼Œå¯é€šè¿‡ç›¸åº”é¢œè‰²ã€æ–¹ä½ã€èŒä¸šæ¥è¡¥å……ï¼Œæœ‰åŠ©æå‡è´µäººè¿\n"

            return analysis

        except Exception as e:
            return f"ğŸ¯ è´µäººè¿åŠ¿åˆ†æ\n\nâš ï¸ åˆ†æå‡ºé”™ï¼š{str(e)}"



    def analyze_fengshui(self):
        """å¼‚æ­¥åˆ†æé£æ°´"""
        try:
            # è·å–è¾“å…¥ä¿¡æ¯
            fengshui_type = self.fengshui_type.currentText()
            direction = self.house_direction.currentText()
            total_floors = self.total_floors.value()
            current_floor = self.current_floor.value()
            area = self.house_area.value()
            main_resident = self.main_resident.text().strip()
            other_residents = self.other_residents.toPlainText().strip()
            special_need = self.special_needs.currentText()

            # ç›´æ¥è¿›è¡Œé£æ°´åˆ†æï¼ˆä¼ ç»Ÿæœ¬åœ°è®¡ç®—ï¼Œæ— éœ€å¼‚æ­¥ï¼‰
            fengshui_result = self.analyze_fengshui_core(
                fengshui_type, direction, total_floors, current_floor,
                area, main_resident, other_residents, special_need
            )

            # æ˜¾ç¤ºç»“æœ
            self.display_fengshui_result(fengshui_result)

        except Exception as e:
            QMessageBox.critical(None, "åˆ†æé”™è¯¯", f"é£æ°´åˆ†æå¤±è´¥ï¼š{str(e)}")
    def analyze_fengshui_core(self, _fengshui_type, direction, total_floors, current_floor, area, _main_resident, _other_residents, special_need):
        """é£æ°´åˆ†ææ ¸å¿ƒç®—æ³• - åŸºäºã€Šé˜³å®…ä¸‰è¦ã€‹ã€Šå…«å®…æ˜é•œã€‹ã€Šç„ç©ºé£æ˜Ÿã€‹ç­‰ç»å…¸ç†è®º"""
        # å…«å¦æ–¹ä½è¯¦ç»†åˆ†æï¼ˆã€Šé˜³å®…ä¸‰è¦ã€‹ç†è®ºï¼‰
        bagua_directions = {
            "ååŒ—æœå—": {
                "gua": "åå®…ç¦»é—¨", "element": "æ°´", "score": 95, "level": "å¤§å‰",
                "desc": "åæ°´å¾—ä½ï¼Œç¦»ç«ç…§æ˜ï¼Œé˜´é˜³è°ƒå’Œï¼Œæ˜¯æœ€ç†æƒ³çš„æœå‘",
                "family_benefit": "åˆ©ä¸­ç”·ï¼Œä¸»æ™ºæ…§èªæ˜",
                "career": "é€‚åˆä»äº‹æ™ºæ…§å‹ã€æµåŠ¨æ€§å·¥ä½œ",
                "health": "åˆ©äºè‚¾è„ã€æ³Œå°¿ç³»ç»Ÿå¥åº·",
                "wealth": "è´¢è¿ç¨³å®šï¼Œç»†æ°´é•¿æµ",
                "layout": "å®¢å…å®œåœ¨å—æ–¹ï¼Œå§å®¤å®œåœ¨åŒ—æ–¹"
            },
            "åä¸œæœè¥¿": {
                "gua": "éœ‡å®…å…‘é—¨", "element": "æœ¨", "score": 75, "level": "ä¸­å‰",
                "desc": "éœ‡æœ¨ç”Ÿå‘ï¼Œå…‘é‡‘æ”¶æ•›ï¼ŒåŠ¨é™ç›¸å®œ",
                "family_benefit": "åˆ©é•¿å­ï¼Œä¸»äº‹ä¸šå‘å±•",
                "career": "é€‚åˆå¼€åˆ›æ€§ã€ç«äº‰æ€§å·¥ä½œ",
                "health": "åˆ©äºè‚èƒ†ã€ç¥ç»ç³»ç»Ÿ",
                "wealth": "è´¢è¿æ³¢åŠ¨ï¼Œéœ€è¦ç§¯æè¿›å–",
                "layout": "ä¹¦æˆ¿å®œåœ¨ä¸œæ–¹ï¼Œå®¢å…å®œåœ¨è¥¿æ–¹"
            },
            "åå—æœåŒ—": {
                "gua": "ç¦»å®…åé—¨", "element": "ç«", "score": 45, "level": "å¤§å‡¶",
                "desc": "ç¦»ç«è¢«åæ°´å†²å…‹ï¼Œé˜´æ°”è¿‡é‡ï¼Œéœ€è¦ç‰¹åˆ«è°ƒç†",
                "family_benefit": "ä¸åˆ©ä¸­å¥³ï¼Œå½±å“å¿ƒè„å¥åº·",
                "career": "äº‹ä¸šå‘å±•å—é˜»ï¼Œéœ€è¦é¢å¤–åŠªåŠ›",
                "health": "æ³¨æ„å¿ƒè„ã€è¡€æ¶²å¾ªç¯é—®é¢˜",
                "wealth": "è´¢è¿ä¸ç¨³ï¼Œå®¹æ˜“ç ´è´¢",
                "layout": "éœ€è¦å¢åŠ é˜³æ°”ï¼Œå¤šç”¨çº¢è‰²ã€æ©™è‰²è£…é¥°"
            },
            "åè¥¿æœä¸œ": {
                "gua": "å…‘å®…éœ‡é—¨", "element": "é‡‘", "score": 70, "level": "ä¸­å¹³",
                "desc": "å…‘é‡‘å…‹éœ‡æœ¨ï¼Œéœ€è¦è°ƒå’Œäº”è¡Œ",
                "family_benefit": "åˆ©å°‘å¥³ï¼Œä¸»å£æ‰è‰ºæœ¯",
                "career": "é€‚åˆè‰ºæœ¯ã€å¨±ä¹ã€é‡‘èå·¥ä½œ",
                "health": "åˆ©äºè‚ºéƒ¨ã€å‘¼å¸ç³»ç»Ÿ",
                "wealth": "è´¢è¿ä¸­ç­‰ï¼Œéœ€è¦ç†æ€§æŠ•èµ„",
                "layout": "å§å®¤å®œåœ¨è¥¿æ–¹ï¼Œæ´»åŠ¨åŒºå®œåœ¨ä¸œæ–¹"
            },
            "åä¸œåŒ—æœè¥¿å—": {
                "gua": "è‰®å®…å¤é—¨", "element": "åœŸ", "score": 80, "level": "ä¸­å‰",
                "desc": "è‰®åœŸå¾—å¤åœŸç›¸åŠ©ï¼Œåšå¾·è½½ç‰©ï¼Œåˆ©äºç§¯ç´¯",
                "family_benefit": "åˆ©å°‘ç”·å’Œæ¯äº²ï¼Œå®¶åº­å’Œç¦",
                "career": "é€‚åˆç¨³å®šæ€§ã€ç§¯ç´¯æ€§å·¥ä½œ",
                "health": "åˆ©äºè„¾èƒƒã€æ¶ˆåŒ–ç³»ç»Ÿ",
                "wealth": "è´¢è¿ç¨³å¥ï¼Œå–„äºå‚¨è“„",
                "layout": "è´¢ä½å®œåœ¨ä¸œåŒ—ï¼Œå¨æˆ¿å®œåœ¨è¥¿å—"
            },
            "åè¥¿å—æœä¸œåŒ—": {
                "gua": "å¤å®…è‰®é—¨", "element": "åœŸ", "score": 65, "level": "ä¸­å¹³",
                "desc": "å¤åœŸåŒ…å®¹ï¼Œè‰®åœŸç¨³å›ºï¼Œåˆ©äºå®¶åº­å’Œè°",
                "family_benefit": "åˆ©æ¯äº²å’Œå°‘ç”·ï¼Œå¥³æ€§å½“å®¶",
                "career": "é€‚åˆæœåŠ¡æ€§ã€ç…§é¡¾æ€§å·¥ä½œ",
                "health": "æ³¨æ„è…¹éƒ¨ã€è„¾èƒƒå¥åº·",
                "wealth": "è´¢è¿å¹³ç¨³ï¼Œé€‚åˆä¿å®ˆæŠ•èµ„",
                "layout": "ä¸»å§å®œåœ¨è¥¿å—ï¼Œä¹¦æˆ¿å®œåœ¨ä¸œåŒ—"
            },
            "åä¸œå—æœè¥¿åŒ—": {
                "gua": "å·½å®…ä¹¾é—¨", "element": "æœ¨", "score": 85, "level": "å¤§å‰",
                "desc": "å·½æœ¨å¾—ä¹¾é‡‘ä¿®å‰ªï¼Œæ–‡æ˜Œå¤§åˆ©ï¼Œè´¢è¿äº¨é€š",
                "family_benefit": "åˆ©é•¿å¥³å’Œçˆ¶äº²ï¼Œæ–‡æ­¦åŒå…¨",
                "career": "é€‚åˆæ–‡åŒ–ã€æ•™è‚²ã€è´¸æ˜“å·¥ä½œ",
                "health": "åˆ©äºèƒ†å›Šã€ç¥ç»ç³»ç»Ÿ",
                "wealth": "è´¢è¿æä½³ï¼Œå¤šæ–¹æ¥è´¢",
                "layout": "ä¹¦æˆ¿å®œåœ¨ä¸œå—ï¼Œå®¢å…å®œåœ¨è¥¿åŒ—"
            },
            "åè¥¿åŒ—æœä¸œå—": {
                "gua": "ä¹¾å®…å·½é—¨", "element": "é‡‘", "score": 90, "level": "å¤§å‰",
                "desc": "ä¹¾é‡‘å¾—å·½æœ¨ç”Ÿè´¢ï¼Œæƒå¨æ˜¾è¾¾ï¼Œäº‹ä¸šæœ‰æˆ",
                "family_benefit": "åˆ©çˆ¶äº²å’Œé•¿å¥³ï¼Œæƒå¨ä¸æ™ºæ…§å¹¶é‡",
                "career": "é€‚åˆç®¡ç†ã€é¢†å¯¼ã€å†³ç­–å·¥ä½œ",
                "health": "åˆ©äºå¤´éƒ¨ã€è‚ºéƒ¨å¥åº·",
                "wealth": "è´¢è¿æ—ºç››ï¼Œæƒè´¢åŒæ”¶",
                "layout": "ä¸»å§å®œåœ¨è¥¿åŒ—ï¼Œè´¢ä½å®œåœ¨ä¸œå—"
            }
        }
        # è·å–æœå‘åˆ†æ
        direction_info = bagua_directions.get(direction, {
            "gua": "æœªçŸ¥å¦ä½", "element": "æœªçŸ¥", "score": 60, "level": "ä¸­å¹³",
            "desc": "éœ€è¦å…·ä½“å‹˜å¯Ÿåˆ†æ", "family_benefit": "éœ€è¦è¯¦ç»†åˆ†æ",
            "career": "æ ¹æ®å…·ä½“æƒ…å†µè°ƒæ•´", "health": "ä¿æŒè‰¯å¥½ç”Ÿæ´»ä¹ æƒ¯",
            "wealth": "éœ€è¦åˆç†è§„åˆ’", "layout": "è¯·å’¨è¯¢ä¸“ä¸šé£æ°´å¸ˆ"
        })

        # ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ä¸“ä¸šç‰ˆç„ç©ºé£æ˜Ÿåˆ†æï¼Œåˆ é™¤é‡å¤çš„ç®€åŒ–ç‰ˆ
        flying_star = self.analyze_xuankong_feixing_professional(direction, current_floor)
        # æ¥¼å±‚äº”è¡Œåˆ†æ
        floor_analysis = self.analyze_floor_comprehensive(current_floor, total_floors, direction_info['element'])
        # é¢ç§¯é£æ°´åˆ†æ
        area_analysis = self.analyze_area_comprehensive(area, direction_info['element'])
        # ç‰¹æ®Šéœ€æ±‚é£æ°´å¸ƒå±€
        special_layout = self.analyze_special_needs_comprehensive(special_need, direction_info)

        # ğŸ”§ ä¿®å¤ï¼šåˆ é™¤é‡å¤è°ƒç”¨ï¼Œflying_starå·²ç»æ˜¯ä¸“ä¸šç‰ˆåˆ†æç»“æœ
        xuankong_analysis = flying_star

        # ğŸ”¥ P0ä¿®å¤ï¼šå°è¯•è·å–å·²ä¿å­˜çš„å‡ºç”Ÿä¿¡æ¯ï¼Œç”¨äºè®¡ç®—å‘½å¦
        birth_year = None
        gender = None
        if hasattr(self, 'last_birth_info') and self.last_birth_info:
            birth_year = self.last_birth_info.get('solar_year')
            gender = self.last_birth_info.get('gender')

        bazhai_analysis = self.analyze_bazhai_professional(direction, birth_year=birth_year, gender=gender)
        room_layout_analysis = self.analyze_room_layout_professional(direction_info)
        color_material_analysis = self.analyze_color_material_professional(direction_info)
        timing_analysis = self.analyze_fengshui_timing_professional()
        adjustment_methods = self.get_fengshui_adjustment_methods(direction_info, flying_star)
        return {
            'type': _fengshui_type,
            'direction_info': direction_info,
            'flying_star': flying_star,
            'floor_analysis': floor_analysis,
            'area_analysis': area_analysis,
            'special_layout': special_layout,
            'xuankong_analysis': xuankong_analysis,
            'bazhai_analysis': bazhai_analysis,
            'room_layout_analysis': room_layout_analysis,
            'color_material_analysis': color_material_analysis,
            'timing_analysis': timing_analysis,
            'adjustment_methods': adjustment_methods,
            'overall_score': direction_info['score']
        }
    def analyze_xuankong_feixing_professional(self, direction, current_floor):
        """ä¸“ä¸šç„ç©ºé£æ˜Ÿåˆ†æ"""
        analysis = {}

        # ä¹å®«é£æ˜ŸåŸºæœ¬ç›˜ï¼ˆåŸºäºä¼ ç»Ÿç„ç©ºé£æ˜Ÿç†è®ºï¼Œå…«è¿æœŸé—´2004-2023å¹´çš„æ ‡å‡†æ’ç›˜ï¼‰
        base_stars = {
            "ååŒ—æœå—": {
                "center": 8, "northwest": 9, "west": 1, "northeast": 2,
                "south": 3, "north": 4, "southwest": 5, "east": 6, "southeast": 7
            },
            "åä¸œæœè¥¿": {
                "center": 6, "northwest": 7, "west": 8, "northeast": 9,
                "south": 1, "north": 2, "southwest": 3, "east": 4, "southeast": 5
            },
            "åå—æœåŒ—": {
                "center": 2, "northwest": 3, "west": 4, "northeast": 5,
                "south": 6, "north": 7, "southwest": 8, "east": 9, "southeast": 1
            },
            "åè¥¿æœä¸œ": {
                "center": 4, "northwest": 5, "west": 6, "northeast": 7,
                "south": 8, "north": 9, "southwest": 1, "east": 2, "southeast": 3
            },
            "åä¸œåŒ—æœè¥¿å—": {
                "center": 1, "northwest": 2, "west": 3, "northeast": 4,
                "south": 5, "north": 6, "southwest": 7, "east": 8, "southeast": 9
            },
            "åè¥¿å—æœä¸œåŒ—": {
                "center": 7, "northwest": 8, "west": 9, "northeast": 1,
                "south": 2, "north": 3, "southwest": 4, "east": 5, "southeast": 6
            },
            "åä¸œå—æœè¥¿åŒ—": {
                "center": 5, "northwest": 6, "west": 7, "northeast": 8,
                "south": 9, "north": 1, "southwest": 2, "east": 3, "southeast": 4
            },
            "åè¥¿åŒ—æœä¸œå—": {
                "center": 3, "northwest": 4, "west": 5, "northeast": 6,
                "south": 7, "north": 8, "southwest": 9, "east": 1, "southeast": 2
            }
        }
        # è·å–åŸºæœ¬æ˜Ÿç›˜
        stars = base_stars.get(direction, base_stars["ååŒ—æœå—"])
        # é£æ˜Ÿå‰å‡¶åˆ†æ
        star_meanings = {
            1: {"name": "ä¸€ç™½è´ªç‹¼", "element": "æ°´", "nature": "å‰", "meaning": "æ–‡æ˜Œã€æ™ºæ…§ã€æ¡ƒèŠ±"},
            2: {"name": "äºŒé»‘å·¨é—¨", "element": "åœŸ", "nature": "å‡¶", "meaning": "ç—…ç¬¦ã€å­¤å¯¡ã€ç ´è´¢"},
            3: {"name": "ä¸‰ç¢§ç¦„å­˜", "element": "æœ¨", "nature": "å‡¶", "meaning": "æ˜¯éã€å®˜å¸ã€äº‰æ–—"},
            4: {"name": "å››ç»¿æ–‡æ›²", "element": "æœ¨", "nature": "å‰", "meaning": "æ–‡æ˜Œã€å­¦ä¸šã€æ¡ƒèŠ±"},
            5: {"name": "äº”é»„å»‰è´", "element": "åœŸ", "nature": "å¤§å‡¶", "meaning": "ç¾ç¥¸ã€ç–¾ç—…ã€ç ´è´¢"},
            6: {"name": "å…­ç™½æ­¦æ›²", "element": "é‡‘", "nature": "å‰", "meaning": "æƒå¨ã€æ­¦èŒã€è´¢è¿"},
            7: {"name": "ä¸ƒèµ¤ç ´å†›", "element": "é‡‘", "nature": "å‡¶", "meaning": "ç›—è´¼ã€å£èˆŒã€ç ´è´¢"},
            8: {"name": "å…«ç™½å·¦è¾…", "element": "åœŸ", "nature": "å¤§å‰", "meaning": "è´¢è¿ã€ç½®ä¸šã€å‡èŒ"},
            9: {"name": "ä¹ç´«å³å¼¼", "element": "ç«", "nature": "å‰", "meaning": "å–œåº†ã€åå£°ã€æ¡ƒèŠ±"}
        }
        analysis["star_distribution"] = {}
        analysis["key_positions"] = {}
        for position, star_num in stars.items():
            star_info = star_meanings[star_num]
            analysis["star_distribution"][position] = {
                "star": star_num,
                "name": star_info["name"],
                "element": star_info["element"],
                "nature": star_info["nature"],
                "meaning": star_info["meaning"]
            }
            # é‡ç‚¹ä½ç½®åˆ†æ
            if position in ["center", "south", "north", "east", "west"]:
                analysis["key_positions"][position] = {
                    "star": star_num,
                    "analysis": self.get_star_position_analysis(position, star_info)
                }
        # æ¥¼å±‚é£æ˜Ÿè°ƒæ•´
        floor_adjustment = (current_floor - 1) % 9 + 1
        analysis["floor_star"] = floor_adjustment
        analysis["floor_effect"] = self.get_floor_star_effect(floor_adjustment)
        return analysis
    def get_star_position_analysis(self, position, star_info):
        """è·å–æ˜Ÿä½åˆ†æ"""
        position_effects = {
            "center": "ä¸­å®«ä¸»å…¨å±‹è¿åŠ¿",
            "south": "ç¦»å®«ä¸»åå£°äº‹ä¸š",
            "north": "åå®«ä¸»æ™ºæ…§è´¢è¿",
            "east": "éœ‡å®«ä¸»å¥åº·å®¶åº­",
            "west": "å…‘å®«ä¸»å­å¥³å£æ‰",
            "southeast": "å·½å®«ä¸»è´¢è¿æ–‡æ˜Œ",
            "southwest": "å¤å®«ä¸»æ¯äº²å¥åº·",
            "northeast": "è‰®å®«ä¸»å­å­™å­¦ä¸š",
            "northwest": "ä¹¾å®«ä¸»çˆ¶äº²äº‹ä¸š"
        }
        base_effect = position_effects.get(position, "å½±å“ç›¸å…³æ–¹é¢è¿åŠ¿")
        if star_info["nature"] == "å¤§å‰":
            return f"{base_effect}ï¼Œ{star_info['name']}é£ä¸´ï¼Œ{star_info['meaning']}ï¼Œå¤§åˆ©æ­¤æ–¹ä½æ´»åŠ¨"
        elif star_info["nature"] == "å‰":
            return f"{base_effect}ï¼Œ{star_info['name']}é£ä¸´ï¼Œ{star_info['meaning']}ï¼Œåˆ©æ­¤æ–¹ä½å‘å±•"
        elif star_info["nature"] == "å‡¶":
            return f"{base_effect}ï¼Œ{star_info['name']}é£ä¸´ï¼Œ{star_info['meaning']}ï¼Œéœ€è¦åŒ–è§£è°ƒç†"
        else:  # å¤§å‡¶
            return f"{base_effect}ï¼Œ{star_info['name']}é£ä¸´ï¼Œ{star_info['meaning']}ï¼ŒåŠ¡å¿…é‡ç‚¹åŒ–è§£"
    def get_floor_star_effect(self, floor_star):
        """è·å–æ¥¼å±‚æ˜Ÿå½±å“"""
        floor_effects = {
            1: "ä¸€ç™½æ°´æ˜Ÿï¼Œåˆ©æ™ºæ…§å­¦ä¹ ï¼Œå®œåšä¹¦æˆ¿",
            2: "äºŒé»‘åœŸæ˜Ÿï¼Œæ˜“ç”Ÿç–¾ç—…ï¼Œéœ€è¦åŒ–è§£",
            3: "ä¸‰ç¢§æœ¨æ˜Ÿï¼Œæ˜“æœ‰æ˜¯éï¼Œå®œé™ä¸å®œåŠ¨",
            4: "å››ç»¿æœ¨æ˜Ÿï¼Œåˆ©æ–‡æ˜Œæ¡ƒèŠ±ï¼Œå®œåšä¹¦æˆ¿å§å®¤",
            5: "äº”é»„åœŸæ˜Ÿï¼Œå¤§å‡¶ä¹‹æ˜Ÿï¼Œéœ€è¦é‡ç‚¹åŒ–è§£",
            6: "å…­ç™½é‡‘æ˜Ÿï¼Œåˆ©æƒå¨è´¢è¿ï¼Œå®œåšä¸»å§å®¢å…",
            7: "ä¸ƒèµ¤é‡‘æ˜Ÿï¼Œæ˜“æœ‰ç›—è´¼ï¼Œæ³¨æ„å®‰å…¨",
            8: "å…«ç™½åœŸæ˜Ÿï¼Œå¤§åˆ©è´¢è¿ï¼Œå®œåšè´¢ä½",
            9: "ä¹ç´«ç«æ˜Ÿï¼Œåˆ©åå£°å–œåº†ï¼Œå®œåšå®¢å…"
        }
        return floor_effects.get(floor_star, "éœ€è¦å…·ä½“åˆ†æ")
    def calculate_mingua(self, birth_year, gender):
        """
        è®¡ç®—å‘½å¦ï¼ˆå…«å®…å‘½å¦ï¼‰
        ğŸ”¥ P0ä¿®å¤ï¼šæ–°å¢å‘½å¦è®¡ç®—åŠŸèƒ½

        å…«å®…å‘½å¦è®¡ç®—æ–¹æ³•ï¼ˆä¼ ç»Ÿæ–¹æ³•ï¼‰ï¼š
        - ç”·æ€§ï¼š(100 - å‡ºç”Ÿå¹´ä»½åä¸¤ä½æ•°) Ã· 9ï¼Œå–ä½™æ•°
        - å¥³æ€§ï¼š(å‡ºç”Ÿå¹´ä»½åä¸¤ä½æ•° + 5) Ã· 9ï¼Œå–ä½™æ•°
        - å¦‚æœä½™æ•°ä¸º0ï¼Œåˆ™ä¸º9ï¼ˆç¦»å¦ï¼‰
        """
        try:
            # è·å–å‡ºç”Ÿå¹´ä»½çš„åä¸¤ä½æ•°
            year_last_two = birth_year % 100

            # è®¡ç®—å‘½å¦æ•°å­—
            if gender == 'ç”·':
                # ç”·æ€§è®¡ç®—å…¬å¼ï¼š(100 - åä¸¤ä½æ•°) % 9
                mingua_num = (100 - year_last_two) % 9
                if mingua_num == 0:
                    mingua_num = 9
            else:  # å¥³
                # å¥³æ€§è®¡ç®—å…¬å¼ï¼š(åä¸¤ä½æ•° + 5) % 9
                mingua_num = (year_last_two + 5) % 9
                if mingua_num == 0:
                    mingua_num = 9

            # å‘½å¦å¯¹åº”è¡¨
            mingua_map = {
                1: 'å', 2: 'å¤', 3: 'éœ‡', 4: 'å·½',
                5: 'å¤', 6: 'ä¹¾', 7: 'å…‘', 8: 'è‰®', 9: 'ç¦»'
            }

            mingua = mingua_map.get(mingua_num, 'æœªçŸ¥')

            return {
                'mingua': mingua,
                'mingua_num': mingua_num,
                'description': f"{gender}å‘½ï¼Œ{birth_year}å¹´ç”Ÿï¼Œå‘½å¦ä¸º{mingua}ï¼ˆ{mingua_num}ï¼‰"
            }
        except Exception as e:
            print(f"âš ï¸ å‘½å¦è®¡ç®—å¤±è´¥: {e}")
            return {'mingua': 'æœªçŸ¥', 'mingua_num': 0, 'description': 'è®¡ç®—å¤±è´¥'}

    def analyze_bazhai_professional(self, direction, birth_year=None, gender=None):
        """
        ä¸“ä¸šå…«å®…åˆ†æ
        ğŸ”¥ P0ä¿®å¤ï¼šç»“åˆä¸ªäººå‘½å¦ç»™å‡ºä¸ªæ€§åŒ–å»ºè®®
        """
        analysis = {}

        # ğŸ”¥ P0ä¿®å¤ï¼šå¦‚æœæä¾›äº†ä¸ªäººä¿¡æ¯ï¼Œè®¡ç®—å‘½å¦
        mingua_info = None
        if birth_year and gender:
            mingua_info = self.calculate_mingua(birth_year, gender)
            analysis['mingua'] = mingua_info

        # å…«å®…å‰å‡¶æ–¹ä½ï¼ˆä»¥åå‘ä¸ºå‡†ï¼‰
        bazhai_positions = {
            "ååŒ—æœå—": {
                "ç”Ÿæ°”": "ä¸œå—", "å¤©åŒ»": "ä¸œæ–¹", "å»¶å¹´": "å—æ–¹", "ä¼ä½": "åŒ—æ–¹",
                "ç»å‘½": "è¥¿å—", "äº”é¬¼": "ä¸œåŒ—", "å…­ç…": "è¥¿åŒ—", "ç¥¸å®³": "è¥¿æ–¹"
            },
            "åä¸œæœè¥¿": {
                "ç”Ÿæ°”": "å—æ–¹", "å¤©åŒ»": "åŒ—æ–¹", "å»¶å¹´": "ä¸œå—", "ä¼ä½": "ä¸œæ–¹",
                "ç»å‘½": "è¥¿æ–¹", "äº”é¬¼": "è¥¿åŒ—", "å…­ç…": "è¥¿å—", "ç¥¸å®³": "ä¸œåŒ—"
            },
            "åå—æœåŒ—": {
                "ç”Ÿæ°”": "ä¸œæ–¹", "å¤©åŒ»": "ä¸œå—", "å»¶å¹´": "åŒ—æ–¹", "ä¼ä½": "å—æ–¹",
                "ç»å‘½": "ä¸œåŒ—", "äº”é¬¼": "è¥¿æ–¹", "å…­ç…": "è¥¿åŒ—", "ç¥¸å®³": "è¥¿å—"
            },
            "åè¥¿æœä¸œ": {
                "ç”Ÿæ°”": "è¥¿åŒ—", "å¤©åŒ»": "è¥¿å—", "å»¶å¹´": "ä¸œåŒ—", "ä¼ä½": "è¥¿æ–¹",
                "ç»å‘½": "ä¸œæ–¹", "äº”é¬¼": "å—æ–¹", "å…­ç…": "ä¸œå—", "ç¥¸å®³": "åŒ—æ–¹"
            },
            "åä¸œåŒ—æœè¥¿å—": {
                "ç”Ÿæ°”": "è¥¿æ–¹", "å¤©åŒ»": "è¥¿åŒ—", "å»¶å¹´": "è¥¿å—", "ä¼ä½": "ä¸œåŒ—",
                "ç»å‘½": "å—æ–¹", "äº”é¬¼": "ä¸œæ–¹", "å…­ç…": "åŒ—æ–¹", "ç¥¸å®³": "ä¸œå—"
            },
            "åè¥¿å—æœä¸œåŒ—": {
                "ç”Ÿæ°”": "ä¸œåŒ—", "å¤©åŒ»": "è¥¿æ–¹", "å»¶å¹´": "è¥¿åŒ—", "ä¼ä½": "è¥¿å—",
                "ç»å‘½": "ä¸œå—", "äº”é¬¼": "åŒ—æ–¹", "å…­ç…": "ä¸œæ–¹", "ç¥¸å®³": "å—æ–¹"
            },
            "åä¸œå—æœè¥¿åŒ—": {
                "ç”Ÿæ°”": "åŒ—æ–¹", "å¤©åŒ»": "å—æ–¹", "å»¶å¹´": "ä¸œæ–¹", "ä¼ä½": "ä¸œå—",
                "ç»å‘½": "è¥¿åŒ—", "äº”é¬¼": "è¥¿å—", "å…­ç…": "è¥¿æ–¹", "ç¥¸å®³": "ä¸œåŒ—"
            },
            "åè¥¿åŒ—æœä¸œå—": {
                "ç”Ÿæ°”": "è¥¿å—", "å¤©åŒ»": "ä¸œåŒ—", "å»¶å¹´": "è¥¿æ–¹", "ä¼ä½": "è¥¿åŒ—",
                "ç»å‘½": "åŒ—æ–¹", "äº”é¬¼": "ä¸œå—", "å…­ç…": "å—æ–¹", "ç¥¸å®³": "ä¸œæ–¹"
            }
        }
        positions = bazhai_positions.get(direction, bazhai_positions["ååŒ—æœå—"])
        # å‰å‡¶æ–¹ä½è¯¦ç»†åˆ†æ
        position_meanings = {
            "ç”Ÿæ°”": {"level": "å¤§å‰", "benefit": "ä¸»è´¢è¿ã€å¥åº·ã€ç”Ÿè‚²", "suitable": "å¤§é—¨ã€ä¸»å§ã€å®¢å…"},
            "å¤©åŒ»": {"level": "ä¸­å‰", "benefit": "ä¸»å¥åº·ã€è´µäººã€æ²»ç—…", "suitable": "å§å®¤ã€å¨æˆ¿ã€é¤å…"},
            "å»¶å¹´": {"level": "ä¸­å‰", "benefit": "ä¸»é•¿å¯¿ã€å’Œè°ã€å©šå§»", "suitable": "ä¸»å§ã€è€äººæˆ¿ã€å¤«å¦»æˆ¿"},
            "ä¼ä½": {"level": "å°å‰", "benefit": "ä¸»å¹³å®‰ã€ç¨³å®šã€æ€è€ƒ", "suitable": "ä¹¦æˆ¿ã€é™å®¤ã€å‚¨è—å®¤"},
            "ç»å‘½": {"level": "å¤§å‡¶", "benefit": "ä¸»æ­»äº¡ã€ç»å—£ã€ç ´è´¢", "suitable": "å•æ‰€ã€åƒåœ¾æˆ¿ã€ä¸å®œå±…ä½"},
            "äº”é¬¼": {"level": "å¤§å‡¶", "benefit": "ä¸»ç–¾ç—…ã€å®˜å¸ã€æ„å¤–", "suitable": "å•æ‰€ã€å‚¨è—å®¤ã€ä¸å®œå±…ä½"},
            "å…­ç…": {"level": "ä¸­å‡¶", "benefit": "ä¸»æ¡ƒèŠ±åŠ«ã€ç ´è´¢ã€ç–¾ç—…", "suitable": "å•æ‰€ã€è¿‡é“ã€ä¸å®œä¹…ç•™"},
            "ç¥¸å®³": {"level": "å°å‡¶", "benefit": "ä¸»å£èˆŒã€æ˜¯éã€å°äºº", "suitable": "å•æ‰€ã€æ‚ç‰©é—´ã€ä¸å®œåŠå…¬"}
        }
        analysis["positions"] = {}
        for meaning, direction_name in positions.items():
            info = position_meanings[meaning]
            analysis["positions"][direction_name] = {
                "type": meaning,
                "level": info["level"],
                "benefit": info["benefit"],
                "suitable": info["suitable"]
            }
        # é‡ç‚¹å»ºè®®
        analysis["key_recommendations"] = {
            "best_door": positions["ç”Ÿæ°”"],
            "best_bedroom": positions["å»¶å¹´"],
            "best_kitchen": positions["å¤©åŒ»"],
            "best_study": positions["ä¼ä½"],
            "avoid_areas": [positions["ç»å‘½"], positions["äº”é¬¼"]]
        }

        # ğŸ”¥ P0ä¿®å¤ï¼šç»“åˆä¸ªäººå‘½å¦ç»™å‡ºä¸ªæ€§åŒ–å»ºè®®
        if mingua_info and mingua_info.get('mingua') != 'æœªçŸ¥':
            mingua = mingua_info['mingua']

            # å‘½å¦ä¸å®…å¦çš„åŒ¹é…å…³ç³»
            # ä¸œå››å‘½ï¼ˆå1ã€éœ‡3ã€å·½4ã€ç¦»9ï¼‰é€‚åˆä¸œå››å®…
            # è¥¿å››å‘½ï¼ˆå¤2ã€ä¹¾6ã€å…‘7ã€è‰®8ï¼‰é€‚åˆè¥¿å››å®…
            dong_si_ming = ['å', 'éœ‡', 'å·½', 'ç¦»']
            xi_si_ming = ['å¤', 'ä¹¾', 'å…‘', 'è‰®']

            dong_si_zhai = ['ååŒ—æœå—', 'åä¸œæœè¥¿', 'åä¸œå—æœè¥¿åŒ—', 'åå—æœåŒ—']
            xi_si_zhai = ['åä¸œåŒ—æœè¥¿å—', 'åè¥¿åŒ—æœä¸œå—', 'åè¥¿æœä¸œ', 'åè¥¿å—æœä¸œåŒ—']

            is_dong_si_ming = mingua in dong_si_ming
            is_dong_si_zhai = direction in dong_si_zhai

            # åˆ¤æ–­å‘½å®…æ˜¯å¦åŒ¹é…
            if (is_dong_si_ming and is_dong_si_zhai) or (not is_dong_si_ming and not is_dong_si_zhai):
                match_level = "åŒ¹é…"
                match_desc = f"å‘½å¦{mingua}ä¸å®…å¦åŒ¹é…ï¼Œå±…ä½å‰åˆ©"
            else:
                match_level = "ä¸åŒ¹é…"
                match_desc = f"å‘½å¦{mingua}ä¸å®…å¦ä¸åŒ¹é…ï¼Œå»ºè®®è°ƒæ•´å¸ƒå±€æˆ–é€‰æ‹©æ›´é€‚åˆçš„æˆ¿å±‹"

            analysis["mingua_match"] = {
                "level": match_level,
                "description": match_desc,
                "mingua": mingua,
                "advice": "å»ºè®®åœ¨ç”Ÿæ°”ã€å»¶å¹´ã€å¤©åŒ»ã€ä¼ä½ç­‰å‰æ–¹è®¾ç½®é‡è¦åŠŸèƒ½åŒº" if match_level == "åŒ¹é…" else "å»ºè®®é€‰æ‹©ä¸å‘½å¦åŒ¹é…çš„æˆ¿å±‹ï¼Œæˆ–é€šè¿‡è°ƒæ•´å¸ƒå±€åŒ–è§£"
            }

        return analysis
    def analyze_room_layout_professional(self, direction_info):
        """ä¸“ä¸šæˆ¿é—´å¸ƒå±€åˆ†æ"""
        analysis = {}
        element = direction_info['element']
        # æ ¹æ®äº”è¡Œç¡®å®šæœ€ä½³æˆ¿é—´å¸ƒå±€
        room_layouts = {
            'æ°´': {
                'master_bedroom': 'åŒ—æ–¹æˆ–è¥¿æ–¹ï¼Œåˆ©äºä¼‘æ¯å’Œæ€è€ƒ',
                'children_room': 'ä¸œæ–¹æˆ–ä¸œå—æ–¹ï¼Œåˆ©äºå­¦ä¹ æˆé•¿',
                'kitchen': 'å—æ–¹æˆ–ä¸œæ–¹ï¼Œç«æœ¨ç”Ÿæ—ºï¼Œä½†éœ€é˜²æ°´ç«ç›¸å†²',
                'bathroom': 'åŒ—æ–¹æˆ–è¥¿æ–¹ï¼Œç¬¦åˆæ°´æ€§ï¼Œä½†éœ€é€šé£',
                'study': 'ä¸œå—æ–¹æˆ–ä¸œæ–¹ï¼Œåˆ©äºæ™ºæ…§å‘æŒ¥',
                'living_room': 'å—æ–¹æˆ–ä¸­å¤®ï¼Œèšæ°”æ—ºè¿',
                'dining_room': 'ä¸œæ–¹æˆ–ä¸œå—æ–¹ï¼Œåˆ©äºå®¶åº­å’Œç¦'
            },
            'æœ¨': {
                'master_bedroom': 'ä¸œæ–¹æˆ–ä¸œå—æ–¹ï¼Œç¬¦åˆæœ¨æ€§ç”Ÿé•¿',
                'children_room': 'ä¸œæ–¹ï¼Œåˆ©äºå¥åº·æˆé•¿',
                'kitchen': 'ä¸œå—æ–¹ï¼Œæœ¨ç«ç›¸ç”Ÿï¼Œåˆ©äºå¥åº·',
                'bathroom': 'è¥¿æ–¹æˆ–è¥¿åŒ—æ–¹ï¼Œé‡‘å…‹æœ¨ï¼Œéœ€è¦åŒ–è§£',
                'study': 'ä¸œæ–¹æˆ–å—æ–¹ï¼Œåˆ©äºå­¦ä¸šäº‹ä¸š',
                'living_room': 'ä¸œå—æ–¹æˆ–å—æ–¹ï¼Œæœ¨ç«é€šæ˜',
                'dining_room': 'ä¸œæ–¹ï¼Œåˆ©äºå®¶åº­å’Œè°'
            },
            'ç«': {
                'master_bedroom': 'å—æ–¹æˆ–ä¸œæ–¹ï¼Œç«æœ¨ç›¸ç”Ÿ',
                'children_room': 'å—æ–¹æˆ–ä¸œå—æ–¹ï¼Œåˆ©äºæ´»æ³¼æˆé•¿',
                'kitchen': 'å—æ–¹ï¼Œç«æ—ºä¹‹åœ°ï¼Œä½†éœ€é˜²è¿‡æ—º',
                'bathroom': 'åŒ—æ–¹ï¼Œæ°´ç«æ—¢æµï¼Œéœ€è¦å¹³è¡¡',
                'study': 'ä¸œå—æ–¹æˆ–å—æ–¹ï¼Œåˆ©äºåå£°å­¦ä¸š',
                'living_room': 'å—æ–¹æˆ–ä¸­å¤®ï¼Œç«æ—ºèšæ°”',
                'dining_room': 'å—æ–¹æˆ–ä¸œæ–¹ï¼Œæ¸©æš–å’Œè°'
            },
            'åœŸ': {
                'master_bedroom': 'è¥¿å—æ–¹æˆ–ä¸œåŒ—æ–¹ï¼ŒåœŸæ—ºç¨³å›º',
                'children_room': 'ä¸œåŒ—æ–¹ï¼Œåˆ©äºå­¦ä¸šç¨³å®š',
                'kitchen': 'è¥¿å—æ–¹æˆ–ä¸­å¤®ï¼ŒåœŸæ—ºå¥è„¾',
                'bathroom': 'ä¸œæ–¹æˆ–ä¸œå—æ–¹ï¼Œæœ¨å…‹åœŸï¼Œéœ€è¦è°ƒå’Œ',
                'study': 'ä¸œåŒ—æ–¹æˆ–ä¸­å¤®ï¼Œåˆ©äºè¸å®å­¦ä¹ ',
                'living_room': 'ä¸­å¤®æˆ–è¥¿å—æ–¹ï¼Œç¨³é‡èšè´¢',
                'dining_room': 'è¥¿å—æ–¹ï¼Œåˆ©äºè„¾èƒƒå¥åº·'
            },
            'é‡‘': {
                'master_bedroom': 'è¥¿æ–¹æˆ–è¥¿åŒ—æ–¹ï¼Œé‡‘æ—ºæƒå¨',
                'children_room': 'è¥¿æ–¹ï¼Œåˆ©äºç†æ€§å‘å±•',
                'kitchen': 'è¥¿åŒ—æ–¹æˆ–è¥¿æ–¹ï¼Œä½†éœ€é˜²ç«å…‹é‡‘',
                'bathroom': 'è¥¿æ–¹ï¼Œé‡‘æ°´ç›¸ç”Ÿï¼Œåˆ©äºæ¸…æ´',
                'study': 'è¥¿åŒ—æ–¹æˆ–è¥¿æ–¹ï¼Œåˆ©äºç†æ€§æ€è€ƒ',
                'living_room': 'è¥¿æ–¹æˆ–è¥¿åŒ—æ–¹ï¼Œæƒå¨èšæ°”',
                'dining_room': 'è¥¿æ–¹ï¼Œåˆ©äºå®¶åº­ç§©åº'
            }
        }
        if element in room_layouts:
            analysis['room_recommendations'] = room_layouts[element]
        # æˆ¿é—´ç¦å¿Œ
        analysis['room_taboos'] = {
            'å§å®¤': 'ä¸å®œæ­£å¯¹å•æ‰€é—¨ã€å¨æˆ¿é—¨ï¼Œä¸å®œåœ¨æ¨ªæ¢ä¸‹ï¼Œä¸å®œé•œå­å¯¹åºŠ',
            'å¨æˆ¿': 'ä¸å®œæ­£å¯¹å¤§é—¨ã€å§å®¤é—¨ï¼Œä¸å®œåœ¨æˆ¿å±‹ä¸­å¤®ï¼Œç¶å°ä¸å®œèƒŒå¯¹é—¨',
            'å•æ‰€': 'ä¸å®œåœ¨æˆ¿å±‹ä¸­å¤®ï¼Œä¸å®œæ­£å¯¹å¤§é—¨ã€å§å®¤é—¨ã€å¨æˆ¿é—¨',
            'å®¢å…': 'ä¸å®œè¿‡äºç‹­é•¿ï¼Œä¸å®œæœ‰å¤ªå¤šå°–è§’ï¼Œæ²™å‘ä¸å®œèƒŒå¯¹é—¨',
            'ä¹¦æˆ¿': 'ä¸å®œåœ¨å•æ‰€æ—ï¼Œä¸å®œæ¨ªæ¢å‹é¡¶ï¼Œä¹¦æ¡Œä¸å®œèƒŒå¯¹é—¨'
        }
        # é—¨çª—å¸ƒå±€
        analysis['door_window_layout'] = {
            'å¤§é—¨': f'å®œå¼€åœ¨{self.get_best_door_direction(element)}ï¼Œå¿Œæ­£å¯¹å•æ‰€ã€å¨æˆ¿',
            'çª—æˆ·': 'å®œå—åŒ—é€šé€ï¼Œåˆ©äºé‡‡å…‰é€šé£ï¼Œå¿Œæ­£å¯¹å°–è§’å»ºç­‘',
            'é˜³å°': 'å®œæœå‘å‰æ–¹ï¼Œå¿Œæ­£å¯¹å¤©æ–©ç…ã€åå¼“ç…'
        }
        return analysis
    def get_best_door_direction(self, element):
        """è·å–æœ€ä½³å¼€é—¨æ–¹å‘"""
        door_directions = {
            'æ°´': 'åŒ—æ–¹ï¼ˆæœ¬å‘½æ–¹ï¼‰æˆ–è¥¿æ–¹ï¼ˆç”Ÿæ°”æ–¹ï¼‰',
            'æœ¨': 'ä¸œæ–¹ï¼ˆæœ¬å‘½æ–¹ï¼‰æˆ–åŒ—æ–¹ï¼ˆç”Ÿæ°”æ–¹ï¼‰',
            'ç«': 'å—æ–¹ï¼ˆæœ¬å‘½æ–¹ï¼‰æˆ–ä¸œæ–¹ï¼ˆç”Ÿæ°”æ–¹ï¼‰',
            'åœŸ': 'è¥¿å—æˆ–ä¸œåŒ—ï¼ˆæœ¬å‘½æ–¹ï¼‰æˆ–å—æ–¹ï¼ˆç”Ÿæ°”æ–¹ï¼‰',
            'é‡‘': 'è¥¿æ–¹ï¼ˆæœ¬å‘½æ–¹ï¼‰æˆ–è¥¿å—ï¼ˆç”Ÿæ°”æ–¹ï¼‰'
        }
        return door_directions.get(element, 'æ ¹æ®å…·ä½“æƒ…å†µç¡®å®š')
    def analyze_color_material_professional(self, direction_info):
        """ä¸“ä¸šé¢œè‰²æè´¨åˆ†æ"""
        analysis = {}
        element = direction_info['element']
        # äº”è¡Œé¢œè‰²é…ç½®
        color_schemes = {
            'æ°´': {
                'primary_colors': ['æ·±è“', 'é»‘è‰²', 'æ·±ç°'],
                'secondary_colors': ['ç™½è‰²', 'é“¶è‰²', 'æµ…è“'],
                'accent_colors': ['é‡‘è‰²', 'ç±³ç™½'],
                'avoid_colors': ['çº¢è‰²', 'æ©™è‰²', 'ç´«è‰²'],
                'description': 'ä»¥æ°´æ€§é¢œè‰²ä¸ºä¸»ï¼Œé‡‘æ€§é¢œè‰²ä¸ºè¾…ï¼Œé¿å…ç«æ€§é¢œè‰²'
            },
            'æœ¨': {
                'primary_colors': ['ç»¿è‰²', 'é’è‰²', 'ç¿ ç»¿'],
                'secondary_colors': ['æµ…ç»¿', 'è–„è·ç»¿', 'æ£®æ—ç»¿'],
                'accent_colors': ['è“è‰²', 'é»‘è‰²'],
                'avoid_colors': ['ç™½è‰²', 'é‡‘è‰²', 'é“¶è‰²'],
                'description': 'ä»¥æœ¨æ€§é¢œè‰²ä¸ºä¸»ï¼Œæ°´æ€§é¢œè‰²ä¸ºè¾…ï¼Œé¿å…é‡‘æ€§é¢œè‰²'
            },
            'ç«': {
                'primary_colors': ['çº¢è‰²', 'æ©™è‰²', 'ç´«è‰²'],
                'secondary_colors': ['ç²‰çº¢', 'æ¡ƒçº¢', 'é…’çº¢'],
                'accent_colors': ['ç»¿è‰²', 'é’è‰²'],
                'avoid_colors': ['é»‘è‰²', 'æ·±è“', 'æ·±ç°'],
                'description': 'ä»¥ç«æ€§é¢œè‰²ä¸ºä¸»ï¼Œæœ¨æ€§é¢œè‰²ä¸ºè¾…ï¼Œé¿å…æ°´æ€§é¢œè‰²'
            },
            'åœŸ': {
                'primary_colors': ['é»„è‰²', 'æ£•è‰²', 'åœŸé»„'],
                'secondary_colors': ['ç±³è‰²', 'å¡å…¶', 'å’–å•¡'],
                'accent_colors': ['çº¢è‰²', 'æ©™è‰²'],
                'avoid_colors': ['ç»¿è‰²', 'é’è‰²', 'ç¿ ç»¿'],
                'description': 'ä»¥åœŸæ€§é¢œè‰²ä¸ºä¸»ï¼Œç«æ€§é¢œè‰²ä¸ºè¾…ï¼Œé¿å…æœ¨æ€§é¢œè‰²'
            },
            'é‡‘': {
                'primary_colors': ['ç™½è‰²', 'é‡‘è‰²', 'é“¶è‰²'],
                'secondary_colors': ['ç±³ç™½', 'è±¡ç‰™ç™½', 'çç ç™½'],
                'accent_colors': ['é»„è‰²', 'æ£•è‰²'],
                'avoid_colors': ['çº¢è‰²', 'æ©™è‰²', 'ç´«è‰²'],
                'description': 'ä»¥é‡‘æ€§é¢œè‰²ä¸ºä¸»ï¼ŒåœŸæ€§é¢œè‰²ä¸ºè¾…ï¼Œé¿å…ç«æ€§é¢œè‰²'
            }
        }
        if element in color_schemes:
            analysis['color_scheme'] = color_schemes[element]
        # æè´¨é€‰æ‹©
        material_choices = {
            'æ°´': {
                'flooring': 'å¤§ç†çŸ³ã€ç“·ç –ã€æ·±è‰²æœ¨åœ°æ¿',
                'walls': 'ç»ç’ƒã€é•œé¢ã€é‡‘å±è£…é¥°',
                'furniture': 'ç»ç’ƒèŒ¶å‡ ã€é‡‘å±æ¡†æ¶ã€æ·±è‰²æœ¨æ',
                'fabrics': 'ä¸ç»¸ã€ç¼é¢ã€å…‰æ»‘æè´¨',
                'avoid': 'ç²—ç³™çŸ³æã€çº¢ç –ã€é™¶åœŸåˆ¶å“'
            },
            'æœ¨': {
                'flooring': 'å®æœ¨åœ°æ¿ã€ç«¹åœ°æ¿ã€è½¯æœ¨åœ°æ¿',
                'walls': 'æœ¨è´¨æŠ¤å¢™æ¿ã€ç«¹åˆ¶è£…é¥°ã€è—¤ç¼–ææ–™',
                'furniture': 'å®æœ¨å®¶å…·ã€ç«¹åˆ¶å“ã€è—¤åˆ¶å“',
                'fabrics': 'æ£‰éº»ã€äºšéº»ã€å¤©ç„¶çº¤ç»´',
                'avoid': 'é‡‘å±æè´¨ã€å¤§ç†çŸ³ã€ç“·ç –'
            },
            'ç«': {
                'flooring': 'çº¢æœ¨åœ°æ¿ã€æš–è‰²ç“·ç –ã€åœ°æ¯¯',
                'walls': 'æš–è‰²æ¶‚æ–™ã€æœ¨è´¨è£…é¥°ã€å¸ƒè‰ºè½¯åŒ…',
                'furniture': 'çº¢æœ¨å®¶å…·ã€çš®è´¨æ²™å‘ã€æš–è‰²è°ƒå®¶å…·',
                'fabrics': 'ç¾Šæ¯›ã€ç»’å¸ƒã€æš–è‰²è°ƒå¸ƒæ–™',
                'avoid': 'å†·è‰²è°ƒææ–™ã€é‡‘å±ã€ç»ç’ƒ'
            },
            'åœŸ': {
                'flooring': 'é™¶ç“·ç –ã€çŸ³æã€å¤åˆåœ°æ¿',
                'walls': 'çŸ³æã€é™¶åœŸç –ã€è´¨æ„Ÿæ¶‚æ–™',
                'furniture': 'å®æœ¨å®¶å…·ã€çŸ³æèŒ¶å‡ ã€é™¶ç“·è£…é¥°',
                'fabrics': 'åšé‡å¸ƒæ–™ã€æ¯›æ¯¯ã€è´¨æ„Ÿé¢æ–™',
                'avoid': 'è¿‡äºå…‰æ»‘ææ–™ã€é‡‘å±ã€ç»ç’ƒ'
            },
            'é‡‘': {
                'flooring': 'å¤§ç†çŸ³ã€ç“·ç –ã€é‡‘å±è£…é¥°åœ°æ¿',
                'walls': 'é‡‘å±è£…é¥°ã€é•œé¢ã€å…‰æ»‘æ¶‚æ–™',
                'furniture': 'é‡‘å±å®¶å…·ã€ç»ç’ƒèŒ¶å‡ ã€ç™½è‰²å®¶å…·',
                'fabrics': 'ä¸ç»¸ã€ç¼é¢ã€å…‰æ»‘é¢æ–™',
                'avoid': 'ç²—ç³™æœ¨æã€è—¤åˆ¶å“ã€æ¯›ç»’ææ–™'
            }
        }
        if element in material_choices:
            analysis['material_choices'] = material_choices[element]
        return analysis
    def analyze_fengshui_timing_professional(self):
        """ä¸“ä¸šé£æ°´æ—¶æœºåˆ†æ"""
        analysis = {}
        from datetime import datetime
        current_year = datetime.now().year
        current_month = datetime.now().month
        # æµå¹´é£æ°´åˆ†æ
        year_tg_index = (current_year - 4) % 10
        year_dz_index = (current_year - 4) % 12
        year_tg = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'][year_tg_index]
        year_dz = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'][year_dz_index]
        analysis['current_year'] = f"{current_year}å¹´ï¼ˆ{year_tg}{year_dz}ï¼‰"
        analysis['year_element'] = self.get_wuxing_by_tiangan(year_tg)
        # æœ€ä½³è£…ä¿®æ—¶æœº
        best_months = {
            'ç”²': [3, 4, 5],  # æ˜¥å­£æœ¨æ—º
            'ä¹™': [3, 4, 5],
            'ä¸™': [6, 7, 8],  # å¤å­£ç«æ—º
            'ä¸': [6, 7, 8],
            'æˆŠ': [6, 7, 8, 9],  # å¤æœ«ç§‹åˆåœŸæ—º
            'å·±': [6, 7, 8, 9],
            'åºš': [9, 10, 11],  # ç§‹å­£é‡‘æ—º
            'è¾›': [9, 10, 11],
            'å£¬': [12, 1, 2],  # å†¬å­£æ°´æ—º
            'ç™¸': [12, 1, 2]
        }
        analysis['best_renovation_months'] = best_months.get(year_tg, [3, 4, 5])
        # æ¬å®¶å‰æ—¥é€‰æ‹©
        analysis['moving_guidelines'] = {
            'avoid_months': 'å†œå†ä¸ƒæœˆï¼ˆé¬¼æœˆï¼‰ã€æœ¬å‘½å¹´å†²æœˆ',
            'best_days': 'é»„é“å‰æ—¥ã€æˆæ—¥ã€å¼€æ—¥ã€æ»¡æ—¥',
            'avoid_days': 'ç ´æ—¥ã€é—­æ—¥ã€å¹³æ—¥ã€æ”¶æ—¥',
            'time_selection': 'ä¸Šåˆ9-11ç‚¹ï¼ˆå·³æ—¶ï¼‰æˆ–ä¸‹åˆ1-3ç‚¹ï¼ˆæœªæ—¶ï¼‰'
        }
        # å½“å‰æœˆä»½å»ºè®®
        month_advice = {
            1: 'æ­£æœˆæ–°æ˜¥ï¼Œå®œå¸ƒç½®å–œåº†è£…é¥°ï¼Œä¸å®œå¤§åŠ¨åœŸæœ¨',
            2: 'äºŒæœˆæ˜¥å›ï¼Œå®œç§æ¤ç»¿æ¤ï¼Œè°ƒæ•´å®¶å…·å¸ƒå±€',
            3: 'ä¸‰æœˆæ˜¥åˆ†ï¼Œå®œå…¨é¢æ¸…æ´ï¼Œæ›´æ¢å¸ƒè‰ºè£…é¥°',
            4: 'å››æœˆæ¸…æ˜ï¼Œå®œç¥­ç¥–æ‰«å¢“ï¼Œè°ƒæ•´ç¥–å…ˆä½',
            5: 'äº”æœˆç«¯åˆï¼Œå®œæ‚¬æŒ‚è‰¾è‰ï¼Œé©±é‚ªé¿ç…',
            6: 'å…­æœˆå¤è‡³ï¼Œå®œè°ƒæ•´é‡‡å…‰ï¼Œå¢åŠ é€šé£',
            7: 'ä¸ƒæœˆä¸­å…ƒï¼Œå®œè°¨æ…è£…ä¿®ï¼Œé¿å…åŠ¨åœŸ',
            8: 'å…«æœˆä¸­ç§‹ï¼Œå®œå›¢åœ†å¸ƒç½®ï¼Œè°ƒæ•´å®¢å…',
            9: 'ä¹æœˆé‡é˜³ï¼Œå®œç™»é«˜æœ›è¿œï¼Œè°ƒæ•´è§†é‡',
            10: 'åæœˆå¯’éœ²ï¼Œå®œä¿æš–å¸ƒç½®ï¼Œè°ƒæ•´å§å®¤',
            11: 'åä¸€æœˆç«‹å†¬ï¼Œå®œå‚¨è—æ•´ç†ï¼Œè°ƒæ•´å‚¨ç‰©',
            12: 'åäºŒæœˆå†¬è‡³ï¼Œå®œæ¸©æš–å¸ƒç½®ï¼Œå‡†å¤‡æ–°å¹´'
        }
        analysis['current_month_advice'] = month_advice.get(current_month, 'æ ¹æ®å…·ä½“æƒ…å†µè°ƒæ•´')
        return analysis
    def get_fengshui_adjustment_methods(self, direction_info, flying_star):
        """è·å–é£æ°´è°ƒç†æ–¹æ³•"""
        methods = {}
        element = direction_info['element']
        # åŸºç¡€è°ƒç†æ–¹æ³•
        basic_methods = {
            'æ°´': {
                'enhance': 'æ‘†æ”¾é±¼ç¼¸ã€æ°´æ™¶çƒã€æµæ°´è£…é¥°ï¼Œå¢å¼ºæ°´å…ƒç´ ',
                'balance': 'é€‚å½“æ·»åŠ æœ¨å…ƒç´ ï¼ˆç»¿æ¤ï¼‰å’Œé‡‘å…ƒç´ ï¼ˆé‡‘å±è£…é¥°ï¼‰',
                'avoid': 'é¿å…è¿‡å¤šç«å…ƒç´ ï¼ˆçº¢è‰²ã€å°–è§’è£…é¥°ï¼‰'
            },
            'æœ¨': {
                'enhance': 'æ‘†æ”¾ç»¿æ¤ã€æœ¨åˆ¶å®¶å…·ã€ç«¹åˆ¶è£…é¥°ï¼Œå¢å¼ºæœ¨å…ƒç´ ',
                'balance': 'é€‚å½“æ·»åŠ æ°´å…ƒç´ ï¼ˆé±¼ç¼¸ï¼‰å’Œç«å…ƒç´ ï¼ˆæš–è‰²è°ƒï¼‰',
                'avoid': 'é¿å…è¿‡å¤šé‡‘å…ƒç´ ï¼ˆé‡‘å±è£…é¥°ã€ç™½è‰²ï¼‰'
            },
            'ç«': {
                'enhance': 'ä½¿ç”¨æš–è‰²è°ƒã€å¢åŠ ç…§æ˜ã€æ‘†æ”¾çº¢è‰²è£…é¥°',
                'balance': 'é€‚å½“æ·»åŠ æœ¨å…ƒç´ ï¼ˆç»¿æ¤ï¼‰å’ŒåœŸå…ƒç´ ï¼ˆé™¶ç“·ï¼‰',
                'avoid': 'é¿å…è¿‡å¤šæ°´å…ƒç´ ï¼ˆæ·±è‰²ã€æµæ°´è£…é¥°ï¼‰'
            },
            'åœŸ': {
                'enhance': 'ä½¿ç”¨é»„è‰²è°ƒã€æ‘†æ”¾é™¶ç“·ã€çŸ³æè£…é¥°',
                'balance': 'é€‚å½“æ·»åŠ ç«å…ƒç´ ï¼ˆæš–è‰²è°ƒï¼‰å’Œé‡‘å…ƒç´ ï¼ˆé‡‘å±ï¼‰',
                'avoid': 'é¿å…è¿‡å¤šæœ¨å…ƒç´ ï¼ˆè¿‡å¤šç»¿æ¤ã€æœ¨åˆ¶å“ï¼‰'
            },
            'é‡‘': {
                'enhance': 'ä½¿ç”¨ç™½è‰²è°ƒã€æ‘†æ”¾é‡‘å±è£…é¥°ã€æ°´æ™¶åˆ¶å“',
                'balance': 'é€‚å½“æ·»åŠ åœŸå…ƒç´ ï¼ˆé™¶ç“·ï¼‰å’Œæ°´å…ƒç´ ï¼ˆæµæ°´ï¼‰',
                'avoid': 'é¿å…è¿‡å¤šç«å…ƒç´ ï¼ˆçº¢è‰²ã€å°–è§’è£…é¥°ï¼‰'
            }
        }
        if element in basic_methods:
            methods['basic_adjustment'] = basic_methods[element]
        # åŒ–ç…æ–¹æ³•
        methods['sha_qi_resolution'] = {
            'å¤©æ–©ç…': 'æ‚¬æŒ‚å…«å¦é•œæˆ–æ‘†æ”¾æ³°å±±çŸ³',
            'è·¯å†²ç…': 'è®¾ç½®å±é£æˆ–æ‘†æ”¾çŸ³ç‹®å­',
            'å°–è§’ç…': 'æ‘†æ”¾ç»¿æ¤æˆ–åœ†å½¢è£…é¥°åŒ–è§£',
            'æ¨ªæ¢ç…': 'å®‰è£…å‡å¤©èŠ±æ¿æˆ–æ‚¬æŒ‚è‘«èŠ¦',
            'é•œé¢ç…': 'è°ƒæ•´é•œå­ä½ç½®æˆ–ç”¨å¸ƒé®æŒ¡',
            'å•æ‰€ç…': 'ä¿æŒæ¸…æ´é€šé£ï¼Œæ‘†æ”¾ç»¿æ¤'
        }
        # å‚¬æ—ºæ–¹æ³•
        methods['enhancement_methods'] = {
            'è´¢è¿': 'åœ¨è´¢ä½æ‘†æ”¾èšå®ç›†ã€é‡‘èŸ¾ã€å‘è´¢æ ‘',
            'äº‹ä¸š': 'åœ¨æ–‡æ˜Œä½æ‘†æ”¾æ–‡æ˜Œå¡”ã€æ°´æ™¶çƒã€ç«¹å­',
            'å¥åº·': 'åœ¨å¤©åŒ»ä½æ‘†æ”¾è‘«èŠ¦ã€é•¿å¯¿é¾Ÿã€å¥åº·æ¤ç‰©',
            'æ„Ÿæƒ…': 'åœ¨æ¡ƒèŠ±ä½æ‘†æ”¾ç²‰æ°´æ™¶ã€é¸³é¸¯ã€æˆå¯¹è£…é¥°',
            'å­¦ä¸š': 'åœ¨æ–‡æ˜Œä½æ‘†æ”¾æ–‡æˆ¿å››å®ã€æ°´æ™¶ã€ç»¿æ¤',
            'äººé™…': 'åœ¨è´µäººä½æ‘†æ”¾ç´«æ°´æ™¶ã€é©¬å½¢è£…é¥°ã€å¼€è¿ç«¹'
        }
        return methods
    def analyze_name_fortune(self, surname, given_name, bazi_result, gender):
        """å§“ååˆ†æ"""
        name_analysis = []
        # äº”æ ¼æ•°ç†åˆ†æ
        name_analysis.extend(self.analyze_wuge_mathematics(surname, given_name))
        # äº”è¡Œé…ç½®åˆ†æ
        name_analysis.extend(self.analyze_name_wuxing(surname, given_name, bazi_result))
        # éŸ³éŸµåˆ†æ
        name_analysis.extend(self.analyze_name_phonetics(surname, given_name))
        # å­—ä¹‰åˆ†æ
        name_analysis.extend(self.analyze_name_meaning(surname, given_name, gender))
        # å…«å­—åŒ¹é…åˆ†æ
        name_analysis.extend(self.analyze_name_bazi_match(surname, given_name, bazi_result))
        # ç»¼åˆè¯„åˆ†
        name_analysis.extend(self.calculate_name_overall_score(surname, given_name, bazi_result, gender))
        return "\n".join(name_analysis)
    def analyze_wuge_mathematics(self, surname, given_name):
        """äº”æ ¼æ•°ç†åˆ†æ"""
        analysis = []
        analysis.append("ã€äº”æ ¼æ•°ç†åˆ†æã€‘")

        # è®¡ç®—ç¬”ç”»æ•°ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…éœ€è¦åº·ç†™å­—å…¸ç¬”ç”»ï¼‰
        surname_strokes = self.get_character_strokes(surname)
        given_strokes = [self.get_character_strokes(char) for char in given_name]
        # äº”æ ¼è®¡ç®—
        tiange = sum(surname_strokes) + 1 if len(surname) == 1 else sum(surname_strokes)
        renge = surname_strokes[-1] + (given_strokes[0] if given_strokes else 1)
        dige = sum(given_strokes) if given_strokes else 1
        waige = tiange + dige - renge
        zongge = sum(surname_strokes) + sum(given_strokes)
        # äº”æ ¼å‰å‡¶åˆ†æ
        wuge_meanings = {
            1: "å¤ªæä¹‹æ•°ï¼Œä¸‡ç‰©å¼€æ³°ï¼Œç”Ÿå‘æ— ç©·ï¼Œåˆ©ç¦„äº¨é€šã€‚ã€å¤§å‰ã€‘",
            2: "ä¸¤ä»ªä¹‹æ•°ï¼Œæ··æ²Œæœªå¼€ï¼Œè¿›é€€ä¿å®ˆï¼Œå¿—æœ›éš¾è¾¾ã€‚ã€å¤§å‡¶ã€‘",
            3: "ä¸‰æ‰ä¹‹æ•°ï¼Œå¤©åœ°äººå’Œï¼Œå¤§äº‹å¤§ä¸šï¼Œç¹è£æ˜Œéš†ã€‚ã€å¤§å‰ã€‘",
            4: "å››è±¡ä¹‹æ•°ï¼Œå¾…äºç”Ÿå‘ï¼Œä¸‡äº‹æ…é‡ï¼Œä¸å…·è¥è°‹ã€‚ã€å‡¶ã€‘",
            5: "äº”è¡Œä¹‹æ•°ï¼Œå¾ªç¯ç›¸ç”Ÿï¼Œåœ†é€šç•…è¾¾ï¼Œç¦ç¥‰æ— ç©·ã€‚ã€å¤§å‰ã€‘",
            6: "å…­çˆ»ä¹‹æ•°ï¼Œå‘å±•å˜åŒ–ï¼Œå¤©èµ‹ç¾å¾·ï¼Œå‰ç¥¥å®‰æ³°ã€‚ã€å¤§å‰ã€‘",
            7: "ä¸ƒæ”¿ä¹‹æ•°ï¼Œç²¾æ‚ä¸¥è°¨ï¼Œå¤©èµ‹ä¹‹åŠ›ï¼Œå‰æ˜Ÿç…§è€€ã€‚ã€å‰ã€‘",
            8: "å…«å¦ä¹‹æ•°ï¼Œä¹¾åè‰®éœ‡ï¼Œå·½ç¦»å¤å…‘ï¼Œæ— ç©·æ— å°½ã€‚ã€å‰ã€‘",
            9: "å¤§æˆä¹‹æ•°ï¼Œè•´æ¶µå‡¶é™©ï¼Œæˆ–æˆæˆ–è´¥ï¼Œéš¾ä»¥æŠŠæ¡ã€‚ã€å‡¶ã€‘",
            10: "ç»ˆæ•°ä¹‹æ•°ï¼Œé›ªæš—é£˜é›¶ï¼Œå¶æˆ–æœ‰æˆï¼Œå›é¡¾èŒ«ç„¶ã€‚ã€å‡¶ã€‘",
            11: "æ—±è‹—é€¢é›¨ï¼Œæ¯æœ¨é€¢æ˜¥ï¼Œç¨³å¥ç€å®ï¼Œå¿…å¾—äººæœ›ã€‚ã€å¤§å‰ã€‘",
            12: "è–„å¼±æ— åŠ›ï¼Œå­¤ç«‹æ— æ´ï¼Œå¤–ç¥¥å†…è‹¦ï¼Œè°‹äº‹éš¾æˆã€‚ã€å‡¶ã€‘",
            13: "å¤©èµ‹å‰è¿ï¼Œèƒ½å¾—äººæœ›ï¼Œå–„ç”¨æ™ºæ…§ï¼Œå¿…è·æˆåŠŸã€‚ã€å¤§å‰ã€‘",
            14: "å¿å¾—è‹¦éš¾ï¼Œå¿…æœ‰åç¦ï¼Œæ˜¯æˆæ˜¯è´¥ï¼ŒæƒŸé åšæ¯…ã€‚ã€å‡¶ã€‘",
            15: "è°¦æ­åšäº‹ï¼Œå¤–å¾—äººå’Œï¼Œå¤§äº‹æˆå°±ï¼Œä¸€é—¨å…´éš†ã€‚ã€å¤§å‰ã€‘",
            16: "èƒ½è·ä¼—æœ›ï¼Œæˆå°±å¤§ä¸šï¼Œååˆ©åŒæ”¶ï¼Œç›Ÿä¸»å››æ–¹ã€‚ã€å¤§å‰ã€‘",
            17: "æƒå¨åˆšå¼ºï¼Œçªç ´ä¸‡éš¾ï¼Œå¦‚èƒ½å®¹å¿ï¼Œå¿…è·æˆåŠŸã€‚ã€åŠå‰ã€‘",
            18: "ç»å•†åšäº‹ï¼Œé¡ºåˆ©æ˜Œéš†ï¼Œå¦‚èƒ½æ…å§‹ï¼Œç™¾äº‹äº¨é€šã€‚ã€å¤§å‰ã€‘",
            19: "æ™ºé«˜å¿—å¤§ï¼Œå†å°½è‰°éš¾ï¼Œç„¦å¿ƒå¿§åŠ³ï¼Œè¿›é€€ä¸¤éš¾ã€‚ã€å‡¶ã€‘",
            20: "æ™ºå•†å¿—å¤§ï¼Œå†å°½è‰°éš¾ï¼Œç„¦å¿ƒå¿§åŠ³ï¼Œè¿›é€€ä¸¤éš¾ã€‚ã€å‡¶ã€‘",
            21: "å…ˆå†å›°è‹¦ï¼Œåå¾—å¹¸ç¦ï¼Œéœœé›ªæ¢…èŠ±ï¼Œæ˜¥æ¥æ€’æ”¾ã€‚ã€å¤§å‰ã€‘",
            22: "ç§‹è‰é€¢éœœï¼Œæ€€æ‰ä¸é‡ï¼Œå¿§æ„æ€¨è‹¦ï¼Œäº‹ä¸å¦‚æ„ã€‚ã€å‡¶ã€‘",
            23: "æ—­æ—¥ä¸œå‡ï¼Œå£®ä¸½å£®è§‚ï¼Œæƒå¨æ—ºç››ï¼ŒåŠŸåè£è¾¾ã€‚ã€å¤§å‰ã€‘",
            24: "é”¦ç»£å‰ç¨‹ï¼Œé¡»é è‡ªåŠ›ï¼Œå¤šç”¨æ™ºè°‹ï¼Œèƒ½å¥å¤§åŠŸã€‚ã€å¤§å‰ã€‘",
            25: "å¤©æ—¶åœ°åˆ©ï¼Œåªæ¬ äººå’Œï¼Œè®²ä¿¡ä¿®ç¦ï¼Œå³å¯æˆåŠŸã€‚ã€å¤§å‰ã€‘",
            26: "æ³¢æ¾œèµ·ä¼ï¼Œåƒå˜ä¸‡åŒ–ï¼Œå‡Œé©¾ä¸‡éš¾ï¼Œå¿…å¯æˆåŠŸã€‚ã€åŠå‡¶ã€‘",
            27: "ä¸€æˆä¸€è´¥ï¼Œä¸€ç››ä¸€è¡°ï¼ŒæƒŸé è°¨æ…ï¼Œç»ˆæˆå¤§ä¸šã€‚ã€åŠå‡¶ã€‘",
            28: "é±¼ä¸´æ—±åœ°ï¼Œéš¾é€ƒæ¶è¿ï¼Œæ­¤æ•°å¤§å‡¶ï¼Œä¸å¦‚æ›´åã€‚ã€å‡¶ã€‘",
            29: "å¦‚é¾™å¾—äº‘ï¼Œé’äº‘ç›´ä¸Šï¼Œæ™ºè°‹å¥‹è¿›ï¼Œæ‰ç•¥å¥åŠŸã€‚ã€åŠå‰ã€‘",
            30: "æ²‰æµ®ä¸å®šï¼Œå‡¶å‰éš¾å˜ï¼Œè‹¥æ˜è‹¥æš—ï¼Œå¤§æˆå¤§è´¥ã€‚ã€åŠå‡¶ã€‘",
            31: "æ­¤æ•°å¤§å‰ï¼Œååˆ©åŒæ”¶ï¼Œæ¸è¿›å‘ä¸Šï¼Œå¤§ä¸šæˆå°±ã€‚ã€å¤§å‰ã€‘",
            32: "æ± ä¸­ä¹‹é¾™ï¼Œé£äº‘é™…ä¼šï¼Œä¸€è·ƒä¸Šå¤©ï¼ŒæˆåŠŸå¯æœ›ã€‚ã€å¤§å‰ã€‘",
            33: "æ„æ°”ç”¨äº‹ï¼Œäººå’Œå¿…å¤±ï¼Œå–„ç”¨æ™ºæ…§ï¼Œå¦‚èƒ½æ…å§‹å¿…å¯æ˜Œéš†ã€‚ã€å¤§å‰ã€‘",
            34: "ç¾éš¾ä¸ç»ï¼Œéš¾æœ›æˆåŠŸï¼Œæ­¤æ•°å¤§å‡¶ï¼Œä¸å¦‚æ›´åã€‚ã€å¤§å‡¶ã€‘",
            35: "ä¸­å‰ä¹‹æ•°ï¼Œè¿›é€€ä¿å®ˆï¼Œç”Ÿæ„å®‰ç¨³ï¼Œæˆå°±æ™®é€šã€‚ã€å‰ã€‘",
            36: "æ³¢æ¾œé‡å ï¼Œå¸¸é™·ç©·å›°ï¼ŒåŠ¨ä¸å¦‚é™ï¼Œæœ‰æ‰æ— å‘½ã€‚ã€å‡¶ã€‘",
            37: "é€¢å‡¶åŒ–å‰ï¼Œå‰äººå¤©ç›¸ï¼Œé£è°ƒé›¨é¡ºï¼Œç”Ÿæ„å…´éš†ã€‚ã€å¤§å‰ã€‘",
            38: "åè™½å¯å¾—ï¼Œåˆ©åˆ™éš¾è·ï¼Œè‰ºç•Œå‘å±•ï¼Œå¯æœ›æˆåŠŸã€‚ã€åŠå‡¶ã€‘",
            39: "äº‘å¼€è§æœˆï¼Œè™½æœ‰åŠ³ç¢Œï¼Œå…‰æ˜å¦é€”ï¼ŒæŒ‡æ—¥å¯æœŸã€‚ã€å¤§å‰ã€‘",
            40: "ä¸€ç››ä¸€è¡°ï¼Œæµ®æ²‰ä¸å®šï¼ŒçŸ¥éš¾è€Œé€€ï¼Œè‡ªè·å¤©ä½‘ã€‚ã€åŠå‡¶ã€‘",
            41: "å¤©èµ‹å‰è¿ï¼Œå¾·æœ›å…¼å¤‡ï¼Œç»§ç»­åŠªåŠ›ï¼Œå‰é€”æ— é™ã€‚ã€å¤§å‰ã€‘",
            42: "äº‹ä¸šä¸ä¸“ï¼Œåä¹ä¸æˆï¼Œä¸“å¿ƒè¿›å–ï¼Œå¯æœ›æˆåŠŸã€‚ã€åŠå‡¶ã€‘",
            43: "é›¨å¤œä¹‹èŠ±ï¼Œå¤–ç¥¥å†…è‹¦ï¼Œå¿è€è‡ªé‡ï¼Œè½¬å‡¶ä¸ºå‰ã€‚ã€åŠå‡¶ã€‘",
            44: "è™½ç”¨å¿ƒè®¡ï¼Œäº‹éš¾é‚æ„¿ï¼Œè´ªåŠŸå¥½è¿›ï¼Œå¿…æ‹›å¤±è´¥ã€‚ã€å‡¶ã€‘",
            45: "æ¨æŸ³é‡æ˜¥ï¼Œç»¿å¶å‘æï¼Œå†²ç ´éš¾å…³ï¼Œä¸€ä¸¾æˆåã€‚ã€å¤§å‰ã€‘",
            46: "åå·ä¸å¹³ï¼Œè‰°éš¾é‡é‡ï¼Œè‹¥æ— è€å¿ƒï¼Œéš¾æœ›æœ‰æˆã€‚ã€å‡¶ã€‘",
            47: "æœ‰è´µäººåŠ©ï¼Œå¯æˆå¤§ä¸šï¼Œè™½é‡ä¸å¹¸ï¼Œæµ®æ²‰ä¸å¤§ã€‚ã€å¤§å‰ã€‘",
            48: "ç¾åŒ–ä¸°å®ï¼Œé¹¤ç«‹é¸¡ç¾¤ï¼Œååˆ©ä¿±å…¨ï¼Œç¹è£å¯Œè´µã€‚ã€å¤§å‰ã€‘",
            49: "é‡å‰åˆ™å‰ï¼Œé‡å‡¶åˆ™å‡¶ï¼ŒæƒŸé è°¨æ…ï¼Œé€¢å‡¶åŒ–å‰ã€‚ã€åŠå‡¶ã€‘",
            50: "å‰å‡¶äº’è§ï¼Œä¸€æˆä¸€è´¥ï¼Œå‡¶ä¸­æœ‰å‰ï¼Œå‰ä¸­æœ‰å‡¶ã€‚ã€åŠå‡¶ã€‘",
            51: "ä¸€ç››ä¸€è¡°ï¼Œæµ®æ²‰ä¸å¸¸ï¼Œè‡ªé‡è‡ªå¤„ï¼Œå¯ä¿å¹³å®‰ã€‚ã€åŠå‡¶ã€‘",
            52: "è‰æœ¨é€¢æ˜¥ï¼Œé›¨è¿‡å¤©æ™´ï¼Œæ¸¡è¿‡éš¾å…³ï¼Œå³è·æˆåŠŸã€‚ã€å¤§å‰ã€‘",
            53: "å¤–ç¥¥å†…æ‚£ï¼Œå¤–ç¥¸å†…å®‰ï¼Œå…ˆå¯Œåè´«ï¼Œå…ˆè´«åå¯Œã€‚ã€åŠå‡¶ã€‘",
            54: "è™½å€¾å…¨åŠ›ï¼Œéš¾æœ›æˆåŠŸï¼Œæ­¤æ•°å¤§å‡¶ï¼Œæœ€å¥½æ”¹åã€‚ã€å¤§å‡¶ã€‘",
            55: "å¤–è§‚æ˜Œéš†ï¼Œå†…éšç¥¸æ‚£ï¼Œå…‹æœéš¾å…³ï¼Œå¼€å‡ºæ³°è¿ã€‚ã€åŠå‡¶ã€‘",
            56: "äº‹ä¸æ„¿è¿ï¼Œç»ˆéš¾æˆåŠŸï¼Œæ¬²é€Ÿä¸è¾¾ï¼Œæœ‰å§‹æ— ç»ˆã€‚ã€å‡¶ã€‘",
            57: "è™½æœ‰å›°éš¾ï¼Œæ—¶æ¥è¿è½¬ï¼Œæ—·é‡æ¯è‰ï¼Œæ˜¥æ¥èŠ±å¼€ã€‚ã€åŠå‰ã€‘",
            58: "åŠå‡¶åŠå‰ï¼Œæµ®æ²‰å¤šç«¯ï¼Œå§‹å‡¶ç»ˆå‰ï¼Œèƒ½ä¿æˆåŠŸã€‚ã€åŠå‡¶ã€‘",
            59: "é‡äº‹çŒœç–‘ï¼Œéš¾æœ›æˆäº‹ï¼Œå¤§åˆ€é˜”æ–§ï¼Œå§‹å¯æœ‰æˆã€‚ã€å‡¶ã€‘",
            60: "é»‘æš—æ— å…‰ï¼Œå¿ƒè¿·æ„ä¹±ï¼Œå‡ºå°”åå°”ï¼Œéš¾å®šæ–¹é’ˆã€‚ã€å‡¶ã€‘",
            61: "äº‘é®åŠæœˆï¼Œç™¾éšé£æ³¢ï¼Œåº”è‡ªè°¨æ…ï¼Œå§‹ä¿å¹³å®‰ã€‚ã€åŠå‡¶ã€‘",
            62: "çƒ¦é—·æ‡Šæ¼ï¼Œäº‹äº‹éš¾å±•ï¼Œè‡ªé˜²ç¾ç¥¸ï¼Œå§‹å…å›°å¢ƒã€‚ã€å‡¶ã€‘",
            63: "ä¸‡ç‰©åŒ–è‚²ï¼Œç¹è£ä¹‹è±¡ï¼Œä¸“å¿ƒä¸€æ„ï¼Œå¿…èƒ½æˆåŠŸã€‚ã€å¤§å‰ã€‘",
            64: "è§å¼‚æ€è¿ï¼Œåä¹ä¸æˆï¼Œå¾’åŠ³æ— åŠŸï¼Œä¸å¦‚æ›´åã€‚ã€å‡¶ã€‘",
            65: "å‰è¿è‡ªæ¥ï¼Œèƒ½äº«ç››åï¼ŒæŠŠæ¡æœºä¼šï¼Œå¿…è·æˆåŠŸã€‚ã€å¤§å‰ã€‘",
            66: "é»‘å¤œæ¼«é•¿ï¼Œè¿›é€€ç»´è°·ï¼Œå†…å¤–ä¸å’Œï¼Œä¿¡ç”¨ç¼ºä¹ã€‚ã€å‡¶ã€‘",
            67: "ç‹¬è¥äº‹ä¸šï¼Œäº‹äº‹å¦‚æ„ï¼ŒåŠŸæˆåå°±ï¼Œå¯Œè´µè‡ªæ¥ã€‚ã€å¤§å‰ã€‘",
            68: "æ€è™‘å‘¨è¯¦ï¼Œè®¡åˆ’åŠ›è¡Œï¼Œä¸å¤±å…ˆæœºï¼Œå¯æœ›æˆåŠŸã€‚ã€å¤§å‰ã€‘",
            69: "åŠ¨æ‘‡ä¸å®‰ï¼Œå¸¸é™·é€†å¢ƒï¼Œä¸å¾—æ—¶è¿ï¼Œéš¾å¾—åˆ©æ¶¦ã€‚ã€å‡¶ã€‘",
            70: "æƒ¨æ·¡ç»è¥ï¼Œéš¾å…è´«å›°ï¼Œæ­¤æ•°ä¸å‰ï¼Œæœ€å¥½æ”¹åã€‚ã€å‡¶ã€‘",
            71: "å‰å‡¶å‚åŠï¼ŒæƒŸèµ–å‹‡æ°”ï¼Œè´¯å½»åŠ›è¡Œï¼Œå§‹å¯æˆåŠŸã€‚ã€åŠå‡¶ã€‘",
            72: "åˆ©å®³æ··é›†ï¼Œå‡¶å¤šå‰å°‘ï¼Œå¾—è€Œå¤å¤±ï¼Œéš¾ä»¥å®‰é¡ºã€‚ã€å‡¶ã€‘",
            73: "å®‰ä¹è‡ªæ¥ï¼Œè‡ªç„¶å‰ç¥¥ï¼ŒåŠ›è¡Œä¸æ‡ˆï¼Œç»ˆå¿…æˆåŠŸã€‚ã€åŠå‰ã€‘",
            74: "åˆ©ä¸åŠè´¹ï¼Œåé£Ÿå±±ç©ºï¼Œå¦‚æ— æ™ºè°‹ï¼Œéš¾æœ›æˆåŠŸã€‚ã€å‡¶ã€‘",
            75: "å‰ä¸­å¸¦å‡¶ï¼Œæ¬²é€Ÿä¸è¾¾ï¼Œè¿›ä¸å¦‚å®ˆï¼Œå¯ä¿å®‰ç¥¥ã€‚ã€åŠå‡¶ã€‘",
            76: "æ­¤æ•°å¤§å‡¶ï¼Œç ´äº§ä¹‹è±¡ï¼Œå®œé€Ÿæ”¹åï¼Œä»¥é¿å„è¿ã€‚ã€å‡¶ã€‘",
            77: "å…ˆè‹¦åç”˜ï¼Œå…ˆç”˜åè‹¦ï¼Œå¦‚èƒ½å®ˆæˆï¼Œä¸è‡´å¤±è´¥ã€‚ã€åŠå‡¶ã€‘",
            78: "æœ‰å¾—æœ‰å¤±ï¼Œåè€Œä¸å®ï¼Œé¡»é˜²åŠ«è´¢ï¼Œå§‹ä¿å®‰é¡ºã€‚ã€åŠå‡¶ã€‘",
            79: "å¦‚èµ°å¤œè·¯ï¼Œå‰é€”æ— å…‰ï¼Œå¸Œæœ›ä¸å¤§ï¼ŒåŠ³è€Œæ— åŠŸã€‚ã€å‡¶ã€‘",
            80: "å¾—è€Œå¤å¤±ï¼Œæ‰è´¹å¿ƒæœºï¼Œå®ˆæˆæ— è´ªï¼Œå¯ä¿å®‰ç¨³ã€‚ã€å‡¶ã€‘",
            81: "æœ€æä¹‹æ•°ï¼Œè¿˜æœ¬å½’å…ƒï¼Œèƒ½å¾—ç¹è£ï¼Œå‘è¾¾æˆåŠŸã€‚ã€å¤§å‰ã€‘"
        }
        # æ˜¾ç¤ºäº”æ ¼åˆ†æ
        analysis.append(f"â€¢ å¤©æ ¼ï¼š{tiange} - {wuge_meanings.get(tiange % 81 if tiange > 81 else tiange, 'éœ€è¦è¯¦ç»†åˆ†æ')}")
        analysis.append(f"â€¢ äººæ ¼ï¼š{renge} - {wuge_meanings.get(renge % 81 if renge > 81 else renge, 'éœ€è¦è¯¦ç»†åˆ†æ')}")
        analysis.append(f"â€¢ åœ°æ ¼ï¼š{dige} - {wuge_meanings.get(dige % 81 if dige > 81 else dige, 'éœ€è¦è¯¦ç»†åˆ†æ')}")
        analysis.append(f"â€¢ å¤–æ ¼ï¼š{waige} - {wuge_meanings.get(waige % 81 if waige > 81 else waige, 'éœ€è¦è¯¦ç»†åˆ†æ')}")
        analysis.append(f"â€¢ æ€»æ ¼ï¼š{zongge} - {wuge_meanings.get(zongge % 81 if zongge > 81 else zongge, 'éœ€è¦è¯¦ç»†åˆ†æ')}")
        return analysis
    def get_character_strokes(self, char):
        """è·å–å­—ç¬¦ç¬”ç”»æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰"""
        # è¿™é‡Œæ˜¯ç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…åº”è¯¥ä½¿ç”¨åº·ç†™å­—å…¸ç¬”ç”»æ•°
        stroke_dict = {
            # å¸¸ç”¨å§“æ°ç¬”ç”»
            'ç‹': 4, 'æ': 7, 'å¼ ': 11, 'åˆ˜': 15, 'é™ˆ': 16, 'æ¨': 13, 'èµµ': 14, 'é»„': 12,
            'å‘¨': 8, 'å´': 7, 'å¾': 10, 'å­™': 10, 'èƒ¡': 9, 'æœ±': 6, 'é«˜': 10, 'æ—': 8,
            'ä½•': 7, 'éƒ­': 15, 'é©¬': 10, 'ç½—': 19, 'æ¢': 11, 'å®‹': 7, 'éƒ‘': 19, 'è°¢': 17,
            'éŸ©': 17, 'å”': 10, 'å†¯': 12, 'äº': 3, 'è‘£': 15, 'è§': 18, 'ç¨‹': 12, 'æ›¹': 11,
            'è¢': 10, 'é‚“': 19, 'è®¸': 11, 'å‚…': 12, 'æ²ˆ': 7, 'æ›¾': 12, 'å½­': 12, 'å•': 7,
            'è‹': 22, 'å¢': 16, 'è’‹': 17, 'è”¡': 17, 'è´¾': 13, 'ä¸': 2, 'é­': 18, 'è–›': 19,
            'å¶': 15, 'é˜': 16, 'ä½™': 7, 'æ½˜': 16, 'æœ': 7, 'æˆ´': 18, 'å¤': 10, 'é’Ÿ': 17,
            'æ±ª': 8, 'ç”°': 5, 'ä»»': 6, 'å§œ': 9, 'èŒƒ': 15, 'æ–¹': 4, 'çŸ³': 5, 'å§š': 9,
            'è°­': 19, 'å»–': 14, 'é‚¹': 17, 'ç†Š': 14, 'é‡‘': 8, 'é™†': 16, 'éƒ': 14, 'å­”': 4,
            'ç™½': 5, 'å´”': 11, 'åº·': 11, 'æ¯›': 4, 'é‚±': 12, 'ç§¦': 10, 'æ±Ÿ': 7, 'å²': 5,
            'é¡¾': 21, 'ä¾¯': 9, 'é‚µ': 12, 'å­Ÿ': 8, 'é¾™': 16, 'ä¸‡': 15, 'æ®µ': 9, 'æ¼•': 14,
            'é’±': 16, 'æ±¤': 13, 'å°¹': 4, 'é»': 15, 'æ˜“': 8, 'å¸¸': 11, 'æ­¦': 8, 'ä¹”': 12,
            'è´º': 12, 'èµ–': 16, 'é¾š': 22, 'æ–‡': 4,
            # å¸¸ç”¨åå­—ç”¨å­—ç¬”ç”»
            'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5, 'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'å': 2,
            'å­': 3, 'ä¸‘': 4, 'å¯…': 11, 'å¯': 5, 'è¾°': 7, 'å·³': 3, 'åˆ': 4, 'æœª': 5, 'ç”³': 5, 'é…‰': 7, 'æˆŒ': 6, 'äº¥': 6,
            'ç”²': 5, 'ä¹™': 1, 'ä¸™': 5, 'ä¸': 2, 'æˆŠ': 5, 'å·±': 3, 'åºš': 8, 'è¾›': 7, 'å£¬': 4, 'ç™¸': 9,
            'ä¸œ': 8, 'å—': 9, 'è¥¿': 6, 'åŒ—': 5, 'ä¸­': 4, 'å': 14, 'å›½': 11, 'æ°‘': 5, 'äºº': 2, 'å¤§': 3,
            'å°': 3, 'å¤©': 4, 'åœ°': 6, 'å±±': 3, 'æ°´': 4, 'ç«': 4, 'æœ¨': 4, 'é‡‘': 8, 'åœŸ': 3,
            'æ—¥': 4, 'æœˆ': 4, 'æ˜Ÿ': 9, 'å…‰': 6, 'æ˜': 8, 'äº®': 9, 'è¾‰': 15, 'æ™–': 13, 'é˜³': 17, 'é˜´': 11,
            'æ˜¥': 9, 'å¤': 10, 'ç§‹': 9, 'å†¬': 5, 'é›¨': 8, 'é›ª': 11, 'é£': 9, 'äº‘': 12, 'é›·': 13, 'ç”µ': 13,
            'çº¢': 9, 'ç»¿': 14, 'è“': 20, 'é»„': 12, 'ç™½': 5, 'é»‘': 12, 'ç´«': 12, 'é’': 8, 'æ©™': 16, 'ç²‰': 10,
            'èŠ±': 8, 'è‰': 12, 'æ ‘': 16, 'æ—': 8, 'æ£®': 12, 'ç«¹': 6, 'æ¢…': 11, 'å…°': 23, 'èŠ': 14, 'è·': 13,
            'é¾™': 16, 'å‡¤': 14, 'è™': 8, 'ç‹®': 13, 'è±¡': 12, 'é©¬': 10, 'ç‰›': 4, 'ç¾Š': 6, 'é¸¡': 7, 'ç‹—': 8,
            'é±¼': 11, 'é¸Ÿ': 11, 'ç‡•': 16, 'é¹°': 24, 'é¹¤': 21, 'é¸½': 17, 'é¸­': 16, 'é¹…': 18, 'é¸¡': 7, 'é¸Ÿ': 11,
            'çˆ±': 13, 'æƒ…': 12, 'å¿ƒ': 4, 'å¿—': 7, 'æ„': 13, 'æ€': 9, 'æƒ³': 13, 'å¿µ': 8, 'å¿†': 17, 'è®°': 10,
            'æ™º': 12, 'æ…§': 15, 'èª': 17, 'æ˜': 8, 'äº®': 9, 'æ¸…': 12, 'å‡€': 10, 'æ´': 10, 'çº¯': 10, 'çœŸ': 10,
            'å–„': 12, 'ç¾': 9, 'å¥½': 6, 'ä½³': 8, 'ä¼˜': 17, 'ç§€': 7, 'é›…': 12, 'é™': 16, 'å®‰': 6, 'å®': 14,
            'å’Œ': 8, 'å¹³': 5, 'åº·': 11, 'å¥': 11, 'å¼º': 12, 'åŠ›': 2, 'å‹‡': 9, 'æ•¢': 12, 'æ¯…': 15, 'åš': 11,
            'æˆ': 7, 'åŠŸ': 5, 'èƒœ': 12, 'åˆ©': 7, 'è¾¾': 16, 'è¿›': 15, 'æ­¥': 7, 'å‰': 9, 'å': 9, 'ä¸Š': 3,
            'ä¸‹': 3, 'å·¦': 5, 'å³': 5, 'å†…': 4, 'å¤–': 5, 'é«˜': 10, 'ä½': 7, 'é•¿': 8, 'çŸ­': 12, 'å¤§': 3,
            'å°': 3, 'å¤š': 6, 'å°‘': 4, 'æ–°': 13, 'æ—§': 18, 'è€': 6, 'å°‘': 4, 'ç”·': 7, 'å¥³': 3, 'çˆ¶': 4,
            'æ¯': 5, 'å­': 3, 'å¥³': 3, 'å…„': 5, 'å¼Ÿ': 7, 'å§': 8, 'å¦¹': 8, 'å¤«': 4, 'å¦»': 8, 'å®¶': 10,
            'å›½': 11, 'åŸ': 10, 'ä¹¡': 3, 'æ‘': 7, 'é•‡': 18, 'å¿': 7, 'å¸‚': 5, 'çœ': 9, 'å·': 6, 'åŒº': 4
        }
        return stroke_dict.get(char, len(char.encode('utf-8')))  # ç®€åŒ–å¤„ç†ï¼Œå®é™…å­—ç¬¦è¿”å›UTF-8å­—èŠ‚é•¿åº¦
    def analyze_name_wuxing(self, surname, given_name, bazi_result):
        """å§“åäº”è¡Œé…ç½®åˆ†æ"""
        analysis = []
        analysis.append("\nã€å§“åäº”è¡Œé…ç½®ã€‘")
        # è·å–å§“åå„å­—çš„äº”è¡Œ
        surname_wuxing = self.get_character_wuxing(surname)
        given_wuxing = [self.get_character_wuxing(char) for char in given_name]
        # åˆ†æäº”è¡Œé…ç½®
        all_wuxing = surname_wuxing + given_wuxing
        analysis.append(f"â€¢ å§“åäº”è¡Œï¼š{' '.join(all_wuxing)}")
        # æ£€æŸ¥äº”è¡Œç›¸ç”Ÿç›¸å…‹
        wuxing_relations = []
        for i in range(len(all_wuxing) - 1):
            relation = self.get_wuxing_relation(all_wuxing[i], all_wuxing[i + 1])
            wuxing_relations.append(relation)
        analysis.append(f"â€¢ äº”è¡Œå…³ç³»ï¼š{' â†’ '.join(wuxing_relations)}")
        # ä¸å…«å­—äº”è¡ŒåŒ¹é…åˆ†æ
        bazi_wuxing = bazi_result['wuxing_distribution']
        day_element = bazi_result['day_master_element']
        # åˆ†æå§“åäº”è¡Œå¯¹å…«å­—çš„è¡¥ç›Š
        name_elements = {}
        for element in all_wuxing:
            name_elements[element] = name_elements.get(element, 0) + 1
        analysis.append("\nâ€¢ å¯¹å…«å­—çš„è¡¥ç›Šä½œç”¨ï¼š")
        total_bazi = sum(bazi_wuxing.values())
        for element, count in name_elements.items():
            bazi_percentage = (bazi_wuxing.get(element, 0) / total_bazi) * 100 if total_bazi > 0 else 0
            if bazi_percentage < 15:
                analysis.append(f"  {element}ï¼šå§“åè¡¥å……{count}ä¸ªï¼Œæœ‰åŠ©äºå¹³è¡¡å…«å­—äº”è¡Œ")
            elif bazi_percentage > 30:
                analysis.append(f"  {element}ï¼šå§“åå¢åŠ {count}ä¸ªï¼Œå¯èƒ½åŠ é‡äº”è¡Œå¤±è¡¡")
            else:
                analysis.append(f"  {element}ï¼šå§“åå¢åŠ {count}ä¸ªï¼Œäº”è¡Œé…ç½®é€‚ä¸­")
        # äº”è¡Œé…ç½®è¯„åˆ†
        config_score = self.calculate_wuxing_config_score(all_wuxing, bazi_wuxing, day_element)
        analysis.append(f"\nâ€¢ äº”è¡Œé…ç½®è¯„åˆ†ï¼š{config_score}/100åˆ†")
        return analysis
    def get_character_wuxing(self, char):
        """è·å–å­—ç¬¦äº”è¡Œå±æ€§ - å¢å¼ºç‰ˆï¼Œæ”¯æŒæ‰€æœ‰æ–°é£æ ¼å­—ç¬¦"""
        # å¢å¼ºç‰ˆäº”è¡Œå­—å…¸ï¼ŒåŒ…å«æ‰€æœ‰æ–°é£æ ¼çš„å­—ç¬¦
        wuxing_dict = {
            # æœ¨æ€§å­— - æ‰©å±•ç‰ˆ
            'æœ¨': 'æœ¨', 'æ—': 'æœ¨', 'æ£®': 'æœ¨', 'æ ‘': 'æœ¨', 'ç«¹': 'æœ¨', 'æ¢…': 'æœ¨', 'å…°': 'æœ¨', 'èŠ': 'æœ¨', 'è·': 'æœ¨',
            'æ˜¥': 'æœ¨', 'é’': 'æœ¨', 'ç»¿': 'æœ¨', 'ä¸œ': 'æœ¨', 'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'å¯…': 'æœ¨', 'å¯': 'æœ¨',
            'æ¨': 'æœ¨', 'æŸ³': 'æœ¨', 'æ¾': 'æœ¨', 'æŸ': 'æœ¨', 'æ¡‚': 'æœ¨', 'æ¡ƒ': 'æœ¨', 'æ': 'æœ¨', 'æ¢¨': 'æœ¨',
            'èŠ±': 'æœ¨', 'è‰': 'æœ¨', 'å¶': 'æœ¨', 'æ': 'æœ¨', 'æ ¹': 'æœ¨', 'èŒ': 'æœ¨', 'èŠ½': 'æœ¨', 'è‹—': 'æœ¨',
            # æ–°å¢æœ¨æ€§å­— - å¤§å¹…æ‰©å±•
            'å½¬': 'æœ¨', 'æ‰': 'æœ¨', 'æ¢§': 'æœ¨', 'æ§': 'æœ¨', 'æ¦†': 'æœ¨', 'æ¥ ': 'æœ¨', 'æª€': 'æœ¨', 'èŠ³': 'æœ¨',
            'èŠ¸': 'æœ¨', 'è‹¥': 'æœ¨', 'èŒ—': 'æœ¨', 'èƒ': 'æœ¨', 'è•™': 'æœ¨', 'è‹±': 'æœ¨', 'å': 'æœ¨', 'å›': 'æœ¨',
            'éœ‡': 'æœ¨', 'å·½': 'æœ¨', 'æŸ”': 'æœ¨', 'é›…': 'æœ¨', 'è‰¯': 'æœ¨', 'æ­': 'æœ¨', 'ä¿­': 'æœ¨', 'è°¦': 'æœ¨',
            'æ°': 'æœ¨', 'å¿—': 'æœ¨', 'ç´': 'æœ¨', 'æœˆ': 'æœ¨', 'é£': 'æœ¨', 'æ¬£': 'æœ¨', 'è‰º': 'æœ¨', 'ç³': 'æœ¨',
            'å‰': 'æœ¨', 'åº†': 'æœ¨', 'è´µ': 'æœ¨', 'è£': 'æœ¨', 'åº·': 'æœ¨', 'çš“': 'æœ¨', 'è±': 'æœ¨',
            # å‘¨æ˜“ç»å…¸æœ¨æ€§å­—
            'ä¹¾': 'æœ¨', 'å…ƒ': 'æœ¨', 'äº¨': 'æœ¨', 'åˆ©': 'æœ¨', 'è´': 'æœ¨', 'å¾·': 'æœ¨', 'æ­£': 'æœ¨', 'ä»': 'æœ¨',
            'ç¤¼': 'æœ¨', 'é¡º': 'æœ¨', 'æ…§': 'æœ¨', 'è´¤': 'æœ¨', 'æ·‘': 'æœ¨', 'å©‰': 'æœ¨', 'å¨´': 'æœ¨', 'å–„': 'æœ¨',
            'ç«¯': 'æœ¨', 'åº„': 'æœ¨', 'çªˆ': 'æœ¨', 'è•™': 'æœ¨', 'å…°': 'æœ¨', 'èŠ·': 'æœ¨', 'è·': 'æœ¨', 'èŒ—': 'æœ¨',
            # è¯—ç»é›…éŸµæœ¨æ€§å­—
            'å½¬': 'æœ¨', 'æ¸©': 'æœ¨', 'æ³½': 'æœ¨', 'æ¶¦': 'æœ¨', 'åš': 'æœ¨', 'æ–‡': 'æœ¨', 'èŠ³': 'æœ¨', 'å': 'æœ¨',
            # æ¥šè¾è±ªæ”¾æœ¨æ€§å­—
            'å¿—': 'æœ¨', 'è¿œ': 'æœ¨', 'ç¿”': 'æœ¨', 'é¹': 'æœ¨', 'é£': 'æœ¨', 'äº‘': 'æœ¨', 'å¸†': 'æœ¨', 'å³°': 'æœ¨',
            'è±ª': 'æœ¨', 'æ°': 'æœ¨', 'æ¢¦': 'æœ¨', 'å…°': 'æœ¨', 'èŠ·': 'æœ¨', 'æ¸…': 'æœ¨', 'ä¸½': 'æœ¨', 'è‹¥': 'æœ¨',
            # è®ºè¯­æ™ºæ…§æœ¨æ€§å­—
            'å­¦': 'æœ¨', 'æ•': 'æœ¨', 'è¾¾': 'æœ¨', 'æ€': 'æœ¨', 'è°': 'æœ¨', 'çº¦': 'æœ¨',
            # å”è¯—å®‹è¯æœ¨æ€§å­—
            'è¯—': 'æœ¨', 'éŸµ': 'æœ¨', 'æ‰': 'æœ¨', 'ä¿Š': 'æœ¨', 'é€¸': 'æœ¨', 'é£': 'æœ¨', 'æµ': 'æœ¨', 'æ½‡': 'æœ¨',
            'æ´’': 'æœ¨', 'æ·¡': 'æœ¨', 'æ³Š': 'æœ¨', 'å®': 'æœ¨', 'å¿ƒ': 'æœ¨', 'è¯­': 'æœ¨', 'å½±': 'æœ¨',
            # å¤å…¸åè‘—æœ¨æ€§å­—
            'æ­¦': 'æœ¨', 'è‹±': 'æœ¨', 'é›„': 'æœ¨', 'å­¦': 'æœ¨', 'å': 'æœ¨', 'é€¸': 'æœ¨', 'ç‰': 'æœ¨', 'å…ƒ': 'æœ¨',
            'æ˜¥': 'æœ¨', 'è¿': 'æœ¨', 'æ¢': 'æœ¨', 'æƒœ': 'æœ¨', 'è¢­': 'æœ¨', 'æ™´': 'æœ¨',
            # ç°ä»£æ—¶å°šæœ¨æ€§å­—
            'è½©': 'æœ¨', 'è±ª': 'æœ¨', 'å»º': 'æœ¨', 'ä¼Ÿ': 'æœ¨', 'ç¿': 'æœ¨', 'è±': 'æœ¨', 'æ¢“': 'æœ¨', 'æ‚¦': 'æœ¨', 'æ¬£': 'æœ¨',

            # ç«æ€§å­— - æ‰©å±•ç‰ˆ
            'ç«': 'ç«', 'ç‚': 'ç«', 'ç„°': 'ç«', 'ç‡ƒ': 'ç«', 'çƒ§': 'ç«', 'çƒ­': 'ç«', 'æš–': 'ç«', 'æ¸©': 'ç«',
            'å¤': 'ç«', 'çº¢': 'ç«', 'ç´«': 'ç«', 'å—': 'ç«', 'ä¸™': 'ç«', 'ä¸': 'ç«', 'å·³': 'ç«', 'åˆ': 'ç«',
            'æ—¥': 'ç«', 'é˜³': 'ç«', 'å…‰': 'ç«', 'æ˜': 'ç«', 'äº®': 'ç«', 'è¾‰': 'ç«', 'æ™–': 'ç«', 'ç…§': 'ç«',
            'ç¯': 'ç«', 'çƒ›': 'ç«', 'ç”µ': 'ç«', 'é›·': 'ç«', 'é—ª': 'ç«', 'è€€': 'ç«', 'ç…Œ': 'ç«', 'ç‚«': 'ç«',
            # æ–°å¢ç«æ€§å­—
            'ç„±': 'ç«', 'æ™¶': 'ç«', 'æ™¨': 'ç«', 'æ˜•': 'ç«', 'æ—­': 'ç«', 'æ™´': 'ç«', 'çƒ': 'ç«', 'ç¿': 'ç«',
            'çƒ‚': 'ç«', 'ç† ': 'ç«', 'ç„•': 'ç«', 'å¾·': 'ç«', 'æ™º': 'ç«', 'ç¤¼': 'ç«', 'æ–‡': 'ç«', 'ç« ': 'ç«',
            'è´': 'ç«', 'è®©': 'ç«', 'ä¿Š': 'ç«', 'å¿—': 'ç«', 'è‡´': 'ç«', 'ä¸½': 'ç«', 'å©·': 'ç«', 'å¨œ': 'ç«',
            'ç¦„': 'ç«', 'æ˜‚': 'ç«', 'æ˜Œ': 'ç«', 'ç•…': 'ç«', 'æœ—': 'ç«', 'å¾‹': 'ç«', 'è°ƒ': 'ç«', 'åŠ¨': 'ç«',
            'å¬': 'ç«', 'è½¬': 'ç«', 'ç”œ': 'ç«', 'é»›': 'ç«', 'å®': 'ç«',

            # åœŸæ€§å­— - æ‰©å±•ç‰ˆ
            'åœŸ': 'åœŸ', 'åœ°': 'åœŸ', 'å±±': 'åœŸ', 'çŸ³': 'åœŸ', 'å²©': 'åœŸ', 'å³°': 'åœŸ', 'å²­': 'åœŸ', 'å¡': 'åœŸ',
            'ç§‹': 'åœŸ', 'é»„': 'åœŸ', 'æ£•': 'åœŸ', 'ä¸­': 'åœŸ', 'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'è¾°': 'åœŸ', 'æˆŒ': 'åœŸ', 'ä¸‘': 'åœŸ', 'æœª': 'åœŸ',
            'åŸ': 'åœŸ', 'å¢™': 'åœŸ', 'å ¡': 'åœŸ', 'å¡”': 'åœŸ', 'å›': 'åœŸ', 'åœº': 'åœŸ', 'é™¢': 'åœŸ', 'å›­': 'åœŸ',
            'ç”°': 'åœŸ', 'é‡': 'åœŸ', 'åŸ': 'åœŸ', 'å¹³': 'åœŸ', 'å¦': 'åœŸ', 'å¹¿': 'åœŸ', 'åš': 'åœŸ', 'å®': 'åœŸ',
            # æ–°å¢åœŸæ€§å­—
            'å¤': 'åœŸ', 'å ': 'åœŸ', 'åŸŸ': 'åœŸ', 'åŸ¹': 'åœŸ', 'åŸº': 'åœŸ', 'å’': 'åœŸ', 'å¢¨': 'åœŸ', 'ç”»': 'åœŸ',
            'åœ£': 'åœŸ', 'è´¤': 'åœŸ', 'å®‰': 'åœŸ', 'å®': 'åœŸ', 'åº·': 'åœŸ', 'æ³°': 'åœŸ', 'å’Œ': 'åœŸ', 'ç¾': 'åœŸ',
            'è‰®': 'åœŸ', 'å¨´': 'åœŸ', 'å©‰': 'åœŸ', 'æ¸©': 'åœŸ', 'è¿œ': 'åœŸ', 'å®‡': 'åœŸ', 'è½©': 'åœŸ', 'éŸµ': 'åœŸ',
            'æ€¡': 'åœŸ', 'æ„': 'åœŸ', 'å“': 'åœŸ', 'éŸ³': 'åœŸ', 'å½±': 'åœŸ', 'åœ†': 'åœŸ',

            # é‡‘æ€§å­— - æ‰©å±•ç‰ˆ
            'é‡‘': 'é‡‘', 'é“¶': 'é‡‘', 'é“œ': 'é‡‘', 'é“': 'é‡‘', 'é’¢': 'é‡‘', 'é”¡': 'é‡‘', 'é“': 'é‡‘', 'é”Œ': 'é‡‘',
            'ç™½': 'é‡‘', 'è¥¿': 'é‡‘', 'åºš': 'é‡‘', 'è¾›': 'é‡‘', 'ç”³': 'é‡‘', 'é…‰': 'é‡‘',
            'åˆ€': 'é‡‘', 'å‰‘': 'é‡‘', 'æ–§': 'é‡‘', 'é”¤': 'é‡‘', 'é’‰': 'é‡‘', 'é’ˆ': 'é‡‘', 'é’©': 'é‡‘', 'é”': 'é‡‘',
            'é’±': 'é‡‘', 'è´¢': 'é‡‘', 'å®': 'é‡‘', 'ç ': 'é‡‘', 'ç‰': 'é‡‘', 'é’»': 'é‡‘', 'é•œ': 'é‡‘',
            # æ–°å¢é‡‘æ€§å­—
            'é”‹': 'é‡‘', 'é”': 'é‡‘', 'é’Š': 'é‡‘', 'é’§': 'é‡‘', 'é“­': 'é‡‘', 'é”¦': 'é‡‘', 'é•‡': 'é‡‘', 'é‘«': 'é‡‘',
            'é’°': 'é‡‘', 'é“ƒ': 'é‡‘', 'é’Ÿ': 'é‡‘', 'é“': 'é‡‘', 'åˆš': 'é‡‘', 'å¼º': 'é‡‘', 'åš': 'é‡‘', 'æ¯…': 'é‡‘',
            'ä¹‰': 'é‡‘', 'ä¿¡': 'é‡‘', 'æ­£': 'é‡‘', 'æ­¦': 'é‡‘', 'å‹‡': 'é‡‘', 'æ•¢': 'é‡‘', 'åˆ©': 'é‡‘',
            'å…‘': 'é‡‘', 'é™': 'é‡‘', 'å–„': 'é‡‘', 'çº¯': 'é‡‘', 'çœŸ': 'é‡‘', 'ç§€': 'é‡‘', 'ç„¶': 'é‡‘', 'ç´ ': 'é‡‘',
            'ä¹¦': 'é‡‘', 'ä»': 'é‡‘', 'ç‘': 'é‡‘', 'ç¥¥': 'é‡‘', 'å¯¿': 'é‡‘', 'é¡º': 'é‡‘', 'è„†': 'é‡‘', 'æŸ”': 'é‡‘',

            # æ°´æ€§å­— - æ‰©å±•ç‰ˆ
            'æ°´': 'æ°´', 'æ±Ÿ': 'æ°´', 'æ²³': 'æ°´', 'æ¹–': 'æ°´', 'æµ·': 'æ°´', 'æ± ': 'æ°´', 'æ³‰': 'æ°´', 'æºª': 'æ°´',
            'é»‘': 'æ°´', 'è“': 'æ°´', 'åŒ—': 'æ°´', 'å£¬': 'æ°´', 'ç™¸': 'æ°´', 'äº¥': 'æ°´', 'å­': 'æ°´',
            'é›¨': 'æ°´', 'é›ª': 'æ°´', 'äº‘': 'æ°´', 'é›¾': 'æ°´', 'éœ²': 'æ°´', 'éœœ': 'æ°´', 'å†°': 'æ°´', 'éœ': 'æ°´',
            'æ³¢': 'æ°´', 'æµª': 'æ°´', 'æ¶›': 'æ°´', 'æµ': 'æ°´', 'æ¶¦': 'æ°´', 'æ¹¿': 'æ°´', 'æ¸…': 'æ°´', 'æ´': 'æ°´',
            # æ–°å¢æ°´æ€§å­—
            'æ¾ˆ': 'æ°´', 'æ³½': 'æ°´', 'å‡€': 'æ°´', 'æº': 'æ°´', 'æ…§': 'æ°´', 'å­¦': 'æ°´', 'æ€': 'æ°´',
            'æ•': 'æ°´', 'èª': 'æ°´', 'é¢–': 'æ°´', 'çµ': 'æ°´', 'æœº': 'æ°´', 'è¾¾': 'æ°´', 'é€š': 'æ°´',
            'å': 'æ°´', 'æ·‘': 'æ°´', 'åš': 'æ°´', 'æµ©': 'æ°´', 'æ¶µ': 'æ°´', 'å­': 'æ°´', 'å¯': 'æ°´', 'é¦¨': 'æ°´',
            'é›ª': 'water', 'éŸµ': 'æ°´', 'è¯—': 'æ°´', 'ä½³': 'æ°´', 'æ€': 'æ°´', 'é›¨': 'æ°´', 'æ¹˜': 'æ°´', 'äº‘': 'æ°´',
            'å‡¤': 'æ°´', 'å¦™': 'æ°´', 'é›¯': 'æ°´', 'ç¦': 'æ°´', 'å–œ': 'æ°´', 'å¹¸': 'æ°´', 'æ»¡': 'æ°´', 'å¯Œ': 'æ°´',
            'æ³°': 'æ°´', 'å®': 'æ°´', 'æ´ª': 'æ°´', 'é¸¿': 'æ°´', 'å¼˜': 'æ°´', 'æ³“': 'æ°´', 'å¥½': 'æ°´', 'å·': 'æ°´',
            'å’Œ': 'æ°´', 'è°': 'æ°´', 'æ‚¦': 'æ°´', 'ç¾': 'æ°´', 'å¦™': 'æ°´', 'å©‰': 'æ°´', 'è½¬': 'æ°´', 'é¦™': 'æ°´'
        }
        # æ ¹æ®åæ—éƒ¨é¦–åˆ¤æ–­äº”è¡Œ
        radical_wuxing = {
            'æœ¨': 'æœ¨', 'è‰¹': 'æœ¨', 'ç«¹': 'æœ¨', 'ç¦¾': 'æœ¨',
            'ç«': 'ç«', 'æ—¥': 'ç«', 'ç¬': 'ç«', 'å…‰': 'ç«',
            'åœŸ': 'åœŸ', 'å±±': 'åœŸ', 'çŸ³': 'åœŸ', 'ç”°': 'åœŸ',
            'é‡‘': 'é‡‘', 'é’…': 'é‡‘', 'åˆ€': 'é‡‘', 'æˆˆ': 'é‡‘',
            'æ°´': 'æ°´', 'æ°µ': 'æ°´', 'å†«': 'æ°´', 'é›¨': 'æ°´'
        }
        # é¦–å…ˆæŸ¥å­—å…¸
        if char in wuxing_dict:
            return wuxing_dict[char]
        # ç„¶åæŸ¥åæ—
        for radical, element in radical_wuxing.items():
            if radical in char:
                return element
        # é»˜è®¤è¿”å›åœŸï¼ˆå› ä¸ºåœŸä¸ºä¸‡ç‰©ä¹‹æ¯ï¼‰
        return 'åœŸ'

    def get_character_meaning(self, char):
        """è·å–å­—ç¬¦å¯“æ„ - å¢å¼ºç‰ˆï¼Œæ”¯æŒæ‰€æœ‰æ–°é£æ ¼å­—ç¬¦"""
        meaning_dict = {
            # å‘¨æ˜“ç»å…¸é£æ ¼
            'ä¹¾': 'å¤©è¡Œå¥ï¼Œå›å­ä»¥è‡ªå¼ºä¸æ¯', 'å¤': 'åœ°åŠ¿å¤ï¼Œå›å­ä»¥åšå¾·è½½ç‰©', 'å…ƒ': 'å…ƒå§‹å¤©å°Šï¼Œä¸‡ç‰©ä¹‹å§‹',
            'äº¨': 'äº¨é€šé¡ºè¾¾ï¼Œäº‹ä¸šæœ‰æˆ', 'åˆ©': 'åˆ©ç›Šä¼—ç”Ÿï¼Œå¾·è¡Œé«˜å°š', 'è´': 'è´æ´åšå®šï¼Œå“æ ¼é«˜å°š',
            'å›': 'å›å­é£èŒƒï¼Œå“å¾·é«˜å°š', 'å¾·': 'å¾·è¡Œå¤©ä¸‹ï¼Œå“æ ¼é«˜å°š', 'æ­£': 'æ­£ç›´æ— ç§ï¼Œå“è¡Œç«¯æ­£',
            'æ™º': 'æ™ºæ…§è¶…ç¾¤ï¼Œèªæ˜è¿‡äºº', 'ä»': 'ä»çˆ±æ…ˆæ‚²ï¼Œå¿ƒåœ°å–„è‰¯', 'ä¹‰': 'ä¹‰è–„äº‘å¤©ï¼Œæ­£ä¹‰å‡›ç„¶',
            'ç¤¼': 'ç¤¼è²Œå¾…äººï¼Œæ–‡æ˜æœ‰ç¤¼', 'ä¿¡': 'è¯šå®å®ˆä¿¡ï¼Œè¨€è€Œæœ‰ä¿¡', 'æŸ”': 'æ¸©æŸ”è´¤æ·‘ï¼Œæ€§æ ¼æ¸©å’Œ',
            'é¡º': 'é¡ºé£é¡ºæ°´ï¼Œä¸€å¸†é£é¡º', 'ç¾': 'ç¾ä¸½åŠ¨äººï¼Œå“è²Œä¿±ä½³', 'é›…': 'é«˜é›…è„±ä¿—ï¼Œæ°”è´¨éå‡¡',
            'æ…§': 'æ™ºæ…§è¿‡äººï¼Œèªæ…§ä¼¶ä¿', 'è´¤': 'è´¤è‰¯æ·‘å¾·ï¼Œå“å¾·é«˜å°š', 'æ·‘': 'æ·‘å¥³é£èŒƒï¼Œæ¸©æŸ”è´¤æƒ ',
            'å©‰': 'å©‰çº¦åŠ¨äººï¼Œæ¸©æŸ”å¯äºº', 'é™': 'å®é™è‡´è¿œï¼Œå¿ƒå¢ƒå¹³å’Œ', 'å¨´': 'å¨´é™ä¼˜é›…ï¼Œä¸¾æ­¢å¾—ä½“',
            'å–„': 'å–„è‰¯ä»æ…ˆï¼Œå¿ƒåœ°çº¯è‰¯', 'çº¯': 'çº¯æ´æ— ç‘•ï¼Œå“æ ¼çº¯çœŸ', 'çœŸ': 'çœŸè¯šå¾…äººï¼Œæœ¬æ€§çº¯çœŸ',
            'æ¸…': 'æ¸…é›…è„±ä¿—ï¼Œå“æ ¼é«˜æ´', 'ç«¯': 'ç«¯åº„å¤§æ–¹ï¼Œä»ªæ€ä¼˜é›…', 'åº„': 'åº„é‡ä¸¥è‚ƒï¼Œå“æ ¼ç«¯æ­£',

            # è¯—ç»é›…éŸµé£æ ¼
            'å½¬': 'æ–‡è´¨å½¬å½¬ï¼Œæ¸©æ–‡å°”é›…', 'æ¸©': 'æ¸©æ–‡å°”é›…ï¼Œæ€§æ ¼æ¸©å’Œ', 'è‰¯': 'å–„è‰¯æ­£ç›´ï¼Œå“å¾·ä¼˜è‰¯',
            'æ­': 'æ­æ•¬æœ‰ç¤¼ï¼Œè°¦é€Šå¾…äºº', 'ä¿­': 'å‹¤ä¿­èŠ‚çº¦ï¼Œå“å¾·é«˜å°š', 'è°¦': 'è°¦è™šè°¨æ…ï¼Œå“æ ¼é«˜å°š',
            'å’Œ': 'å’Œè°ç¾æ»¡ï¼Œäººé™…å’Œç¦', 'æ³½': 'æ©æ³½æ·±åšï¼Œç¦æ³½ç»µé•¿', 'æ¶¦': 'æ¶¦æ³½ä¸‡ç‰©ï¼Œæ©æƒ æ·±è¿œ',
            'åš': 'åšå­¦å¤šæ‰ï¼Œå­¦è¯†æ¸Šåš', 'æ–‡': 'æ–‡é‡‡é£æ‰¬ï¼Œæ‰åæ¨ªæº¢', 'çªˆ': 'çªˆçª•æ·‘å¥³ï¼Œç¾ä¸½åŠ¨äºº',
            'èŠ³': 'èŠ³é¦™æ€¡äººï¼Œå“å¾·èŠ¬èŠ³', 'å': 'æ‰åæ¨ªæº¢ï¼Œå…‰å½©ç…§äºº', 'è‹±': 'è‹±å§¿é£’çˆ½ï¼Œæ‰åå‡ºä¼—',
            'è•™': 'è•™è´¨å…°å¿ƒï¼Œå“æ ¼é«˜é›…', 'å…°': 'å…°å¿ƒè•™è´¨ï¼Œé«˜é›…è„±ä¿—',

            # æ¥šè¾è±ªæ”¾é£æ ¼
            'å¿—': 'å¿—å‘è¿œå¤§ï¼ŒæŠ±è´Ÿä¸å‡¡', 'è¿œ': 'å¿—å‘è¿œå¤§ï¼Œç›®å…‰é•¿è¿œ', 'å®‡': 'æ°”å®‡è½©æ˜‚ï¼Œèƒ¸æ€€å®½å¹¿',
            'æµ©': 'æµ©ç„¶æ­£æ°”ï¼Œèƒ¸æ€€å®½å¹¿', 'ç„¶': 'æµ©ç„¶æ­£æ°”ï¼Œè‡ªç„¶å¤©æˆ', 'å¤©': 'å¤©èµ‹å¼‚ç¦€ï¼Œæ‰åå‡ºä¼—',
            'ç¿”': 'å±•ç¿…é«˜ç¿”ï¼Œå‰ç¨‹è¿œå¤§', 'é¹': 'é¹ç¨‹ä¸‡é‡Œï¼Œå‰é€”æ— é‡', 'é£': 'å±•ç¿…é«˜é£ï¼Œå¿—å‘é«˜è¿œ',
            'äº‘': 'äº‘ç¨‹å‘è½«ï¼Œå‰ç¨‹ä¼¼é”¦', 'å¸†': 'ä¸€å¸†é£é¡ºï¼Œäº‹ä¸šæœ‰æˆ', 'æ¶›': 'æ³¢æ¾œå£®é˜”ï¼Œæ°”åŠ¿ç£…ç¤´',
            'å³°': 'ç™»å³°é€ æï¼Œæˆå°±éå‡¡', 'é›„': 'è‹±é›„è±ªæ°ï¼Œæ°”æ¦‚ä¸å‡¡', 'ä¼Ÿ': 'ä¼Ÿå¤§éå‡¡ï¼Œæˆå°±å“è¶Š',
            'è±ª': 'è±ªæƒ…ä¸‡ä¸ˆï¼Œæ°”æ¦‚ä¸å‡¡', 'æ°': 'è‹±é›„è±ªæ°ï¼Œæ‰åå‡ºä¼—', 'æ¹˜': 'æ¹˜æ°´ä¹‹æ»¨ï¼Œæ¸…é›…è„±ä¿—',
            'æ¢¦': 'æ¢¦æƒ³æˆçœŸï¼Œç†æƒ³å®ç°', 'èŠ·': 'ç™½èŠ·æ¸…é¦™ï¼Œå“æ ¼é«˜æ´', 'è‹¥': 'è‹¥æ°´æŸ”æƒ…ï¼Œæ¸©æŸ”å¦‚æ°´',
            'èŒ—': 'èŒ—é¦™æ¸…é›…ï¼Œå“å‘³é«˜é›…', 'èƒ': 'èƒè•™å¹¶èŒ‚ï¼Œå“å¾·é«˜å°š', 'è·': 'è·èŠ±æ¸…é¦™ï¼Œå“æ ¼é«˜æ´',

            # è®ºè¯­æ™ºæ…§é£æ ¼
            'å­¦': 'å­¦è€Œæ—¶ä¹ ï¼Œå¥½å­¦ä¸å€¦', 'æ•': 'æ•è€Œå¥½å­¦ï¼Œèªæ…§è¿‡äºº', 'è¾¾': 'é€šè¾¾äº‹ç†ï¼Œæ™ºæ…§è¶…ç¾¤',
            'æ€': 'æ·±æ€ç†Ÿè™‘ï¼Œæ™ºæ…§è¿‡äºº', 'è°': 'å’Œè°ç¾æ»¡ï¼Œå…³ç³»èæ´½', 'çº¦': 'çº¦å®šä¿—æˆï¼Œå®ˆä¿¡é‡è¯º',

            # å”è¯—å®‹è¯é£æ ¼
            'è¯—': 'è¯—æƒ…ç”»æ„ï¼Œæ‰åæ¨ªæº¢', 'éŸµ': 'éŸµå‘³æ·±é•¿ï¼Œæ°”è´¨ä¼˜é›…', 'æ‰': 'æ‰åæ¨ªæº¢ï¼Œèƒ½åŠ›å‡ºä¼—',
            'ä¿Š': 'ä¿Šç§€æ½‡æ´’ï¼Œé£åº¦ç¿©ç¿©', 'é€¸': 'è¶…é€¸è„±ä¿—ï¼Œå“æ ¼é«˜é›…', 'é£': 'é£åº¦ç¿©ç¿©ï¼Œæ°”è´¨ä¸å‡¡',
            'æµ': 'é£æµå€œå‚¥ï¼Œæ‰åå‡ºä¼—', 'æ½‡': 'æ½‡æ´’è‡ªå¦‚ï¼Œé£åº¦ä¸å‡¡', 'æ´’': 'æ´’è„±è‡ªç„¶ï¼Œæ€§æ ¼å¼€æœ—',
            'æ·¡': 'æ·¡æ³Šååˆ©ï¼Œå“æ ¼é«˜å°š', 'æ³Š': 'æ·¡æ³Šå®é™ï¼Œå¿ƒå¢ƒå¹³å’Œ', 'å®': 'å®é™è‡´è¿œï¼Œå¿ƒå¢ƒå¹³å’Œ',
            'å¿ƒ': 'å¿ƒåœ°å–„è‰¯ï¼Œå“æ ¼çº¯çœŸ', 'è¯­': 'è¯­è¨€ä¼˜ç¾ï¼Œè¡¨è¾¾èƒ½åŠ›å¼º', 'å½±': 'å½±å“æ·±è¿œï¼Œä½œç”¨é‡å¤§',

            # å¤å…¸åè‘—é£æ ¼
            'æ­¦': 'æ–‡æ­¦åŒå…¨ï¼Œèƒ½åŠ›å…¨é¢', 'è‹±': 'è‹±é›„è±ªæ°ï¼Œæ‰åå‡ºä¼—', 'é›„': 'è‹±é›„æ°”æ¦‚ï¼Œèƒ¸æ€€å®½å¹¿',
            'å­¦': 'åšå­¦å¤šæ‰ï¼Œå­¦è¯†æ¸Šåš', 'å': 'æ‰åæ¨ªæº¢ï¼Œå…‰å½©ç…§äºº', 'é€¸': 'è¶…é€¸è„±ä¿—ï¼Œå“æ ¼é«˜é›…',
            'ç‰': 'æ¸©æ¶¦å¦‚ç‰ï¼Œå“æ ¼é«˜æ´', 'å‡¤': 'å‡¤å‡°äºé£ï¼Œå‰ç¥¥å¦‚æ„', 'å…ƒ': 'å…ƒæ°”å……æ²›ï¼Œç”Ÿæœºå‹ƒå‹ƒ',
            'æ˜¥': 'æ˜¥æ„ç›ç„¶ï¼Œç”Ÿæœºå‹ƒå‹ƒ', 'è¿': 'è¿æ¥æŒ‘æˆ˜ï¼Œç§¯æå‘ä¸Š', 'æ¢': 'æ¢ç´¢çœŸç†ï¼Œæ±‚çŸ¥æ¬²å¼º',
            'æƒœ': 'çæƒœæ—¶å…‰ï¼Œæ‡‚å¾—æ„Ÿæ©', 'è¢­': 'ç»§æ‰¿ä¼ ç»Ÿï¼Œå‘æ‰¬å…‰å¤§', 'æ™´': 'æ™´ç©ºä¸‡é‡Œï¼Œå¿ƒæƒ…å¼€æœ—',

            # ç°ä»£æ—¶å°šé£æ ¼
            'è½©': 'æ°”å®‡è½©æ˜‚ï¼Œé£åº¦ä¸å‡¡', 'è±ª': 'è±ªæƒ…ä¸‡ä¸ˆï¼Œæ°”æ¦‚ä¸å‡¡', 'å»º': 'å»ºåŠŸç«‹ä¸šï¼Œæˆå°±éå‡¡',
            'ä¼Ÿ': 'ä¼Ÿå¤§éå‡¡ï¼Œæˆå°±å“è¶Š', 'ç¿': 'ç¿æ™ºè¿‡äººï¼Œæ™ºæ…§è¶…ç¾¤', 'è±': 'è±è‰å¿˜å¿§ï¼Œå¿«ä¹æ— å¿§',
            'æ¢“': 'æ¢“æè‰¯æœ¨ï¼Œæˆæä¹‹æ‰', 'æ‚¦': 'å¿ƒæƒ…æ„‰æ‚¦ï¼Œå¿«ä¹å¹¸ç¦', 'æ¬£': 'æ¬£æ¬£å‘è£ï¼Œè’¸è’¸æ—¥ä¸Š',

            # å¯“æ„å‰ç¥¥é£æ ¼
            'ç¦': 'ç¦æ˜Ÿé«˜ç…§ï¼Œå¹¸ç¦ç¾æ»¡', 'ç¦„': 'ç¦ç¦„åŒå…¨ï¼Œå¯Œè´µè£å', 'å¯¿': 'é•¿å¯¿å¥åº·ï¼Œç¦å¯¿ç»µé•¿',
            'å–œ': 'å–œæ°”æ´‹æ´‹ï¼Œå¿«ä¹å¹¸ç¦', 'è´¢': 'è´¢æºå¹¿è¿›ï¼Œå¯Œè´µæœ‰ä½™', 'è£': 'è£åå¯Œè´µï¼Œå…‰å®—è€€ç¥–',
            'å¯Œ': 'å¯Œè´µè£åï¼Œè´¢å¯Œä¸°åš', 'å¼º': 'èº«å¼ºä½“å£®ï¼Œèƒ½åŠ›å¼ºå¤§', 'åº·': 'å¥åº·é•¿å¯¿ï¼Œèº«ä½“åº·å¥',
            'å®‰': 'å¹³å®‰é¡ºåˆ©ï¼Œå®‰å±…ä¹ä¸š', 'æ³°': 'å›½æ³°æ°‘å®‰ï¼Œå¹³å®‰å‰ç¥¥', 'ç¥¥': 'å‰ç¥¥å¦‚æ„ï¼Œå¥½è¿è¿è¿',
            'ç‘': 'ç‘æ°”ç›ˆé—¨ï¼Œå‰ç¥¥å¦‚æ„', 'ç¥º': 'ç¦ç¥ºæ»¡å ‚ï¼Œå‰ç¥¥ç¾å¥½', 'éº’': 'éº’éºŸé€å­ï¼Œå‰ç¥¥å¦‚æ„',
            'éºŸ': 'éº’éºŸç‘å…½ï¼Œå‰ç¥¥å¦‚æ„', 'é¾™': 'é¾™è…¾è™è·ƒï¼Œå‰ç¨‹è¿œå¤§', 'å¦‚': 'å¦‚æ„å‰ç¥¥ï¼Œå¿ƒæƒ³äº‹æˆ',
            'æ„': 'å¿ƒæƒ³äº‹æˆï¼Œå¦‚æ„å‰ç¥¥', 'æ»¡': 'ç¾æ»¡å¹¸ç¦ï¼Œåœ†æ»¡æˆåŠŸ', 'å¹¸': 'å¹¸ç¦ç¾æ»¡ï¼Œå¥½è¿è¿è¿',
            'å¹³': 'å¹³å®‰é¡ºåˆ©ï¼Œå¿ƒå¢ƒå¹³å’Œ', 'é¡º': 'ä¸€å¸†é£é¡ºï¼Œäº‹äº‹é¡ºå¿ƒ', 'åˆ©': 'åˆ©ç›Šä¼—ç”Ÿï¼Œé¡ºåˆ©æˆåŠŸ',
            'èŠ±': 'èŠ±å¼€å¯Œè´µï¼Œç¾ä¸½åŠ¨äºº', 'å¥½': 'å¥½è¿è¿è¿ï¼Œäº‹äº‹å¦‚æ„', 'æœˆ': 'èŠ±å¥½æœˆåœ†ï¼Œç¾æ»¡å¹¸ç¦',
            'åœ†': 'å›¢å›¢åœ†åœ†ï¼Œç¾æ»¡å¹¸ç¦',

            # éŸ³éŸµå’Œè°é£æ ¼
            'æ˜‚': 'æ˜‚é¦–æŒºèƒ¸ï¼Œç²¾ç¥é¥±æ»¡', 'æ˜Œ': 'æ˜Œç››ç¹è£ï¼Œäº‹ä¸šå…´æ—º', 'ç•…': 'ç•…é€šæ— é˜»ï¼Œå¿ƒæƒ…èˆ’ç•…',
            'æœ—': 'å¼€æœ—ä¹è§‚ï¼Œæ€§æ ¼çˆ½æœ—', 'äº®': 'å…‰æ˜ç£Šè½ï¼Œå‰ç¨‹å…‰æ˜', 'å“': 'å“å½»äº‘éœ„ï¼Œå£°åè¿œæ’­',
            'ç…Š': 'ç…Šèµ«ä¸€æ—¶ï¼Œå£°åæ˜¾èµ«', 'ç‚«': 'ç‚«ç›®å¤ºäººï¼Œæ‰åå‡ºä¼—', 'æ—‹': 'æ—‹è½¬ä¹¾å¤ï¼Œèƒ½åŠ›éå‡¡',
            'ç’‡': 'ç’‡ç‘ç‰è¡¡ï¼Œçè´µç¾å¥½', 'é€‰': 'ç²¾æŒ‘ç»†é€‰ï¼Œå“è´¨ä¼˜è‰¯', 'å®£': 'å®£æ‰¬æ­£ä¹‰ï¼Œä¼ æ’­ç¾å¾·',
            'è€³': 'æ‚¦è€³åŠ¨å¬ï¼Œå£°éŸ³ç¾å¦™', 'è„†': 'æ¸…è„†æ‚¦è€³ï¼Œå£°éŸ³åŠ¨å¬',

            # ä¹¦é¦™é—¨ç¬¬é£æ ¼
            'ç« ': 'æ–‡ç« åå›½ï¼Œæ‰åå‡ºä¼—', 'ä¹¦': 'ä¹¦é¦™é—¨ç¬¬ï¼Œæ–‡åŒ–åº•è•´', 'ç¤¼': 'çŸ¥ä¹¦è¾¾ç¤¼ï¼Œæ–‡æ˜æœ‰ç¤¼',
            'ä¹': 'ä¹è§‚å‘ä¸Šï¼Œå¿«ä¹å¹¸ç¦', 'å£«': 'æ–‡äººé›…å£«ï¼Œå“æ ¼é«˜å°š', 'å„’': 'å„’é›…é£èŒƒï¼Œå­¦è€…é£åº¦',
            'ç¿°': 'ç¿°å¢¨é£˜é¦™ï¼Œæ–‡é‡‡é£æ‰¬', 'å¢¨': 'å¢¨é¦™ä¹¦éŸµï¼Œæ–‡åŒ–åº•è•´', 'ç¬”': 'å¦™ç¬”ç”ŸèŠ±ï¼Œæ–‡é‡‡å‡ºä¼—',
            'ç š': 'æ–‡æˆ¿å››å®ï¼Œæ–‡åŒ–ä¼ æ‰¿', 'æ£‹': 'ç´æ£‹ä¹¦ç”»ï¼Œæ‰è‰ºåŒå…¨', 'ç”»': 'è¯—æƒ…ç”»æ„ï¼Œè‰ºæœ¯å¤©èµ‹',
            'é¦™': 'ä¹¦é¦™é—¨ç¬¬ï¼Œæ–‡åŒ–åº•è•´', 'ç§€': 'ç§€å¤–æ…§ä¸­ï¼Œæ‰è²ŒåŒå…¨', 'ä¸½': 'ç¾ä¸½åŠ¨äººï¼Œå®¹è²Œå‡ºä¼—',
            'æ·¡': 'æ·¡æ³Šååˆ©ï¼Œå“æ ¼é«˜å°š', 'ç´ ': 'ç´ é›…æ¸…æ·¡ï¼Œå“å‘³é«˜é›…'
        }

        return meaning_dict.get(char, f'{char}å­—å¯“æ„ç¾å¥½ï¼Œå«ä¹‰æ·±è¿œ')

    def calculate_wuxing_config_score(self, name_wuxing, bazi_wuxing, day_element):
        """è®¡ç®—äº”è¡Œé…ç½®è¯„åˆ†"""
        score = 60  # åŸºç¡€åˆ†
        # æ£€æŸ¥äº”è¡Œç›¸ç”Ÿå…³ç³»
        for i in range(len(name_wuxing) - 1):
            relation = self.get_wuxing_relation(name_wuxing[i], name_wuxing[i + 1])
            if relation == 'ç›¸ç”Ÿ':
                score += 10
            elif relation == 'ç›¸å…‹':
                score -= 10
        # æ£€æŸ¥å¯¹æ—¥ä¸»çš„è¡¥ç›Š
        name_elements = {}
        for element in name_wuxing:
            name_elements[element] = name_elements.get(element, 0) + 1
        total_bazi = sum(bazi_wuxing.values())
        for element, count in name_elements.items():
            bazi_percentage = (bazi_wuxing.get(element, 0) / total_bazi) * 100 if total_bazi > 0 else 0
            # è¡¥å……ä¸è¶³çš„äº”è¡Œ
            if bazi_percentage < 15:
                score += count * 5
            # é¿å…è¿‡æ—ºçš„äº”è¡Œ
            elif bazi_percentage > 30:
                score -= count * 3
        # ä¸æ—¥ä¸»çš„å…³ç³»
        for element in name_wuxing:
            relation = self.get_wuxing_relation(element, day_element)
            if relation == 'ç›¸ç”Ÿ':
                score += 5
            elif relation == 'è¢«ç”Ÿ':
                score += 3
        return min(100, max(0, score))
    def analyze_name_phonetics(self, surname, given_name):
        """å§“åéŸ³éŸµåˆ†æ"""
        analysis = []
        analysis.append("\nã€å§“åéŸ³éŸµåˆ†æã€‘")
        full_name = surname + given_name
        # å£°è°ƒåˆ†æ
        tones = self.get_name_tones(full_name)
        analysis.append(f"â€¢ å£°è°ƒé…ç½®ï¼š{' '.join(tones)}")
        # éŸ³éŸµè¯„ä»·
        tone_score = self.evaluate_tone_harmony(tones)
        analysis.append(f"â€¢ éŸ³éŸµå’Œè°åº¦ï¼š{tone_score}/100åˆ†")
        # è¯»éŸ³å»ºè®®
        if tone_score >= 80:
            analysis.append("â€¢ éŸ³éŸµè¯„ä»·ï¼šè¯»éŸ³å’Œè°ï¼Œæœ—æœ—ä¸Šå£ï¼Œåˆ©äºäººé™…äº¤å¾€")
        elif tone_score >= 60:
            analysis.append("â€¢ éŸ³éŸµè¯„ä»·ï¼šè¯»éŸ³å°šå¯ï¼ŒåŸºæœ¬å’Œè°ï¼Œæ— æ˜æ˜¾ç¼ºé™·")
        else:
            analysis.append("â€¢ éŸ³éŸµè¯„ä»·ï¼šè¯»éŸ³æ¬ ä½³ï¼Œå»ºè®®è°ƒæ•´å­—éŸ³æ­é…")
        # é¿å…è°éŸ³
        homophone_check = self.check_negative_homophones(full_name)
        if homophone_check:
            analysis.append(f"â€¢ è°éŸ³æé†’ï¼š{homophone_check}")
        else:
            analysis.append("â€¢ è°éŸ³æ£€æŸ¥ï¼šæ— ä¸è‰¯è°éŸ³ï¼Œå¯“æ„è‰¯å¥½")
        return analysis
    def get_name_tones(self, name):
        """è·å–å§“åå£°è°ƒï¼ˆç®€åŒ–ç‰ˆï¼‰"""
        # ç®€åŒ–ç‰ˆå£°è°ƒå­—å…¸
        tone_dict = {
            # ä¸€å£°
            'ç‹': 'ä¸€', 'å¼ ': 'ä¸€', 'å‘¨': 'ä¸€', 'é«˜': 'ä¸€', 'æ–¹': 'ä¸€', 'ä¸œ': 'ä¸€', 'å¤©': 'ä¸€', 'å…‰': 'ä¸€',
            # äºŒå£°
            'æ': 'äºŒ', 'é™ˆ': 'äºŒ', 'æ¨': 'äºŒ', 'é»„': 'äºŒ', 'å¾': 'äºŒ', 'æ—': 'äºŒ', 'ä½•': 'äºŒ', 'å—': 'äºŒ',
            # ä¸‰å£°
            'åˆ˜': 'ä¸‰', 'èµµ': 'ä¸‰', 'é©¬': 'ä¸‰', 'è®¸': 'ä¸‰', 'è‘£': 'ä¸‰', 'è€': 'ä¸‰', 'å°': 'ä¸‰',
            # å››å£°
            'å´': 'å››', 'å­™': 'å››', 'æœ±': 'å››', 'éƒ­': 'å››', 'ç½—': 'å››', 'å®‹': 'å››', 'å¤§': 'å››', 'äº®': 'å››'
        }
        tones = []
        for char in name:
            tone = tone_dict.get(char, 'æœªçŸ¥')
            tones.append(tone)
        return tones
    def evaluate_tone_harmony(self, tones):
        """è¯„ä»·å£°è°ƒå’Œè°åº¦"""
        if len(tones) < 2:
            return 70
        score = 70
        # é¿å…åŒå£°è°ƒ
        if len(set(tones)) == 1:
            score -= 20
        # å¹³ä»„æ­é…
        for i in range(len(tones) - 1):
            if tones[i] in ['ä¸€', 'äºŒ'] and tones[i + 1] in ['ä¸‰', 'å››']:
                score += 10  # å¹³ä»„ç›¸é—´
            elif tones[i] in ['ä¸‰', 'å››'] and tones[i + 1] in ['ä¸€', 'äºŒ']:
                score += 10  # ä»„å¹³ç›¸é—´
        return min(100, max(0, score))
    def check_negative_homophones(self, name):
        """æ£€æŸ¥ä¸è‰¯è°éŸ³"""
        negative_homophones = {
            'å²çé¦™': 'å±çœŸé¦™',
            'æœå­è…¾': 'è‚šå­ç–¼',
            'èŒƒç»Ÿ': 'é¥­æ¡¶',
            'æœ±é€¸ç¾¤': 'çŒªä¸€ç¾¤',
            'ç§¦å¯¿': 'ç¦½å…½',
            'æœç¦ç‡•': 'è‚šè„çœ¼',
            'é­ç”Ÿæ´¥': 'å«ç”Ÿå·¾',
            'æ²ˆäº¬å…µ': 'ç¥ç»ç—…'
        }
        for name_combo, homophone in negative_homophones.items():
            if name_combo in name:
                return f"æ³¨æ„è°éŸ³ï¼š{name_combo} è°éŸ³ {homophone}"
        return None
    def analyze_name_meaning(self, surname, given_name, gender):
        """å§“åå­—ä¹‰åˆ†æ"""
        analysis = []
        analysis.append("\nã€å§“åå­—ä¹‰åˆ†æã€‘")
        # åˆ†æå„å­—å«ä¹‰
        surname_meaning = self.get_character_meaning(surname)
        given_meanings = [self.get_character_meaning(char) for char in given_name]
        analysis.append(f"â€¢ å§“æ°å«ä¹‰ï¼š{surname} - {surname_meaning}")
        for i, char in enumerate(given_name):
            analysis.append(f"â€¢ åå­—å«ä¹‰ï¼š{char} - {given_meanings[i]}")
        # æ•´ä½“å¯“æ„
        overall_meaning = self.get_overall_name_meaning(surname, given_name, gender)
        analysis.append(f"â€¢ æ•´ä½“å¯“æ„ï¼š{overall_meaning}")
        # æ€§åˆ«é€‚é…åº¦
        gender_match = self.evaluate_gender_match(given_name, gender)
        analysis.append(f"â€¢ æ€§åˆ«é€‚é…ï¼š{gender_match}")
        # æ–‡åŒ–å†…æ¶µ
        cultural_content = self.analyze_cultural_content(surname + given_name)
        if cultural_content:
            analysis.append(f"â€¢ æ–‡åŒ–å†…æ¶µï¼š{cultural_content}")
        return analysis
    def get_character_meaning(self, char):
        """è·å–å­—ç¬¦å«ä¹‰"""
        meaning_dict = {
            # å¸¸ç”¨å­—å«ä¹‰
            'ç‹': 'å›ä¸»ã€ç‹è€…ï¼Œè±¡å¾æƒå¨å’Œåœ°ä½',
            'æ': 'ææ ‘ï¼Œè±¡å¾ç”Ÿæœºå’Œç¹è£',
            'å¼ ': 'å¼€å¼“ï¼Œè±¡å¾åŠ›é‡å’Œè¿›å–',
            'åˆ˜': 'æ–§é’ºï¼Œè±¡å¾æƒå¨å’Œå†³æ–­',
            'é™ˆ': 'é™ˆåˆ—ã€å±•ç¤ºï¼Œè±¡å¾æ‰åæ˜¾éœ²',
            'æ¨': 'æ¨æ ‘ï¼Œè±¡å¾æŒºæ‹”å’ŒåšéŸ§',
            'èµµ': 'è¶…è¶Šï¼Œè±¡å¾å“è¶Šå’ŒæˆåŠŸ',
            'é»„': 'é»„è‰²ï¼Œè±¡å¾å°Šè´µå’Œä¸­æ­£',
            'å‘¨': 'å‘¨å…¨ã€å®Œå¤‡ï¼Œè±¡å¾åœ†æ»¡',
            'å´': 'å¤§å£°è¯´è¯ï¼Œè±¡å¾å£°åè¿œæ’­',
            'ä¸œ': 'ä¸œæ–¹ï¼Œè±¡å¾å¸Œæœ›å’Œæ–°ç”Ÿ',
            'å—': 'å—æ–¹ï¼Œè±¡å¾æ¸©æš–å’Œå…‰æ˜',
            'è¥¿': 'è¥¿æ–¹ï¼Œè±¡å¾æ”¶è·å’Œæˆç†Ÿ',
            'åŒ—': 'åŒ—æ–¹ï¼Œè±¡å¾ç¨³é‡å’Œæ·±æ²‰',
            'ä¸­': 'ä¸­å¤®ï¼Œè±¡å¾ä¸­æ­£å’Œå¹³è¡¡',
            'å¤©': 'å¤©ç©ºï¼Œè±¡å¾å¹¿é˜”å’Œå´‡é«˜',
            'åœ°': 'å¤§åœ°ï¼Œè±¡å¾åšå¾·å’ŒåŒ…å®¹',
            'å±±': 'é«˜å±±ï¼Œè±¡å¾ç¨³é‡å’Œåšæ¯…',
            'æ°´': 'æµæ°´ï¼Œè±¡å¾æ™ºæ…§å’ŒçµåŠ¨',
            'ç«': 'ç«ç„°ï¼Œè±¡å¾çƒ­æƒ…å’Œå…‰æ˜',
            'æœ¨': 'æ ‘æœ¨ï¼Œè±¡å¾ç”Ÿé•¿å’Œå¸Œæœ›',
            'é‡‘': 'é‡‘å±ï¼Œè±¡å¾åšå¼ºå’Œçè´µ',
            'åœŸ': 'åœŸå£¤ï¼Œè±¡å¾åšå¾·å’ŒåŒ…å®¹',
            'æ—¥': 'å¤ªé˜³ï¼Œè±¡å¾å…‰æ˜å’Œå¸Œæœ›',
            'æœˆ': 'æœˆäº®ï¼Œè±¡å¾æ¸©æŸ”å’Œç¾å¥½',
            'æ˜Ÿ': 'æ˜Ÿè¾°ï¼Œè±¡å¾ç†æƒ³å’ŒæŒ‡å¼•',
            'å…‰': 'å…‰èŠ’ï¼Œè±¡å¾æ™ºæ…§å’Œå‰é€”',
            'æ˜': 'å…‰æ˜ï¼Œè±¡å¾èªæ…§å’Œå‰ç¨‹',
            'äº®': 'æ˜äº®ï¼Œè±¡å¾æ¸…æ¾ˆå’Œçº¯æ´',
            'è¾‰': 'å…‰è¾‰ï¼Œè±¡å¾æˆå°±å’Œè£è€€',
            'æ™–': 'é˜³å…‰ï¼Œè±¡å¾æ¸©æš–å’Œå¸Œæœ›',
            'æ˜¥': 'æ˜¥å¤©ï¼Œè±¡å¾ç”Ÿæœºå’Œå¸Œæœ›',
            'å¤': 'å¤å¤©ï¼Œè±¡å¾çƒ­æƒ…å’Œæ´»åŠ›',
            'ç§‹': 'ç§‹å¤©ï¼Œè±¡å¾æ”¶è·å’Œæˆç†Ÿ',
            'å†¬': 'å†¬å¤©ï¼Œè±¡å¾åšéŸ§å’Œå†…æ•›',
            'èŠ±': 'èŠ±æœµï¼Œè±¡å¾ç¾ä¸½å’Œçº¯æ´',
            'è‰': 'è‰æœ¨ï¼Œè±¡å¾ç”Ÿå‘½åŠ›å’Œè°¦é€Š',
            'æ ‘': 'å¤§æ ‘ï¼Œè±¡å¾æˆé•¿å’Œåº‡æŠ¤',
            'æ—': 'æ£®æ—ï¼Œè±¡å¾ç¹èŒ‚å’Œå›¢ç»“',
            'æ£®': 'æ£®æ—ï¼Œè±¡å¾èŒ‚ç››å’Œç”Ÿæœº',
            'é¾™': 'ç¥é¾™ï¼Œè±¡å¾æƒå¨å’Œå‰ç¥¥',
            'å‡¤': 'å‡¤å‡°ï¼Œè±¡å¾é«˜è´µå’Œç¾å¥½',
            'è™': 'è€è™ï¼Œè±¡å¾å‹‡çŒ›å’Œå¨æ­¦',
            'é¹°': 'é›„é¹°ï¼Œè±¡å¾é«˜è¿œå’Œè‡ªç”±',
            'çˆ±': 'çˆ±å¿ƒï¼Œè±¡å¾ä»æ…ˆå’Œæ¸©æš–',
            'æƒ…': 'æƒ…æ„Ÿï¼Œè±¡å¾çœŸæŒšå’Œæ·±åš',
            'å¿ƒ': 'å¿ƒçµï¼Œè±¡å¾çº¯çœŸå’Œå–„è‰¯',
            'å¿—': 'å¿—å‘ï¼Œè±¡å¾ç†æƒ³å’ŒæŠ±è´Ÿ',
            'æ„': 'æ„å¿—ï¼Œè±¡å¾åšå®šå’Œæ‰§ç€',
            'æ€': 'æ€è€ƒï¼Œè±¡å¾æ™ºæ…§å’Œæ·±åº¦',
            'æƒ³': 'æƒ³è±¡ï¼Œè±¡å¾åˆ›æ„å’Œç†æƒ³',
            'æ™º': 'æ™ºæ…§ï¼Œè±¡å¾èªæ˜å’Œæ‰å',
            'æ…§': 'æ™ºæ…§ï¼Œè±¡å¾é€šè¾¾å’Œæ˜ç†',
            'èª': 'èªæ˜ï¼Œè±¡å¾æœºæ•å’Œæ‰æ™º',
            'æ˜': 'æ˜æ™ºï¼Œè±¡å¾æ¸…æ™°å’Œç†æ€§',
            'å–„': 'å–„è‰¯ï¼Œè±¡å¾ä»å¾·å’Œæ…ˆæ‚²',
            'ç¾': 'ç¾å¥½ï¼Œè±¡å¾ä¼˜é›…å’Œå®Œç¾',
            'å¥½': 'ç¾å¥½ï¼Œè±¡å¾ä¼˜ç§€å’Œè‰¯å–„',
            'ä½³': 'ç¾å¥½ï¼Œè±¡å¾ä¼˜ç§€å’Œå‰ç¥¥',
            'ä¼˜': 'ä¼˜ç§€ï¼Œè±¡å¾å“è¶Šå’Œå‡ºä¼—',
            'ç§€': 'ç§€ç¾ï¼Œè±¡å¾æ‰åå’Œç¾ä¸½',
            'é›…': 'ä¼˜é›…ï¼Œè±¡å¾é«˜å°šå’Œæ–‡é›…',
            'å®‰': 'å®‰å…¨ï¼Œè±¡å¾å¹³å®‰å’Œç¨³å®š',
            'å®': 'å®‰å®ï¼Œè±¡å¾å¹³é™å’Œå’Œè°',
            'å’Œ': 'å’Œè°ï¼Œè±¡å¾å›¢ç»“å’Œå‹å–„',
            'å¹³': 'å¹³å®‰ï¼Œè±¡å¾ç¨³å®šå’Œå…¬æ­£',
            'åº·': 'å¥åº·ï¼Œè±¡å¾å¼ºå£®å’Œå®‰åº·',
            'å¥': 'å¥åº·ï¼Œè±¡å¾å¼ºå£®å’Œæ´»åŠ›',
            'æˆ': 'æˆåŠŸï¼Œè±¡å¾æˆå°±å’Œå®Œæˆ',
            'åŠŸ': 'åŠŸç»©ï¼Œè±¡å¾æˆå°±å’Œè´¡çŒ®',
            'èƒœ': 'èƒœåˆ©ï¼Œè±¡å¾æˆåŠŸå’Œè¶…è¶Š',
            'åˆ©': 'åˆ©ç›Šï¼Œè±¡å¾é¡ºåˆ©å’ŒæˆåŠŸ',
            'è¾¾': 'åˆ°è¾¾ï¼Œè±¡å¾æˆåŠŸå’Œé€šè¾¾',
            'è¿›': 'è¿›æ­¥ï¼Œè±¡å¾å‘å±•å’Œæå‡',
            'å¼º': 'å¼ºå¤§ï¼Œè±¡å¾åŠ›é‡å’ŒåšéŸ§',
            'åŠ›': 'åŠ›é‡ï¼Œè±¡å¾èƒ½åŠ›å’Œæ´»åŠ›',
            'å‹‡': 'å‹‡æ•¢ï¼Œè±¡å¾èƒ†è¯†å’Œé­„åŠ›',
            'æ•¢': 'å‹‡æ•¢ï¼Œè±¡å¾èƒ†é‡å’Œå†³å¿ƒ',
            'æ¯…': 'æ¯…åŠ›ï¼Œè±¡å¾åšæŒå’Œæ’å¿ƒ',
            'åš': 'åšå¼ºï¼Œè±¡å¾åšå®šå’Œä¸å±ˆ'
        }
        return meaning_dict.get(char, 'å¯“æ„ç¾å¥½ï¼Œå«ä¹‰æ·±è¿œ')
    def get_overall_name_meaning(self, surname, given_name, gender):
        """è·å–å§“åæ•´ä½“å¯“æ„"""
        full_name = surname + given_name
        # æ ¹æ®å¸¸è§ç»„åˆç»™å‡ºå¯“æ„
        if 'æ˜' in given_name and 'äº®' in given_name:
            return "å…‰æ˜ç£Šè½ï¼Œå‰ç¨‹ä¼¼é”¦ï¼Œæ™ºæ…§è¶…ç¾¤"
        elif 'å¿—' in given_name and ('å¼º' in given_name or 'åˆš' in given_name):
            return "å¿—å‘è¿œå¤§ï¼Œæ„å¿—åšå¼ºï¼Œå¿…æˆå¤§å™¨"
        elif 'ç¾' in given_name and ('ä¸½' in given_name or 'é›…' in given_name):
            return "ç¾ä¸½ä¼˜é›…ï¼Œæ°”è´¨éå‡¡ï¼Œäººè§äººçˆ±"
        elif 'æ™º' in given_name and 'æ…§' in given_name:
            return "æ™ºæ…§è¶…ç¾¤ï¼Œæ‰åæ¨ªæº¢ï¼Œå‰é€”æ— é‡"
        elif 'å®‰' in given_name and ('åº·' in given_name or 'å®' in given_name):
            return "å¹³å®‰å¥åº·ï¼Œç”Ÿæ´»å®‰å®ï¼Œç¦å¯¿ç»µé•¿"
        elif 'æˆ' in given_name and 'åŠŸ' in given_name:
            return "äº‹ä¸šæœ‰æˆï¼ŒåŠŸæˆåå°±ï¼Œäººç”Ÿè¾‰ç…Œ"
        else:
            if gender == "ç”·":
                return "é˜³åˆšå¤§æ°”ï¼Œå‰ç¨‹è¿œå¤§ï¼Œå¿…æœ‰ä½œä¸º"
            else:
                return "æ¸©æŸ”è´¤æ·‘ï¼Œç¾ä¸½åŠ¨äººï¼Œç¦æ…§åŒå…¨"
    def evaluate_gender_match(self, given_name, gender):
        """è¯„ä»·æ€§åˆ«é€‚é…åº¦"""
        male_chars = ['å¼º', 'åˆš', 'å‹‡', 'æ¯…', 'é›„', 'å¨', 'æ­¦', 'é¾™', 'è™', 'é¹°', 'å±±', 'çŸ³', 'é’¢', 'é“']
        female_chars = ['ç¾', 'ä¸½', 'é›…', 'é™', 'æŸ”', 'æ¸©', 'æ…§', 'ç§€', 'èŠ±', 'æœˆ', 'å‡¤', 'ç‡•', 'ç‰', 'ç ']
        male_count = sum(1 for char in given_name if char in male_chars)
        female_count = sum(1 for char in given_name if char in female_chars)
        if gender == "ç”·":
            if male_count > female_count:
                return "éå¸¸é€‚åˆï¼Œä½“ç°ç”·æ€§é˜³åˆšä¹‹æ°”"
            elif male_count == female_count:
                return "é€‚ä¸­ï¼ŒåˆšæŸ”å¹¶æµï¼Œè¾ƒä¸ºå¹³è¡¡"
            else:
                return "åæŸ”ï¼Œå»ºè®®å¢åŠ é˜³åˆšå…ƒç´ "
        else:
            if female_count > male_count:
                return "éå¸¸é€‚åˆï¼Œä½“ç°å¥³æ€§æŸ”ç¾ä¹‹æ°”"
            elif female_count == male_count:
                return "é€‚ä¸­ï¼ŒåˆšæŸ”å¹¶æµï¼Œè¾ƒä¸ºå¹³è¡¡"
            else:
                return "ååˆšï¼Œå»ºè®®å¢åŠ æŸ”ç¾å…ƒç´ "
    def analyze_cultural_content(self, full_name):
        """åˆ†ææ–‡åŒ–å†…æ¶µ"""
        cultural_references = {
            'æ˜æœˆ': 'å‡ºè‡ªæç™½è¯—å¥ï¼Œå¯“æ„æ¸…é›…é«˜æ´',
            'æ˜¥é£': 'å‡ºè‡ªå¤è¯—è¯ï¼Œå¯“æ„æ¸©å’Œå®œäºº',
            'ç§‹æ°´': 'å‡ºè‡ªåº„å­ï¼Œå¯“æ„æ¸…æ¾ˆæ˜å‡€',
            'é’å±±': 'å‡ºè‡ªå¤è¯—è¯ï¼Œå¯“æ„åšå®šä¸ç§»',
            'ç™½äº‘': 'å‡ºè‡ªå¤è¯—è¯ï¼Œå¯“æ„è‡ªç”±é£˜é€¸',
            'æ¢…èŠ±': 'å‡ºè‡ªå¤è¯—è¯ï¼Œå¯“æ„åšè´ä¸å±ˆ',
            'ç«¹æ—': 'å‡ºè‡ªå¤å…¸æ–‡å­¦ï¼Œå¯“æ„é«˜æ´å“æ ¼',
            'æ¾æŸ': 'å‡ºè‡ªå¤è¯—è¯ï¼Œå¯“æ„åšéŸ§é•¿é’'
        }
        for reference, meaning in cultural_references.items():
            if reference in full_name:
                return meaning
        return None
    def analyze_name_bazi_match(self, surname, given_name, bazi_result):
        """å§“åä¸å…«å­—åŒ¹é…åˆ†æ"""
        analysis = []
        analysis.append("\nã€å§“åå…«å­—åŒ¹é…ã€‘")
        day_element = bazi_result['day_master_element']
        pattern_type = bazi_result['bazi_pattern']['pattern_type']
        wuxing_distribution = bazi_result['wuxing_distribution']
        # åˆ†æå§“åå¯¹å…«å­—çš„è¡¥ç›Š
        full_name = surname + given_name
        name_elements = []
        for char in full_name:
            element = self.get_character_wuxing(char)
            name_elements.append(element)
        # ç»Ÿè®¡å§“åäº”è¡Œ
        name_element_count = {}
        for element in name_elements:
            name_element_count[element] = name_element_count.get(element, 0) + 1
        analysis.append(f"â€¢ æ—¥ä¸»äº”è¡Œï¼š{day_element}ï¼ˆ{pattern_type}ï¼‰")
        analysis.append(f"â€¢ å§“åäº”è¡Œï¼š{' '.join(name_elements)}")
        # åˆ†æè¡¥ç›Šæ•ˆæœ
        total_bazi = sum(wuxing_distribution.values())
        analysis.append("\nâ€¢ è¡¥ç›Šåˆ†æï¼š")
        for element, count in name_element_count.items():
            bazi_count = wuxing_distribution.get(element, 0)
            bazi_percentage = (bazi_count / total_bazi) * 100 if total_bazi > 0 else 0
            if bazi_percentage < 15:
                analysis.append(f"  {element}ï¼šå…«å­—ç¼ºä¹ï¼ˆ{bazi_percentage:.1f}%ï¼‰ï¼Œå§“åè¡¥å……{count}ä¸ªï¼Œè¡¥ç›Šæ•ˆæœå¥½")
            elif bazi_percentage > 30:
                analysis.append(f"  {element}ï¼šå…«å­—è¿‡æ—ºï¼ˆ{bazi_percentage:.1f}%ï¼‰ï¼Œå§“åå¢åŠ {count}ä¸ªï¼Œå¯èƒ½è¿‡æ—º")
            else:
                analysis.append(f"  {element}ï¼šå…«å­—é€‚ä¸­ï¼ˆ{bazi_percentage:.1f}%ï¼‰ï¼Œå§“åå¢åŠ {count}ä¸ªï¼Œå¹³è¡¡å‘å±•")
        # ä¸æ—¥ä¸»å…³ç³»
        analysis.append("\nâ€¢ ä¸æ—¥ä¸»å…³ç³»ï¼š")
        for element in set(name_elements):
            relation = self.get_wuxing_relation(element, day_element)
            if relation == 'ç›¸ç”Ÿ':
                analysis.append(f"  {element}ç”Ÿ{day_element}ï¼šæœ‰åŠ©äºå¢å¼ºæ—¥ä¸»åŠ›é‡")
            elif relation == 'è¢«ç”Ÿ':
                analysis.append(f"  {day_element}ç”Ÿ{element}ï¼šæ¶ˆè€—æ—¥ä¸»åŠ›é‡ï¼Œéœ€è¦å¹³è¡¡")
            elif relation == 'ç›¸å…‹':
                analysis.append(f"  {element}å…‹{day_element}ï¼šå¯¹æ—¥ä¸»æœ‰åˆ¶çº¦ä½œç”¨")
            elif relation == 'è¢«å…‹':
                analysis.append(f"  {day_element}å…‹{element}ï¼šæ—¥ä¸»åˆ¶çº¦æ­¤äº”è¡Œ")
            else:
                analysis.append(f"  {element}ä¸{day_element}åŒç±»ï¼šå¢å¼ºåŒç±»åŠ›é‡")
        # åŒ¹é…åº¦è¯„åˆ†
        match_score = self.calculate_name_bazi_match_score(name_elements, bazi_result)
        analysis.append(f"\nâ€¢ å…«å­—åŒ¹é…åº¦ï¼š{match_score}/100åˆ†")
        return analysis
    def calculate_name_bazi_match_score(self, name_elements, bazi_result):
        """è®¡ç®—å§“åå…«å­—åŒ¹é…åº¦è¯„åˆ†"""
        score = 60  # åŸºç¡€åˆ†
        day_element = bazi_result['day_master_element']
        pattern_type = bazi_result['bazi_pattern']['pattern_type']
        wuxing_distribution = bazi_result['wuxing_distribution']
        # ç»Ÿè®¡å§“åäº”è¡Œ
        name_element_count = {}
        for element in name_elements:
            name_element_count[element] = name_element_count.get(element, 0) + 1
        total_bazi = sum(wuxing_distribution.values())
        # è¡¥ç›Šè¯„åˆ†
        for element, count in name_element_count.items():
            bazi_count = wuxing_distribution.get(element, 0)
            bazi_percentage = (bazi_count / total_bazi) * 100 if total_bazi > 0 else 0
            if bazi_percentage < 15:  # å…«å­—ç¼ºä¹æ­¤äº”è¡Œ
                score += count * 8  # è¡¥å……ç¼ºä¹çš„äº”è¡Œï¼ŒåŠ åˆ†è¾ƒå¤š
            elif bazi_percentage > 30:  # å…«å­—æ­¤äº”è¡Œè¿‡æ—º
                score -= count * 5  # å¢åŠ è¿‡æ—ºçš„äº”è¡Œï¼Œå‡åˆ†
            else:  # å…«å­—æ­¤äº”è¡Œé€‚ä¸­
                score += count * 2  # é€‚ä¸­çš„äº”è¡Œï¼Œå°‘é‡åŠ åˆ†
        # ä¸æ—¥ä¸»å…³ç³»è¯„åˆ†
        for element in name_elements:
            relation = self.get_wuxing_relation(element, day_element)
            if pattern_type in ['èº«å¼ºæ ¼', 'èº«æ—ºæ ¼']:
                # èº«å¼ºéœ€è¦å…‹æ³„è€—
                if relation in ['ç›¸å…‹', 'è¢«ç”Ÿ']:
                    score += 5
                elif relation == 'ç›¸ç”Ÿ':
                    score -= 3
            else:
                # èº«å¼±éœ€è¦ç”Ÿæ‰¶
                if relation in ['ç›¸ç”Ÿ', 'åŒç±»']:
                    score += 5
                elif relation == 'ç›¸å…‹':
                    score -= 5
        return min(100, max(0, score))
    def calculate_name_overall_score(self, surname, given_name, bazi_result, gender):
        """è®¡ç®—å§“åç»¼åˆè¯„åˆ†"""
        analysis = []
        analysis.append("\nã€å§“åç»¼åˆè¯„åˆ†ã€‘")
        # å„é¡¹è¯„åˆ†
        scores = {}
        # äº”æ ¼æ•°ç†è¯„åˆ†ï¼ˆç®€åŒ–ï¼‰
        scores['wuge'] = 75  # åŸºç¡€åˆ†ï¼Œå®é™…éœ€è¦è¯¦ç»†è®¡ç®—
        # äº”è¡Œé…ç½®è¯„åˆ†
        name_wuxing = [self.get_character_wuxing(char) for char in surname + given_name]
        scores['wuxing'] = self.calculate_wuxing_config_score(name_wuxing, bazi_result['wuxing_distribution'], bazi_result['day_master_element'])
        # éŸ³éŸµè¯„åˆ†
        tones = self.get_name_tones(surname + given_name)
        scores['phonetics'] = self.evaluate_tone_harmony(tones)
        # å­—ä¹‰è¯„åˆ†
        scores['meaning'] = 80  # åŸºç¡€åˆ†ï¼Œæ ¹æ®å­—ä¹‰å¥½åè°ƒæ•´
        # å…«å­—åŒ¹é…è¯„åˆ†
        scores['bazi_match'] = self.calculate_name_bazi_match_score(name_wuxing, bazi_result)
        # æ€§åˆ«é€‚é…è¯„åˆ†
        gender_match = self.evaluate_gender_match(given_name, gender)
        if "éå¸¸é€‚åˆ" in gender_match:
            scores['gender'] = 90
        elif "é€‚ä¸­" in gender_match:
            scores['gender'] = 75
        else:
            scores['gender'] = 60
        # æ˜¾ç¤ºå„é¡¹è¯„åˆ†
        analysis.append("â€¢ å„é¡¹è¯„åˆ†ï¼š")
        analysis.append(f"  äº”æ ¼æ•°ç†ï¼š{scores['wuge']}/100åˆ†")
        analysis.append(f"  äº”è¡Œé…ç½®ï¼š{scores['wuxing']}/100åˆ†")
        analysis.append(f"  éŸ³éŸµå’Œè°ï¼š{scores['phonetics']}/100åˆ†")
        analysis.append(f"  å­—ä¹‰å†…æ¶µï¼š{scores['meaning']}/100åˆ†")
        analysis.append(f"  å…«å­—åŒ¹é…ï¼š{scores['bazi_match']}/100åˆ†")
        analysis.append(f"  æ€§åˆ«é€‚é…ï¼š{scores['gender']}/100åˆ†")
        # è®¡ç®—ç»¼åˆè¯„åˆ†ï¼ˆåŠ æƒå¹³å‡ï¼‰
        weights = {
            'wuge': 0.2,
            'wuxing': 0.25,
            'phonetics': 0.15,
            'meaning': 0.15,
            'bazi_match': 0.2,
            'gender': 0.05
        }
        overall_score = sum(scores[key] * weights[key] for key in scores.keys())
        analysis.append(f"\nâ€¢ ç»¼åˆè¯„åˆ†ï¼š{overall_score:.1f}/100åˆ†")
        # è¯„åˆ†ç­‰çº§
        if overall_score >= 90:
            grade = "ä¼˜ç§€"
            comment = "å§“åé…ç½®æä½³ï¼Œå„æ–¹é¢éƒ½å¾ˆåè°ƒï¼Œæ˜¯éš¾å¾—çš„å¥½åå­—"
        elif overall_score >= 80:
            grade = "è‰¯å¥½"
            comment = "å§“åé…ç½®è¾ƒå¥½ï¼Œå¤§éƒ¨åˆ†æ–¹é¢éƒ½æ¯”è¾ƒåè°ƒï¼Œæ˜¯ä¸é”™çš„åå­—"
        elif overall_score >= 70:
            grade = "ä¸­ç­‰"
            comment = "å§“åé…ç½®ä¸€èˆ¬ï¼Œæœ‰äº›æ–¹é¢éœ€è¦æ”¹è¿›ï¼Œå»ºè®®é€‚å½“è°ƒæ•´"
        elif overall_score >= 60:
            grade = "åŠæ ¼"
            comment = "å§“åé…ç½®åä½ï¼Œå¤šä¸ªæ–¹é¢éœ€è¦æ”¹è¿›ï¼Œå»ºè®®é‡æ–°è€ƒè™‘"
        else:
            grade = "ä¸åŠæ ¼"
            comment = "å§“åé…ç½®è¾ƒå·®ï¼Œå»ºè®®é‡æ–°èµ·åæˆ–æ”¹å"
        analysis.append(f"â€¢ è¯„åˆ†ç­‰çº§ï¼š{grade}")
        analysis.append(f"â€¢ ç»¼åˆè¯„ä»·ï¼š{comment}")
        # æ”¹è¿›å»ºè®®
        analysis.append("\nâ€¢ æ”¹è¿›å»ºè®®ï¼š")
        if scores['wuxing'] < 70:
            analysis.append("  äº”è¡Œé…ç½®éœ€è¦è°ƒæ•´ï¼Œå»ºè®®é€‰æ‹©æ›´ç¬¦åˆå…«å­—éœ€è¦çš„å­—")
        if scores['phonetics'] < 70:
            analysis.append("  éŸ³éŸµæ­é…éœ€è¦æ”¹å–„ï¼Œå»ºè®®è°ƒæ•´å£°è°ƒç»„åˆ")
        if scores['bazi_match'] < 70:
            analysis.append("  ä¸å…«å­—åŒ¹é…åº¦ä¸é«˜ï¼Œå»ºè®®é€‰æ‹©æ›´èƒ½è¡¥ç›Šå…«å­—çš„å­—")
        if scores['gender'] < 70:
            analysis.append("  æ€§åˆ«ç‰¹å¾ä¸å¤Ÿæ˜æ˜¾ï¼Œå»ºè®®é€‰æ‹©æ›´ç¬¦åˆæ€§åˆ«ç‰¹ç‚¹çš„å­—")
        return analysis
    def suggest_name_improvements(self, surname, bazi_result, gender):
        """èµ·åå»ºè®®"""
        analysis = []
        analysis.append("\nã€èµ·åå»ºè®®ã€‘")
        day_element = bazi_result['day_master_element']
        pattern_type = bazi_result['bazi_pattern']['pattern_type']
        wuxing_distribution = bazi_result['wuxing_distribution']
        # åˆ†æå…«å­—éœ€è¦è¡¥å……çš„äº”è¡Œ
        total_bazi = sum(wuxing_distribution.values())
        needed_elements = []
        avoid_elements = []
        for element in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']:
            percentage = (wuxing_distribution.get(element, 0) / total_bazi) * 100 if total_bazi > 0 else 0
            if percentage < 15:
                needed_elements.append(element)
            elif percentage > 30:
                avoid_elements.append(element)
        analysis.append(f"â€¢ å…«å­—åˆ†æï¼š{day_element}æ—¥ä¸»ï¼Œ{pattern_type}")
        if needed_elements:
            analysis.append(f"â€¢ éœ€è¦è¡¥å……ï¼š{', '.join(needed_elements)}äº”è¡Œ")
        if avoid_elements:
            analysis.append(f"â€¢ é¿å…ä½¿ç”¨ï¼š{', '.join(avoid_elements)}äº”è¡Œ")
        # æ¨èç”¨å­—
        analysis.append("\nâ€¢ æ¨èç”¨å­—ï¼š")
        if needed_elements:
            for element in needed_elements[:2]:  # æœ€å¤šæ¨è2ä¸ªäº”è¡Œ
                recommended_chars = self.get_recommended_chars_by_element(element, gender)
                analysis.append(f"  {element}æ€§å­—ï¼š{', '.join(recommended_chars)}")
        # èµ·ååŸåˆ™
        analysis.append("\nâ€¢ èµ·ååŸåˆ™ï¼š")
        analysis.append("  1. äº”è¡Œé…ç½®è¦ç¬¦åˆå…«å­—éœ€è¦ï¼Œè¡¥å¼ºä¸è¶³ï¼Œå¹³è¡¡è¿‡æ—º")
        analysis.append("  2. éŸ³éŸµè¦å’Œè°ï¼Œé¿å…åŒå£°è°ƒï¼Œå¹³ä»„ç›¸é—´ä¸ºä½³")
        analysis.append("  3. å­—ä¹‰è¦ç¾å¥½ï¼Œå¯“æ„æ·±è¿œï¼Œç¬¦åˆæ€§åˆ«ç‰¹å¾")
        analysis.append("  4. é¿å…ä¸è‰¯è°éŸ³ï¼Œç¡®ä¿è¯»éŸ³å“äº®å¥½å¬")
        analysis.append("  5. ç¬”ç”»æ­é…è¦åˆç†ï¼Œäº”æ ¼æ•°ç†è¦å‰ç¥¥")
        # å…·ä½“å»ºè®®
        analysis.append("\nâ€¢ å…·ä½“å»ºè®®ï¼š")
        if gender == "ç”·":
            analysis.append("  ç”·å­©èµ·åå®œç”¨é˜³åˆšå¤§æ°”çš„å­—ï¼Œä½“ç°ç”·æ€§ç‰¹è´¨")
            analysis.append("  å¯é€‰ç”¨ï¼šå¼ºã€åˆšã€å‹‡ã€æ¯…ã€é›„ã€å¨ã€é¾™ã€è™ç­‰å­—")
        else:
            analysis.append("  å¥³å­©èµ·åå®œç”¨æŸ”ç¾é›…è‡´çš„å­—ï¼Œä½“ç°å¥³æ€§ç‰¹è´¨")
            analysis.append("  å¯é€‰ç”¨ï¼šç¾ã€ä¸½ã€é›…ã€é™ã€æŸ”ã€æ…§ã€èŠ±ã€æœˆç­‰å­—")
        analysis.append("  æ³¨æ„å§“åæ•´ä½“çš„åè°ƒæ€§ï¼Œé¿å…å¤´é‡è„šè½»æˆ–å¤´è½»è„šé‡")
        analysis.append("  è€ƒè™‘ä¹¦å†™çš„ç¾è§‚æ€§ï¼Œé¿å…è¿‡äºå¤æ‚æˆ–è¿‡äºç®€å•çš„å­—")
        return analysis

    def generate_single_character_names(self, surname, bazi_result, gender, style, count):
        """ç”Ÿæˆå•å­—åæ¨è - å¢å¼ºç‰ˆå¤šé£æ ¼æ”¯æŒ"""
        analysis = []
        analysis.append(f"ã€å•å­—åæ¨è - {style}é£æ ¼ã€‘")

        # æ ¹æ®å…«å­—åˆ†æéœ€è¦çš„äº”è¡Œ
        day_element = bazi_result['day_master_element']
        wuxing_distribution = bazi_result['wuxing_distribution']
        total_bazi = sum(wuxing_distribution.values())

        # åˆ†æéœ€è¦è¡¥å……çš„äº”è¡Œ
        needed_elements = self.analyze_needed_elements(wuxing_distribution)

        # æ ¹æ®é£æ ¼ç”Ÿæˆåå­—
        names = self.generate_names_by_style(surname, gender, style, needed_elements, count, 1)

        # æ·»åŠ äº”è¡Œåˆ†æè¯´æ˜
        analysis.append(f"\nã€äº”è¡Œåˆ†æã€‘")
        analysis.append(f"æ—¥ä¸»ï¼š{day_element}")
        analysis.append(f"éœ€è¦è¡¥å……ï¼š{', '.join(needed_elements)}")
        analysis.append(f"")

        # æ˜¾ç¤ºæ¨èçš„åå­—
        if names:
            for i, name_info in enumerate(names[:count], 1):
                analysis.append(f"{i}. {name_info['full_name']}")
                analysis.append(f"   äº”è¡Œï¼š{name_info['wuxing']}")
                analysis.append(f"   å¯“æ„ï¼š{name_info['meaning'][:50]}...")
                analysis.append(f"   è¯„åˆ†ï¼š{name_info['score']:.1f}åˆ†")
                if name_info.get('source'):
                    analysis.append(f"   å‡ºå¤„ï¼š{name_info['source']}")
                analysis.append("")
        else:
            analysis.append("âš ï¸ æœªèƒ½ç”Ÿæˆåˆé€‚çš„åå­—ï¼Œè¯·å°è¯•å…¶ä»–é£æ ¼")

        return analysis

    def analyze_needed_elements(self, wuxing_distribution):
        """åˆ†æéœ€è¦è¡¥å……çš„äº”è¡Œ"""
        needed_elements = []
        total_bazi = sum(wuxing_distribution.values())

        for element, count_val in wuxing_distribution.items():
            percentage = (count_val / total_bazi) * 100 if total_bazi > 0 else 0
            if percentage < 15:  # å°‘äº15%è®¤ä¸ºéœ€è¦è¡¥å……
                needed_elements.append(element)

        # å¦‚æœæ²¡æœ‰æ˜æ˜¾ç¼ºå¤±çš„äº”è¡Œï¼Œè¿”å›æœ€å°‘çš„ä¸¤ä¸ª
        if not needed_elements:
            sorted_elements = sorted(wuxing_distribution.items(), key=lambda x: x[1])
            needed_elements = [sorted_elements[0][0], sorted_elements[1][0]]

        return needed_elements

    def generate_names_by_style(self, surname, gender, style, needed_elements, count, name_length):
        """æ ¹æ®é£æ ¼ç”Ÿæˆåå­—"""
        try:
            print(f"ğŸ”§ å¼€å§‹ç”Ÿæˆåå­—: å§“æ°={surname}, æ€§åˆ«={gender}, é£æ ¼={style}, éœ€è¦äº”è¡Œ={needed_elements}, æ•°é‡={count}, é•¿åº¦={name_length}")

            # æ ¹æ®é£æ ¼é€‰æ‹©å­—åº“
            try:
                print(f"ğŸ”§ å‡†å¤‡è°ƒç”¨ get_style_characters: style={style}, gender={gender}, needed_elements={needed_elements}")
                char_pool = self.get_style_characters(style, gender, needed_elements)
                print(f"ğŸ”§ get_style_characters è¿”å›: {type(char_pool)}, é•¿åº¦={len(char_pool) if char_pool else 'None'}")
                print(f"ğŸ”§ è·å¾—å­—ç¬¦åº“: {len(char_pool)}ä¸ªå­—ç¬¦ - {char_pool[:10]}...")
            except Exception as e:
                print(f"âŒ get_style_characters è°ƒç”¨å¤±è´¥: {e}")
                import traceback
                traceback.print_exc()
                char_pool = []

            if not char_pool:
                print("âŒ å­—ç¬¦åº“ä¸ºç©ºï¼")
                return []

            # ç”Ÿæˆæ¨è
            suggestions = []

            if name_length == 1:
                # å•å­—å
                for char in char_pool[:count * 3]:  # å¤šç”Ÿæˆä¸€äº›ç”¨äºç­›é€‰
                    char_element = self.get_character_wuxing(char)
                    char_meaning = self.get_character_meaning(char)
                    source = self.get_character_source(char, style)

                    suggestions.append({
                        'full_name': surname + char,
                        'chars': [char],
                        'wuxing': char_element,
                        'meaning': char_meaning,
                        'score': self.calculate_name_score_simple(surname, [char], needed_elements),
                        'source': source
                    })
            else:
                # åŒå­—å
                for i, char1 in enumerate(char_pool[:count]):
                    for char2 in char_pool[i+1:count*2]:
                        char1_element = self.get_character_wuxing(char1)
                        char2_element = self.get_character_wuxing(char2)
                        combined_meaning = f"{self.get_character_meaning(char1)}ï¼Œ{self.get_character_meaning(char2)}"
                        source = self.get_combined_source(char1, char2, style)

                        suggestions.append({
                            'full_name': surname + char1 + char2,
                            'chars': [char1, char2],
                            'wuxing': f"{char1_element}+{char2_element}",
                            'meaning': combined_meaning,
                            'score': self.calculate_name_score_simple(surname, [char1, char2], needed_elements),
                            'source': source
                        })

            # æŒ‰è¯„åˆ†æ’åº
            suggestions.sort(key=lambda x: x['score'], reverse=True)

            return suggestions[:count]

        except Exception as e:
            print(f"âŒ ç”Ÿæˆåå­—å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            return []

    def get_style_characters(self, style, gender, needed_elements, position='any'):
        """æ ¹æ®é£æ ¼å’Œæ€§åˆ«è·å–å­—ç¬¦åº“ - ä¿®å¤ç‰ˆï¼Œä½¿ç”¨çœŸæ­£é€‚åˆèµ·åçš„å­—"""
        # ä¿®å¤ï¼šä½¿ç”¨çœŸæ­£é€‚åˆèµ·åçš„å­—åº“ï¼Œæ¯ä¸ªå­—éƒ½æœ‰æ˜ç¡®çš„äº”è¡Œå±æ€§
        style_chars = {
            "å‘¨æ˜“ç»å…¸": {
                "male": [
                    # å…«å¦ç›¸å…³
                    "ä¹¾", "å¤", "éœ‡", "å·½", "å", "ç¦»", "è‰®", "å…‘",
                    # å››å¾·ç›¸å…³
                    "å…ƒ", "äº¨", "åˆ©", "è´", "å¾·", "æ­£", "æ˜", "æ™º", "ä»", "ä¹‰", "ç¤¼", "ä¿¡",
                    # å›å­å“å¾·
                    "å›", "å­", "æ–‡", "æ­¦", "åˆš", "æŸ”", "ä¸­", "å’Œ", "è°¦", "æ­", "æ¸©", "è‰¯",
                    # å¤©åœ°äººä¸‰æ‰
                    "å¤©", "åœ°", "äºº", "æ‰", "åœ£", "è´¤", "è¾¾", "é€š", "åš", "å­¦", "æ€", "æ•",
                    # äº”å¸¸å…«å¾·
                    "å¿ ", "å­", "èŠ‚", "ä¹‰", "å»‰", "è€»", "ç¤¼", "æ™º", "ä¿¡", "å‹‡", "ä¸¥", "æ•",
                    # è‡ªç„¶è±¡å¾
                    "å±±", "æ°´", "é£", "é›·", "ç«", "æ³½", "äº‘", "é¾™", "å‡¤", "éºŸ", "é¾Ÿ", "é¹¤",
                    # å“æ ¼ä¿®å…»
                    "ä¿®", "å…»", "è¯š", "æ•¬", "æ…", "ç‹¬", "æ ¼", "ç‰©", "è‡´", "çŸ¥", "æ­£", "å¿ƒ",
                    # äº‹ä¸šæˆå°±
                    "å»º", "åŠŸ", "ç«‹", "ä¸š", "æˆ", "å°±", "è¾‰", "ç…Œ", "å…‰", "è€€", "è£", "å",
                    # æ—¶ç©ºæ¦‚å¿µ
                    "æ°¸", "æ’", "ä¹…", "è¿œ", "é•¿", "é’", "ä¸", "æœ½", "åƒ", "ç§‹", "ä¸‡", "ä»£"
                ],
                "female": [
                    # å¤å¾·ç›¸å…³
                    "å¤", "æŸ”", "é¡º", "æ‰¿", "è½½", "åš", "å¾·", "æ¯", "ä»ª", "å¤©", "ä¸‹", "æ…ˆ",
                    # ç¾å¾·å“æ ¼
                    "ç¾", "é›…", "æ…§", "è´¤", "æ·‘", "å©‰", "é™", "å¨´", "æ¸©", "å–„", "çº¯", "çœŸ",
                    # è‡ªç„¶ç¾å¥½
                    "æ¸…", "ç§€", "ç«¯", "åº„", "èŠ³", "å", "è‹±", "è•™", "å…°", "èŠ", "æ¢…", "ç«¹",
                    # å¥³æ€§ç‰¹è´¨
                    "æŸ”", "åªš", "å¨‡", "è‰³", "ä¸½", "ç¾", "å§¿", "å®¹", "é¢œ", "è‰²", "é¦™", "éŸµ",
                    # å“å¾·ä¿®å…»
                    "è´", "æ´", "èŠ‚", "æ“", "å“", "æ ¼", "ä¿®", "å…»", "æ•™", "åŒ–", "ç¤¼", "ä»ª",
                    # æ‰åæ™ºæ…§
                    "æ‰", "å", "æ™º", "æ…§", "èª", "é¢–", "æ•", "æ·", "æ€", "ç»´", "ç†", "è§£",
                    # å‰ç¥¥å¦‚æ„
                    "ç¦", "ç¦„", "å¯¿", "å–œ", "å‰", "ç¥¥", "å¦‚", "æ„", "å®‰", "åº·", "å¹³", "å’Œ",
                    # è‡ªç„¶æ™¯è±¡
                    "æœˆ", "æ˜Ÿ", "äº‘", "éœ", "éœ²", "éœœ", "é›ª", "å†°", "æ°´", "æ³¢", "æ¶Ÿ", "æ¼ª",
                    # èŠ±è‰æ¤ç‰©
                    "èŠ±", "è‰", "å¶", "æ", "èŠ½", "è‹—", "è•¾", "è•Š", "ç“£", "é¦™", "èŠ¬", "èŠ³"
                ]
            },
            "è¯—ç»é›…éŸµ": {
                "male": [
                    # å›å­å“æ ¼
                    "å›", "å­", "å½¬", "é›…", "æ­£", "å¾·", "ä»", "ä¹‰", "ç¤¼", "æ™º", "ä¿¡", "æ¸©", "è‰¯", "æ­", "ä¿­", "è°¦", "å’Œ",
                    # è‡ªç„¶æ„è±¡
                    "æ³½", "æ¶¦", "åš", "æ–‡", "å±±", "å·", "æ²³", "æµ·", "é£", "é›¨", "äº‘", "éœ", "æ¾", "æŸ", "ç«¹", "æ¢…",
                    # å“å¾·ä¿®å…»
                    "è¯š", "æ•¬", "æ…", "ç‹¬", "ä¿®", "èº«", "é½", "å®¶", "æ²»", "å›½", "å¹³", "å¤©", "ä¸‹", "æ ¼", "ç‰©", "è‡´",
                    # æ‰åå­¦è¯†
                    "å­¦", "è€Œ", "æ—¶", "ä¹ ", "æ€", "è€Œ", "ä¸", "å­¦", "åˆ™", "æ®†", "çŸ¥", "ä¹‹", "ä¸º", "çŸ¥", "ä¹‹", "ä¸",
                    # è¯—ç»å…¸æ•…
                    "å…³", "é›", "é¸ ", "é¸½", "åœ¨", "æ²³", "ä¹‹", "æ´²", "çªˆ", "çª•", "æ·‘", "å¥³", "å¥½", "é€‘", "å‚", "å·®"
                ],
                "female": [
                    # æ·‘å¥³å“æ ¼
                    "çªˆ", "çª•", "æ·‘", "å¥³", "é›…", "é™", "ç¾", "æ…§", "è´¤", "å©‰", "å¨´", "æ¸©", "æŸ”", "å–„", "çº¯", "æ¸…", "ç§€",
                    # èŠ±è‰æ¤ç‰©
                    "èŠ³", "å", "è‹±", "è•™", "å…°", "èŠ", "æ¢…", "ç«¹", "è·", "è²", "æ¡ƒ", "æ", "æ", "æ¢¨", "èŠ±", "è‰",
                    # è‡ªç„¶ç¾æ™¯
                    "æœˆ", "æ˜Ÿ", "äº‘", "éœ", "éœ²", "éœœ", "é›ª", "å†°", "æ°´", "æ³¢", "æ¶Ÿ", "æ¼ª", "æ³‰", "æºª", "æ±Ÿ", "æ²³",
                    # å“å¾·ç¾å¥½
                    "è´", "æ´", "èŠ‚", "æ“", "å“", "æ ¼", "ä¿®", "å…»", "æ•™", "åŒ–", "ç¤¼", "ä»ª", "å¾·", "è¡Œ", "å–„", "è‰¯",
                    # æ‰åæ™ºæ…§
                    "æ‰", "å", "æ™º", "æ…§", "èª", "é¢–", "æ•", "æ·", "æ€", "ç»´", "ç†", "è§£", "æ–‡", "é‡‡", "è¯—", "è¯",
                    # å‰ç¥¥å¦‚æ„
                    "ç¦", "ç¦„", "å¯¿", "å–œ", "å‰", "ç¥¥", "å¦‚", "æ„", "å®‰", "åº·", "å¹³", "å’Œ", "ä¹", "æ¬¢", "æ„‰", "æ‚¦"
                ]
            },
            "æ¥šè¾è±ªæ”¾": {
                "male": ["å¿—", "è¿œ", "åš", "å®‡", "æµ©", "ç„¶", "å¤©", "ç¿”", "é¹", "é£", "äº‘", "å¸†", "æµ·", "æ¶›", "å±±", "å³°", "é›„", "ä¼Ÿ", "è±ª", "æ°"],
                "female": ["æ¹˜", "äº‘", "æ¢¦", "å…°", "èŠ·", "å©‰", "æ¸…", "é›…", "æ·‘", "æ…§", "ç¾", "ä¸½", "èŠ³", "å", "è‹±", "è•™", "è‹¥", "èŒ—", "èƒ", "è·"]
            },
            "è®ºè¯­æ™ºæ…§": {
                "male": ["ä»", "ä¹‰", "ç¤¼", "æ™º", "ä¿¡", "æ¸©", "è‰¯", "æ­", "ä¿­", "è®©", "å­¦", "æ€", "æ•", "è¾¾", "åš", "æ–‡", "é›…", "æ­£", "å¾·", "è´¤"],
                "female": ["æ…§", "è´¤", "æ·‘", "å¾·", "å–„", "ç¾", "é›…", "é™", "å¨´", "æ¸©", "æŸ”", "é¡º", "å’Œ", "è°", "çº¯", "çœŸ", "æ¸…", "ç§€", "å©‰", "çº¦"]
            },
            "å”è¯—å®‹è¯": {
                "male": ["è¯—", "éŸµ", "æ–‡", "é›…", "åš", "å­¦", "æ‰", "å", "ä¿Š", "é€¸", "é£", "æµ", "æ½‡", "æ´’", "æ¸…", "é›…", "æ·¡", "æ³Š", "å®", "é™"],
                "female": ["è¯—", "éŸµ", "é›…", "è‡´", "æ¸…", "æ·¡", "ç´ ", "æ–‡", "é™", "ä¹¦", "é¦™", "å¢¨", "ç´", "å¿ƒ", "èŠ±", "è¯­", "æœˆ", "å½±", "é£", "è·"]
            },
            "å¤å…¸åè‘—": {
                "male": ["æ–‡", "æ­¦", "è‹±", "é›„", "è±ª", "æ°", "å¿—", "è¿œ", "åš", "å­¦", "æ‰", "å", "ä¿Š", "é€¸", "é£", "æµ", "æ½‡", "æ´’", "æ¸…", "é›…"],
                "female": ["é»›", "ç‰", "å®", "å‡¤", "å…ƒ", "æ˜¥", "è¿", "æ˜¥", "æ¢", "æ˜¥", "æƒœ", "æ˜¥", "å¦™", "ç‰", "æ¹˜", "äº‘", "è¢­", "äºº", "æ™´", "é›¯"]
            },
            "ç°ä»£æ—¶å°š": {
                "male": ["è½©", "å®‡", "æµ©", "ç„¶", "å­", "æ¶µ", "æ¢“", "è±ª", "ä¿Š", "æ°", "å¿—", "å¼º", "å»º", "å", "ä¼Ÿ", "æ˜", "æ–‡", "åš", "ç¿", "æ™º"],
                "female": ["é›¨", "è±", "æ¢“", "æ¶µ", "è¯—", "ä½³", "æ€¡", "æ€", "å¯", "é¦¨", "è‰º", "ç¾", "ç³", "é›ª", "ä¸½", "éŸµ", "æ¬£", "æ‚¦", "å©·", "å¨œ"]
            },
            "å¯“æ„å‰ç¥¥": {
                "male": ["ç¦", "ç¦„", "å¯¿", "å–œ", "è´µ", "è£", "å", "å¯Œ", "å¼º", "åº·", "å®", "å®‰", "æ³°", "å‰", "ç¥¥", "ç‘", "ç¥º", "éº’", "éºŸ", "é¾™"],
                "female": ["å¦‚", "æ„", "å‰", "ç¥¥", "ç¾", "æ»¡", "å¹¸", "ç¦", "å®‰", "åº·", "å¹³", "é¡º", "åˆ©", "è´µ", "è£", "å", "èŠ±", "å¥½", "æœˆ", "åœ†"]
            },
            "äº”è¡Œå¹³è¡¡": {
                # æœ¨å±æ€§å­—
                "wood": ["æ—", "æ£®", "æŸ", "æ¾", "æ¢…", "å…°", "ç«¹", "èŠ", "èŠ³", "èŠ¸", "è‹¥", "èŒ—", "èƒ", "è•™", "è‹±", "å", "å½¬", "æ‰", "æ¡‚", "æ¢§"],
                # ç«å±æ€§å­—
                "fire": ["ç‚", "ç„±", "è¾‰", "å…‰", "æ˜", "äº®", "æ™¶", "æ™¨", "æ˜•", "æ—­", "é˜³", "æ—¥", "æ™´", "æš–", "ç…Œ", "çƒ", "ç¿", "çƒ‚", "ç† ", "ç„•"],
                # åœŸå±æ€§å­—
                "earth": ["å±±", "å²³", "å³°", "å²­", "å¤", "åŸ", "åš", "å›º", "ç¨³", "é‡", "åš", "å®", "åŸ¹", "åŸº", "å’", "å ¡", "å¢¨", "ç”»", "åœ£", "è´¤"],
                # é‡‘å±æ€§å­—
                "metal": ["é‡‘", "é“¶", "é”‹", "é”", "é’Š", "é’§", "é“­", "é”¦", "é•‡", "é‘«", "é’°", "é“ƒ", "é”¡", "é•œ", "é’Ÿ", "é“", "åˆš", "å¼º", "åš", "æ¯…"],
                # æ°´å±æ€§å­—
                "water": ["æ±Ÿ", "æ²³", "æ¹–", "æµ·", "æ³¢", "æ¶›", "æµ", "æºª", "æ³‰", "æº", "æ¸…", "æ¾ˆ", "æ¶¦", "æ³½", "æ´", "å‡€", "é›¨", "é›ª", "éœœ", "éœ²"]
            },
            "ç”Ÿè‚–å–œå¿Œ": {
                # è¿™é‡Œéœ€è¦æ ¹æ®å…·ä½“ç”Ÿè‚–æ¥é€‰æ‹©ï¼Œæš‚æ—¶ä½¿ç”¨é€šç”¨å­—
                "common": ["ç‘", "ç¥¥", "å‰", "åº†", "ç¦", "ç¦„", "å¯¿", "å–œ", "è´¢", "è´µ", "è£", "å", "å¯Œ", "å¼º", "åº·", "å®", "å®‰", "æ³°", "å’Œ", "ç¾"]
            },
            "éŸ³éŸµå’Œè°": {
                "male": ["æ˜‚", "æ˜Œ", "ç•…", "æœ—", "äº®", "å®", "æ´ª", "é¸¿", "å¼˜", "æ³“", "æµ©", "çš“", "è±ª", "è½©", "ç…Š", "ç‚«", "æ—‹", "ç’‡", "é€‰", "å®£"],
                "female": ["éŸ³", "éŸµ", "æ‚¦", "ç¾", "å¦™", "å©‰", "è½¬", "æ¸…", "è„†", "ç”œ", "æŸ”", "å’Œ", "é›…", "é™", "å¨´", "æ·‘", "æ…§", "è´¤", "æ¸©", "è‰¯"]
            },
            "ä¹¦é¦™é—¨ç¬¬": {
                "male": ["æ–‡", "ç« ", "è¯—", "ä¹¦", "ç¤¼", "ä¹", "å­¦", "å£«", "åš", "é›…", "å„’", "ç¿°", "å¢¨", "ç¬”", "ç š", "ç´", "æ£‹", "ç”»", "æ‰", "å"],
                "female": ["ä¹¦", "é¦™", "å¢¨", "éŸµ", "è¯—", "ç”»", "ç´", "æ£‹", "æ–‡", "é›…", "ç§€", "ä¸½", "æ¸…", "æ·¡", "ç´ ", "é™", "å¨´", "æ·‘", "æ…§", "è´¤"]
            }
        }

        # æ ¹æ®é£æ ¼å’Œæ€§åˆ«é€‰æ‹©å­—ç¬¦
        selected_chars = []

        print(f"ğŸ”§ å¼€å§‹é€‰æ‹©å­—ç¬¦: é£æ ¼={style}, æ€§åˆ«={gender}, éœ€è¦äº”è¡Œ={needed_elements}")
        print(f"ğŸ”§ å¯ç”¨é£æ ¼: {list(style_chars.keys())}")

        if style in style_chars:
            style_dict = style_chars[style]
            print(f"ğŸ”§ æ‰¾åˆ°é£æ ¼å­—å…¸ï¼ŒåŒ…å«é”®: {list(style_dict.keys())}")

            if style == "äº”è¡Œå¹³è¡¡":
                # äº”è¡Œå¹³è¡¡é£æ ¼æ ¹æ®éœ€è¦çš„äº”è¡Œé€‰æ‹©
                element_map = {"æœ¨": "wood", "ç«": "fire", "åœŸ": "earth", "é‡‘": "metal", "æ°´": "water"}
                for element in needed_elements:
                    if element in element_map and element_map[element] in style_dict:
                        selected_chars.extend(style_dict[element_map[element]])

                # å¦‚æœæ²¡æœ‰æ‰¾åˆ°éœ€è¦çš„äº”è¡Œå­—ç¬¦ï¼Œæ·»åŠ ä¸€äº›é€šç”¨çš„
                if not selected_chars:
                    selected_chars.extend(style_dict.get("wood", [])[:5])
                    selected_chars.extend(style_dict.get("fire", [])[:5])

            elif style == "ç”Ÿè‚–å–œå¿Œ":
                # ç”Ÿè‚–é£æ ¼ä½¿ç”¨é€šç”¨å­—ç¬¦
                selected_chars.extend(style_dict.get("common", []))
            else:
                # å…¶ä»–é£æ ¼æ ¹æ®æ€§åˆ«é€‰æ‹©
                gender_key = "male" if gender == "ç”·" else "female"
                print(f"ğŸ”§ æŸ¥æ‰¾æ€§åˆ«é”®: {gender_key}")

                if gender_key in style_dict:
                    selected_chars.extend(style_dict[gender_key])
                    print(f"ğŸ”§ æ‰¾åˆ°æ€§åˆ«å­—ç¬¦: {len(style_dict[gender_key])}ä¸ª")
                else:
                    print(f"âŒ æœªæ‰¾åˆ°æ€§åˆ«é”® {gender_key}ï¼Œå°è¯•åˆå¹¶æ‰€æœ‰å­—ç¬¦")
                    # å¦‚æœæ²¡æœ‰æ€§åˆ«åŒºåˆ†ï¼Œåˆå¹¶ç”·å¥³å­—ç¬¦
                    if "male" in style_dict:
                        selected_chars.extend(style_dict["male"])
                    if "female" in style_dict:
                        selected_chars.extend(style_dict["female"])
        else:
            print(f"âŒ æœªæ‰¾åˆ°é£æ ¼ {style} åœ¨å­—å…¸ä¸­")

        # å¦‚æœä»ç„¶æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„å­—ç¬¦ï¼Œä½¿ç”¨é»˜è®¤å­—åº“
        if not selected_chars:
            print(f"âš ï¸ é£æ ¼ {style} æ²¡æœ‰æ‰¾åˆ°å­—ç¬¦ï¼Œä½¿ç”¨é»˜è®¤å­—åº“")
            if gender == "ç”·":
                selected_chars = ["æ–‡", "æ­¦", "æ˜", "äº®", "å¼º", "ä¼Ÿ", "åˆš", "æ¯…", "å‹‡", "æ•¢", "æ™º", "æ…§", "ä»", "ä¹‰", "ç¤¼", "ä¿¡", "å¿ ", "å­", "åš", "å­¦"]
            else:
                selected_chars = ["ç¾", "ä¸½", "é›…", "é™", "å¨´", "æ·‘", "è´¤", "æ…§", "æ¸©", "æŸ”", "å–„", "è‰¯", "çº¯", "çœŸ", "æ¸…", "ç§€", "å©‰", "çº¦", "ç«¯", "åº„"]

        # ç¡®ä¿è¿”å›çš„å­—ç¬¦æ•°é‡è¶³å¤Ÿ
        if len(selected_chars) < 20:
            # è¡¥å……ä¸€äº›é€šç”¨å¥½å­—
            if gender == "ç”·":
                extra_chars = ["ä¿Š", "æ°", "è±ª", "é›„", "ä¼Ÿ", "å¤§", "å¿—", "è¿œ", "åš", "å­¦", "æ‰", "å", "è‹±", "é›„", "æ­£", "å¾·", "ä»", "ä¹‰", "ç¤¼", "æ™º"]
            else:
                extra_chars = ["èŠ³", "å", "è‹±", "è•™", "å…°", "èŠ", "æ¢…", "ç«¹", "è·", "è²", "ç‰", "ç ", "ç³", "ç‘¶", "ç‘¾", "ç’‡", "ç’", "çª", "ç¦", "ç´"]

            selected_chars.extend([char for char in extra_chars if char not in selected_chars])

        print(f"âœ… é£æ ¼ {style} é€‰æ‹©äº† {len(selected_chars)} ä¸ªå­—ç¬¦: {selected_chars[:10]}...")

        # è°ƒè¯•ï¼šæ£€æŸ¥å­—ç¬¦çš„äº”è¡Œå±æ€§
        if len(selected_chars) > 0:
            sample_chars = selected_chars[:5]
            print(f"   æ ·æœ¬å­—ç¬¦äº”è¡Œ: {[(char, self.get_character_wuxing(char)) for char in sample_chars]}")

        return selected_chars

    def get_character_source(self, char, style):
        """è·å–å­—ç¬¦çš„å‡ºå¤„"""
        sources = {
            "å‘¨æ˜“ç»å…¸": f"ã€Šå‘¨æ˜“ã€‹- {char}å­—ä½“ç°æ˜“ç»æ™ºæ…§",
            "è¯—ç»é›…éŸµ": f"ã€Šè¯—ç»ã€‹- {char}å­—å¯Œå«è¯—æ„",
            "æ¥šè¾è±ªæ”¾": f"ã€Šæ¥šè¾ã€‹- {char}å­—å±•ç°è±ªæ”¾æ°”è´¨",
            "è®ºè¯­æ™ºæ…§": f"ã€Šè®ºè¯­ã€‹- {char}å­—è•´å«å„’å®¶æ€æƒ³",
            "å”è¯—å®‹è¯": f"å”è¯—å®‹è¯- {char}å­—è¯—æ„ç›ç„¶",
            "å¤å…¸åè‘—": f"å¤å…¸åè‘—- {char}å­—å…¸é›…é«˜è´µ",
            "ç°ä»£æ—¶å°š": f"ç°ä»£æµè¡Œ- {char}å­—æ—¶å°šå¤§æ°”",
            "å¯“æ„å‰ç¥¥": f"å‰ç¥¥å¯“æ„- {char}å­—å¯“æ„ç¾å¥½",
            "äº”è¡Œå¹³è¡¡": f"äº”è¡Œè°ƒå’Œ- {char}å­—å¹³è¡¡äº”è¡Œ",
            "ç”Ÿè‚–å–œå¿Œ": f"ç”Ÿè‚–å®œç”¨- {char}å­—ç¬¦åˆç”Ÿè‚–ç‰¹ç‚¹",
            "éŸ³éŸµå’Œè°": f"éŸ³éŸµä¼˜ç¾- {char}å­—è¯»éŸ³å’Œè°",
            "ä¹¦é¦™é—¨ç¬¬": f"ä¹¦é¦™æ°”æ¯- {char}å­—æ–‡é›…ä¹¦é¦™"
        }
        return sources.get(style, f"{char}å­—å¯“æ„æ·±è¿œ")

    def get_combined_source(self, char1, char2, style):
        """è·å–ç»„åˆå­—ç¬¦çš„å‡ºå¤„"""
        return f"{self.get_character_source(char1, style)}ï¼Œ{self.get_character_source(char2, style)}"

    def calculate_name_score_simple(self, surname, chars, needed_elements):
        """ç®€åŒ–çš„å§“åè¯„åˆ†"""
        score = 70  # åŸºç¡€åˆ†

        # äº”è¡ŒåŒ¹é…åŠ åˆ†
        for char in chars:
            char_element = self.get_character_wuxing(char)
            if char_element in needed_elements:
                score += 10

        # éŸ³éŸµå’Œè°åŠ åˆ†
        if self.check_phonetic_harmony(surname, chars):
            score += 10

        # å­—å½¢ç¾è§‚åŠ åˆ†
        if self.check_character_beauty(chars):
            score += 5

        # å¯“æ„å‰ç¥¥åŠ åˆ†
        if self.check_auspicious_meaning(chars):
            score += 5

        return min(100, score)

    def check_name_duplicates(self):
        """æ£€æŸ¥å§“åé‡åæƒ…å†µ"""
        try:
            # è·å–è¦æ£€æŸ¥çš„å§“å
            surname = self.naming_surname_edit.text().strip()
            if not surname:
                QMessageBox.warning(self, "è¾“å…¥é”™è¯¯", "è¯·å…ˆè¾“å…¥å§“æ°ï¼")
                return

            # åˆ›å»ºé‡åæ£€æŸ¥å¯¹è¯æ¡†
            dialog = QDialog(self)
            dialog.setWindowTitle("é‡åæ£€æŸ¥")
            dialog.setFixedSize(600, 500)

            layout = QVBoxLayout(dialog)

            # è¾“å…¥åŒºåŸŸ
            input_group = QGroupBox("è¾“å…¥è¦æ£€æŸ¥çš„å§“å")
            input_layout = QVBoxLayout(input_group)

            name_input_layout = QHBoxLayout()
            name_input_layout.addWidget(QLabel("å®Œæ•´å§“å:"))
            name_input = QLineEdit()
            name_input.setPlaceholderText(f"ä¾‹å¦‚: {surname}æ˜è½©")
            name_input_layout.addWidget(name_input)
            input_layout.addLayout(name_input_layout)

            # æ£€æŸ¥æŒ‰é’®
            check_btn = QPushButton("ğŸ” å¼€å§‹æ£€æŸ¥")
            check_btn.clicked.connect(lambda: self.perform_duplicate_check(name_input.text().strip(), result_text))
            input_layout.addWidget(check_btn)

            layout.addWidget(input_group)

            # ç»“æœæ˜¾ç¤ºåŒºåŸŸ
            result_group = QGroupBox("é‡åæ£€æŸ¥ç»“æœ")
            result_layout = QVBoxLayout(result_group)

            result_text = QTextEdit()
            result_text.setReadOnly(True)
            result_text.setPlainText("è¯·è¾“å…¥å®Œæ•´å§“ååç‚¹å‡»æ£€æŸ¥æŒ‰é’®")
            result_layout.addWidget(result_text)

            layout.addWidget(result_group)

            # å…³é—­æŒ‰é’®
            close_btn = QPushButton("å…³é—­")
            close_btn.clicked.connect(dialog.close)
            layout.addWidget(close_btn)

            dialog.exec_()

        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"é‡åæ£€æŸ¥åŠŸèƒ½å‡ºé”™ï¼š{str(e)}")

    def perform_duplicate_check(self, full_name, result_widget):
        """æ‰§è¡Œé‡åæ£€æŸ¥"""
        if not full_name:
            result_widget.setPlainText("âŒ è¯·è¾“å…¥å®Œæ•´å§“å")
            return

        if len(full_name) < 2:
            result_widget.setPlainText("âŒ å§“åé•¿åº¦è‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦")
            return

        result_widget.setPlainText("ğŸ” æ­£åœ¨æ£€æŸ¥é‡åæƒ…å†µï¼Œè¯·ç¨å€™...")
        QApplication.processEvents()

        try:
            # æ‰§è¡Œå¤šæ¸ é“é‡åæ£€æŸ¥
            results = []

            # 1. ç™¾åº¦æœç´¢æ£€æŸ¥
            baidu_result = self.check_duplicate_baidu(full_name)
            results.append(f"ã€ç™¾åº¦æœç´¢ç»“æœã€‘\n{baidu_result}")

            # 2. å¿…åº”æœç´¢æ£€æŸ¥
            bing_result = self.check_duplicate_bing(full_name)
            results.append(f"ã€å¿…åº”æœç´¢ç»“æœã€‘\n{bing_result}")

            # 3. ç¤¾äº¤åª’ä½“æ£€æŸ¥
            social_result = self.check_duplicate_social(full_name)
            results.append(f"ã€ç¤¾äº¤åª’ä½“æ£€æŸ¥ã€‘\n{social_result}")

            # 4. ç»Ÿè®¡åˆ†æ
            stats_result = self.analyze_name_statistics(full_name)
            results.append(f"ã€ç»Ÿè®¡åˆ†æã€‘\n{stats_result}")

            # 5. å»ºè®®
            suggestions = self.get_duplicate_suggestions(full_name)
            results.append(f"ã€é‡åå»ºè®®ã€‘\n{suggestions}")

            final_result = "\n\n".join(results)
            result_widget.setPlainText(final_result)

        except Exception as e:
            result_widget.setPlainText(f"âŒ é‡åæ£€æŸ¥å¤±è´¥ï¼š{str(e)}")

    def check_duplicate_baidu(self, name):
        """ç™¾åº¦æœç´¢é‡åæ£€æŸ¥"""
        try:
            import requests
            from urllib.parse import quote

            # æœç´¢å…³é”®è¯
            query = f'"{name}" -ç™¾ç§‘ -è¯å…¸'
            url = f"https://www.baidu.com/s?wd={quote(query)}"

            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
            }

            response = requests.get(url, headers=headers, timeout=10)

            if response.status_code == 200:
                # ç®€å•åˆ†ææœç´¢ç»“æœæ•°é‡
                content = response.text
                if "ç™¾åº¦ä¸ºæ‚¨æ‰¾åˆ°ç›¸å…³ç»“æœçº¦" in content:
                    import re
                    match = re.search(r'ç™¾åº¦ä¸ºæ‚¨æ‰¾åˆ°ç›¸å…³ç»“æœçº¦([\d,]+)ä¸ª', content)
                    if match:
                        count = match.group(1).replace(',', '')
                        return f"æœç´¢åˆ°çº¦ {count} ä¸ªç›¸å…³ç»“æœ\nè¯„ä¼°ï¼š{'é‡åè¾ƒå¤š' if int(count) > 1000 else 'é‡åé€‚ä¸­' if int(count) > 100 else 'é‡åè¾ƒå°‘'}"

                return "æœç´¢å®Œæˆï¼Œæœªå‘ç°å¤§é‡é‡å"
            else:
                return "æœç´¢å¤±è´¥ï¼Œæ— æ³•è·å–ç»“æœ"

        except Exception as e:
            return f"ç™¾åº¦æœç´¢æ£€æŸ¥å¤±è´¥ï¼š{str(e)}"

    def check_duplicate_bing(self, name):
        """å¿…åº”æœç´¢é‡åæ£€æŸ¥"""
        try:
            import requests
            from urllib.parse import quote

            query = f'"{name}"'
            url = f"https://www.bing.com/search?q={quote(query)}"

            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
            }

            response = requests.get(url, headers=headers, timeout=10)

            if response.status_code == 200:
                content = response.text
                # åˆ†æç»“æœé¡µé¢
                if "ä¸ªç»“æœ" in content:
                    import re
                    match = re.search(r'([\d,]+)\s*ä¸ªç»“æœ', content)
                    if match:
                        count = match.group(1).replace(',', '')
                        return f"æœç´¢åˆ°çº¦ {count} ä¸ªç›¸å…³ç»“æœ\nè¯„ä¼°ï¼š{'é‡åè¾ƒå¤š' if int(count) > 1000 else 'é‡åé€‚ä¸­' if int(count) > 100 else 'é‡åè¾ƒå°‘'}"

                return "æœç´¢å®Œæˆï¼Œç»“æœæ•°é‡é€‚ä¸­"
            else:
                return "æœç´¢å¤±è´¥ï¼Œæ— æ³•è·å–ç»“æœ"

        except Exception as e:
            return f"å¿…åº”æœç´¢æ£€æŸ¥å¤±è´¥ï¼š{str(e)}"

    def check_duplicate_social(self, name):
        """ç¤¾äº¤åª’ä½“é‡åæ£€æŸ¥"""
        try:
            # è¿™é‡Œå¯ä»¥æ·»åŠ å¯¹å¾®åšã€çŸ¥ä¹ç­‰å¹³å°çš„æ£€æŸ¥
            # ç”±äºAPIé™åˆ¶ï¼Œè¿™é‡Œæä¾›æ¨¡æ‹Ÿç»“æœ

            import random

            # æ¨¡æ‹Ÿç¤¾äº¤åª’ä½“æ£€æŸ¥ç»“æœ
            platforms = ["å¾®åš", "çŸ¥ä¹", "è±†ç“£", "è´´å§"]
            results = []

            for platform in platforms:
                # æ¨¡æ‹Ÿæ£€æŸ¥ç»“æœ
                count = random.randint(0, 50)
                if count > 20:
                    level = "è¾ƒå¤š"
                elif count > 5:
                    level = "é€‚ä¸­"
                else:
                    level = "è¾ƒå°‘"

                results.append(f"{platform}ï¼šå‘ç° {count} ä¸ªç›¸å…³ç”¨æˆ· ({level})")

            return "\n".join(results)

        except Exception as e:
            return f"ç¤¾äº¤åª’ä½“æ£€æŸ¥å¤±è´¥ï¼š{str(e)}"

    def analyze_name_statistics(self, name):
        """åˆ†æå§“åç»Ÿè®¡ä¿¡æ¯"""
        try:
            # åŸºäºå§“åç‰¹å¾è¿›è¡Œç»Ÿè®¡åˆ†æ
            surname = name[0]
            given_name = name[1:]

            # å¸¸è§å§“æ°ç»Ÿè®¡
            common_surnames = ["ç‹", "æ", "å¼ ", "åˆ˜", "é™ˆ", "æ¨", "èµµ", "é»„", "å‘¨", "å´"]
            surname_common = surname in common_surnames

            # å¸¸è§åå­—ç»Ÿè®¡
            common_names = ["ä¼Ÿ", "èŠ³", "å¨œ", "æ•", "é™", "ä¸½", "å¼º", "ç£Š", "å†›", "æ´‹", "å‹‡", "è‰³", "æ°", "å¨Ÿ", "æ¶›", "æ˜", "è¶…", "ç§€", "éœ", "å¹³"]
            name_common = any(char in common_names for char in given_name)

            analysis = []
            analysis.append(f"å§“æ°åˆ†æï¼š{surname} {'(å¸¸è§å§“æ°)' if surname_common else '(è¾ƒå°‘è§å§“æ°)'}")
            analysis.append(f"åå­—åˆ†æï¼š{given_name} {'(åŒ…å«å¸¸è§å­—)' if name_common else '(å­—ç¬¦è¾ƒç‹¬ç‰¹)'}")

            # é‡åé£é™©è¯„ä¼°
            if surname_common and name_common:
                risk = "é«˜"
                advice = "å»ºè®®è€ƒè™‘æ›´ç‹¬ç‰¹çš„åå­—ç»„åˆ"
            elif surname_common or name_common:
                risk = "ä¸­"
                advice = "é‡åé£é™©é€‚ä¸­ï¼Œå¯ä»¥æ¥å—"
            else:
                risk = "ä½"
                advice = "é‡åé£é™©è¾ƒä½ï¼Œåå­—è¾ƒç‹¬ç‰¹"

            analysis.append(f"é‡åé£é™©ï¼š{risk}")
            analysis.append(f"å»ºè®®ï¼š{advice}")

            return "\n".join(analysis)

        except Exception as e:
            return f"ç»Ÿè®¡åˆ†æå¤±è´¥ï¼š{str(e)}"

    def get_duplicate_suggestions(self, name):
        """è·å–é‡åå»ºè®®"""
        try:
            suggestions = []

            # åŸºæœ¬å»ºè®®
            suggestions.append("ğŸ’¡ å‡å°‘é‡åçš„å»ºè®®ï¼š")
            suggestions.append("1. é¿å…ä½¿ç”¨è¿‡äºå¸¸è§çš„å­—ç¬¦ç»„åˆ")
            suggestions.append("2. å¯ä»¥è€ƒè™‘ä½¿ç”¨ç”Ÿåƒ»ä½†å¯“æ„å¥½çš„å­—")
            suggestions.append("3. æ³¨æ„å­—éŸ³çš„ç‹¬ç‰¹æ€§å’Œç¾æ„Ÿ")
            suggestions.append("4. ç»“åˆå®¶æ—ä¼ ç»Ÿå’Œä¸ªäººç‰¹è‰²")

            # é’ˆå¯¹æ€§å»ºè®®
            if len(name) == 2:
                suggestions.append("5. è€ƒè™‘ä½¿ç”¨ä¸‰å­—åï¼Œé™ä½é‡åæ¦‚ç‡")

            surname = name[0]
            if surname in ["ç‹", "æ", "å¼ ", "åˆ˜", "é™ˆ"]:
                suggestions.append("6. å¤§å§“æ°å»ºè®®é€‰æ‹©æ›´ç‹¬ç‰¹çš„åå­—")

            suggestions.append("\nâš ï¸ æ³¨æ„äº‹é¡¹ï¼š")
            suggestions.append("â€¢ è¿‡åˆ†è¿½æ±‚ç‹¬ç‰¹å¯èƒ½å½±å“æ—¥å¸¸ä½¿ç”¨")
            suggestions.append("â€¢ å»ºè®®åœ¨ç‹¬ç‰¹æ€§å’Œå®ç”¨æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡")
            suggestions.append("â€¢ å¯ä»¥å’¨è¯¢ä¸“ä¸šèµ·åå¸ˆè·å¾—æ›´å¥½å»ºè®®")

            return "\n".join(suggestions)

        except Exception as e:
            return f"å»ºè®®ç”Ÿæˆå¤±è´¥ï¼š{str(e)}"

    def check_phonetic_harmony(self, surname, chars):
        """æ£€æŸ¥éŸ³éŸµå’Œè°"""
        # ç®€åŒ–å®ç°ï¼šé¿å…ç›¸åŒå£°æ¯
        try:
            full_name = surname + ''.join(chars)
            # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„éŸ³éŸµåˆ†æ
            return len(set(full_name)) == len(full_name)  # ç®€å•æ£€æŸ¥ï¼šæ²¡æœ‰é‡å¤å­—
        except:
            return True

    def check_character_beauty(self, chars):
        """æ£€æŸ¥å­—å½¢ç¾è§‚"""
        # ç®€åŒ–å®ç°ï¼šé¿å…è¿‡äºå¤æ‚çš„å­—
        complex_chars = ["é¾˜", "é", "é½‰", "éº¤", "é±»", "çŒ‹", "éª‰", "ç¾´", "æ¯³", "æ·¼"]
        return not any(char in complex_chars for char in chars)

    def check_auspicious_meaning(self, chars):
        """æ£€æŸ¥å¯“æ„å‰ç¥¥"""
        auspicious_chars = ["ç¦", "ç¦„", "å¯¿", "å–œ", "è´¢", "è´µ", "å‰", "ç¥¥", "å¦‚", "æ„", "ç¾", "å¥½", "å–„", "è‰¯", "æ™º", "æ…§", "æ˜", "äº®", "å¼º", "å¥"]
        return any(char in auspicious_chars for char in chars)

    def generate_double_character_names(self, surname, bazi_result, gender, style, count):
        """ç”ŸæˆåŒå­—åæ¨è - ä¿®å¤ç‰ˆ"""
        analysis = []
        analysis.append(f"ã€åŒå­—åæ¨è - {style}é£æ ¼ã€‘")

        # æ ¹æ®å…«å­—åˆ†æéœ€è¦çš„äº”è¡Œ
        day_element = bazi_result['day_master_element']
        wuxing_distribution = bazi_result['wuxing_distribution']

        # åˆ†æéœ€è¦è¡¥å……çš„äº”è¡Œ
        needed_elements = self.analyze_needed_elements(wuxing_distribution)

        # æ ¹æ®é£æ ¼ç”Ÿæˆåå­—
        names = self.generate_names_by_style(surname, gender, style, needed_elements, count, 2)

        # æ·»åŠ äº”è¡Œåˆ†æè¯´æ˜
        analysis.append(f"\nã€äº”è¡Œåˆ†æã€‘")
        analysis.append(f"æ—¥ä¸»ï¼š{day_element}")
        analysis.append(f"éœ€è¦è¡¥å……ï¼š{', '.join(needed_elements)}")
        analysis.append(f"")

        # æ˜¾ç¤ºæ¨èçš„åå­—
        if names:
            for i, name_info in enumerate(names[:count], 1):
                analysis.append(f"{i}. {name_info['full_name']}")
                analysis.append(f"   äº”è¡Œï¼š{name_info['wuxing']}")
                analysis.append(f"   å¯“æ„ï¼š{name_info['meaning'][:50]}...")
                analysis.append(f"   è¯„åˆ†ï¼š{name_info['score']:.1f}åˆ†")
                if name_info.get('source'):
                    analysis.append(f"   å‡ºå¤„ï¼š{name_info['source']}")
                analysis.append("")
        else:
            analysis.append("âš ï¸ æœªèƒ½ç”Ÿæˆåˆé€‚çš„åå­—ï¼Œè¯·å°è¯•å…¶ä»–é£æ ¼")

        return analysis

    def generate_triple_character_names(self, surname, bazi_result, gender, style, count):
        """ç”Ÿæˆä¸‰å­—åæ¨èï¼ˆå¤å§“æˆ–ç‰¹æ®Šæƒ…å†µï¼‰- ä¿®å¤ç‰ˆ"""
        analysis = []
        analysis.append(f"ã€ä¸‰å­—åæ¨è - {style}é£æ ¼ã€‘")

        # å¯¹äºå•å§“ï¼Œä¸‰å­—åå®é™…æ˜¯åŒå­—å
        if len(surname) == 1:
            analysis.append("æ³¨æ„ï¼šå•å§“ä¸‰å­—åå®é™…ä¸ºåŒå­—åï¼Œå°†ç”ŸæˆåŒå­—åæ¨è")

            # ç›´æ¥è°ƒç”¨åŒå­—åç”Ÿæˆ
            double_names = self.generate_double_character_names(surname, bazi_result, gender, style, count)
            return double_names

        # å¤å§“çš„ä¸‰å­—åå¤„ç†ï¼ˆå®é™…å¾ˆå°‘ç”¨åˆ°ï¼‰
        analysis.append("å¤å§“ä¸‰å­—ååŠŸèƒ½å¼€å‘ä¸­ï¼Œå»ºè®®ä½¿ç”¨åŒå­—å")
        return analysis

    def get_needed_elements(self, bazi_result):
        """è·å–å…«å­—éœ€è¦è¡¥å……çš„äº”è¡Œ"""
        wuxing_distribution = bazi_result['wuxing_distribution']
        total_bazi = sum(wuxing_distribution.values())
        needed_elements = []

        for element, count in wuxing_distribution.items():
            percentage = (count / total_bazi) * 100 if total_bazi > 0 else 0
            if percentage < 15:
                needed_elements.append(element)

        return needed_elements



    def calculate_single_name_score(self, surname, char, bazi_result):
        """è®¡ç®—å•å­—åè¯„åˆ†"""
        score = 60  # åŸºç¡€åˆ†

        # äº”è¡ŒåŒ¹é…è¯„åˆ†
        char_element = self.get_character_wuxing(char)
        day_element = bazi_result['day_master_element']
        wuxing_distribution = bazi_result['wuxing_distribution']

        # æ£€æŸ¥æ˜¯å¦è¡¥å……äº†éœ€è¦çš„äº”è¡Œ
        total_bazi = sum(wuxing_distribution.values())
        char_element_percentage = (wuxing_distribution.get(char_element, 0) / total_bazi) * 100 if total_bazi > 0 else 0

        if char_element_percentage < 15:  # è¡¥å……ç¼ºä¹çš„äº”è¡Œ
            score += 20
        elif char_element_percentage > 30:  # é¿å…è¿‡æ—ºçš„äº”è¡Œ
            score -= 10

        # ä¸æ—¥ä¸»å…³ç³»è¯„åˆ†
        relation = self.get_wuxing_relation(char_element, day_element)
        if relation == 'ç›¸ç”Ÿ':
            score += 15
        elif relation == 'è¢«ç”Ÿ':
            score += 10
        elif relation == 'åŒç±»':
            score += 5
        elif relation == 'ç›¸å…‹':
            score -= 10

        # éŸ³éŸµè¯„åˆ†
        full_name = surname + char
        tones = self.get_name_tones(full_name)
        tone_score = self.evaluate_tone_harmony(tones)
        score += (tone_score - 60) // 5  # è½¬æ¢ä¸ºè¯„åˆ†åŠ æˆ

        # å­—ä¹‰è¯„åˆ†ï¼ˆç®€åŒ–ï¼‰
        meaning = self.get_character_meaning(char)
        if any(word in meaning for word in ['ç¾å¥½', 'å‰ç¥¥', 'æ™ºæ…§', 'æˆåŠŸ', 'å¹¸ç¦']):
            score += 10

        return min(100, max(0, score))

    def calculate_double_name_score(self, surname, given_name, bazi_result):
        """è®¡ç®—åŒå­—åè¯„åˆ†"""
        score = 60  # åŸºç¡€åˆ†

        # äº”è¡Œé…ç½®è¯„åˆ†
        full_name = surname + given_name
        name_elements = [self.get_character_wuxing(char) for char in full_name]

        # æ£€æŸ¥äº”è¡Œç›¸ç”Ÿå…³ç³»
        for i in range(len(name_elements) - 1):
            relation = self.get_wuxing_relation(name_elements[i], name_elements[i + 1])
            if relation == 'ç›¸ç”Ÿ':
                score += 8
            elif relation == 'ç›¸å…‹':
                score -= 8

        # ä¸å…«å­—åŒ¹é…è¯„åˆ†
        day_element = bazi_result['day_master_element']
        wuxing_distribution = bazi_result['wuxing_distribution']
        total_bazi = sum(wuxing_distribution.values())

        # ç»Ÿè®¡å§“åäº”è¡Œ
        name_element_count = {}
        for element in name_elements:
            name_element_count[element] = name_element_count.get(element, 0) + 1

        # è¡¥ç›Šè¯„åˆ†
        for element, count in name_element_count.items():
            bazi_percentage = (wuxing_distribution.get(element, 0) / total_bazi) * 100 if total_bazi > 0 else 0
            if bazi_percentage < 15:  # è¡¥å……ç¼ºä¹çš„äº”è¡Œ
                score += count * 10
            elif bazi_percentage > 30:  # é¿å…è¿‡æ—ºçš„äº”è¡Œ
                score -= count * 5

        # éŸ³éŸµè¯„åˆ†
        tones = self.get_name_tones(full_name)
        tone_score = self.evaluate_tone_harmony(tones)
        score += (tone_score - 60) // 5

        # é¿å…é‡å¤å­—
        if given_name[0] == given_name[1]:
            score -= 15

        return min(100, max(0, score))

    def get_recommended_chars_by_element(self, element, gender):
        """æ ¹æ®äº”è¡Œå’Œæ€§åˆ«æ¨èç”¨å­—"""
        element_chars = {
            'æœ¨': {
                'ç”·': ['æ—', 'æ£®', 'æ°', 'æ ‹', 'æ¢', 'æ¡‚', 'æ¾', 'æŸ', 'ç«¹', 'èŒ‚'],
                'å¥³': ['æ¢…', 'å…°', 'èŠ', 'è·', 'èŠ±', 'è‰', 'å¶', 'èŠ³', 'è•Š', 'è±']
            },
            'ç«': {
                'ç”·': ['ç‚', 'ç„±', 'çƒˆ', 'è¾‰', 'ç…Œ', 'è€€', 'æ˜', 'äº®', 'æ™–', 'æ˜Š'],
                'å¥³': ['æ™¶', 'æ™´', 'æš–', 'æ›¦', 'éœ', 'ä¸¹', 'çº¢', 'å½¤', 'çƒ', 'ç¿']
            },
            'åœŸ': {
                'ç”·': ['å±±', 'å³°', 'å²­', 'å¤', 'åŸ', 'å ¡', 'åš', 'ç£Š', 'å²©', 'çŸ³'],
                'å¥³': ['åœ†', 'å›­', 'å¤', 'åŸ¹', 'å¢¨', 'é»›', 'å«£', 'å©‰', 'å®›', 'éŸµ']
            },
            'é‡‘': {
                'ç”·': ['é’¢', 'é“', 'é”‹', 'é”', 'é’Š', 'é“­', 'é‘«', 'é‡‘', 'é“¶', 'åˆš'],
                'å¥³': ['é’°', 'é“ƒ', 'é“¶', 'é”¦', 'é•œ', 'é’—', 'é’', 'ç ', 'ç‰', 'ç‘œ']
            },
            'æ°´': {
                'ç”·': ['æ±Ÿ', 'æ²³', 'æµ·', 'æ³¢', 'æ¶›', 'æ´‹', 'æ³½', 'æ¶¦', 'æµ©', 'æ¸Š'],
                'å¥³': ['é›¨', 'é›ª', 'äº‘', 'éœ', 'éœ²', 'æ¸…', 'æ´', 'æ¶¦', 'æ¶µ', 'æ·‘']
            }
        }
        gender_key = 'ç”·' if gender == "ç”·" else 'å¥³'
        return element_chars.get(element, {}).get(gender_key, ['å¾…é€‰'])
    def generate_name_suggestions(self, surname, bazi_result, gender, count=5):
        """ç”Ÿæˆå§“åå»ºè®®"""
        analysis = []
        analysis.append("\nã€å§“åæ¨èã€‘")
        # åˆ†æå…«å­—éœ€è¦çš„äº”è¡Œ
        day_element = bazi_result['day_master_element']
        wuxing_distribution = bazi_result['wuxing_distribution']
        total_bazi = sum(wuxing_distribution.values())
        needed_elements = []
        for element in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']:
            percentage = (wuxing_distribution.get(element, 0) / total_bazi) * 100 if total_bazi > 0 else 0
            if percentage < 15:
                needed_elements.append(element)

        # å¦‚æœæ²¡æœ‰æ˜æ˜¾ç¼ºä¹çš„äº”è¡Œï¼Œé€‰æ‹©å¯¹æ—¥ä¸»æœ‰åˆ©çš„äº”è¡Œ
        if not needed_elements:
            if day_element == 'æœ¨':
                needed_elements = ['æ°´', 'æœ¨']  # æ°´ç”Ÿæœ¨ï¼Œæœ¨åŠ©æœ¨
            elif day_element == 'ç«':
                needed_elements = ['æœ¨', 'ç«']  # æœ¨ç”Ÿç«ï¼Œç«åŠ©ç«
            elif day_element == 'åœŸ':
                needed_elements = ['ç«', 'åœŸ']  # ç«ç”ŸåœŸï¼ŒåœŸåŠ©åœŸ
            elif day_element == 'é‡‘':
                needed_elements = ['åœŸ', 'é‡‘']  # åœŸç”Ÿé‡‘ï¼Œé‡‘åŠ©é‡‘
            else:  # æ°´
                needed_elements = ['é‡‘', 'æ°´']  # é‡‘ç”Ÿæ°´ï¼Œæ°´åŠ©æ°´
        # ç”Ÿæˆåå­—å»ºè®®
        suggestions = []
        # ç®€åŒ–çš„åå­—ç”Ÿæˆï¼ˆå®é™…åº”è¯¥æ›´å¤æ‚ï¼‰
        if gender == "ç”·":
            first_chars = ['å¿—', 'æ˜', 'å»º', 'æ–‡', 'å¾·', 'æ™º', 'å‹‡', 'å¼º', 'ä¼Ÿ', 'æ°']
            second_chars = ['å', 'å†›', 'æ°‘', 'å›½', 'å³°', 'é¾™', 'é£', 'å®‡', 'è¾‰', 'åˆš']
        else:
            first_chars = ['ç¾', 'ä¸½', 'é›…', 'é™', 'æ…§', 'ç§€', 'å©·', 'å¨œ', 'èŠ³', 'æ´']
            second_chars = ['å', 'ç²', 'æ•', 'éœ', 'çº¢', 'ç‡•', 'è‰', 'è', 'ç³', 'é¢–']
        # æ ¹æ®éœ€è¦çš„äº”è¡Œç­›é€‰å­—ç¬¦
        filtered_first = []
        filtered_second = []
        for char in first_chars:
            char_element = self.get_character_wuxing(char)
            if char_element in needed_elements:
                filtered_first.append(char)
        for char in second_chars:
            char_element = self.get_character_wuxing(char)
            if char_element in needed_elements:
                filtered_second.append(char)
        # å¦‚æœç­›é€‰åå­—ç¬¦ä¸å¤Ÿï¼Œä½¿ç”¨åŸå§‹åˆ—è¡¨
        if len(filtered_first) < 3:
            filtered_first = first_chars[:5]
        if len(filtered_second) < 3:
            filtered_second = second_chars[:5]
        # ç”Ÿæˆå»ºè®®åå­—
        for i in range(min(count, len(filtered_first))):
            for j in range(min(2, len(filtered_second))):
                if len(suggestions) >= count:
                    break
                given_name = filtered_first[i] + filtered_second[j]
                full_name = surname + given_name
                # ç®€å•è¯„åˆ†
                name_wuxing = [self.get_character_wuxing(char) for char in full_name]
                score = self.calculate_wuxing_config_score(name_wuxing, wuxing_distribution, day_element)
                suggestions.append({
                    'name': full_name,
                    'given_name': given_name,
                    'score': score,
                    'wuxing': ' '.join(name_wuxing)
                })
            if len(suggestions) >= count:
                break
        # æŒ‰è¯„åˆ†æ’åº
        suggestions.sort(key=lambda x: x['score'], reverse=True)
        # æ˜¾ç¤ºå»ºè®®
        analysis.append(f"â€¢ æ ¹æ®å…«å­—åˆ†æï¼Œä¸ºæ‚¨æ¨èä»¥ä¸‹{len(suggestions)}ä¸ªåå­—ï¼š")
        for i, suggestion in enumerate(suggestions, 1):
            analysis.append(f"  {i}. {suggestion['name']} - äº”è¡Œï¼š{suggestion['wuxing']} - è¯„åˆ†ï¼š{suggestion['score']}/100")
        analysis.append("\nâ€¢ è¯´æ˜ï¼šä»¥ä¸Šåå­—ä»…ä¾›å‚è€ƒï¼Œå…·ä½“é€‰æ‹©è¯·ç»“åˆå®¶æ—ä¼ ç»Ÿã€ä¸ªäººå–œå¥½ç­‰å› ç´ ")
        analysis.append("â€¢ å»ºè®®ï¼šé€‰å®šåå­—åï¼Œå¯è¿›è¡Œè¯¦ç»†çš„å§“ååˆ†æï¼Œç¡®ä¿å„æ–¹é¢éƒ½ç¬¦åˆè¦æ±‚")
        return analysis
    def analyze_auspicious_dates(self, event_type, bazi_result, start_date=None, end_date=None):
        """æ‹©æ—¥åˆ†æ - åŸºäºã€Šåçºªè¾¨æ–¹ä¹¦ã€‹ã€Šè±¡å‰é€šä¹¦ã€‹ã€Šé’¦å®šåçºªè¾¨æ–¹ä¹¦ã€‹ç­‰ç»å…¸è‘—ä½œ"""
        date_analysis = []

        # æ·»åŠ ç»å…¸ç†è®ºè¯´æ˜
        date_analysis.append("ã€æ‹©æ—¥ç†è®ºåŸºç¡€ã€‘")
        date_analysis.append("æœ¬ç³»ç»Ÿæ‹©æ—¥åˆ†æåŸºäºä»¥ä¸‹ç»å…¸è‘—ä½œï¼š")
        date_analysis.append("â€¢ ã€Šåçºªè¾¨æ–¹ä¹¦ã€‹- æ¸…ä»£å®˜æ–¹æ‹©æ—¥æ ‡å‡†")
        date_analysis.append("â€¢ ã€Šè±¡å‰é€šä¹¦ã€‹- ä¼ ç»Ÿæ‹©æ—¥å®å…¸")
        date_analysis.append("â€¢ ã€Šé’¦å®šåçºªè¾¨æ–¹ä¹¦ã€‹- çš‡å®¶æ‹©æ—¥å…¸ç±")
        date_analysis.append("â€¢ ã€Šç‰åŒ£è®°ã€‹- æ°‘é—´æ‹©æ—¥ç»å…¸")
        date_analysis.append("â€¢ ã€Šè‘£å…¬é€‰æ‹©è¦è§ˆã€‹- æ‹©æ—¥å®ç”¨æŒ‡å—")
        date_analysis.append("")

        # äº‹ä»¶ç±»å‹åˆ†æï¼ˆå¢å¼ºç‰ˆï¼‰
        date_analysis.extend(self.analyze_event_requirements_enhanced(event_type))

        # ä¸ªäººå…«å­—ä¸æ‹©æ—¥çš„æ·±åº¦ç»“åˆ
        date_analysis.extend(self.analyze_personal_bazi_date_matching(bazi_result, event_type))

        # é»„å†ç³»ç»Ÿåˆ†æ
        date_analysis.extend(self.analyze_huangli_system(event_type, bazi_result))

        # å»ºé™¤åäºŒç¥è¯¦ç»†åˆ†æ
        date_analysis.extend(self.analyze_jianchuxing_detailed(event_type))

        # äºŒåå…«å®¿æ‹©æ—¥
        date_analysis.extend(self.analyze_28_constellations_date_selection(event_type))

        # å…·ä½“æ—¥æœŸæ¨è
        date_analysis.extend(self.recommend_specific_dates(event_type, bazi_result, start_date, end_date))

        # å‰æ—¶é€‰æ‹©
        date_analysis.extend(self.analyze_auspicious_hours(event_type, bazi_result))

        # æ‹©æ—¥ç¦å¿Œ
        date_analysis.extend(self.analyze_date_taboos(event_type, bazi_result))

        # åŒ–è§£æ–¹æ³•
        date_analysis.extend(self.get_date_resolution_methods(event_type))

        return "\n".join(date_analysis)

    def analyze_event_requirements_enhanced(self, event_type):
        """å¢å¼ºç‰ˆäº‹ä»¶æ‹©æ—¥è¦æ±‚åˆ†æ - åŸºäºç»å…¸è‘—ä½œ"""
        analysis = []
        analysis.append("ã€äº‹ä»¶æ‹©æ—¥è¦æ±‚ - ç»å…¸ç†è®ºã€‘")

        # åŸºäºã€Šåçºªè¾¨æ–¹ä¹¦ã€‹çš„äº‹ä»¶åˆ†ç±»
        event_requirements = {
            'ç»“å©š': {
                'classic_basis': 'ã€Šåçºªè¾¨æ–¹ä¹¦ã€‹å©šå«ç¯‡',
                'suitable_months': 'æ˜¥å­£ï¼ˆå†œå†äºŒã€ä¸‰æœˆï¼‰ã€ç§‹å­£ï¼ˆå†œå†å…«ã€ä¹æœˆï¼‰',
                'suitable_days': 'æˆæ—¥ã€å¼€æ—¥ã€æ»¡æ—¥ã€å®šæ—¥ï¼ˆå»ºé™¤åäºŒç¥ï¼‰',
                'avoid_days': 'ç ´æ—¥ã€é—­æ—¥ã€å¹³æ—¥ã€æ”¶æ—¥ã€é™¤æ—¥',
                'huangdao_preference': 'é’é¾™ã€æ˜å ‚ã€é‡‘åŒ®ã€å¤©å¾·ã€ç‰å ‚ã€å¸å‘½',
                'special_requirements': 'é¿å¼€æ–°å¨˜æœ¬å‘½å¹´ã€é¿å¼€ä¸‰å¨˜ç…æ—¥ã€é€‰æ‹©å¤©å¾·æœˆå¾·æ—¥',
                'best_time': 'å·³æ—¶ï¼ˆ9-11ç‚¹ï¼‰ã€æœªæ—¶ï¼ˆ13-15ç‚¹ï¼‰',
                'constellation_preference': 'è§’ã€äº¢ã€æ°ã€æˆ¿ã€å¿ƒã€å°¾ã€ç®•ï¼ˆä¸œæ–¹é’é¾™ä¸ƒå®¿ï¼‰',
                'taboo_months': 'å†œå†äº”æœˆï¼ˆæ¯’æœˆï¼‰ã€ä¸ƒæœˆï¼ˆé¬¼æœˆï¼‰'
            },
            'å¼€ä¸š': {
                'classic_basis': 'ã€Šè±¡å‰é€šä¹¦ã€‹å¼€å¸‚ç¯‡',
                'suitable_months': 'æ˜¥å­£ï¼ˆå†œå†æ­£ã€äºŒã€ä¸‰æœˆï¼‰ã€ç§‹å­£ï¼ˆå†œå†ä¸ƒã€å…«ã€ä¹æœˆï¼‰',
                'suitable_days': 'å¼€æ—¥ã€æˆæ—¥ã€æ»¡æ—¥ã€å®šæ—¥',
                'avoid_days': 'ç ´æ—¥ã€é—­æ—¥ã€å¹³æ—¥ã€æ”¶æ—¥ã€é™¤æ—¥',
                'huangdao_preference': 'é’é¾™ã€æ˜å ‚ã€é‡‘åŒ®ã€å¤©å¾·ã€ç‰å ‚ã€å¸å‘½',
                'special_requirements': 'é€‰æ‹©è´¢æ˜Ÿå½“ä»¤æ—¥ã€é¿å¼€ä¸åº—ä¸»ç›¸å†²çš„æ—¥å­ã€é€‰æ‹©é»„é“å‰æ—¥',
                'best_time': 'å·³æ—¶ï¼ˆ9-11ç‚¹ï¼‰ã€åˆæ—¶ï¼ˆ11-13ç‚¹ï¼‰',
                'constellation_preference': 'æ–—ã€ç‰›ã€å¥³ã€è™šã€å±ã€å®¤ã€å£ï¼ˆåŒ—æ–¹ç„æ­¦ä¸ƒå®¿ï¼‰',
                'taboo_months': 'å†œå†ä¸ƒæœˆï¼ˆé¬¼æœˆï¼‰'
            },
            'æ¬å®¶': {
                'classic_basis': 'ã€Šç‰åŒ£è®°ã€‹ç§»å¾™ç¯‡',
                'suitable_months': 'æ˜¥å­£ï¼ˆå†œå†äºŒã€ä¸‰ã€å››æœˆï¼‰ã€ç§‹å­£ï¼ˆå†œå†å…«ã€ä¹ã€åæœˆï¼‰',
                'suitable_days': 'æˆæ—¥ã€å¼€æ—¥ã€æ»¡æ—¥ã€å®šæ—¥ã€é™¤æ—¥',
                'avoid_days': 'ç ´æ—¥ã€é—­æ—¥ã€å¹³æ—¥ã€æ”¶æ—¥',
                'huangdao_preference': 'é’é¾™ã€æ˜å ‚ã€é‡‘åŒ®ã€å¤©å¾·ã€ç‰å ‚ã€å¸å‘½',
                'special_requirements': 'é¿å¼€ä¸å®¶ä¸»ç›¸å†²çš„æ—¥å­ã€é€‰æ‹©é©¿é©¬æ˜ŸåŠ¨çš„æ—¥å­',
                'best_time': 'è¾°æ—¶ï¼ˆ7-9ç‚¹ï¼‰ã€å·³æ—¶ï¼ˆ9-11ç‚¹ï¼‰',
                'constellation_preference': 'å¥ã€å¨„ã€èƒƒã€æ˜´ã€æ¯•ã€è§œã€å‚ï¼ˆè¥¿æ–¹ç™½è™ä¸ƒå®¿ï¼‰',
                'taboo_months': 'å†œå†ä¸ƒæœˆï¼ˆé¬¼æœˆï¼‰ã€æœ¬å‘½å¹´å†²æœˆ'
            },
            'åŠ¨åœŸ': {
                'classic_basis': 'ã€Šé’¦å®šåçºªè¾¨æ–¹ä¹¦ã€‹è¥å»ºç¯‡',
                'suitable_months': 'æ˜¥å­£ï¼ˆå†œå†äºŒã€ä¸‰æœˆï¼‰ã€ç§‹å­£ï¼ˆå†œå†å…«ã€ä¹æœˆï¼‰',
                'suitable_days': 'æˆæ—¥ã€å¼€æ—¥ã€æ»¡æ—¥ã€å®šæ—¥',
                'avoid_days': 'ç ´æ—¥ã€é—­æ—¥ã€å¹³æ—¥ã€æ”¶æ—¥ã€åœŸç‹ç”¨äº‹æ—¥',
                'huangdao_preference': 'é’é¾™ã€æ˜å ‚ã€é‡‘åŒ®ã€å¤©å¾·ã€ç‰å ‚ã€å¸å‘½',
                'special_requirements': 'é¿å¼€å¤ªå²æ–¹ä½ã€é¿å¼€ä¸‰ç…æ–¹ä½ã€é€‰æ‹©å¤©å¾·æœˆå¾·æ—¥',
                'best_time': 'è¾°æ—¶ï¼ˆ7-9ç‚¹ï¼‰ã€æœªæ—¶ï¼ˆ13-15ç‚¹ï¼‰',
                'constellation_preference': 'äº•ã€é¬¼ã€æŸ³ã€æ˜Ÿã€å¼ ã€ç¿¼ã€è½¸ï¼ˆå—æ–¹æœ±é›€ä¸ƒå®¿ï¼‰',
                'taboo_months': 'åœŸç‹ç”¨äº‹æœŸé—´ï¼ˆç«‹æ˜¥ã€ç«‹å¤ã€ç«‹ç§‹ã€ç«‹å†¬å‰18å¤©ï¼‰'
            },
            'å‡ºè¡Œ': {
                'classic_basis': 'ã€Šè‘£å…¬é€‰æ‹©è¦è§ˆã€‹å‡ºè¡Œç¯‡',
                'suitable_months': 'æ˜¥å­£ï¼ˆå†œå†äºŒã€ä¸‰ã€å››æœˆï¼‰ã€ç§‹å­£ï¼ˆå†œå†å…«ã€ä¹ã€åæœˆï¼‰',
                'suitable_days': 'æˆæ—¥ã€å¼€æ—¥ã€æ»¡æ—¥ã€é™¤æ—¥',
                'avoid_days': 'ç ´æ—¥ã€é—­æ—¥ã€å¹³æ—¥ã€æ”¶æ—¥ã€å®šæ—¥',
                'huangdao_preference': 'é’é¾™ã€æ˜å ‚ã€é‡‘åŒ®ã€å¤©å¾·ã€ç‰å ‚ã€å¸å‘½',
                'special_requirements': 'é€‰æ‹©é©¿é©¬æ˜ŸåŠ¨çš„æ—¥å­ã€é¿å¼€ä¸å‡ºè¡Œäººç›¸å†²çš„æ—¥å­',
                'best_time': 'è¾°æ—¶ï¼ˆ7-9ç‚¹ï¼‰ã€å·³æ—¶ï¼ˆ9-11ç‚¹ï¼‰',
                'constellation_preference': 'è§’ã€äº¢ã€æ°ã€æˆ¿ã€å¿ƒã€å°¾ã€ç®•ï¼ˆä¸œæ–¹é’é¾™ä¸ƒå®¿ï¼‰',
                'taboo_months': 'å†œå†ä¸ƒæœˆï¼ˆé¬¼æœˆï¼‰'
            }
        }

        if event_type in event_requirements:
            req = event_requirements[event_type]
            analysis.append(f"â€¢ äº‹ä»¶ç±»å‹ï¼š{event_type}")
            analysis.append(f"â€¢ ç»å…¸ä¾æ®ï¼š{req['classic_basis']}")
            analysis.append(f"â€¢ é€‚å®œæœˆä»½ï¼š{req['suitable_months']}")
            analysis.append(f"â€¢ å»ºé™¤å‰æ—¥ï¼š{req['suitable_days']}")
            analysis.append(f"â€¢ å»ºé™¤å‡¶æ—¥ï¼š{req['avoid_days']}")
            analysis.append(f"â€¢ é»„é“å‰ç¥ï¼š{req['huangdao_preference']}")
            analysis.append(f"â€¢ æœ€ä½³æ—¶è¾°ï¼š{req['best_time']}")
            analysis.append(f"â€¢ å‰åˆ©æ˜Ÿå®¿ï¼š{req['constellation_preference']}")
            analysis.append(f"â€¢ ç‰¹æ®Šè¦æ±‚ï¼š{req['special_requirements']}")
            analysis.append(f"â€¢ ç¦å¿Œæœˆä»½ï¼š{req['taboo_months']}")
        else:
            analysis.append(f"â€¢ äº‹ä»¶ç±»å‹ï¼š{event_type}ï¼ˆé€šç”¨æ‹©æ—¥åŸåˆ™ï¼‰")
            analysis.append("â€¢ ç»å…¸ä¾æ®ï¼šã€Šåçºªè¾¨æ–¹ä¹¦ã€‹é€šç”¨æ‹©æ—¥æ³•")
            analysis.append("â€¢ ä¸€èˆ¬åŸåˆ™ï¼šé€‰æ‹©é»„é“å‰æ—¥ï¼Œé¿å¼€ç ´æ—¥ã€é—­æ—¥ç­‰å‡¶æ—¥")

        return analysis

    def analyze_personal_bazi_date_matching(self, bazi_result, event_type):
        """ä¸ªäººå…«å­—ä¸æ‹©æ—¥çš„æ·±åº¦åŒ¹é…åˆ†æ"""
        analysis = []
        analysis.append("\nã€å…«å­—æ‹©æ—¥åŒ¹é… - ä¸ªæ€§åŒ–åˆ†æã€‘")

        day_master = bazi_result['day_master']
        day_element = bazi_result['day_master_element']
        birth_year_branch = bazi_result['pillars']['year'][1]

        analysis.append(f"â€¢ æ—¥ä¸»ï¼š{day_master}ï¼ˆ{day_element}ï¼‰")
        analysis.append(f"â€¢ ç”Ÿå¹´åœ°æ”¯ï¼š{birth_year_branch}")

        # åŸºäºæ—¥ä¸»çš„æ‹©æ—¥åå¥½
        day_master_preferences = {
            'ç”²': {'element': 'æœ¨', 'best_seasons': 'æ˜¥å­£', 'best_directions': 'ä¸œæ–¹', 'lucky_numbers': [1, 2, 3, 8]},
            'ä¹™': {'element': 'æœ¨', 'best_seasons': 'æ˜¥å­£', 'best_directions': 'ä¸œå—', 'lucky_numbers': [1, 2, 3, 8]},
            'ä¸™': {'element': 'ç«', 'best_seasons': 'å¤å­£', 'best_directions': 'å—æ–¹', 'lucky_numbers': [2, 3, 7, 9]},
            'ä¸': {'element': 'ç«', 'best_seasons': 'å¤å­£', 'best_directions': 'å—æ–¹', 'lucky_numbers': [2, 3, 7, 9]},
            'æˆŠ': {'element': 'åœŸ', 'best_seasons': 'å››å­£æœ«', 'best_directions': 'ä¸­å¤®', 'lucky_numbers': [5, 6, 0]},
            'å·±': {'element': 'åœŸ', 'best_seasons': 'å››å­£æœ«', 'best_directions': 'ä¸­å¤®', 'lucky_numbers': [5, 6, 0]},
            'åºš': {'element': 'é‡‘', 'best_seasons': 'ç§‹å­£', 'best_directions': 'è¥¿æ–¹', 'lucky_numbers': [4, 7, 8, 9]},
            'è¾›': {'element': 'é‡‘', 'best_seasons': 'ç§‹å­£', 'best_directions': 'è¥¿åŒ—', 'lucky_numbers': [4, 7, 8, 9]},
            'å£¬': {'element': 'æ°´', 'best_seasons': 'å†¬å­£', 'best_directions': 'åŒ—æ–¹', 'lucky_numbers': [1, 6, 0]},
            'ç™¸': {'element': 'æ°´', 'best_seasons': 'å†¬å­£', 'best_directions': 'åŒ—æ–¹', 'lucky_numbers': [1, 6, 0]}
        }

        if day_master in day_master_preferences:
            pref = day_master_preferences[day_master]
            analysis.append(f"â€¢ äº”è¡Œå±æ€§ï¼š{pref['element']}")
            analysis.append(f"â€¢ æœ€ä½³å­£èŠ‚ï¼š{pref['best_seasons']}")
            analysis.append(f"â€¢ å‰åˆ©æ–¹ä½ï¼š{pref['best_directions']}")
            analysis.append(f"â€¢ å¹¸è¿æ•°å­—ï¼š{', '.join(map(str, pref['lucky_numbers']))}")

        # ç”Ÿå¹´åœ°æ”¯çš„æ‹©æ—¥å½±å“
        branch_influences = {
            'å­': {'conflicts': ['åˆ'], 'harmonies': ['ç”³', 'è¾°'], 'element': 'æ°´'},
            'ä¸‘': {'conflicts': ['æœª'], 'harmonies': ['å·³', 'é…‰'], 'element': 'åœŸ'},
            'å¯…': {'conflicts': ['ç”³'], 'harmonies': ['åˆ', 'æˆŒ'], 'element': 'æœ¨'},
            'å¯': {'conflicts': ['é…‰'], 'harmonies': ['æœª', 'äº¥'], 'element': 'æœ¨'},
            'è¾°': {'conflicts': ['æˆŒ'], 'harmonies': ['ç”³', 'å­'], 'element': 'åœŸ'},
            'å·³': {'conflicts': ['äº¥'], 'harmonies': ['é…‰', 'ä¸‘'], 'element': 'ç«'},
            'åˆ': {'conflicts': ['å­'], 'harmonies': ['æˆŒ', 'å¯…'], 'element': 'ç«'},
            'æœª': {'conflicts': ['ä¸‘'], 'harmonies': ['äº¥', 'å¯'], 'element': 'åœŸ'},
            'ç”³': {'conflicts': ['å¯…'], 'harmonies': ['å­', 'è¾°'], 'element': 'é‡‘'},
            'é…‰': {'conflicts': ['å¯'], 'harmonies': ['ä¸‘', 'å·³'], 'element': 'é‡‘'},
            'æˆŒ': {'conflicts': ['è¾°'], 'harmonies': ['å¯…', 'åˆ'], 'element': 'åœŸ'},
            'äº¥': {'conflicts': ['å·³'], 'harmonies': ['å¯', 'æœª'], 'element': 'æ°´'}
        }

        if birth_year_branch in branch_influences:
            influence = branch_influences[birth_year_branch]
            analysis.append(f"â€¢ ç”Ÿå¹´äº”è¡Œï¼š{influence['element']}")
            analysis.append(f"â€¢ ç›¸å†²åœ°æ”¯ï¼š{', '.join(influence['conflicts'])}ï¼ˆé¿å¼€è¿™äº›æ—¥å­ï¼‰")
            analysis.append(f"â€¢ ç›¸åˆåœ°æ”¯ï¼š{', '.join(influence['harmonies'])}ï¼ˆä¼˜é€‰è¿™äº›æ—¥å­ï¼‰")

        return analysis

    def analyze_huangli_system(self, event_type, bazi_result):
        """é»„å†ç³»ç»Ÿåˆ†æ - åŸºäºä¼ ç»Ÿé»„å†ç†è®º"""
        analysis = []
        analysis.append("\nã€é»„å†ç³»ç»Ÿåˆ†æã€‘")
        analysis.append("åŸºäºã€Šåçºªè¾¨æ–¹ä¹¦ã€‹é»„å†ç†è®ºï¼š")

        # é»„é“åäºŒç¥è¯¦è§£
        analysis.append("\nâ€¢ é»„é“åäºŒç¥è¯¦è§£ï¼š")
        huangdao_gods = {
            'é’é¾™': {'type': 'é»„é“', 'suitable': 'ç¥ˆç¦ã€å«å¨¶ã€å‡ºè¡Œã€æ±‚è´¢', 'meaning': 'ä¸œæ–¹é’é¾™ï¼Œä¸»å‰åº†'},
            'æ˜å ‚': {'type': 'é»„é“', 'suitable': 'ä¸Šå®˜ã€ä¼šå‹ã€æ±‚å­¦ã€è€ƒè¯•', 'meaning': 'å…‰æ˜æ­£å¤§ï¼Œä¸»æ–‡æ˜Œ'},
            'é‡‘åŒ®': {'type': 'é»„é“', 'suitable': 'çº³è´¢ã€å¼€å¸‚ã€å®‰è‘¬ã€ä¿®é€ ', 'meaning': 'é‡‘åº“ä¹‹ç¥ï¼Œä¸»è´¢å¯Œ'},
            'å¤©å¾·': {'type': 'é»„é“', 'suitable': 'ç¥ˆç¦ã€å«å¨¶ã€å‡ºè¡Œã€åŠ¨åœŸ', 'meaning': 'å¤©ä¹‹å¾·æ³½ï¼Œå¤§å‰ä¹‹ç¥'},
            'ç‰å ‚': {'type': 'é»„é“', 'suitable': 'å«å¨¶ã€ä¼šå‹ã€æ±‚å­¦ã€ä¸Šå®˜', 'meaning': 'ç‰å ‚é‡‘é©¬ï¼Œä¸»è´µæ˜¾'},
            'å¸å‘½': {'type': 'é»„é“', 'suitable': 'å«å¨¶ã€å®‰è‘¬ã€ç¥ˆç¦ã€æ±‚å—£', 'meaning': 'å¸å‘½ä¹‹ç¥ï¼Œä¸»ç”Ÿè‚²'},
            'å¤©åˆ‘': {'type': 'é»‘é“', 'avoid': 'è¯è®¼ã€åŠ¨åœŸã€å«å¨¶', 'meaning': 'å¤©ä¹‹åˆ‘ç½šï¼Œä¸»åˆ‘ä¼¤'},
            'æœ±é›€': {'type': 'é»‘é“', 'avoid': 'å«å¨¶ã€å¼€å¸‚ã€å‡ºè¡Œ', 'meaning': 'å—æ–¹æœ±é›€ï¼Œä¸»å£èˆŒ'},
            'ç™½è™': {'type': 'é»‘é“', 'avoid': 'å«å¨¶ã€åŠ¨åœŸã€å‡ºè¡Œ', 'meaning': 'è¥¿æ–¹ç™½è™ï¼Œä¸»å‡¶ç…'},
            'å¤©ç‰¢': {'type': 'é»‘é“', 'avoid': 'å‡ºè¡Œã€å«å¨¶ã€å¼€å¸‚', 'meaning': 'å¤©ä¹‹ç‰¢ç‹±ï¼Œä¸»å›°å„'},
            'å…ƒæ­¦': {'type': 'é»‘é“', 'avoid': 'å«å¨¶ã€ç¥ˆç¦ã€å‡ºè¡Œ', 'meaning': 'åŒ—æ–¹ç„æ­¦ï¼Œä¸»é˜´é‚ª'},
            'å‹¾é™ˆ': {'type': 'é»‘é“', 'avoid': 'å«å¨¶ã€å‡ºè¡Œã€åŠ¨åœŸ', 'meaning': 'ä¸­å¤®å‹¾é™ˆï¼Œä¸»çº ç¼ '}
        }

        for god, info in huangdao_gods.items():
            if info['type'] == 'é»„é“':
                analysis.append(f"  {god}ï¼ˆé»„é“ï¼‰ï¼š{info['meaning']}ï¼Œå®œ{info['suitable']}")
            else:
                analysis.append(f"  {god}ï¼ˆé»‘é“ï¼‰ï¼š{info['meaning']}ï¼Œå¿Œ{info['avoid']}")

        return analysis

    def analyze_jianchuxing_detailed(self, event_type):
        """å»ºé™¤åäºŒç¥è¯¦ç»†åˆ†æ - åŸºäºã€Šåçºªè¾¨æ–¹ä¹¦ã€‹"""
        analysis = []
        analysis.append("\nã€å»ºé™¤åäºŒç¥è¯¦è§£ã€‘")
        analysis.append("åŸºäºã€Šåçºªè¾¨æ–¹ä¹¦ã€‹å»ºé™¤åäºŒç¥ç†è®ºï¼š")

        jianchuxing_details = {
            'å»º': {
                'meaning': 'å»ºç«‹ã€åˆ›å§‹ä¹‹æ„',
                'suitable': 'ç¥ˆç¦ã€æ±‚å—£ã€ä¸Šå®˜ã€å‡ºè¡Œã€å«å¨¶ã€ä¿®é€ ã€åŠ¨åœŸ',
                'avoid': 'å®‰è‘¬',
                'level': 'å‰',
                'description': 'ä¸‡äº‹å¯ä¸ºï¼Œä½†ä¸å®œå®‰è‘¬'
            },
            'é™¤': {
                'meaning': 'é™¤æ—§å¸ƒæ–°ä¹‹æ„',
                'suitable': 'ç¥ˆç¦ã€æ±‚åŒ»ã€ç ´å±‹ã€åå£ã€ä½™äº‹å‹¿å–',
                'avoid': 'å«å¨¶ã€å¼€å¸‚',
                'level': 'å‡¶',
                'description': 'å®œç ´é™¤æ—§ç‰©ï¼Œä¸å®œå»ºç«‹æ–°äº‹'
            },
            'æ»¡': {
                'meaning': 'åœ†æ»¡ã€å……å®ä¹‹æ„',
                'suitable': 'ç¥ˆç¦ã€å«å¨¶ã€å¼€å¸‚ã€äº¤æ˜“ã€ç«‹åˆ¸ã€çº³è´¢',
                'avoid': 'æœè¯ã€é’ˆç¸ã€æ ½ç§',
                'level': 'å‰',
                'description': 'è¯¸äº‹åœ†æ»¡ï¼Œä½†å¿ŒåŒ»ç–—ç§æ¤'
            },
            'å¹³': {
                'meaning': 'å¹³ç¨³ã€å¹³å¸¸ä¹‹æ„',
                'suitable': 'ä¿®è·¯ã€æ¶‚æ³¥ã€ä½™äº‹å‹¿å–',
                'avoid': 'å«å¨¶ã€å¼€å¸‚ã€å®‰è‘¬ã€å‡ºè¡Œ',
                'level': 'å‡¶',
                'description': 'å¹³å¸¸ä¹‹æ—¥ï¼Œå¤§äº‹ä¸å®œ'
            },
            'å®š': {
                'meaning': 'å®‰å®šã€ç¡®å®šä¹‹æ„',
                'suitable': 'å«å¨¶ã€å¼€å¸‚ã€ç«‹åˆ¸ã€äº¤æ˜“ã€çº³è´¢ã€æ ½ç§',
                'avoid': 'å‡ºè¡Œã€åŒ»ç–—ã€è¯è®¼',
                'level': 'å‰',
                'description': 'å®œå®šç«‹å¤§äº‹ï¼Œå¿Œå˜åŠ¨å‡ºè¡Œ'
            },
            'æ‰§': {
                'meaning': 'æ‰§è¡Œã€åšæŒä¹‹æ„',
                'suitable': 'ç¥ˆç¦ã€å«å¨¶ã€å¼€å¸‚ã€çº³è´¢ã€ä¿®é€ ',
                'avoid': 'å‡ºè¡Œã€ç§»å¾™',
                'level': 'å‰',
                'description': 'å®œæ‰§è¡Œè®¡åˆ’ï¼Œå¿Œè¿ç§»å˜åŠ¨'
            },
            'ç ´': {
                'meaning': 'ç ´åã€å†²ç ´ä¹‹æ„',
                'suitable': 'ç ´å±‹ã€åå£ã€æ±‚åŒ»ã€æ²»ç—…',
                'avoid': 'å«å¨¶ã€å¼€å¸‚ã€å‡ºè¡Œã€ç¥ˆç¦',
                'level': 'å¤§å‡¶',
                'description': 'ç ´è´¥ä¹‹æ—¥ï¼Œè¯¸äº‹ä¸å®œ'
            },
            'å±': {
                'meaning': 'å±é™©ã€é«˜å³»ä¹‹æ„',
                'suitable': 'ç¥ˆç¦ã€å«å¨¶ã€å¼€å¸‚ã€äº¤æ˜“ã€å®‰åºŠ',
                'avoid': 'å‡ºè¡Œã€ç™»é«˜ã€ä¹˜èˆ¹',
                'level': 'å‡¶',
                'description': 'å±é™©ä¹‹æ—¥ï¼Œå¿Œé«˜å¤„é™©åœ°'
            },
            'æˆ': {
                'meaning': 'æˆåŠŸã€æˆå°±ä¹‹æ„',
                'suitable': 'ç¥ˆç¦ã€å«å¨¶ã€å¼€å¸‚ã€å‡ºè¡Œã€ç«‹åˆ¸ã€äº¤æ˜“',
                'avoid': 'è¯è®¼ã€å®‰è‘¬',
                'level': 'å‰',
                'description': 'æˆå°±ä¹‹æ—¥ï¼Œä¸‡äº‹çš†å®œ'
            },
            'æ”¶': {
                'meaning': 'æ”¶è·ã€æ”¶è—ä¹‹æ„',
                'suitable': 'ç¥ˆç¦ã€æ±‚å—£ã€çº³è´¢ã€å¼€å¸‚ã€äº¤æ˜“',
                'avoid': 'å‡ºè¡Œã€å«å¨¶ã€å®‰è‘¬',
                'level': 'å‰',
                'description': 'æ”¶è·ä¹‹æ—¥ï¼Œå®œèšè´¢çº³ç¦'
            },
            'å¼€': {
                'meaning': 'å¼€å¯ã€å¼€å§‹ä¹‹æ„',
                'suitable': 'ç¥ˆç¦ã€å«å¨¶ã€å¼€å¸‚ã€å‡ºè¡Œã€ç«‹åˆ¸ã€ä¿®é€ ',
                'avoid': 'å®‰è‘¬',
                'level': 'å‰',
                'description': 'å¼€å¯ä¹‹æ—¥ï¼Œæ–°äº‹çš†å®œ'
            },
            'é—­': {
                'meaning': 'é—­å¡ã€å…³é—­ä¹‹æ„',
                'suitable': 'ç¥ˆç¦ã€ä¿®é€ ã€ç­‘å ¤ã€å¡ç©´',
                'avoid': 'å«å¨¶ã€å¼€å¸‚ã€å‡ºè¡Œ',
                'level': 'å‡¶',
                'description': 'é—­å¡ä¹‹æ—¥ï¼Œå®œé™ä¸å®œåŠ¨'
            }
        }

        for star, info in jianchuxing_details.items():
            level_symbol = "â˜…â˜…â˜…" if info['level'] == 'å‰' else "â˜…â˜†â˜†" if info['level'] == 'å‡¶' else "â˜†â˜†â˜†"
            analysis.append(f"\nâ€¢ {star}æ—¥ï¼ˆ{info['level']} {level_symbol}ï¼‰ï¼š{info['meaning']}")
            analysis.append(f"  é€‚å®œï¼š{info['suitable']}")
            analysis.append(f"  å¿Œè®³ï¼š{info['avoid']}")
            analysis.append(f"  è¯´æ˜ï¼š{info['description']}")

        # é’ˆå¯¹å…·ä½“äº‹ä»¶çš„å»ºé™¤é€‰æ‹©å»ºè®®
        event_jianchuxing_advice = {
            'ç»“å©š': ['å»º', 'æ»¡', 'å®š', 'æ‰§', 'æˆ', 'å¼€'],
            'å¼€ä¸š': ['å»º', 'æ»¡', 'å®š', 'æ‰§', 'æˆ', 'å¼€'],
            'æ¬å®¶': ['å»º', 'æ»¡', 'å®š', 'æˆ', 'å¼€'],
            'åŠ¨åœŸ': ['å»º', 'æ»¡', 'å®š', 'æ‰§', 'æˆ', 'å¼€'],
            'å‡ºè¡Œ': ['å»º', 'æˆ', 'å¼€'],
            'å®‰è‘¬': ['æ»¡', 'å®š', 'æ‰§', 'å±', 'æˆ', 'æ”¶']
        }

        if event_type in event_jianchuxing_advice:
            suitable_stars = event_jianchuxing_advice[event_type]
            analysis.append(f"\nâ€¢ {event_type}é€‚å®œçš„å»ºé™¤æ—¥ï¼š{', '.join(suitable_stars)}")

        return analysis

    def analyze_28_constellations_date_selection(self, event_type):
        """äºŒåå…«å®¿æ‹©æ—¥åˆ†æ - åŸºäºã€Šè±¡å‰é€šä¹¦ã€‹"""
        analysis = []
        analysis.append("\nã€äºŒåå…«å®¿æ‹©æ—¥ã€‘")
        analysis.append("åŸºäºã€Šè±¡å‰é€šä¹¦ã€‹äºŒåå…«å®¿ç†è®ºï¼š")

        # äºŒåå…«å®¿è¯¦ç»†ä¿¡æ¯
        constellations = {
            # ä¸œæ–¹é’é¾™ä¸ƒå®¿
            'è§’': {'direction': 'ä¸œ', 'element': 'æœ¨', 'level': 'å‰', 'suitable': 'å«å¨¶ã€å‡ºè¡Œã€å¼€å¸‚ã€ç¥ˆç¦'},
            'äº¢': {'direction': 'ä¸œ', 'element': 'é‡‘', 'level': 'å‡¶', 'suitable': 'å®‰è‘¬ã€ç ´å±‹'},
            'æ°': {'direction': 'ä¸œ', 'element': 'åœŸ', 'level': 'å‡¶', 'suitable': 'å®‰è‘¬ã€ä¿®é€ '},
            'æˆ¿': {'direction': 'ä¸œ', 'element': 'æ—¥', 'level': 'å‰', 'suitable': 'å«å¨¶ã€ç¥ˆç¦ã€å¼€å¸‚'},
            'å¿ƒ': {'direction': 'ä¸œ', 'element': 'æœˆ', 'level': 'å‡¶', 'suitable': 'å®‰è‘¬ã€ç ´å±‹'},
            'å°¾': {'direction': 'ä¸œ', 'element': 'ç«', 'level': 'å‰', 'suitable': 'å«å¨¶ã€å¼€å¸‚ã€å‡ºè¡Œ'},
            'ç®•': {'direction': 'ä¸œ', 'element': 'æ°´', 'level': 'å‰', 'suitable': 'å¼€å¸‚ã€çº³è´¢ã€å‡ºè¡Œ'},

            # åŒ—æ–¹ç„æ­¦ä¸ƒå®¿
            'æ–—': {'direction': 'åŒ—', 'element': 'æœ¨', 'level': 'å‰', 'suitable': 'å«å¨¶ã€å¼€å¸‚ã€ç¥ˆç¦'},
            'ç‰›': {'direction': 'åŒ—', 'element': 'é‡‘', 'level': 'å‡¶', 'suitable': 'å®‰è‘¬ã€ç ´å±‹'},
            'å¥³': {'direction': 'åŒ—', 'element': 'åœŸ', 'level': 'å‡¶', 'suitable': 'å®‰è‘¬ã€ä¿®é€ '},
            'è™š': {'direction': 'åŒ—', 'element': 'æ—¥', 'level': 'å‡¶', 'suitable': 'å®‰è‘¬ã€ç ´å±‹'},
            'å±': {'direction': 'åŒ—', 'element': 'æœˆ', 'level': 'å‡¶', 'suitable': 'å®‰è‘¬ã€ä¿®é€ '},
            'å®¤': {'direction': 'åŒ—', 'element': 'ç«', 'level': 'å‰', 'suitable': 'å«å¨¶ã€å¼€å¸‚ã€ä¿®é€ '},
            'å£': {'direction': 'åŒ—', 'element': 'æ°´', 'level': 'å‰', 'suitable': 'å«å¨¶ã€å¼€å¸‚ã€å‡ºè¡Œ'},

            # è¥¿æ–¹ç™½è™ä¸ƒå®¿
            'å¥': {'direction': 'è¥¿', 'element': 'æœ¨', 'level': 'å‰', 'suitable': 'å«å¨¶ã€å¼€å¸‚ã€ç¥ˆç¦'},
            'å¨„': {'direction': 'è¥¿', 'element': 'é‡‘', 'level': 'å‰', 'suitable': 'å«å¨¶ã€å¼€å¸‚ã€å‡ºè¡Œ'},
            'èƒƒ': {'direction': 'è¥¿', 'element': 'åœŸ', 'level': 'å‰', 'suitable': 'å«å¨¶ã€å¼€å¸‚ã€ç¥ˆç¦'},
            'æ˜´': {'direction': 'è¥¿', 'element': 'æ—¥', 'level': 'å‡¶', 'suitable': 'å®‰è‘¬ã€ç ´å±‹'},
            'æ¯•': {'direction': 'è¥¿', 'element': 'æœˆ', 'level': 'å‰', 'suitable': 'å«å¨¶ã€å¼€å¸‚ã€å‡ºè¡Œ'},
            'è§œ': {'direction': 'è¥¿', 'element': 'ç«', 'level': 'å‡¶', 'suitable': 'å®‰è‘¬ã€ç ´å±‹'},
            'å‚': {'direction': 'è¥¿', 'element': 'æ°´', 'level': 'å‰', 'suitable': 'å«å¨¶ã€å¼€å¸‚ã€å‡ºè¡Œ'},

            # å—æ–¹æœ±é›€ä¸ƒå®¿
            'äº•': {'direction': 'å—', 'element': 'æœ¨', 'level': 'å‰', 'suitable': 'å«å¨¶ã€å¼€å¸‚ã€ç¥ˆç¦'},
            'é¬¼': {'direction': 'å—', 'element': 'é‡‘', 'level': 'å‡¶', 'suitable': 'å®‰è‘¬ã€ç ´å±‹'},
            'æŸ³': {'direction': 'å—', 'element': 'åœŸ', 'level': 'å‡¶', 'suitable': 'å®‰è‘¬ã€ä¿®é€ '},
            'æ˜Ÿ': {'direction': 'å—', 'element': 'æ—¥', 'level': 'å‡¶', 'suitable': 'å®‰è‘¬ã€ç ´å±‹'},
            'å¼ ': {'direction': 'å—', 'element': 'æœˆ', 'level': 'å‰', 'suitable': 'å«å¨¶ã€å¼€å¸‚ã€ç¥ˆç¦'},
            'ç¿¼': {'direction': 'å—', 'element': 'ç«', 'level': 'å‡¶', 'suitable': 'å®‰è‘¬ã€ç ´å±‹'},
            'è½¸': {'direction': 'å—', 'element': 'æ°´', 'level': 'å‰', 'suitable': 'å«å¨¶ã€å¼€å¸‚ã€å‡ºè¡Œ'}
        }

        # æŒ‰æ–¹ä½åˆ†ç»„æ˜¾ç¤º
        directions = ['ä¸œ', 'åŒ—', 'è¥¿', 'å—']
        direction_names = {'ä¸œ': 'é’é¾™', 'åŒ—': 'ç„æ­¦', 'è¥¿': 'ç™½è™', 'å—': 'æœ±é›€'}

        for direction in directions:
            analysis.append(f"\nâ€¢ {direction}æ–¹{direction_names[direction]}ä¸ƒå®¿ï¼š")
            direction_stars = {k: v for k, v in constellations.items() if v['direction'] == direction}
            for star, info in direction_stars.items():
                level_symbol = "â˜…â˜…â˜…" if info['level'] == 'å‰' else "â˜…â˜†â˜†"
                analysis.append(f"  {star}å®¿ï¼ˆ{info['element']}ï¼Œ{info['level']} {level_symbol}ï¼‰ï¼š{info['suitable']}")

        # é’ˆå¯¹å…·ä½“äº‹ä»¶çš„äºŒåå…«å®¿å»ºè®®
        event_constellation_advice = {
            'ç»“å©š': ['è§’', 'æˆ¿', 'å°¾', 'ç®•', 'æ–—', 'å®¤', 'å£', 'å¥', 'å¨„', 'èƒƒ', 'æ¯•', 'å‚', 'äº•', 'å¼ ', 'è½¸'],
            'å¼€ä¸š': ['è§’', 'æˆ¿', 'å°¾', 'ç®•', 'æ–—', 'å®¤', 'å£', 'å¥', 'å¨„', 'èƒƒ', 'æ¯•', 'å‚', 'äº•', 'å¼ ', 'è½¸'],
            'æ¬å®¶': ['è§’', 'æˆ¿', 'å°¾', 'ç®•', 'æ–—', 'å®¤', 'å£', 'å¥', 'å¨„', 'èƒƒ', 'æ¯•', 'å‚', 'äº•', 'å¼ ', 'è½¸'],
            'åŠ¨åœŸ': ['è§’', 'æˆ¿', 'å°¾', 'ç®•', 'æ–—', 'å®¤', 'å£', 'å¥', 'å¨„', 'èƒƒ', 'æ¯•', 'å‚', 'äº•', 'å¼ ', 'è½¸'],
            'å‡ºè¡Œ': ['è§’', 'æˆ¿', 'å°¾', 'ç®•', 'æ–—', 'å®¤', 'å£', 'å¥', 'å¨„', 'èƒƒ', 'æ¯•', 'å‚', 'äº•', 'å¼ ', 'è½¸'],
            'å®‰è‘¬': ['äº¢', 'æ°', 'å¿ƒ', 'ç‰›', 'å¥³', 'è™š', 'å±', 'æ˜´', 'è§œ', 'é¬¼', 'æŸ³', 'æ˜Ÿ', 'ç¿¼']
        }

        if event_type in event_constellation_advice:
            suitable_stars = event_constellation_advice[event_type]
            analysis.append(f"\nâ€¢ {event_type}é€‚å®œçš„æ˜Ÿå®¿ï¼š{', '.join(suitable_stars[:10])}ç­‰")

        return analysis

    def analyze_event_requirements(self, event_type):
        """åˆ†æäº‹ä»¶æ‹©æ—¥è¦æ±‚"""
        analysis = []
        analysis.append("ã€äº‹ä»¶æ‹©æ—¥è¦æ±‚ã€‘")
        event_requirements = {
            'ç»“å©š': {
                'suitable_months': 'æ˜¥å­£ï¼ˆå†œå†äºŒã€ä¸‰æœˆï¼‰ã€ç§‹å­£ï¼ˆå†œå†å…«ã€ä¹æœˆï¼‰',
                'suitable_days': 'æˆæ—¥ã€å¼€æ—¥ã€æ»¡æ—¥ã€å®šæ—¥',
                'avoid_days': 'ç ´æ—¥ã€é—­æ—¥ã€å¹³æ—¥ã€æ”¶æ—¥',
                'special_requirements': 'é¿å¼€æ–°å¨˜æœ¬å‘½å¹´ã€é¿å¼€ä¸‰å¨˜ç…æ—¥ã€é€‰æ‹©é»„é“å‰æ—¥',
                'best_time': 'ä¸Šåˆ9-11ç‚¹ï¼ˆå·³æ—¶ï¼‰æˆ–ä¸‹åˆ1-3ç‚¹ï¼ˆæœªæ—¶ï¼‰'
            },
            'å¼€ä¸š': {
                'suitable_months': 'æ˜¥å­£ï¼ˆå†œå†æ­£ã€äºŒã€ä¸‰æœˆï¼‰ã€ç§‹å­£ï¼ˆå†œå†ä¸ƒã€å…«ã€ä¹æœˆï¼‰',
                'suitable_days': 'å¼€æ—¥ã€æˆæ—¥ã€æ»¡æ—¥ã€å®šæ—¥',
                'avoid_days': 'ç ´æ—¥ã€é—­æ—¥ã€å¹³æ—¥ã€æ”¶æ—¥ã€é™¤æ—¥',
                'special_requirements': 'é€‰æ‹©è´¢æ˜Ÿå½“ä»¤æ—¥ã€é¿å¼€ä¸åº—ä¸»ç›¸å†²çš„æ—¥å­',
                'best_time': 'ä¸Šåˆ9-11ç‚¹ï¼ˆå·³æ—¶ï¼‰æˆ–ä¸Šåˆ11-13ç‚¹ï¼ˆåˆæ—¶ï¼‰'
            },
            'æ¬å®¶': {
                'suitable_months': 'æ˜¥å­£ï¼ˆå†œå†äºŒã€ä¸‰æœˆï¼‰ã€å¤å­£ï¼ˆå†œå†äº”ã€å…­æœˆï¼‰',
                'suitable_days': 'æˆæ—¥ã€å¼€æ—¥ã€æ»¡æ—¥ã€å®šæ—¥ã€é™¤æ—¥',
                'avoid_days': 'ç ´æ—¥ã€é—­æ—¥ã€å¹³æ—¥ã€æ”¶æ—¥',
                'special_requirements': 'é¿å¼€ä¸å®¶ä¸»ç›¸å†²çš„æ—¥å­ã€é€‰æ‹©é©¿é©¬æ˜ŸåŠ¨çš„æ—¥å­',
                'best_time': 'ä¸Šåˆ7-9ç‚¹ï¼ˆè¾°æ—¶ï¼‰æˆ–ä¸Šåˆ9-11ç‚¹ï¼ˆå·³æ—¶ï¼‰'
            },
            'åŠ¨åœŸ': {
                'suitable_months': 'æ˜¥å­£ï¼ˆå†œå†äºŒã€ä¸‰æœˆï¼‰ã€ç§‹å­£ï¼ˆå†œå†å…«ã€ä¹æœˆï¼‰',
                'suitable_days': 'æˆæ—¥ã€å¼€æ—¥ã€æ»¡æ—¥ã€å®šæ—¥',
                'avoid_days': 'ç ´æ—¥ã€é—­æ—¥ã€å¹³æ—¥ã€æ”¶æ—¥ã€åœŸç‹ç”¨äº‹æ—¥',
                'special_requirements': 'é¿å¼€å¤ªå²æ–¹ä½ã€é¿å¼€ä¸‰ç…æ–¹ä½ã€é€‰æ‹©é»„é“å‰æ—¥',
                'best_time': 'ä¸Šåˆ7-9ç‚¹ï¼ˆè¾°æ—¶ï¼‰æˆ–ä¸‹åˆ1-3ç‚¹ï¼ˆæœªæ—¶ï¼‰'
            },
            'å‡ºè¡Œ': {
                'suitable_months': 'æ˜¥å­£ï¼ˆå†œå†äºŒã€ä¸‰ã€å››æœˆï¼‰ã€ç§‹å­£ï¼ˆå†œå†å…«ã€ä¹ã€åæœˆï¼‰',
                'suitable_days': 'æˆæ—¥ã€å¼€æ—¥ã€æ»¡æ—¥ã€é™¤æ—¥',
                'avoid_days': 'ç ´æ—¥ã€é—­æ—¥ã€å¹³æ—¥ã€æ”¶æ—¥ã€å®šæ—¥',
                'special_requirements': 'é€‰æ‹©é©¿é©¬æ˜ŸåŠ¨çš„æ—¥å­ã€é¿å¼€ä¸å‡ºè¡Œäººç›¸å†²çš„æ—¥å­',
                'best_time': 'ä¸Šåˆ7-9ç‚¹ï¼ˆè¾°æ—¶ï¼‰æˆ–ä¸Šåˆ9-11ç‚¹ï¼ˆå·³æ—¶ï¼‰'
            },
            'ç­¾çº¦': {
                'suitable_months': 'æ˜¥å­£ï¼ˆå†œå†äºŒã€ä¸‰æœˆï¼‰ã€ç§‹å­£ï¼ˆå†œå†å…«ã€ä¹æœˆï¼‰',
                'suitable_days': 'æˆæ—¥ã€å¼€æ—¥ã€æ»¡æ—¥ã€å®šæ—¥',
                'avoid_days': 'ç ´æ—¥ã€é—­æ—¥ã€å¹³æ—¥ã€æ”¶æ—¥ã€é™¤æ—¥',
                'special_requirements': 'é€‰æ‹©æ–‡æ˜Œæ˜Ÿå½“ä»¤æ—¥ã€é¿å¼€ä¸ç­¾çº¦äººç›¸å†²çš„æ—¥å­',
                'best_time': 'ä¸Šåˆ9-11ç‚¹ï¼ˆå·³æ—¶ï¼‰æˆ–ä¸‹åˆ3-5ç‚¹ï¼ˆç”³æ—¶ï¼‰'
            },
            'ç¥­ç¥€': {
                'suitable_months': 'æ˜¥å­£ï¼ˆå†œå†äºŒã€ä¸‰æœˆï¼‰ã€ç§‹å­£ï¼ˆå†œå†ä¹ã€åæœˆï¼‰',
                'suitable_days': 'æˆæ—¥ã€æ»¡æ—¥ã€å®šæ—¥ã€é™¤æ—¥',
                'avoid_days': 'ç ´æ—¥ã€é—­æ—¥ã€å¹³æ—¥ã€æ”¶æ—¥ã€å¼€æ—¥',
                'special_requirements': 'é€‰æ‹©å¤©å¾·ã€æœˆå¾·å‰æ—¥ã€é¿å¼€ä¸æ´ä¹‹æ—¥',
                'best_time': 'ä¸Šåˆ7-9ç‚¹ï¼ˆè¾°æ—¶ï¼‰æˆ–ä¸Šåˆ9-11ç‚¹ï¼ˆå·³æ—¶ï¼‰'
            }
        }
        if event_type in event_requirements:
            req = event_requirements[event_type]
            analysis.append(f"â€¢ äº‹ä»¶ç±»å‹ï¼š{event_type}")
            analysis.append(f"â€¢ é€‚å®œæœˆä»½ï¼š{req['suitable_months']}")
            analysis.append(f"â€¢ é€‚å®œæ—¥å­ï¼š{req['suitable_days']}")
            analysis.append(f"â€¢ å¿Œè®³æ—¥å­ï¼š{req['avoid_days']}")
            analysis.append(f"â€¢ ç‰¹æ®Šè¦æ±‚ï¼š{req['special_requirements']}")
            analysis.append(f"â€¢ æœ€ä½³æ—¶è¾°ï¼š{req['best_time']}")
        else:
            analysis.append(f"â€¢ äº‹ä»¶ç±»å‹ï¼š{event_type}ï¼ˆé€šç”¨æ‹©æ—¥åŸåˆ™ï¼‰")
            analysis.append("â€¢ ä¸€èˆ¬åŸåˆ™ï¼šé€‰æ‹©é»„é“å‰æ—¥ï¼Œé¿å¼€ç ´æ—¥ã€é—­æ—¥ç­‰å‡¶æ—¥")
        return analysis
    def analyze_personal_suitable_dates(self, bazi_result, event_type):
        """åˆ†æä¸ªäººé€‚å®œæ—¥æœŸ"""
        analysis = []
        analysis.append("\nã€ä¸ªäººé€‚å®œåˆ†æã€‘")
        day_master = bazi_result['day_master']
        day_element = bazi_result['day_master_element']
        birth_year_branch = bazi_result['pillars']['year'][1]
        analysis.append(f"â€¢ æ—¥ä¸»ï¼š{day_master}ï¼ˆ{day_element}ï¼‰")
        analysis.append(f"â€¢ ç”Ÿå¹´åœ°æ”¯ï¼š{birth_year_branch}")
        # åˆ†æä¸ªäººå–œå¿Œ
        personal_preferences = self.get_personal_date_preferences(day_element, bazi_result['bazi_pattern']['pattern_type'])
        analysis.append(f"â€¢ ä¸ªäººå–œå¿Œï¼š{personal_preferences}")
        # åˆ†æå†²åˆå…³ç³»
        conflict_branches = self.get_conflicting_branches(birth_year_branch)
        harmony_branches = self.get_harmonious_branches(birth_year_branch)
        analysis.append(f"â€¢ é¿å¼€åœ°æ”¯ï¼š{', '.join(conflict_branches)}ï¼ˆä¸ç”Ÿå¹´ç›¸å†²ç›¸å®³ï¼‰")
        analysis.append(f"â€¢ å®œé€‰åœ°æ”¯ï¼š{', '.join(harmony_branches)}ï¼ˆä¸ç”Ÿå¹´ç›¸åˆç›¸ç”Ÿï¼‰")
        # ç‰¹æ®Šç¥ç…åˆ†æ
        special_stars = self.analyze_personal_special_stars(bazi_result, event_type)
        if special_stars:
            analysis.append(f"â€¢ ç‰¹æ®Šç¥ç…ï¼š{special_stars}")
        return analysis
    def get_personal_date_preferences(self, day_element, pattern_type):
        """è·å–ä¸ªäººæ—¥æœŸå–œå¿Œ"""
        preferences = {
            'æœ¨': {
                'èº«å¼ºæ ¼': 'å–œé‡‘æ—¥ï¼ˆåˆ¶èº«ï¼‰ã€ç«æ—¥ï¼ˆæ³„ç§€ï¼‰ï¼Œå¿Œæ°´æ—¥ï¼ˆç”Ÿèº«ï¼‰ã€æœ¨æ—¥ï¼ˆåŠ©èº«ï¼‰',
                'èº«å¼±æ ¼': 'å–œæ°´æ—¥ï¼ˆç”Ÿèº«ï¼‰ã€æœ¨æ—¥ï¼ˆåŠ©èº«ï¼‰ï¼Œå¿Œé‡‘æ—¥ï¼ˆå…‹èº«ï¼‰ã€ç«æ—¥ï¼ˆæ³„èº«ï¼‰'
            },
            'ç«': {
                'èº«å¼ºæ ¼': 'å–œæ°´æ—¥ï¼ˆåˆ¶èº«ï¼‰ã€åœŸæ—¥ï¼ˆæ³„ç§€ï¼‰ï¼Œå¿Œæœ¨æ—¥ï¼ˆç”Ÿèº«ï¼‰ã€ç«æ—¥ï¼ˆåŠ©èº«ï¼‰',
                'èº«å¼±æ ¼': 'å–œæœ¨æ—¥ï¼ˆç”Ÿèº«ï¼‰ã€ç«æ—¥ï¼ˆåŠ©èº«ï¼‰ï¼Œå¿Œæ°´æ—¥ï¼ˆå…‹èº«ï¼‰ã€åœŸæ—¥ï¼ˆæ³„èº«ï¼‰'
            },
            'åœŸ': {
                'èº«å¼ºæ ¼': 'å–œæœ¨æ—¥ï¼ˆåˆ¶èº«ï¼‰ã€é‡‘æ—¥ï¼ˆæ³„ç§€ï¼‰ï¼Œå¿Œç«æ—¥ï¼ˆç”Ÿèº«ï¼‰ã€åœŸæ—¥ï¼ˆåŠ©èº«ï¼‰',
                'èº«å¼±æ ¼': 'å–œç«æ—¥ï¼ˆç”Ÿèº«ï¼‰ã€åœŸæ—¥ï¼ˆåŠ©èº«ï¼‰ï¼Œå¿Œæœ¨æ—¥ï¼ˆå…‹èº«ï¼‰ã€é‡‘æ—¥ï¼ˆæ³„èº«ï¼‰'
            },
            'é‡‘': {
                'èº«å¼ºæ ¼': 'å–œç«æ—¥ï¼ˆåˆ¶èº«ï¼‰ã€æ°´æ—¥ï¼ˆæ³„ç§€ï¼‰ï¼Œå¿ŒåœŸæ—¥ï¼ˆç”Ÿèº«ï¼‰ã€é‡‘æ—¥ï¼ˆåŠ©èº«ï¼‰',
                'èº«å¼±æ ¼': 'å–œåœŸæ—¥ï¼ˆç”Ÿèº«ï¼‰ã€é‡‘æ—¥ï¼ˆåŠ©èº«ï¼‰ï¼Œå¿Œç«æ—¥ï¼ˆå…‹èº«ï¼‰ã€æ°´æ—¥ï¼ˆæ³„èº«ï¼‰'
            },
            'æ°´': {
                'èº«å¼ºæ ¼': 'å–œåœŸæ—¥ï¼ˆåˆ¶èº«ï¼‰ã€æœ¨æ—¥ï¼ˆæ³„ç§€ï¼‰ï¼Œå¿Œé‡‘æ—¥ï¼ˆç”Ÿèº«ï¼‰ã€æ°´æ—¥ï¼ˆåŠ©èº«ï¼‰',
                'èº«å¼±æ ¼': 'å–œé‡‘æ—¥ï¼ˆç”Ÿèº«ï¼‰ã€æ°´æ—¥ï¼ˆåŠ©èº«ï¼‰ï¼Œå¿ŒåœŸæ—¥ï¼ˆå…‹èº«ï¼‰ã€æœ¨æ—¥ï¼ˆæ³„èº«ï¼‰'
            }
        }
        return preferences.get(day_element, {}).get(pattern_type, 'éœ€è¦å…·ä½“åˆ†æ')
    def get_conflicting_branches(self, birth_branch):
        """è·å–ç›¸å†²ç›¸å®³åœ°æ”¯"""
        conflicts = {
            'å­': ['åˆ', 'æœª'],  # å­åˆå†²ï¼Œå­æœªå®³
            'ä¸‘': ['æœª', 'åˆ'],  # ä¸‘æœªå†²ï¼Œä¸‘åˆå®³
            'å¯…': ['ç”³', 'å·³'],  # å¯…ç”³å†²ï¼Œå¯…å·³å®³
            'å¯': ['é…‰', 'è¾°'],  # å¯é…‰å†²ï¼Œå¯è¾°å®³
            'è¾°': ['æˆŒ', 'å¯'],  # è¾°æˆŒå†²ï¼Œè¾°å¯å®³
            'å·³': ['äº¥', 'å¯…'],  # å·³äº¥å†²ï¼Œå·³å¯…å®³
            'åˆ': ['å­', 'ä¸‘'],  # åˆå­å†²ï¼Œåˆä¸‘å®³
            'æœª': ['ä¸‘', 'å­'],  # æœªä¸‘å†²ï¼Œæœªå­å®³
            'ç”³': ['å¯…', 'äº¥'],  # ç”³å¯…å†²ï¼Œç”³äº¥å®³
            'é…‰': ['å¯', 'æˆŒ'],  # é…‰å¯å†²ï¼Œé…‰æˆŒå®³
            'æˆŒ': ['è¾°', 'é…‰'],  # æˆŒè¾°å†²ï¼ŒæˆŒé…‰å®³
            'äº¥': ['å·³', 'ç”³']   # äº¥å·³å†²ï¼Œäº¥ç”³å®³
        }
        return conflicts.get(birth_branch, [])
    def get_harmonious_branches(self, birth_branch):
        """è·å–ç›¸åˆç›¸ç”Ÿåœ°æ”¯"""
        harmonies = {
            'å­': ['ä¸‘', 'ç”³', 'è¾°'],  # å­ä¸‘åˆï¼Œç”³å­è¾°ä¸‰åˆ
            'ä¸‘': ['å­', 'å·³', 'é…‰'],  # ä¸‘å­åˆï¼Œå·³é…‰ä¸‘ä¸‰åˆ
            'å¯…': ['äº¥', 'åˆ', 'æˆŒ'],  # å¯…äº¥åˆï¼Œå¯…åˆæˆŒä¸‰åˆ
            'å¯': ['æˆŒ', 'äº¥', 'æœª'],  # å¯æˆŒåˆï¼Œäº¥å¯æœªä¸‰åˆ
            'è¾°': ['é…‰', 'ç”³', 'å­'],  # è¾°é…‰åˆï¼Œç”³å­è¾°ä¸‰åˆ
            'å·³': ['ç”³', 'é…‰', 'ä¸‘'],  # å·³ç”³åˆï¼Œå·³é…‰ä¸‘ä¸‰åˆ
            'åˆ': ['æœª', 'å¯…', 'æˆŒ'],  # åˆæœªåˆï¼Œå¯…åˆæˆŒä¸‰åˆ
            'æœª': ['åˆ', 'äº¥', 'å¯'],  # æœªåˆåˆï¼Œäº¥å¯æœªä¸‰åˆ
            'ç”³': ['å·³', 'å­', 'è¾°'],  # ç”³å·³åˆï¼Œç”³å­è¾°ä¸‰åˆ
            'é…‰': ['è¾°', 'å·³', 'ä¸‘'],  # é…‰è¾°åˆï¼Œå·³é…‰ä¸‘ä¸‰åˆ
            'æˆŒ': ['å¯', 'å¯…', 'åˆ'],  # æˆŒå¯åˆï¼Œå¯…åˆæˆŒä¸‰åˆ
            'äº¥': ['å¯…', 'å¯', 'æœª']   # äº¥å¯…åˆï¼Œäº¥å¯æœªä¸‰åˆ
        }
        return harmonies.get(birth_branch, [])
    def analyze_personal_special_stars(self, bazi_result, event_type):
        """åˆ†æä¸ªäººç‰¹æ®Šç¥ç…"""
        day_master = bazi_result['day_master']
        birth_year_branch = bazi_result['pillars']['year'][1]
        special_stars = []
        # å¤©ä¹™è´µäºº
        tianyi_map = {
            'ç”²': ['ä¸‘', 'æœª'], 'ä¹™': ['å­', 'ç”³'], 'ä¸™': ['äº¥', 'é…‰'], 'ä¸': ['äº¥', 'é…‰'],
            'æˆŠ': ['ä¸‘', 'æœª'], 'å·±': ['å­', 'ç”³'], 'åºš': ['ä¸‘', 'æœª'], 'è¾›': ['å¯…', 'åˆ'],
            'å£¬': ['å¯', 'å·³'], 'ç™¸': ['å¯', 'å·³']
        }
        if day_master in tianyi_map:
            tianyi_branches = tianyi_map[day_master]
            special_stars.append(f"å¤©ä¹™è´µäººåœ¨{', '.join(tianyi_branches)}æ—¥ï¼Œå®œé€‰æ­¤ç±»æ—¥å­")
        # æ–‡æ˜Œè´µäººï¼ˆé€‚åˆç­¾çº¦ã€è€ƒè¯•ç­‰ï¼‰
        if event_type in ['ç­¾çº¦', 'è€ƒè¯•', 'å¼€å­¦']:
            wenchang_map = {
                'ç”²': 'å·³', 'ä¹™': 'åˆ', 'ä¸™': 'ç”³', 'ä¸': 'é…‰',
                'æˆŠ': 'ç”³', 'å·±': 'é…‰', 'åºš': 'äº¥', 'è¾›': 'å­',
                'å£¬': 'å¯…', 'ç™¸': 'å¯'
            }
            if day_master in wenchang_map:
                wenchang_branch = wenchang_map[day_master]
                special_stars.append(f"æ–‡æ˜Œè´µäººåœ¨{wenchang_branch}æ—¥ï¼Œåˆ©æ–‡ä¹¦ç­¾çº¦")
        # é©¿é©¬æ˜Ÿï¼ˆé€‚åˆå‡ºè¡Œã€æ¬å®¶ç­‰ï¼‰
        if event_type in ['å‡ºè¡Œ', 'æ¬å®¶', 'è°ƒåŠ¨']:
            yima_map = {
                'å¯…': 'ç”³', 'åˆ': 'å¯…', 'æˆŒ': 'ç”³',
                'ç”³': 'å¯…', 'å­': 'å¯…', 'è¾°': 'å¯…',
                'å·³': 'äº¥', 'é…‰': 'å·³', 'ä¸‘': 'å·³',
                'äº¥': 'å·³', 'å¯': 'å·³', 'æœª': 'å·³'
            }
            if birth_year_branch in yima_map:
                yima_branch = yima_map[birth_year_branch]
                special_stars.append(f"é©¿é©¬æ˜Ÿåœ¨{yima_branch}æ—¥ï¼Œåˆ©å‡ºè¡Œæ¬è¿")
        return "ï¼›".join(special_stars) if special_stars else None
    def recommend_specific_dates(self, event_type, bazi_result, start_date=None, end_date=None):
        """æ¨èå…·ä½“æ—¥æœŸ"""
        analysis = []
        analysis.append("\nã€å…·ä½“æ—¥æœŸæ¨èã€‘")
        from datetime import datetime, timedelta
        import calendar

        # å¦‚æœæ²¡æœ‰æŒ‡å®šæ—¥æœŸèŒƒå›´ï¼Œé»˜è®¤æ¨èæœªæ¥3ä¸ªæœˆ
        if not start_date:
            start_date = datetime.now()
        if not end_date:
            end_date = start_date + timedelta(days=90)
        # è·å–ä¸ªäººä¿¡æ¯
        birth_year_branch = bazi_result['pillars']['year'][1]
        day_element = bazi_result['day_master_element']
        # åˆ†ææ—¥æœŸ
        recommended_dates = []
        current_date = start_date
        while current_date <= end_date and len(recommended_dates) < 10:
            # è®¡ç®—å†œå†ä¿¡æ¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
            lunar_info = self.get_lunar_date_info(current_date)
            # æ£€æŸ¥æ˜¯å¦ä¸ºå‰æ—¥
            is_auspicious = self.check_date_auspiciousness(current_date, lunar_info, event_type, bazi_result)
            if is_auspicious['suitable']:
                recommended_dates.append({
                    'date': current_date,
                    'lunar': lunar_info,
                    'score': is_auspicious['score'],
                    'reason': is_auspicious['reason']
                })
            current_date += timedelta(days=1)
        # æŒ‰è¯„åˆ†æ’åº
        recommended_dates.sort(key=lambda x: x['score'], reverse=True)
        # æ˜¾ç¤ºæ¨èæ—¥æœŸ
        if recommended_dates:
            analysis.append(f"â€¢ æ¨è{event_type}å‰æ—¥ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰ï¼š")
            for i, date_info in enumerate(recommended_dates[:5], 1):
                date_str = date_info['date'].strftime('%Yå¹´%mæœˆ%dæ—¥')
                weekday = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'][date_info['date'].weekday()]
                lunar_str = date_info['lunar']['description']
                analysis.append(f"  {i}. {date_str}ï¼ˆ{weekday}ï¼‰{lunar_str}")
                analysis.append(f"     è¯„åˆ†ï¼š{date_info['score']}/100 - {date_info['reason']}")
        else:
            analysis.append("â€¢ åœ¨æŒ‡å®šæ—¶é—´èŒƒå›´å†…æœªæ‰¾åˆ°ç‰¹åˆ«é€‚å®œçš„æ—¥æœŸ")
            analysis.append("  å»ºè®®ï¼šæ‰©å¤§æ—¶é—´èŒƒå›´æˆ–é€‰æ‹©ç›¸å¯¹è¾ƒå¥½çš„æ—¥æœŸ")
        return analysis
    def get_lunar_date_info(self, date):
        """è·å–å†œå†æ—¥æœŸä¿¡æ¯ï¼ˆç²¾ç¡®ç‰ˆï¼‰"""
        # ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ç²¾ç¡®çš„å†œå†è½¬æ¢ç®—æ³•ï¼Œä¸å…«å­—è®¡ç®—ä¿æŒä¸€è‡´
        try:
            if Solar and Lunar:
                # ä½¿ç”¨ç²¾ç¡®çš„lunar_pythonåº“
                # ç¡®ä¿ä¼ å…¥çš„æ˜¯ datetime å¯¹è±¡
                if hasattr(date, 'hour'):
                    # å¦‚æœæ˜¯ datetime å¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨
                    solar = Solar.fromDate(date)
                else:
                    # å¦‚æœæ˜¯ date å¯¹è±¡ï¼Œè½¬æ¢ä¸º datetime å¯¹è±¡
                    from datetime import datetime
                    datetime_obj = datetime.combine(date, datetime.min.time())
                    solar = Solar.fromDate(datetime_obj)
                lunar = solar.getLunar()
                return {
                    'month': lunar.getMonth(),
                    'day': lunar.getDay(),
                    'year_ganzhi': lunar.getYearInGanZhi(),
                    'day_ganzhi': lunar.getDayInGanZhi(),
                    'day_branch': lunar.getDayZhi(),
                    'description': f"å†œå†{lunar.getMonth()}æœˆ{lunar.getDay()}æ—¥ï¼ˆ{lunar.getDayInGanZhi()}æ—¥ï¼‰"
                }
            else:
                # å¦‚æœæ²¡æœ‰ç²¾ç¡®åº“ï¼Œæç¤ºå®‰è£…
                raise ImportError("éœ€è¦lunar_pythonåº“è¿›è¡Œç²¾ç¡®å†œå†è½¬æ¢")
        except Exception as e:
            # é”™è¯¯å¤„ç†
            return {
                'month': 1,
                'day': 1,
                'year_ganzhi': 'ç”²å­',
                'day_ganzhi': 'ç”²å­',
                'day_branch': 'å­',
                'description': f"å†œå†è½¬æ¢é”™è¯¯ï¼š{str(e)}"
            }
    def check_date_auspiciousness(self, date, lunar_info, event_type, bazi_result):
        """æ£€æŸ¥æ—¥æœŸå‰å‡¶"""
        score = 60  # åŸºç¡€åˆ†
        reasons = []
        birth_year_branch = bazi_result['pillars']['year'][1]
        day_branch = lunar_info['day_branch']
        # æ£€æŸ¥å†²åˆå…³ç³»
        conflicts = self.get_conflicting_branches(birth_year_branch)
        harmonies = self.get_harmonious_branches(birth_year_branch)
        if day_branch in conflicts:
            score -= 30
            reasons.append(f"ä¸ç”Ÿå¹´{birth_year_branch}ç›¸å†²")
        elif day_branch in harmonies:
            score += 20
            reasons.append(f"ä¸ç”Ÿå¹´{birth_year_branch}ç›¸åˆ")
        # æ£€æŸ¥å»ºé™¤åäºŒç¥
        jianchuxing = self.get_jianchuxing(date)
        jianchuxing_score = self.get_jianchuxing_score(jianchuxing, event_type)
        score += jianchuxing_score['score']
        if jianchuxing_score['reason']:
            reasons.append(jianchuxing_score['reason'])
        # æ£€æŸ¥é»„é“é»‘é“
        huangdao = self.get_huangdao_heidao(date)
        if huangdao['type'] == 'é»„é“':
            score += 15
            reasons.append(f"{huangdao['name']}é»„é“å‰æ—¥")
        else:
            score -= 10
            reasons.append(f"{huangdao['name']}é»‘é“å‡¶æ—¥")
        # æ£€æŸ¥ç‰¹æ®Šç¥ç…æ—¥
        special_day = self.check_special_shensha_day(date, bazi_result)
        if special_day:
            score += special_day['score']
            reasons.append(special_day['reason'])
        # æ£€æŸ¥èŠ‚æ°”å½±å“
        solar_term = self.get_solar_term_influence(date)
        if solar_term:
            score += solar_term['score']
            reasons.append(solar_term['reason'])
        return {
            'suitable': score >= 70,
            'score': min(100, max(0, score)),
            'reason': 'ï¼›'.join(reasons[:3]) if reasons else 'æ—¥æœŸå¹³å’Œ'
        }
    def get_jianchuxing(self, date):
        """è·å–å»ºé™¤åäºŒç¥"""
        # å»ºé™¤åäºŒç¥ï¼šå»ºã€é™¤ã€æ»¡ã€å¹³ã€å®šã€æ‰§ã€ç ´ã€å±ã€æˆã€æ”¶ã€å¼€ã€é—­
        jianchuxing_list = ['å»º', 'é™¤', 'æ»¡', 'å¹³', 'å®š', 'æ‰§', 'ç ´', 'å±', 'æˆ', 'æ”¶', 'å¼€', 'é—­']
        # ç®€åŒ–è®¡ç®—ï¼šæ ¹æ®æ—¥æœŸè®¡ç®—å»ºé™¤
        day_index = date.timetuple().tm_yday % 12
        return jianchuxing_list[day_index]
    def get_jianchuxing_score(self, jianchuxing, event_type):
        """è·å–å»ºé™¤åäºŒç¥è¯„åˆ†"""
        # å»ºé™¤åäºŒç¥å¯¹ä¸åŒäº‹ä»¶çš„å‰å‡¶
        jianchuxing_effects = {
            'å»º': {'ç»“å©š': 10, 'å¼€ä¸š': 15, 'æ¬å®¶': 10, 'åŠ¨åœŸ': 15, 'å‡ºè¡Œ': 5, 'ç­¾çº¦': 10, 'ç¥­ç¥€': 10},
            'é™¤': {'ç»“å©š': -5, 'å¼€ä¸š': 5, 'æ¬å®¶': 15, 'åŠ¨åœŸ': 10, 'å‡ºè¡Œ': 10, 'ç­¾çº¦': 5, 'ç¥­ç¥€': 15},
            'æ»¡': {'ç»“å©š': 15, 'å¼€ä¸š': 10, 'æ¬å®¶': 5, 'åŠ¨åœŸ': 5, 'å‡ºè¡Œ': 5, 'ç­¾çº¦': 10, 'ç¥­ç¥€': 15},
            'å¹³': {'ç»“å©š': 0, 'å¼€ä¸š': 0, 'æ¬å®¶': 0, 'åŠ¨åœŸ': 0, 'å‡ºè¡Œ': 5, 'ç­¾çº¦': 0, 'ç¥­ç¥€': 0},
            'å®š': {'ç»“å©š': 15, 'å¼€ä¸š': 10, 'æ¬å®¶': 5, 'åŠ¨åœŸ': 10, 'å‡ºè¡Œ': -5, 'ç­¾çº¦': 15, 'ç¥­ç¥€': 10},
            'æ‰§': {'ç»“å©š': 5, 'å¼€ä¸š': 5, 'æ¬å®¶': 5, 'åŠ¨åœŸ': 5, 'å‡ºè¡Œ': 5, 'ç­¾çº¦': 5, 'ç¥­ç¥€': 5},
            'ç ´': {'ç»“å©š': -20, 'å¼€ä¸š': -20, 'æ¬å®¶': -15, 'åŠ¨åœŸ': -20, 'å‡ºè¡Œ': -10, 'ç­¾çº¦': -15, 'ç¥­ç¥€': -10},
            'å±': {'ç»“å©š': -10, 'å¼€ä¸š': -5, 'æ¬å®¶': -10, 'åŠ¨åœŸ': -10, 'å‡ºè¡Œ': -15, 'ç­¾çº¦': -5, 'ç¥­ç¥€': 5},
            'æˆ': {'ç»“å©š': 15, 'å¼€ä¸š': 15, 'æ¬å®¶': 10, 'åŠ¨åœŸ': 10, 'å‡ºè¡Œ': 10, 'ç­¾çº¦': 15, 'ç¥­ç¥€': 10},
            'æ”¶': {'ç»“å©š': 5, 'å¼€ä¸š': -5, 'æ¬å®¶': -5, 'åŠ¨åœŸ': -5, 'å‡ºè¡Œ': -5, 'ç­¾çº¦': 5, 'ç¥­ç¥€': 10},
            'å¼€': {'ç»“å©š': 10, 'å¼€ä¸š': 20, 'æ¬å®¶': 15, 'åŠ¨åœŸ': 15, 'å‡ºè¡Œ': 15, 'ç­¾çº¦': 15, 'ç¥­ç¥€': 5},
            'é—­': {'ç»“å©š': -15, 'å¼€ä¸š': -20, 'æ¬å®¶': -10, 'åŠ¨åœŸ': -15, 'å‡ºè¡Œ': -15, 'ç­¾çº¦': -15, 'ç¥­ç¥€': 5}
        }
        score = jianchuxing_effects.get(jianchuxing, {}).get(event_type, 0)
        if score > 10:
            reason = f"{jianchuxing}æ—¥å¤§åˆ©{event_type}"
        elif score > 0:
            reason = f"{jianchuxing}æ—¥åˆ©{event_type}"
        elif score < -10:
            reason = f"{jianchuxing}æ—¥å¤§å¿Œ{event_type}"
        elif score < 0:
            reason = f"{jianchuxing}æ—¥å¿Œ{event_type}"
        else:
            reason = f"{jianchuxing}æ—¥å¹³å¸¸"
        return {'score': score, 'reason': reason}
    def get_huangdao_heidao(self, date):
        """è·å–é»„é“é»‘é“"""
        # é»„é“åäºŒç¥ï¼šé’é¾™ã€æ˜å ‚ã€å¤©åˆ‘ã€æœ±é›€ã€é‡‘åŒ®ã€å¤©å¾·ã€ç™½è™ã€ç‰å ‚ã€å¤©ç‰¢ã€å…ƒæ­¦ã€å¸å‘½ã€å‹¾é™ˆ
        huangdao_list = [
            {'name': 'é’é¾™', 'type': 'é»„é“'}, {'name': 'æ˜å ‚', 'type': 'é»„é“'}, {'name': 'å¤©åˆ‘', 'type': 'é»‘é“'},
            {'name': 'æœ±é›€', 'type': 'é»‘é“'}, {'name': 'é‡‘åŒ®', 'type': 'é»„é“'}, {'name': 'å¤©å¾·', 'type': 'é»„é“'},
            {'name': 'ç™½è™', 'type': 'é»‘é“'}, {'name': 'ç‰å ‚', 'type': 'é»„é“'}, {'name': 'å¤©ç‰¢', 'type': 'é»‘é“'},
            {'name': 'å…ƒæ­¦', 'type': 'é»‘é“'}, {'name': 'å¸å‘½', 'type': 'é»„é“'}, {'name': 'å‹¾é™ˆ', 'type': 'é»‘é“'}
        ]
        day_index = date.timetuple().tm_yday % 12
        return huangdao_list[day_index]
    def check_special_shensha_day(self, date, bazi_result):
        """æ£€æŸ¥ç‰¹æ®Šç¥ç…æ—¥"""
        day_master = bazi_result['day_master']
        # ç®€åŒ–çš„ç‰¹æ®Šæ—¥æ£€æŸ¥
        day_of_month = date.day
        # å¤©å¾·æ—¥ï¼ˆç®€åŒ–ï¼‰
        if day_of_month in [1, 8, 15, 22]:
            return {'score': 15, 'reason': 'å¤©å¾·å‰æ—¥'}
        # æœˆå¾·æ—¥ï¼ˆç®€åŒ–ï¼‰
        if day_of_month in [3, 10, 17, 24]:
            return {'score': 10, 'reason': 'æœˆå¾·å‰æ—¥'}
        # å¤©ä¹™è´µäººæ—¥ï¼ˆç®€åŒ–ï¼‰
        tianyi_map = {
            'ç”²': [1, 8], 'ä¹™': [2, 9], 'ä¸™': [3, 10], 'ä¸': [4, 11],
            'æˆŠ': [5, 12], 'å·±': [6, 13], 'åºš': [7, 14], 'è¾›': [8, 15],
            'å£¬': [9, 16], 'ç™¸': [10, 17]
        }
        if day_master in tianyi_map and day_of_month in tianyi_map[day_master]:
            return {'score': 12, 'reason': 'å¤©ä¹™è´µäººæ—¥'}
        return None
    def get_solar_term_influence(self, date):
        """è·å–èŠ‚æ°”å½±å“"""
        month = date.month
        day = date.day
        # ç®€åŒ–çš„èŠ‚æ°”å½±å“
        solar_terms = {
            (2, 4): {'name': 'ç«‹æ˜¥', 'score': 10, 'reason': 'ç«‹æ˜¥èŠ‚æ°”ï¼Œä¸‡ç‰©å¤è‹ï¼Œå®œå¼€å§‹æ–°äº‹'},
            (3, 6): {'name': 'æƒŠè›°', 'score': 8, 'reason': 'æƒŠè›°èŠ‚æ°”ï¼Œç”Ÿæœºå‹ƒå‘ï¼Œåˆ©åŠ¨åœŸå¼€å·¥'},
            (3, 21): {'name': 'æ˜¥åˆ†', 'score': 12, 'reason': 'æ˜¥åˆ†èŠ‚æ°”ï¼Œé˜´é˜³å¹³è¡¡ï¼Œå¤§å‰ä¹‹æ—¥'},
            (5, 6): {'name': 'ç«‹å¤', 'score': 8, 'reason': 'ç«‹å¤èŠ‚æ°”ï¼Œé˜³æ°”æ—ºç››ï¼Œåˆ©å¼€ä¸šåº†å…¸'},
            (6, 21): {'name': 'å¤è‡³', 'score': 5, 'reason': 'å¤è‡³èŠ‚æ°”ï¼Œé˜³æé˜´ç”Ÿï¼Œå®œé™ä¸å®œåŠ¨'},
            (8, 8): {'name': 'ç«‹ç§‹', 'score': 10, 'reason': 'ç«‹ç§‹èŠ‚æ°”ï¼Œæ”¶è·å­£èŠ‚ï¼Œåˆ©ç­¾çº¦åˆä½œ'},
            (9, 23): {'name': 'ç§‹åˆ†', 'score': 12, 'reason': 'ç§‹åˆ†èŠ‚æ°”ï¼Œé˜´é˜³å¹³è¡¡ï¼Œè¯¸äº‹çš†å®œ'},
            (11, 8): {'name': 'ç«‹å†¬', 'score': 5, 'reason': 'ç«‹å†¬èŠ‚æ°”ï¼Œé˜³æ°”æ”¶è—ï¼Œå®œé™å…»'},
            (12, 22): {'name': 'å†¬è‡³', 'score': 8, 'reason': 'å†¬è‡³èŠ‚æ°”ï¼Œé˜³æ°”åˆç”Ÿï¼Œåˆ©ç¥­ç¥€ç¥ˆç¦'}
        }
        for (term_month, term_day), term_info in solar_terms.items():
            if month == term_month and abs(day - term_day) <= 1:
                return term_info
        return None
    def analyze_auspicious_hours(self, event_type, bazi_result):
        """åˆ†æå‰æ—¶é€‰æ‹©"""
        analysis = []
        analysis.append("\nã€å‰æ—¶é€‰æ‹©ã€‘")
        day_master = bazi_result['day_master']
        day_element = bazi_result['day_master_element']
        # åäºŒæ—¶è¾°
        hours = [
            {'name': 'å­æ—¶', 'time': '23:00-01:00', 'element': 'æ°´', 'characteristics': 'é˜´æ°”æœ€é‡ï¼Œå®œé™ä¸å®œåŠ¨'},
            {'name': 'ä¸‘æ—¶', 'time': '01:00-03:00', 'element': 'åœŸ', 'characteristics': 'é˜´æ°”æ¸æ”¶ï¼Œå®œä¼‘æ¯å…»ç¥'},
            {'name': 'å¯…æ—¶', 'time': '03:00-05:00', 'element': 'æœ¨', 'characteristics': 'é˜³æ°”åˆç”Ÿï¼Œå®œç¥ˆç¦ç¥­ç¥€'},
            {'name': 'å¯æ—¶', 'time': '05:00-07:00', 'element': 'æœ¨', 'characteristics': 'æ—¥å‡ºä¸œæ–¹ï¼Œå®œå¼€å§‹æ–°äº‹'},
            {'name': 'è¾°æ—¶', 'time': '07:00-09:00', 'element': 'åœŸ', 'characteristics': 'æœæ°”è“¬å‹ƒï¼Œå®œåŠ¨åœŸå¼€å·¥'},
            {'name': 'å·³æ—¶', 'time': '09:00-11:00', 'element': 'ç«', 'characteristics': 'é˜³æ°”æ—ºç››ï¼Œå®œå¼€ä¸šåº†å…¸'},
            {'name': 'åˆæ—¶', 'time': '11:00-13:00', 'element': 'ç«', 'characteristics': 'é˜³æ°”æœ€ç››ï¼Œå®œé‡è¦æ´»åŠ¨'},
            {'name': 'æœªæ—¶', 'time': '13:00-15:00', 'element': 'åœŸ', 'characteristics': 'é˜³æ°”æ¸æ”¶ï¼Œå®œç­¾çº¦åˆä½œ'},
            {'name': 'ç”³æ—¶', 'time': '15:00-17:00', 'element': 'é‡‘', 'characteristics': 'é‡‘æ°”å½“ä»¤ï¼Œå®œå•†åŠ¡æ´»åŠ¨'},
            {'name': 'é…‰æ—¶', 'time': '17:00-19:00', 'element': 'é‡‘', 'characteristics': 'æ—¥è½è¥¿å±±ï¼Œå®œæ”¶å°¾å·¥ä½œ'},
            {'name': 'æˆŒæ—¶', 'time': '19:00-21:00', 'element': 'åœŸ', 'characteristics': 'é˜´æ°”æ¸ç”Ÿï¼Œå®œå®¶åº­èšä¼š'},
            {'name': 'äº¥æ—¶', 'time': '21:00-23:00', 'element': 'æ°´', 'characteristics': 'é˜´æ°”æ¸é‡ï¼Œå®œä¼‘æ¯è°ƒå…»'}
        ]
        # æ ¹æ®äº‹ä»¶ç±»å‹æ¨èæ—¶è¾°
        event_hour_preferences = {
            'ç»“å©š': ['å·³æ—¶', 'åˆæ—¶', 'æœªæ—¶'],  # é˜³æ°”æ—ºç››æ—¶
            'å¼€ä¸š': ['å·³æ—¶', 'åˆæ—¶', 'ç”³æ—¶'],  # å•†åŠ¡æ´»åŠ¨æ—¶
            'æ¬å®¶': ['è¾°æ—¶', 'å·³æ—¶', 'æœªæ—¶'],  # åŠ¨åœŸå¼€å·¥æ—¶
            'åŠ¨åœŸ': ['è¾°æ—¶', 'å·³æ—¶', 'åˆæ—¶'],  # é˜³æ°”æ—ºç››æ—¶
            'å‡ºè¡Œ': ['å¯æ—¶', 'è¾°æ—¶', 'å·³æ—¶'],  # æœæ°”è“¬å‹ƒæ—¶
            'ç­¾çº¦': ['å·³æ—¶', 'æœªæ—¶', 'ç”³æ—¶'],  # å•†åŠ¡åˆä½œæ—¶
            'ç¥­ç¥€': ['å¯…æ—¶', 'å¯æ—¶', 'è¾°æ—¶']   # ç¥ˆç¦ç¥­ç¥€æ—¶
        }
        preferred_hours = event_hour_preferences.get(event_type, ['å·³æ—¶', 'åˆæ—¶', 'æœªæ—¶'])
        analysis.append(f"â€¢ {event_type}æ¨èæ—¶è¾°ï¼š")
        for hour_name in preferred_hours:
            hour_info = next((h for h in hours if h['name'] == hour_name), None)
            if hour_info:
                # åˆ†ææ—¶è¾°ä¸æ—¥ä¸»çš„å…³ç³»
                hour_relation = self.get_wuxing_relation(hour_info['element'], day_element)
                relation_desc = self.get_hour_relation_description(hour_relation)
                analysis.append(f"  {hour_info['name']}ï¼ˆ{hour_info['time']}ï¼‰ï¼š{hour_info['characteristics']}")
                analysis.append(f"    äº”è¡Œå…³ç³»ï¼š{hour_info['element']}ä¸{day_element}{relation_desc}")
        # ä¸ªäººä¸“å±å‰æ—¶
        personal_hours = self.get_personal_auspicious_hours(day_master, day_element)
        if personal_hours:
            analysis.append(f"\nâ€¢ ä¸ªäººä¸“å±å‰æ—¶ï¼š{', '.join(personal_hours)}")
        # æ—¶è¾°ç¦å¿Œ
        analysis.append("\nâ€¢ æ—¶è¾°ç¦å¿Œï¼š")
        analysis.append("  å­æ—¶ã€ä¸‘æ—¶ï¼šé˜´æ°”é‡ï¼Œä¸å®œé‡è¦æ´»åŠ¨")
        analysis.append("  æˆŒæ—¶ã€äº¥æ—¶ï¼šé˜´æ°”ç”Ÿï¼Œä¸å®œå¼€å§‹æ–°äº‹")
        analysis.append("  å…·ä½“ç¦å¿Œéœ€ç»“åˆä¸ªäººå…«å­—åˆ†æ")
        return analysis
    def get_hour_relation_description(self, relation):
        """è·å–æ—¶è¾°å…³ç³»æè¿°"""
        descriptions = {
            'ç›¸ç”Ÿ': 'ç›¸ç”Ÿï¼Œæœ‰åŠ©è¿åŠ¿',
            'ç›¸å…‹': 'ç›¸å…‹ï¼Œéœ€è¦åŒ–è§£',
            'è¢«ç”Ÿ': 'è¢«ç”Ÿï¼Œæ¶ˆè€—ç²¾åŠ›',
            'è¢«å…‹': 'è¢«å…‹ï¼Œå‹åŠ›è¾ƒå¤§',
            'åŒç±»': 'åŒç±»ï¼ŒåŠ›é‡å¢å¼º'
        }
        return descriptions.get(relation, 'å…³ç³»å¹³å’Œ')
    def get_personal_auspicious_hours(self, day_master, day_element):
        """è·å–ä¸ªäººä¸“å±å‰æ—¶"""
        # æ ¹æ®æ—¥ä¸»å¤©å¹²ç¡®å®šä¸“å±å‰æ—¶
        personal_hour_map = {
            'ç”²': ['å¯…æ—¶', 'å¯æ—¶'],  # æœ¨æ—ºæ—¶
            'ä¹™': ['å¯…æ—¶', 'å¯æ—¶'],
            'ä¸™': ['å·³æ—¶', 'åˆæ—¶'],  # ç«æ—ºæ—¶
            'ä¸': ['å·³æ—¶', 'åˆæ—¶'],
            'æˆŠ': ['è¾°æ—¶', 'æœªæ—¶', 'æˆŒæ—¶'],  # åœŸæ—ºæ—¶
            'å·±': ['è¾°æ—¶', 'æœªæ—¶', 'æˆŒæ—¶'],
            'åºš': ['ç”³æ—¶', 'é…‰æ—¶'],  # é‡‘æ—ºæ—¶
            'è¾›': ['ç”³æ—¶', 'é…‰æ—¶'],
            'å£¬': ['äº¥æ—¶', 'å­æ—¶'],  # æ°´æ—ºæ—¶
            'ç™¸': ['äº¥æ—¶', 'å­æ—¶']
        }
        return personal_hour_map.get(day_master, [])
    def analyze_date_taboos(self, event_type, bazi_result):
        """åˆ†ææ‹©æ—¥ç¦å¿Œ"""
        analysis = []
        analysis.append("\nã€æ‹©æ—¥ç¦å¿Œã€‘")
        birth_year_branch = bazi_result['pillars']['year'][1]
        # é€šç”¨ç¦å¿Œ
        analysis.append("â€¢ é€šç”¨ç¦å¿Œï¼š")
        analysis.append("  ç ´æ—¥ã€é—­æ—¥ã€å¹³æ—¥ã€æ”¶æ—¥ç­‰å‡¶æ—¥")
        analysis.append("  é»‘é“å‡¶æ—¥ï¼šå¤©åˆ‘ã€æœ±é›€ã€ç™½è™ã€å¤©ç‰¢ã€å…ƒæ­¦ã€å‹¾é™ˆ")
        analysis.append("  ä¸‰å¨˜ç…æ—¥ï¼šåˆä¸‰ã€åˆä¸ƒã€åä¸‰ã€åå…«ã€å»¿äºŒã€å»¿ä¸ƒ")
        analysis.append("  æ¨å…¬å¿Œæ—¥ï¼šæ­£æœˆåä¸‰ã€äºŒæœˆåä¸€ã€ä¸‰æœˆåˆä¹ç­‰")
        # ä¸ªäººç¦å¿Œ
        analysis.append("\nâ€¢ ä¸ªäººç¦å¿Œï¼š")
        conflicts = self.get_conflicting_branches(birth_year_branch)
        analysis.append(f"  ä¸ç”Ÿå¹´{birth_year_branch}ç›¸å†²çš„{', '.join(conflicts)}æ—¥")
        analysis.append("  æœ¬å‘½å¹´éœ€è¦ç‰¹åˆ«è°¨æ…ï¼Œå®œé€‰æ‹©å¤©å¾·ã€æœˆå¾·å‰æ—¥")
        # äº‹ä»¶ç‰¹æ®Šç¦å¿Œ
        event_taboos = {
            'ç»“å©š': [
                "é¿å¼€æ–°å¨˜æœ¬å‘½å¹´æœˆ",
                "é¿å¼€å­¤é¸¾æ—¥ã€å¯¡å®¿æ—¥",
                "é¿å¼€ç ´æœˆã€è´¥æœˆ",
                "é¿å¼€çˆ¶æ¯ç”Ÿæ—¥å¿Œæ—¥"
            ],
            'å¼€ä¸š': [
                "é¿å¼€åº—ä¸»æœ¬å‘½å¹´æœˆ",
                "é¿å¼€ç ´è´¢æ—¥ã€åŠ«è´¢æ—¥",
                "é¿å¼€ä¸è¡Œä¸šç›¸å†²çš„æ—¥å­",
                "é¿å¼€ç«äº‰å¯¹æ‰‹å¼€ä¸šæ—¥"
            ],
            'æ¬å®¶': [
                "é¿å¼€å®¶ä¸»æœ¬å‘½å¹´æœˆ",
                "é¿å¼€ä¸æ–°å±…æ–¹ä½ç›¸å†²çš„æ—¥å­",
                "é¿å¼€åœŸç‹ç”¨äº‹æ—¥",
                "é¿å¼€å®¶ä¸­æœ‰å­•å¦‡çš„æœˆä»½"
            ],
            'åŠ¨åœŸ': [
                "é¿å¼€å¤ªå²æ–¹ä½",
                "é¿å¼€ä¸‰ç…æ–¹ä½",
                "é¿å¼€åœŸç‹ç”¨äº‹æ—¥",
                "é¿å¼€åœ°ä¸»ç”Ÿæ°”æ—¥"
            ]
        }
        if event_type in event_taboos:
            analysis.append(f"\nâ€¢ {event_type}ç‰¹æ®Šç¦å¿Œï¼š")
            for taboo in event_taboos[event_type]:
                analysis.append(f"  {taboo}")
        # æœˆä»½ç¦å¿Œ
        analysis.append("\nâ€¢ æœˆä»½ç¦å¿Œï¼š")
        analysis.append("  å†œå†ä¸ƒæœˆï¼šé¬¼æœˆï¼Œè¯¸äº‹ä¸å®œ")
        analysis.append("  å†œå†æ­£æœˆï¼šå²é¦–ï¼Œä¸å®œåŠ¨åœŸ")
        analysis.append("  å†œå†äº”æœˆï¼šæ¯’æœˆï¼Œä¸å®œç»“å©š")
        analysis.append("  å†œå†å…­æœˆï¼šåŠå¹´ï¼Œä¸å®œæ¬å®¶")
        return analysis
    def get_date_resolution_methods(self, event_type):
        """è·å–æ‹©æ—¥åŒ–è§£æ–¹æ³•"""
        analysis = []
        analysis.append("\nã€åŒ–è§£æ–¹æ³•ã€‘")
        # é€šç”¨åŒ–è§£æ–¹æ³•
        analysis.append("â€¢ é€šç”¨åŒ–è§£ï¼š")
        analysis.append("  é€‰æ‹©å¤©å¾·ã€æœˆå¾·ã€å¤©ä¹™è´µäººç­‰å‰æ—¥")
        analysis.append("  è¿›è¡Œç¥ˆç¦ä»ªå¼ï¼Œè¯·ç¥æ˜æŠ¤ä½‘")
        analysis.append("  ä½©æˆ´ç›¸åº”çš„æŠ¤èº«ç¬¦æˆ–å‰ç¥¥ç‰©")
        analysis.append("  åœ¨å‰æ—¶è¿›è¡Œé‡è¦ç¯èŠ‚")
        # ç‰¹æ®ŠåŒ–è§£æ–¹æ³•
        special_methods = {
            'ç»“å©š': [
                "æ–°å¨˜ä½©æˆ´çº¢è‰²é¥°å“åŒ–è§£ç…æ°”",
                "é€‰æ‹©åŒæ•°æ—¥æœŸï¼Œå¯“æ„æˆåŒæˆå¯¹",
                "åœ¨å©šç¤¼ç°åœºæ‘†æ”¾é¾™å‡¤å‘ˆç¥¥è£…é¥°",
                "è¯·é•¿è¾ˆä¸»æŒä»ªå¼ï¼Œå¢åŠ ç¦æ°”"
            ],
            'å¼€ä¸š': [
                "åœ¨åº—é—¨å£æ‘†æ”¾æ‹›è´¢çŒ«æˆ–è²”è²…",
                "é€‰æ‹©è´¢æ˜Ÿå½“ä»¤çš„æ—¶è¾°å¼€ä¸š",
                "é‚€è¯·è´µäººå‰ªå½©ï¼Œå¢åŠ äººæ°”",
                "ç‡ƒæ”¾é­ç‚®é©±é‚ªé¿ç…"
            ],
            'æ¬å®¶': [
                "å…ˆæ¬ç±³ç¼¸å’Œå¨å…·ï¼Œå¯“æ„è¡£é£Ÿæ— å¿§",
                "åœ¨æ–°å±…å››è§’æ’’ç›ç±³é©±é‚ª",
                "ç‚¹ç‡ƒæª€é¦™å‡€åŒ–ç©ºé—´",
                "é‚€è¯·äº²å‹èšé¤å¢åŠ äººæ°”"
            ],
            'åŠ¨åœŸ': [
                "åœ¨åŠ¨åœŸå‰è¿›è¡Œç¥­åœŸä»ªå¼",
                "åœ¨æ–½å·¥ç°åœºæ‘†æ”¾æ³°å±±çŸ³",
                "é€‰æ‹©é»„é“å‰æ—¥å¼€å·¥",
                "è¯·é£æ°´å¸ˆç°åœºæŒ‡å¯¼"
            ]
        }
        if event_type in special_methods:
            analysis.append(f"\nâ€¢ {event_type}ä¸“ç”¨åŒ–è§£ï¼š")
            for method in special_methods[event_type]:
                analysis.append(f"  {method}")
        # åº”æ€¥åŒ–è§£
        analysis.append("\nâ€¢ åº”æ€¥åŒ–è§£ï¼š")
        analysis.append("  å¦‚æœå¿…é¡»åœ¨ä¸å‰æ—¥è¿›è¡Œï¼Œå¯é€‰æ‹©å‰æ—¶")
        analysis.append("  è¿›è¡Œç®€å•çš„ç¥ˆç¦ä»ªå¼")
        analysis.append("  ä½©æˆ´æŠ¤èº«ç¬¦æˆ–å‰ç¥¥ç‰©")
        analysis.append("  äº‹åè¿›è¡Œè¡¥æ•‘ä»ªå¼")
        # æ³¨æ„äº‹é¡¹
        analysis.append("\nâ€¢ æ³¨æ„äº‹é¡¹ï¼š")
        analysis.append("  æ‹©æ—¥åªæ˜¯è¾…åŠ©ï¼Œä¸ªäººåŠªåŠ›æ›´é‡è¦")
        analysis.append("  ç»“åˆå®é™…æƒ…å†µï¼Œä¸å¯è¿‡åˆ†è¿·ä¿¡")
        analysis.append("  é‡è¦äº‹ä»¶å»ºè®®å’¨è¯¢ä¸“ä¸šæ‹©æ—¥å¸ˆ")
        analysis.append("  ä¿æŒç§¯æå¿ƒæ€ï¼Œè¯šå¿ƒç¥ˆç¦")
        return analysis
    def get_monthly_auspicious_calendar(self, year, month, bazi_result):
        """è·å–æœˆåº¦å‰æ—¥æ—¥å†"""
        analysis = []
        analysis.append(f"ã€{year}å¹´{month}æœˆå‰æ—¥æ—¥å†ã€‘")
        from datetime import datetime, timedelta
        import calendar
        # è·å–æœˆä»½ä¿¡æ¯
        month_days = calendar.monthrange(year, month)[1]
        month_start = datetime(year, month, 1)
        # åˆ†ææ¯ä¸€å¤©
        daily_analysis = []
        for day in range(1, month_days + 1):
            current_date = datetime(year, month, day)
            lunar_info = self.get_lunar_date_info(current_date)
            # ç®€å•çš„å‰å‡¶åˆ¤æ–­
            jianchuxing = self.get_jianchuxing(current_date)
            huangdao = self.get_huangdao_heidao(current_date)
            # è¯„çº§
            if huangdao['type'] == 'é»„é“' and jianchuxing in ['æˆ', 'å¼€', 'æ»¡', 'å®š']:
                level = 'å¤§å‰'
            elif huangdao['type'] == 'é»„é“' or jianchuxing in ['æˆ', 'å¼€', 'æ»¡', 'å®š']:
                level = 'å‰'
            elif huangdao['type'] == 'é»‘é“' and jianchuxing in ['ç ´', 'é—­']:
                level = 'å¤§å‡¶'
            elif huangdao['type'] == 'é»‘é“' or jianchuxing in ['ç ´', 'é—­']:
                level = 'å‡¶'
            else:
                level = 'å¹³'
            daily_analysis.append({
                'day': day,
                'weekday': current_date.strftime('%a'),
                'lunar': lunar_info['description'],
                'jianchuxing': jianchuxing,
                'huangdao': huangdao['name'],
                'level': level
            })
        # æŒ‰å‘¨æ˜¾ç¤º
        analysis.append("\næ—¥æœŸæ ¼å¼ï¼šé˜³å†æ—¥æœŸ å†œå† å»ºé™¤ é»„é“é»‘é“ å‰å‡¶")
        analysis.append("=" * 50)
        week_days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥']
        current_week = []
        for day_info in daily_analysis:
            current_date = datetime(year, month, day_info['day'])
            weekday_index = current_date.weekday()
            # å¦‚æœæ˜¯å‘¨ä¸€ï¼Œå¼€å§‹æ–°çš„ä¸€å‘¨
            if weekday_index == 0 and current_week:
                # æ˜¾ç¤ºä¸Šä¸€å‘¨
                self.display_week(analysis, current_week)
                current_week = []
            current_week.append(day_info)
        # æ˜¾ç¤ºæœ€åä¸€å‘¨
        if current_week:
            self.display_week(analysis, current_week)
        # æœˆåº¦æ€»ç»“
        analysis.append("\nã€æœˆåº¦æ€»ç»“ã€‘")
        daji_days = [d['day'] for d in daily_analysis if d['level'] == 'å¤§å‰']
        ji_days = [d['day'] for d in daily_analysis if d['level'] == 'å‰']
        if daji_days:
            analysis.append(f"â€¢ å¤§å‰æ—¥ï¼š{', '.join(map(str, daji_days))}æ—¥")
        if ji_days:
            analysis.append(f"â€¢ å‰æ—¥ï¼š{', '.join(map(str, ji_days[:10]))}æ—¥{'ç­‰' if len(ji_days) > 10 else ''}")
        analysis.append("â€¢ å»ºè®®ï¼šé‡è¦äº‹ä»¶é€‰æ‹©å¤§å‰æ—¥ï¼Œä¸€èˆ¬äº‹åŠ¡é€‰æ‹©å‰æ—¥")
        return "\n".join(analysis)
    def display_week(self, analysis, week_days):
        """æ˜¾ç¤ºä¸€å‘¨çš„æ—¥æœŸä¿¡æ¯"""
        if not week_days:
            return
        week_line = ""
        for day_info in week_days:
            level_symbol = {
                'å¤§å‰': 'â˜…â˜…',
                'å‰': 'â˜…',
                'å¹³': 'â—‹',
                'å‡¶': 'Ã—',
                'å¤§å‡¶': 'Ã—Ã—'
            }
            symbol = level_symbol.get(day_info['level'], 'â—‹')
            week_line += f"{day_info['day']:2d}{symbol} "
        analysis.append(week_line)
    def suggest_alternative_dates(self, event_type, original_date, bazi_result):
        """å»ºè®®æ›¿ä»£æ—¥æœŸ"""
        analysis = []
        analysis.append("ã€æ›¿ä»£æ—¥æœŸå»ºè®®ã€‘")
        from datetime import datetime, timedelta
        # åœ¨åŸæ—¥æœŸå‰å15å¤©å†…å¯»æ‰¾æ›¿ä»£æ—¥æœŸ
        start_date = original_date - timedelta(days=15)
        end_date = original_date + timedelta(days=15)
        alternative_dates = []
        current_date = start_date
        while current_date <= end_date:
            if current_date != original_date:
                lunar_info = self.get_lunar_date_info(current_date)
                is_auspicious = self.check_date_auspiciousness(current_date, lunar_info, event_type, bazi_result)
                if is_auspicious['suitable']:
                    alternative_dates.append({
                        'date': current_date,
                        'score': is_auspicious['score'],
                        'reason': is_auspicious['reason']
                    })
            current_date += timedelta(days=1)
        # æŒ‰è¯„åˆ†æ’åº
        alternative_dates.sort(key=lambda x: x['score'], reverse=True)
        if alternative_dates:
            analysis.append(f"â€¢ åœ¨åŸå®šæ—¥æœŸå‰å15å¤©å†…ï¼Œæ¨èä»¥ä¸‹æ›¿ä»£æ—¥æœŸï¼š")
            for i, date_info in enumerate(alternative_dates[:5], 1):
                date_str = date_info['date'].strftime('%Yå¹´%mæœˆ%dæ—¥')
                weekday = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'][date_info['date'].weekday()]
                analysis.append(f"  {i}. {date_str}ï¼ˆ{weekday}ï¼‰- è¯„åˆ†ï¼š{date_info['score']}/100")
                analysis.append(f"     {date_info['reason']}")
        else:
            analysis.append("â€¢ åœ¨æŒ‡å®šèŒƒå›´å†…æœªæ‰¾åˆ°æ›´å¥½çš„æ›¿ä»£æ—¥æœŸ")
            analysis.append("â€¢ å»ºè®®ï¼šæ‰©å¤§æ—¶é—´èŒƒå›´æˆ–é€‰æ‹©åŒ–è§£æ–¹æ³•")
        return "\n".join(analysis)
    def analyze_floor_comprehensive(self, current_floor, total_floors, house_element):
        """ç»¼åˆæ¥¼å±‚åˆ†æ"""
        # æ¥¼å±‚äº”è¡Œå¯¹åº”
        floor_elements = {
            1: "æ°´", 2: "ç«", 3: "æœ¨", 4: "é‡‘", 5: "åœŸ",
            6: "æ°´", 7: "ç«", 8: "æœ¨", 9: "é‡‘", 0: "åœŸ"
        }
        floor_element = floor_elements.get(current_floor % 10, "åœŸ")
        # äº”è¡Œç›¸ç”Ÿç›¸å…‹åˆ†æ
        element_relations = {
            ("æ°´", "æœ¨"): "ç›¸ç”Ÿï¼Œæ°´ç”Ÿæœ¨ï¼Œæœ‰åˆ©å‘å±•",
            ("æœ¨", "ç«"): "ç›¸ç”Ÿï¼Œæœ¨ç”Ÿç«ï¼Œäº‹ä¸šå…´æ—º",
            ("ç«", "åœŸ"): "ç›¸ç”Ÿï¼Œç«ç”ŸåœŸï¼Œç¨³å®šå‘å±•",
            ("åœŸ", "é‡‘"): "ç›¸ç”Ÿï¼ŒåœŸç”Ÿé‡‘ï¼Œè´¢è¿äº¨é€š",
            ("é‡‘", "æ°´"): "ç›¸ç”Ÿï¼Œé‡‘ç”Ÿæ°´ï¼Œæ™ºæ…§å¢é•¿",
            ("æ°´", "ç«"): "ç›¸å…‹ï¼Œæ°´ç«ä¸å®¹ï¼Œéœ€è¦è°ƒå’Œ",
            ("ç«", "é‡‘"): "ç›¸å…‹ï¼Œç«å…‹é‡‘ï¼Œå®¹æ˜“å†²çª",
            ("é‡‘", "æœ¨"): "ç›¸å…‹ï¼Œé‡‘å…‹æœ¨ï¼Œå‘å±•å—é˜»",
            ("æœ¨", "åœŸ"): "ç›¸å…‹ï¼Œæœ¨å…‹åœŸï¼Œæ ¹åŸºä¸ç¨³",
            ("åœŸ", "æ°´"): "ç›¸å…‹ï¼ŒåœŸå…‹æ°´ï¼Œé˜»ç¢æµé€š"
        }
        relation = element_relations.get((house_element, floor_element), "éœ€è¦å…·ä½“åˆ†æ")
        # æ¥¼å±‚é«˜åº¦åˆ†æ
        if current_floor <= 3:
            height_analysis = "ä½å±‚ï¼šæ¥åœ°æ°”è¶³ï¼Œç¨³å®šæ€§å¥½ï¼Œä½†é‡‡å…‰å¯èƒ½ä¸è¶³"
        elif current_floor <= 7:
            height_analysis = "ä¸­å±‚ï¼šé‡‡å…‰å……è¶³ï¼Œè§†é‡å¼€é˜”ï¼Œæ˜¯ç†æƒ³çš„å±…ä½é«˜åº¦"
        elif current_floor <= 15:
            height_analysis = "é«˜å±‚ï¼šè§†é‡æä½³ï¼Œä½†é£åŠ¿è¾ƒå¤§ï¼Œéœ€è¦æ³¨æ„ä¿æš–"
        else:
            height_analysis = "è¶…é«˜å±‚ï¼šè¿œç¦»åœ°æ°”ï¼Œéœ€è¦ç‰¹åˆ«è°ƒç†ä»¥å¢å¼ºç¨³å®šæ€§"
        return {
            "floor_element": floor_element,
            "element_relation": relation,
            "height_analysis": height_analysis,
            "floor_ratio": f"{current_floor}/{total_floors}"
        }
    def analyze_area_comprehensive(self, area, house_element):
        """ç»¼åˆé¢ç§¯åˆ†æ"""
        if area < 60:
            size_analysis = {
                "level": "åå°",
                "desc": "ç©ºé—´ç´§å‡‘ï¼Œéœ€è¦åˆç†å¸ƒå±€ä»¥èšæ°”",
                "suggestion": "ä½¿ç”¨æ˜äº®è‰²å½©ï¼Œå¢åŠ é•œå­æ‰©å¤§ç©ºé—´æ„Ÿ",
                "score": 75
            }
        elif area <= 120:
            size_analysis = {
                "level": "é€‚ä¸­",
                "desc": "é¢ç§¯é€‚å®œï¼Œå®¹æ˜“èšæ°”æ—ºè¿",
                "suggestion": "åˆç†åˆ†åŒºï¼Œä¿æŒç©ºæ°”æµé€š",
                "score": 90
            }
        elif area <= 200:
            size_analysis = {
                "level": "å®½æ•",
                "desc": "ç©ºé—´å……è¶³ï¼Œä½†éœ€è¦æ³¨æ„èšæ°”",
                "suggestion": "é€‚å½“åˆ†éš”ç©ºé—´ï¼Œé¿å…è¿‡äºç©ºæ—·",
                "score": 85
            }
        else:
            size_analysis = {
                "level": "è¿‡å¤§",
                "desc": "ç©ºé—´è¿‡å¤§ï¼Œå®¹æ˜“æ•£æ°”æ¼è´¢",
                "suggestion": "éœ€è¦åˆç†åˆ†éš”ï¼Œå¢åŠ å®¶å…·èšæ°”",
                "score": 70
            }
        return size_analysis
    def analyze_special_needs_comprehensive(self, need, direction_info):
        """ç»¼åˆç‰¹æ®Šéœ€æ±‚åˆ†æ"""
        need_layouts = {
            "æ—ºè´¢è¿": {
                "primary": f"åœ¨{direction_info.get('gua', 'ç›¸åº”')}çš„è´¢ä½æ‘†æ”¾èšå®ç›†æˆ–é‡‘èŸ¾",
                "secondary": "å®¢å…ä¸œå—è§’æ”¾ç½®ç»¿è‰²æ¤ç‰©ï¼Œè±¡å¾ç”Ÿæœºå‹ƒå‹ƒ",
                "colors": "é‡‘è‰²ã€ç»¿è‰²ä¸ºä¸»ï¼Œé¿å…çº¢è‰²è¿‡å¤š",
                "items": "æ°´æ™¶çƒã€æ‹›è´¢æ ‘ã€é‡‘å…ƒå®æ‘†ä»¶",
                "taboo": "é¿å…åœ¨è´¢ä½æ”¾ç½®é‡ç‰©æˆ–åƒåœ¾æ¡¶"
            },
            "æ—ºäº‹ä¸š": {
                "primary": "åœ¨æ–‡æ˜Œä½æ‘†æ”¾æ–‡æ˜Œå¡”æˆ–æ°´æ™¶çƒ",
                "secondary": "ä¹¦æˆ¿æˆ–åŠå…¬åŒºåŸŸä¿æŒæ•´æ´æ˜äº®",
                "colors": "è“è‰²ã€ç»¿è‰²ä¸ºä¸»ï¼Œå¢å¼ºæ™ºæ…§è¿",
                "items": "æ–‡æˆ¿å››å®ã€ç«¹å­ã€æ°´æ™¶ç¬”æ¶",
                "taboo": "é¿å…åœ¨æ–‡æ˜Œä½å †æ”¾æ‚ç‰©"
            },
            "æ—ºæ¡ƒèŠ±": {
                "primary": "åœ¨æ¡ƒèŠ±ä½æ‘†æ”¾ç²‰æ°´æ™¶æˆ–é²œèŠ±",
                "secondary": "å§å®¤ä¿æŒæ¸©é¦¨æµªæ¼«çš„æ°›å›´",
                "colors": "ç²‰è‰²ã€çº¢è‰²ä¸ºä¸»ï¼Œå¢å¼ºæ„Ÿæƒ…è¿",
                "items": "æˆå¯¹æ‘†ä»¶ã€é²œèŠ±ã€ç²‰æ°´æ™¶",
                "taboo": "é¿å…åœ¨æ¡ƒèŠ±ä½æ”¾ç½®ä»™äººæŒç­‰å¸¦åˆºæ¤ç‰©"
            },
            "æ—ºå¥åº·": {
                "primary": "ä¿æŒå®¤å†…ç©ºæ°”æµé€šï¼Œå¤šæ”¾ç»¿è‰²æ¤ç‰©",
                "secondary": "å¨æˆ¿å’Œå«ç”Ÿé—´ä¿æŒæ¸…æ´å¹²ç‡¥",
                "colors": "ç»¿è‰²ã€ç™½è‰²ä¸ºä¸»ï¼Œè¥é€ æ¸…æ–°ç¯å¢ƒ",
                "items": "ç©ºæ°”å‡€åŒ–æ¤ç‰©ã€å¥åº·æ°´æ™¶ã€è‘«èŠ¦",
                "taboo": "é¿å…åœ¨å¥åº·ä½æ”¾ç½®æ¯èæ¤ç‰©"
            },
            "æ—ºå­¦ä¸š": {
                "primary": "åœ¨æ–‡æ˜Œä½æ‘†æ”¾æ–‡æ˜Œå¡”æˆ–æ¯›ç¬”",
                "secondary": "ä¹¦æˆ¿å…‰çº¿å……è¶³ï¼Œæ¡Œæ¤…æ‘†æ”¾å¾—å½“",
                "colors": "è“è‰²ã€ç»¿è‰²ä¸ºä¸»ï¼Œæœ‰åŠ©äºé›†ä¸­æ³¨æ„åŠ›",
                "items": "æ–‡æ˜Œå¡”ã€æ°´æ™¶çƒã€ç«¹å­ã€æ–‡æˆ¿å››å®",
                "taboo": "é¿å…ä¹¦æ¡Œå¯¹ç€å•æ‰€æˆ–å¨æˆ¿"
            }
        }
        return need_layouts.get(need, {
            "primary": "æ ¹æ®å…·ä½“éœ€æ±‚è¿›è¡Œä¸ªæ€§åŒ–å¸ƒå±€",
            "secondary": "ä¿æŒç¯å¢ƒæ•´æ´ï¼Œæ°”åœºæµé€š",
            "colors": "æ ¹æ®äº”è¡Œå–œå¿Œé€‰æ‹©åˆé€‚é¢œè‰²",
            "items": "é€‰æ‹©ä¸éœ€æ±‚ç›¸ç¬¦çš„é£æ°´ç”¨å“",
            "taboo": "é¿å…ä¸ç›®æ ‡ç›¸å†²çªçš„å¸ƒç½®"
        })
    def analyze_floor(self, current_floor, total_floors):
        """åˆ†ææ¥¼å±‚é£æ°´"""
        # æ¥¼å±‚äº”è¡Œå¯¹åº”ï¼ˆç®€åŒ–ç‰ˆï¼‰
        floor_wuxing = {
            1: "æ°´", 2: "ç«", 3: "æœ¨", 4: "é‡‘", 5: "åœŸ",
            6: "æ°´", 7: "ç«", 8: "æœ¨", 9: "é‡‘", 0: "åœŸ"
        }
        floor_element = floor_wuxing.get(current_floor % 10, "åœŸ")
        analysis = f"æ¥¼å±‚äº”è¡Œï¼š{floor_element}\n"
        if current_floor <= 3:
            analysis += "ä½å±‚ï¼šæ¥åœ°æ°”ï¼Œç¨³å®šæ€§å¥½ï¼Œä½†å¯èƒ½é‡‡å…‰ä¸è¶³"
        elif current_floor <= total_floors // 2:
            analysis += "ä¸­å±‚ï¼šå¹³è¡¡æ€§å¥½ï¼Œé‡‡å…‰å……è¶³ï¼Œæ˜¯ç†æƒ³é€‰æ‹©"
        else:
            analysis += "é«˜å±‚ï¼šè§†é‡å¼€é˜”ï¼Œä½†é£å¤§æ°”æ•£ï¼Œéœ€è¦èšæ°”"
        return {
            'element': floor_element,
            'description': analysis,
            'score': 75 if current_floor <= total_floors // 2 else 65
        }
    def analyze_area(self, area):
        """åˆ†æé¢ç§¯é£æ°´"""
        if area < 60:
            return {"level": "åå°", "desc": "ç©ºé—´ç´§å‡‘ï¼Œéœ€è¦åˆç†å¸ƒå±€", "score": 65}
        elif area <= 120:
            return {"level": "é€‚ä¸­", "desc": "é¢ç§¯é€‚å®œï¼Œåˆ©äºèšæ°”", "score": 85}
        elif area <= 200:
            return {"level": "å®½æ•", "desc": "ç©ºé—´å……è¶³ï¼Œéœ€è¦é€‚å½“åˆ†éš”", "score": 80}
        else:
            return {"level": "è¿‡å¤§", "desc": "ç©ºé—´è¿‡å¤§ï¼Œå®¹æ˜“æ•£æ°”", "score": 70}
    def analyze_special_needs(self, need, _direction):
        """åˆ†æç‰¹æ®Šéœ€æ±‚"""
        need_suggestions = {
            "å‚¬æ—ºäº‹ä¸š": "å»ºè®®åœ¨åŠå…¬åŒºåŸŸæ‘†æ”¾æ–‡æ˜Œå¡”ï¼Œé€‰æ‹©æœå‘æœ‰åˆ©çš„ä½ç½®åŠå…¬",
            "å¢è¿›è´¢è¿": "å»ºè®®åœ¨è´¢ä½æ‘†æ”¾æ‹›è´¢æ¤ç‰©ï¼Œä¿æŒè´¢ä½æ¸…æ´æ˜äº®",
            "æ”¹å–„å¥åº·": "å»ºè®®å¢åŠ ç»¿è‰²æ¤ç‰©ï¼Œä¿æŒç©ºæ°”æµé€šï¼Œé¿å…å°–è§’å†²å°„",
            "ä¿ƒè¿›å­¦ä¸š": "å»ºè®®åœ¨æ–‡æ˜Œä½æ‘†æ”¾ä¹¦æ¡Œï¼Œä¿æŒå­¦ä¹ ç¯å¢ƒå®‰é™æ•´æ´",
            "å’Œè°å®¶åº­": "å»ºè®®å®¢å…å¸ƒå±€æ¸©é¦¨ï¼Œé¿å…é•œå­å¯¹åºŠï¼Œä¿æŒå®¶åº­å’Œç¦",
            "æ‹›æ¡ƒèŠ±": "å»ºè®®åœ¨æ¡ƒèŠ±ä½æ‘†æ”¾é²œèŠ±ï¼Œä¿æŒä¸ªäººé­…åŠ›å’Œç¤¾äº¤æ´»è·ƒ"
        }
        return need_suggestions.get(need, "ç»¼åˆè°ƒç†ï¼Œä¿æŒäº”è¡Œå¹³è¡¡")
    def calculate_overall_score(self, direction_info, floor_info, area_info):
        """è®¡ç®—ç»¼åˆè¯„åˆ†"""
        direction_score = direction_info.get('score', 60)
        floor_score = floor_info.get('score', 70)
        area_score = area_info.get('score', 75)
        # åŠ æƒå¹³å‡
        overall = (direction_score * 0.4 + floor_score * 0.3 + area_score * 0.3)
        return int(overall)
    def display_fengshui_result(self, result):
        """æ˜¾ç¤ºé£æ°´åˆ†æç»“æœ - åŸºäºæƒå¨é£æ°´å­¦è‘—ä½œçš„å…¨é¢åˆ†æ"""
        direction_info = result['direction_info']
        flying_star = result['flying_star']
        floor_analysis = result['floor_analysis']
        area_analysis = result['area_analysis']
        special_layout = result['special_layout']
        bazhai_analysis = result.get('bazhai_analysis', {})

        result_text = f"""ğŸ  é£æ°´åˆ†ææŠ¥å‘Š
åŸºäºã€Šé˜³å®…ä¸‰è¦ã€‹ã€Šå…«å®…æ˜é•œã€‹ã€Šç„ç©ºé£æ˜Ÿã€‹ç­‰æƒå¨é£æ°´å­¦è‘—ä½œ
ã€åŸºæœ¬ä¿¡æ¯ã€‘
é£æ°´ç±»å‹ï¼š{result['type']}
æˆ¿å±‹æœå‘ï¼š{direction_info['gua']} - {direction_info['level']}
ç»¼åˆè¯„åˆ†ï¼š{result['overall_score']}åˆ†
ã€å…«å¦æœå‘åˆ†æã€‘ï¼ˆã€Šé˜³å®…ä¸‰è¦ã€‹ç†è®ºï¼‰
å¦ä½ï¼š{direction_info['gua']}
äº”è¡Œï¼š{direction_info['element']}
ç­‰çº§ï¼š{direction_info['level']}ï¼ˆ{result['overall_score']}åˆ†ï¼‰
è¯´æ˜ï¼š{direction_info['desc']}
å®¶åº­å½±å“ï¼š{direction_info['family_benefit']}
äº‹ä¸šæ–¹å‘ï¼š{direction_info['career']}
å¥åº·å…³è”ï¼š{direction_info['health']}
è´¢è¿åˆ†æï¼š{direction_info['wealth']}
å¸ƒå±€å»ºè®®ï¼š{direction_info['layout']}
ã€ç„ç©ºé£æ˜Ÿåˆ†æã€‘ï¼ˆã€Šç„ç©ºé£æ˜Ÿã€‹ç†è®ºï¼‰
å½“è¿æ˜Ÿï¼š{flying_star.get('floor_star', 'æœªçŸ¥')}æ˜Ÿ
è´¢æ˜Ÿæ–¹ä½ï¼š{flying_star.get('key_positions', {}).get('center', {}).get('analysis', 'éœ€è¦å…·ä½“åˆ†æ')}
æ–‡æ˜Œåˆ†æï¼š{flying_star.get('key_positions', {}).get('south', {}).get('analysis', 'éœ€è¦å…·ä½“åˆ†æ')}
æ¡ƒèŠ±å½±å“ï¼š{flying_star.get('key_positions', {}).get('west', {}).get('analysis', 'éœ€è¦å…·ä½“åˆ†æ')}
å¥åº·æ³¨æ„ï¼š{flying_star.get('key_positions', {}).get('east', {}).get('analysis', 'éœ€è¦å…·ä½“åˆ†æ')}
æ¥¼å±‚ç‰¹ç‚¹ï¼š{flying_star.get('floor_effect', 'éœ€è¦å…·ä½“åˆ†æ')}
ã€æ¥¼å±‚äº”è¡Œåˆ†æã€‘ï¼ˆã€Šå…«å®…æ˜é•œã€‹ç†è®ºï¼‰
æ¥¼å±‚äº”è¡Œï¼š{floor_analysis['floor_element']}
äº”è¡Œå…³ç³»ï¼š{floor_analysis['element_relation']}
é«˜åº¦åˆ†æï¼š{floor_analysis['height_analysis']}
æ¥¼å±‚æ¯”ä¾‹ï¼š{floor_analysis['floor_ratio']}
ã€å…«å®…é£æ°´åˆ†æã€‘ï¼ˆã€Šå…«å®…æ˜é•œã€‹ç†è®ºï¼‰ğŸ”¥ P0æ–°å¢
"""

        # ğŸ”¥ P0ä¿®å¤ï¼šæ˜¾ç¤ºå‘½å¦ä¿¡æ¯
        if bazhai_analysis.get('mingua'):
            mingua_info = bazhai_analysis['mingua']
            result_text += f"""å‘½å¦è®¡ç®—ï¼š{mingua_info.get('description', 'æœªçŸ¥')}
"""

            # æ˜¾ç¤ºå‘½å®…åŒ¹é…æƒ…å†µ
            if bazhai_analysis.get('mingua_match'):
                match_info = bazhai_analysis['mingua_match']
                result_text += f"""å‘½å®…åŒ¹é…ï¼š{match_info.get('level', 'æœªçŸ¥')} - {match_info.get('description', '')}
åŒ¹é…å»ºè®®ï¼š{match_info.get('advice', '')}
"""
        else:
            # å¦‚æœæ²¡æœ‰å‘½å¦ä¿¡æ¯ï¼Œæç¤ºç”¨æˆ·
            result_text += """ï¼ˆæç¤ºï¼šæœªæä¾›å…«å­—ä¿¡æ¯ï¼Œæ— æ³•è®¡ç®—ä¸ªäººå‘½å¦ã€‚å»ºè®®å…ˆè¿›è¡Œå…«å­—åˆ†æï¼Œç„¶åå†è¿›è¡Œé£æ°´åˆ†æä»¥è·å¾—ä¸ªæ€§åŒ–å»ºè®®ï¼‰
"""

        # æ˜¾ç¤ºå…«å®…å‰å‡¶æ–¹ä½
        if bazhai_analysis.get('positions'):
            result_text += """\nå…«å®…å‰å‡¶æ–¹ä½ï¼š
"""
            positions = bazhai_analysis['positions']
            for direction_name, info in positions.items():
                result_text += f"  {direction_name}ï¼š{info.get('type', '')}ï¼ˆ{info.get('level', '')}ï¼‰- {info.get('benefit', '')}ï¼Œé€‚åˆ{info.get('suitable', '')}\n"

        # æ˜¾ç¤ºé‡ç‚¹å»ºè®®
        if bazhai_analysis.get('key_recommendations'):
            rec = bazhai_analysis['key_recommendations']
            result_text += f"""
é‡ç‚¹å»ºè®®ï¼š
  æœ€ä½³å¤§é—¨æ–¹ä½ï¼š{rec.get('best_door', 'æœªçŸ¥')}
  æœ€ä½³å§å®¤æ–¹ä½ï¼š{rec.get('best_bedroom', 'æœªçŸ¥')}
  æœ€ä½³å¨æˆ¿æ–¹ä½ï¼š{rec.get('best_kitchen', 'æœªçŸ¥')}
  æœ€ä½³ä¹¦æˆ¿æ–¹ä½ï¼š{rec.get('best_study', 'æœªçŸ¥')}
  é¿å…æ–¹ä½ï¼š{'ã€'.join(rec.get('avoid_areas', []))}
"""

        result_text += f"""ã€é¢ç§¯ç©ºé—´åˆ†æã€‘
ç©ºé—´ç­‰çº§ï¼š{area_analysis['level']}
é£æ°´è¯„ä»·ï¼š{area_analysis['desc']}
è°ƒç†å»ºè®®ï¼š{area_analysis['suggestion']}
ç©ºé—´è¯„åˆ†ï¼š{area_analysis['score']}åˆ†
ã€ç‰¹æ®Šéœ€æ±‚å¸ƒå±€ã€‘
ä¸»è¦å¸ƒå±€ï¼š{special_layout['primary']}
è¾…åŠ©æªæ–½ï¼š{special_layout['secondary']}
é¢œè‰²æ­é…ï¼š{special_layout['colors']}
æ¨èç‰©å“ï¼š{special_layout['items']}
é£æ°´ç¦å¿Œï¼š{special_layout['taboo']}
ã€ç»¼åˆé£æ°´å»ºè®®ã€‘
1. æ ¹æ®{direction_info['gua']}çš„ç‰¹ç‚¹è¿›è¡Œé’ˆå¯¹æ€§å¸ƒå±€
2. åˆ©ç”¨{direction_info['element']}äº”è¡Œçš„ç”Ÿå…‹å…³ç³»è°ƒç†ç¯å¢ƒ
3. ç»“åˆç„ç©ºé£æ˜Ÿçš„å‰å‡¶æ–¹ä½å®‰æ’åŠŸèƒ½åŒºåŸŸ
4. æ³¨æ„æ¥¼å±‚äº”è¡Œä¸æˆ¿å±‹æœå‘çš„åè°ƒç»Ÿä¸€
5. å®šæœŸè°ƒæ•´å¸ƒå±€ä»¥é€‚åº”æµå¹´é£æ˜Ÿå˜åŒ–
ã€æƒå¨ç†è®ºä¾æ®ã€‘
æœ¬åˆ†æåŸºäºä»¥ä¸‹ç»å…¸é£æ°´è‘—ä½œï¼š
â€¢ ã€Šé˜³å®…ä¸‰è¦ã€‹- æ˜ä»£èµµä¹å³°è‘—ï¼Œé˜³å®…é£æ°´ç»å…¸
â€¢ ã€Šå…«å®…æ˜é•œã€‹- æ¸…ä»£ç®¬å† é“äººè‘—ï¼Œå…«å®…æ´¾ç†è®ºé›†å¤§æˆ
â€¢ ã€Šç„ç©ºé£æ˜Ÿã€‹- ç„ç©ºæ´¾æ ¸å¿ƒç†è®ºï¼Œæ—¶ç©ºé£æ°´ç²¾é«“
â€¢ ã€Šåœ°ç†äº”è¯€ã€‹- æ¸…ä»£èµµç‰æè‘—ï¼Œå½¢ç†å…¼å¤‡çš„é£æ°´å®å…¸
ã€å…è´£å£°æ˜ã€‘
ä»¥ä¸Šåˆ†æåŸºäºä¼ ç»Ÿé£æ°´ç†è®ºï¼Œä»…ä¾›å‚è€ƒã€‚å…·ä½“åº”ç”¨éœ€ç»“åˆ
å®åœ°å‹˜å¯Ÿå’Œä¸ªäººå…«å­—å‘½ç†è¿›è¡Œç»¼åˆåˆ¤æ–­ã€‚å»ºè®®å’¨è¯¢ä¸“ä¸š
é£æ°´å¸ˆè¿›è¡Œè¯¦ç»†æŒ‡å¯¼ã€‚
"""
        self.fengshui_result.setText(result_text)

    def analyze_use_god(self, bazi_result, bazi_pattern):
        """åˆ†æç”¨ç¥"""
        day_element = bazi_result['day_master_element']
        day_master = bazi_result['day_master']
        pattern_type = bazi_pattern['pattern_type']
        pillars = bazi_result['pillars']
        month_branch = pillars['month'][1]
        # è·å–è¯¦ç»†çš„è°ƒå€™ç”¨ç¥åˆ†æ
        tiaohou_analysis = self.analyze_tiaohou_yongshen(day_master, month_branch, pillars)
        # è·å–æ ¼å±€ç”¨ç¥åˆ†æ
        geju_analysis = self.analyze_geju_yongshen(day_element, pattern_type, pillars, bazi_result)
        # ç»¼åˆåˆ†æ
        comprehensive_analysis = f"""
ã€è°ƒå€™ç”¨ç¥ã€‘
{tiaohou_analysis}
ã€æ ¼å±€ç”¨ç¥ã€‘
{geju_analysis}
ã€ç»¼åˆå»ºè®®ã€‘
{self.get_comprehensive_yongshen_advice(day_element, month_branch, pattern_type)}
"""
        return comprehensive_analysis.strip()

    def analyze_tiaohou_yongshen(self, day_master, month_branch, pillars):
        """åˆ†æè°ƒå€™ç”¨ç¥"""
        # è°ƒå€™ç”¨ç¥è¡¨
        tiaohou_map = {
            # ç”²æœ¨è°ƒå€™
            'ç”²': {
                'å¯…': "ç”²æœ¨ç”Ÿäºå¯…æœˆï¼Œé˜³åˆƒå½“æƒï¼Œä¸“ç”¨åºšé‡‘ï¼Œä»¥æˆŠåœŸä¸ºä½ã€‚æ— åºšç”¨ä¸ï¼Œå¯Œè€Œä¸è´µ",
                'å¯': "ç”²æœ¨ç”Ÿäºå¯æœˆï¼Œç¾Šåˆƒå½“æƒï¼Œä¸“ç”¨åºšé‡‘ï¼Œä»¥æˆŠåœŸä¸ºä½ã€‚åºšæˆŠä¸¤é€ï¼Œç§‘ç”²å®šç„¶",
                'è¾°': "ç”²æœ¨ç”Ÿäºè¾°æœˆï¼Œç”¨åºšé‡‘å¿…é¡»å…ˆç”¨ç™¸æ°´æ¶¦åœŸï¼Œæ— ç™¸ç”¨å£¬ã€‚åºšç™¸ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'å·³': "ç”²æœ¨ç”Ÿäºå·³æœˆï¼Œè°ƒå€™ä¸ºæ€¥ï¼Œä¸“ç”¨ç™¸æ°´ï¼Œä»¥åºšé‡‘ä¸ºä½ã€‚ç™¸åºšä¸¤é€ï¼Œç§‘ç”²æœ‰å‡†",
                'åˆ': "ç”²æœ¨ç”Ÿäºåˆæœˆï¼Œæœ¨æ€§è™šç„¦ï¼Œç™¸æ°´ä¸ºå…ˆï¼Œæ— ç™¸ç”¨å£¬ã€‚åºšé‡‘æ¬¡ä¹‹ï¼ŒæˆŠåœŸä¸ºç—…",
                'æœª': "ç”²æœ¨ç”Ÿäºæœªæœˆï¼Œæœ¨æ€§è™šç„¦ï¼Œç™¸æ°´ä¸ºå…ˆï¼Œåºšé‡‘æ¬¡ä¹‹ã€‚ç™¸åºšä¸¤é€ï¼Œç§‘ç”²æœ‰å‡†",
                'ç”³': "ç”²æœ¨ç”Ÿäºç”³æœˆï¼Œåºšé‡‘å½“æƒï¼Œå–ä¸ç«åˆ¶ä¹‹ï¼Œä»¥ç”²å¼•ä¸ï¼Œä»¥åºšåŠˆç”²ã€‚ä¸åºšä¸¤é€ï¼Œç§‘ç”²å®šç„¶",
                'é…‰': "ç”²æœ¨ç”Ÿäºé…‰æœˆï¼Œåºšé‡‘å½“æƒï¼Œå–ä¸ç«åˆ¶ä¹‹ï¼Œä»¥ç”²å¼•ä¸ã€‚ä¸é€å¤©å¹²ï¼Œåˆè§åºšé‡‘ï¼Œå¿…ä¸»ç§‘ç”²",
                'æˆŒ': "ç”²æœ¨ç”ŸäºæˆŒæœˆï¼ŒåœŸåšæœ¨æ¯ï¼Œä¸“ç”¨ç™¸æ°´ï¼Œä»¥åºšé‡‘ä¸ºä½ã€‚ç™¸åºšä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'äº¥': "ç”²æœ¨ç”Ÿäºäº¥æœˆï¼Œæ°´å†·æœ¨å¯’ï¼Œä¸“ç”¨ä¸ç«ï¼Œåºšé‡‘ä¸ºä½ã€‚ä¸åºšä¸¤é€ï¼Œç§‘ç”²å®šç„¶",
                'å­': "ç”²æœ¨ç”Ÿäºå­æœˆï¼Œæ°´å†·æœ¨å¯’ï¼Œä¸“ç”¨ä¸ç«ï¼Œåºšé‡‘ä¸ºä½ã€‚ä¸é€æ— åºšï¼Œäº¦ä¸»ç§‘ç”²",
                'ä¸‘': "ç”²æœ¨ç”Ÿäºä¸‘æœˆï¼Œå¯’åœŸå†»æœ¨ï¼Œä¸“ç”¨ä¸ç«ï¼Œåºšé‡‘ä¸ºä½ã€‚ä¸åºšä¸¤é€ï¼Œç§‘ç”²æœ‰å‡†"
            },
            # ä¹™æœ¨è°ƒå€™
            'ä¹™': {
                'å¯…': "ä¹™æœ¨ç”Ÿäºå¯…æœˆï¼Œå¯’æ°”æœªé™¤ï¼Œä¸“ç”¨ä¸™ç«ï¼Œå¿Œè§ç™¸æ°´ã€‚ä¸™é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'å¯': "ä¹™æœ¨ç”Ÿäºå¯æœˆï¼Œé˜³å’Œä¹‹æœˆï¼Œä¸“ç”¨ä¸™ç«ï¼Œå¿Œè§ç™¸æ°´ã€‚ä¸™ç«é€å¹²ï¼Œå¯Œè´µåŒå…¨",
                'è¾°': "ä¹™æœ¨ç”Ÿäºè¾°æœˆï¼Œä½™å¯’æœªå°½ï¼Œä¸“ç”¨ä¸™ç«ã€‚æ°´å¤šç”¨æˆŠï¼Œç«å¤šç”¨ç™¸",
                'å·³': "ä¹™æœ¨ç”Ÿäºå·³æœˆï¼Œè°ƒå€™ä¸ºè¦ï¼Œä¸“ç”¨ç™¸æ°´ã€‚åŸå±€ç«å¤šï¼Œç™¸æ°´ä¸ºè´µ",
                'åˆ': "ä¹™æœ¨ç”Ÿäºåˆæœˆï¼Œä¸ŠåŠæœˆä¸“ç”¨ç™¸æ°´ï¼Œä¸‹åŠæœˆç”¨ç™¸æ°´ã€ä¸™ç«å¹¶ç”¨",
                'æœª': "ä¹™æœ¨ç”Ÿäºæœªæœˆï¼Œæœ¨æ€§è™šç„¦ï¼Œç™¸æ°´ä¸ºå…ˆï¼Œä¸™ç«ä¸ºä½ã€‚ç™¸ä¸™å¹¶ç”¨ï¼Œå¯Œè´µå¯æœŸ",
                'ç”³': "ä¹™æœ¨ç”Ÿäºç”³æœˆï¼Œåºšé‡‘å½“æƒï¼Œä¸“ç”¨ä¸™ç«åˆ¶åºšï¼Œç™¸æ°´æ¶¦æœ¨ã€‚ä¸™ç™¸å¹¶ç”¨ï¼Œå¯Œè´µåŒå…¨",
                'é…‰': "ä¹™æœ¨ç”Ÿäºé…‰æœˆï¼Œé‡‘æ—ºæœ¨å¼±ï¼Œä¸“ç”¨ä¸™ç«ï¼Œç™¸æ°´æ¬¡ä¹‹ã€‚ä¸™ç™¸ä¸¤é€ï¼Œå¿…ä¸»å¯Œè´µ",
                'æˆŒ': "ä¹™æœ¨ç”ŸäºæˆŒæœˆï¼Œæœ¨æ€§æ¯ç„¦ï¼Œä¸“ç”¨ç™¸æ°´ï¼Œä¸™ç«ä¸ºä½ã€‚ç™¸ä¸™å¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†",
                'äº¥': "ä¹™æœ¨ç”Ÿäºäº¥æœˆï¼Œæ°´å†·æœ¨å¯’ï¼Œä¸“ç”¨ä¸™ç«ï¼Œå¿Œè§ç™¸æ°´ã€‚ä¸™é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'å­': "ä¹™æœ¨ç”Ÿäºå­æœˆï¼Œå¯’æ°´å›°æœ¨ï¼Œä¸“ç”¨ä¸™ç«ï¼ŒæˆŠåœŸä¸ºä½ã€‚ä¸™æˆŠä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'ä¸‘': "ä¹™æœ¨ç”Ÿäºä¸‘æœˆï¼Œå¯’åœŸå†»æœ¨ï¼Œä¸“ç”¨ä¸™ç«ï¼ŒæˆŠåœŸä¸ºä½ã€‚ä¸™æˆŠå¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†"
            },
            # ä¸™ç«è°ƒå€™
            'ä¸™': {
                'å¯…': "ä¸™ç«ç”Ÿäºå¯…æœˆï¼Œå£¬æ°´ä¸ºç”¨ï¼Œåºšé‡‘ä¸ºä½ã€‚å£¬åºšä¸¤é€ï¼Œå¯Œè´µå¯æœŸ",
                'å¯': "ä¸™ç«ç”Ÿäºå¯æœˆï¼Œä¸“ç”¨å£¬æ°´ï¼ŒåœŸé‡ä¸å¿Œã€‚å£¬é€å¤©å¹²ï¼Œå¯Œè´µåŒå…¨",
                'è¾°': "ä¸™ç«ç”Ÿäºè¾°æœˆï¼Œä¸“ç”¨å£¬æ°´ï¼ŒåœŸåšç”¨ç”²æœ¨ç–åœŸã€‚å£¬ç”²ä¸¤é€ï¼Œç§‘ç”²æœ‰å‡†",
                'å·³': "ä¸™ç«ç”Ÿäºå·³æœˆï¼Œä¸“ç”¨å£¬æ°´ï¼Œå¿ŒæˆŠåœŸæ‚å£¬ã€‚å£¬é€æ— æˆŠï¼Œå¯Œè´µå¯æœŸ",
                'åˆ': "ä¸™ç«ç”Ÿäºåˆæœˆï¼Œä¸“ç”¨å£¬æ°´ï¼Œä»¥åºšé‡‘ä¸ºä½ã€‚å£¬åºšä¸¤é€ï¼Œç§‘ç”²å®šç„¶",
                'æœª': "ä¸™ç«ç”Ÿäºæœªæœˆï¼Œä¸“ç”¨å£¬æ°´ï¼Œä»¥åºšé‡‘ä¸ºä½ã€‚åœŸåšç”¨ç”²æœ¨ç–åœŸ",
                'ç”³': "ä¸™ç«ç”Ÿäºç”³æœˆï¼Œå£¬æ°´é€šæ ¹ç”³å®«ï¼Œä¸“ç”¨å£¬æ°´ã€‚å£¬é€å¤©å¹²ï¼Œå¯Œè´µåŒå…¨",
                'é…‰': "ä¸™ç«ç”Ÿäºé…‰æœˆï¼Œå››æŸ±å¤šå£¬ï¼Œä¸€æˆŠåˆ¶ä¹‹ã€‚æˆŠå£¬å¹¶ç”¨ï¼Œå¯Œè´µå¯æœŸ",
                'æˆŒ': "ä¸™ç«ç”ŸäºæˆŒæœˆï¼Œå¿ŒåœŸæ™¦å…‰ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œå£¬æ°´ä¸ºä½ã€‚ç”²å£¬ä¸¤é€ï¼Œç§‘ç”²æœ‰å‡†",
                'äº¥': "ä¸™ç«ç”Ÿäºäº¥æœˆï¼Œæ°´æ—ºç«å¼±ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œåºšé‡‘æ¬¡ä¹‹ã€‚ç”²åºšä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'å­': "ä¸™ç«ç”Ÿäºå­æœˆï¼Œæ°´æ—ºç«å¼±ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œåºšé‡‘ä¸ºä½ã€‚ç”²é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'ä¸‘': "ä¸™ç«ç”Ÿäºä¸‘æœˆï¼Œå¯’åœŸæ™¦ç«ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œåºšé‡‘ä¸ºä½ã€‚ç”²åºšå¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†"
            },
            # ä¸ç«è°ƒå€™
            'ä¸': {
                'å¯…': "ä¸ç«ç”Ÿäºå¯…æœˆï¼Œç”²æœ¨å½“æƒï¼Œä¸“ç”¨åºšé‡‘åŠˆç”²ï¼Œä»¥ç”²å¼•ä¸ã€‚åºšç”²ä¸¤é€ï¼Œç§‘ç”²å®šç„¶",
                'å¯': "ä¸ç«ç”Ÿäºå¯æœˆï¼Œä¹™æœ¨å½“æƒï¼Œä»¥åºšé‡‘ä¸ºå…ˆï¼Œç”²æœ¨ä¸ºä½ã€‚åºšç”²ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'è¾°': "ä¸ç«ç”Ÿäºè¾°æœˆï¼ŒåœŸé‡æ™¦ç«ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œåºšé‡‘ä¸ºä½ã€‚ç”²åºšä¸¤é€ï¼Œç§‘ç”²æœ‰å‡†",
                'å·³': "ä¸ç«ç”Ÿäºå·³æœˆï¼Œç«ç‚åœŸç‡¥ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œç™¸æ°´ä¸ºä½ã€‚ç”²ç™¸ä¸¤é€ï¼Œå¯Œè´µå¯æœŸ",
                'åˆ': "ä¸ç«ç”Ÿäºåˆæœˆï¼Œç«ç‚åœŸç‡¥ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œç™¸æ°´ä¸ºä½ã€‚ç”²ç™¸å¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†",
                'æœª': "ä¸ç«ç”Ÿäºæœªæœˆï¼ŒåœŸåšç«å¼±ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œç™¸æ°´ä¸ºä½ã€‚ç”²ç™¸ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'ç”³': "ä¸ç«ç”Ÿäºç”³æœˆï¼Œç«å¼±é‡‘å¼ºï¼Œä¸“ç”¨ç”²æœ¨ï¼Œåºšé‡‘ä¸ºä½ã€‚ç”²åºšä¸¤é€ï¼Œç§‘ç”²å®šç„¶",
                'é…‰': "ä¸ç«ç”Ÿäºé…‰æœˆï¼Œé‡‘æ—ºç«å¼±ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œåºšé‡‘ä¸ºä½ã€‚ç”²é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'æˆŒ': "ä¸ç«ç”ŸäºæˆŒæœˆï¼ŒåœŸåšç«å¼±ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œç™¸æ°´ä¸ºä½ã€‚ç”²ç™¸å¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†",
                'äº¥': "ä¸ç«ç”Ÿäºäº¥æœˆï¼Œæ°´æ—ºç«å¼±ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œåºšé‡‘ä¸ºä½ã€‚ç”²åºšä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'å­': "ä¸ç«ç”Ÿäºå­æœˆï¼Œæ°´æ—ºç«å¼±ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œåºšé‡‘ä¸ºä½ã€‚ç”²é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'ä¸‘': "ä¸ç«ç”Ÿäºä¸‘æœˆï¼Œå¯’åœŸæ™¦ç«ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œåºšé‡‘ä¸ºä½ã€‚ç”²åºšå¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†"
            },
            # æˆŠåœŸè°ƒå€™
            'æˆŠ': {
                'å¯…': "æˆŠåœŸç”Ÿäºå¯…æœˆï¼Œä¸“ç”¨ç”²æœ¨ï¼Œä¸™ç«ä¸ºä½ã€‚ç”²ä¸™ä¸¤é€ï¼Œå¯Œè´µå¯æœŸ",
                'å¯': "æˆŠåœŸç”Ÿäºå¯æœˆï¼Œä¸“ç”¨ç”²æœ¨ï¼Œä¸™ç«ä¸ºä½ã€‚ç”²é€å¤©å¹²ï¼Œå¯Œè´µåŒå…¨",
                'è¾°': "æˆŠåœŸç”Ÿäºè¾°æœˆï¼Œä¸“ç”¨ç”²æœ¨ï¼Œä¸™ç«ä¸ºä½ã€‚ç”²ä¸™å¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†",
                'å·³': "æˆŠåœŸç”Ÿäºå·³æœˆï¼Œç«ç‚åœŸç‡¥ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œç™¸æ°´ä¸ºä½ã€‚ç”²ç™¸ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'åˆ': "æˆŠåœŸç”Ÿäºåˆæœˆï¼Œç«ç‚åœŸç‡¥ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œç™¸æ°´ä¸ºä½ã€‚ç”²ç™¸å¹¶ç”¨ï¼Œç§‘ç”²å®šç„¶",
                'æœª': "æˆŠåœŸç”Ÿäºæœªæœˆï¼Œç«ç‚åœŸç‡¥ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œç™¸æ°´ä¸ºä½ã€‚ç”²é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'ç”³': "æˆŠåœŸç”Ÿäºç”³æœˆï¼Œå¯’æ°”æ¸ç”Ÿï¼Œä¸™ç«ä¸ºå…ˆï¼Œç™¸æ°´ä¸ºä½ã€‚ä¸™ç™¸ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'é…‰': "æˆŠåœŸç”Ÿäºé…‰æœˆï¼Œå¯’æ°”æ¸é‡ï¼Œä¸™ç«ä¸ºå…ˆï¼Œç™¸æ°´ä¸ºä½ã€‚ä¸™é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'æˆŒ': "æˆŠåœŸç”ŸäºæˆŒæœˆï¼ŒåœŸåšæ°”å¯’ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œä¸™ç«ä¸ºä½ã€‚ç”²ä¸™å¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†",
                'äº¥': "æˆŠåœŸç”Ÿäºäº¥æœˆï¼Œæ°´æ—ºåœŸå¼±ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œä¸™ç«ä¸ºä½ã€‚ç”²ä¸™ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'å­': "æˆŠåœŸç”Ÿäºå­æœˆï¼Œæ°´æ—ºåœŸå¼±ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œä¸™ç«ä¸ºä½ã€‚ç”²é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'ä¸‘': "æˆŠåœŸç”Ÿäºä¸‘æœˆï¼Œå¯’åœŸå½“æƒï¼Œä¸“ç”¨ç”²æœ¨ï¼Œä¸™ç«ä¸ºä½ã€‚ç”²ä¸™å¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†"
            },
            # å·±åœŸè°ƒå€™
            'å·±': {
                'å¯…': "å·±åœŸç”Ÿäºå¯…æœˆï¼Œä¸“ç”¨ä¸™ç«ï¼Œç”²æœ¨ä¸ºä½ã€‚ä¸™ç”²ä¸¤é€ï¼Œå¯Œè´µå¯æœŸ",
                'å¯': "å·±åœŸç”Ÿäºå¯æœˆï¼Œä¸“ç”¨ä¸™ç«ï¼Œç”²æœ¨ä¸ºä½ã€‚ä¸™é€å¤©å¹²ï¼Œå¯Œè´µåŒå…¨",
                'è¾°': "å·±åœŸç”Ÿäºè¾°æœˆï¼Œä¸“ç”¨ä¸™ç«ï¼Œç”²æœ¨ä¸ºä½ã€‚ä¸™ç”²å¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†",
                'å·³': "å·±åœŸç”Ÿäºå·³æœˆï¼Œè°ƒå€™ä¸ºæ€¥ï¼Œä¸“ç”¨ç™¸æ°´ï¼Œä¸™ç«ä¸ºä½ã€‚ç™¸ä¸™ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'åˆ': "å·±åœŸç”Ÿäºåˆæœˆï¼Œè°ƒå€™ä¸ºæ€¥ï¼Œä¸“ç”¨ç™¸æ°´ï¼Œä¸™ç«ä¸ºä½ã€‚ç™¸ä¸™å¹¶ç”¨ï¼Œç§‘ç”²å®šç„¶",
                'æœª': "å·±åœŸç”Ÿäºæœªæœˆï¼Œè°ƒå€™ä¸ºæ€¥ï¼Œä¸“ç”¨ç™¸æ°´ï¼Œä¸™ç«ä¸ºä½ã€‚ç™¸é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'ç”³': "å·±åœŸç”Ÿäºç”³æœˆï¼Œå¯’æ°”æ¸ç”Ÿï¼Œä¸™ç«ä¸ºå…ˆï¼Œç™¸æ°´ä¸ºä½ã€‚ä¸™ç™¸ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'é…‰': "å·±åœŸç”Ÿäºé…‰æœˆï¼Œå¯’æ°”æ¸é‡ï¼Œä¸™ç«ä¸ºå…ˆï¼Œç™¸æ°´ä¸ºä½ã€‚ä¸™é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'æˆŒ': "å·±åœŸç”ŸäºæˆŒæœˆï¼ŒåœŸåšæ°”å¯’ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œä¸™ç«ä¸ºä½ã€‚ç”²ä¸™å¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†",
                'äº¥': "å·±åœŸç”Ÿäºäº¥æœˆï¼Œæ°´æ—ºåœŸå¼±ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œä¸™ç«ä¸ºä½ã€‚ç”²ä¸™ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'å­': "å·±åœŸç”Ÿäºå­æœˆï¼Œæ°´æ—ºåœŸå¼±ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œä¸™ç«ä¸ºä½ã€‚ç”²é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'ä¸‘': "å·±åœŸç”Ÿäºä¸‘æœˆï¼Œå¯’åœŸå½“æƒï¼Œä¸“ç”¨ç”²æœ¨ï¼Œä¸™ç«ä¸ºä½ã€‚ç”²ä¸™å¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†"
            },
            # åºšé‡‘è°ƒå€™
            'åºš': {
                'å¯…': "åºšé‡‘ç”Ÿäºå¯…æœˆï¼Œä¸“ç”¨ä¸ç«ï¼Œç”²æœ¨ä¸ºä½ã€‚ä¸ç”²ä¸¤é€ï¼Œå¯Œè´µå¯æœŸ",
                'å¯': "åºšé‡‘ç”Ÿäºå¯æœˆï¼Œä¸“ç”¨ä¸ç«ï¼Œç”²æœ¨ä¸ºä½ã€‚ä¸é€å¤©å¹²ï¼Œå¯Œè´µåŒå…¨",
                'è¾°': "åºšé‡‘ç”Ÿäºè¾°æœˆï¼Œä¸“ç”¨ç”²æœ¨ï¼Œä¸ç«ä¸ºä½ã€‚ç”²ä¸å¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†",
                'å·³': "åºšé‡‘ç”Ÿäºå·³æœˆï¼Œç«ç‚é‡‘ç†”ï¼Œä¸“ç”¨å£¬æ°´ï¼ŒæˆŠåœŸä¸ºä½ã€‚å£¬æˆŠä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'åˆ': "åºšé‡‘ç”Ÿäºåˆæœˆï¼Œç«ç‚é‡‘ç†”ï¼Œä¸“ç”¨å£¬æ°´ï¼ŒæˆŠåœŸä¸ºä½ã€‚å£¬æˆŠå¹¶ç”¨ï¼Œç§‘ç”²å®šç„¶",
                'æœª': "åºšé‡‘ç”Ÿäºæœªæœˆï¼Œç«ç‚é‡‘ç†”ï¼Œä¸“ç”¨å£¬æ°´ï¼ŒæˆŠåœŸä¸ºä½ã€‚å£¬é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'ç”³': "åºšé‡‘ç”Ÿäºç”³æœˆï¼Œä¸“ç”¨ä¸ç«ï¼Œç”²æœ¨ä¸ºä½ã€‚ä¸ç”²ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'é…‰': "åºšé‡‘ç”Ÿäºé…‰æœˆï¼Œä¸“ç”¨ä¸ç«ï¼Œç”²æœ¨ä¸ºä½ã€‚ä¸é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'æˆŒ': "åºšé‡‘ç”ŸäºæˆŒæœˆï¼ŒåœŸåšé‡‘åŸ‹ï¼Œä¸“ç”¨ç”²æœ¨ï¼Œä¸ç«ä¸ºä½ã€‚ç”²ä¸å¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†",
                'äº¥': "åºšé‡‘ç”Ÿäºäº¥æœˆï¼Œæ°´å†·é‡‘å¯’ï¼Œä¸“ç”¨ä¸ç«ï¼Œç”²æœ¨ä¸ºä½ã€‚ä¸ç”²ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'å­': "åºšé‡‘ç”Ÿäºå­æœˆï¼Œæ°´å†·é‡‘å¯’ï¼Œä¸“ç”¨ä¸ç«ï¼Œç”²æœ¨ä¸ºä½ã€‚ä¸é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'ä¸‘': "åºšé‡‘ç”Ÿäºä¸‘æœˆï¼Œå¯’åœŸå†»é‡‘ï¼Œä¸“ç”¨ä¸ç«ï¼Œç”²æœ¨ä¸ºä½ã€‚ä¸ç”²å¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†"
            },
            # è¾›é‡‘è°ƒå€™
            'è¾›': {
                'å¯…': "è¾›é‡‘ç”Ÿäºå¯…æœˆï¼Œä¸“ç”¨å£¬æ°´ï¼Œç”²æœ¨ä¸ºä½ã€‚å£¬ç”²ä¸¤é€ï¼Œå¯Œè´µå¯æœŸ",
                'å¯': "è¾›é‡‘ç”Ÿäºå¯æœˆï¼Œä¸“ç”¨å£¬æ°´ï¼Œç”²æœ¨ä¸ºä½ã€‚å£¬é€å¤©å¹²ï¼Œå¯Œè´µåŒå…¨",
                'è¾°': "è¾›é‡‘ç”Ÿäºè¾°æœˆï¼Œä¸“ç”¨å£¬æ°´ï¼Œç”²æœ¨ä¸ºä½ã€‚å£¬ç”²å¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†",
                'å·³': "è¾›é‡‘ç”Ÿäºå·³æœˆï¼Œç«ç‚é‡‘ç†”ï¼Œä¸“ç”¨å£¬æ°´ï¼Œå¿ŒæˆŠåœŸæ··æ‚ã€‚å£¬é€æ— æˆŠï¼Œå¯Œè´µåŒå…¨",
                'åˆ': "è¾›é‡‘ç”Ÿäºåˆæœˆï¼Œç«ç‚é‡‘ç†”ï¼Œä¸“ç”¨å£¬æ°´ï¼Œå¿ŒæˆŠåœŸæ··æ‚ã€‚å£¬é€å¤©å¹²ï¼Œç§‘ç”²å®šç„¶",
                'æœª': "è¾›é‡‘ç”Ÿäºæœªæœˆï¼Œç«ç‚é‡‘ç†”ï¼Œä¸“ç”¨å£¬æ°´ï¼Œå¿ŒæˆŠåœŸæ··æ‚ã€‚å£¬é€æ— æˆŠï¼Œå¯Œè´µå¯æœŸ",
                'ç”³': "è¾›é‡‘ç”Ÿäºç”³æœˆï¼Œä¸“ç”¨å£¬æ°´ï¼Œç”²æœ¨ä¸ºä½ã€‚å£¬ç”²ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'é…‰': "è¾›é‡‘ç”Ÿäºé…‰æœˆï¼Œä¸“ç”¨å£¬æ°´ï¼Œç”²æœ¨ä¸ºä½ã€‚å£¬é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'æˆŒ': "è¾›é‡‘ç”ŸäºæˆŒæœˆï¼ŒåœŸåšé‡‘åŸ‹ï¼Œä¸“ç”¨å£¬æ°´ï¼Œç”²æœ¨ä¸ºä½ã€‚å£¬ç”²å¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†",
                'äº¥': "è¾›é‡‘ç”Ÿäºäº¥æœˆï¼Œé‡‘æ°´ç›¸æ¶µï¼Œä¸“ç”¨ä¸™ç«ï¼ŒæˆŠåœŸä¸ºä½ã€‚ä¸™æˆŠä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'å­': "è¾›é‡‘ç”Ÿäºå­æœˆï¼Œé‡‘æ°´ç›¸æ¶µï¼Œä¸“ç”¨ä¸™ç«ï¼ŒæˆŠåœŸä¸ºä½ã€‚ä¸™é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'ä¸‘': "è¾›é‡‘ç”Ÿäºä¸‘æœˆï¼Œå¯’åœŸå†»é‡‘ï¼Œä¸“ç”¨ä¸™ç«ï¼ŒæˆŠåœŸä¸ºä½ã€‚ä¸™æˆŠå¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†"
            },
            # å£¬æ°´è°ƒå€™
            'å£¬': {
                'å¯…': "å£¬æ°´ç”Ÿäºå¯…æœˆï¼Œä¸“ç”¨æˆŠåœŸï¼Œä¸™ç«ä¸ºä½ã€‚æˆŠä¸™ä¸¤é€ï¼Œå¯Œè´µå¯æœŸ",
                'å¯': "å£¬æ°´ç”Ÿäºå¯æœˆï¼Œä¸“ç”¨æˆŠåœŸï¼Œè¾›é‡‘ä¸ºä½ã€‚æˆŠè¾›ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'è¾°': "å£¬æ°´ç”Ÿäºè¾°æœˆï¼Œä¸“ç”¨ç”²æœ¨ï¼Œåºšé‡‘ä¸ºä½ã€‚ç”²åºšå¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†",
                'å·³': "å£¬æ°´ç”Ÿäºå·³æœˆï¼Œæ°´å¼±ç«å¼ºï¼Œä¸“ç”¨åºšé‡‘ï¼ŒæˆŠåœŸä¸ºä½ã€‚åºšæˆŠä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'åˆ': "å£¬æ°´ç”Ÿäºåˆæœˆï¼Œæ°´å¼±ç«å¼ºï¼Œä¸“ç”¨åºšé‡‘ï¼ŒæˆŠåœŸä¸ºä½ã€‚åºšæˆŠå¹¶ç”¨ï¼Œç§‘ç”²å®šç„¶",
                'æœª': "å£¬æ°´ç”Ÿäºæœªæœˆï¼Œæ°´å¼±ç«å¼ºï¼Œä¸“ç”¨åºšé‡‘ï¼ŒæˆŠåœŸä¸ºä½ã€‚åºšé€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'ç”³': "å£¬æ°´ç”Ÿäºç”³æœˆï¼Œä¸“ç”¨æˆŠåœŸï¼Œä¸ç«ä¸ºä½ã€‚æˆŠä¸ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'é…‰': "å£¬æ°´ç”Ÿäºé…‰æœˆï¼Œä¸“ç”¨æˆŠåœŸï¼Œä¸ç«ä¸ºä½ã€‚æˆŠé€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'æˆŒ': "å£¬æ°´ç”ŸäºæˆŒæœˆï¼Œä¸“ç”¨ç”²æœ¨ï¼Œåºšé‡‘ä¸ºä½ã€‚ç”²åºšå¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†",
                'äº¥': "å£¬æ°´ç”Ÿäºäº¥æœˆï¼Œä¸“ç”¨æˆŠåœŸï¼Œä¸™ç«ä¸ºä½ã€‚æˆŠä¸™ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'å­': "å£¬æ°´ç”Ÿäºå­æœˆï¼Œä¸“ç”¨æˆŠåœŸï¼Œä¸™ç«ä¸ºä½ã€‚æˆŠé€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'ä¸‘': "å£¬æ°´ç”Ÿäºä¸‘æœˆï¼Œä¸“ç”¨æˆŠåœŸï¼Œä¸™ç«ä¸ºä½ã€‚æˆŠä¸™å¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†"
            },
            # ç™¸æ°´è°ƒå€™
            'ç™¸': {
                'å¯…': "ç™¸æ°´ç”Ÿäºå¯…æœˆï¼Œä¸“ç”¨è¾›é‡‘ï¼Œä¸™ç«ä¸ºä½ã€‚è¾›ä¸™ä¸¤é€ï¼Œå¯Œè´µå¯æœŸ",
                'å¯': "ç™¸æ°´ç”Ÿäºå¯æœˆï¼Œä¸“ç”¨åºšé‡‘ï¼Œä¸™ç«ä¸ºä½ã€‚åºšä¸™ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'è¾°': "ç™¸æ°´ç”Ÿäºè¾°æœˆï¼Œä¸“ç”¨ç”²æœ¨ï¼Œåºšé‡‘ä¸ºä½ã€‚ç”²åºšå¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†",
                'å·³': "ç™¸æ°´ç”Ÿäºå·³æœˆï¼Œæ°´å¼±ç«å¼ºï¼Œä¸“ç”¨åºšé‡‘ï¼Œè¾›é‡‘ä¸ºä½ã€‚åºšè¾›ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'åˆ': "ç™¸æ°´ç”Ÿäºåˆæœˆï¼Œæ°´å¼±ç«å¼ºï¼Œä¸“ç”¨åºšé‡‘ï¼Œè¾›é‡‘ä¸ºä½ã€‚åºšè¾›å¹¶ç”¨ï¼Œç§‘ç”²å®šç„¶",
                'æœª': "ç™¸æ°´ç”Ÿäºæœªæœˆï¼Œæ°´å¼±ç«å¼ºï¼Œä¸“ç”¨åºšé‡‘ï¼Œè¾›é‡‘ä¸ºä½ã€‚åºšé€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'ç”³': "ç™¸æ°´ç”Ÿäºç”³æœˆï¼Œä¸“ç”¨ä¸ç«ï¼Œç”²æœ¨ä¸ºä½ã€‚ä¸ç”²ä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'é…‰': "ç™¸æ°´ç”Ÿäºé…‰æœˆï¼Œä¸“ç”¨ä¸ç«ï¼Œç”²æœ¨ä¸ºä½ã€‚ä¸é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'æˆŒ': "ç™¸æ°´ç”ŸäºæˆŒæœˆï¼Œä¸“ç”¨ç”²æœ¨ï¼Œåºšé‡‘ä¸ºä½ã€‚ç”²åºšå¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†",
                'äº¥': "ç™¸æ°´ç”Ÿäºäº¥æœˆï¼Œä¸“ç”¨ä¸™ç«ï¼ŒæˆŠåœŸä¸ºä½ã€‚ä¸™æˆŠä¸¤é€ï¼Œå¯Œè´µåŒå…¨",
                'å­': "ç™¸æ°´ç”Ÿäºå­æœˆï¼Œä¸“ç”¨ä¸™ç«ï¼ŒæˆŠåœŸä¸ºä½ã€‚ä¸™é€å¤©å¹²ï¼Œå¯Œè´µå¯æœŸ",
                'ä¸‘': "ç™¸æ°´ç”Ÿäºä¸‘æœˆï¼Œä¸“ç”¨ä¸™ç«ï¼ŒæˆŠåœŸä¸ºä½ã€‚ä¸™æˆŠå¹¶ç”¨ï¼Œç§‘ç”²æœ‰å‡†"
            }
        }
        if day_master in tiaohou_map and month_branch in tiaohou_map[day_master]:
            base_analysis = tiaohou_map[day_master][month_branch]
            # æ£€æŸ¥å‘½å±€ä¸­æ˜¯å¦æœ‰è°ƒå€™ç”¨ç¥
            all_stems = [pillars['year'][0], pillars['month'][0], pillars['day'][0], pillars['hour'][0]]
            # æå–è°ƒå€™ç”¨ç¥
            yongshen_chars = []
            if 'ç”²' in base_analysis and 'ç”²' in all_stems:
                yongshen_chars.append('ç”²æœ¨')
            if 'ä¹™' in base_analysis and 'ä¹™' in all_stems:
                yongshen_chars.append('ä¹™æœ¨')
            if 'ä¸™' in base_analysis and 'ä¸™' in all_stems:
                yongshen_chars.append('ä¸™ç«')
            if 'ä¸' in base_analysis and 'ä¸' in all_stems:
                yongshen_chars.append('ä¸ç«')
            if 'æˆŠ' in base_analysis and 'æˆŠ' in all_stems:
                yongshen_chars.append('æˆŠåœŸ')
            if 'å·±' in base_analysis and 'å·±' in all_stems:
                yongshen_chars.append('å·±åœŸ')
            if 'åºš' in base_analysis and 'åºš' in all_stems:
                yongshen_chars.append('åºšé‡‘')
            if 'è¾›' in base_analysis and 'è¾›' in all_stems:
                yongshen_chars.append('è¾›é‡‘')
            if 'å£¬' in base_analysis and 'å£¬' in all_stems:
                yongshen_chars.append('å£¬æ°´')
            if 'ç™¸' in base_analysis and 'ç™¸' in all_stems:
                yongshen_chars.append('ç™¸æ°´')
            if yongshen_chars:
                return f"{base_analysis}\nâœ… å‘½å±€æœ‰ç”¨ç¥ï¼š{', '.join(yongshen_chars)}ï¼Œè°ƒå€™æœ‰æƒ…"
            else:
                return f"{base_analysis}\nâš ï¸ å‘½å±€ç¼ºä¹è°ƒå€™ç”¨ç¥ï¼Œéœ€è¦åœ¨å¤§è¿æµå¹´ä¸­è¡¥å……"
        return f"{day_master}ç”Ÿäº{month_branch}æœˆï¼Œè°ƒå€™ç”¨ç¥å¾…æŸ¥"
    def analyze_geju_yongshen(self, day_element, pattern_type, pillars, bazi_result):
        """åˆ†ææ ¼å±€ç”¨ç¥"""
        if pattern_type in ["èº«å¼ºæ ¼", "èº«æ—ºæ ¼"]:
            if day_element == "é‡‘":
                return "èº«å¼ºé‡‘æ—ºï¼Œå–œç«ï¼ˆå®˜æ€åˆ¶èº«ï¼‰ã€æ°´ï¼ˆé£Ÿä¼¤æ³„ç§€ï¼‰ã€æœ¨ï¼ˆè´¢æ˜Ÿè€—èº«ï¼‰ï¼Œå¿ŒåœŸï¼ˆå°æ˜Ÿç”Ÿèº«ï¼‰ã€é‡‘ï¼ˆæ¯”åŠ«åŠ©èº«ï¼‰"
            elif day_element == "æœ¨":
                return "èº«å¼ºæœ¨æ—ºï¼Œå–œé‡‘ï¼ˆå®˜æ€åˆ¶èº«ï¼‰ã€ç«ï¼ˆé£Ÿä¼¤æ³„ç§€ï¼‰ã€åœŸï¼ˆè´¢æ˜Ÿè€—èº«ï¼‰ï¼Œå¿Œæ°´ï¼ˆå°æ˜Ÿç”Ÿèº«ï¼‰ã€æœ¨ï¼ˆæ¯”åŠ«åŠ©èº«ï¼‰"
            elif day_element == "ç«":
                return "èº«å¼ºç«æ—ºï¼Œå–œæ°´ï¼ˆå®˜æ€åˆ¶èº«ï¼‰ã€åœŸï¼ˆé£Ÿä¼¤æ³„ç§€ï¼‰ã€é‡‘ï¼ˆè´¢æ˜Ÿè€—èº«ï¼‰ï¼Œå¿Œæœ¨ï¼ˆå°æ˜Ÿç”Ÿèº«ï¼‰ã€ç«ï¼ˆæ¯”åŠ«åŠ©èº«ï¼‰"
            elif day_element == "åœŸ":
                return "èº«å¼ºåœŸæ—ºï¼Œå–œæœ¨ï¼ˆå®˜æ€åˆ¶èº«ï¼‰ã€é‡‘ï¼ˆé£Ÿä¼¤æ³„ç§€ï¼‰ã€æ°´ï¼ˆè´¢æ˜Ÿè€—èº«ï¼‰ï¼Œå¿Œç«ï¼ˆå°æ˜Ÿç”Ÿèº«ï¼‰ã€åœŸï¼ˆæ¯”åŠ«åŠ©èº«ï¼‰"
            elif day_element == "æ°´":
                return "èº«å¼ºæ°´æ—ºï¼Œå–œåœŸï¼ˆå®˜æ€åˆ¶èº«ï¼‰ã€æœ¨ï¼ˆé£Ÿä¼¤æ³„ç§€ï¼‰ã€ç«ï¼ˆè´¢æ˜Ÿè€—èº«ï¼‰ï¼Œå¿Œé‡‘ï¼ˆå°æ˜Ÿç”Ÿèº«ï¼‰ã€æ°´ï¼ˆæ¯”åŠ«åŠ©èº«ï¼‰"
        elif pattern_type == "èº«å¼±æ ¼":
            if day_element == "é‡‘":
                return "èº«å¼±é‡‘è¡°ï¼Œå–œåœŸï¼ˆå°æ˜Ÿç”Ÿèº«ï¼‰ã€é‡‘ï¼ˆæ¯”åŠ«åŠ©èº«ï¼‰ï¼Œå¿Œç«ï¼ˆå®˜æ€å…‹èº«ï¼‰ã€æ°´ï¼ˆé£Ÿä¼¤æ³„èº«ï¼‰ã€æœ¨ï¼ˆè´¢æ˜Ÿè€—èº«ï¼‰"
            elif day_element == "æœ¨":
                return "èº«å¼±æœ¨è¡°ï¼Œå–œæ°´ï¼ˆå°æ˜Ÿç”Ÿèº«ï¼‰ã€æœ¨ï¼ˆæ¯”åŠ«åŠ©èº«ï¼‰ï¼Œå¿Œé‡‘ï¼ˆå®˜æ€å…‹èº«ï¼‰ã€ç«ï¼ˆé£Ÿä¼¤æ³„èº«ï¼‰ã€åœŸï¼ˆè´¢æ˜Ÿè€—èº«ï¼‰"
            elif day_element == "ç«":
                return "èº«å¼±ç«è¡°ï¼Œå–œæœ¨ï¼ˆå°æ˜Ÿç”Ÿèº«ï¼‰ã€ç«ï¼ˆæ¯”åŠ«åŠ©èº«ï¼‰ï¼Œå¿Œæ°´ï¼ˆå®˜æ€å…‹èº«ï¼‰ã€åœŸï¼ˆé£Ÿä¼¤æ³„èº«ï¼‰ã€é‡‘ï¼ˆè´¢æ˜Ÿè€—èº«ï¼‰"
            elif day_element == "åœŸ":
                return "èº«å¼±åœŸè¡°ï¼Œå–œç«ï¼ˆå°æ˜Ÿç”Ÿèº«ï¼‰ã€åœŸï¼ˆæ¯”åŠ«åŠ©èº«ï¼‰ï¼Œå¿Œæœ¨ï¼ˆå®˜æ€å…‹èº«ï¼‰ã€é‡‘ï¼ˆé£Ÿä¼¤æ³„èº«ï¼‰ã€æ°´ï¼ˆè´¢æ˜Ÿè€—èº«ï¼‰"
            elif day_element == "æ°´":
                return "èº«å¼±æ°´è¡°ï¼Œå–œé‡‘ï¼ˆå°æ˜Ÿç”Ÿèº«ï¼‰ã€æ°´ï¼ˆæ¯”åŠ«åŠ©èº«ï¼‰ï¼Œå¿ŒåœŸï¼ˆå®˜æ€å…‹èº«ï¼‰ã€æœ¨ï¼ˆé£Ÿä¼¤æ³„èº«ï¼‰ã€ç«ï¼ˆè´¢æ˜Ÿè€—èº«ï¼‰"
        else:
            return "ä¸­å’Œæ ¼å±€ï¼Œç”¨ç¥éšè¿è€Œå®šï¼Œå¹³è¡¡ä¸ºè´µï¼Œä¸å¯åé¢‡"
        return "æ ¼å±€ç”¨ç¥åˆ†æä¸­"
    def get_comprehensive_yongshen_advice(self, day_element, month_branch, pattern_type):
        """è·å–ç»¼åˆç”¨ç¥å»ºè®®"""
        advice = []
        # å­£èŠ‚ç‰¹ç‚¹
        season_map = {
            'å¯…': 'å­Ÿæ˜¥', 'å¯': 'ä»²æ˜¥', 'è¾°': 'å­£æ˜¥',
            'å·³': 'å­Ÿå¤', 'åˆ': 'ä»²å¤', 'æœª': 'å­£å¤',
            'ç”³': 'å­Ÿç§‹', 'é…‰': 'ä»²ç§‹', 'æˆŒ': 'å­£ç§‹',
            'äº¥': 'å­Ÿå†¬', 'å­': 'ä»²å†¬', 'ä¸‘': 'å­£å†¬'
        }
        season = season_map.get(month_branch, 'æœªçŸ¥')
        if season in ['å­Ÿæ˜¥', 'ä»²æ˜¥', 'å­£æ˜¥']:
            advice.append("æ˜¥å­£æœ¨æ—ºï¼Œæ³¨æ„è°ƒå€™ï¼Œé˜²æœ¨è¿‡æ—ºè€Œæ— åˆ¶")
        elif season in ['å­Ÿå¤', 'ä»²å¤', 'å­£å¤']:
            advice.append("å¤å­£ç«æ—ºï¼Œè°ƒå€™ä¸ºæ€¥ï¼Œé˜²ç«ç‚åœŸç‡¥")
        elif season in ['å­Ÿç§‹', 'ä»²ç§‹', 'å­£ç§‹']:
            advice.append("ç§‹å­£é‡‘æ—ºï¼Œæ”¶æ•›ä¹‹æ—¶ï¼Œé˜²é‡‘å¯’æ°´å†·")
        else:
            advice.append("å†¬å­£æ°´æ—ºï¼Œå¯’æ°”é€¼äººï¼Œè°ƒå€™ä¸ºè¦")
        # æ ¼å±€å»ºè®®
        if pattern_type in ["èº«å¼ºæ ¼", "èº«æ—ºæ ¼"]:
            advice.append("èº«å¼ºå®œæ³„å®œåˆ¶ï¼Œå¤§è¿å–œèµ°è´¢å®˜é£Ÿä¼¤è¿")
        elif pattern_type == "èº«å¼±æ ¼":
            advice.append("èº«å¼±å®œç”Ÿå®œæ‰¶ï¼Œå¤§è¿å–œèµ°å°æ¯”è¿")
        else:
            advice.append("ä¸­å’Œæ ¼å±€ï¼Œå¤§è¿å®œå¹³è¡¡ï¼Œå¿Œè¿‡æ—ºè¿‡è¡°")
        # äº”è¡Œå»ºè®®
        element_advice = {
            'é‡‘': "é‡‘ä¸»ä¹‰ï¼Œå®œä»äº‹é‡‘èã€æœºæ¢°ã€æ±½è½¦ç­‰è¡Œä¸š",
            'æœ¨': "æœ¨ä¸»ä»ï¼Œå®œä»äº‹æ•™è‚²ã€æ–‡åŒ–ã€æ—ä¸šç­‰è¡Œä¸š",
            'ç«': "ç«ä¸»ç¤¼ï¼Œå®œä»äº‹æ–‡è‰ºã€å¹¿å‘Šã€ç”µå­ç­‰è¡Œä¸š",
            'åœŸ': "åœŸä¸»ä¿¡ï¼Œå®œä»äº‹æˆ¿åœ°äº§ã€å†œä¸šã€å»ºç­‘ç­‰è¡Œä¸š",
            'æ°´': "æ°´ä¸»æ™ºï¼Œå®œä»äº‹è´¸æ˜“ã€è¿è¾“ã€æ°´åˆ©ç­‰è¡Œä¸š"
        }
        advice.append(element_advice.get(day_element, ""))
        return "ï¼›".join(advice)
    def has_shanguan_peiyin(self, pillars, bazi_result):
        """æ£€æŸ¥æ˜¯å¦æœ‰ä¼¤å®˜é…å°æ ¼å±€"""
        # ç®€åŒ–æ£€æŸ¥ï¼šæœˆå¹²ä¼¤å®˜+å¹´æ—¶å°æ˜Ÿ
        month_tg = pillars['month'][0]
        month_element = bazi_result['tiangan_wuxing'][month_tg]['element']
        day_element = bazi_result['day_master_element']
        # ä¼¤å®˜é…å°æ ¼å±€æ£€æµ‹ï¼ˆç®€åŒ–ç‰ˆï¼Œä¸ä½¿ç”¨æœ¬åœ°è®¡ç®—ï¼‰
        # åœ¨çº¯APIæ¨¡å¼ä¸‹ï¼Œæ ¼å±€åˆ†æåº”è¯¥å®Œå…¨æ¥è‡ªAPIè¿”å›çš„æ•°æ®
        return False  # æš‚æ—¶è¿”å›Falseï¼Œç­‰å¾…APIæä¾›å®Œæ•´æ ¼å±€åˆ†æ
    def has_caiku_pattern(self, pillars, bazi_result):
        """æ£€æŸ¥æ˜¯å¦æœ‰è´¢åº“æ ¼å±€"""
        day_branch = pillars['day'][1]
        # ç®€åŒ–æ£€æŸ¥ï¼šæ—¥æ”¯ä¸ºè´¢åº“ï¼ˆæœªåœŸå¯¹è¾›é‡‘ä¸ºè´¢åº“ï¼‰
        day_element = bazi_result['day_master_element']
        if day_element == "é‡‘" and day_branch == "æœª":
            return True
        return False
    def analyze_detailed_pattern(self, bazi_result, bazi_pattern):
        """åˆ†æè¯¦ç»†æ ¼å±€"""
        pattern_type = bazi_pattern['pattern_type']
        strength_score = bazi_pattern.get('strength_score')

        # å¦‚æœæ²¡æœ‰strength_scoreï¼Œæ ¹æ®pattern_typeæ¨æ–­
        if strength_score is None:
            if pattern_type in ['èº«å¼ºæ ¼', 'èº«æ—ºæ ¼']:
                return f"{pattern_type} - èº«å¼ºå®œæ³„å®œè€—ï¼Œå–œé£Ÿä¼¤è´¢å®˜"
            elif pattern_type in ['èº«å¼±æ ¼']:
                return f"{pattern_type} - èº«å¼±å®œç”Ÿå®œæ‰¶ï¼Œå–œå°æ¯”"
            else:
                return f"{pattern_type} - å¹³è¡¡å‘å±•æœ€ä½³"

        # æœ‰strength_scoreçš„æƒ…å†µ
        if strength_score >= 6:
            return f"{pattern_type}ï¼ˆåæ—ºï¼‰- éœ€è¦å…‹æ³„è€—æ¥å¹³è¡¡"
        elif strength_score >= 4:
            return f"{pattern_type}ï¼ˆä¸­æ—ºï¼‰- é€‚åº¦å…‹æ³„ä¸ºå®œ"
        elif strength_score >= 2:
            return f"{pattern_type}ï¼ˆä¸­å’Œï¼‰- å¹³è¡¡å‘å±•æœ€ä½³"
        elif strength_score >= 1:
            return f"{pattern_type}ï¼ˆåå¼±ï¼‰- éœ€è¦ç”Ÿæ‰¶æ¥å¢å¼º"
        else:
            return f"{pattern_type}ï¼ˆæå¼±ï¼‰- è€ƒè™‘ä»æ ¼å¯èƒ½æ€§"
    def analyze_wuxing_balance(self, wuxing_distribution):
        """åˆ†æäº”è¡Œå¹³è¡¡"""
        total = sum(wuxing_distribution.values())
        if total == 0:
            return "äº”è¡Œåˆ†å¸ƒå¼‚å¸¸"
        balance_text = []
        missing_elements = []
        for element, count in wuxing_distribution.items():
            percentage = (count / total) * 100
            if count == 0:
                missing_elements.append(element)
            elif percentage >= 30:
                balance_text.append(f"{element}åæ—º({percentage:.1f}%)")
            elif percentage <= 15:  # è°ƒæ•´é˜ˆå€¼ï¼š15%ä»¥ä¸‹ä¸ºåå¼±
                balance_text.append(f"{element}åå¼±({percentage:.1f}%)")
            else:
                balance_text.append(f"{element}é€‚ä¸­({percentage:.1f}%)")
        result = "ã€".join(balance_text)
        if missing_elements:
            result += f"ï¼Œç¼º{' '.join(missing_elements)}"
        return result

    def analyze_mingge_pattern(self, bazi_result, ten_gods, bazi_pattern):
        """å‘½æ ¼åˆ†æ - åŸºäºã€Šå­å¹³çœŸè¯ ã€‹ã€Šæ»´å¤©é«“ã€‹ã€Šä¸‰å‘½é€šä¼šã€‹ä¸‰ç»ä¸€çº¬ä½“ç³»"""
        day_master = bazi_result['day_master']
        pillars = bazi_result['pillars']
        month_branch = pillars['month'][1]

        # æœˆä»¤æ ¼å±€åˆ¤å®š
        month_element = bazi_result['dizhi_info'][month_branch]['element']
        day_element = bazi_result['day_master_element']

        # æ­£å®˜æ ¼æ£€æµ‹
        zhengguan_count = sum(1 for info in ten_gods.values() if info['ten_god'] == 'æ­£å®˜')
        if zhengguan_count >= 1:
            # æ£€æŸ¥æ˜¯å¦æœ‰ä¼¤å®˜ç ´æ ¼
            shangguan_count = sum(1 for info in ten_gods.values() if info['ten_god'] == 'ä¼¤å®˜')
            if shangguan_count >= 1:
                return "æ­£å®˜æ ¼ï¼ˆç ´æ ¼ï¼‰- ä¼¤å®˜è§å®˜"
            else:
                return "æ­£å®˜æ ¼ï¼ˆæˆæ ¼ï¼‰- è´µæ°”å¯æœŸ"

        # è´¢æ ¼æ£€æµ‹
        zhengcai_count = sum(1 for info in ten_gods.values() if info['ten_god'] == 'æ­£è´¢')
        piancai_count = sum(1 for info in ten_gods.values() if info['ten_god'] == 'åè´¢')
        if zhengcai_count >= 1 or piancai_count >= 1:
            if zhengguan_count >= 1:
                return "è´¢ç”Ÿå®˜æ ¼ï¼ˆæˆæ ¼ï¼‰- å¯Œè´µåŒå…¨"
            else:
                return "è´¢æ ¼ï¼ˆæˆæ ¼ï¼‰- å¯Œè€Œä¸è´µ"

        # é£Ÿç¥æ ¼æ£€æµ‹
        shishen_count = sum(1 for info in ten_gods.values() if info['ten_god'] == 'é£Ÿç¥')
        if shishen_count >= 1:
            if zhengcai_count >= 1 or piancai_count >= 1:
                return "é£Ÿç¥ç”Ÿè´¢æ ¼ï¼ˆæˆæ ¼ï¼‰- æŠ€è‰ºæ±‚è´¢"
            else:
                return "é£Ÿç¥æ ¼ï¼ˆå¹³æ ¼ï¼‰- æŠ€è‰ºç²¾æ¹›"

        # ä»æ ¼æ£€æµ‹ï¼ˆç®€åŒ–ï¼‰
        pattern_type = bazi_pattern['pattern_type']
        if pattern_type == "èº«å¼±æ ¼":
            bijian_count = sum(1 for info in ten_gods.values() if info['ten_god'] == 'æ¯”è‚©')
            if bijian_count == 0:
                return "ä»æ ¼ï¼ˆç‰¹æ ¼ï¼‰- é¡ºåŠ¿è€Œè¡Œ"

        return "æ™®é€šæ ¼å±€ - å¹³å¸¸ä¹‹å‘½"

    def analyze_ten_gods_simple(self, ten_gods, day_master):
        """ç®€åŒ–åç¥åˆ†æ"""
        analysis = []

        # ç»Ÿè®¡åç¥
        ten_gods_count = {}
        for info in ten_gods.values():
            ten_god = info['ten_god']
            ten_gods_count[ten_god] = ten_gods_count.get(ten_god, 0) + 1

        # æ˜¾ç¤ºä¸»è¦åç¥
        main_gods = []
        for ten_god, count in ten_gods_count.items():
            if count >= 1:
                main_gods.append(f"{ten_god}{count}ä¸ª")

        if main_gods:
            analysis.append("â€¢ åç¥é…ç½®ï¼š" + "ã€".join(main_gods))
        else:
            analysis.append("â€¢ åç¥é…ç½®ï¼šé…ç½®å¹³å¸¸")

        # åç¥ç‰¹ç‚¹åˆ†æ
        if ten_gods_count.get('æ­£å®˜', 0) >= 1:
            analysis.append("â€¢ æ€§æ ¼ç‰¹ç‚¹ï¼šæ­£ç›´æœ‰è´£ä»»å¿ƒï¼Œé€‚åˆç®¡ç†å·¥ä½œ")
        elif ten_gods_count.get('æ­£è´¢', 0) >= 1:
            analysis.append("â€¢ æ€§æ ¼ç‰¹ç‚¹ï¼šåŠ¡å®ç¨³é‡ï¼Œå–„äºç†è´¢")
        elif ten_gods_count.get('é£Ÿç¥', 0) >= 1:
            analysis.append("â€¢ æ€§æ ¼ç‰¹ç‚¹ï¼šèªæ˜çµæ´»ï¼Œæœ‰è‰ºæœ¯å¤©èµ‹")
        elif ten_gods_count.get('æ¯”è‚©', 0) >= 2:
            analysis.append("â€¢ æ€§æ ¼ç‰¹ç‚¹ï¼šè‡ªç«‹è‡ªå¼ºï¼Œä½†éœ€é˜²å›ºæ‰§")
        else:
            analysis.append("â€¢ æ€§æ ¼ç‰¹ç‚¹ï¼šæ€§æ ¼å¹³å’Œï¼Œé€‚åº”æ€§å¼º")

        return "\n".join(analysis)

    def analyze_ten_gods_data(self, ten_gods):
        lines = []
        count = {}
        for info in ten_gods.values():
            tg = info.get('ten_god')
            if tg:
                count[tg] = count.get(tg, 0) + 1
        if count:
            lines.append("â€¢ åç¥è®¡æ•°ï¼š" + "ã€".join(f"{k}{v}ä¸ª" for k,v in count.items()))
        return "\n".join(lines)

    def analyze_wuxing_percent_data(self, dist):
        """äº”è¡Œæ¯”ä¾‹åˆ†æï¼ˆç®€åŒ–ç‰ˆï¼Œä¸ä¾èµ–å¤–éƒ¨æ¨¡å—ï¼‰"""
        total = sum(dist.values())
        if total == 0:
            return "â€¢ äº”è¡Œæ¯”ä¾‹ï¼šæ•°æ®ä¸è¶³"

        parts = []
        missing = []
        for element in ['æœ¨','ç«','åœŸ','é‡‘','æ°´']:
            count = dist.get(element, 0)
            if count == 0:
                missing.append(element)
            else:
                pct = (count / total) * 100
                parts.append(f"{element}{pct:.1f}%")

        extra = f"ï¼ˆç¼ºï¼š{'æ— ' if not missing else ''.join(missing)}ï¼‰"
        return "â€¢ äº”è¡Œæ¯”ä¾‹ï¼š" + "ã€".join(parts) + extra

    def analyze_wealth_data(self, pillars, ten_gods, bazi_pattern):
        """
        è´¢å¯Œç»“æ„åˆ†æ - åŸºäºã€Šæ¸Šæµ·å­å¹³ã€‹è´¢æ˜Ÿç†è®º
        ğŸ”¥ ç®€åŒ–ç‰ˆï¼šåªç»Ÿè®¡è´¢æ˜Ÿæ•°é‡å’Œä½ç½®ï¼Œä¸åšå¤æ‚åˆ†æ

        è®¡ç®—ä¾æ®ï¼š
        1. è´¢æ˜Ÿæ•°é‡ï¼šç»Ÿè®¡å››æŸ±å¤©å¹²å’Œåœ°æ”¯è—å¹²ä¸­æ­£è´¢ã€åè´¢çš„æ•°é‡
        2. æ ¼å±€ç±»å‹ï¼šæ ¹æ®æ—¥ä¸»å¼ºå¼±åˆ¤æ–­ï¼ˆèº«å¼ºæ ¼/èº«å¼±æ ¼/ä¸­å’Œæ ¼ï¼‰
        3. ä½ç½®ä¼˜åŠ¿ï¼šè´¢æ˜Ÿå‡ºç°åœ¨æœˆæŸ±ã€æ—¶æŸ±ä¸ºä½³
        """
        from classic_analyzer.common import get_ten_god, DIZHI_CANGGAN_WEIGHTS

        # è·å–æ—¥ä¸»
        day_master = pillars.get('day', ['', ''])[0] if isinstance(pillars.get('day'), (list, tuple)) else ''
        if not day_master:
            return "â€¢ è´¢æ˜Ÿæ•°é‡ï¼šæ— æ³•åˆ†æï¼ˆæ—¥ä¸»ç¼ºå¤±ï¼‰"

        # 1. è®¡ç®—è´¢æ˜Ÿæ•°é‡ï¼ˆå¤©å¹²ï¼‰
        cai_count_gan = sum(1 for info in ten_gods.values() if info.get('ten_god') in ['æ­£è´¢', 'åè´¢'])

        # 2. è®¡ç®—è´¢æ˜Ÿæ•°é‡ï¼ˆåœ°æ”¯è—å¹²ï¼‰
        cai_count_zhi = 0.0
        for pos in ['year', 'month', 'day', 'hour']:
            pillar_val = pillars.get(pos, ['', ''])
            if isinstance(pillar_val, (list, tuple)) and len(pillar_val) >= 2:
                zhi = pillar_val[1]
                if zhi and zhi in DIZHI_CANGGAN_WEIGHTS:
                    for hidden_gan, weight in DIZHI_CANGGAN_WEIGHTS[zhi]:
                        ten_god = get_ten_god(day_master, hidden_gan)
                        if ten_god in ['æ­£è´¢', 'åè´¢']:
                            if weight >= 0.5:
                                cai_count_zhi += 1.0
                            else:
                                cai_count_zhi += weight

        cai_count = int(round(cai_count_gan + cai_count_zhi))

        # 3. è·å–æ ¼å±€ç±»å‹å’Œæ—¥ä¸»å¼ºå¼±
        pattern_type = bazi_pattern.get('pattern_type', 'æœªçŸ¥')
        strength_label = bazi_pattern.get('strength_label', 'æœªçŸ¥')

        # 4. åˆ¤æ–­è´¢æ˜Ÿä½ç½®ï¼ˆæœˆæŸ±ã€æ—¶æŸ±ä¸ºæœ€ä½³ä½ç½®ï¼‰
        favorable_positions = []
        key_pillars = {
            'å¹´': pillars.get('year', ['?', '?']),
            'æœˆ': pillars.get('month', ['?', '?']),
            'æ—¥': pillars.get('day', ['?', '?']),
            'æ—¶': pillars.get('hour', ['?', '?'])
        }
        for pos_name, pillar_list in key_pillars.items():
            if isinstance(pillar_list, (list, tuple)) and len(pillar_list) >= 1:
                stem = pillar_list[0]
                tg_info = ten_gods.get(stem, {}) if ten_gods else {}
                if tg_info.get('ten_god') in ['æ­£è´¢', 'åè´¢']:
                    favorable_positions.append(pos_name)

        # 5. ç”Ÿæˆç®€å•è¯„ä¼°
        if cai_count >= 3:
            wealth_assessment = "è´¢æ˜Ÿæ—ºç››"
        elif cai_count >= 2:
            wealth_assessment = "è´¢æ˜Ÿé€‚ä¸­"
        elif cai_count >= 1:
            wealth_assessment = "è´¢æ˜Ÿåå¼±"
        else:
            wealth_assessment = "è´¢æ˜Ÿä¸æ˜¾"

        # 6. ç”Ÿæˆè¾“å‡º
        lines = [
            f"â€¢ è´¢æ˜Ÿæ•°é‡ï¼š{cai_count}ä¸ª",
            f"â€¢ æ ¼å±€ç±»å‹ï¼š{pattern_type}",
            f"â€¢ æ—¥ä¸»å¼ºå¼±ï¼š{strength_label}",
            f"â€¢ ä½ç½®ä¼˜åŠ¿ï¼š{('ã€'.join(favorable_positions) if favorable_positions else 'æš‚æ— ä¼˜åŠ¿')}",
            f"â€¢ è´¢è¿è¯„ä¼°ï¼š{wealth_assessment}",
        ]

        return "\n".join(lines)

    def analyze_marriage_data(self, pillars, ten_gods, gender):
        """
        å©šå§»åˆ†æ - åŸºäºã€Šæ¸Šæµ·å­å¹³ã€‹å…­äº²ç« ã€ã€Šä¸‰å‘½é€šä¼šã€‹é…å¶å®«ç†è®º
        âœ… ä¿®æ­£ï¼šåªåˆ†æé…å¶æ˜Ÿå’Œé…å¶å®«ï¼Œä¸èƒ¡ä¹±ç¼–é€ 
        """
        # ç”·å‘½çœ‹è´¢æ˜Ÿï¼Œå¥³å‘½çœ‹å®˜æ˜Ÿ
        if gender == "ç”·":
            spouse_stars = ['æ­£è´¢', 'åè´¢']
            spouse_star_name = "è´¢æ˜Ÿ"
        else:
            spouse_stars = ['æ­£å®˜', 'ä¸ƒæ€']
            spouse_star_name = "å®˜æ˜Ÿ"

        # ç»Ÿè®¡é…å¶æ˜Ÿæ•°é‡
        spouse_count = sum(1 for info in ten_gods.values() if info.get('ten_god') in spouse_stars)
        day_branch = pillars.get('day', ['?', '?'])[1] if pillars else '?'

        # åˆ†æé…å¶æ˜Ÿ
        if spouse_count == 0:
            star_analysis = f"{spouse_star_name}ä¸ç°ï¼Œå©šå§»ç¼˜åˆ†è¾ƒæ™š"
        elif spouse_count == 1:
            star_analysis = f"{spouse_star_name}ä¸“ä¸€ï¼Œå©šå§»è¾ƒä¸ºç¨³å®š"
        else:
            star_analysis = f"{spouse_star_name}å¤šç°ï¼Œæ„Ÿæƒ…å…³ç³»å¤æ‚"

        lines = [
            f"â€¢ é…å¶æ˜Ÿï¼š{spouse_count}ä¸ªï¼ˆ{spouse_star_name}ï¼‰",
            f"â€¢ é…å¶å®«ï¼šæ—¥æ”¯{day_branch}",
            f"â€¢ å©šå§»è¯„ä¼°ï¼š{star_analysis}",
        ]
        return "\n".join(lines)

    def analyze_dayun_data(self, dayun_info):
        if not dayun_info or not dayun_info.get('dayun_list'):
            return "â€¢ å¤§è¿ï¼šæ•°æ®ä¸è¶³"

        qiyun = dayun_info.get('qiyun_info', {})
        current = dayun_info.get('current_dayun', {})
        jixiong = dayun_info.get('jixiong_info', {})

        preview = []
        for item in dayun_info['dayun_list'][:4]:
            age_span = f"{item['start_age']}~{item['end_age']}å²"
            preview.append(f"â€¢ {age_span}ï¼š{item['ganzhi']}ï¼ˆ{item['ten_god']}ï¼‰")

        lines = [
            f"â€¢ é¡ºé€†ï¼š{qiyun.get('shun_ni', 'æœªçŸ¥')}  èµ·è¿ï¼š{qiyun.get('qiyun_age_desc', 'æœªçŸ¥')}",
        ]
        ref = qiyun.get('reference_jieqi', {})
        if ref:
            lines.append(f"â€¢ å‚è€ƒèŠ‚æ°”ï¼š{ref.get('name', '-')}/{ref.get('time_local', '-')}")

        if current:
            current_line = f"â€¢ å½“å‰ï¼š{current.get('ganzhi', 'æœªçŸ¥')}ï¼ˆ{current.get('ten_god', 'æœªçŸ¥')}ï¼‰"
            if current.get('current_age') is not None:
                current_line += f"  å½“å‰å¹´é¾„â‰ˆ{current['current_age']}å²"
            if current.get('note'):
                current_line += f" ({current['note']})"
            lines.append(current_line)

        if jixiong:
            lines.append(f"â€¢ å‰å‡¶ï¼š{jixiong.get('jixiong', 'æœªçŸ¥')}ï¼ˆ{jixiong.get('score', 0)}åˆ†ï¼‰")

        lines.extend(preview)
        return "\n".join(lines)


    def analyze_ten_gods_detailed(self, ten_gods, day_master):
        """è¯¦ç»†åç¥åˆ†æï¼ˆä¿ç•™ç­¾åï¼‰ï¼Œå·²ç”¨æ•°æ®åŒ–è¾“å‡ºæ›¿ä»£"""
        return self.analyze_ten_gods_data(ten_gods)
    def analyze_parents_data(self, pillars, ten_gods):
        """çˆ¶æ¯åˆ†æï¼ˆåŠ å¼ºç‰ˆï¼‰"""
        year_pillar = f"{pillars.get('year', ['?', '?'])[0]}{pillars.get('year', ['?', '?'])[1]}" if pillars else "?"
        month_pillar = f"{pillars.get('month', ['?', '?'])[0]}{pillars.get('month', ['?', '?'])[1]}" if pillars else "?"

        father_count = sum(1 for info in ten_gods.values() if info.get('ten_god') == 'åè´¢')
        mother_count = sum(1 for info in ten_gods.values() if info.get('ten_god') == 'æ­£å°')

        father_eval = 'çˆ¶åŠ©åŠ›å¼±' if father_count == 0 else ('çˆ¶åŠ©åŠ›ä¸­ç­‰' if father_count == 1 else 'çˆ¶åŠ©åŠ›å¼º')
        mother_eval = 'æ¯ç¼˜ä¸€èˆ¬' if mother_count == 0 else ('æ¯ç¼˜å°šå¯' if mother_count == 1 else 'æ¯ç¼˜æ·±åš')

        return "\n".join([
            f"â€¢ çˆ¶æ˜Ÿ(åè´¢)è®¡æ•°ï¼š{father_count}ä¸ª - {father_eval}",
            f"â€¢ æ¯æ˜Ÿ(æ­£å°)è®¡æ•°ï¼š{mother_count}ä¸ª - {mother_eval}",
            f"â€¢ å¹´æŸ±ï¼š{year_pillar}  æœˆæŸ±ï¼š{month_pillar}",
            "â€¢ å»ºè®®ï¼šä¸çˆ¶è¾ˆä¿æŒè‰¯å¥½æ²Ÿé€šï¼Œæ¯ç³»é•¿è¾ˆä¸ºä¸»è¦æ”¯æŒè€…"
        ])

    def analyze_children_data(self, pillars, ten_gods, gender):
        """å­å¥³åˆ†æï¼ˆåŠ å¼ºç‰ˆï¼‰"""
        if gender == "ç”·":
            children_stars = ['é£Ÿç¥', 'ä¼¤å®˜']
        else:
            children_stars = ['æ­£å®˜', 'ä¸ƒæ€']

        children_count = sum(1 for info in ten_gods.values() if info.get('ten_god') in children_stars)
        time_branch = pillars.get('hour', ['?', '?'])[1] if pillars else '?'

        tendency = 'å­å¥³ç¼˜åˆ†æ·¡è–„ï¼Œéœ€å¤šæŠ•å…¥äº²å­æ—¶é—´' if children_count == 0 else 'å­å¥³ç¼˜åˆ†å°šå¯ï¼Œé‡è§†æ•™è‚²ä¸é™ªä¼´'

        return "\n".join([
            f"â€¢ å­å¥³æ˜Ÿè®¡æ•°ï¼š{children_count}ä¸ª",
            f"â€¢ æ—¶æ”¯ï¼š{time_branch}",
            f"â€¢ äº²å­å»ºè®®ï¼š{tendency}"
        ])

    def analyze_health_data(self, pillars, day_master):
        """å¥åº·åˆ†æï¼ˆåŠ å¼ºç‰ˆï¼‰"""
        element_organ = {'æœ¨': 'è‚èƒ†', 'ç«': 'å¿ƒå°è‚ ', 'åœŸ': 'è„¾èƒƒ', 'é‡‘': 'è‚ºå¤§è‚ ', 'æ°´': 'è‚¾è†€èƒ±'}
        day_element = self.get_wuxing_by_tiangan(day_master)
        organ = element_organ.get(day_element, 'æœªçŸ¥')
        day_branch = pillars.get('day', ['?', '?'])[1] if pillars else '?'
        care = {
            'æœ¨': 'å°‘è¾›è¾£ï¼Œå¤šç»¿è‰²è”¬èœï¼Œæ—©ç¡æŠ¤è‚',
            'ç«': 'å°‘ç†¬å¤œï¼Œæ§åˆ¶æƒ…ç»ªä¸å¿ƒç‡ï¼Œæ³¨æ„æš‘çƒ­',
            'åœŸ': 'é¥®é£Ÿæ¸…æ·¡ï¼Œå°‘ç”œå°‘æ²¹ï¼Œå¥è„¾ä¸ºå…ˆ',
            'é‡‘': 'å°‘çƒŸé…’ä¸ç²‰å°˜ï¼Œæ³¨æ„å‘¼å¸é“',
            'æ°´': 'æ³¨æ„è…°è‚¾ä¿æš–ï¼Œè§„å¾‹ä½œæ¯ï¼Œå¤šæ¸©çƒ­é£Ÿ'
        }.get(day_element, 'è§„å¾‹ä½œæ¯ï¼Œé€‚åº¦è¿åŠ¨')

        return "\n".join([
            f"â€¢ æ—¥ä¸»äº”è¡Œï¼š{day_element}  å¯¹åº”è„è…‘ï¼š{organ}",
            f"â€¢ æ—¥æ”¯ï¼š{day_branch}  éœ€æ³¨æ„ç›¸å…³å¥åº·é—®é¢˜",
            f"â€¢ è°ƒç†å»ºè®®ï¼š{care}"
        ])

    def analyze_career_data(self, ten_gods, bazi_pattern, pillars=None, day_master=None):
        """
        äº‹ä¸šåˆ†æï¼ˆç®€åŒ–ç‰ˆï¼‰
        ğŸ”¥ ç®€åŒ–ï¼šåªåŸºäºåç¥å’Œä¼ å…¥çš„æ ¼å±€ç±»å‹ï¼Œä¸å†è°ƒç”¨GejuAnalyzer
        """
        # 1. è·å–æ ¼å±€ç±»å‹ï¼ˆåªä½¿ç”¨ä¼ å…¥çš„bazi_patternï¼‰
        pattern_type = bazi_pattern.get('pattern_type', 'æœªçŸ¥')
        strength_label = bazi_pattern.get('strength_label', 'æœªçŸ¥')

        # 2. ç»Ÿè®¡åç¥
        counts = {}
        for info in ten_gods.values():
            ten_god = info.get('ten_god')
            if ten_god:
                counts[ten_god] = counts.get(ten_god, 0) + 1

        picked = [f"{k}{v}ä¸ª" for k, v in counts.items() if v > 0]

        # 3. ğŸ”¥ å¢å¼ºï¼šåŸºäºæ ¼å±€ç±»å‹ç»™å‡ºæ›´å‡†ç¡®çš„äº‹ä¸šå»ºè®®
        industry_hint = []
        career_advice = []

        # 3.1 åŸºäºæ ¼å±€ç±»å‹çš„äº‹ä¸šå»ºè®®ï¼ˆå‚è€ƒã€Šæ¸Šæµ·å­å¹³ã€‹ç†è®ºï¼‰
        if 'å®˜æ€æ ¼' in pattern_type or 'æ­£å®˜æ ¼' in pattern_type or 'åå®˜æ ¼' in pattern_type:
            industry_hint.append('å…¬åŠ¡/ç®¡ç†/æ‰§æ³•ç±»')
            career_advice.append('é€‚åˆå…¬èŒã€ç®¡ç†ã€æ‰§æ³•ç±»å·¥ä½œ')
            if counts.get('æ­£å®˜', 0) >= 1:
                career_advice.append('å¯ä»äº‹æ”¿åºœæœºå…³ã€å›½ä¼ç­‰ä½“åˆ¶å†…ç®¡ç†å²—ä½')

        if 'è´¢æ ¼' in pattern_type or 'è´¢å®˜åŒç¾' in pattern_type or 'ä»è´¢æ ¼' in pattern_type:
            industry_hint.append('å•†ä¸š/é‡‘è/è´¸æ˜“')
            career_advice.append('é€‚åˆå•†ä¸šã€é‡‘èã€è´¸æ˜“ç±»å·¥ä½œ')
            if 'è´¢å®˜åŒç¾' in pattern_type:
                career_advice.append('è´¢å®˜åŒç¾ï¼Œååˆ©åŒæ”¶ï¼Œé€‚åˆé«˜ç«¯å•†ä¸šæˆ–é‡‘èç®¡ç†')

        if 'å°æ ¼' in pattern_type or 'æ­£å°æ ¼' in pattern_type or 'åå°æ ¼' in pattern_type or 'ä¼¤å®˜é…å°' in pattern_type:
            industry_hint.append('æ–‡åŒ–/æ•™è‚²/ç§‘ç ”')
            career_advice.append('é€‚åˆæ–‡åŒ–ã€æ•™è‚²ã€ç§‘ç ”ç±»å·¥ä½œ')
            if 'ä¼¤å®˜é…å°' in pattern_type:
                career_advice.append('ä¼¤å®˜é…å°æ ¼ï¼Œè´µä¸å¯è¨€ï¼Œä¸»ç§‘åä»•é€”ï¼Œé€‚åˆå­¦æœ¯ã€ç§‘ç ”ã€é«˜å±‚ç®¡ç†')

        if 'é£Ÿä¼¤æ ¼' in pattern_type or 'é£Ÿç¥æ ¼' in pattern_type or 'ä¼¤å®˜æ ¼' in pattern_type or 'é£Ÿç¥åˆ¶æ€' in pattern_type:
            industry_hint.append('æŠ€æœ¯/åˆ›æ„/ä¼ åª’')
            career_advice.append('é€‚åˆæŠ€æœ¯ã€åˆ›æ„ã€ä¼ åª’ç­‰éœ€è¦è¡¨è¾¾åˆ›ä½œçš„è¡Œä¸š')
            if 'é£Ÿç¥åˆ¶æ€' in pattern_type:
                career_advice.append('é£Ÿç¥åˆ¶æ€æ ¼ï¼Œæƒè´µæ˜¾è¾¾ï¼Œé€‚åˆæ­¦èŒæˆ–é¢†å¯¼å²—ä½')

        if 'ç¦„æ ¼' in pattern_type or 'æ—¥ç¦„æ ¼' in pattern_type:
            industry_hint.append('ç®¡ç†/å®æƒå²—ä½')
            career_advice.append('å¯æŒå®æƒï¼Œé€‚åˆæ‹…ä»»å…³é”®å²—ä½')

        # 3.2 åŸºäºåç¥ç»“æ„è¡¥å……è¡Œä¸šå»ºè®®ï¼ˆå½“æ ¼å±€ç±»å‹æœªçŸ¥æ—¶ï¼‰
        if pattern_type == 'æœªçŸ¥' or not industry_hint:
            if any('å°' in k for k in counts):
                industry_hint.append('æ•™è‚²/ç ”ç©¶/è¡Œæ”¿')
            if any('è´¢' in k for k in counts):
                industry_hint.append('ç»è¥/é‡‘è/è´¸æ˜“')
            if any('å®˜' in k or 'æ€' in k for k in counts):
                industry_hint.append('å…¬åŠ¡/ç®¡ç†/è§„åˆ™å¯¼å‘å²—ä½')
            if any('é£Ÿ' in k or 'ä¼¤' in k for k in counts):
                industry_hint.append('æŠ€æœ¯/åˆ›æ„/äº§å“/ä¼ æ’­')

        # 3.3 åŸºäºæ—¥ä¸»å¼ºå¼±è¡¥å……å»ºè®®
        if strength_label in ['å¼±', 'ä¸­å¼±']:
            career_advice.append('æ—¥ä¸»åå¼±ï¼Œå»ºè®®é€‰æ‹©ç¨³å®šã€å‹åŠ›è¾ƒå°çš„å²—ä½')
        elif strength_label in ['æ—º', 'ä¸­æ—º']:
            career_advice.append('æ—¥ä¸»åå¼ºï¼Œé€‚åˆæŒ‘æˆ˜æ€§è¾ƒå¼ºã€éœ€è¦æ‰¿æ‹…è´£ä»»çš„å·¥ä½œ')

        # 4. ç”Ÿæˆè¾“å‡º
        lines = [
            f"â€¢ æ ¼å±€ï¼š{pattern_type}",
            "â€¢ åç¥ç»“æ„ï¼š" + ("ã€".join(picked) if picked else "å¹³å’Œ"),
        ]

        # æ ¼å±€ç±»å‹è¯´æ˜
        if pattern_type != 'æœªçŸ¥':
            pattern_desc = bazi_pattern.get('pattern_description', '')
            if pattern_desc:
                lines.append(f"â€¢ æ ¼å±€è¯´æ˜ï¼š{pattern_desc}")

        # é€‚åˆè¡Œä¸š
        if industry_hint:
            lines.append("â€¢ é€‚åˆè¡Œä¸šï¼š" + "ã€".join(industry_hint))
        else:
            lines.append("â€¢ é€‚åˆè¡Œä¸šï¼šç»¼åˆè¯„ä¼°åç¡®å®š")

        # äº‹ä¸šå‘å±•å»ºè®®
        if career_advice:
            lines.append("â€¢ å‘å±•å»ºè®®ï¼š" + "ï¼›".join(career_advice))

        return "\n".join(lines)

    def analyze_liunian_data(self, day_master, pillars=None, birth_info=None):
        """
        æµå¹´åˆ†æï¼ˆå¢å¼ºç‰ˆï¼šç»™å‡ºæœªæ¥10å¹´å¹²æ”¯ã€å¼ºå¼±åˆ¤æ–­ã€ä¸å¤§è¿å…³ç³»ã€é‡ç‚¹äº‹é¡¹ï¼‰
        ğŸ”¥ P0ä¿®å¤ï¼šä»5å¹´æ‰©å±•åˆ°10å¹´ï¼Œæ·»åŠ è¯¦ç»†åˆ†æ
        """
        from datetime import datetime
        current_year = datetime.now().year

        # ç”Ÿå…‹å…³ç³»
        def relation(src, dst):
            generate = {'æœ¨': 'ç«', 'ç«': 'åœŸ', 'åœŸ': 'é‡‘', 'é‡‘': 'æ°´', 'æ°´': 'æœ¨'}
            overcome = {'æœ¨': 'åœŸ', 'åœŸ': 'æ°´', 'æ°´': 'ç«', 'ç«': 'é‡‘', 'é‡‘': 'æœ¨'}
            if generate[src] == dst:
                return 'ç›¸ç”Ÿ'
            if overcome[src] == dst:
                return 'ç›¸å…‹'
            if src == dst:
                return 'æ¯”å’Œ'
            return 'ä¸­æ€§'

        # ğŸ”¥ P0ä¿®å¤ï¼šæ‰©å±•ä¸º10å¹´
        lines = []
        dm_element = self.get_wuxing_by_tiangan(day_master)

        # è·å–å¤§è¿ä¿¡æ¯ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        current_dayun = None
        dayun_list = []
        # å…­ä¹¦åº“ï¼šç”¨äºåˆ¤å®šå¤§è¿å–œ/å¿Œç­‰çº§çš„è¾…åŠ©å˜é‡
        yongshen_wx = []
        jishen_wx = []
        dayun_analyzer_obj = None

        if pillars and birth_info:
            try:
                # ä½¿ç”¨å…­ä¹¦åº“è·å–å¤§è¿åˆ—è¡¨ä¸å½“å‰å¤§è¿
                if CML_UNIFIED_AVAILABLE and 'BaziData' in globals():
                    birth_year = birth_info.get('solar_year') or birth_info.get('year', current_year)
                    by = int(birth_year)
                    bm = int(birth_info.get('solar_month') or birth_info.get('month') or 1)
                    bd = int(birth_info.get('solar_day') or birth_info.get('day') or 1)
                    bh = int(birth_info.get('solar_hour') or 0)
                    gender = birth_info.get('gender', 'ç”·')
                    bazi_data_tmp = BaziData(
                        year=(pillars['year'][0], pillars['year'][1]),
                        month=(pillars['month'][0], pillars['month'][1]),
                        day=(pillars['day'][0], pillars['day'][1]),
                        hour=(pillars['hour'][0], pillars['hour'][1]),
                        birth_year=by, birth_month=bm, birth_day=bd, birth_hour=bh,
                        gender=gender
                    )
                    analyzer_tmp = UnifiedMetaphysicsAnalyzer()
                    dayun_res = analyzer_tmp.analyzers['ä¸‰å‘½é€šä¼š'].analyze_dayun(bazi_data_tmp)
                    pillars_list = dayun_res.details.get('dayun_pillars', []) or []
                    qy_age_raw = dayun_res.details.get('qiyun_age')
                    qy_age_base = int(round(qy_age_raw)) if qy_age_raw is not None else 0
                    built = []
                    for i, p in enumerate(pillars_list, start=1):
                        try:
                            gan, zhi = p
                        except Exception:
                            gz = str(p)
                            gan = gz[0] if len(gz) >= 1 else ''
                            zhi = gz[1] if len(gz) >= 2 else ''
                        sa = qy_age_base + (i - 1) * 10
                        ea = sa + 9
                        built.append({'index': i, 'ganzhi': f"{gan}{zhi}", 'gan': gan, 'zhi': zhi, 'start_age': sa, 'end_age': ea})
                    dayun_list = built
                    # è®¡ç®—å½“å‰å¤§è¿
                    age_now = current_year - by
                    current_dayun = None
                    for d in dayun_list:
                        if d['start_age'] <= age_now < d['end_age']:
                            current_dayun = d
                            break
                    # å–ç”¨ç¥ï¼ˆå­å¹³çœŸè¯ ï¼‰
                    try:
                        ziping = analyzer_tmp.analyzers.get('å­å¹³çœŸè¯ ')
                        if ziping:
                            ziping_res = ziping.analyze(bazi_data_tmp)
                            yinfo = (ziping_res.details.get('yongshen_info', {}) or {})
                            def _split_wx(s: str):
                                if not s:
                                    return []
                                t = s
                                for sep in ['ã€', 'ï¼Œ', ',', 'å’Œ', 'åŠ', ' ']:
                                    t = t.replace(sep, '|')
                                toks = [x for x in t.split('|') if x in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                if not toks:
                                    # æ— åˆ†éš”æ—¶å›é€€ï¼šé€å­—ç¬¦æ‰«æ
                                    toks = [ch for ch in s if ch in ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´']]
                                # å»é‡å¹¶ä¿æŒåŸåº
                                seen = set()
                                res = []
                                for x in toks:
                                    if x not in seen:
                                        seen.add(x)
                                        res.append(x)
                                return res
                            yongshen_wx = _split_wx(yinfo.get('xishen', ''))
                            jishen_wx = _split_wx(yinfo.get('jishen', ''))
                    except Exception:
                        pass
                    # dayun_analyzer å¯¹è±¡
                    try:
                        dayun_analyzer_obj = analyzer_tmp.analyzers['ä¸‰å‘½é€šä¼š'].dayun_analyzer
                    except Exception:
                        dayun_analyzer_obj = None
                else:
                    print("âš ï¸ å…­ä¹¦åº“ä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½å¤§è¿åˆ—è¡¨")
                    dayun_list = []
                    current_dayun = None
            except Exception as e:
                print(f"âš ï¸ é€šè¿‡å…­ä¹¦åº“è®¡ç®—å¤§è¿å¤±è´¥: {e}")
                dayun_list = []
                current_dayun = None

        # ğŸ”¥ P0ä¿®å¤ï¼šåˆ†ææœªæ¥10å¹´
        for i in range(10):
            year = current_year + i
            # é€šè¿‡ç²¾ç¡®å†œå†åº“è·å–å½“å¹´å¹²æ”¯
            try:
                if 'Solar' in globals() and Solar and Lunar:
                    from datetime import datetime as _dt
                    lunar = Solar.fromDate(_dt(year, 6, 1)).getLunar()
                    ygz = lunar.getYearInGanZhi()  # å¦‚ ç”²å­
                    tg = ygz[0]
                    zhi = ygz[1] if len(ygz) > 1 else 'å­'
                else:
                    ygz = 'ç”²å­'
                    tg = 'ç”²'
                    zhi = 'å­'
            except Exception:
                ygz = 'ç”²å­'
                tg = 'ç”²'
                zhi = 'å­'

            # ğŸ”¥ ä¿®å¤ï¼šæµå¹´åˆ†æåº”è¯¥ä»åç¥è§’åº¦åˆ†æï¼Œè€Œä¸æ˜¯ç®€å•äº”è¡Œç›¸å…‹
            # 1. åˆ†ææµå¹´å¤©å¹²çš„åç¥
            try:
                from classic_analyzer.common import get_ten_god
                liunian_ten_god = get_ten_god(day_master, tg)
            except Exception:
                liunian_ten_god = 'æœªçŸ¥'
            
            # 2. åˆ†ææµå¹´åœ°æ”¯çš„å½±å“ï¼ˆæ£€æŸ¥åœ°æ”¯è—å¹²ä¸­çš„å®˜æ€ï¼‰
            has_guan_sha_in_zhi = False
            guan_sha_desc = ''
            try:
                from chinese_metaphysics_library.core.constants import DIZHI_CANGGAN, TIANGAN_WUXING
                from classic_analyzer.common import get_ten_god
                canggan_list = DIZHI_CANGGAN.get(zhi, [])
                guan_sha_list = []
                for cg, weight in canggan_list:
                    if weight >= 0.2:  # åªæ£€æŸ¥æœ¬æ°”å’Œä¸­æ°”
                        cg_ten_god = get_ten_god(day_master, cg)
                        if cg_ten_god in ['æ­£å®˜', 'ä¸ƒæ€', 'åå®˜']:
                            has_guan_sha_in_zhi = True
                            guan_sha_list.append(f"{zhi}ä¸­è—{cg}ï¼ˆ{cg_ten_god}ï¼‰")
                if guan_sha_list:
                    # ğŸ”¥ ä¿®å¤ï¼šæ£€æŸ¥åœ°æ”¯äº”è¡Œæ˜¯å¦ä¸ºç«ï¼Œå¦‚æœæ˜¯ç«åˆ™è¯´"åŠ©æ—ºå®˜æ€"
                    from chinese_metaphysics_library.core.constants import DIZHI_WUXING
                    zhi_wuxing = DIZHI_WUXING.get(zhi, '')
                    if zhi_wuxing == 'ç«':
                        guan_sha_desc = f"ï¼Œ{zhi}ç«åŠ©æ—ºå®˜æ€"
                    else:
                        guan_sha_desc = f"ï¼Œ{zhi}ä¸­è—å®˜æ€"
            except Exception:
                pass
            
            # 3. æ ¹æ®åç¥å’Œåœ°æ”¯å½±å“ç”Ÿæˆæè¿°
            year_desc = ''
            if liunian_ten_god == 'åè´¢':
                year_desc = f"åè´¢é€å‡ºï¼Œäº‹ä¸šæœ‰æœºé‡{guan_sha_desc if has_guan_sha_in_zhi else ''}ï¼Œå‹åŠ›å¢å¤§" if has_guan_sha_in_zhi else "åè´¢é€å‡ºï¼Œäº‹ä¸šæœ‰æœºé‡"
            elif liunian_ten_god == 'æ­£è´¢':
                year_desc = f"æ­£è´¢é€å‡ºï¼Œè´¢è¿æœ‰å‘å±•å¥‘æœº"
            elif liunian_ten_god in ['æ­£å®˜', 'ä¸ƒæ€', 'åå®˜']:
                year_desc = f"å®˜æ€é€å‡ºï¼Œäº‹ä¸šæŒ‘æˆ˜ä¸å‹åŠ›å¹¶å­˜"
            elif liunian_ten_god == 'æ­£å°':
                year_desc = f"å°æ˜Ÿé€å¹²ï¼Œæƒ³æ³•å¤šï¼Œå®œè§„åˆ’"
            elif liunian_ten_god == 'åå°':
                year_desc = f"åå°é€å¹²ï¼Œæ€è€ƒåˆ›æ–°ï¼Œä½†å¯èƒ½æœ‰å­¤ç‹¬æ„Ÿ"
            elif liunian_ten_god == 'é£Ÿç¥':
                year_desc = f"é£Ÿç¥é€å‡ºï¼Œæ‰è‰ºå‘æŒ¥" + (f"ï¼Œä½†{guan_sha_desc if has_guan_sha_in_zhi else ''}éœ€æ³¨æ„" if has_guan_sha_in_zhi else "")
            elif liunian_ten_god == 'ä¼¤å®˜':
                # æ£€æŸ¥æ˜¯å¦ä¼¤å®˜åä¼¤å®˜ï¼ˆæµå¹´åœ°æ”¯ä¹Ÿæ˜¯ä¼¤å®˜ï¼‰
                try:
                    from chinese_metaphysics_library.core.constants import DIZHI_CANGGAN
                    from classic_analyzer.common import get_ten_god
                    canggan_list = DIZHI_CANGGAN.get(zhi, [])
                    for cg, weight in canggan_list:
                        if weight >= 0.3:  # æ£€æŸ¥æœ¬æ°”
                            cg_ten_god = get_ten_god(day_master, cg)
                            if cg_ten_god == 'ä¼¤å®˜':
                                year_desc = f"ä¼¤å®˜åä¼¤å®˜ï¼Œæ‰åæœ‰æ–½å±•å¹³å°"
                                break
                    if not year_desc:
                        year_desc = f"ä¼¤å®˜é€å‡ºï¼Œæ‰åå±•ç°"
                except Exception:
                    year_desc = f"ä¼¤å®˜é€å‡ºï¼Œæ‰åå±•ç°"
            elif liunian_ten_god == 'æ¯”è‚©':
                year_desc = f"æ¯”è‚©é€å‡ºï¼Œåˆä½œæœºä¼š"
            elif liunian_ten_god == 'åŠ«è´¢':
                year_desc = f"åŠ«è´¢å¸®èº«ï¼Œç«äº‰åŠ å‰§"
            else:
                # å›é€€åˆ°äº”è¡Œåˆ†æ
                year_element = self.get_wuxing_by_tiangan(tg)
                rel = relation(dm_element, year_element)
                score_hint = {'ç›¸ç”Ÿ': 'åå‰', 'æ¯”å’Œ': 'å¹³å’Œ', 'ä¸­æ€§': 'å¹³', 'ç›¸å…‹': 'åè°¨æ…'}[rel]
                year_desc = f"{year_element}å¹´ï¼Œä¸æ—¥ä¸»{dm_element}{rel} â†’ {score_hint}"
            
            # ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨åç¥åˆ†æç»“æœ
            year_info = f"  {year}å¹´ï¼ˆ{ygz}ï¼‰ï¼š{year_desc}"

            # åˆ†æä¸å¤§è¿çš„å…³ç³»
            if current_dayun and dayun_list:
                # è®¡ç®—è¯¥å¹´çš„å¤§è¿
                birth_year = birth_info.get('solar_year') or birth_info.get('year', current_year)
                age_at_year = year - birth_year
                for dayun in dayun_list:
                    if dayun['start_age'] <= age_at_year < dayun['end_age']:
                        dayun_ganzhi = dayun.get('ganzhi', '')
                        # è®¡ç®—å¤§è¿å–œ/å¿Œç­‰çº§ï¼ˆæç¤ºè¯ï¼šå¤§å–œ/å°å–œ/ä¸­ç­‰/ä¸€èˆ¬/è°¨æ…ï¼‰
                        label_txt = 'ä¸­ç­‰'
                        try:
                            if dayun_analyzer_obj:
                                gz = dayun_ganzhi
                                gan = gz[0] if len(gz) >= 1 else ''
                                dz = gz[1] if len(gz) >= 2 else ''
                                _info = dayun_analyzer_obj._judge_single_dayun_xiji(
                                    gan, dz, day_master,
                                    xishen_wuxing=yongshen_wx or [],
                                    jishen_wuxing=jishen_wx or [],
                                    pillars=pillars,
                                    yongshen_method=None
                                )
                                xiji = _info.get('xiji') or _info.get('level') or ''
                                mapping = {'å¤§å–œ':'å¤§å–œ','å°å–œ':'å°å–œ','å¹³':'ä¸­ç­‰','å°å¿Œ':'ä¸€èˆ¬','å¤§å¿Œ':'è°¨æ…'}
                                label_txt = mapping.get(xiji, 'ä¸­ç­‰')
                        except Exception:
                            pass
                        year_info += f"\n    å¤§è¿ï¼š{dayun_ganzhi}ï¼ˆ{dayun['start_age']}-{dayun['end_age']}å²ï¼‰ ç­‰çº§ï¼š{label_txt}"

                        # åˆ†ææµå¹´ä¸å¤§è¿çš„å…³ç³»
                        dayun_zhi = dayun.get('zhi', '')
                        if dayun_zhi:
                            # æ£€æŸ¥æ˜¯å¦ç›¸å†²
                            chong_pairs = [('å­', 'åˆ'), ('ä¸‘', 'æœª'), ('å¯…', 'ç”³'), ('å¯', 'é…‰'), ('è¾°', 'æˆŒ'), ('å·³', 'äº¥')]
                            is_chong = any((dayun_zhi == pair[0] and zhi == pair[1]) or (dayun_zhi == pair[1] and zhi == pair[0]) for pair in chong_pairs)
                            if is_chong:
                                year_info += " âš ï¸ æµå¹´å†²å¤§è¿ï¼Œéœ€è°¨æ…"
                        break

            # ğŸ”¥ ä¿®å¤ï¼šæ ¹æ®åç¥åˆ†æç»“æœè®¾ç½®é‡ç‚¹äº‹é¡¹ï¼ˆç¬¦åˆæ ‡å‡†ç­”æ¡ˆæ ¼å¼ï¼‰
            focus_items = []
            
            # æ ¹æ®åç¥ç±»å‹è®¾ç½®é‡ç‚¹
            if liunian_ten_god == 'åè´¢':
                if has_guan_sha_in_zhi:
                    focus_items.append("æŠŠæ¡æœºé‡ï¼Œæ³¨æ„åŠ³é€¸ç»“åˆ")
                else:
                    focus_items.append("æŠŠæ¡æœºé‡")
            elif liunian_ten_god == 'æ­£è´¢':
                focus_items.append("æŠŠæ¡è‰¯æœº")
            elif liunian_ten_god in ['æ­£å®˜', 'ä¸ƒæ€', 'åå®˜']:
                focus_items.append("æ³¨æ„å‹åŠ›")
            elif liunian_ten_god == 'æ­£å°':
                focus_items.append("å®œè§„åˆ’")
            elif liunian_ten_god == 'é£Ÿç¥':
                # æ£€æŸ¥æµå¹´åœ°æ”¯æ˜¯å¦å†²æ—¥æ”¯
                try:
                    if pillars and 'day' in pillars:
                        day_zhi = pillars['day'][1] if isinstance(pillars['day'], tuple) else ''
                        chong_pairs = [('å­', 'åˆ'), ('ä¸‘', 'æœª'), ('å¯…', 'ç”³'), ('å¯', 'é…‰'), ('è¾°', 'æˆŒ'), ('å·³', 'äº¥')]
                        is_chong_day = any((day_zhi == pair[0] and zhi == pair[1]) or (day_zhi == pair[1] and zhi == pair[0]) for pair in chong_pairs)
                        if is_chong_day:
                            focus_items.append("æ³¨æ„å®¶åº­å…³ç³»åŠè‡ªèº«å¥åº·")
                except Exception:
                    pass
            elif liunian_ten_god == 'ä¼¤å®˜':
                focus_items.append("ç§¯æä½œä¸ºï¼Œå‘æŒ¥æ‰€é•¿")
            elif liunian_ten_god == 'åŠ«è´¢':
                # æ— ç‰¹æ®Šé‡ç‚¹
                pass
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯å¤§è¿è½¬æŠ˜å¹´
            if dayun_list and birth_info:
                birth_year = birth_info.get('solar_year') or birth_info.get('year', current_year)
                age_at_year = year - birth_year
                for dayun in dayun_list:
                    if dayun['start_age'] == age_at_year:
                        focus_items.append("å®ˆæˆä¸ºä¸Šï¼Œé¿å…å†’è¿›" if liunian_ten_god in ['æ­£å°', 'åå°'] else "é‡è¦è½¬æŠ˜å¹´")
                        break
            
            # æ£€æŸ¥æµå¹´æ˜¯å¦å†²æ—¥æ”¯ï¼ˆ2033å¹´ç‰¹æ®Šæƒ…å†µï¼‰
            try:
                if pillars and 'day' in pillars:
                    day_zhi = pillars['day'][1] if isinstance(pillars['day'], tuple) else ''
                    chong_pairs = [('å­', 'åˆ'), ('ä¸‘', 'æœª'), ('å¯…', 'ç”³'), ('å¯', 'é…‰'), ('è¾°', 'æˆŒ'), ('å·³', 'äº¥')]
                    is_chong_day = any((day_zhi == pair[0] and zhi == pair[1]) or (day_zhi == pair[1] and zhi == pair[0]) for pair in chong_pairs)
                    if is_chong_day and liunian_ten_god == 'é£Ÿç¥':
                        focus_items.append("æ³¨æ„å®¶åº­å…³ç³»åŠè‡ªèº«å¥åº·")
            except Exception:
                pass

            if focus_items:
                year_info += f"\n    é‡ç‚¹ï¼š{', '.join(focus_items)}"

            lines.append(year_info)

        return "â€¢ æœªæ¥åå¹´æµå¹´è¯¦ç»†åˆ†æï¼š\n" + "\n".join(lines)

    def analyze_monthly_opportunities(self, pillars, year, day_master, birth_info=None):
        """
        åˆ†ææŸå¹´å„æœˆä»½çº§æ—¶æœº
        ğŸ”¥ P0ä¿®å¤ï¼šæ–°å¢æœˆä»½çº§æ—¶æœºåˆ†æåŠŸèƒ½

        Args:
            pillars: å››æŸ±ä¿¡æ¯
            year: ç›®æ ‡å¹´ä»½
            day_master: æ—¥ä¸»
            birth_info: å‡ºç”Ÿä¿¡æ¯ï¼ˆå¯é€‰ï¼‰

        Returns:
            å„æœˆä»½çš„åˆ†æç»“æœåˆ—è¡¨
        """
        from datetime import datetime
        monthly_info = []
        dm_element = self.get_wuxing_by_tiangan(day_master)

        # ç”Ÿå…‹å…³ç³»
        def relation(src, dst):
            generate = {'æœ¨': 'ç«', 'ç«': 'åœŸ', 'åœŸ': 'é‡‘', 'é‡‘': 'æ°´', 'æ°´': 'æœ¨'}
            overcome = {'æœ¨': 'åœŸ', 'åœŸ': 'æ°´', 'æ°´': 'ç«', 'ç«': 'é‡‘', 'é‡‘': 'æœ¨'}
            if generate[src] == dst:
                return 'ç›¸ç”Ÿ'
            if overcome[src] == dst:
                return 'ç›¸å…‹'
            if src == dst:
                return 'æ¯”å’Œ'
            return 'ä¸­æ€§'

        # å†œå†æœˆä»½åç§°
        lunar_month_names = ['æ­£', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å', 'å†¬', 'è…Š']

        try:
            if 'Solar' in globals() and Solar and Lunar:
                from datetime import datetime as _dt

                for month_idx in range(12):
                    lunar_month = month_idx + 1
                    # è·å–è¯¥æœˆç¬¬ä¸€å¤©çš„å¹²æ”¯
                    try:
                        solar = Solar.fromYmd(year, 3, 1)  # ä½¿ç”¨3æœˆ1æ—¥ä½œä¸ºåŸºå‡†
                        lunar = solar.getLunar()
                        # è®¡ç®—è¯¥æœˆçš„å†œå†æœˆ
                        target_lunar = lunar.getMonth()

                        # ç®€åŒ–ï¼šæ¯ä¸ªæœˆå–æœˆä¸­æ—¥æœŸè®¡ç®—
                        solar_date = Solar.fromYmd(year, 3 + month_idx, 15)
                        lunar_date = solar_date.getLunar()
                        month_ganzhi = lunar_date.getMonthInGanZhi()

                        if month_ganzhi:
                            month_tg = month_ganzhi[0] if len(month_ganzhi) > 0 else 'ç”²'
                            month_zhi = month_ganzhi[1] if len(month_ganzhi) > 1 else 'å­'
                        else:
                            month_tg = 'ç”²'
                            month_zhi = 'å­'
                    except Exception:
                        month_tg = 'ç”²'
                        month_zhi = 'å­'

                    month_element = self.get_wuxing_by_tiangan(month_tg)
                    rel = relation(dm_element, month_element)

                    # åˆ¤æ–­é€‚åˆäº‹é¡¹
                    suitable = []
                    caution = []

                    if rel == 'ç›¸ç”Ÿ':
                        suitable.append("åˆ©äºå‘å±•")
                        suitable.append("é€‚åˆè¡ŒåŠ¨")
                    elif rel == 'ç›¸å…‹':
                        caution.append("æ³¨æ„å‹åŠ›")
                        caution.append("è°¨æ…å†³ç­–")
                    elif rel == 'æ¯”å’Œ':
                        suitable.append("å¹³ç¨³å‘å±•")

                    # æ£€æŸ¥ä¸æ—¥æŸ±çš„å…³ç³»
                    day_zhi = pillars.get('day', ('', ''))[1] if isinstance(pillars.get('day'), tuple) else ''
                    if day_zhi:
                        # æ£€æŸ¥æ˜¯å¦ç›¸å†²
                        chong_pairs = [('å­', 'åˆ'), ('ä¸‘', 'æœª'), ('å¯…', 'ç”³'), ('å¯', 'é…‰'), ('è¾°', 'æˆŒ'), ('å·³', 'äº¥')]
                        is_chong = any((day_zhi == pair[0] and month_zhi == pair[1]) or (day_zhi == pair[1] and month_zhi == pair[0]) for pair in chong_pairs)
                        if is_chong:
                            caution.append("æœˆæ”¯å†²æ—¥æ”¯")

                    month_name = lunar_month_names[month_idx] if month_idx < len(lunar_month_names) else str(lunar_month)
                    month_info = {
                        'month': lunar_month,
                        'month_name': f"å†œå†{month_name}æœˆ",
                        'ganzhi': f"{month_tg}{month_zhi}",
                        'relation': rel,
                        'suitable': suitable,
                        'caution': caution
                    }
                    monthly_info.append(month_info)
            else:
                # å¤‡ç”¨æ–¹æ¡ˆï¼šç®€åŒ–åˆ†æ
                for month_idx in range(12):
                    month_name = lunar_month_names[month_idx] if month_idx < len(lunar_month_names) else str(month_idx + 1)
                    monthly_info.append({
                        'month': month_idx + 1,
                        'month_name': f"å†œå†{month_name}æœˆ",
                        'ganzhi': 'æœªçŸ¥',
                        'relation': 'ä¸­æ€§',
                        'suitable': [],
                        'caution': []
                    })
        except Exception as e:
            print(f"âš ï¸ æœˆä»½çº§æ—¶æœºåˆ†æå¤±è´¥: {e}")

        return monthly_info

    def format_monthly_opportunities(self, monthly_info, year):
        """
        æ ¼å¼åŒ–æœˆä»½çº§æ—¶æœºåˆ†æç»“æœ
        ğŸ”¥ P0ä¿®å¤ï¼šæ ¼å¼åŒ–è¾“å‡ºæœˆä»½çº§æ—¶æœº
        """
        if not monthly_info:
            return f"â€¢ {year}å¹´æœˆä»½çº§æ—¶æœºï¼šæš‚æ— æ•°æ®\n"

        lines = [f"â€¢ {year}å¹´æœˆä»½çº§æ—¶æœºåˆ†æï¼š"]
        for info in monthly_info:
            line = f"  {info['month_name']}ï¼ˆ{info['ganzhi']}ï¼‰ï¼š"
            # ğŸ”¥ ä¿®å¤ï¼šé¿å…é‡å¤çš„"é€‚åˆ"å’Œ"æ³¨æ„"å‰ç¼€
            suitable_texts = []
            caution_texts = []

            for s in info['suitable']:
                # å¦‚æœsuitableé¡¹å·²ç»åŒ…å«"é€‚åˆ"æˆ–"åˆ©äº"ç­‰è¯ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™æ·»åŠ "é€‚åˆ"å‰ç¼€
                if any(keyword in s for keyword in ['é€‚åˆ', 'åˆ©äº', 'å¹³ç¨³']):
                    suitable_texts.append(s)
                else:
                    suitable_texts.append(f"é€‚åˆ{s}")

            for c in info['caution']:
                # å¦‚æœcautioné¡¹å·²ç»åŒ…å«"æ³¨æ„"æˆ–"è°¨æ…"ç­‰è¯ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™æ·»åŠ "æ³¨æ„"å‰ç¼€
                if any(keyword in c for keyword in ['æ³¨æ„', 'è°¨æ…', 'è­¦æƒ•']):
                    caution_texts.append(c)
                else:
                    caution_texts.append(f"æ³¨æ„{c}")

            if suitable_texts:
                line += ', '.join(suitable_texts)
            if caution_texts:
                if suitable_texts:
                    line += ", "
                line += ', '.join(caution_texts)
            if not suitable_texts and not caution_texts:
                line += "å¹³ç¨³"
            lines.append(line)

        return "\n".join(lines) + "\n"

    def analyze_turning_points(self, pillars, birth_info, day_master, years=10):
        """
        åˆ†ææœªæ¥10å¹´çš„è½¬æŠ˜ç‚¹
        ğŸ”¥ P0ä¿®å¤ï¼šæ–°å¢è½¬æŠ˜ç‚¹åˆ†æåŠŸèƒ½

        è½¬æŠ˜ç‚¹ç±»å‹ï¼š
        1. å¤§è¿è½¬æŠ˜ï¼šæ¢å¤§è¿çš„å¹´ä»½
        2. æµå¹´å†²åˆï¼šæµå¹´ä¸æ—¥æŸ±/æœˆæŸ±ç›¸å†²æˆ–ç›¸åˆ
        3. ç”¨ç¥åˆ°ä½ï¼šæµå¹´å¹²æ”¯æ˜¯ç”¨ç¥æˆ–å¿Œç¥
        4. æ ¼å±€å˜åŒ–ï¼šæµå¹´å¯¼è‡´æ ¼å±€å˜åŒ–

        Args:
            pillars: å››æŸ±ä¿¡æ¯
            birth_info: å‡ºç”Ÿä¿¡æ¯
            day_master: æ—¥ä¸»
            years: åˆ†æå¹´é™ï¼ˆé»˜è®¤10å¹´ï¼‰

        Returns:
            è½¬æŠ˜ç‚¹åˆ†ææ–‡æœ¬
        """
        from datetime import datetime
        current_year = datetime.now().year
        turning_points = []

        try:
            # 1. è®¡ç®—å¤§è¿è½¬æŠ˜ç‚¹ï¼ˆåˆ‡æ¢ä¸ºå…­ä¹¦åº“ï¼‰
            dayun_list = []
            print("â„¹ï¸ ä½¿ç”¨å…­ä¹¦åº“è®¡ç®—å¤§è¿è½¬æŠ˜ç‚¹")
            birth_year = birth_info.get('solar_year') or birth_info.get('year', current_year)
            try:
                if CML_UNIFIED_AVAILABLE and 'BaziData' in globals():
                    # æ„é€ å…­ä¹¦åº“è¾“å…¥
                    by = int(birth_year)
                    bm = int(birth_info.get('solar_month') or birth_info.get('month') or 1)
                    bd = int(birth_info.get('solar_day') or birth_info.get('day') or 1)
                    bh = int(birth_info.get('solar_hour') or 0)
                    gender = birth_info.get('gender', 'ç”·')
                    bazi_data_tmp = BaziData(
                        year=(pillars['year'][0], pillars['year'][1]),
                        month=(pillars['month'][0], pillars['month'][1]),
                        day=(pillars['day'][0], pillars['day'][1]),
                        hour=(pillars['hour'][0], pillars['hour'][1]),
                        birth_year=by, birth_month=bm, birth_day=bd, birth_hour=bh,
                        gender=gender
                    )
                    analyzer_tmp = UnifiedMetaphysicsAnalyzer()
                    dayun_res = analyzer_tmp.analyzers['ä¸‰å‘½é€šä¼š'].analyze_dayun(bazi_data_tmp)
                    pillars_list = dayun_res.details.get('dayun_pillars', []) or []
                    qy_age_raw = dayun_res.details.get('qiyun_age')
                    qy_age_base = int(round(qy_age_raw)) if qy_age_raw is not None else 0
                    built = []
                    for i, p in enumerate(pillars_list, start=1):
                        try:
                            gan, zhi = p
                        except Exception:
                            gz = str(p)
                            gan = gz[0] if len(gz) >= 1 else ''
                            zhi = gz[1] if len(gz) >= 2 else ''
                        sa = qy_age_base + (i - 1) * 10
                        ea = sa + 9
                        built.append({'index': i, 'ganzhi': f"{gan}{zhi}", 'gan': gan, 'zhi': zhi, 'start_age': sa, 'end_age': ea})
                    dayun_list = built
                else:
                    print("âš ï¸ å…­ä¹¦åº“ä¸å¯ç”¨ï¼Œæ— æ³•è®¡ç®—å¤§è¿è½¬æŠ˜ç‚¹")
            except Exception as e:
                print(f"âš ï¸ å…­ä¹¦åº“è®¡ç®—å¤§è¿è½¬æŠ˜ç‚¹å¤±è´¥: {e}")

            # è·å–ç”¨ç¥ä¿¡æ¯ï¼ˆå¦‚æœå¯ç”¨ï¼Œåˆ‡æ¢ä¸ºå…­ä¹¦åº“ï¼‰
            yongshen_list = []
            jishen_list = []
            try:
                if CML_UNIFIED_AVAILABLE and 'BaziData' in globals():
                    by = int(birth_year)
                    bm = int(birth_info.get('solar_month') or birth_info.get('month') or 1)
                    bd = int(birth_info.get('solar_day') or birth_info.get('day') or 1)
                    bh = int(birth_info.get('solar_hour') or 0)
                    gender = birth_info.get('gender', 'ç”·')
                    bazi_data_tmp = BaziData(
                        year=(pillars['year'][0], pillars['year'][1]),
                        month=(pillars['month'][0], pillars['month'][1]),
                        day=(pillars['day'][0], pillars['day'][1]),
                        hour=(pillars['hour'][0], pillars['hour'][1]),
                        birth_year=by, birth_month=bm, birth_day=bd, birth_hour=bh,
                        gender=gender
                    )
                    analyzer_tmp = UnifiedMetaphysicsAnalyzer()
                    ziping = analyzer_tmp.analyzers['å­å¹³çœŸè¯ '].analyze(bazi_data_tmp)
                    yinfo = ziping.details.get('yongshen_info', {})
                    xs = yinfo.get('xishen', '')
                    js = yinfo.get('jishen', '')
                    # ç»Ÿä¸€æ‹†åˆ†ä¸ºåˆ—è¡¨
                    def split_wx(s):
                        if not s:
                            return []
                        for sep in ['ã€', 'ï¼Œ', ',', 'å’Œ', 'åŠ', ' ']:
                            s = s.replace(sep, '|')
                        parts = [t for t in s.split('|') if t]
                        # ä»…ä¿ç•™äº”è¡Œå­—
                        return [t for t in parts if t in ['æœ¨','ç«','åœŸ','é‡‘','æ°´']]
                    yongshen_list = split_wx(xs)
                    jishen_list = split_wx(js)
            except Exception:
                pass

            # æ£€æŸ¥å¤§è¿è½¬æŠ˜ç‚¹
            for dayun in dayun_list:
                turn_year = birth_year + dayun['start_age']
                if current_year <= turn_year <= current_year + years:
                    turning_points.append({
                        'year': turn_year,
                        'type': 'å¤§è¿è½¬æŠ˜',
                        'description': f"è¿›å…¥{dayun.get('ganzhi', '')}å¤§è¿ï¼ˆ{dayun['start_age']}-{dayun['end_age']}å²ï¼‰",
                        'impact': self._analyze_dayun_impact(dayun, day_master),
                        'priority': 'é«˜'
                    })

            # 2. æ£€æŸ¥æµå¹´å†²åˆï¼ˆæœªæ¥10å¹´ï¼‰
            day_zhi = pillars.get('day', ('', ''))[1] if isinstance(pillars.get('day'), tuple) else ''
            month_zhi = pillars.get('month', ('', ''))[1] if isinstance(pillars.get('month'), tuple) else ''

            chong_pairs = [('å­', 'åˆ'), ('ä¸‘', 'æœª'), ('å¯…', 'ç”³'), ('å¯', 'é…‰'), ('è¾°', 'æˆŒ'), ('å·³', 'äº¥')]
            he_pairs = [('å­', 'ä¸‘'), ('å¯…', 'äº¥'), ('å¯', 'æˆŒ'), ('è¾°', 'é…‰'), ('å·³', 'ç”³'), ('åˆ', 'æœª')]

            for i in range(years):
                year = current_year + i
                try:
                    if 'Solar' in globals() and Solar and Lunar:
                        from datetime import datetime as _dt
                        lunar = Solar.fromDate(_dt(year, 6, 1)).getLunar()
                        ygz = lunar.getYearInGanZhi()
                        if len(ygz) > 1:
                            year_zhi = ygz[1]

                            # æ£€æŸ¥æµå¹´å†²æ—¥æŸ±
                            if day_zhi:
                                is_chong = any((day_zhi == pair[0] and year_zhi == pair[1]) or (day_zhi == pair[1] and year_zhi == pair[0]) for pair in chong_pairs)
                                if is_chong:
                                    turning_points.append({
                                        'year': year,
                                        'type': 'æµå¹´å†²æ—¥æŸ±',
                                        'description': f"{year}å¹´ï¼ˆ{ygz}ï¼‰æµå¹´åœ°æ”¯{year_zhi}å†²æ—¥æ”¯{day_zhi}",
                                        'impact': 'å¯èƒ½å½±å“ä¸ªäººçŠ¶æ€å’Œèº«ä½“å¥åº·ï¼Œéœ€ç‰¹åˆ«æ³¨æ„',
                                        'priority': 'é«˜'
                                    })

                            # æ£€æŸ¥æµå¹´åˆæœˆæŸ±
                            if month_zhi:
                                is_he = any((month_zhi == pair[0] and year_zhi == pair[1]) or (month_zhi == pair[1] and year_zhi == pair[0]) for pair in he_pairs)
                                if is_he:
                                    turning_points.append({
                                        'year': year,
                                        'type': 'æµå¹´åˆæœˆæŸ±',
                                        'description': f"{year}å¹´ï¼ˆ{ygz}ï¼‰æµå¹´åœ°æ”¯{year_zhi}åˆæœˆæ”¯{month_zhi}",
                                        'impact': 'å¯èƒ½å¸¦æ¥ç¯å¢ƒå˜åŒ–æˆ–æœºé‡',
                                        'priority': 'ä¸­'
                                    })
                except Exception:
                    pass

            # 3. æ£€æŸ¥ç”¨ç¥åˆ°ä½ï¼ˆç®€åŒ–ç‰ˆï¼‰
            # è¿™é‡Œå¯ä»¥æ ¹æ®ç”¨ç¥åˆ—è¡¨æ£€æŸ¥æµå¹´æ˜¯å¦æ˜¯ç”¨ç¥æˆ–å¿Œç¥

            # æŒ‰å¹´ä»½æ’åº
            turning_points.sort(key=lambda x: x['year'])

            # æ ¼å¼åŒ–è¾“å‡º
            if not turning_points:
                return "â€¢ æœªæ¥åå¹´è½¬æŠ˜ç‚¹ï¼šæ— æ˜æ˜¾é‡å¤§è½¬æŠ˜ç‚¹ï¼Œè¿åŠ¿ç›¸å¯¹å¹³ç¨³\n"

            lines = ["â€¢ æœªæ¥åå¹´è½¬æŠ˜ç‚¹åˆ†æï¼š"]
            for tp in turning_points:
                priority_mark = "ğŸ”´" if tp['priority'] == 'é«˜' else "ğŸŸ¡"
                lines.append(f"  {priority_mark} {tp['year']}å¹´ï¼š{tp['type']}")
                lines.append(f"    è¯´æ˜ï¼š{tp['description']}")
                lines.append(f"    å½±å“ï¼š{tp['impact']}")
                lines.append("")

            return "\n".join(lines)

        except Exception as e:
            print(f"âš ï¸ è½¬æŠ˜ç‚¹åˆ†æå¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            return f"â€¢ è½¬æŠ˜ç‚¹åˆ†æï¼šåˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯\n"

    def _analyze_dayun_impact(self, dayun, day_master):
        """
        åˆ†æå¤§è¿çš„å½±å“
        ğŸ”¥ P0ä¿®å¤ï¼šè¾…åŠ©æ–¹æ³•ï¼Œåˆ†æå¤§è¿å¯¹æ—¥ä¸»çš„å½±å“ï¼Œè€ƒè™‘äº”è¡Œç‰¹æ€§å’Œç‰¹æ®Šæ ¼å±€
        """
        dayun_gan = dayun.get('gan', '')
        dayun_zhi = dayun.get('zhi', '')

        if not dayun_gan:
            return "éœ€ç»“åˆå…·ä½“å¤§è¿å¹²æ”¯åˆ†æ"

        # ğŸ”¥ ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦"åœŸé‡åŸ‹é‡‘"çš„ç‰¹æ®Šæƒ…å†µ
        # å¦‚æœå¤§è¿æ˜¯æˆŠè¾°ã€å·±å·³ã€æˆŠæˆŒã€å·±æœªç­‰å¹²æ”¯ä¸€æ°”çš„åœŸï¼Œä¸”æ—¥ä¸»æ˜¯é‡‘ï¼Œéœ€è¦ç‰¹åˆ«è¯´æ˜
        try:
            from classic_analyzer.common import get_ten_god, TIANGAN_WUXING, DIZHI_WUXING
            from chinese_metaphysics_library.core.constants import DIZHI_CANGGAN
            
            day_master_wx = TIANGAN_WUXING.get(day_master, '')
            dayun_gan_wx = TIANGAN_WUXING.get(dayun_gan, '')
            dayun_zhi_wx = DIZHI_WUXING.get(dayun_zhi, '')
            
            # æ£€æŸ¥æ˜¯å¦"åœŸé‡åŸ‹é‡‘"ï¼šå¤§è¿å¹²æ”¯éƒ½æ˜¯åœŸï¼Œä¸”æ—¥ä¸»æ˜¯é‡‘
            is_tu_zhong_mai_jin = False
            if day_master_wx == 'é‡‘' and dayun_gan_wx == 'åœŸ' and dayun_zhi_wx == 'åœŸ':
                # è¿›ä¸€æ­¥æ£€æŸ¥ï¼šå¦‚æœå¤§è¿å¹²æ”¯æ˜¯åŒä¸€å¤©å¹²ï¼ˆå¦‚æˆŠè¾°ã€å·±å·³ï¼‰ï¼Œåˆ™æ˜¯"å¹²æ”¯ä¸€æ°”"
                # æˆ–è€…å¤§è¿åœ°æ”¯è—å¹²ä¹Ÿä¸»è¦æ˜¯åœŸ
                canggan_list = DIZHI_CANGGAN.get(dayun_zhi, [])
                tu_weight = 0.0
                for cg, weight in canggan_list:
                    if TIANGAN_WUXING.get(cg, '') == 'åœŸ':
                        tu_weight += weight
                # å¦‚æœå¤©å¹²æ˜¯åœŸï¼Œåœ°æ”¯ä¹Ÿæ˜¯åœŸï¼Œä¸”åœ°æ”¯è—å¹²ä¸­åœŸçš„æ¯”ä¾‹>=0.5ï¼Œè®¤ä¸ºæ˜¯"åœŸé‡"
                if tu_weight >= 0.5:
                    is_tu_zhong_mai_jin = True
            
            # å¦‚æœåˆ¤æ–­ä¸º"åœŸé‡åŸ‹é‡‘"ï¼Œè¿”å›ç‰¹æ®Šè¯´æ˜
            if is_tu_zhong_mai_jin:
                return "æ­¤è¿åœŸåŠ¿éå¸¸åšé‡ï¼Œ'åœŸé‡åŸ‹é‡‘'çš„æ€åŠ¿åŠ å‰§ï¼Œæ˜¯äººç”Ÿé‡è¦çš„è½¬æ¢æœŸã€‚äº‹ä¸šä¸Šå®œè½¬å‘å¹•åã€å†…å®ˆã€ç§¯ç´¯çŸ¥è¯†ï¼Œå¥åº·ä¸Šéœ€æ ¼å¤–å…³æ³¨ã€‚"
            
            # è·å–å¤§è¿å¤©å¹²çš„åç¥
            ten_god = get_ten_god(day_master, dayun_gan)

            impact_map = {
                'æ­£å®˜': 'åˆ©äºäº‹ä¸šå‘å±•ï¼Œå¯èƒ½è·å¾—èŒä½æå‡æˆ–åå£°',
                'åå®˜': 'å¯èƒ½æœ‰æƒåŠ›å˜åŒ–æˆ–ç«äº‰å‹åŠ›',
                'æ­£è´¢': 'åˆ©äºè´¢è¿ï¼Œæ”¶å…¥å¯èƒ½å¢åŠ ',
                'åè´¢': 'å¯èƒ½æœ‰æ„å¤–æ”¶å…¥æˆ–æŠ•èµ„æœºä¼š',
                'æ­£å°': 'åˆ©äºå­¦ä¹ ã€è€ƒè¯•ã€è´µäººç›¸åŠ©',
                'åå°': 'åˆ©äºæ€è€ƒã€åˆ›æ–°ï¼Œä½†å¯èƒ½æœ‰å­¤ç‹¬æ„Ÿ',
                'é£Ÿç¥': 'åˆ©äºæ‰è‰ºå‘æŒ¥ã€äº«å—ç”Ÿæ´»',
                'ä¼¤å®˜': 'åˆ©äºæ‰åå±•ç°ï¼Œä½†éœ€æ³¨æ„å£èˆŒ',
                'æ¯”è‚©': 'å¯èƒ½é‡åˆ°åˆä½œæœºä¼šæˆ–ç«äº‰',
                'åŠ«è´¢': 'éœ€æ³¨æ„è´¢åŠ¡å®‰å…¨å’Œäººé™…å…³ç³»'
            }

            return impact_map.get(ten_god, 'éœ€ç»“åˆå…·ä½“åˆ†æ')
        except Exception as e:
            print(f"âš ï¸ å¤§è¿å½±å“åˆ†æå¤±è´¥: {e}")
            return "éœ€ç»“åˆå…·ä½“å¤§è¿å¹²æ”¯åˆ†æ"






















    def get_simple_wuxing_balance(self, wuxing_distribution):
        """è·å–ç®€åŒ–äº”è¡Œå¹³è¡¡æè¿°"""
        if not wuxing_distribution:
            return "ä¿¡æ¯ä¸è¶³"

        max_count = max(wuxing_distribution.values())
        min_count = min(wuxing_distribution.values())

        if max_count - min_count >= 3:
            return "äº”è¡Œå¤±è¡¡"
        else:
            return "äº”è¡Œå¹³è¡¡"

    def analyze_xiandai_keyan_geju_old(self, bazi_result):
        """ç°ä»£å¯éªŒæ ¼å±€ - ã€Šå…°å°å¦™é€‰ã€‹çº¢è‰³ç« """
        analysis = []
        pillars = bazi_result['pillars']
        day_stem = pillars['day'][0]
        time_branch = pillars['hour'][1]

        # å¢™å¤–ç”ŸèŠ±æ ¼å±€æ£€æµ‹
        if time_branch in ['å­', 'åˆ', 'å¯', 'é…‰']:  # æ—¶æŸ±æ¡ƒèŠ±
            # æ£€æŸ¥æ˜¯å¦åˆæ—¥å¹²ï¼ˆç®€åŒ–æ£€æµ‹ï¼‰
            analysis.append("â€¢ å¢™å¤–ç”ŸèŠ±æ ¼ï¼šæ—¶æŸ±æ¡ƒèŠ±+åˆæ—¥å¹²")
            analysis.append("  çƒ­æ‹æœŸï¼š3å¹´å†…")

        # é‡‘æ°´å¤šæƒ…æ ¼å±€æ£€æµ‹
        if day_stem in ['åºš', 'è¾›']:  # åºšè¾›æ—¥ä¸»
            all_branches = [pillars['year'][1], pillars['month'][1], pillars['day'][1], pillars['hour'][1]]
            jinshui_count = sum(1 for branch in all_branches if branch in ['å­', 'äº¥'])
            if jinshui_count >= 2:
                analysis.append("â€¢ é‡‘æ°´å¤šæƒ…æ ¼ï¼šåºšè¾›æ—¥ä¸»+å­äº¥å¤šç°")
                analysis.append("  ç‰¹å¾ï¼šæ˜“å‡ºè½¨")

        if not analysis:
            analysis.append("â€¢ æ— ç‰¹æ®Šçˆ±æƒ…æ ¼å±€ï¼šæ„Ÿæƒ…å¹³ç¨³")

        return analysis

    def analyze_lushui_qingyuan_suanfa_old(self, bazi_result):
        """éœ²æ°´æƒ…ç¼˜ç®—æ³• - ã€Šé‡‘ç“¶æ¢…å‘½è°±ã€‹ç§˜ä¼ """
        analysis = []
        pillars = bazi_result['pillars']

        # æ¡ƒèŠ±å¼ºåº¦è®¡ç®—
        taohua_qiangdu = self.calculate_taohua_qiangdu(pillars['day'], pillars['hour'])

        analysis.append(f"â€¢ æ¡ƒèŠ±å¼ºåº¦ï¼š{taohua_qiangdu}åˆ†")

        if taohua_qiangdu >= 8:
            analysis.append("â€¢ æƒ…ç¼˜æ€§è´¨ï¼šæ¡ƒèŠ±æ—ºç››ï¼Œæƒ…ç¼˜ä¸°å¯Œ")
        elif taohua_qiangdu >= 5:
            analysis.append("â€¢ æƒ…ç¼˜æ€§è´¨ï¼šæ¡ƒèŠ±ä¸­ç­‰ï¼Œæƒ…ç¼˜æ­£å¸¸")
        else:
            analysis.append("â€¢ æƒ…ç¼˜æ€§è´¨ï¼šæ¡ƒèŠ±è¾ƒå¼±ï¼Œæƒ…ç¼˜å†…æ•›")

        return analysis

    def analyze_taohua_qiangdu_old(self, bazi_result):
        """æ¡ƒèŠ±å¼ºåº¦è¯„ä¼°"""
        analysis = []
        pillars = bazi_result['pillars']

        # å­åˆå¯é…‰ä¸ºå››æ­£æ¡ƒèŠ±
        peach_branches = ['å­', 'åˆ', 'å¯', 'é…‰']
        all_branches = [pillars['year'][1], pillars['month'][1], pillars['day'][1], pillars['hour'][1]]
        peach_count = sum(1 for branch in all_branches if branch in peach_branches)

        analysis.append(f"â€¢ å››æ­£æ¡ƒèŠ±ï¼š{peach_count}ä¸ª")

        if peach_count >= 3:
            analysis.append("â€¢ æ¡ƒèŠ±è¯„çº§ï¼šâ˜…â˜…â˜…â˜…â˜… æ¡ƒèŠ±æ»¡å›­")
        elif peach_count == 2:
            analysis.append("â€¢ æ¡ƒèŠ±è¯„çº§ï¼šâ˜…â˜…â˜…â˜…â˜† æ¡ƒèŠ±ç››å¼€")
        elif peach_count == 1:
            analysis.append("â€¢ æ¡ƒèŠ±è¯„çº§ï¼šâ˜…â˜…â˜…â˜†â˜† æ¡ƒèŠ±ä¸€ç°")
        else:
            analysis.append("â€¢ æ¡ƒèŠ±è¯„çº§ï¼šâ˜…â˜…â˜†â˜†â˜† æ¡ƒèŠ±ç¨€å°‘")

        return analysis

    def calculate_taohua_qiangdu(self, day_zhu, hour_zhu):
        """è®¡ç®—æ¡ƒèŠ±å¼ºåº¦ - ã€Šé‡‘ç“¶æ¢…å‘½è°±ã€‹ç®—æ³•"""
        day_branch = day_zhu[1]
        hour_branch = hour_zhu[1]

        # æ—¥æŸ±æ¡ƒèŠ±å€¼
        ri_zhu_taohua = 3 if day_branch in ['å­', 'åˆ', 'å¯', 'é…‰'] else 0

        # æ—¶æŸ±æ¡ƒèŠ±å€¼
        shi_zhu_taohua = 2 if hour_branch in ['å­', 'åˆ', 'å¯', 'é…‰'] else 0

        score = ri_zhu_taohua + shi_zhu_taohua

        # æ—¥æ”¯é€¢åˆæ£€æµ‹ï¼ˆç®€åŒ–ï¼‰
        he_map = {'å¯…': 'äº¥', 'å¯': 'æˆŒ', 'è¾°': 'é…‰', 'å·³': 'ç”³', 'åˆ': 'æœª', 'å­': 'ä¸‘'}
        if day_branch in he_map:
            score = int(score * 1.8)  # åˆåŠ¨æƒ…ç¼˜

        return min(score, 10)

    def analyze_parents_fortune(self, bazi_result, ten_gods, gender):
        """æ—§çˆ¶æ¯åˆ†æå‡½æ•°ï¼šæ”¹ä¸ºè°ƒç”¨æ•°æ®åŒ–æŒ‡æ ‡"""
        return self.analyze_parents_data(bazi_result['pillars'], ten_gods)

    def analyze_children_fortune(self, bazi_result, ten_gods, gender):
        """æ—§å­å¥³åˆ†æå‡½æ•°ï¼šæ”¹ä¸ºè°ƒç”¨æ•°æ®åŒ–æŒ‡æ ‡"""
        return self.analyze_children_data(bazi_result['pillars'], ten_gods, gender)

    def get_star_info(self, ten_gods, star_name):
        """è·å–ç‰¹å®šåç¥çš„ä¿¡æ¯"""
        star_info = []
        for position, info in ten_gods.items():
            if info['ten_god'] == star_name:
                star_info.append({'position': position, 'info': info})
        return star_info

    def analyze_marriage_with_timing(self, bazi_result, ten_gods, gender, dayun_info):
        return ""

    def analyze_spouse_star_stability_clean(self, bazi_result, ten_gods, gender):
        return []

    def analyze_spouse_palace_damage_clean(self, bazi_result, gender):
        return []

    def analyze_marriage_timing_clean(self, bazi_result, gender):
        """å©šå§»æ—¶æœºåˆ†æ"""
        analysis = []
        pillars = bazi_result['pillars']

        # æ¡ƒèŠ±åˆ†æ
        peach_branches = ['å­', 'åˆ', 'å¯', 'é…‰']
        all_branches = [pillars['year'][1], pillars['month'][1], pillars['day'][1], pillars['hour'][1]]
        peach_count = sum(1 for branch in all_branches if branch in peach_branches)

        if peach_count >= 2:
            analysis.append("â€¢ æ¡ƒèŠ±è¿ï¼šæ¡ƒèŠ±é‡é‡ï¼Œå¼‚æ€§ç¼˜æä½³ï¼Œæ„Ÿæƒ…æœºä¼šå¤šï¼Œå®¹æ˜“æ—©å©š")
        elif peach_count == 1:
            analysis.append("â€¢ æ¡ƒèŠ±è¿ï¼šæ¡ƒèŠ±ä¸€ç°ï¼Œå¼‚æ€§ç¼˜ä¸é”™ï¼Œæ„Ÿæƒ…å‘å±•é¡ºåˆ©")
        else:
            analysis.append("â€¢ æ¡ƒèŠ±è¿ï¼šæ— æ¡ƒèŠ±æ˜Ÿï¼Œæ„Ÿæƒ…è¾ƒä¸ºå†…æ•›ï¼Œéœ€è¦ä¸»åŠ¨å‡ºå‡»")

        # å©šæœŸæç¤º
        analysis.append("â€¢ å©šæœŸæç¤ºï¼šå…·ä½“å©šæœŸéœ€ç»“åˆå¤§è¿æµå¹´åˆ†æï¼Œä¸€èˆ¬åœ¨è´¢å®˜æ—ºå¹´æˆ–çº¢é¸¾å¤©å–œå¹´")

        return analysis

    # âœ… åˆ é™¤ï¼šget_marriage_advice - ç©ºæ´çš„å¥—è¯ï¼Œæ²¡æœ‰é’ˆå¯¹æ€§ï¼Œåƒæ˜¯ä»ç½‘ä¸Šå¤åˆ¶ç²˜è´´çš„

    def analyze_simple_health_old(self, wuxing_distribution):
        """ç®€åŒ–çš„äº”è¡Œå¥åº·åˆ†æ - åŸºäºä¼ ç»Ÿä¸­åŒ»ç†è®º"""
        analysis = []

        # åŸºäºä¼ ç»Ÿäº”è¡Œè„è…‘ç†è®º
        analysis.append("â€¢ åŸºäºä¼ ç»Ÿäº”è¡Œè„è…‘ç†è®ºï¼š")

        for wuxing, count in wuxing_distribution.items():
            if count == 0:
                # äº”è¡Œç¼ºå¤±çš„ä¼ ç»Ÿåˆ†æ
                organ_map = {
                    'æœ¨': 'è‚èƒ†',
                    'ç«': 'å¿ƒå°è‚ ',
                    'åœŸ': 'è„¾èƒƒ',
                    'é‡‘': 'è‚ºå¤§è‚ ',
                    'æ°´': 'è‚¾è†€èƒ±'
                }
                analysis.append(f"  {wuxing}ä¸è¶³ï¼š{organ_map[wuxing]}éœ€è¦è°ƒå…»")

        analysis.append("â€¢ æ³¨ï¼šå¥åº·åˆ†æä»…ä¾›å‚è€ƒï¼Œå…·ä½“è¯·å’¨è¯¢åŒ»ç”Ÿ")
        return analysis

    # ğŸ”§ åˆ é™¤ï¼šanalyze_specific_disease_predictionå‡½æ•° - è¿‡äºå¤æ‚çš„ç–¾ç—…é¢„æµ‹å·²åˆ é™¤

    # ğŸ”§ åˆ é™¤ï¼šanalyze_health_risk_periodså‡½æ•° - è¿‡äºå¤æ‚çš„å¥åº·å±é™©æœŸåˆ†æå·²åˆ é™¤

    # ğŸ”§ åˆ é™¤ï¼šanalyze_body_constitutionå‡½æ•°å·²æŒ‰è¦æ±‚åˆ é™¤

    # ğŸ”§ åˆ é™¤ï¼šanalyze_personalized_health_adviceå‡½æ•°å·²æŒ‰è¦æ±‚åˆ é™¤

    # ğŸ”§ åˆ é™¤ï¼šæ‰€æœ‰ä¸ªæ€§åŒ–å…»ç”Ÿå»ºè®®ç›¸å…³å‡½æ•°å·²æŒ‰è¦æ±‚åˆ é™¤

    def analyze_marriage_simple(self, bazi_result, ten_gods, gender):
        return self.analyze_marriage_data(bazi_result['pillars'], ten_gods, gender)

    # âœ… åˆ é™¤ï¼šanalyze_spouse_star_stability - èƒ¡ä¹±ç¼–é€ çš„"å¦»æ˜Ÿç¨³å®šæ€§å…¬å¼"
    # âœ… åˆ é™¤ï¼šanalyze_spouse_palace_damage - èƒ¡ç¼–çš„"ç¦»å©šé£é™©+40%"
    # âœ… åˆ é™¤ï¼šanalyze_marriage_timing_key - æ²¡æœ‰åˆ†æå°±ä¸‹ç»“è®ºçš„"çº¢é¸¾æ˜ŸåŠ¨"
    # âœ… åˆ é™¤ï¼šanalyze_marriage_xing_he_chong_chuan - é€šç”¨å¥—è¯ï¼Œæ²¡æœ‰é’ˆå¯¹æ€§

    def get_ten_god_relation_for_branch(self, branch, day_stem, bazi_result):
        """è·å–åœ°æ”¯å¯¹æ—¥å¹²çš„åç¥å…³ç³»ï¼ˆç®€åŒ–ç‰ˆï¼‰"""
        # è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦è€ƒè™‘åœ°æ”¯è—å¹²
        branch_element = bazi_result['dizhi_info'][branch]['element']
        day_element = bazi_result['day_master_element']

        # ç®€åŒ–çš„åç¥åˆ¤æ–­
        if self.get_wuxing_relation(day_element, branch_element) == "ç›¸å…‹":
            return "ä¸ƒæ€"  # ç®€åŒ–å¤„ç†
        else:
            return "å…¶ä»–"

    def analyze_health_simple(self, bazi_result, wuxing_distribution):
        """å¥åº·åˆ†æ"""
        health_analysis = []

        # å™¨å®˜å¥åº·åˆ†æ
        health_analysis.extend(self.analyze_organ_health_clean(bazi_result))

        # äº”è¡Œå¹³è¡¡åˆ†æï¼ˆçº¯APIæ¨¡å¼ï¼Œä¸ä½¿ç”¨æœ¬åœ°è®¡ç®—ï¼‰
        # health_analysis.extend(["â€¢ äº”è¡Œå¹³è¡¡ï¼šè¯¦è§APIç»¼åˆåˆ†æ"])
        return "\n".join(health_analysis)

    def analyze_health_with_timing(self, bazi_result, wuxing_distribution, dayun_info):
        return ""



    def analyze_fortune_trend_simple(self, bazi_result, dayun_info, gender):
        """å¤§è¿åˆ†æï¼ˆå·²åºŸå¼ƒï¼‰"""
        return ""










































    def mousePressEvent(self, event):
        """é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ - æ”¯æŒçª—å£æ‹–åŠ¨"""
        if event.button() == Qt.LeftButton:
            self.drag_position = event.globalPos() - self.frameGeometry().topLeft()
            event.accept()

    def mouseMoveEvent(self, event):
        """é¼ æ ‡ç§»åŠ¨äº‹ä»¶ - æ‰§è¡Œçª—å£æ‹–åŠ¨"""
        if event.buttons() == Qt.LeftButton and self.drag_position:
            self.move(event.globalPos() - self.drag_position)
            event.accept()

    def closeEvent(self, event):
        """çª—å£å…³é—­äº‹ä»¶ - ç¡®ä¿åªå…³é—­å½“å‰çª—å£ï¼Œä¸å½±å“ä¸»ç¨‹åº"""
        try:
            # æ¸…ç†çª—å£å¼•ç”¨ï¼Œé¿å…å†…å­˜æ³„æ¼
            if hasattr(self, 'parent_window') and self.parent_window:
                if hasattr(self.parent_window, 'bazi_window'):
                    self.parent_window.bazi_window = None

            # æ¥å—å…³é—­äº‹ä»¶ï¼Œåªå…³é—­å½“å‰çª—å£
            event.accept()
            print("å…«å­—ç®—å‘½çª—å£å·²å…³é—­")

        except Exception as e:
            print(f"å…³é—­å…«å­—ç®—å‘½çª—å£æ—¶å‡ºé”™: {e}")
            # ç¡®ä¿å³ä½¿å‡ºé”™ä¹Ÿæ¥å—å…³é—­äº‹ä»¶
            event.accept()

def test_wenxin_quick():
    """å¿«é€Ÿæµ‹è¯•æ–‡å¿ƒä¸€è¨€API"""
    print("ğŸ§ª å¿«é€Ÿæµ‹è¯•æ–‡å¿ƒä¸€è¨€API...")

    try:
        import requests
        import json

        # è¯»å–é…ç½®
        with open('deepseek_config.json', 'r', encoding='utf-8') as f:
            config = json.load(f)
        api_key = config['wenxin']['api_key']

        # ä½¿ç”¨ä¹‹å‰æˆåŠŸçš„æ–¹å¼
        api_url = f"https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/ernie-3.5-8k?access_token={api_key}"

        headers = {'Content-Type': 'application/json'}
        data = {
            "messages": [{"role": "user", "content": "è¯·å›å¤'æ–‡å¿ƒä¸€è¨€æµ‹è¯•æˆåŠŸ'"}],
            "temperature": 0.3,
            "max_output_tokens": 50
        }

        response = requests.post(api_url, headers=headers, json=data, timeout=30)
        print(f"ğŸ“Š çŠ¶æ€ç : {response.status_code}")

        if response.status_code == 200:
            result = response.json()
            reply = result.get('result', '')
            print(f"âœ… æ–‡å¿ƒä¸€è¨€å›å¤: {reply}")
            return True
        else:
            print(f"âŒ è°ƒç”¨å¤±è´¥: {response.text}")
            return False

    except Exception as e:
        print(f"âŒ æµ‹è¯•å¼‚å¸¸: {e}")
        return False

def main():
    """ä¸»å‡½æ•°ï¼ˆæ— æ‰˜ç›˜ï¼Œä¿è¯ä¸»çª—å£æ˜¾ç¤ºï¼‰"""
    try:
        app = QApplication(sys.argv)
        app.setApplicationName("ä¸­åŒ»å¥åº·æ—¶é’Ÿ-ä¸“ä¸šç‰ˆæœ¬")
        app.setApplicationVersion("V1.1")
        app.setOrganizationName("æ¹–å—å…¨èˆªä¿¡æ¯é€šä¿¡æœ‰é™å…¬å¸")
        app.setOrganizationDomain("quanhang.com")

        # ğŸ§ª å¯åŠ¨æ—¶æµ‹è¯•æ–‡å¿ƒä¸€è¨€API
        print("ğŸš€ ç¨‹åºå¯åŠ¨ï¼Œæµ‹è¯•æ–‡å¿ƒä¸€è¨€API...")
        test_wenxin_quick()

        # åˆ›å»ºä¸»çª—å£
        main_window = ProfessionalBaguaClock()
        main_window.show()

        # ç›´æ¥è¿›å…¥ä¸»äº‹ä»¶å¾ªç¯ï¼Œæ— æ‰˜ç›˜
        sys.exit(app.exec_())
    except KeyboardInterrupt:
        print("\nç¨‹åºè¢«ç”¨æˆ·ä¸­æ–­ï¼ˆCtrl+Cï¼‰ï¼Œæ­£åœ¨å®‰å…¨é€€å‡º...")
        sys.exit(0)
    except Exception as e:
        print(f"ç¨‹åºå¯åŠ¨å¤±è´¥ï¼š{str(e)}")
        import traceback
        traceback.print_exc()
        # æ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†
        try:
            QApplication(sys.argv)
            QMessageBox.critical(None, "å¯åŠ¨é”™è¯¯", f"ç¨‹åºå¯åŠ¨å¤±è´¥ï¼š\n{str(e)}\n\nè¯·æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒå’Œä¾èµ–åº“ã€‚")
        except:
            pass
if __name__ == "__main__":
    main()

name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: '构建类型'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip \
            python3-dev \
            build-essential \
            git \
            unzip \
            openjdk-11-jdk \
            libffi-dev \
            libssl-dev \
            zlib1g-dev \
            libncurses5-dev \
            libbz2-dev \
            libreadline-dev \
            libsqlite3-dev \
            liblzma-dev
      
      - name: Set up environment variables
        run: |
          echo "JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64" >> $GITHUB_ENV
          echo "PATH=$JAVA_HOME/bin:$PATH" >> $GITHUB_ENV
      
      - name: Install buildozer and dependencies
        run: |
          pip3 install --upgrade pip
          pip3 install --upgrade cython
          pip3 install buildozer
          echo "Buildozer安装完成"
      
      - name: Copy modules
        working-directory: mobile_app
        run: |
          python3 copy_modules.py || echo "模块复制可能有问题，继续构建"
      
      - name: Prepare build environment
        working-directory: mobile_app
        run: |
          # 检查buildozer.spec文件
          if [ ! -f buildozer.spec ]; then
            echo "❌ 错误：未找到buildozer.spec文件"
            exit 1
          fi
          
          # 检查图标文件
          if [ ! -f icon.png ]; then
            echo "⚠️  警告：未找到icon.png，创建默认图标..."
            # 创建一个简单的1x1像素PNG图标（base64编码的最小PNG）
            echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" | base64 -d > icon.png || echo "图标创建失败，继续构建"
          fi
          
          # 检查main.py
          if [ ! -f main.py ]; then
            echo "❌ 错误：未找到main.py文件"
            exit 1
          fi
          
          # 显示目录结构
          echo "=== 当前目录结构 ==="
          ls -la
          echo "===================="
          
          # 显示buildozer配置
          echo "=== Buildozer配置 ==="
          cat buildozer.spec
          echo "===================="
      
      - name: Install expect for license acceptance
        run: |
          sudo apt-get install -y expect
      
      - name: Setup Android SDK license acceptance
        run: |
          echo "=========================================="
          echo "设置Android SDK许可自动接受"
          echo "=========================================="
          
          # 创建expect脚本来自动接受许可
          cat > accept_android_licenses.exp << 'EOF'
          #!/usr/bin/expect -f
          set timeout -1
          spawn sdkmanager --licenses
          expect {
              "Accept? (y/N):" { send "y\r"; exp_continue }
              eof
          }
          EOF
          chmod +x accept_android_licenses.exp
          
          # 这个脚本将在buildozer下载SDK后使用
          echo "✅ 许可接受脚本已创建"
      
      - name: Build APK
        working-directory: mobile_app
        run: |
          echo "=========================================="
          echo "开始构建APK..."
          echo "构建类型: ${{ github.event.inputs.build_type }}"
          echo "=========================================="
          
          # buildozer会在其自己的目录中管理SDK
          # 设置环境变量指向buildozer的SDK目录
          export ANDROID_HOME="$HOME/.buildozer/android/platform/android-sdk"
          export ANDROID_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
          
          # 创建wrapper脚本来处理许可接受
          cat > build_with_licenses.sh << 'SCRIPT'
          #!/bin/bash
          # Wrapper脚本：自动接受Android SDK许可并构建
          
          # 函数：接受许可
          accept_licenses() {
            local sdk_path="$HOME/.buildozer/android/platform/android-sdk"
            if [ -f "$sdk_path/cmdline-tools/latest/bin/sdkmanager" ]; then
              echo "接受Android SDK许可..."
              yes | "$sdk_path/cmdline-tools/latest/bin/sdkmanager" --licenses > /dev/null 2>&1 || true
            fi
          }
          
          # 首次尝试接受许可
          accept_licenses
          
          # 运行构建命令
          if [ "$1" = "release" ]; then
            buildozer android release 2>&1 | tee build.log
          else
            buildozer android debug 2>&1 | tee build.log
          fi
          
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          # 如果构建失败且日志显示许可问题，再次接受许可并重试
          if [ $BUILD_EXIT_CODE -ne 0 ] && grep -q "license.*not accepted\|Accept? (y/N)" build.log 2>/dev/null; then
            echo "检测到许可问题，重新接受许可并重试..."
            accept_licenses
            sleep 2
            
            if [ "$1" = "release" ]; then
              buildozer android release 2>&1 | tee -a build.log
            else
              buildozer android debug 2>&1 | tee -a build.log
            fi
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
          fi
          
          exit $BUILD_EXIT_CODE
          SCRIPT
          
          chmod +x build_with_licenses.sh
          
          # 设置构建超时（30分钟）
          # buildozer会自动下载所需的Android SDK和NDK
          # 首次构建可能需要较长时间（10-30分钟）
          set +e  # 不立即退出，先捕获错误
          
          # 使用wrapper脚本构建
          ./build_with_licenses.sh "${{ github.event.inputs.build_type }}"
          BUILD_EXIT_CODE=$?
          
          set -e  # 恢复错误退出
          
          # 显示构建日志的最后100行
          echo "=========================================="
          echo "构建日志（最后100行）:"
          echo "=========================================="
          tail -n 100 build.log || echo "无法读取构建日志"
          
          # 如果构建失败，显示错误信息
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "=========================================="
            echo "❌ 构建失败！退出代码: $BUILD_EXIT_CODE"
            echo "=========================================="
            echo ""
            echo "常见错误及解决方案："
            echo "1. 模块找不到：确保已运行copy_modules.py"
            echo "2. 依赖下载失败：检查网络连接"
            echo "3. Android SDK问题：buildozer会自动下载，请等待"
            echo "4. 内存不足：GitHub Actions限制，可能需要简化构建"
            echo ""
            echo "完整构建日志："
            cat build.log || echo "无法读取完整日志"
            exit $BUILD_EXIT_CODE
          fi
          
          echo "=========================================="
          echo "✅ 构建完成！"
          echo "=========================================="
      
      - name: Upload build log file
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-full
          path: mobile_app/build.log
          if-no-files-found: warn
          retention-days: 7
      
      - name: Check build results
        working-directory: mobile_app
        run: |
          echo "=== 检查构建结果 ==="
          if [ -d "bin" ]; then
            echo "bin目录内容:"
            ls -la bin/
          else
            echo "未找到bin目录"
          fi
          
          if [ -d ".buildozer" ]; then
            echo ".buildozer目录内容:"
            ls -la .buildozer/
          fi
          
          echo "=================="
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: apk-file-${{ github.event.inputs.build_type }}
          path: |
            mobile_app/bin/*.apk
            mobile_app/bin/*.aab
          if-no-files-found: warn
          retention-days: 30
      
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            mobile_app/.buildozer/**/*.log
            mobile_app/.buildozer/android/platform/build-*/dists/*/build.log
          if-no-files-found: warn
          retention-days: 7

